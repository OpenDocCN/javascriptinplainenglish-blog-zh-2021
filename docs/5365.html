<html>
<head>
<title>How to use Playwright and Benchmark.js to test JavaScript performance across browsers</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用剧作家和Benchmark.js跨浏览器测试JavaScript性能</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/using-playwright-and-benchmark-js-to-test-javascript-performance-across-browsers-99fc0dc56e55?source=collection_archive---------3-----------------------#2021-11-05">https://javascript.plainenglish.io/using-playwright-and-benchmark-js-to-test-javascript-performance-across-browsers-99fc0dc56e55?source=collection_archive---------3-----------------------#2021-11-05</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="6f56" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">正如我们在<a class="ae ki" href="https://medium.com/@alowdon/testing-javascript-performance-with-benchmark-js-3d3f4e4b9fc2" rel="noopener">上一篇文章</a>中讨论的，Benchmark.js是测试JavaScript代码性能的一个有用的库。然而，由于JavaScript是一种<a class="ae ki" href="https://www.easytechjunkie.com/what-is-interpreted-language.htm" rel="noopener ugc nofollow" target="_blank">解释语言</a>，执行代码时的性能取决于使用的JavaScript引擎。不同的浏览器使用不同的JavaScript引擎:</p><ul class=""><li id="4d73" class="kj kk in jm b jn jo jr js jv kl jz km kd kn kh ko kp kq kr bi translated">谷歌的<a class="ae ki" href="https://v8.dev/" rel="noopener ugc nofollow" target="_blank"> V8 </a>是最常用的JavaScript引擎，用于基于<a class="ae ki" href="https://www.chromium.org/" rel="noopener ugc nofollow" target="_blank"> Chromium </a>的浏览器，如谷歌Chrome和微软Edge，以及<a class="ae ki" href="https://nodejs.org/" rel="noopener ugc nofollow" target="_blank"> Node.js </a>和<a class="ae ki" href="https://deno.land/" rel="noopener ugc nofollow" target="_blank"> Deno </a>运行时</li><li id="3d81" class="kj kk in jm b jn ks jr kt jv ku jz kv kd kw kh ko kp kq kr bi translated">蜘蛛猴由Mozilla开发，用于Firefox和其他项目</li><li id="f0fe" class="kj kk in jm b jn ks jr kt jv ku jz kv kd kw kh ko kp kq kr bi translated">JavaScriptCore是苹果的产品，用于基于WebKit的浏览器，比如Safari</li></ul><p id="5d46" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">进行更改时，我们必须验证对这些引擎性能的影响，这一点很重要；我们很容易对一些浏览器产生积极的影响，而对其他浏览器产生消极的影响，并且可能经常需要根据用户最常用的浏览器做出关于使用什么代码的务实决定。</p><figure class="ky kz la lb gt lc gh gi paragraph-image"><div role="button" tabindex="0" class="ld le di lf bf lg"><div class="gh gi kx"><img src="../Images/037d8680815e5397f6cd20260948bfe1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cCqtmD00FAusCUbO79-GMw.jpeg"/></div></div><figcaption class="lj lk gj gh gi ll lm bd b be z dk">Performance varies across different browser engines</figcaption></figure><p id="9f4d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">剧作家作为浏览器自动化工具正在迅速获得关注，它提供了针对Chromium、Firefox和WebKit的测试能力。因此，我们可以使用剧作家对我们上面提到的所有JavaScript引擎执行Benchmark.js测试。</p><p id="f3ba" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们将从我们之前在工作的示例测试套件开始。首先，我们需要安装剧作家测试运行器和支持的浏览器(使用这种方法将允许剧作家为您维护所需的浏览器引擎，但是如果您愿意，您可以<a class="ae ki" href="https://playwright.dev/docs/browsers#installing-browsers" rel="noopener ugc nofollow" target="_blank">使用现有的安装</a>)。</p><pre class="ky kz la lb gt ln lo lp lq aw lr bi"><span id="b314" class="ls lt in lo b gy lu lv l lw lx">npm i -D @playwright/test<br/>npx playwright install</span></pre><blockquote class="ly lz ma"><p id="9c93" class="jk jl mb jm b jn jo jp jq jr js jt ju mc jw jx jy md ka kb kc me ke kf kg kh ig bi translated">注意:在撰写本文时，如果您使用的是MacOS Monterey，您应该调用<code class="fe mf mg mh lo b">npm i -D @playwright/test@next</code>，因为在最新的稳定版本中，WebKit测试存在<a class="ae ki" href="https://github.com/microsoft/playwright/issues/9811" rel="noopener ugc nofollow" target="_blank">问题</a></p></blockquote><p id="0e30" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">接下来，我们需要创建一个spec文件供剧作家执行。默认情况下，测试被假定在一个<code class="fe mf mg mh lo b">tests</code>文件夹中，所以让我们在<code class="fe mf mg mh lo b">tests/bench.spec.js</code>创建一个新文件，内容如下:</p><pre class="ky kz la lb gt ln lo lp lq aw lr bi"><span id="3608" class="ls lt in lo b gy lu lv l lw lx">const { test } = require('@playwright/test');</span><span id="049c" class="ls lt in lo b gy mi lv l lw lx">test('Run benchmarks', async ({ page }) =&gt; {<br/>  await page.goto(`file://${process.cwd()}/bench.html`);<br/>});</span></pre><p id="d189" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们现在可以通过运行以下命令来运行测试:</p><pre class="ky kz la lb gt ln lo lp lq aw lr bi"><span id="c609" class="ls lt in lo b gy lu lv l lw lx">npx playwright test</span></pre><p id="5e85" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们将得到以下输出:</p><pre class="ky kz la lb gt ln lo lp lq aw lr bi"><span id="aeed" class="ls lt in lo b gy lu lv l lw lx">Running 1 test using 1 worker</span><span id="e2c3" class="ls lt in lo b gy mi lv l lw lx">✓  tests/bench.spec.js:3:1 › Run benchmarks (728ms)</span><span id="8a0d" class="ls lt in lo b gy mi lv l lw lx">1 passed (1s)</span></pre><p id="fa7c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">所以页面成功加载了，但是我们看不到基准测试的结果，这没有多大用处！幸运的是，我们可以捕获并显示控制台输出，我们之前通过监听来自剧作家的<code class="fe mf mg mh lo b">console</code>事件来查看基准测试结果。</p><p id="aca4" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们还可以从Benchmark.js <code class="fe mf mg mh lo b">complete</code>事件发布测试套件完成时的已知消息:</p><pre class="ky kz la lb gt ln lo lp lq aw lr bi"><span id="97c9" class="ls lt in lo b gy lu lv l lw lx">suite.on('complete', () =&gt; console.log('Benchmark suite complete.'))</span></pre><p id="1d78" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">并在允许剧作家测试完成之前等待已知消息以确保基准完成:</p><pre class="ky kz la lb gt ln lo lp lq aw lr bi"><span id="5f30" class="ls lt in lo b gy lu lv l lw lx">let benchmarkPromise = new Promise(resolve =&gt; {<br/>  page.on('console', async message =&gt; {<br/>    if (message.text() === 'Benchmark suite complete.') {<br/>      // if the suite has finished, we're done<br/>      resolve();<br/>    } else {<br/>      // pipe through any other console output<br/>      console[message.type()](message);<br/>    }<br/>  });<br/>});</span></pre><blockquote class="ly lz ma"><p id="f3ce" class="jk jl mb jm b jn jo jp jq jr js jt ju mc jw jx jy md ka kb kc me ke kf kg kh ig bi translated">注意:作为优秀的开发人员，我们显然应该将任何神奇的字符串放入共享常量中，但我们在这里这样做只是为了保持示例简单！</p></blockquote><p id="e74c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们现在可以<code class="fe mf mg mh lo b">await</code>在剧作家测试中实现这一承诺，当我们再次运行测试运行程序时，我们将在控制台上看到基准测试结果:</p><pre class="ky kz la lb gt ln lo lp lq aw lr bi"><span id="7985" class="ls lt in lo b gy lu lv l lw lx">Running 1 test using 1 worker</span><span id="f191" class="ls lt in lo b gy mi lv l lw lx">✓  tests/bench.spec.js:3:1 › Run benchmarks (13s)<br/>Array.prototype.some x 133 ops/sec ±0.89% (56 runs sampled)<br/>for loop x 1,724 ops/sec ±0.62% (60 runs sampled)</span><span id="ea46" class="ls lt in lo b gy mi lv l lw lx">1 passed (13s)</span></pre><p id="31d9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">成功！🎉默认情况下，剧作家使用Chromium引擎运行测试，因此要在所有浏览器上运行它们，我们需要使用以下代码:</p><pre class="ky kz la lb gt ln lo lp lq aw lr bi"><span id="51dc" class="ls lt in lo b gy lu lv l lw lx">npx playwright test --browser=all --workers=1</span></pre><p id="460f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><code class="fe mf mg mh lo b">browser</code>选项配置在哪些浏览器中运行测试，而<code class="fe mf mg mh lo b">all</code>将使用剧作家可以使用的所有浏览器。我们还包括了<code class="fe mf mg mh lo b">--workers=1</code>,因为剧作家默认并行运行测试，但这显然会影响我们的性能测试，所以这个选项只允许一个工人强制测试串行运行。我们的输出现在看起来像这样:</p><pre class="ky kz la lb gt ln lo lp lq aw lr bi"><span id="8e2b" class="ls lt in lo b gy lu lv l lw lx">Running 3 tests using 1 worker</span><span id="96b2" class="ls lt in lo b gy mi lv l lw lx">✓  [chromium] › tests/bench.spec.js:3:1 › Run benchmarks (13s)<br/>Array.prototype.some x 140 ops/sec ±1.14% (56 runs sampled)<br/>for loop x 1,793 ops/sec ±0.99% (61 runs sampled)<br/>  ✓  [firefox] › tests/bench.spec.js:3:1 › Run benchmarks (14s)<br/>Array.prototype.some x 224 ops/sec ±0.53% (60 runs sampled)<br/>for loop x 242 ops/sec ±1.10% (59 runs sampled)<br/>  ✓  [webkit] › tests/bench.spec.js:3:1 › Run benchmarks (12s)<br/>Array.prototype.some x 757 ops/sec ±22.39% (54 runs sampled)<br/>for loop x 1,756 ops/sec ±1.27% (60 runs sampled)</span><span id="2667" class="ls lt in lo b gy mi lv l lw lx">3 passed (40s)</span></pre><p id="4cba" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在，我们可以看到所有三个浏览器引擎的基准测试结果。正如这个例子所强调的，差异可能是实质性的，这证明了运行这些测试是多么有用！</p></div><div class="ab cl mj mk hr ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="ig ih ii ij ik"><p id="8225" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这里我们还可以做更多的事情，但是这篇介绍为使用剧作家协调跨浏览器的测试奠定了基础。以下是不同文件的最终版本，供参考:</p><figure class="ky kz la lb gt lc"><div class="bz fp l di"><div class="mq mr l"/></div></figure><p id="7e93" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><em class="mb">更多内容请看</em><a class="ae ki" href="http://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><strong class="jm io"><em class="mb">plain English . io</em></strong></a></p></div></div>    
</body>
</html>