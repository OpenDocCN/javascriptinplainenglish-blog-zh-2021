<html>
<head>
<title>How To Build A Reliable Authentication API With Fastify</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用Fastify构建可靠的认证API</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/how-to-build-a-reliable-authentication-api-with-fastify-c5a24bf8cd41?source=collection_archive---------6-----------------------#2021-11-02">https://javascript.plainenglish.io/how-to-build-a-reliable-authentication-api-with-fastify-c5a24bf8cd41?source=collection_archive---------6-----------------------#2021-11-02</a></blockquote><div><div class="fc if ig ih ii ij"/><div class="ik il im in io"><h2 id="a36e" class="ip iq ir bd b dl is it iu iv iw ix dk iy translated" aria-label="kicker paragraph">Web开发|认证</h2><div class=""/><div class=""><h2 id="6e1f" class="pw-subtitle-paragraph jx ja ir bd b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko dk translated">使用这个新的Node.js框架构建可靠的Auth API</h2></div><figure class="kq kr ks kt gu ku gi gj paragraph-image"><div role="button" tabindex="0" class="kv kw di kx bf ky"><div class="gi gj kp"><img src="../Images/5ce1c02ba38324cfd7be8d0758958fea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4TVJb8fuPQEjBKNSXF37xg.jpeg"/></div></div><figcaption class="lb lc gk gi gj ld le bd b be z dk"><a class="ae lf" href="https://unsplash.com/photos/044AnorPjAU" rel="noopener ugc nofollow" target="_blank">Image By Jexo on Unsplash</a></figcaption></figure><p id="7b5e" class="pw-post-body-paragraph lg lh ir li b lj lk kb ll lm ln ke lo lp lq lr ls lt lu lv lw lx ly lz ma mb ik bi translated">在web开发中，我一直在与身份验证作斗争。我讨厌构建这些API，但是现在，<a class="ae lf" href="https://github.com/fastify/fastify" rel="noopener ugc nofollow" target="_blank">有了Fastify </a>，我实际上非常喜欢它。有了这个快速简洁的JavaScript框架，我们将构建一个带有MongoDB连接的身份验证API。</p></div><div class="ab cl mc md hv me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="ik il im in io"><h1 id="2424" class="mj mk ir bd ml mm mn mo mp mq mr ms mt kg mu kh mv kj mw kk mx km my kn mz na bi translated">什么是Fastify？</h1><p id="0e84" class="pw-post-body-paragraph lg lh ir li b lj nb kb ll lm nc ke lo lp nd lr ls lt ne lv lw lx nf lz ma mb ik bi translated">Fastify是Node.js的一个高效的web框架<a class="ae lf" href="https://github.com/fastify/fastify" rel="noopener ugc nofollow" target="_blank">，它专注于</a>开发人员的便利。这个框架不仅速度快，而且还附带了一个高级且非常易于使用的插件系统。</p></div><div class="ab cl mc md hv me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="ik il im in io"><h1 id="832c" class="mj mk ir bd ml mm mn mo mp mq mr ms mt kg mu kh mv kj mw kk mx km my kn mz na bi translated">要求</h1><p id="fe39" class="pw-post-body-paragraph lg lh ir li b lj nb kb ll lm nc ke lo lp nd lr ls lt ne lv lw lx nf lz ma mb ik bi translated">如果你想开始使用Fastify，你需要做一些准备:</p><ul class=""><li id="244e" class="ng nh ir li b lj lk lm ln lp ni lt nj lx nk mb nl nm nn no bi translated"><a class="ae lf" href="https://nodejs.org/en/" rel="noopener ugc nofollow" target="_blank"> Node.js </a></li><li id="3054" class="ng nh ir li b lj np lm nq lp nr lt ns lx nt mb nl nm nn no bi translated"><a class="ae lf" href="https://www.npmjs.com/" rel="noopener ugc nofollow" target="_blank"> NPM </a></li><li id="77cc" class="ng nh ir li b lj np lm nq lp nr lt ns lx nt mb nl nm nn no bi translated">NPM软件包(我们稍后会谈到)</li></ul></div><div class="ab cl mc md hv me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="ik il im in io"><h1 id="83a8" class="mj mk ir bd ml mm mn mo mp mq mr ms mt kg mu kh mv kj mw kk mx km my kn mz na bi translated">入门指南</h1><p id="06df" class="pw-post-body-paragraph lg lh ir li b lj nb kb ll lm nc ke lo lp nd lr ls lt ne lv lw lx nf lz ma mb ik bi translated">要初始化节点项目，请在终端中输入以下代码行:</p><pre class="kq kr ks kt gu nu nv nw nx aw ny bi"><span id="5524" class="nz mk ir nv b gz oa ob l oc od">&gt; npm init -y</span></pre><p id="c9f0" class="pw-post-body-paragraph lg lh ir li b lj lk kb ll lm ln ke lo lp lq lr ls lt lu lv lw lx ly lz ma mb ik bi translated">这将为您设置一个节点环境。现在，我们将安装Fastify所需的软件包/模块:</p><pre class="kq kr ks kt gu nu nv nw nx aw ny bi"><span id="d224" class="nz mk ir nv b gz oa ob l oc od">&gt; npm i bcryptjs fastify fastify-auth fastify-plugin jsonwebtoken mongoose nodemon</span></pre><p id="d1d9" class="pw-post-body-paragraph lg lh ir li b lj lk kb ll lm ln ke lo lp lq lr ls lt lu lv lw lx ly lz ma mb ik bi translated">在我们的<code class="fe oe of og nv b">package.json</code>中，我们添加了以下脚本:</p><figure class="kq kr ks kt gu ku"><div class="bz fq l di"><div class="oh oi l"/></div></figure><p id="8fe9" class="pw-post-body-paragraph lg lh ir li b lj lk kb ll lm ln ke lo lp lq lr ls lt lu lv lw lx ly lz ma mb ik bi translated">我们调用我们的主文件:<code class="fe oe of og nv b">server.js</code></p></div><div class="ab cl mc md hv me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="ik il im in io"><h1 id="77db" class="mj mk ir bd ml mm mn mo mp mq mr ms mt kg mu kh mv kj mw kk mx km my kn mz na bi translated">设置Fastify服务器</h1><p id="3dcc" class="pw-post-body-paragraph lg lh ir li b lj nb kb ll lm nc ke lo lp nd lr ls lt ne lv lw lx nf lz ma mb ik bi translated">如果你熟悉node和express，也许你知道我们要设置一个web服务器，有了Fastify，这是非常容易的。</p><figure class="kq kr ks kt gu ku"><div class="bz fq l di"><div class="oh oi l"/></div></figure><p id="45be" class="pw-post-body-paragraph lg lh ir li b lj lk kb ll lm ln ke lo lp lq lr ls lt lu lv lw lx ly lz ma mb ik bi translated">这将运行我们的web服务器。在你的终端输入<code class="fe oe of og nv b">npm run dev</code>启动服务器。</p></div><div class="ab cl mc md hv me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="ik il im in io"><h1 id="8eab" class="mj mk ir bd ml mm mn mo mp mq mr ms mt kg mu kh mv kj mw kk mx km my kn mz na bi translated">创建用户模型</h1><p id="8e8c" class="pw-post-body-paragraph lg lh ir li b lj nb kb ll lm nc ke lo lp nd lr ls lt ne lv lw lx nf lz ma mb ik bi translated">创建用户模型允许我们创建一个结构来保存用户数据。如果你想了解更多关于<a class="ae lf" href="https://en.wikipedia.org/wiki/Programming_model#:~:text=A%20programming%20model%20refers%20to,Threads%20library%20and%20Hadoop's%20MapReduce.&amp;text=In%20parallel%20computing%2C%20the%20execution,order%20to%20achieve%20high%20performance" rel="noopener ugc nofollow" target="_blank">编程模型的知识，请点击这个链接。</a>如果你对你应该知道的编程概念感兴趣，我推荐你这篇文章:</p><div class="oj ok gq gs ol om"><a href="https://levelup.gitconnected.com/5-critical-coding-concepts-that-will-move-you-from-a-beginner-to-an-intermediate-programmer-c94670a564c8" rel="noopener  ugc nofollow" target="_blank"><div class="on ab fp"><div class="oo ab op cl cj oq"><h2 class="bd jb gz z fq or fs ft os fv fx ja bi translated">5个关键的编码概念将帮助你从初学者成为中级程序员</h2><div class="ot l"><h3 class="bd b gz z fq or fs ft os fv fx dk translated">编程不仅仅是“你好，世界”和斐波那契</h3></div><div class="ou l"><p class="bd b dl z fq or fs ft os fv fx dk translated">levelup.gitconnected.com</p></div></div><div class="ov l"><div class="ow l ox oy oz ov pa kz om"/></div></div></a></div><p id="ba8d" class="pw-post-body-paragraph lg lh ir li b lj lk kb ll lm ln ke lo lp lq lr ls lt lu lv lw lx ly lz ma mb ik bi translated">为了创建一个用户模型，我们创建一个名为<code class="fe oe of og nv b">models</code>的新文件夹，并添加一个名为<code class="fe oe of og nv b">User.js</code>的文件:</p><figure class="kq kr ks kt gu ku"><div class="bz fq l di"><div class="oh oi l"/></div></figure><p id="2576" class="pw-post-body-paragraph lg lh ir li b lj lk kb ll lm ln ke lo lp lq lr ls lt lu lv lw lx ly lz ma mb ik bi translated">这为我们的用户数据设置了一个容器。我们还需要验证它是否已经在我们的数据库中，并且我们需要导出模型。这将完成User.js类:</p><figure class="kq kr ks kt gu ku"><div class="bz fq l di"><div class="oh oi l"/></div></figure></div><div class="ab cl mc md hv me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="ik il im in io"><h1 id="5230" class="mj mk ir bd ml mm mn mo mp mq mr ms mt kg mu kh mv kj mw kk mx km my kn mz na bi translated">设置我们的路线</h1><p id="a1dc" class="pw-post-body-paragraph lg lh ir li b lj nb kb ll lm nc ke lo lp nd lr ls lt ne lv lw lx nf lz ma mb ik bi translated">创建我们的路线分为两部分:</p><ul class=""><li id="54e9" class="ng nh ir li b lj lk lm ln lp ni lt nj lx nk mb nl nm nn no bi translated">设置Fastify身份验证</li><li id="d30e" class="ng nh ir li b lj np lm nq lp nr lt ns lx nt mb nl nm nn no bi translated">设置路线</li></ul><p id="0dcb" class="pw-post-body-paragraph lg lh ir li b lj lk kb ll lm ln ke lo lp lq lr ls lt lu lv lw lx ly lz ma mb ik bi translated">我们需要创建一个新的<code class="fe oe of og nv b">routes</code>文件夹并添加一个<code class="fe oe of og nv b">Users.js</code>文件，然后导入模块和我们的模型。接下来是路由功能和授权设置:</p><figure class="kq kr ks kt gu ku"><div class="bz fq l di"><div class="oh oi l"/></div></figure><p id="c48d" class="pw-post-body-paragraph lg lh ir li b lj lk kb ll lm ln ke lo lp lq lr ls lt lu lv lw lx ly lz ma mb ik bi translated">这两种方法验证令牌以及用户名和密码，它还将检查给定的用户名是否已经在数据库中注册。尽管如此，我们将在下一节讨论我们的数据库。</p><p id="cd6d" class="pw-post-body-paragraph lg lh ir li b lj lk kb ll lm ln ke lo lp lq lr ls lt lu lv lw lx ly lz ma mb ik bi translated">使用以下代码注册路线，创建一个新的<code class="fe oe of og nv b">User</code>对象，并将其存储在我们的MongoDB数据库中:</p><figure class="kq kr ks kt gu ku"><div class="bz fq l di"><div class="oh oi l"/></div></figure></div><div class="ab cl mc md hv me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="ik il im in io"><h1 id="4cbb" class="mj mk ir bd ml mm mn mo mp mq mr ms mt kg mu kh mv kj mw kk mx km my kn mz na bi translated">建立与MongoDB的连接</h1><p id="d27e" class="pw-post-body-paragraph lg lh ir li b lj nb kb ll lm nc ke lo lp nd lr ls lt ne lv lw lx nf lz ma mb ik bi translated">当我们设置好路由后，您可能会注意到我们在数据库中<code class="fe oe of og nv b">.save()</code>了它，但是连接还没有建立。我们现在就去做。用<code class="fe oe of og nv b">index.js</code>文件创建一个<code class="fe oe of og nv b">config</code>文件夹，输入以下代码:</p><figure class="kq kr ks kt gu ku"><div class="bz fq l di"><div class="oh oi l"/></div></figure><p id="5e2f" class="pw-post-body-paragraph lg lh ir li b lj lk kb ll lm ln ke lo lp lq lr ls lt lu lv lw lx ly lz ma mb ik bi translated">这将使我们的API工作。最后要做的事情是<code class="fe oe of og nv b">server.js</code>必须连接到这3个文件。我们使用<code class="fe oe of og nv b">dotenv</code>来获取我们的连接字符串，就像我们使用<code class="fe oe of og nv b">dotenv</code>来获取我们的秘密令牌一样。</p><figure class="kq kr ks kt gu ku"><div class="bz fq l di"><div class="oh oi l"/></div></figure></div><div class="ab cl mc md hv me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="ik il im in io"><h1 id="a320" class="mj mk ir bd ml mm mn mo mp mq mr ms mt kg mu kh mv kj mw kk mx km my kn mz na bi translated">测试我们的API</h1><p id="1c16" class="pw-post-body-paragraph lg lh ir li b lj nb kb ll lm nc ke lo lp nd lr ls lt ne lv lw lx nf lz ma mb ik bi translated">为了测试API，我使用了一个名为<a class="ae lf" href="https://marketplace.visualstudio.com/items?itemName=humao.rest-client" rel="noopener ugc nofollow" target="_blank"> REST Client </a>的visual studio代码扩展。这个插件允许你用你的HTTP请求创建一个测试文件。让我们创建一个名为<code class="fe oe of og nv b">test.http</code>的。</p><p id="cee8" class="pw-post-body-paragraph lg lh ir li b lj lk kb ll lm ln ke lo lp lq lr ls lt lu lv lw lx ly lz ma mb ik bi translated">我们要调用的第一条路线是<code class="fe oe of og nv b">Register</code>路线:</p><figure class="kq kr ks kt gu ku"><div class="bz fq l di"><div class="oh oi l"/></div></figure><p id="1398" class="pw-post-body-paragraph lg lh ir li b lj lk kb ll lm ln ke lo lp lq lr ls lt lu lv lw lx ly lz ma mb ik bi translated">当我们运行时，您将看到您成功地创建了一个新用户。让我们尝试检索该用户。首先复制您收到的令牌，然后创建一个新请求:</p><figure class="kq kr ks kt gu ku"><div class="bz fq l di"><div class="oh oi l"/></div></figure><p id="4f1f" class="pw-post-body-paragraph lg lh ir li b lj lk kb ll lm ln ke lo lp lq lr ls lt lu lv lw lx ly lz ma mb ik bi translated">当一切都设置正确后，您将收到您刚刚创建的用户。让我们尝试注销:</p><figure class="kq kr ks kt gu ku"><div class="bz fq l di"><div class="oh oi l"/></div></figure><p id="739b" class="pw-post-body-paragraph lg lh ir li b lj lk kb ll lm ln ke lo lp lq lr ls lt lu lv lw lx ly lz ma mb ik bi translated">如果您想再次登录:</p><figure class="kq kr ks kt gu ku"><div class="bz fq l di"><div class="oh oi l"/></div></figure><p id="04f8" class="pw-post-body-paragraph lg lh ir li b lj lk kb ll lm ln ke lo lp lq lr ls lt lu lv lw lx ly lz ma mb ik bi translated">你会得到一个新的令牌。</p><p id="5c7e" class="pw-post-body-paragraph lg lh ir li b lj lk kb ll lm ln ke lo lp lq lr ls lt lu lv lw lx ly lz ma mb ik bi translated">瞧啊。您已经有了一个有效的身份验证API。</p><p id="0536" class="pw-post-body-paragraph lg lh ir li b lj lk kb ll lm ln ke lo lp lq lr ls lt lu lv lw lx ly lz ma mb ik bi translated">如果你对更多关于认证的解释感兴趣，看看David F的这个精彩故事，他向你解释了如何使用NextAuth:</p><div class="oj ok gq gs ol om"><a href="https://davidfrnks7.medium.com/authenticate-users-with-nextauth-2e7aa6f050a" rel="noopener follow" target="_blank"><div class="on ab fp"><div class="oo ab op cl cj oq"><h2 class="bd jb gz z fq or fs ft os fv fx ja bi translated">使用NextAuth验证用户</h2><div class="ot l"><h3 class="bd b gz z fq or fs ft os fv fx dk translated">NextAuth是Next.js应用程序的开源身份验证提供者。它是为无服务器应用程序而构建的，非常…</h3></div><div class="ou l"><p class="bd b dl z fq or fs ft os fv fx dk translated">davidfrnks7.medium.com</p></div></div><div class="ov l"><div class="pd l ox oy oz ov pa kz om"/></div></div></a></div><p id="8c50" class="pw-post-body-paragraph lg lh ir li b lj lk kb ll lm ln ke lo lp lq lr ls lt lu lv lw lx ly lz ma mb ik bi translated">如果你喜欢我的文章，你可以在这里注册我的免费邮箱。 </p><div class="oj ok gq gs ol om"><a href="https://bryandijkh.medium.com/membership" rel="noopener follow" target="_blank"><div class="on ab fp"><div class="oo ab op cl cj oq"><h2 class="bd jb gz z fq or fs ft os fv fx ja bi translated">通过我的推荐链接加入媒体——布莱恩·迪克伊岑</h2><div class="ot l"><h3 class="bd b gz z fq or fs ft os fv fx dk translated">阅读布莱恩·迪克伊岑(以及媒体上成千上万的其他作家)的每一个故事。您的会员费直接…</h3></div><div class="ou l"><p class="bd b dl z fq or fs ft os fv fx dk translated">bryandijkh.medium.com</p></div></div><div class="ov l"><div class="pe l ox oy oz ov pa kz om"/></div></div></a></div></div><div class="ab cl mc md hv me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="ik il im in io"><h1 id="a9ba" class="mj mk ir bd ml mm mn mo mp mq mr ms mt kg mu kh mv kj mw kk mx km my kn mz na bi translated">参考资料和来源</h1><ul class=""><li id="6498" class="ng nh ir li b lj nb lm nc lp pf lt pg lx ph mb nl nm nn no bi translated"><a class="ae lf" href="https://www.fastify.io/" rel="noopener ugc nofollow" target="_blank">https://www.fastify.io/</a></li><li id="be53" class="ng nh ir li b lj np lm nq lp nr lt ns lx nt mb nl nm nn no bi translated">https://www.fastify.io/docs/latest/Getting-Started/<a class="ae lf" href="https://www.fastify.io/docs/latest/Getting-Started/" rel="noopener ugc nofollow" target="_blank"/></li><li id="222f" class="ng nh ir li b lj np lm nq lp nr lt ns lx nt mb nl nm nn no bi translated">【https://github.com/fastify/fastify-jwt T4】</li><li id="e812" class="ng nh ir li b lj np lm nq lp nr lt ns lx nt mb nl nm nn no bi translated"><a class="ae lf" href="https://daily.dev/blog/fastify-authentication-strategy" rel="noopener ugc nofollow" target="_blank">https://daily.dev/blog/fastify-authentication-strategy</a></li></ul><p id="f3f1" class="pw-post-body-paragraph lg lh ir li b lj lk kb ll lm ln ke lo lp lq lr ls lt lu lv lw lx ly lz ma mb ik bi translated"><em class="pi">更多内容请看</em><a class="ae lf" href="http://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><strong class="li jb"><em class="pi">plain English . io</em></strong></a></p></div></div>    
</body>
</html>