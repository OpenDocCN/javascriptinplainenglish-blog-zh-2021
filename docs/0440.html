<html>
<head>
<title>Mongoose (validation + hooks = 🔥)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">猫鼬(验证+挂钩=🔥)</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/mongoose-validation-hooks-652f77b665e2?source=collection_archive---------9-----------------------#2021-01-26">https://javascript.plainenglish.io/mongoose-validation-hooks-652f77b665e2?source=collection_archive---------9-----------------------#2021-01-26</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="b6df" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">mongoose内置的验证和钩子有时是多么强大等等</h2></div><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi kc"><img src="../Images/63f03a3b9857b227a141946af098793a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*te5qr8rlPJW70lIn"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Photo by <a class="ae ks" href="https://unsplash.com/@manuelsardo?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Manuel Sardo</a> on <a class="ae ks" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="7429" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">Mongoose是mongo DB数据库的一个<strong class="kv io"> ODM(对象文档建模器)</strong>。它提供了诸如内置转换、查询构建、验证等便利。</p><h1 id="15c0" class="lp lq in bd lr ls lt lu lv lw lx ly lz jt ma ju mb jw mc jx md jz me ka mf mg bi translated"><strong class="ak">验证</strong></h1><p id="6cfa" class="pw-post-body-paragraph kt ku in kv b kw mh jo ky kz mi jr lb lc mj le lf lg mk li lj lk ml lm ln lo ig bi translated">您一定已经在express中使用了<a class="ae ks" href="https://www.npmjs.com/package/joi" rel="noopener ugc nofollow" target="_blank"> joi </a>进行模式验证，但是如果我们可以使用mongose进行验证，为什么还要使用joi这样的沉重的包呢，现在我们将看到如何使用mongoose validate函数来验证模式。</p><p id="c752" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">在这里，我创建了一个注册新用户的简单路径:</p><pre class="kd ke kf kg gt mm mn mo mp aw mq bi"><span id="4404" class="mr lq in mn b gy ms mt l mu mv">// *NEW USER ROUTE</span><span id="8ce7" class="mr lq in mn b gy mw mt l mu mv">app.post("/register", async (req, res) =&gt; {</span><span id="3e88" class="mr lq in mn b gy mw mt l mu mv">try {</span><span id="bc2f" class="mr lq in mn b gy mw mt l mu mv">const user = await User.create(req.body);</span><span id="3158" class="mr lq in mn b gy mw mt l mu mv">res.json({ success: true, message: "User saved successfuly!!" });</span><span id="1607" class="mr lq in mn b gy mw mt l mu mv">} catch (e) {</span><span id="b70d" class="mr lq in mn b gy mw mt l mu mv">return res.status(400).json({ success: false, messge: e.message });</span><span id="e085" class="mr lq in mn b gy mw mt l mu mv">}</span><span id="32a5" class="mr lq in mn b gy mw mt l mu mv">});</span></pre><p id="9a7f" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated"><em class="mx">用户型号:</em></p><pre class="kd ke kf kg gt mm mn mo mp aw mq bi"><span id="c3cc" class="mr lq in mn b gy ms mt l mu mv">const mongoose = require("mongoose");</span><span id="33ad" class="mr lq in mn b gy mw mt l mu mv">const bcrypt = require("bcryptjs");</span><span id="4f69" class="mr lq in mn b gy mw mt l mu mv">const User = new mongoose.Schema({</span><span id="d7d7" class="mr lq in mn b gy mw mt l mu mv">name: {</span><span id="173f" class="mr lq in mn b gy mw mt l mu mv">type: String,</span><span id="defe" class="mr lq in mn b gy mw mt l mu mv">required: true,</span><span id="1bc9" class="mr lq in mn b gy mw mt l mu mv">},</span><span id="047e" class="mr lq in mn b gy mw mt l mu mv">email: {</span><span id="3a15" class="mr lq in mn b gy mw mt l mu mv">type: String,</span><span id="7a35" class="mr lq in mn b gy mw mt l mu mv">required: true,</span><span id="9023" class="mr lq in mn b gy mw mt l mu mv">unique: true,</span><span id="990c" class="mr lq in mn b gy mw mt l mu mv">},</span><span id="6201" class="mr lq in mn b gy mw mt l mu mv">phone: {</span><span id="b3d8" class="mr lq in mn b gy mw mt l mu mv">type: String,</span><span id="df3e" class="mr lq in mn b gy mw mt l mu mv">required: true,<br/>},</span><span id="c269" class="mr lq in mn b gy mw mt l mu mv">password: {</span><span id="3f82" class="mr lq in mn b gy mw mt l mu mv">type: String,</span><span id="c75f" class="mr lq in mn b gy mw mt l mu mv">required: true</span><span id="3f95" class="mr lq in mn b gy mw mt l mu mv">},</span><span id="a810" class="mr lq in mn b gy mw mt l mu mv">});</span><span id="9e4e" class="mr lq in mn b gy mw mt l mu mv">module.exports = mongoose.model("user", User);</span></pre><p id="face" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated"><em class="mx">如果您想要自定义错误消息:</em></p><pre class="kd ke kf kg gt mm mn mo mp aw mq bi"><span id="e53b" class="mr lq in mn b gy ms mt l mu mv">....<br/>required: [true, "phone number is required"]<br/>....</span></pre><p id="a9d6" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated"><strong class="kv io"> <em class="mx">注意</em> </strong> <em class="mx"> : unique不是验证器</em></p><h1 id="1e0c" class="lp lq in bd lr ls lt lu lv lw lx ly lz jt ma ju mb jw mc jx md jz me ka mf mg bi translated"><strong class="ak">添加验证</strong></h1><p id="7edf" class="pw-post-body-paragraph kt ku in kv b kw mh jo ky kz mi jr lb lc mj le lf lg mk li lj lk ml lm ln lo ig bi translated">Mongoose使用一个内置的验证函数来验证模式，并返回一条定制消息。</p><p id="33ba" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">(ps:验证接触长度)</p><p id="20e1" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">"输入的输入作为参数传递给消息"</p><pre class="kd ke kf kg gt mm mn mo mp aw mq bi"><span id="5165" class="mr lq in mn b gy ms mt l mu mv">phone: {</span><span id="b744" class="mr lq in mn b gy mw mt l mu mv">type: String,</span><span id="1eb4" class="mr lq in mn b gy mw mt l mu mv">required: [true, "Phone number is required !"],</span><span id="2f49" class="mr lq in mn b gy mw mt l mu mv">validate: {</span><span id="4a2a" class="mr lq in mn b gy mw mt l mu mv">validator: (v) =&gt; {</span><span id="30de" class="mr lq in mn b gy mw mt l mu mv">return v.length == 10;</span><span id="f3f8" class="mr lq in mn b gy mw mt l mu mv">},</span><span id="7e74" class="mr lq in mn b gy mw mt l mu mv">message: (props) =&gt; props.value + " Must be 10 digits !",</span><span id="2c9e" class="mr lq in mn b gy mw mt l mu mv">},</span><span id="4437" class="mr lq in mn b gy mw mt l mu mv">},</span></pre><p id="f893" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated"><strong class="kv io">使用正则表达式:</strong></p><pre class="kd ke kf kg gt mm mn mo mp aw mq bi"><span id="0d81" class="mr lq in mn b gy ms mt l mu mv">email: {</span><span id="1069" class="mr lq in mn b gy mw mt l mu mv">type: String,</span><span id="e5cf" class="mr lq in mn b gy mw mt l mu mv">required: [true, "email is required !!"],</span><span id="25ac" class="mr lq in mn b gy mw mt l mu mv">unique: true,</span><span id="9fe9" class="mr lq in mn b gy mw mt l mu mv">validate: {</span><span id="e311" class="mr lq in mn b gy mw mt l mu mv">validator: (email) =&gt; {</span><span id="94a1" class="mr lq in mn b gy mw mt l mu mv">const pattern = /^[A-Z0-9._%+-]+@([A-Z0-9-]+\.)+[A-Z]{2,4}$/i;</span><span id="1d85" class="mr lq in mn b gy mw mt l mu mv">return pattern.test(email);</span><span id="5816" class="mr lq in mn b gy mw mt l mu mv">},</span><span id="7c6d" class="mr lq in mn b gy mw mt l mu mv">message: (props) =&gt; `${props.value} is not in correct format !!`,</span><span id="f905" class="mr lq in mn b gy mw mt l mu mv">},</span><span id="c455" class="mr lq in mn b gy mw mt l mu mv">},</span></pre><blockquote class="my mz na"><p id="7e83" class="kt ku mx kv b kw kx jo ky kz la jr lb nb ld le lf nc lh li lj nd ll lm ln lo ig bi translated">现在，在创建一个新用户时，你不必担心验证，mongoose会相应地处理和抛出验证！！</p></blockquote><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi ne"><img src="../Images/444da0c8268135fd714c2d98d3274d28.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VHaSO_RCAHAbMHOuwnD1NA.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Postman screenshot</figcaption></figure><p id="8152" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">同样，当使用不正确的电子邮件时:</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi ne"><img src="../Images/103ac3ded461630a67328426c60961ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*377vMxoCljo1S6Y4ma1A9w.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Postman Screenshot</figcaption></figure><p id="2722" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">瞧啊。再见，乔伊。</p><h1 id="dbf1" class="lp lq in bd lr ls lt lu lv lw lx ly lz jt ma ju mb jw mc jx md jz me ka mf mg bi translated">下一步:使用猫鼬钩</h1><p id="8880" class="pw-post-body-paragraph kt ku in kv b kw mh jo ky kz mi jr lb lc mj le lf lg mk li lj lk ml lm ln lo ig bi translated">主要有两种被广泛使用的猫鼬钩:</p><ul class=""><li id="132b" class="nf ng in kv b kw kx kz la lc nh lg ni lk nj lo nk nl nm nn bi translated"><em class="mx">【pre】</em>:在保存模型之前做一些事情。</li><li id="be49" class="nf ng in kv b kw no kz np lc nq lg nr lk ns lo nk nl nm nn bi translated"><em class="mx">“post”</em>:保存模型后做一些事情。</li></ul><p id="988c" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated"><strong class="kv io">使用钩子/中间件:</strong></p><p id="32c8" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">如果我们在pre hook中控制台记录这个，我们得到req.body或用户输入的内容。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi nt"><img src="../Images/d3d9dea03fac8e78e5f2f7ece2a9044f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*z3YxRpwOFwf5Ee5TMwgoKw.png"/></div></div></figure><p id="70b2" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">在使用<a class="ae ks" href="https://www.npmjs.com/package/bcryptjs" rel="noopener ugc nofollow" target="_blank"> bcrypt库</a>将密码保存到数据库之前，让我们对密码进行哈希运算。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi nu"><img src="../Images/91e0d001cf6f6435a6a4070e71da7384.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UxQDyFZKFLqsR5esBaVZcw.png"/></div></div></figure><p id="5ec8" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">由于<em class="mx"> pre </em>是一个中间件，它以next作为参数，也可以返回承诺，成功完成后，它调用next()中间件。</p><h2 id="b40f" class="mr lq in bd lr nv nw dn lv nx ny dp lz lc nz oa mb lg ob oc md lk od oe mf of bi translated">让我们看看这是否有效…</h2><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi og"><img src="../Images/5d6f9ce771c76ce6957ccaae8fb23657.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nIzFg6Mp_b-bhPNYFhla4A.png"/></div></div></figure><p id="b51e" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated"><em class="mx">现在我们的密码是hash，我们没有对控制器做任何更改。</em></p><p id="3cad" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">类似地，post hook在保存模型后工作。</p><p id="1ab0" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">中间件可以接受的事件:</p><ul class=""><li id="33dd" class="nf ng in kv b kw kx kz la lc nh lg ni lk nj lo nk nl nm nn bi translated">"保存"</li><li id="bda1" class="nf ng in kv b kw no kz np lc nq lg nr lk ns lo nk nl nm nn bi translated">"移除"</li><li id="ddcc" class="nf ng in kv b kw no kz np lc nq lg nr lk ns lo nk nl nm nn bi translated">"验证"</li></ul><p id="51d9" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">还有<a class="ae ks" href="https://mongoosejs.com/docs/validation.html" rel="noopener ugc nofollow" target="_blank">更有</a>。</p><p id="4526" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated"><em class="mx">最终源代码:</em> <a class="ae ks" href="https://github.com/anandpd/mongoose-validation-medium" rel="noopener ugc nofollow" target="_blank"> <em class="mx">链接</em> </a></p><p id="bb5b" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">如果你已经到达这里，感谢你阅读这篇文章，我希望它清楚的使用mongoose验证和中间件/钩子。如果你喜欢，别忘了留下掌声。</p><p id="d175" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">谢谢大家！</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi oh"><img src="../Images/f3202fbfef8ebae26a9accccb442316a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*zNo4Rh2rjnrYYdow"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Photo by <a class="ae ks" href="https://unsplash.com/@kellysikkema?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Kelly Sikkema</a> on <a class="ae ks" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure></div></div>    
</body>
</html>