<html>
<head>
<title>GraphQL for Beginners: Build Real-Time Chat App with Apollo Client and React</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">面向初学者的GraphQL:用Apollo客户端构建实时聊天应用并做出反应</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/graphql-for-beginners-build-real-time-chat-app-with-apollo-client-and-react-278d22e1d135?source=collection_archive---------12-----------------------#2021-09-04">https://javascript.plainenglish.io/graphql-for-beginners-build-real-time-chat-app-with-apollo-client-and-react-278d22e1d135?source=collection_archive---------12-----------------------#2021-09-04</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="138b" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">GraphQL初学者友好系列🔰继续我们的app吧！第4部分结尾:用React和Apollo客户端设置客户端。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/e7ae166cd6fe9fb4cfa99debe5e8ff89.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*05g4NuTfRJ0hDQno"/></div></div></figure><p id="bcd9" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">欢迎回到<a class="ae ln" href="https://lo-victoria.com/series/graphql" rel="noopener ugc nofollow" target="_blank"> GraphQL初学者版</a>！这是一个对初学者友好的系列，介绍了GraphQL的基本概念，以及如何将其连接到前端框架，如使用Apollo的React。</p><p id="1bca" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在这一部分，我们将通过使用React和Apollo客户端构建我们的前端来完成我们的简单聊天应用程序。</p><blockquote class="lo lp lq"><p id="43ad" class="kr ks lr kt b ku kv jr kw kx ky ju kz ls lb lc ld lt lf lg lh lu lj lk ll lm ij bi translated">如果你没有看过前面的部分，请阅读:</p></blockquote><ul class=""><li id="84db" class="lv lw iq kt b ku kv kx ky la lx le ly li lz lm ma mb mc md bi translated"><a class="ae ln" href="https://victoria2666.medium.com/graphql-for-beginners-introduction-90c78a56a96e?sk=ee4885321344329d8af3096f9074427b" rel="noopener">第1部分:GraphQL简介</a></li><li id="b642" class="lv lw iq kt b ku me kx mf la mg le mh li mi lm ma mb mc md bi translated"><a class="ae ln" href="https://victoria2666.medium.com/graphql-for-beginners-subscriptions-schemas-and-servers-c4b440e3b2aa?sk=0141fe163f173af76e407e8688c3fa8f" rel="noopener">第2部分:模式、订阅和服务器</a></li><li id="b1ba" class="lv lw iq kt b ku me kx mf la mg le mh li mi lm ma mb mc md bi translated"><a class="ae ln" href="https://victoria2666.medium.com/graphql-for-beginners-setting-up-graphql-server-ba48a3cbc184?sk=330d2a07f119d5734ae2424a417eecd1" rel="noopener">第3部分:设置GraphQL服务器</a></li></ul><h1 id="ad75" class="mj mk iq bd ml mm mn mo mp mq mr ms mt jw mu jx mv jz mw ka mx kc my kd mz na bi translated">步骤1:创建一个React应用程序</h1><p id="03a2" class="pw-post-body-paragraph kr ks iq kt b ku nb jr kw kx nc ju kz la nd lc ld le ne lg lh li nf lk ll lm ij bi translated">概括地说，我们的项目文件夹中目前有一个<code class="fe ng nh ni nj b">server</code>文件夹。现在让我们为React应用程序创建一个<code class="fe ng nh ni nj b">client</code>文件夹。</p><p id="deda" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在我们的<code class="fe ng nh ni nj b">client</code>文件夹中，我们可以创建一个新的React应用程序:</p><pre class="kg kh ki kj gt nk nj nl nm aw nn bi"><span id="76c8" class="no mk iq nj b gy np nq l nr ns">npx create-react-app my-app</span></pre><p id="a82d" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">现在，您的项目文件夹应该如下所示:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nt"><img src="../Images/0427effa22ecc01ead6d3f1a73bca2c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*gocRaBDO7Co-4adW"/></div></div></figure><h1 id="92a2" class="mj mk iq bd ml mm mn mo mp mq mr ms mt jw mu jx mv jz mw ka mx kc my kd mz na bi translated">步骤2:安装软件包</h1><p id="c54e" class="pw-post-body-paragraph kr ks iq kt b ku nb jr kw kx nc ju kz la nd lc ld le ne lg lh li nf lk ll lm ij bi translated">要将React应用程序连接到GraphQL服务器，我们需要安装几个包:</p><ul class=""><li id="c541" class="lv lw iq kt b ku kv kx ky la lx le ly li lz lm ma mb mc md bi translated"><code class="fe ng nh ni nj b">@apollo/client</code>:在React应用中设置Apollo客户端</li><li id="0a00" class="lv lw iq kt b ku me kx mf la mg le mh li mi lm ma mb mc md bi translated"><code class="fe ng nh ni nj b">graphql</code>:解析GraphQL查询</li><li id="e9f1" class="lv lw iq kt b ku me kx mf la mg le mh li mi lm ma mb mc md bi translated"><code class="fe ng nh ni nj b">subscriptions-transport-ws</code>:使用WebSocketLink通过WebSocket使用订阅</li></ul><pre class="kg kh ki kj gt nk nj nl nm aw nn bi"><span id="1dff" class="no mk iq nj b gy np nq l nr ns">npm install @apollo/client graphql subscriptions-transport-ws</span></pre><p id="3462" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">也可以选择安装<code class="fe ng nh ni nj b">@material-ui/core</code>进行造型。我将在这个项目中使用一些材料的用户界面组件。</p><pre class="kg kh ki kj gt nk nj nl nm aw nn bi"><span id="945c" class="no mk iq nj b gy np nq l nr ns">npm install @material-ui/core</span></pre><h1 id="3e0c" class="mj mk iq bd ml mm mn mo mp mq mr ms mt jw mu jx mv jz mw ka mx kc my kd mz na bi translated">步骤3:初始化WebSocketLink和ApolloClient</h1><p id="0861" class="pw-post-body-paragraph kr ks iq kt b ku nb jr kw kx nc ju kz la nd lc ld le ne lg lh li nf lk ll lm ij bi translated">让我们通过在React应用程序的<code class="fe ng nh ni nj b">src</code>文件夹中创建<code class="fe ng nh ni nj b">Chat.js</code>来创建一个聊天组件。在这个组件中，我们将初始化我们的WebSocketLink和ApolloClient，以执行我们的聊天应用程序所需的所有必要的查询和功能。</p><p id="4fb1" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">首先，让我们从已安装的包中导入我们需要的东西。</p><pre class="kg kh ki kj gt nk nj nl nm aw nn bi"><span id="7c24" class="no mk iq nj b gy np nq l nr ns">import { ApolloClient, InMemoryCache, useMutation, useSubscription, gql} from '@apollo/client';<br/>import { WebSocketLink } from "@apollo/client/link/ws";<br/>import {Container, Chip, Grid, TextField, Button} from '@material-ui/core';</span></pre><p id="54d3" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">然后，初始化一个<code class="fe ng nh ni nj b">WebSocketLink</code>来处理import语句下的订阅。<code class="fe ng nh ni nj b">uri</code>属性应该是GraphQL服务器中订阅的特定端点。在我们的例子中，它只是<code class="fe ng nh ni nj b">/</code>，我们的服务器在端口4000。</p><pre class="kg kh ki kj gt nk nj nl nm aw nn bi"><span id="8439" class="no mk iq nj b gy np nq l nr ns">const link = new WebSocketLink({<br/>    uri: `ws://localhost:4000/`,<br/>    options: {<br/>      reconnect: true,<br/>    },<br/>});</span></pre><p id="878e" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">现在，让我们初始化一个<code class="fe ng nh ni nj b">ApolloClient</code>实例，这样我们的客户端就可以在<code class="fe ng nh ni nj b"><a class="ae ln" href="http://localhost:4000/." rel="noopener ugc nofollow" target="_blank">http://localhost:4000/</a></code> <a class="ae ln" href="http://localhost:4000/." rel="noopener ugc nofollow" target="_blank">从我们的GraphQL服务器获取数据。</a></p><pre class="kg kh ki kj gt nk nj nl nm aw nn bi"><span id="0949" class="no mk iq nj b gy np nq l nr ns">export const client = new ApolloClient({<br/>  link, //websocket link<br/>  uri: 'http://localhost:4000/', //connect to server<br/>  cache: new InMemoryCache(),<br/>});</span></pre><p id="4dac" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在此之下，我们现在可以让聊天组件返回一个简单的标题。</p><pre class="kg kh ki kj gt nk nj nl nm aw nn bi"><span id="5fb0" class="no mk iq nj b gy np nq l nr ns">export const Chat = () =&gt;{<br/>    return(<br/>      &lt;div&gt;<br/>         &lt;h3&gt;Welcome to DevThoughts! A simple chat app for the GraphQL series!&lt;/h3&gt;<br/>      &lt;/div&gt;<br/>    )<br/>}</span></pre><h1 id="b5ec" class="mj mk iq bd ml mm mn mo mp mq mr ms mt jw mu jx mv jz mw ka mx kc my kd mz na bi translated">步骤4:将ApolloClient与React连接起来</h1><p id="d268" class="pw-post-body-paragraph kr ks iq kt b ku nb jr kw kx nc ju kz la nd lc ld le ne lg lh li nf lk ll lm ij bi translated">为了用React连接初始化的ApolloClient实例，我们可以在我们的<code class="fe ng nh ni nj b">App.js</code>文件中导入ApolloProvider。这就像一个上下文提供者，它包装React应用程序并将Apollo客户端放在上下文中，因此可以从应用程序组件树中的任何位置访问它。</p><p id="19d5" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在我们的<code class="fe ng nh ni nj b">App.js</code>文件中，导入一个ApolloProvider并将其包装在组件周围。最后，我们从<code class="fe ng nh ni nj b">Chat.js</code>导入我们的客户端实例和聊天组件。传入ApolloProvider组件中的<code class="fe ng nh ni nj b">client</code>，我们就完成了设置。</p><pre class="kg kh ki kj gt nk nj nl nm aw nn bi"><span id="c521" class="no mk iq nj b gy np nq l nr ns">import './App.css';<br/>import { ApolloProvider } from '@apollo/client';<br/>import {client, Chat} from './Chat'</span><span id="145b" class="no mk iq nj b gy nu nq l nr ns">function App() {<br/>  return ( <br/>    &lt;ApolloProvider client={client}&gt;<br/>      &lt;div className = "App"&gt;<br/>        &lt;h2&gt;Dev Thoughts 💭&lt;/h2&gt;<br/>        &lt;Chat/&gt;<br/>      &lt;/div&gt;<br/>    &lt;/ApolloProvider&gt;<br/>  );<br/>}</span><span id="d279" class="no mk iq nj b gy nu nq l nr ns">export default App;</span></pre><h1 id="52f1" class="mj mk iq bd ml mm mn mo mp mq mr ms mt jw mu jx mv jz mw ka mx kc my kd mz na bi translated">步骤5: GraphQL获取消息查询</h1><p id="7037" class="pw-post-body-paragraph kr ks iq kt b ku nb jr kw kx nc ju kz la nd lc ld le ne lg lh li nf lk ll lm ij bi translated">现在一切都设置好了，我们可以从我们的React应用程序获取数据并将其发送到我们的GraphQL服务器。为此，我们需要在<code class="fe ng nh ni nj b">Chat.js</code>中编写一些GraphQL查询。</p><p id="3ab7" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们可以通过封装在gql模板文本中来定义一个查询。下面是我们获取消息的查询:</p><pre class="kg kh ki kj gt nk nj nl nm aw nn bi"><span id="2808" class="no mk iq nj b gy np nq l nr ns">const GET_MESSAGES = gql`<br/>  subscription {<br/>    messages {<br/>      id<br/>      user<br/>      text<br/>    }<br/>  }<br/>`;</span></pre><blockquote class="lo lp lq"><p id="a41b" class="kr ks lr kt b ku kv jr kw kx ky ju kz ls lb lc ld lt lf lg lh lu lj lk ll lm ij bi translated">如果您需要对订阅和查询进行总结，请阅读本系列的<a class="ae ln" href="https://victoria2666.medium.com/graphql-for-beginners-setting-up-graphql-server-ba48a3cbc184?sk=330d2a07f119d5734ae2424a417eecd1" rel="noopener">上一部分</a>。</p></blockquote><p id="c8e3" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">然后，我们使用<code class="fe ng nh ni nj b">useSubscription</code>钩子像这样执行查询:</p><pre class="kg kh ki kj gt nk nj nl nm aw nn bi"><span id="9b56" class="no mk iq nj b gy np nq l nr ns">const Messages = ({user}) =&gt;{<br/>    const {data} = useSubscription(GET_MESSAGES) //executes query<br/>    if(!data){<br/>        return null; //if no data fetched, return null<br/>    }</span><span id="3182" class="no mk iq nj b gy nu nq l nr ns">   //else return the fetched data<br/>    return (<br/>      &lt;div&gt;<br/>         //map fetched data here<br/>      &lt;/div&gt;<br/>     )<br/>}</span></pre><p id="70d7" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">如上面的代码所示，Messages组件将使用<code class="fe ng nh ni nj b">useSubscription</code>钩子执行<code class="fe ng nh ni nj b">GET_MESSAGES</code>查询。然后，我们检查提取的数据是否为空。如果是，则组件不返回任何内容。否则，它应该返回<code class="fe ng nh ni nj b">&lt;div&gt;</code>中的所有消息。</p><p id="95eb" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">请注意，提取的数据将采用如下格式:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nv"><img src="../Images/e088e042e286c4b78145356c2da2dd4a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ZIMHCOQHNTO9OD7J"/></div></div></figure><p id="43ca" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">因此，让我们添加获取的数据，并将它们映射为单独的样式。下面是消息组件的外观:</p><pre class="kg kh ki kj gt nk nj nl nm aw nn bi"><span id="7a75" class="no mk iq nj b gy np nq l nr ns">const Messages = () =&gt; {<br/>  const { data } = useSubscription(GET_MESSAGES);<br/>  if (!data) {<br/>    return null;<br/>  }<br/>  return (<br/>    &lt;div style={{ marginBottom: '5rem' }}&gt;<br/>      {data.messages.map(({ id, user, text }) =&gt; {<br/>        return (<br/>          &lt;div key={id} style={{ textAlign: 'right' }}&gt;<br/>            &lt;p style={{ marginBottom: '0.3rem' }}&gt;{user}&lt;/p&gt;<br/>            &lt;Chip style={{ fontSize: '0.9rem' }} color='primary' label={text} /&gt;<br/>          &lt;/div&gt;<br/>        );<br/>      })}<br/>    &lt;/div&gt;<br/>  );<br/>};</span></pre><p id="61c3" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">现在，我们将消息组件添加到之前在步骤3中创建的聊天组件中，如下所示:</p><pre class="kg kh ki kj gt nk nj nl nm aw nn bi"><span id="a138" class="no mk iq nj b gy np nq l nr ns">export const Chat = () =&gt;{<br/>    return(<br/>      &lt;div&gt;<br/>         &lt;h3&gt;Welcome to DevThoughts! A simple chat app for the GraphQL series!&lt;/h3&gt;<br/>         &lt;Messages/&gt; /*add here*/<br/>      &lt;/div&gt;<br/>    )<br/>}</span></pre><h1 id="a84d" class="mj mk iq bd ml mm mn mo mp mq mr ms mt jw mu jx mv jz mw ka mx kc my kd mz na bi translated">测试！</h1><p id="5360" class="pw-post-body-paragraph kr ks iq kt b ku nb jr kw kx nc ju kz la nd lc ld le ne lg lh li nf lk ll lm ij bi translated">让我们测试它是否工作，在<code class="fe ng nh ni nj b">http://localhost:4000/</code>运行服务器并通过操场发布几条消息进行测试。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nw"><img src="../Images/91cbf137071c13bd503416989df2d6e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*vRY_HJf9fBF9cWEB"/></div></div></figure><p id="37d5" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">然后，通过在<code class="fe ng nh ni nj b">client</code>文件夹上运行<code class="fe ng nh ni nj b">npm start</code>来运行React应用程序。消息组件应该执行订阅查询并显示测试消息。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nx"><img src="../Images/59e261f56b5c25af7b59319fdde4f411.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*JXblOFwv3DH0VORC"/></div></div></figure><p id="5e8b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">很好，现在让我们继续创建一个变异查询，以允许从我们的React应用程序而不是我们的操场发布新消息。</p><h1 id="9ae5" class="mj mk iq bd ml mm mn mo mp mq mr ms mt jw mu jx mv jz mw ka mx kc my kd mz na bi translated">步骤6: GraphQL Post消息查询</h1><p id="5a0c" class="pw-post-body-paragraph kr ks iq kt b ku nb jr kw kx nc ju kz la nd lc ld le ne lg lh li nf lk ll lm ij bi translated">让我们将这个查询添加到我们的<code class="fe ng nh ni nj b">GET_MESSAGES</code>查询下面。就像我们在操场上写的一样，<code class="fe ng nh ni nj b">POST_MESSAGE</code>的变异查询如下:</p><pre class="kg kh ki kj gt nk nj nl nm aw nn bi"><span id="7fd5" class="no mk iq nj b gy np nq l nr ns">const POST_MESSAGE = gql`<br/>  mutation($user:String!, $text:String!){<br/>    postMessage(user:$user, text:$text)<br/>  }<br/>`;</span></pre><p id="e5ac" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">然后，我们需要一个名为<code class="fe ng nh ni nj b">sendMessage</code>的函数来执行这个查询。为了创建这个函数，让我们首先创建一些用户可以输入消息的UI元素，然后单击一个调用<code class="fe ng nh ni nj b">sendMessage</code>的按钮。</p><p id="04ff" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在我们的<code class="fe ng nh ni nj b">Chat</code>组件中，在我们的<code class="fe ng nh ni nj b">Messages</code>下面，让我们添加UI。</p><pre class="kg kh ki kj gt nk nj nl nm aw nn bi"><span id="6e6c" class="no mk iq nj b gy np nq l nr ns">export const Chat = () =&gt;{<br/>    return(<br/>        &lt;Container&gt;<br/>          &lt;h3&gt;Welcome to DevThoughts! A simple chat app for the GraphQL series!&lt;/h3&gt;<br/>          &lt;Messages/&gt;<br/>         {/*add this block below*/}<br/>          &lt;Grid container spacing={2}&gt;<br/>            &lt;Grid item xs={3}&gt;<br/>              &lt;TextField onChange={(e)=&gt;{<br/>                setUser(e.target.value)}} value={user} size="small" fullWidth variant="outlined" required label="Required" label="Enter name" /&gt;<br/>            &lt;/Grid&gt;<br/>            &lt;Grid item xs={8}&gt;<br/>              &lt;TextField onChange={(e)=&gt;{<br/>                setText(e.target.value)}} value={text} size="small" fullWidth variant="outlined" required label="Required" label="Enter message here" /&gt;<br/>            &lt;/Grid&gt;<br/>            &lt;Grid item xs={1}&gt;<br/>              &lt;Button onClick={sendMessage} fullWidth  variant="contained" style={{backgroundColor:"#60a820", color:"white"}}&gt;Send&lt;/Button&gt;<br/>            &lt;/Grid&gt;<br/>          &lt;/Grid&gt;<br/>        &lt;/Container&gt;<br/>    )<br/>}</span></pre><p id="77f1" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这是它在浏览器上的样子:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ny"><img src="../Images/2a483f726cd053e5e2735b5ceeaa8b18.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*rNPC480rsvzFdtYA"/></div></div></figure><p id="1930" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">您可能会注意到，除了<code class="fe ng nh ni nj b">sendMessage</code>之外，我还添加了一些新的变量:<code class="fe ng nh ni nj b">user</code>和<code class="fe ng nh ni nj b">text</code>，它们包含了我们刚刚包含的输入字段的值。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nz"><img src="../Images/d2c3d63491cc7b6f5adbd3f6f26a5bd7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*L7Wh9-UguVC1TsAI"/></div></div></figure><p id="738b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">让我们在<code class="fe ng nh ni nj b">Chat.js</code>的顶部导入<code class="fe ng nh ni nj b">useState</code>钩子，并初始化<code class="fe ng nh ni nj b">Chat</code>组件中的变量。</p><p id="d4cb" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在文件的顶部:</p><pre class="kg kh ki kj gt nk nj nl nm aw nn bi"><span id="1b0a" class="no mk iq nj b gy np nq l nr ns">import React, {useState} from 'react';</span></pre><p id="74ae" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在我们的<code class="fe ng nh ni nj b">Chat</code>组件中:</p><pre class="kg kh ki kj gt nk nj nl nm aw nn bi"><span id="6bf7" class="no mk iq nj b gy np nq l nr ns">export const Chat = () =&gt;{<br/>    const [user, setUser] = useState("Victoria"); //initialize user<br/>    const [text, setText] = useState(""); //initialize text</span><span id="cd23" class="no mk iq nj b gy nu nq l nr ns">    return <br/>       //...<br/>}</span></pre><p id="e9f0" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">最后，我们在变量下面创建sendMessage函数。正如阿波罗<a class="ae ln" href="https://www.apollographql.com/docs/react/data/mutations/" rel="noopener ugc nofollow" target="_blank">文档</a>中所描述的，我们必须使用<code class="fe ng nh ni nj b">useMutation</code>钩子来执行变异。</p><p id="9f21" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">下面是代码的作用。花点时间回顾并理解它:</p><ol class=""><li id="745e" class="lv lw iq kt b ku kv kx ky la lx le ly li lz lm oa mb mc md bi translated">在返回数组的<code class="fe ng nh ni nj b">useMutation</code>钩子中传递我们的<code class="fe ng nh ni nj b">POST_MESSAGE</code>查询，其中第一个元素是我们的mutate函数<code class="fe ng nh ni nj b">postMessage</code>。</li><li id="e807" class="lv lw iq kt b ku me kx mf la mg le mh li mi lm oa mb mc md bi translated">sendMessage首先检查两个输入是否都不为空。它通过从输入(<code class="fe ng nh ni nj b">user</code>和<code class="fe ng nh ni nj b">text</code>)传递变量来执行<code class="fe ng nh ni nj b">postMessage</code> mutate函数，并重置文本字段。</li><li id="db72" class="lv lw iq kt b ku me kx mf la mg le mh li mi lm oa mb mc md bi translated">如果其中一个输入字段为空，将会触发一个警告窗口。</li></ol><pre class="kg kh ki kj gt nk nj nl nm aw nn bi"><span id="00a9" class="no mk iq nj b gy np nq l nr ns">export const Chat = () =&gt;{<br/>    //...<br/>    // 1.<br/>    const [postMessage] = useMutation(POST_MESSAGE)</span><span id="b612" class="no mk iq nj b gy nu nq l nr ns">    const sendMessage=()=&gt;{<br/>      // 2.<br/>      if(text.length&gt;0 &amp;&amp; user.length &gt;0){<br/>        //calls the mutate function<br/>        postMessage({<br/>          variables:{ user: user, text: text }<br/>        })<br/>        setText(""); //reset text field<br/>      }else{<br/>        // 3.<br/>        alert("Missing fields!")<br/>      }<br/>    }</span><span id="76e8" class="no mk iq nj b gy nu nq l nr ns">   return (<br/>   // ...<br/>}</span></pre><h1 id="b9f9" class="mj mk iq bd ml mm mn mo mp mq mr ms mt jw mu jx mv jz mw ka mx kc my kd mz na bi translated">试验</h1><p id="3520" class="pw-post-body-paragraph kr ks iq kt b ku nb jr kw kx nc ju kz la nd lc ld le ne lg lh li nf lk ll lm ij bi translated">如果我们发布一条新消息，它应该会完美地执行变异，监听任何变化的订阅会立即用新数据更新UI。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ob"><img src="../Images/e2c0fbe61f6c321cb504bb43ef9ef3f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4fIJny_KrubU7_NPd9pOtw.png"/></div></div></figure><p id="c5f5" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们甚至可以打开多个窗口，这样它就像一个真正的聊天应用程序！</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oc"><img src="../Images/81ab76479df9cf6efc0297fae527f564.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ShXkRt01KKTCxk3kuu94tQ.png"/></div></div></figure><h1 id="fd8f" class="mj mk iq bd ml mm mn mo mp mq mr ms mt jw mu jx mv jz mw ka mx kc my kd mz na bi translated">第七步:最终改进</h1><p id="6e1f" class="pw-post-body-paragraph kr ks iq kt b ku nb jr kw kx nc ju kz la nd lc ld le ne lg lh li nf lk ll lm ij bi translated">上面的片段显示了我们的应用程序可以成功发布和获取新消息。但是，请注意，无论用户是谁，消息总是向右对齐。</p><p id="3f64" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在典型的聊天应用程序中，只有用户发送的消息会在右边，而其余的会在左边。让我们添加这个小改进来完成我们的聊天应用程序。</p><p id="75d2" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在我们的<code class="fe ng nh ni nj b">Chat.js</code>文件的<code class="fe ng nh ni nj b">Messages</code>组件中，让它接受我们的<code class="fe ng nh ni nj b">user</code>变量作为道具。然后，我们将根据消息数据的<code class="fe ng nh ni nj b">user</code>属性是否等于<code class="fe ng nh ni nj b">user</code>变量给出不同的样式。</p><pre class="kg kh ki kj gt nk nj nl nm aw nn bi"><span id="dd3f" class="no mk iq nj b gy np nq l nr ns">const Messages = ({user}) =&gt;{<br/>    const {data} = useSubscription(GET_MESSAGES)<br/>    if(!data){<br/>        return null;<br/>    }<br/>    return (<br/>      &lt;div style={{marginBottom:"5rem"}}&gt;<br/>        {data.messages.map(({id, user: messageUser, text})=&gt;{<br/>          return(<br/>            &lt;div key={id} style={{textAlign: user===messageUser?"right":"left"}}&gt;<br/>              &lt;p style={{marginBottom:"0.3rem"}}&gt;{messageUser}&lt;/p&gt;<br/>              &lt;Chip style={{fontSize:"0.9rem"}} color={user===messageUser?"primary": "secondary"} label={text}/&gt;<br/>            &lt;/div&gt;<br/>          )<br/>        })}<br/>      &lt;/div&gt;<br/>     )<br/>}</span></pre><p id="9099" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">最后，记住在<code class="fe ng nh ni nj b">Chat</code>组件下的<code class="fe ng nh ni nj b">Messages</code>中传递<code class="fe ng nh ni nj b">user</code>变量:</p><pre class="kg kh ki kj gt nk nj nl nm aw nn bi"><span id="6634" class="no mk iq nj b gy np nq l nr ns">export const Chat = () =&gt;{<br/>  //...<br/>  return(<br/>    //...<br/>      &lt;Messages user={user}/&gt;<br/>    //...<br/>  )<br/>}</span></pre><h1 id="afd3" class="mj mk iq bd ml mm mn mo mp mq mr ms mt jw mu jx mv jz mw ka mx kc my kd mz na bi translated">最终结果和单词</h1><p id="9960" class="pw-post-body-paragraph kr ks iq kt b ku nb jr kw kx nc ju kz la nd lc ld le ne lg lh li nf lk ll lm ij bi translated">如下图所示，我们的聊天应用终于完成了！</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi od"><img src="../Images/4861524441b157c79c4b027b60b44f69.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UMt6nCiXZzLPDF8-nWMI4Q.png"/></div></div></figure><p id="d0eb" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们现在已经到了GraphQL初学者系列的末尾。如果你一直在关注这个系列，非常感谢。我希望它有助于您了解GraphQL的基本概念，并将其集成到React这样的前端框架中。</p><p id="c4fb" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">如果你认为这个系列对你有帮助，请喜欢并分享它，这样它就能接触到更多的人。</p><p id="d87b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">请查看下面的参考资料部分，查看该项目的代码，并阅读更多关于Apollo的GraphQL的内容。为了提高和更好地使用GraphQL，我鼓励您尝试构建自己的项目，甚至在开始时向这个聊天应用程序添加更多功能。祝你学习顺利，干杯！</p></div><div class="ab cl oe of hu og" role="separator"><span class="oh bw bk oi oj ok"/><span class="oh bw bk oi oj ok"/><span class="oh bw bk oi oj"/></div><div class="ij ik il im in"><h1 id="bc26" class="mj mk iq bd ml mm ol mo mp mq om ms mt jw on jx mv jz oo ka mx kc op kd mz na bi translated">阅读更多</h1><ul class=""><li id="46c1" class="lv lw iq kt b ku nb kx nc la oq le or li os lm ma mb mc md bi translated"><a class="ae ln" href="https://victoria2666.medium.com/graphql-for-beginners-introduction-90c78a56a96e?sk=ee4885321344329d8af3096f9074427b" rel="noopener">第1部分:GraphQL简介</a></li><li id="2db5" class="lv lw iq kt b ku me kx mf la mg le mh li mi lm ma mb mc md bi translated"><a class="ae ln" href="https://victoria2666.medium.com/graphql-for-beginners-subscriptions-schemas-and-servers-c4b440e3b2aa?sk=0141fe163f173af76e407e8688c3fa8f" rel="noopener">第2部分:模式、订阅和服务器</a></li><li id="b570" class="lv lw iq kt b ku me kx mf la mg le mh li mi lm ma mb mc md bi translated"><a class="ae ln" href="https://victoria2666.medium.com/graphql-for-beginners-setting-up-graphql-server-ba48a3cbc184?sk=330d2a07f119d5734ae2424a417eecd1" rel="noopener">第3部分:设置GraphQL服务器</a></li></ul><h1 id="f2f8" class="mj mk iq bd ml mm mn mo mp mq mr ms mt jw mu jx mv jz mw ka mx kc my kd mz na bi translated">参考</h1><ul class=""><li id="ae90" class="lv lw iq kt b ku nb kx nc la oq le or li os lm ma mb mc md bi translated"><a class="ae ln" href="https://github.com/victoria-lo/devthoughts" rel="noopener ugc nofollow" target="_blank"> GitHub回购</a></li><li id="84e5" class="lv lw iq kt b ku me kx mf la mg le mh li mi lm ma mb mc md bi translated"><a class="ae ln" href="https://www.apollographql.com/docs/react/get-started/" rel="noopener ugc nofollow" target="_blank">apollographql.com/docs/react/get-started</a></li><li id="31a4" class="lv lw iq kt b ku me kx mf la mg le mh li mi lm ma mb mc md bi translated"><a class="ae ln" href="https://www.apollographql.com/docs/react/data/subscriptions/" rel="noopener ugc nofollow" target="_blank">apollographql.com/docs/react/data/subscript..</a></li><li id="846a" class="lv lw iq kt b ku me kx mf la mg le mh li mi lm ma mb mc md bi translated"><a class="ae ln" href="https://www.apollographql.com/docs/react/data/mutations/" rel="noopener ugc nofollow" target="_blank">apollographql.com/docs/react/data/mutations</a></li><li id="0a9c" class="lv lw iq kt b ku me kx mf la mg le mh li mi lm ma mb mc md bi translated"><a class="ae ln" href="https://www.youtube.com/watch?v=E3NHd-PkLrQ&amp;t=1697" rel="noopener ugc nofollow" target="_blank">youtube.com/watch?v=E3NHd-PkLrQ&amp;t = 1697</a></li></ul></div></div>    
</body>
</html>