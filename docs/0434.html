<html>
<head>
<title>Node.js — Testing a Downloaded File with Jest + Supertest</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Node.js —用Jest + Supertest测试下载的文件</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/node-js-test-downloading-a-file-with-jest-supertest-cf47f431e417?source=collection_archive---------3-----------------------#2021-01-26">https://javascript.plainenglish.io/node-js-test-downloading-a-file-with-jest-supertest-cf47f431e417?source=collection_archive---------3-----------------------#2021-01-26</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/f2c1f1c0e397fa021c1a0bea3767a2f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8H_TTpih573tuxu74smAuQ.jpeg"/></div></div></figure><p id="8abd" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">几天前，我在做一个任务，在这个任务中，我必须编写一个端点来从服务器下载文件。</p><p id="1258" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">像往常一样，对于我们在团队中编写的每一个代码(至少对于后端)，我们都编写了正确的测试用例。到目前为止，我已经编写了测试用例，检查返回的HTTP代码、正确的内容类型、内容处置和内容长度头，仅此而已。这一次，我想检查我下载的文件是否正确(检查我接收的内容)。</p><p id="c49c" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">首先，我认为只是检查响应中的“主体”并验证数据，但这还不够。</p><p id="ae77" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><em class="kt">验证下载的内容取决于文件类型，在我最初的案例中，我下载的是一个zip文件，因此为了验证内容，我解压缩了内容并检查包含的文件是否正确。在我将要展示的例子中，我正在下载一个CSV文件，并检查文件内容是否正确。</em></p><p id="1fd5" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">读了一点之后，我意识到我是从服务器上流式传输文件内容，通常是由显示下载/保存对话框的浏览器来执行操作。</p><p id="3ba2" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在测试用例中，我使用的是<a class="ae ku" href="https://www.npmjs.com/package/supertest" rel="noopener ugc nofollow" target="_blank">超级测试</a>，默认情况下运行良好。您可以访问所有的响应头，甚至可以访问“content-length ”,它告诉您已经收到了带有数据的响应。但是，如果您想要访问下载的内容，您需要修改典型使用的代码，并添加作为缓冲区处理响应，读取内容并将其写入响应体。</p><p id="9002" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我们从类似于</p><figure class="kw kx ky kz gt jo gh gi paragraph-image"><div class="gh gi kv"><img src="../Images/45e75e93e7b64f141efac418172abaa7.png" data-original-src="https://miro.medium.com/v2/resize:fit:948/format:webp/1*5p-3RgPiNz8pm-bQMYp7-w.png"/></div></figure><p id="2f48" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">到</p><figure class="kw kx ky kz gt jo gh gi paragraph-image"><div class="gh gi la"><img src="../Images/de95035498e93516b30dad592e2e9082.png" data-original-src="https://miro.medium.com/v2/resize:fit:1054/format:webp/1*UxtqZC5u4cbtEoveMtTCUQ.png"/></div></figure><p id="f7bf" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">如你所见，魔力就在”。buffer()”将响应作为来自服务器的缓冲区进行处理，然后使用“parse”将接收到的数据写入“res.data”(这里可以使用外部时态变量)，最后返回“end”事件处理程序中的所有内容(将在“response.body”中结束)。</p><p id="1316" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">之后，我可以访问“response.body”中的文件内容并验证它。</p><figure class="kw kx ky kz gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi lb"><img src="../Images/aa9295deaf1103c0e4f23cdf7dca2402.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zpoZe1VA3suMECTs3YQw3g.png"/></div></div></figure><p id="0998" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">你可以在https://github.com/amcereijo/tdd-example的<a class="ae ku" href="https://github.com/amcereijo/tdd-example" rel="noopener ugc nofollow" target="_blank">上看到所有代码。具体文件有:</a></p><ul class=""><li id="7385" class="lc ld in jx b jy jz kc kd kg le kk lf ko lg ks lh li lj lk bi translated">端点代码<a class="ae ku" href="https://github.com/amcereijo/tdd-example/blob/master/api/controllers/country.controller.js#L66" rel="noopener ugc nofollow" target="_blank">https://github . com/amcereijo/TDD-example/blob/master/API/controllers/country . controller . js # L66</a></li><li id="9c00" class="lc ld in jx b jy ll kc lm kg ln kk lo ko lp ks lh li lj lk bi translated">测试代码<a class="ae ku" href="https://github.com/amcereijo/tdd-example/blob/master/api/controllers/country.controller.test.js#L127" rel="noopener ugc nofollow" target="_blank">https://github . com/amcereijo/TDD-example/blob/master/API/controllers/country . controller . test . js # L127</a></li></ul><p id="68c6" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我希望这能帮助你改进你的测试用例，如果你知道任何其他方法来进行这些验证，请在评论中告诉我。</p><p id="303f" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><em class="kt">更多内容看</em><a class="ae ku" href="http://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><strong class="jx io"><em class="kt">plain English . io</em></strong></a></p></div></div>    
</body>
</html>