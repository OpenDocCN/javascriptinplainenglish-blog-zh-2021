<html>
<head>
<title>Add Token Authentication to Our Fastify App with fastify-jwt</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用fastify-jwt为我们的Fastify应用程序添加令牌认证</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/add-token-authentication-to-our-fastify-app-with-fastify-jwt-778a8402a9b8?source=collection_archive---------4-----------------------#2021-01-09">https://javascript.plainenglish.io/add-token-authentication-to-our-fastify-app-with-fastify-jwt-778a8402a9b8?source=collection_archive---------4-----------------------#2021-01-09</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/951b562698608ab2a916be52587ae361.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*VTkSdiTyHdTS_l4S"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@harleydavidson?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Harley-Davidson</a> on <a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="2b54" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">有了fastify-jwt库，我们可以快速地将基本认证添加到我们的fastify应用程序中。</p><p id="f3cf" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，我们将了解如何使用这个库向我们的Fastify应用程序添加身份验证。</p><h1 id="079f" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">装置</h1><p id="851d" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以通过运行以下命令来安装该软件包:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="b4f0" class="mn lc iq mj b gy mo mp l mq mr">npm i fastify-jwt</span></pre><h1 id="821b" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">发行代币</h1><p id="a0df" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以用这个方法发行代币。</p><p id="02c3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="818a" class="mn lc iq mj b gy mo mp l mq mr">const fastify = require('fastify')({<br/>  logger: true<br/>})<br/>fastify.register(require('fastify-jwt'), {<br/>  secret: 'secret'<br/>})</span><span id="aa54" class="mn lc iq mj b gy mv mp l mq mr">fastify.post('/signup', (req, reply) =&gt; {<br/>  const token = fastify.jwt.sign({ foo: 'bar' })<br/>  reply.send({ token })<br/>})</span><span id="69e6" class="mn lc iq mj b gy mv mp l mq mr">fastify.listen(3000, '0.0.0.0', function (err, address) {<br/>  if (err) {<br/>    fastify.log.error(err)<br/>    process.exit(1)<br/>  }<br/>  fastify.log.info(`server listening on ${address}`)<br/>})</span></pre><p id="3bd9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们只是调用方法，用我们想要的对象作为有效载荷来返回一个令牌。</p><h1 id="ee70" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">验证令牌</h1><p id="3282" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以用<code class="fe ms mt mu mj b">jwtVerify</code>方法验证令牌。</p><p id="4b29" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="0890" class="mn lc iq mj b gy mo mp l mq mr">const fastify = require('fastify')({<br/>  logger: true<br/>})<br/>fastify.register(require('fastify-jwt'), {<br/>  secret: 'secret'<br/>})</span><span id="29b1" class="mn lc iq mj b gy mv mp l mq mr">fastify.decorate("authenticate", async (request, reply) =&gt; {<br/>    try {<br/>      await request.jwtVerify()<br/>    } catch (err) {<br/>      reply.send(err)<br/>    }<br/>  })<br/>  .after(() =&gt; {<br/>    fastify.route({<br/>      method: 'GET',<br/>      url: '/secret',<br/>      preHandler: [fastify.authenticate],<br/>      handler: (req, reply) =&gt; {<br/>        reply.send('secret')<br/>      }<br/>    })<br/>  })</span><span id="3320" class="mn lc iq mj b gy mv mp l mq mr">fastify.post('/signup', (req, reply) =&gt; {<br/>  const token = fastify.jwt.sign({<br/>    foo: 'bar'<br/>  })<br/>  reply.send({<br/>    token<br/>  })<br/>})</span><span id="97ce" class="mn lc iq mj b gy mv mp l mq mr">fastify.listen(3000, '0.0.0.0', function(err, address) {<br/>  if (err) {<br/>    fastify.log.error(err)<br/>    process.exit(1)<br/>  }<br/>  fastify.log.info(`server listening on ${address}`)<br/>})</span></pre><p id="8826" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们调用<code class="fe ms mt mu mj b">request.jwtVerify</code>方法，在我们调用<code class="fe ms mt mu mj b">fastify.register</code>方法之后就可以使用了。</p><p id="85ab" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果有错误，将运行<code class="fe ms mt mu mj b">catch</code>程序块。</p><p id="2699" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了添加一些需要auth令牌的路由，我们添加了带有由<code class="fe ms mt mu mj b">fastify.route</code>定义的路由的<code class="fe ms mt mu mj b">after</code>回调。</p><p id="e82f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ms mt mu mj b">preHandler</code>在调用路由之前运行，以便我们可以运行授权令牌检查，并且只有在令牌有效时才调用路由处理程序。</p><h1 id="cbc7" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">饼干</h1><p id="139c" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以将身份验证令牌放在cookies中。</p><p id="e5ce" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="me mf mg mh gt mi mj mk ml aw mm bi"><span id="a3fe" class="mn lc iq mj b gy mo mp l mq mr">const fastify = require('fastify')()<br/>const jwt = require('fastify-jwt')</span><span id="bc3d" class="mn lc iq mj b gy mv mp l mq mr">fastify.register(jwt, {<br/>  secret: 'key',<br/>  cookie: { <br/>    cookieName: 'token'<br/>  }<br/>})</span><span id="c288" class="mn lc iq mj b gy mv mp l mq mr">fastify<br/>  .register(require('fastify-cookie'))</span><span id="1e9f" class="mn lc iq mj b gy mv mp l mq mr">fastify.get('/cookies', async (request, reply) =&gt; {<br/>  const token = await reply.jwtSign({<br/>    name: 'foo',<br/>    role: ['admin', 'spy']<br/>  })</span><span id="4e75" class="mn lc iq mj b gy mv mp l mq mr">reply<br/>    .setCookie('token', token, {<br/>      domain: '*',<br/>      path: '/',<br/>      secure: true,<br/>      httpOnly: true,<br/>      sameSite: true<br/>    })<br/>    .code(200)<br/>    .send('Cookie sent')<br/>})</span><span id="ef12" class="mn lc iq mj b gy mv mp l mq mr">fastify.get('/verifycookie', async (request, reply) =&gt; {<br/>  try {<br/>    await request.jwtVerify()<br/>    reply.send({ code: 'OK', message: 'it works!' })<br/>  }<br/>  catch(error){<br/>    reply.send(error);<br/>  }<br/>})</span><span id="a4e6" class="mn lc iq mj b gy mv mp l mq mr">fastify.listen(3000, '0.0.0.0', function (err, address) {<br/>  if (err) {<br/>    fastify.log.error(err)<br/>    process.exit(1)<br/>  }<br/>  fastify.log.info(`server listening on ${address}`)<br/>})</span></pre><p id="e8a3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们添加了<code class="fe ms mt mu mj b">/cookies</code>路径来发布cookie。</p><p id="0e55" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">注册了<code class="fe ms mt mu mj b">fastify-cookie</code>插件后<code class="fe ms mt mu mj b">setCookie</code>就可用了。</p><p id="2e53" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们将<code class="fe ms mt mu mj b">token</code>传递给<code class="fe ms mt mu mj b">setCookie</code>方法，以传递响应头中的cookie。</p><p id="bace" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ms mt mu mj b">secure</code>确保它发送到HTTPS。</p><p id="f783" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ms mt mu mj b">httpOnly</code>确保它仅用于HTTP请求。</p><p id="f929" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe ms mt mu mj b">sameSite</code>检查cookie是否是从使用它的同一站点发布的。</p><p id="66ef" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在<code class="fe ms mt mu mj b">verifycookie</code>路径中，我们调用<code class="fe ms mt mu mj b">request.jwtVerify</code>来验证cookie，然后再做其他事情。</p><h1 id="bd25" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">结论</h1><p id="9f64" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以使用fastify-jwt来发布JSON web令牌并验证它。</p><p id="4e35" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">喜欢这篇文章吗？如果有，通过<a class="ae kc" href="https://www.youtube.com/channel/UCtipWUghju290NWcn8jhyAw?sub_confirmation=true" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir">订阅我们的YouTube频道</strong> </a> <strong class="kf ir">获取更多类似内容！</strong></p></div></div>    
</body>
</html>