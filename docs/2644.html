<html>
<head>
<title>TIL: Synchronous Async Reduce Functions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">TIL:同步异步缩减功能</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/til-synchronous-async-reduce-functions-ff3fb339a154?source=collection_archive---------13-----------------------#2021-05-31">https://javascript.plainenglish.io/til-synchronous-async-reduce-functions-ff3fb339a154?source=collection_archive---------13-----------------------#2021-05-31</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="a136" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用async/await语法，而不一次解决所有问题。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/0ac70a0534e8c9369e5f65c041248f83.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*xkT5EhKlOizwpo-M"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Photo by <a class="ae kv" href="https://unsplash.com/@claytonrobbins?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Clayton Robbins</a> on <a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="0c9c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">上周我碰壁了。我试图为我的帖子制作一个图表，展示代码库随时间的增长，这个帖子是关于我如何在TripActions 重建电子邮件架构的。我想遍历所有提交，计算特定目录中的文件数量，并绘制输出。最大的挑战不是获得提交或构建图表。它在没有压倒git的情况下循环提交。</p><h1 id="4c11" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">为什么使用Async/Await？</h1><p id="2f5f" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">首先，我是Async/Await代码风格的超级粉丝，我尽可能地使用它。如果你以前没有使用过，这是一个很好的方法来简化你的代码，使它更容易阅读和调试。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="b64d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">上面这个过于简单的例子展示了两种编码风格之间的区别。使用承诺时，很容易迷失在层叠的<code class="fe mr ms mt mu b">then</code>循环中，尤其是如果您想要嵌套标签——一个获取用户的示例，该用户数据用于进行另一次获取以获取他们以前的购买。</p><p id="5fd4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Async/Await帮助我们编写简单的、非嵌套的代码，易于阅读和理解。</p><h1 id="6249" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">更进一步</h1><p id="9689" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">我也是<a class="ae kv" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/Reduce" rel="noopener ugc nofollow" target="_blank">阵的忠实粉丝。减少</a>(这里简称减少)，虽然情况并不总是如此。我认为Reduce被广泛认为过于复杂，不容易阅读，并且被那些想要证明他们知道事情的开发者所使用。反过来，我觉得只是误解。</p><p id="cef0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当与常见的<a class="ae kv" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/map" rel="noopener ugc nofollow" target="_blank">映射</a>和<a class="ae kv" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/filter" rel="noopener ugc nofollow" target="_blank">过滤</a>方法一起使用时，它会是一个非常有用的工具</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="4e40" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">有时Map和Reduce可以用来实现相同的目的(例如:将数组中的值加倍)。通常，如果您可以选择使用Map或Reduce，则默认为Map。它降低了复杂性，增加了可读性。</p><p id="96ec" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Reduce有一些很好的例子，如上所示——按字母顺序对对象进行排序(在使用hmacsha1 auth时很有用),其中您获取现有对象，获取键，然后基于键按字母顺序重新构建它。Reduce最大的优点是它知道你正在构建的东西的状态，因为它正在被构建。使用初始值参数意味着您保持了严格的范围，不需要Reduce函数之外的变量来托管结果值。</p><h1 id="27d7" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">将一切融合在一起</h1><p id="0632" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">您可以在Reduce循环中执行异步Await。但你为什么要这么做？也许像我一样，你有一个值数组，你想遍历它们，做一些处理，然后返回一些别的东西。</p><p id="3c81" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在我的例子中，我有一个提交数组。我想遍历它们，计算每个时间点的文件数，并返回一个包含散列、提交日期和文件数的对象数组。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="5882" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">节点；。js和<a class="ae kv" href="https://www.npmjs.com/package/simple-git" rel="noopener ugc nofollow" target="_blank"> Simple-Git </a> npm包在这里完成了大部分繁重的工作，导航到选择的目录，获取历史记录，然后检查每个提交，最后在将结果返回到文件之前计算文件的数量。它利用承诺让你知道事情何时完成，你可以进入下一步。</p><p id="4050" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这个挑战性的方面在于，默认情况下，<a class="ae kv" href="https://www.npmjs.com/package/simple-git" rel="noopener ugc nofollow" target="_blank"> Simple-Git </a>允许6个并发进程。当达到这个限制时，git开始抛出错误——“另一个git进程似乎正在这个存储库中运行”。作为背景，我的电子邮件目录的git历史记录是1，018次提交，所以再多的并行化也无法解决这个问题。</p><p id="9138" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我选择了同步流程，一个接一个地检查提交，这意味着我不会过度使用git或使我的笔记本电脑崩溃，尽管这会花费更长的时间。但这又导致了另一个问题，reduce中的并发性和时间性。</p><p id="d8f2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当reduce有一个同步函数参数时，它按预期运行，一个接一个，直到数组结束。但是当它有一个异步函数参数时，它们同时运行，它返回一个承诺数组。通常这可能不是一个问题(您可以使用<code class="fe mr ms mt mu b">Promise.All</code>来解决它们),但是由于Git的速率限制，我需要找到另一种方法。</p><p id="a301" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">谢天谢地，我偶然发现了Tamás Sallai的文章，其中介绍了Reduce中的计时。<code class="fe mr ms mt mu b">await acc</code> ( <a class="ae kv" href="https://gist.github.com/Davetherave2010/21db263dac121496ac1dc996619bf1ac#file-git-grapher-js-L20" rel="noopener ugc nofollow" target="_blank"> line 20 </a>)强制reduce函数等待累加器建立，反过来同步运行函数，这正是我所需要的。</p><p id="64cd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们开始吧。一个简单的git reduce循环(原谅双关语),计算每次提交的文件数。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mv"><img src="../Images/8b50cf90bd5e7fc9941feabf4aaba3d4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*NihdNkUgc1zBc7ey"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">A graph that shows the number of email templates vs time at TripActions. For more context, please read the article I wrote on this, ‘<a class="ae kv" href="https://medium.davidendersby.me/giving-emails-at-tripactions-some-tlc-23e3131a5286" rel="noopener ugc nofollow" target="_blank">Giving Emails some TLC</a>’</figcaption></figure><p id="a03f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我使用从这个过程中获得的数据构建了上面显示的图表，该图表显示了电子邮件模板的数量是如何随着时间的推移而增长的。</p><p id="1353" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">感谢阅读。我希望这篇文章对你有用</p><p id="6535" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">大卫</p><p id="2651" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">高级前端开发者@ <a class="ae kv" href="https://tripactions.com/" rel="noopener ugc nofollow" target="_blank"> TripActions </a>(通常是<a class="ae kv" href="https://grnh.se/cbeb241d1" rel="noopener ugc nofollow" target="_blank">招聘</a>！)</p><p id="720c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="mw">更多内容尽在</em><a class="ae kv" href="http://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><em class="mw">plain English . io</em></a></p></div></div>    
</body>
</html>