<html>
<head>
<title>I Can’t Access My Camera and Microphone With JavaScript in WebRTC.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我无法在WebRTC中使用JavaScript访问我的摄像头和麦克风。</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/cant-access-camera-or-microphone-in-webrtc-apps-solve-using-navigator-mediadevices-web-api-c0ffe5cbd32c?source=collection_archive---------2-----------------------#2021-03-01">https://javascript.plainenglish.io/cant-access-camera-or-microphone-in-webrtc-apps-solve-using-navigator-mediadevices-web-api-c0ffe5cbd32c?source=collection_archive---------2-----------------------#2021-03-01</a></blockquote><div><div class="fc if ig ih ii ij"/><div class="ik il im in io"><div class=""/><div class=""><h2 id="61e9" class="pw-subtitle-paragraph jo iq ir bd b jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf dk translated">如何用navigator.mediaDevices Web API解决这个问题</h2></div><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gi gj kg"><img src="../Images/bc9ceec756e24c8d573e3a0c00a84dc5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*2A5Qbg802RyfMWx1"/></div></div><figcaption class="ks kt gk gi gj ku kv bd b be z dk">Photo by <a class="ae kw" href="https://unsplash.com/@surface?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Surface</a> on <a class="ae kw" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="33be" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">有时在WebRTC应用程序中会出现浏览器无法访问摄像头或麦克风的情况。可能它正在被另一个软件使用，或者它根本没有摄像头。</p><p id="c0b7" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">在这篇文章中，我想向你展示如何使用<a class="ae kw" href="https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices" rel="noopener ugc nofollow" target="_blank"> Web API MediaDevices </a>来检查这一点。这超级简单，让我们开始吧。在文章的最后，如果你是一个懒惰的开发者，你可以使用我的代码(<em class="lt">你应该是</em>😅).</p></div><div class="ab cl lu lv hv lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="ik il im in io"><h1 id="b3eb" class="mb mc ir bd md me mf mg mh mi mj mk ml jx mm jy mn ka mo kb mp kd mq ke mr ms bi translated">列出媒体输入和输出设备</h1><p id="4898" class="pw-post-body-paragraph kx ky ir kz b la mt js lc ld mu jv lf lg mv li lj lk mw lm ln lo mx lq lr ls ik bi translated">作为开发者，我们不能做出为什么不能接入用户麦克风或摄像头的假设。使用<code class="fe my mz na nb b">navigator.mediaDevices.enumerateDevices()</code>方法，我们可以获得媒体输入和输出设备的列表。</p><p id="e745" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">这个方法返回一个<code class="fe my mz na nb b">Promise</code>，所以得到那个列表超级简单！</p><pre class="kh ki kj kk gu nc nb nd ne aw nf bi"><span id="e085" class="ng mc ir nb b gz nh ni l nj nk">navigator.mediaDevices.enumerateDevices()<br/>  .then(function(devices) {<br/>    console.log('devices: ', devices);<br/>  })<br/>  .catch(function(err) {<br/>    console.log(err.name + ": " + err.message);<br/>  });</span></pre><p id="10bb" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">这是我此刻的结果。</p><pre class="kh ki kj kk gu nc nb nd ne aw nf bi"><span id="1dd8" class="ng mc ir nb b gz nh ni l nj nk">[<br/>   {<br/>      "deviceId":"default",<br/>      "kind":"audioinput",<br/>      "label":"Default - MacBook Pro Microphone (Built-in)",<br/>      "groupId":"8e16639392cc33ed9421836432166375ff23720fe41cfab2bf1d350b8f83f5f5"<br/>   },<br/>   {<br/>      "deviceId":"6e06241b89f9043e7101d5dbd2bdf91f7ba9ea78c0e5aa5efc58927e1f28c6f6",<br/>      "kind":"audioinput",<br/>      "label":"ray’s AirPods Pro (Bluetooth)",<br/>      "groupId":"48357ddc7bab573800fd4db4c1d9dac1d0fb800d1fb9fd21cd2608c330db9a20"<br/>   },<br/>   {<br/>      "deviceId":"2108da4a847ad10cf90c85af7cb29a29db54bf810afb18e58639e345fbe2abd7",<br/>      "kind":"audioinput",<br/>      "label":"MacBook Pro Microphone (Built-in)",<br/>      "groupId":"8e16639392cc33ed9421836432166375ff23720fe41cfab2bf1d350b8f83f5f5"<br/>   },<br/>   {<br/>      "deviceId":"default",<br/>      "kind":"audiooutput",<br/>      "label":"Default - ray’s AirPods Pro (Bluetooth)",<br/>      "groupId":"48357ddc7bab573800fd4db4c1d9dac1d0fb800d1fb9fd21cd2608c330db9a20"<br/>   },<br/>   {<br/>      "deviceId":"dd51ddd88220fda9209daf2dba9608b960a7539d1deac7007af734b3d30580fc",<br/>      "kind":"audiooutput",<br/>      "label":"ray’s AirPods Pro (Bluetooth)",<br/>      "groupId":"48357ddc7bab573800fd4db4c1d9dac1d0fb800d1fb9fd21cd2608c330db9a20"<br/>   },<br/>   {<br/>      "deviceId":"985ba2f44a8db0d1ef0b50f8e6f7a0b682535b91ea631cad24ae483e871cebfd",<br/>      "kind":"audiooutput",<br/>      "label":"U32J59x (DisplayPort)",<br/>      "groupId":"91b72f113dc19f56739a74dcd2d8a422a4e5abef6a1efa0fd2e9f17ac2216bf0"<br/>   },<br/>   {<br/>      "deviceId":"223700057fcf336336b3d6ab9f8dc7a281cb52b2409bec081aaeed8aa68c518a",<br/>      "kind":"audiooutput",<br/>      "label":"[Samsung] Soundbar J-Series (Bluetooth)",<br/>      "groupId":"f1b0ba1e49bf6873ee2cb14193d5e6fa29fa3fc86e4b858734d2f15e0103bd66"<br/>   },<br/>   {<br/>      "deviceId":"67d7d9cddb6f0cdc0fd7d13c9dd4f85f466be86d0a55c7ae572155d1383a1371",<br/>      "kind":"audiooutput",<br/>      "label":"MacBook Pro Speakers (Built-in)",<br/>      "groupId":"8e16639392cc33ed9421836432166375ff23720fe41cfab2bf1d350b8f83f5f5"<br/>   }<br/>]</span></pre><p id="5ba4" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">所以你会得到所有媒体设备的完整列表。但有一点是清楚的；列表中没有相机。(<em class="lt">我的新M1有一个有缺陷的网络摄像头，应该被修复</em>)如果我没有这个问题，我可能不会调查这个问题，也不会从用户的角度尝试修复它。</p><p id="0aaa" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">现在我们知道了计算机连接了哪种类型的输入设备，我们可以为用户编写一条错误消息。请注意，这与访问无关；这只是连接到我的计算机的媒体设备列表。</p></div><div class="ab cl lu lv hv lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="ik il im in io"><h1 id="258e" class="mb mc ir bd md me mf mg mh mi mj mk ml jx mm jy mn ka mo kb mp kd mq ke mr ms bi translated">拿到摄像机和麦克风。</h1><p id="b9f3" class="pw-post-body-paragraph kx ky ir kz b la mt js lc ld mu jv lf lg mv li lj lk mw lm ln lo mx lq lr ls ik bi translated">但是我们想区分它是否与访问问题有关，媒体设备是否由不同的软件使用，或者是否没有连接摄像头。</p><p id="61b2" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">让我们检查一下是否可以访问用户电脑的摄像头和麦克风。</p><p id="7caf" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">为此，我们可以使用<code class="fe my mz na nb b">navigator.mediaDevices.getUserMedia(constraints)</code>。这个方法还返回一个<code class="fe my mz na nb b">Promise</code>，这使得它很容易实现。</p><pre class="kh ki kj kk gu nc nb nd ne aw nf bi"><span id="8169" class="ng mc ir nb b gz nh ni l nj nk">async function getMedia(constraints) {<br/>  let stream = null;<br/>  const constraints = {audio: true, video: true}</span><span id="12cc" class="ng mc ir nb b gz nl ni l nj nk">  try {<br/>    stream = await navigator.mediaDevices.getUserMedia(constraints);<br/>    /* use the stream */<br/>  } catch(err) {<br/>    /* handle the error */<br/>  }<br/>}</span></pre><p id="4bda" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">通过这个功能，我们可以看到我们是否可以访问麦克风和摄像头。但是由于我的电脑没有连接摄像头，我们得到了一个<code class="fe my mz na nb b">NotFoundError</code>，但是我们看不到是麦克风还是摄像头的问题。</p><p id="4a1a" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">因此，我们必须为音频和视频分别运行该功能。</p></div><div class="ab cl lu lv hv lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="ik il im in io"><h1 id="d102" class="mb mc ir bd md me mf mg mh mi mj mk ml jx mm jy mn ka mo kb mp kd mq ke mr ms bi translated">音频和视频访问</h1><p id="16fb" class="pw-post-body-paragraph kx ky ir kz b la mt js lc ld mu jv lf lg mv li lj lk mw lm ln lo mx lq lr ls ik bi translated">因此，我创建了一个功能来发现是否有音频和视频设备连接到计算机，以及我们是否可以访问它。该函数返回一个带有完整结果的<code class="fe my mz na nb b">Promise</code>。</p><pre class="kh ki kj kk gu nc nb nd ne aw nf bi"><span id="1178" class="ng mc ir nb b gz nh ni l nj nk">function getMediaDevices() {<br/>  /*<br/>   * This function checks the device if it has any audio and video input.<br/>   * This is purely to check, not to check if the user has allowed the application to use an audio or video input device.<br/>   * The function returns a Promise with an object of what types of input devices the computer has.<br/>   * Documentation can be found: <a class="ae kw" href="https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/enumerateDevices" rel="noopener ugc nofollow" target="_blank">https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/enumerateDevices</a><br/>   */<br/>  let hasVideo = false;<br/>  let hasAudio = false;<br/>  let audioAccess = false;<br/>  let videoAccess = false;</span><span id="fefd" class="ng mc ir nb b gz nl ni l nj nk">  return new Promise(async (resolve, reject) =&gt; {<br/>    if (navigator.mediaDevices) {<br/>      let devices = null;</span><span id="ac5f" class="ng mc ir nb b gz nl ni l nj nk">      try {<br/>        devices = await navigator.mediaDevices.enumerateDevices();<br/>        console.log(JSON.stringify(devices));<br/>        devices.forEach(function (device) {<br/>          if (device.kind === "audioinput") {<br/>            hasAudio = true;<br/>          }<br/>          if (device.kind === "videoinput") {<br/>            hasVideo = true;<br/>          }<br/>        });<br/>      } catch (error) {<br/>        console.error("There are no media devices available in this device.");<br/>      }</span><span id="8fef" class="ng mc ir nb b gz nl ni l nj nk">      try {<br/>        audioAccess = await navigator.mediaDevices.getUserMedia({<br/>          audio: true<br/>        });<br/>      } catch (error) {<br/>        console.error(<br/>          "The browser has no access to the microphone of the device."<br/>        );<br/>      }</span><span id="19b3" class="ng mc ir nb b gz nl ni l nj nk">      try {<br/>        videoAccess = await navigator.mediaDevices.getUserMedia({<br/>          video: true<br/>        });<br/>      } catch (error) {<br/>        console.error("The browser has no access to the camera of the device.");<br/>      }</span><span id="d3c7" class="ng mc ir nb b gz nl ni l nj nk">      resolve({<br/>        hasAudio: hasAudio,<br/>        hasVideo: hasVideo,<br/>        audioAccess: audioAccess,<br/>        videoAccess: videoAccess<br/>      });<br/>    } else {<br/>      reject({ error: "The media devices could not be checked" });<br/>    }<br/>  });<br/>}</span></pre><p id="8eee" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">但是如果其中一个设备有问题，我们想给用户一个消息。例如，如果摄像机已经被团队使用。然后我们可以看到一个视频设备，但我们无法访问它。</p><p id="dd4b" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">对于错误处理程序，我创建了一个函数，如果您愿意，可以使用它。</p><pre class="kh ki kj kk gu nc nb nd ne aw nf bi"><span id="1bff" class="ng mc ir nb b gz nh ni l nj nk">function mediaDevicesAvailable() {<br/>  console.log("Check Media!");<br/>  getMediaDevices().then((media) =&gt; {<br/>    const errorWrapper = document.querySelector(".error-on-initialize");<br/>    let errorMessage = null;</span><span id="5f9e" class="ng mc ir nb b gz nl ni l nj nk">    if (!media.hasAudio &amp;&amp; media.hasVideo) {<br/>      errorMessage = "Could not find your microphone.";<br/>    } else if (!media.hasVideo &amp;&amp; media.hasAudio) {<br/>      errorMessage = "Could not find your camera.";<br/>    } else if (!media.hasVideo &amp;&amp; !media.hasAudio) {<br/>      errorMessage = "Could not find your camera and microphone. ";<br/>    }</span><span id="d0ea" class="ng mc ir nb b gz nl ni l nj nk">    if (!media.audioAccess &amp;&amp; media.videoAccess) {<br/>      errorMessage = deviceErrorMsg("microphone");<br/>    } else if (media.audioAccess &amp;&amp; !media.videoAccess) {<br/>      errorMessage = deviceErrorMsg("camera");<br/>    } else if (!media.audioAccess &amp;&amp; !media.videoAccess) {<br/>      errorMessage = deviceErrorMsg("camera and microphone");<br/>    }</span><span id="aaab" class="ng mc ir nb b gz nl ni l nj nk">    if (errorWrapper) {<br/>      errorWrapper.innerHTML = errorMessage;<br/>    }<br/>  });<br/>}</span><span id="c0f9" class="ng mc ir nb b gz nl ni l nj nk">function deviceErrorMsg(device) {<br/>  return `We can not use your ${device}. Please turn off any other software that is using your ${device}.`;<br/>}</span></pre><p id="9deb" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">确保为DOM中的现有元素定义了选择器。如果有的话，它会显示一个错误。否则，它不会显示任何内容。</p><p id="599d" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">如果您想在示例中看到这一点，请检查下面的<a class="ae kw" href="https://codepen.io/devbyrayray/pen/vYypaEJ" rel="noopener ugc nofollow" target="_blank">代码栏</a>。</p><figure class="kh ki kj kk gu kl"><div class="bz fq l di"><div class="nm nn l"/></div></figure></div><div class="ab cl lu lv hv lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="ik il im in io"><h1 id="0aeb" class="mb mc ir bd md me mf mg mh mi mj mk ml jx mm jy mn ka mo kb mp kd mq ke mr ms bi translated">结论</h1><p id="86da" class="pw-post-body-paragraph kx ky ir kz b la mt js lc ld mu jv lf lg mv li lj lk mw lm ln lo mx lq lr ls ik bi translated">也许这不是您的确切用例，但是使用我的代码作为灵感来找出为什么您不能访问音频或视频设备。</p><p id="0667" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">如果你有问题，请让我知道。😉</p><p id="de87" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated"><em class="lt">编码快乐！🚀</em></p></div></div>    
</body>
</html>