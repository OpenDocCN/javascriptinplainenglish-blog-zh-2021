<html>
<head>
<title>Create a WhatsApp Clone with Next.js: Send Message</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Next.js: Send Message创建WhatsApp克隆</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/create-whatsapp-clone-with-next-js-part-27-send-message-bb3a4481dc73?source=collection_archive---------3-----------------------#2021-11-21">https://javascript.plainenglish.io/create-whatsapp-clone-with-next-js-part-27-send-message-bb3a4481dc73?source=collection_archive---------3-----------------------#2021-11-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="dd7c" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">第27部分:用addDoc Firestore函数向消息集合发送消息</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/a52f7bf5d3d5e5d8c443def788c9db92.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*tb1QPzs-ciZRBHLW"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Photo by <a class="ae kv" href="https://unsplash.com/@alexbemore?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Alexander Shatov</a> on <a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="d81d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这一部分，我们开始添加sendMessage功能，这样用户就可以将消息发送给他们的朋友。</p><p id="2e43" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">首先，我们需要添加状态输入来存储消息。</p><pre class="kg kh ki kj gt ls lt lu lv aw lw bi"><span id="456c" class="lx ly iq lt b gy lz ma l mb mc">const [input, setInput] = useState("")</span></pre><p id="5202" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在输入组件中，检测值的变化，并将其设置为“输入”状态。</p><pre class="kg kh ki kj gt ls lt lu lv aw lw bi"><span id="b23b" class="lx ly iq lt b gy lz ma l mb mc">&lt;Input onChange={e=&gt;setInput(e.target.value)} value={input}</span><span id="a4ac" class="lx ly iq lt b gy md ma l mb mc">placeholder="Type a message" /&gt;</span></pre><h2 id="79a7" class="lx ly iq bd me mf mg dn mh mi mj dp mk lf ml mm mn lj mo mp mq ln mr ms mt mu bi translated">创建sendMessage函数</h2><p id="100a" class="pw-post-body-paragraph kw kx iq ky b kz mv jr lb lc mw ju le lf mx lh li lj my ll lm ln mz lp lq lr ij bi translated">在sendMessage函数中，我们主要想做三件事，一是存储用户最后一次活动的时间。第二种是发送带有时间戳和用户电子邮件以及photoURL的消息。第三个是存储最新聊天消息和最新消息时间戳，这样它就可以显示在侧边栏中。</p><p id="4a3a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="na">存储用户上次活动时间</em></p><pre class="kg kh ki kj gt ls lt lu lv aw lw bi"><span id="8335" class="lx ly iq lt b gy lz ma l mb mc">import { useAuth } from '../Auth';</span><span id="56ac" class="lx ly iq lt b gy md ma l mb mc">const {currentUser} = useAuth()</span><span id="11e4" class="lx ly iq lt b gy md ma l mb mc">const usersRef = doc(db, "users",currentUser.uid);</span><span id="a207" class="lx ly iq lt b gy md ma l mb mc">setDoc(usersRef,{lastSeen:serverTimestamp()},{merge:true})</span></pre><p id="3308" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="na">发送消息</em></p><p id="1aa4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">转到聊天收藏，使用聊天id选择，转到收藏消息，并创建一个新文档来存储带有时间戳、消息、电子邮件和照片URL的消息。</p><pre class="kg kh ki kj gt ls lt lu lv aw lw bi"><span id="f261" class="lx ly iq lt b gy lz ma l mb mc">import { addDoc, collection, doc, serverTimestamp, setDoc } from '@firebase/firestore';</span><span id="83d1" class="lx ly iq lt b gy md ma l mb mc">import { db } from '../firebase';</span><span id="930d" class="lx ly iq lt b gy md ma l mb mc">const messagesRef = collection(db, "chats",id,"messages");</span><span id="487e" class="lx ly iq lt b gy md ma l mb mc">await addDoc(messagesRef,{</span><span id="476c" class="lx ly iq lt b gy md ma l mb mc">timestamp:serverTimestamp(),</span><span id="2e5d" class="lx ly iq lt b gy md ma l mb mc">message:input,</span><span id="39c4" class="lx ly iq lt b gy md ma l mb mc">user:currentUser.email,</span><span id="580f" class="lx ly iq lt b gy md ma l mb mc">photoURL:currentUser.photoURL</span><span id="1ffe" class="lx ly iq lt b gy md ma l mb mc">})</span></pre><p id="8eea" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="na">存储最新信息和时间</em></p><p id="e47d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用setDoc函数在id为的聊天集合中选择聊天，这样它会用最新的时间戳和消息替换旧文档。</p><pre class="kg kh ki kj gt ls lt lu lv aw lw bi"><span id="baf9" class="lx ly iq lt b gy lz ma l mb mc">const chatRef = doc(db, "chats",id);</span><span id="82cb" class="lx ly iq lt b gy md ma l mb mc">setDoc(chatRef,{</span><span id="feb9" class="lx ly iq lt b gy md ma l mb mc">latestMessage:input,</span><span id="b442" class="lx ly iq lt b gy md ma l mb mc">timestamp:serverTimestamp()</span><span id="6cce" class="lx ly iq lt b gy md ma l mb mc">}, {merge:true});</span></pre><p id="fd6a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">所有东西准备好后，通过<code class="fe nb nc nd lt b">setInput('')</code>清除输入框的信息</p><p id="d729" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">完整代码:</p><pre class="kg kh ki kj gt ls lt lu lv aw lw bi"><span id="c755" class="lx ly iq lt b gy lz ma l mb mc">const sendMessage= async(e)=&gt;{</span><span id="c056" class="lx ly iq lt b gy md ma l mb mc">e.preventDefault();</span><span id="c978" class="lx ly iq lt b gy md ma l mb mc">const usersRef = doc(db, "users",currentUser.uid);</span><span id="fd17" class="lx ly iq lt b gy md ma l mb mc">setDoc(usersRef,{lastSeen:serverTimestamp()},{merge:true})</span><span id="a0e0" class="lx ly iq lt b gy md ma l mb mc">const messagesRef = collection(db, "chats",id,"messages");</span><span id="21d6" class="lx ly iq lt b gy md ma l mb mc">await addDoc(messagesRef,{</span><span id="30e1" class="lx ly iq lt b gy md ma l mb mc">timestamp:serverTimestamp(),</span><span id="0e5a" class="lx ly iq lt b gy md ma l mb mc">message:input,</span><span id="c393" class="lx ly iq lt b gy md ma l mb mc">user:currentUser.email,</span><span id="d1c9" class="lx ly iq lt b gy md ma l mb mc">photoURL:currentUser.photoURL</span><span id="7e29" class="lx ly iq lt b gy md ma l mb mc">})</span><span id="0af1" class="lx ly iq lt b gy md ma l mb mc">const chatRef = doc(db, "chats",id);</span><span id="2415" class="lx ly iq lt b gy md ma l mb mc">setDoc(chatRef,{</span><span id="a18e" class="lx ly iq lt b gy md ma l mb mc">latestMessage:input,</span><span id="078c" class="lx ly iq lt b gy md ma l mb mc">timestamp:serverTimestamp()</span><span id="4689" class="lx ly iq lt b gy md ma l mb mc">}, {merge:true});</span><span id="fbcd" class="lx ly iq lt b gy md ma l mb mc">setInput('')</span><span id="31cb" class="lx ly iq lt b gy md ma l mb mc">}</span></pre><p id="4811" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了触发sendMessage，我们使用一个隐藏的按钮来发送。它只有在有输入时才发送。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ne"><img src="../Images/1cf95bf7b691e79c9e3c3cd387e48035.png" data-original-src="https://miro.medium.com/v2/resize:fit:1396/format:webp/1*9sn6ZvbF4AlxU-q6P3QZ5A.png"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">messages added to messages collection, latest message and timestamp added to the chat</figcaption></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nf"><img src="../Images/3b6e7173520e6b492e0b8cda65aecd69.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZTSRKuhdRV-ROUu-bjS61A.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">lastSeen time is added to the user document</figcaption></figure><h1 id="55df" class="ng ly iq bd me nh ni nj mh nk nl nm mk jw nn jx mn jz no ka mq kc np kd mt nq bi translated">关注我们:<a class="ae kv" href="https://www.youtube.com/channel/UCu4-4FnutvSHVo9WHvq80Ww?sub_confirmation=1" rel="noopener ugc nofollow" target="_blank"> YouTube </a>，<a class="ae kv" href="https://ckmobile.medium.com/" rel="noopener"> Medium </a>，<a class="ae kv" href="https://www.udemy.com/user/cyruschan2/" rel="noopener ugc nofollow" target="_blank"> Udemy </a>，<a class="ae kv" href="https://www.linkedin.com/company/ckmobi/" rel="noopener ugc nofollow" target="_blank"> Linkedin </a>，<a class="ae kv" href="https://twitter.com/ckmobilejavasc1" rel="noopener ugc nofollow" target="_blank"> Twitter </a>，<a class="ae kv" href="https://www.instagram.com/ckmobile8050" rel="noopener ugc nofollow" target="_blank"> Instagram </a>，<a class="ae kv" href="https://app.gumroad.com/ckmobile" rel="noopener ugc nofollow" target="_blank"> Gumroad </a></h1><p id="edc3" class="pw-post-body-paragraph kw kx iq ky b kz mv jr lb lc mw ju le lf mx lh li lj my ll lm ln mz lp lq lr ij bi translated">加入分支机构赚钱</p><p id="ffd1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">【https://ckmobile.gumroad.com/affiliates】</p><p id="2541" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="na">更多内容看</em> <a class="ae kv" href="http://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <em class="na">说白了就是</em> </a> <em class="na">。在这里注册我们的</em> <a class="ae kv" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <em class="na">免费周报</em> </a> <em class="na">。</em></p></div></div>    
</body>
</html>