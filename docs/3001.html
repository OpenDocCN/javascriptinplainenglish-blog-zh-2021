<html>
<head>
<title>Writing a Captcha Validator with Express</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Express编写验证码验证程序</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/writing-the-simplest-captcha-validator-for-express-2a3f1411ec0e?source=collection_archive---------2-----------------------#2021-06-18">https://javascript.plainenglish.io/writing-the-simplest-captcha-validator-for-express-2a3f1411ec0e?source=collection_archive---------2-----------------------#2021-06-18</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/96abb1b36ba6bb4ed4dd3815d55c7578.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3rsEZDH89n1hvKB2qt4HLw.jpeg"/></div></div></figure><p id="6882" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">最近我的任务是创建一个验证码服务，在每次表单提交之前，你的服务器都会验证验证码。我不允许使用谷歌验证码，因为他们都有一个自定义的用户界面。</p><p id="a693" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">所以我问自己，如何创建验证码，什么是验证码？对我来说，captcha是一个有限的字符串，它根据客户端输入进行验证，验证后让用户看到他想要的东西，通常是图像，因为如果是文本，可以在客户端找到。</p><p id="b416" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">每个服务器中都有一个会话的概念，我使用过很多PHP，所以我对什么是会话有一个很好的概念。因为你几乎一直都在用。与会话类似，我们也可以轻松地在express上实现会话。下面是在express服务器中实现会话的代码。</p><pre class="kt ku kv kw gt kx ky kz la aw lb bi"><span id="a95b" class="lc ld in ky b gy le lf l lg lh">var cookieParser = require("cookie-parser");</span><span id="7bc7" class="lc ld in ky b gy li lf l lg lh">var session = require("express-session");</span><span id="2855" class="lc ld in ky b gy li lf l lg lh">app.use(cookieParser("Your secret key"));</span><span id="6743" class="lc ld in ky b gy li lf l lg lh">app.use(session());</span></pre><p id="6ba8" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">回到验证码，要求是一个有文字的图像，比如说6个字符写在上面。下面是生成随机字符串的函数的代码。</p><pre class="kt ku kv kw gt kx ky kz la aw lb bi"><span id="7ab7" class="lc ld in ky b gy le lf l lg lh">export function RANDOMWORDS(length) {  <br/> var result = '';  </span><span id="5d86" class="lc ld in ky b gy li lf l lg lh"> var characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';    <br/> <br/> var charactersLength = characters.length;  </span><span id="ebca" class="lc ld in ky b gy li lf l lg lh"> for (var i = 0; i &lt; length; i++) {    <br/>  result += characters.charAt(Math.floor(Math.random() *    <br/>  charactersLength));  <br/> }  </span><span id="07c6" class="lc ld in ky b gy li lf l lg lh">return result;<br/>}</span></pre><p id="6c3f" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">好的，下一步是把图像转换成文本，所以我们要用一个库，因为我很擅长这个。</p><pre class="kt ku kv kw gt kx ky kz la aw lb bi"><span id="d919" class="lc ld in ky b gy le lf l lg lh">const textToImage = require("text-to-image");<br/>await textToImage.generate(`  ${RANDOMWORDS(6)}  `, {<br/>maxWidth: 100,<br/>});</span></pre><p id="773b" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">上面的图像很容易被任何OCR图像解码。您可以尝试寻找另一种方法来处理稍微复杂的图像。</p><p id="63af" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">现在，让我们也来处理express部分。</p><pre class="kt ku kv kw gt kx ky kz la aw lb bi"><span id="aba9" class="lc ld in ky b gy le lf l lg lh">app.get("/generate/captcha.png", async function (req, res, next) {</span><span id="e652" class="lc ld in ky b gy li lf l lg lh">var captcha = RANDOMWORDS(6)<br/>var sess = req.session;<br/>sess.captcha = captcha;</span><span id="709b" class="lc ld in ky b gy li lf l lg lh">const dataUri = await textToImage.generate(`  ${captcha}  `, {<br/>maxWidth: 100,<br/>});</span><span id="4b39" class="lc ld in ky b gy li lf l lg lh">const im = dataUri.split(",")[1];<br/>const img = Buffer.from(im, "base64");</span><span id="148a" class="lc ld in ky b gy li lf l lg lh">res.writeHead(200, {<br/>"Content-Type": "image/png",<br/>"Content-Length": img.length,<br/>});</span><span id="2e0c" class="lc ld in ky b gy li lf l lg lh">res.end(img);</span><span id="85f0" class="lc ld in ky b gy li lf l lg lh">});</span></pre><p id="9877" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">上面的代码将生成一个新的验证码，每次点击端点都会生成一个新的会话，它将返回一个png图像，上面写有文本。</p><p id="790a" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">要验证验证码，您可以执行以下操作。</p><pre class="kt ku kv kw gt kx ky kz la aw lb bi"><span id="fdb5" class="lc ld in ky b gy le lf l lg lh">var captcha = req.body.captcha;</span><span id="0767" class="lc ld in ky b gy li lf l lg lh">if (!captcha) {<br/>return next("invalid");<br/>}</span><span id="6822" class="lc ld in ky b gy li lf l lg lh">if (captcha != req.session.captcha) return res.send("invalid");</span></pre><p id="2d37" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">就是这样！</p><p id="6429" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi">— — — — — — — — — — — — — — — — — — — — — — —</p><p id="9185" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">找自由职业者？通过Fiverr 雇用我。</p><p id="eb9e" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi">— — — — — — — — — — — — — — — — — — — — — — —</p><p id="0898" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><em class="lk">更多内容尽在</em><a class="ae lj" href="http://plainenglish.io" rel="noopener ugc nofollow" target="_blank"><strong class="jx io"><em class="lk">plain English . io</em></strong></a></p></div></div>    
</body>
</html>