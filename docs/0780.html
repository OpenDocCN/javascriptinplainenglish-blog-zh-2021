<html>
<head>
<title>Deno — HTTP, Server, File Server, and Subprocesses</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Deno — HTTP、服务器、文件服务器和子进程</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/deno-http-server-file-server-and-subprocesses-70d6624e4706?source=collection_archive---------15-----------------------#2021-02-17">https://javascript.plainenglish.io/deno-http-server-file-server-and-subprocesses-70d6624e4706?source=collection_archive---------15-----------------------#2021-02-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/a5ac1c3f78b41a7bace6c7786c094323.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*zT-qOVC090k-aT2Q"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@qwitka?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Maksym Kaharlytskyi</a> on <a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="9d01" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Deno是一个新的服务器端运行时环境，用于运行JavaScript和TypeScript应用程序。</p><p id="2c2b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，我们将了解如何开始为Deno开发应用程序。</p><h1 id="0aec" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">简单HTTP Web服务器</h1><p id="750b" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以用Deno提供的<code class="fe me mf mg mh b">server</code>模块创建一个简单的HTTP服务器。</p><p id="8729" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="b1e3" class="mq lc iq mh b gy mr ms l mt mu">import { serve } from "https://deno.land/std@0.75.0/http/server.ts";</span><span id="af17" class="mq lc iq mh b gy mv ms l mt mu">const server = serve({ hostname: "0.0.0.0", port: 8080 });<br/>console.log(`HTTP server running on port 8080`);</span><span id="7857" class="mq lc iq mh b gy mv ms l mt mu">for await (const request of server) {<br/>  const bodyContent = `Your user-agent is: ${request.headers.get("user-agent") || "Unknown"}`;<br/>  request.respond({ status: 200, body: bodyContent });<br/>}</span></pre><p id="140d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们导入<code class="fe me mf mg mh b">serve</code>函数来创建我们的HTTP服务器。</p><p id="b9f4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对象有<code class="fe me mf mg mh b">hostname</code>和<code class="fe me mf mg mh b">port</code>来监听请求。</p><p id="c3a1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，我们在for-await-of循环中创建响应体。</p><p id="1e6e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们通过调用<code class="fe me mf mg mh b">request.headers.get</code>来获取标题。</p><p id="1e18" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们用HTTP状态代码和对象中的主体调用<code class="fe me mf mg mh b">request.response</code>，我们用它作为<code class="fe me mf mg mh b">respond</code>的参数。</p><p id="59bd" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，我们可以使用以下命令运行脚本:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="7c28" class="mq lc iq mh b gy mr ms l mt mu">deno run --allow-net index.ts</span></pre><p id="f726" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，当我们转到<a class="ae kc" href="http://localhost:" rel="noopener ugc nofollow" target="_blank"> http://localhost: </a> 8080时，我们应该会看到类似这样的内容:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="5acc" class="mq lc iq mh b gy mr ms l mt mu">Your user-agent is: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.111 Safari/537.36</span></pre><h1 id="12bb" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">文件服务器</h1><p id="b8e3" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们也可以用Deno轻松创建一个文件服务器。</p><p id="9106" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为此，我们只需运行:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="cc63" class="mq lc iq mh b gy mr ms l mt mu">deno run --allow-net --allow-read https://deno.land/std@0.75.0/http/file_server.ts</span></pre><p id="1370" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，当我们转到http://localhost:4507/时，我们会看到列出了当前文件夹中的文件。</p><h1 id="faba" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">TCP回送服务器</h1><p id="a5ef" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以用<code class="fe me mf mg mh b">Deno.listen</code>和<code class="fe me mf mg mh b">Deno.copy</code>方法轻松创建一个TCP echo服务器。</p><p id="6c8e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="31bb" class="mq lc iq mh b gy mr ms l mt mu">const listener = Deno.listen({ port: 8080 });<br/>console.log("listening on 0.0.0.0:8080");<br/>for await (const conn of listener) {<br/>  Deno.copy(conn, conn);<br/>}</span></pre><p id="75c4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">监听8080端口。</p><p id="65e1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们遍历<code class="fe me mf mg mh b">listener</code>数组来观察请求。</p><p id="08a5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们调用<code class="fe me mf mg mh b">Deno.copy</code>将连接数据重定向到入站。</p><h1 id="2c18" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">创建子流程</h1><p id="da48" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以使用<code class="fe me mf mg mh b">Deno.run</code>方法创建一个子流程。</p><p id="e65b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以运行:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="8162" class="mq lc iq mh b gy mr ms l mt mu">const p = Deno.run({<br/>  cmd: ["echo", "hello"],<br/>});<br/>await p.status();</span></pre><p id="0b77" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">运行<code class="fe me mf mg mh b">echo hello</code>。</p><p id="f03d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们可以用<code class="fe me mf mg mh b">p.status</code>方法等待它的完成。</p><p id="696b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们需要<code class="fe me mf mg mh b">--allow-run</code>标志来运行子流程。</p><p id="6655" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以通过使用各种方法从子流程中获得结果并运行它们。</p><p id="0d8f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="b642" class="mq lc iq mh b gy mr ms l mt mu">const fileNames = Deno.args;</span><span id="1059" class="mq lc iq mh b gy mv ms l mt mu">const p = Deno.run({<br/>  cmd: [<br/>    "deno",<br/>    "run",<br/>    "--allow-read",<br/>    "https://deno.land/std@0.75.0/examples/cat.ts",<br/>    ...fileNames,<br/>  ],<br/>  stdout: "piped",<br/>  stderr: "piped",<br/>});</span><span id="9dd8" class="mq lc iq mh b gy mv ms l mt mu">const { code } = await p.status();</span><span id="9967" class="mq lc iq mh b gy mv ms l mt mu">if (code === 0) {<br/>  const rawOutput = await p.output();<br/>  await Deno.stdout.write(rawOutput);<br/>} else {<br/>  const rawError = await p.stderrOutput();<br/>  const errorString = new TextDecoder().decode(rawError);<br/>  console.log(errorString);<br/>}</span><span id="4903" class="mq lc iq mh b gy mv ms l mt mu">Deno.exit(code);</span></pre><p id="6d95" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们调用<code class="fe me mf mg mh b">status</code>方法来获取状态代码。</p><p id="f289" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果代码是0，我们就写输出。</p><p id="1b08" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">否则，我们将错误输出到<code class="fe me mf mg mh b">stderr</code>。</p><p id="ba6c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们把绳子记录下来。</p><p id="7680" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最后，我们用命令的退出代码调用<code class="fe me mf mg mh b">Deno.exit</code>。</p><h1 id="ef24" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">结论</h1><p id="ea3e" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以创建一个简单的HTTP服务器、文件服务器，并使用Deno轻松运行子流程。</p><p id="8577" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">喜欢这篇文章吗？如果有，通过<a class="ae kc" href="https://www.youtube.com/channel/UCtipWUghju290NWcn8jhyAw?sub_confirmation=true" rel="noopener ugc nofollow" target="_blank"> <strong class="kf ir">订阅我们的YouTube频道</strong> </a> <strong class="kf ir">获取更多类似内容！</strong></p></div></div>    
</body>
</html>