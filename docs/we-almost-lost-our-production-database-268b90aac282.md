# 我们几乎失去了我们的生产数据库

> 原文：<https://javascript.plainenglish.io/we-almost-lost-our-production-database-268b90aac282?source=collection_archive---------5----------------------->

## 对现实危机的技术剖析

![](img/239b1b40ea33c343ef702daa6edbf17c.png)

Photo by [Andrea Piacquadio](https://www.pexels.com/@olly?utm_content=attributionCopyText&utm_medium=referral&utm_source=pexels) from [Pexels](https://www.pexels.com/photo/shallow-focus-photo-of-man-reading-newspaper-3799099/?utm_content=attributionCopyText&utm_medium=referral&utm_source=pexels)

上周五，我接到朋友(也是我的生意伙伴)的电话。一些客户打电话给他，说他们在仪表板上看不到任何数据。

“你确定他们可以登录吗？”我问我的朋友。

“是的，他们可以，但登录后看不到任何东西，”他回答说。

他不是技术人员，也没有开发人员在我们国家的假期打电话。他让我调查这个问题。

事情就是这样开始的…

# 可能的原因

我在之前的工作中已经面对了足够多的类似情况。我立即想到的可能原因是。

*   用户做错了什么。(非常不可能)
*   由于某种原因，获取用户详细信息 API 不工作
*   凭证不知怎么搞混了(可能是前端缓存什么的)
*   最坏的情况-数据丢失

现在，我需要仔细检查每一种可能性，找出真正的问题所在。

# 放弃第一种可能性

让我半技术性地概述一下这个东西是如何工作的。

我们使用 firebase 进行身份验证。成功登录后，firebase 返回一个令牌，然后用这个令牌向提供 JWT 的 Node.js 后端发出后续请求。

所以如果用户可以登录，就意味着凭据是正确的，因为 Firebase 不会出错，对吗？😛

所以我们这边肯定有问题。

# 最可怕的噩梦！

在这种情况下，首先要找出特定用户的凭证，以检查出了什么问题。但在我看来，询问顾客的证件似乎是错误的。这会向他们传达一个错误的信息。

于是我创建了一个新用户，尝试登录。这是成功的，令我惊讶的是，我能够在仪表板上看到细节！

经证实，firebase 上的身份验证在此阶段正常工作，我们的 API 也正常工作！所以只剩下一个选择了。

> 数据丢失！

好，好，好。这是一家公司可能发生的最糟糕的事情。此外，我们谈论的客户是付费客户，在该用户的个人资料中存储了一些敏感信息。

因此，找出问题所在至关重要。

# 这不是结束！

在发现 API 工作正常后，我打电话给我的朋友，收集了更多的客户信息，并检查了他们的资料。

事实证明，我们过去 6 个月的所有客户的仪表板上都没有任何数据。所有的凭据都是正确的，但不幸的是，他们中没有人能看到任何数据。

我别无选择。我想不出任何可能的答案或理由。

# 所以我们召集了一次会议

我们召集利益相关者召开了紧急会议。因为是周末，不可能让开发人员参加会议。

"有什么新功能可以让用户删除所有内容吗？"我问。

这是一个愚蠢的问题，但在过去的几个月里，我并没有参与开发过程，所以我并不了解最新的特性。

事实证明，有部分删除用户信息的要求。后端 API 已经准备好了，但是前端并没有进行修改。

所以客户不可能自己从数据库中删除一些数据！

我想，“好吧。有没有可能所有用户都调用了这个 API？”。在检查后端代码后，我没有发现删除用户重要信息的更改，所以我们不得不放弃这个选项。

# 新线索！

我们的一个朋友查看了过去几个月应用程序的部署过程。我们公司正处于转型期，目前还没有积极的发展。

我们设计了使用 GitHub 管道部署后端的常用流程，该管道将应用程序部署到 AWS ECS 集群中。这是一个自动的过程。

看了部署流程的朋友告诉我们，之前的部署流程被改了。现在我们将部署到一个 EC2 实例。

好，好，好。我想起了以前的一个事件，环境文件被交换，导致 API 命中错误的数据库。

# 抓住你了。

当我们没有选择的时候，我们最终决定再次手动部署应用程序。我不确定这是为什么，但是在使用正确的环境文件进行新的部署之后，一切都神奇地工作了！

# 自我反省的时刻

就这些吗？我们浪费了两天时间才发现重新部署是解决方案？到底发生了什么？

事实证明，我的朋友手工制作了一个数据库的克隆。他不是数据管理方面的专家，所以他想，让我们用新克隆的数据库来学习吧。

出于某种原因，我仍然不确定为什么。有些表没有被克隆。API 一直指向错误的数据库。我们还在错误的数据库中搜索数据。

# 我们学到了什么？

这件事再一次告诉我们，一个不好的流程会带来什么灾难。由于公司正在经历一段艰难的时期，没有积极的开发活动，我的朋友觉得没有必要通知我们他对数据库和部署过程所做的更改。

结果，我们失去了客户的信任，白白浪费了两天时间。

> 但是即使是不好的事情也有好的一面，对吗？

也许下次类似的事情发生时，我会建议不看任何东西就重新部署:P 也许我会鼓励每个人和我自己更多地遵循好的实践。

不管是什么？我希望这样的事情永远不要再发生。

感谢阅读。祝您愉快！

**通过** [**LinkedIn**](https://www.linkedin.com/in/56faisal/) **或我的** [**个人网站**](https://www.mohammadfaisal.dev/) **与我取得联系。**

*更多内容看*[***plain English . io***](http://plainenglish.io/)