<html>
<head>
<title>Lazy Loading JavaScript With the New Intersection Observer API</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用新的交叉点观察器API延迟加载JavaScript</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/lazy-load-javascript-5d63cbfb83fb?source=collection_archive---------7-----------------------#2021-08-09">https://javascript.plainenglish.io/lazy-load-javascript-5d63cbfb83fb?source=collection_archive---------7-----------------------#2021-08-09</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="5e9e" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">需要时加载，就像React和co中一样。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/1008393d509788a3bcd8e27e27e4d261.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TLHqm1OUCtmOWD9-IWNndw.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Source: the author</figcaption></figure><p id="759c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">延迟加载的想法并不新鲜——但是JavaScript世界中的实现却很新鲜。React.js的懒加载API是2018年底才正式发布的。</p><p id="6f6a" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">当你看React-lazy或其他工具的代码时，你会意识到它有多复杂。我们希望在真正需要的时候将JavaScript代码加载到浏览器中。</p><p id="a6aa" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">幸运的是，现在有一个新的API使这变得更加容易:交叉点观察器API。创新的静态站点生成器<a class="ae lr" rel="noopener ugc nofollow" target="_blank" href="/astro-cec429f049d"> Astro </a>也使用它。</p><p id="2745" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">乍一看，这个新API与延迟加载无关:它帮助我们检测DOM元素何时在浏览器中可见。下面是我们如何使用它以一种有意义的方式延迟加载JavaScript。</p><h2 id="8279" class="ls lt iq bd lu lv lw dn lx ly lz dp ma le mb mc md li me mf mg lm mh mi mj mk bi translated">基本项目结构</h2><p id="9008" class="pw-post-body-paragraph kv kw iq kx b ky ml jr la lb mm ju ld le mn lg lh li mo lk ll lm mp lo lp lq ij bi translated">我知道这很难，但是我们不会使用任何框架或库。<br/>我们从以下文件开始:</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="bc29" class="ls lt iq mr b gy mv mw l mx my">.<br/>├── app.js<br/>├── index.html<br/>└── lazy.js</span></pre><p id="09d6" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><code class="fe mz na nb mr b">app.js</code>包含延迟加载的代码，<code class="fe mz na nb mr b">lazy.js</code>是我们想要延迟加载的文件。在<code class="fe mz na nb mr b">index.html</code>中，我创建了一个H1标签列表，当打开页面时，最后一个标签是不可见的。(如果它在你的屏幕上可见，只需添加更多的H1标签，这样最后一个<code class="fe mz na nb mr b">&lt;h1 id="hiddenH1"&gt;</code>在默认情况下是不可见的。目标是通过JavaScript改变最后一个H1的样式，但是只有当用户看到元素时。</p><p id="9d2d" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我知道这对于延迟加载来说并不现实，但是它可以作为一个例子。</p><p id="f183" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">你可以在我的GitHub 上找到完整的<a class="ae lr" href="https://github.com/LouisPetrik/lazy-loading-from-scratch" rel="noopener ugc nofollow" target="_blank">代码，但是我现在将浏览每个文件。</a></p><p id="872a" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">index.html:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="1d97" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我认为这里没什么特别的，所以让我们转到最有趣的部分:包含惰性加载代码的<code class="fe mz na nb mr b">app.js</code>:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="44ad" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">让我们一步一步来:</p><ol class=""><li id="3d13" class="ne nf iq kx b ky kz lb lc le ng li nh lm ni lq nj nk nl nm bi translated">就在第一行，引用了H1，打开页面时看不到它。这里没什么特别的。</li><li id="3966" class="ne nf iq kx b ky nn lb no le np li nq lm nr lq nj nk nl nm bi translated">lazyLoad()函数创建一个新的脚本标签，并将其插入DOM。src-attribute指的是我们想要延迟加载的<code class="fe mz na nb mr b">lazy.js</code>文件。像这样插入脚本标签会导致浏览器加载脚本，即使页面已经加载了。</li><li id="261d" class="ne nf iq kx b ky nn lb no le np li nq lm nr lq nj nk nl nm bi translated">交叉点观察器API是作为一个类编写的——我们创建了一个观察器的新实例，将其称为“观察器”我们提供了一个函数作为回调函数，每当一个被观察的元素<strong class="kx ir">进入或退出或者viewport </strong>(在我们的例子中)时都会被执行。</li></ol><p id="185d" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在提供options对象时，我们还可以指定一个环绕元素，而不是整个视口——但是在我们的例子中，默认的监视视口就可以了。</p><p id="ca41" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">回调函数接收一个条目数组，在我们的代码中称为<code class="fe mz na nb mr b">entries</code>——它是DOM元素的列表，其交集状态发生了变化。在我们的代码中，只有一个受监控的元素，所以数组中只有一个条目——我们用<code class="fe mz na nb mr b">entries[0]</code>访问它。</p><p id="b9d8" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">通过检查<code class="fe mz na nb mr b">entries[0].isIntersecting</code>是否为真，我们检查我们被监控的元素是否进入了视口——因此对用户是可见的。注意:默认情况下，<em class="ns">is intersection</em>可以多次切换到true。例如，当它进入视口时，离开它并再次进入它。因此，<code class="fe mz na nb mr b">observer.unobserve(hiddenH1)</code>一旦我们的H1可见，就关闭它的观察器，并且需要所需的JavaScript代码。</p><p id="5edc" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">为了让延迟加载的效果可见，我编写了一个setTimeout，它延迟了延迟加载。最后，这里是lazy.js:</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="ba4d" class="ls lt iq mr b gy mv mw l mx my">// since we already loaded app.js, defining hiddenH1,<br/>// we can access it, an change it’s styles: </span><span id="2c0b" class="ls lt iq mr b gy nt mw l mx my">hiddenH1.style.color = "red"</span></pre><p id="bb49" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">它所做的只是将最后一个H1的字体颜色设置为红色。</p><p id="ae0a" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">下面是完整的代码:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nu"><img src="../Images/246cdea7bfcd588a36e0abc0a3e62dbb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*lzLAtgaqcyVgmXe8HsZAdA.gif"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">source: the author</figcaption></figure><p id="35b9" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">感谢您的阅读！</p><p id="431a" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">关于加载JavaScript的更多信息:</p><div class="nv nw gp gr nx ny"><a rel="noopener  ugc nofollow" target="_blank" href="/async-and-defer-the-complete-guide-to-loading-javascript-properly-ce6edce1e6b5"><div class="nz ab fo"><div class="oa ab ob cl cj oc"><h2 class="bd ir gy z fp od fr fs oe fu fw ip bi translated">异步和延迟——如何正确加载JavaScript</h2><div class="of l"><h3 class="bd b gy z fp od fr fs oe fu fw dk translated">解决错误并提高性能</h3></div><div class="og l"><p class="bd b dl z fp od fr fs oe fu fw dk translated">javascript.plainenglish.io</p></div></div><div class="oh l"><div class="oi l oj ok ol oh om kp ny"/></div></div></a></div><p id="5d8a" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><a class="ae lr" href="http://eepurl.com/hacY0v" rel="noopener ugc nofollow" target="_blank"> <strong class="kx ir">加入我的时事通讯保持最新</strong> </a></p><p id="55ba" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><em class="ns">更多内容请看</em><a class="ae lr" href="http://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><strong class="kx ir"><em class="ns">plain English . io</em></strong></a></p></div></div>    
</body>
</html>