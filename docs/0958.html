<html>
<head>
<title>Environment Variables &amp; File I/O in Node.js Cron Jobs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Node.js Cron作业中的环境变量和文件I/O</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/environment-variables-file-i-o-in-node-js-cron-jobs-5e8558202fc7?source=collection_archive---------9-----------------------#2021-02-28">https://javascript.plainenglish.io/environment-variables-file-i-o-in-node-js-cron-jobs-5e8558202fc7?source=collection_archive---------9-----------------------#2021-02-28</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="50c5" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">“我在哪里？”</h2></div><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi kc"><img src="../Images/2e7757112c1483051726dd9ccd32d24d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*z-RHexlWzmnBOXjfOZxjEQ.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Garbage + CRON + NodeJS = GoodTimes</figcaption></figure><h1 id="5e79" class="ks kt in bd ku kv kw kx ky kz la lb lc jt ld ju le jw lf jx lg jz lh ka li lj bi translated">介绍</h1><p id="caab" class="pw-post-body-paragraph lk ll in lm b ln lo jo lp lq lr jr ls lt lu lv lw lx ly lz ma mb mc md me mf ig bi translated">这是我开发的一个<a class="ae mg" href="https://github.com/d-otis/tweetStreets" rel="noopener ugc nofollow" target="_blank">小Node.js应用</a>上的一个偶然系列的一部分，用来让我了解费城街道部门的垃圾/回收收集状况。像过去一年的许多事情一样，由于疫情和2021年冬季风暴的突然袭击，垃圾/回收收集在我们地区变得非常不稳定。</p><p id="6267" class="pw-post-body-paragraph lk ll in lm b ln mh jo lp lq mi jr ls lt mj lv lw lx mk lz ma mb ml md me mf ig bi translated">如果我的垃圾要到周三或者下周五才会被清理，为什么要在周五把它们拿出来呢？这个小小的Node.js应用程序试图缓解这种情况，并通过每小时查看费城街道部门的Twitter，如果有延迟，给我发电子邮件，防止我的垃圾被扔得到处都是。</p><p id="3ab4" class="pw-post-body-paragraph lk ll in lm b ln mh jo lp lq mi jr ls lt mj lv lw lx mk lz ma mb ml md me mf ig bi translated">一切都很好，直到我不得不把我的MacBook Pro拿到店里进行一些维修。我一直通过<code class="fe mn mo mp mq b">launchctl load</code>命令和我放在<code class="fe mn mo mp mq b">Launch Agents</code>文件夹中的<code class="fe mn mo mp mq b">.plist</code>文件从macOS的内置<code class="fe mn mo mp mq b">launchd</code>中启动任务。在这里阅读<a class="ae mg" href="https://medium.com/swlh/how-to-use-launchd-to-run-services-in-macos-b972ed1e352" rel="noopener"/>。我想让我的应用程序在我的笔记本电脑停止运行的1.5周内保持运行，所以我把所有东西都移植到我基于Debian的Raspberry Pi上，并使用<code class="fe mn mo mp mq b">cron -e</code>设置了一个CRON作业。阅读关于在树莓平台上设置CRON作业的信息。我不能发表这篇文章而不包括<a class="ae mg" href="https://crontab.guru/" rel="noopener ugc nofollow" target="_blank">这个奇妙的资源</a>来拨入你的CRON时间表表达式。下面是一张有趣的截图:</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi mr"><img src="../Images/3945cdee01fbf0017b93c708a5a13a3f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*frNzxvrc2A9-aZbcg2WO-Q.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Screenshot from crontab guru ❤</figcaption></figure><h1 id="2666" class="ks kt in bd ku kv kw kx ky kz la lb lc jt ld ju le jw lf jx lg jz lh ka li lj bi translated">问题</h1><h2 id="2658" class="ms kt in bd ku mt mu dn ky mv mw dp lc lt mx my le lx mz na lg mb nb nc li nd bi translated">第一部分。环境变量</h2><p id="d478" class="pw-post-body-paragraph lk ll in lm b ln lo jo lp lq lr jr ls lt lu lv lw lx ly lz ma mb mc md me mf ig bi translated">我开始收到错误消息，说我对Twitter API的访问依赖于凭证，不知何故，这些凭证没有从我的<code class="fe mn mo mp mq b">.env</code>文件传递到我的节点应用程序，该应用程序在我的PI上作为CRON作业运行。原来，与在Mac上运行来自<code class="fe mn mo mp mq b">launchd</code>的进程不同，CRON作业从根目录执行，所以我的节点应用程序试图通过<code class="fe mn mo mp mq b">process.env.&lt;ENV_VARIABLE_HERE&gt;</code>与<code class="fe mn mo mp mq b"><a class="ae mg" href="https://www.npmjs.com/package/dotenv" rel="noopener ugc nofollow" target="_blank">dotenv</a></code> npm包合谋获取我的凭证，并得出nada。下面是我如何使用访问环境变量的简化版本:</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="ne nf l"/></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Original Code for Accessing .env Environment Variables</figcaption></figure><h2 id="c4c0" class="ms kt in bd ku mt mu dn ky mv mw dp lc lt mx my le lx mz na lg mb nb nc li nd bi translated">第二部分。文件输入输出</h2><p id="e3ae" class="pw-post-body-paragraph lk ll in lm b ln lo jo lp lq lr jr ls lt lu lv lw lx ly lz ma mb mc md me mf ig bi translated">为了跟踪我从应用程序中通过电子邮件发送给自己的内容——一旦推特标识通过我的标准并通过电子邮件发送给我，我就会保存它们，并且在程序启动时也会阅读保存的标识，以避免重复。以下是我如何使用<code class="fe mn mo mp mq b">process.cwd()</code>将我的身份证写入文本文件。有一次我在我的覆盆子馅饼上做CRON工作时，它对我非常生气！</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="ne nf l"/></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Original Logic for Writing IDs to File Using process.cwd()</figcaption></figure><h1 id="0a11" class="ks kt in bd ku kv kw kx ky kz la lb lc jt ld ju le jw lf jx lg jz lh ka li lj bi translated">解决方法</h1><h2 id="7d61" class="ms kt in bd ku mt mu dn ky mv mw dp lc lt mx my le lx mz na lg mb nb nc li nd bi translated">第一部分。环境变量</h2><p id="72b4" class="pw-post-body-paragraph lk ll in lm b ln lo jo lp lq lr jr ls lt lu lv lw lx ly lz ma mb mc md me mf ig bi translated">由于<code class="fe mn mo mp mq b">dotenv.config()</code>通过<code class="fe mn mo mp mq b">path.resolve(process.cwd(), ‘.env’)</code> <a class="ae mg" href="https://github.com/motdotla/dotenv#path" rel="noopener ugc nofollow" target="_blank">将当前工作目录解析为默认的</a>目录，我们需要在引擎盖下查看并更改它的外观，以防我们从根调用该进程成为一个la CRON作业。下面我们将通过<code class="fe mn mo mp mq b">.config()</code>方法传递一个带有<code class="fe mn mo mp mq b">path</code>键的对象，指向JS文件的<code class="fe mn mo mp mq b">__dirname</code>，然后在目录级别上更进一步，非常明确地指向<code class="fe mn mo mp mq b">.env</code>。祈祷手表情符号。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="ne nf l"/></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Custom configuration for dotenv module usage</figcaption></figure><h2 id="9675" class="ms kt in bd ku mt mu dn ky mv mw dp lc lt mx my le lx mz na lg mb nb nc li nd bi translated">第二部分。文件输入/输出</h2><p id="106e" class="pw-post-body-paragraph lk ll in lm b ln lo jo lp lq lr jr ls lt lu lv lw lx ly lz ma mb mc md me mf ig bi translated">使用类似的工具可以解决文件I/O问题。在这里，我们拉入<code class="fe mn mo mp mq b">path</code>模块和<code class="fe mn mo mp mq b">.join()</code><code class="fe mn mo mp mq b"> __dirname</code>指令，通过<code class="fe mn mo mp mq b">‘..’</code>进入保存我们的<code class="fe mn mo mp mq b">ids.txt</code>文件的<code class="fe mn mo mp mq b">/db</code>目录所在的位置。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="ne nf l"/></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Updated Accessing of ids.txt File</figcaption></figure><h1 id="ba3b" class="ks kt in bd ku kv kw kx ky kz la lb lc jt ld ju le jw lf jx lg jz lh ka li lj bi translated">结论</h1><p id="fc56" class="pw-post-body-paragraph lk ll in lm b ln lo jo lp lq lr jr ls lt lu lv lw lx ly lz ma mb mc md me mf ig bi translated">概括地说:当以一种新的执行方式运行Node.js应用程序时(CRON对比<code class="fe mn mo mp mq b">launchd</code>)，我遇到了一些环境变量和文件位置的问题。通过一点谷歌搜索，我找到了一个在CRON和<code class="fe mn mo mp mq b">launchd</code>流程中都有效的解决方案。我希望这能帮助其他人！</p><p id="adcd" class="pw-post-body-paragraph lk ll in lm b ln mh jo lp lq mi jr ls lt mj lv lw lx mk lz ma mb ml md me mf ig bi translated">在<a class="ae mg" href="http://www.twitter.com/_dan_foley_" rel="noopener ugc nofollow" target="_blank">推特</a> &amp; <a class="ae mg" href="http://github.com/d-otis" rel="noopener ugc nofollow" target="_blank">推特</a>上跟我来！</p></div></div>    
</body>
</html>