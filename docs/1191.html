<html>
<head>
<title>React Image Loading Optimization Techniques</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">React图像加载优化技术</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/image-loading-in-react-js-preloading-lazy-loading-intersectionobserver-fade-in-transitions-722c24f4d5fb?source=collection_archive---------2-----------------------#2021-03-13">https://javascript.plainenglish.io/image-loading-in-react-js-preloading-lazy-loading-intersectionobserver-fade-in-transitions-722c24f4d5fb?source=collection_archive---------2-----------------------#2021-03-13</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="580f" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">第1部分:预加载，延迟加载，<strong class="ak"><em class="kf">【intersection observer，</em> </strong>【淡入过渡，窗口，错误处理，占位符等等</h2></div><h1 id="5ea5" class="kg kh iq bd ki kj kk kl km kn ko kp kq jw kr jx ks jz kt ka ku kc kv kd kw kx bi translated">介绍</h1><p id="f5ec" class="pw-post-body-paragraph ky kz iq la b lb lc jr ld le lf ju lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">就职业而言，我首先是一名(本地)Android开发人员，已经为一系列公司和项目工作了6年多。<br/>开发世界中的一个挑战性问题是，如果你想创建一个应用程序，并在市场上成为一个重要的参与者，你需要为iOS <strong class="la ir">和安卓</strong>开发应用程序。其他问题可能会出现，如:我也应该创建一个网站吗？或者当你想创建一个网站时，你至少应该确保它在移动设备上看起来不错。我是不是应该先把重点放在<em class="lu">手机上……</em>因为可以说大多数听说过你的网站的用户首先会想通过他们的移动设备来尝试和访问它？</p><p id="fb1c" class="pw-post-body-paragraph ky kz iq la b lb lv jr ld le lw ju lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">在我工作过的所有公司中，每个平台(iOS/Android/Web)都有自己的开发团队。每个团队通常解决许多相同的挑战，很少交换想法或代码。由于所用语言的本质差异，似乎无法找到一种方法来结合或减少工作努力的桥梁。</p><p id="fe66" class="pw-post-body-paragraph ky kz iq la b lb lv jr ld le lw ju lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">因此，我一直在思考的一个问题是:“有没有一种方法可以让我创建一个网站/应用程序来设置我的项目，以便它1。在台式机/笔记本电脑2上看起来不错。可以在Android以及iOS设备上使用3。请记住，大多数用户希望通过移动设备访问它。</p><p id="3e0e" class="pw-post-body-paragraph ky kz iq la b lb lv jr ld le lw ju lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">显而易见的答案是，创建一个基于网络的应用程序，用户可以通过他们的网络浏览器访问，这也是一个额外的好处，不必处理发布到Google Play或苹果应用程序商店带来的额外工作。<br/>脸书做到了……而且用户体验水平足够好，足以满足我对自己平台的期望……那么我为什么不能做到呢？)<br/>所以我去年决定开始学习React JS和一些后端开发，并着手看看我是否能创建<a class="ae ma" href="https://metacules.com" rel="noopener ugc nofollow" target="_blank">metacules.com</a>平台。这里的文字描述了React JS世界中的一些冒险。</p></div><div class="ab cl mb mc hu md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="ij ik il im in"><h1 id="abfd" class="kg kh iq bd ki kj mi kl km kn mj kp kq jw mk jx ks jz ml ka ku kc mm kd kw kx bi translated">图像，图像，图像…</h1><p id="1ced" class="pw-post-body-paragraph ky kz iq la b lb lc jr ld le lf ju lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">视觉故事讲述:图像…可能是任何应用程序或网站最重要的方面之一。在Android开发中，多年来我们已经有了像Glide和Picasso这样的库，使得Android开发人员的图像加载变得相当“容易”。<br/>当我转到React JS学习web开发时，我非常惊讶地发现，开发人员的水平还没有达到我习惯的在Kotlin或像Android Studio这样的IDE中开发的水平。</p><p id="d596" class="pw-post-body-paragraph ky kz iq la b lb lv jr ld le lw ju lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">像图像加载这样琐碎的事情并不像使用整个开发社区都在使用的库那么简单。所以我开始一步一步地解决这个问题…一块一块拼图…从我从Stackoverflow和Medium帖子中收集的综合信息中…</p><figure class="mo mp mq mr gt ms gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi mn"><img src="../Images/a7be49d7dbda5803de2515bcd9358b58.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2SYxuvdjKfamdTldqu5Zmg.png"/></div></div><figcaption class="mz na gj gh gi nb nc bd b be z dk">Part of the Home screen of the desktop version of metacules.com</figcaption></figure><p id="3feb" class="pw-post-body-paragraph ky kz iq la b lb lv jr ld le lw ju lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">我需要解决的一些图像加载问题有:</p><ol class=""><li id="a90f" class="nd ne iq la b lb lv le lw lh nf ll ng lp nh lt ni nj nk nl bi translated">如何在图像显示在屏幕上之前预加载它们？我不想只在开始加载图像时才在视窗中显示。</li><li id="c38b" class="nd ne iq la b lb nm le nn lh no ll np lp nq lt ni nj nk nl bi translated"><strong class="la ir">如何限制预加载图像的数量</strong>？例如，metacules.com的主屏幕提供了滚动浏览250多人列表的选项，并通过选择一个人来启动查询，以找到与该人相关的播客、视频和书籍。在我们列表的第一个实现中，一个网络请求获取所有的图像，当然，这对于性能来说不是很好。</li><li id="23de" class="nd ne iq la b lb nm le nn lh no ll np lp nq lt ni nj nk nl bi translated"><strong class="la ir">如何在加载图片url出错时显示占位符？</strong></li><li id="4fd5" class="nd ne iq la b lb nm le nn lh no ll np lp nq lt ni nj nk nl bi translated"><strong class="la ir">当图像进入视窗时，如何在图像尚未显示/完全加载时添加淡入过渡？</strong></li><li id="6072" class="nd ne iq la b lb nm le nn lh no ll np lp nq lt ni nj nk nl bi translated"><strong class="la ir">如何添加加载动画，给用户一个图像正在加载的视觉提示？</strong></li></ol><h1 id="cb45" class="kg kh iq bd ki kj kk kl km kn ko kp kq jw kr jx ks jz kt ka ku kc kv kd kw kx bi translated">使用<strong class="ak">react-lazy-load</strong>&amp;<strong class="ak">react-lazy load</strong>遇到的问题</h1><p id="16c4" class="pw-post-body-paragraph ky kz iq la b lb lc jr ld le lf ju lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">最初我开始使用像<a class="ae ma" href="https://www.npmjs.com/package/react-lazy-load" rel="noopener ugc nofollow" target="_blank"> react-lazy-load </a>和<a class="ae ma" href="https://www.npmjs.com/package/react-lazyload" rel="noopener ugc nofollow" target="_blank"> react-lazyload </a>这样的包(其中第二个似乎更受欢迎)。<br/>我试用了两个非常受欢迎的包，下载量都超过了20万次，解决了只在图像进入视窗之前才开始加载图像的问题。<br/>lazy load实现看起来相对简单，类似下面的代码将延迟加载图像(在本例中是在垂直列表中),直到图像进入300px的视口范围。</p><pre class="mo mp mq mr gt nr ns nt nu aw nv bi"><span id="5e3b" class="nw kh iq ns b gy nx ny l nz oa">&lt;LazyLoad <strong class="ns ir">height</strong>={imageHeight} <strong class="ns ir">offsetVertical</strong>={300}&gt;<br/>   &lt;img sr<strong class="ns ir">c</strong>={imageUrl} /&gt;<br/>&lt;/LazyLoad&gt;</span></pre><p id="d6a4" class="pw-post-body-paragraph ky kz iq la b lb lv jr ld le lw ju lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">一切看起来都很好，直到我们在图像列表中添加了一个随机按钮功能，这样用户不仅可以通过滚动，还可以通过按下按钮来发现其他项目。现在，在主屏幕的情况下，其中显示了一个人的卡片列表，其中列表被打乱加载，图像不会被触发，用户首先需要滚动一点点来触发图像加载。这很奇怪，当然也是不想要的行为，我们无法直接找到一个可靠的解决方案，需要编写一些额外的代码来触发图像加载。</p><h1 id="a5a9" class="kg kh iq bd ki kj kk kl km kn ko kp kq jw kr jx ks jz kt ka ku kc kv kd kw kx bi translated">图像未载入时显示占位符</h1><p id="93a2" class="pw-post-body-paragraph ky kz iq la b lb lc jr ld le lf ju lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">Javascript的图像组件<img/>包含一个属性/事件回调，用于加载图像出错时。这让我想到，如果我想在图像无法加载时显示一个占位符，实现起来会相对容易一些，如下所示:</p><pre class="mo mp mq mr gt nr ns nt nu aw nv bi"><span id="f233" class="nw kh iq ns b gy nx ny l nz oa"><em class="lu">&lt;</em>img src={imageUrl}<br/>     onError={(e) =&gt; e.target.src = {placeholder}}<em class="lu"><br/>     </em>alt=""<em class="lu">/&gt;</em></span></pre><p id="1663" class="pw-post-body-paragraph ky kz iq la b lb lv jr ld le lw ju lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">不幸的是，这还不够，例如，当图像url为空时，占位符有时根本不会显示。或者，在应该触发错误和占位符显示的情况下，有时会显示图像的Base64字符串。</p><p id="b78d" class="pw-post-body-paragraph ky kz iq la b lb lv jr ld le lw ju lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">当src url为空时，onError回调未被触发的问题可以通过在src值上添加or运算符来巧妙解决。像这样:</p><pre class="mo mp mq mr gt nr ns nt nu aw nv bi"><span id="3fb9" class="nw kh iq ns b gy nx ny l nz oa"><em class="lu">&lt;</em>img src={imageUrl <strong class="ns ir">|| placeholder</strong>}<br/>     onError={(e) =&gt; e.target.src = {placeholder}}<em class="lu"><br/>     </em>alt=""<em class="lu">/&gt;</em></span></pre><p id="9852" class="pw-post-body-paragraph ky kz iq la b lb lv jr ld le lw ju lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">在我浏览了一段时间后，发现GitHub repo上的一些代码没有使用<em class="lu"> react lazy load </em>包之一，而是使用了交叉点观察器API来延迟图像的加载，并且也有一些预加载图像的实现，因此Base64字符串显示而不是实际图像的问题得到了解决。正是在这个预加载的错误处理实现中，我找到了一种在&lt; img &gt;组件上实际设置占位符的方法，而不是错误地显示没有正确加载的图像的Base64字符串。</p><p id="ae25" class="pw-post-body-paragraph ky kz iq la b lb lv jr ld le lw ju lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">不幸的是，我已经不知道是在哪个回购协议中找到的代码，我用它作为自己实现ImageLoading包装组件的基础，但我的代码看起来应该是这样的:</p><pre class="mo mp mq mr gt nr ns nt nu aw nv bi"><span id="af91" class="nw kh iq ns b gy nx ny l nz oa">class PreloadImage extends React.Component <em class="lu">{<br/>    </em>constructor<em class="lu">(</em>props<em class="lu">) {<br/>        </em>super<em class="lu">(</em>props<em class="lu">)</em>;<br/>        this.state = <em class="lu">{<br/>            </em>loaded: false,<br/>            src: null,<br/>            placeholder: this.props.placeholder || null,<br/>        };<br/>    }</span><span id="52d5" class="nw kh iq ns b gy ob ny l nz oa">    componentDidMount() {<br/>        if (this.props.lazy &amp;&amp; 'IntersectionObserver' in <strong class="ns ir">window</strong>) {<br/>            this.setObserver();<br/>        } else {<br/>            this.setPreloader();<br/>        }<br/>    }</span><span id="37c2" class="nw kh iq ns b gy ob ny l nz oa">componentWillUnmount() {<br/>        if (this.observer) this.observer.disconnect();<br/>        if (this.preloader) this.preloader.onload = null;<br/>    }</span><span id="07de" class="nw kh iq ns b gy ob ny l nz oa">setObserver() {<br/>        this.observer = new <strong class="ns ir">IntersectionObserver</strong>((entries) =&gt; {<br/>            entries.forEach((entry) =&gt; {<br/>                if (entry.isIntersecting) {<br/>                    this.setPreloader();<br/>                    this.observer.disconnect();<br/>                }<br/>            });<br/>        });<br/>        this.observer.observe(this.el);<br/>    }</span><span id="5d6a" class="nw kh iq ns b gy ob ny l nz oa">    setPreloader() {<br/>        this.preloader = new <strong class="ns ir">Image</strong>();<br/>        this.preloader.onload = () =&gt; {<br/>            this.setState({<br/>                loaded: true,<br/>                src: this.props.src<br/>            });<br/>        };<br/>        this.preloader.onerror = () =&gt; {<br/>            this.setState({<br/>                loaded: true,<br/>                src: this.state.placeholder<br/>            });<br/>        };</span><span id="5913" class="nw kh iq ns b gy ob ny l nz oa">        this.preloader.src = this.props.src;<br/>    }</span><span id="f3da" class="nw kh iq ns b gy ob ny l nz oa">    render() {<br/>        return (<br/>            &lt;div ref={(el) =&gt; this.el = el}&gt;<br/>                &lt;img src={this.state.src || this.state.placeholder}<br/>                     ref={(el) =&gt; this.el = el}<br/>                     onError={(e) =&gt; {<br/>                         e.target.src = this.state.placeholder;<br/>                     }}<br/>                     alt=""/&gt;<br/>            &lt;/div&gt;<br/>        );<br/>    }<br/>}</span><span id="f7d5" class="nw kh iq ns b gy ob ny l nz oa">export default PreloadImage;</span></pre><p id="03ec" class="pw-post-body-paragraph ky kz iq la b lb lv jr ld le lw ju lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">然后，其他组件可以使用此组件，并设置带有占位符回退的图像src，如下所示:</p><pre class="mo mp mq mr gt nr ns nt nu aw nv bi"><span id="08e3" class="nw kh iq ns b gy nx ny l nz oa">&lt;PreloadImage  <br/>    lazy<br/>    src={imageUrl} <br/>    placeholder={placeholder}<br/> /&gt;</span></pre><p id="2162" class="pw-post-body-paragraph ky kz iq la b lb lv jr ld le lw ju lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">在<preloadimage>上添加lazy属性将阻止图像被预加载，直到交叉点观察器触发加载。</preloadimage></p><p id="6187" class="pw-post-body-paragraph ky kz iq la b lb lv jr ld le lw ju lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">此外，注意在<preloadimage>的内部实现中，<strong class="la ir"> imageUrl </strong>并没有直接设置为&lt; img &gt;标签上的值。</preloadimage></p><p id="8d2a" class="pw-post-body-paragraph ky kz iq la b lb lv jr ld le lw ju lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">相反，每当调用setPreloader()时，图像的加载将由imageUrl触发，imageUrl通过<preloadimage>上的src属性提供。根据加载是失败还是成功，占位符或实际的src url将被设置为<img/>标签的src属性。现在，在图像加载失败的情况下，偶尔会放在UI上的Base6字符串将不再显示，因为图像的预加载实际上正确地触发了错误。</preloadimage></p><h1 id="b732" class="kg kh iq bd ki kj kk kl km kn ko kp kq jw kr jx ks jz kt ka ku kc kv kd kw kx bi translated">更多内容将在第2部分介绍</h1><p id="2039" class="pw-post-body-paragraph ky kz iq la b lb lc jr ld le lf ju lg lh li lj lk ll lm ln lo lp lq lr ls lt ij bi translated">在下一部分中，我们将更深入地研究图像加载的实现、淡入动画、何时预加载或推迟预加载直到图像进入视口附近的模式等等。</p><p id="ade5" class="pw-post-body-paragraph ky kz iq la b lb lv jr ld le lw ju lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">关注我，了解未来帖子的最新动态。</p><p id="c9a0" class="pw-post-body-paragraph ky kz iq la b lb lv jr ld le lw ju lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">第2部分的链接:<a class="ae ma" href="https://rik-van-velzen.medium.com/react-image-loading-optimization-techniques-b885427bde44" rel="noopener">https://JavaScript . plain English . io/image-loading-in-react-js-preloading-lazy-loading-intersection observer-fade-in-transitions-722 c24 F4 D5 FB</a></p></div><div class="ab cl mb mc hu md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="ij ik il im in"><p id="c08d" class="pw-post-body-paragraph ky kz iq la b lb lv jr ld le lw ju lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated">如果您有任何额外的东西要添加、改进，或者如果您想给我们的项目送去一些爱或支持，您可以给我们买一杯咖啡或帮助筹集我们创建元规则(一种审查的解毒剂)平台的资金，请通过</p><ul class=""><li id="805d" class="nd ne iq la b lb lv le lw lh nf ll ng lp nh lt oc nj nk nl bi translated"><a class="ae ma" href="https://www.buymeacoffee.com/l5LnQfk" rel="noopener ugc nofollow" target="_blank">https://www.buymeacoffee.com/l5LnQfk</a></li><li id="039c" class="nd ne iq la b lb nm le nn lh no ll np lp nq lt oc nj nk nl bi translated">https://fundrazr.com/f1ldl3<a class="ae ma" href="https://fundrazr.com/f1ldl3" rel="noopener ugc nofollow" target="_blank"/></li></ul><p id="12ac" class="pw-post-body-paragraph ky kz iq la b lb lv jr ld le lw ju lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated"><em class="lu">里克·范·韦尔森是metacules的创始人，高级(Android)移动开发者，目前是使用React/NodeJs的metacules平台的开发者。<br/>您可以在社交媒体上关注我们:</em></p><p id="da0c" class="pw-post-body-paragraph ky kz iq la b lb lv jr ld le lw ju lg lh lx lj lk ll ly ln lo lp lz lr ls lt ij bi translated"><em class="lu"> -推特:</em><a class="ae ma" href="https://twitter.com/VelzenRik" rel="noopener ugc nofollow" target="_blank">https://twitter.com/VelzenRik</a><br/>-<em class="lu">推特</em>:<a class="ae ma" href="https://twitter.com/metacules" rel="noopener ugc nofollow" target="_blank">https://twitter.com/metacules</a><br/>-<em class="lu">脸书</em>:<a class="ae ma" href="https://www.facebook.com/Metaculescom-100856938688500" rel="noopener ugc nofollow" target="_blank">https://www.facebook.com/Metaculescom-100856938688500</a></p><figure class="mo mp mq mr gt ms gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi od"><img src="../Images/c08ac77f23d3f41940524419906a4ba5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IslAlwYOeT0f4BaSZrQRgA.jpeg"/></div></div><figcaption class="mz na gj gh gi nb nc bd b be z dk">Screenshot part of the Landing Page of metacules.com</figcaption></figure></div><div class="ab cl mb mc hu md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="ij ik il im in"><h1 id="0a83" class="kg kh iq bd ki kj mi kl km kn mj kp kq jw mk jx ks jz ml ka ku kc mm kd kw kx bi translated">链接:</h1><ul class=""><li id="af22" class="nd ne iq la b lb lc le lf lh oe ll of lp og lt oc nj nk nl bi translated">【https://www.npmjs.com/package/react-lazyload】</li><li id="1bbf" class="nd ne iq la b lb nm le nn lh no ll np lp nq lt oc nj nk nl bi translated"><a class="ae ma" href="https://www.npmjs.com/package/react-lazy-load" rel="noopener ugc nofollow" target="_blank">https://www.npmjs.com/package/react-lazy-load</a></li><li id="baee" class="nd ne iq la b lb nm le nn lh no ll np lp nq lt oc nj nk nl bi translated"><a class="ae ma" href="https://levelup.gitconnected.com/what-is-so-special-about-intersection-observer-api-in-javascript-f2430a159fa7" rel="noopener ugc nofollow" target="_blank">https://level up . git connected . com/what-so-special-about-intersection-observer-API-in-JavaScript-f 2430 a 159 fa 7</a></li><li id="3387" class="nd ne iq la b lb nm le nn lh no ll np lp nq lt oc nj nk nl bi translated">https://metacules.com创造审查的解药</li><li id="f285" class="nd ne iq la b lb nm le nn lh no ll np lp nq lt oc nj nk nl bi translated"><a class="ae ma" href="https://fundrazr.com/f1ldl3" rel="noopener ugc nofollow" target="_blank">https://fundrazr.com/f1ldl3</a></li></ul></div></div>    
</body>
</html>