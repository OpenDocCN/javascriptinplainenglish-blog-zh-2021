<html>
<head>
<title>Next.js Firebase v9: Rendering the To-Dos Server-Side</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Next.js Firebase v9:呈现待办事项服务器端</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/nextjs-firebase-v9-part-21-server-side-rendering-the-todos-97c2f519d42a?source=collection_archive---------7-----------------------#2021-10-25">https://javascript.plainenglish.io/nextjs-firebase-v9-part-21-server-side-rendering-the-todos-97c2f519d42a?source=collection_archive---------7-----------------------#2021-10-25</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="505f" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">第21部分:使用Next.js getServerSideProps预构建待办事项。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi kf"><img src="../Images/c6d360eb3b41b5d477faff14d841e6e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*uaASVwhIGhFOa128.png"/></div></figure><p id="a900" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">观看<a class="ae lj" href="https://www.youtube.com/watch?v=Sdv3bw2rIuQ&amp;list=PLC5vixW_4xSKqwpgaPEcLj7O3SvUNqC9L" rel="noopener ugc nofollow" target="_blank">视频系列</a>和<a class="ae lj" href="https://www.udemy.com/course/complete-nextjs-firebase-firestore-course/?referralCode=50C342DE4DD73B4428F4" rel="noopener ugc nofollow" target="_blank">源代码</a></p></div><div class="ab cl lk ll hu lm" role="separator"><span class="ln bw bk lo lp lq"/><span class="ln bw bk lo lp lq"/><span class="ln bw bk lo lp"/></div><div class="ij ik il im in"><p id="53c4" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">为了在预构建时获取数据，我们需要使用<code class="fe lr ls lt lu b">getServerSideProps</code>，还需要导入几个包。</p><pre class="kg kh ki kj gt lv lu lw lx aw ly bi"><span id="c4ce" class="lz ma iq lu b gy mb mc l md me">import nookies from 'nookies'</span><span id="df1e" class="lz ma iq lu b gy mf mc l md me">import { verifyIdToken } from '../firebaseAdmin';</span></pre><p id="5f85" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">转到<strong class="kp ir"> index.js </strong>的底部，使用<code class="fe lr ls lt lu b">nookies</code>获取cookies。</p><p id="8c4b" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">使用<code class="fe lr ls lt lu b">firebaseAdmin</code>中的<code class="fe lr ls lt lu b">verifyIdToken</code>获得令牌。</p><p id="bd2d" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">从令牌获取电子邮件地址。既然我们现在有了电子邮件，我们可以获取电子邮件等于用户电子邮件的文档。</p><p id="2e32" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">获取所有待办事项，创建<code class="fe lr ls lt lu b">todosProps</code>。</p><pre class="kg kh ki kj gt lv lu lw lx aw ly bi"><span id="e9d2" class="lz ma iq lu b gy mb mc l md me">export async function getServerSideProps(context) {</span><span id="09d9" class="lz ma iq lu b gy mf mc l md me">try {</span><span id="7b24" class="lz ma iq lu b gy mf mc l md me">const cookies = nookies.get(context);</span><span id="8f9f" class="lz ma iq lu b gy mf mc l md me">const token = await verifyIdToken(cookies.token);</span><span id="fb18" class="lz ma iq lu b gy mf mc l md me">const { email } = token;</span><span id="d4a8" class="lz ma iq lu b gy mf mc l md me">const collectionRef = collection(db, "todos")</span><span id="f127" class="lz ma iq lu b gy mf mc l md me">const q = query(collectionRef, where("email", "==", email), orderBy("timestamp", "desc"));</span><span id="08a2" class="lz ma iq lu b gy mf mc l md me">const querySnapshot = await getDocs(q);</span><span id="4e30" class="lz ma iq lu b gy mf mc l md me">let todos = [];</span><span id="0ddb" class="lz ma iq lu b gy mf mc l md me">querySnapshot.forEach((doc) =&gt; {</span><span id="613d" class="lz ma iq lu b gy mf mc l md me">todos.push({ ...doc.data(), id: doc.id, timestamp: doc.data().timestamp.toDate().getTime() });</span><span id="ca3e" class="lz ma iq lu b gy mf mc l md me">});</span><span id="b630" class="lz ma iq lu b gy mf mc l md me">return {</span><span id="7cd3" class="lz ma iq lu b gy mf mc l md me">props: {</span><span id="5dfc" class="lz ma iq lu b gy mf mc l md me">todosProps: JSON.stringify(todos) || [],</span><span id="7e7f" class="lz ma iq lu b gy mf mc l md me">}</span><span id="4403" class="lz ma iq lu b gy mf mc l md me">// props: { session: `Your email is ${email} and your UID is ${uid}.` },</span><span id="ffe2" class="lz ma iq lu b gy mf mc l md me">};</span><span id="d264" class="lz ma iq lu b gy mf mc l md me">} catch (error) {</span><span id="13f8" class="lz ma iq lu b gy mf mc l md me">return { props: {} };</span><span id="dbb6" class="lz ma iq lu b gy mf mc l md me">}</span><span id="69ed" class="lz ma iq lu b gy mf mc l md me">}</span></pre><p id="b9db" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">之后，将这个<code class="fe lr ls lt lu b">todosProps</code>绑定到<code class="fe lr ls lt lu b">&lt;TodoList&gt;</code>上。</p><pre class="kg kh ki kj gt lv lu lw lx aw ly bi"><span id="0e54" class="lz ma iq lu b gy mb mc l md me">&lt;TodoList todosProps={todosProps}/&gt;</span></pre><h2 id="fd60" class="lz ma iq bd mg mh mi dn mj mk ml dp mm kw mn mo mp la mq mr ms le mt mu mv mw bi translated">托多利斯特</h2><p id="0665" class="pw-post-body-paragraph kn ko iq kp b kq mx jr ks kt my ju kv kw mz ky kz la na lc ld le nb lg lh li ij bi translated">在<code class="fe lr ls lt lu b">&lt;TodoList&gt;</code>处，在解析字符串化的JSON之后，使用<code class="fe lr ls lt lu b">useEffect</code>将<code class="fe lr ls lt lu b">todoProps</code>设置为todos。</p><pre class="kg kh ki kj gt lv lu lw lx aw ly bi"><span id="d202" class="lz ma iq lu b gy mb mc l md me">const TodoList = ({ todosProps }) =&gt; {</span><span id="8c6e" class="lz ma iq lu b gy mf mc l md me">const [todos, setTodos] = useState([])</span><span id="536e" class="lz ma iq lu b gy mf mc l md me">const { currentUser } = useAuth()</span><span id="2560" class="lz ma iq lu b gy mf mc l md me">useEffect(() =&gt; {</span><span id="96ed" class="lz ma iq lu b gy mf mc l md me">setTodos(JSON.parse(todosProps))</span><span id="faf0" class="lz ma iq lu b gy mf mc l md me">}, [todosProps])</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="nd ne di nf bf ng"><div class="gh gi nc"><img src="../Images/d0caa95ac73678b503165654197e97a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*FU3OHxKd1uu1-OOFbRoYPw.gif"/></div></div><figcaption class="nh ni gj gh gi nj nk bd b be z dk">todo list with using getServerSideProps</figcaption></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="nd ne di nf bf ng"><div class="gh gi nc"><img src="../Images/785374040fd2673311635b68b887fe28.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*AZAkxKVl5-R7iqnIGgeHuw.gif"/></div></div><figcaption class="nh ni gj gh gi nj nk bd b be z dk">without using getServerSideProps</figcaption></figure><p id="1c67" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">您可以看到服务器端呈现和没有服务器端呈现之间的差异。</p><p id="add5" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">网站建成后，待办事项列表就已经显示出来了。</p><h1 id="de6a" class="nl ma iq bd mg nm nn no mj np nq nr mm jw ns jx mp jz nt ka ms kc nu kd mv nv bi translated">关注我们:<a class="ae lj" href="https://www.youtube.com/channel/UCu4-4FnutvSHVo9WHvq80Ww?sub_confirmation=1" rel="noopener ugc nofollow" target="_blank"> YouTube </a>，<a class="ae lj" href="https://ckmobile.medium.com/" rel="noopener"> Medium </a>，<a class="ae lj" href="https://www.udemy.com/user/cyruschan2/" rel="noopener ugc nofollow" target="_blank"> Udemy </a>，<a class="ae lj" href="https://www.linkedin.com/company/ckmobi/" rel="noopener ugc nofollow" target="_blank"> Linkedin </a>，<a class="ae lj" href="https://twitter.com/ckmobilejavasc1" rel="noopener ugc nofollow" target="_blank"> Twitter </a>，<a class="ae lj" href="https://www.instagram.com/ckmobile8050" rel="noopener ugc nofollow" target="_blank"> Instagram </a>，<a class="ae lj" href="https://app.gumroad.com/ckmobile" rel="noopener ugc nofollow" target="_blank"> Gumroad </a></h1><p id="8e8a" class="pw-post-body-paragraph kn ko iq kp b kq mx jr ks kt my ju kv kw mz ky kz la na lc ld le nb lg lh li ij bi translated"><em class="nw">更多内容请看</em><a class="ae lj" href="http://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><strong class="kp ir"><em class="nw">plain English . io</em></strong></a></p></div></div>    
</body>
</html>