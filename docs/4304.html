<html>
<head>
<title>Storing Data to MongoDB with Next.js</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Next.js将数据存储到MongoDB</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/storing-data-to-mongodb-with-nextjs-6372319d498b?source=collection_archive---------1-----------------------#2021-08-27">https://javascript.plainenglish.io/storing-data-to-mongodb-with-nextjs-6372319d498b?source=collection_archive---------1-----------------------#2021-08-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="7cc5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在我的前一篇博文中，我写了如何设置MongoDB以便在Next.js项目中建立到数据库的连接，以及如何从数据库中读取数据。所以，如果你错过了，可以先看看这篇文章！</p><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi km"><img src="../Images/b5648e1753b2e54c36cd9ee688119ec0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NXYT7cw3xVTqIvhuzpYymQ.png"/></div></div></figure><h1 id="fa5c" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">设置您的自定义API路线</h1><p id="4bc1" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">通常情况下，当通过<strong class="jp ir"> npx create-next-app </strong>命令新建一个Next.js项目时，会自动创建一个API目录。否则，您将不得不在您的<strong class="jp ir">页面目录</strong>中创建该目录。在<strong class="jp ir"> API目录</strong>中，创建一个JavaScript文件(您可以随意命名)。</p><p id="224c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下面的代码片段显示了设置自定义API路由的整个过程:</p><pre class="kn ko kp kq gt mb mc md me aw mf bi"><span id="bd4d" class="mg kz iq mc b gy mh mi l mj mk">import { MongoClient } from "mongodb";</span><span id="d89e" class="mg kz iq mc b gy ml mi l mj mk">export default async function handler(req, res) {</span><span id="665d" class="mg kz iq mc b gy ml mi l mj mk">  if (req.method === "POST") {<br/>  const data = req.body;</span><span id="d729" class="mg kz iq mc b gy ml mi l mj mk">  const client = await <br/>  MongoClient.connect(<br/>    "mongodb+srv://&lt;user&gt;&lt;password&gt;@cluster0.pqdli.mongodb.net/&lt;dbname&gt;retryWrites=true&amp;w=majority");</span><span id="6aab" class="mg kz iq mc b gy ml mi l mj mk">  const db = client.db();</span><span id="adbf" class="mg kz iq mc b gy ml mi l mj mk">  const yourCollection = db.collection("yourCollection");</span><span id="b119" class="mg kz iq mc b gy ml mi l mj mk">  const result = await yourCollection.insertOne(data);</span><span id="f09e" class="mg kz iq mc b gy ml mi l mj mk">  console.log(result);</span><span id="c683" class="mg kz iq mc b gy ml mi l mj mk">  client.close();</span><span id="ca54" class="mg kz iq mc b gy ml mi l mj mk">  res.status(201).json({ message: "Data inserted successfully!" });<br/>  }<br/>}</span></pre><p id="3a58" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">第一步，您需要通过<strong class="jp ir"> npm i mongodb </strong>安装所需的依赖项。完成后，使用以下命令导入MongoClient:</p><pre class="kn ko kp kq gt mb mc md me aw mf bi"><span id="71bd" class="mg kz iq mc b gy mh mi l mj mk">import { MongoClient } from "mongodb";</span></pre><p id="3bd5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">之后，我创建了一个名为<strong class="jp ir"> handler </strong>的异步函数，它有两个参数:1。请求又名请求和2。res又名响应。如果您曾经使用过node.js和express.js，您可能会认识到这些参数。</p><p id="aabc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">非常简单地解释一下:请求表示来自客户端的输入信息，而另一方面，响应包含将被发送回客户端的信息。</p><p id="4f5d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">作为函数内部的第一步，我们检查传入的请求是否来自于<strong class="jp ir"> POST </strong>类型。只有当检查结果为真时，代码才会继续执行。</p><pre class="kn ko kp kq gt mb mc md me aw mf bi"><span id="5155" class="mg kz iq mc b gy mh mi l mj mk">const data = req.body;</span></pre><p id="04aa" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们期望有数据附加到传入的请求。通过上面的简单代码，我们可以访问这些数据。</p><p id="2012" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您遵循了本<a class="ae kl" href="https://my-blog-alpha-navy.vercel.app/posts/nextjs-and-mongodb" rel="noopener ugc nofollow" target="_blank">教程</a>，您应该对以下步骤很熟悉。这里就不赘述了。只是不要忘记在那里插入你的证件。</p><pre class="kn ko kp kq gt mb mc md me aw mf bi"><span id="b46a" class="mg kz iq mc b gy mh mi l mj mk">const client = await <br/>  MongoClient.connect(<br/>    "mongodb+srv://&lt;user&gt;<br/>    :&lt;password&gt;<br/>    @cluster0.pqdli.<br/>    mongodb.net/&lt;dbname&gt;?<br/>    retryWrites=true&amp;w=majority"<br/>    );</span><span id="eedc" class="mg kz iq mc b gy ml mi l mj mk">  const db = client.db();</span><span id="8b9e" class="mg kz iq mc b gy ml mi l mj mk">  const yourCollection = db.collection("yourCollection");</span></pre><p id="0dd9" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下一步是<strong class="jp ir">从MongoDB数据库读取数据和向其写入数据之间最重要也是唯一的区别。</strong></p><pre class="kn ko kp kq gt mb mc md me aw mf bi"><span id="4fc5" class="mg kz iq mc b gy mh mi l mj mk">const result = await yourCollection.insertOne(data);</span></pre><p id="92ce" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">不是调用集合上的<strong class="jp ir"> find </strong>函数，而是调用<strong class="jp ir"> insert </strong>或<strong class="jp ir"> insertOne </strong>函数。正如函数名所暗示的，您将数据插入到您的集合中。您放在括号中的数据是您从传入请求中获得的数据。关于你的API路线，其实就是这样！</p><p id="f0eb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">当然，不要忘记关闭连接。</p><p id="223e" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">或者，您可以发回一个响应。在本例中，状态代码201和一条消息将被发回。</p><pre class="kn ko kp kq gt mb mc md me aw mf bi"><span id="4ccb" class="mg kz iq mc b gy mh mi l mj mk">res.status(201).json({ message: "Data inserted successfully!" });</span></pre><h1 id="bc51" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">在React组件中使用API</h1><p id="3b52" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">设置好API路径后，我们可以继续在React组件中使用这个API路径。</p><p id="5b6c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">例如，每当单击表单中的某个按钮时，就可以触发这个API路由。该表单中的数据将被发送到我们的数据库。我们将在下面的代码片段中演示这个场景:</p><pre class="kn ko kp kq gt mb mc md me aw mf bi"><span id="32c0" class="mg kz iq mc b gy mh mi l mj mk">async function clickHandler(enteredData) {const response = await <br/>  fetch("/api/your-api-route", {<br/>    method: "POST",<br/>    body: JSON.stringify(enteredData),<br/>    headers: <br/>    {<br/>      "Content-Type": <br/>      "application/json",<br/>    },<br/>  });</span><span id="f7a6" class="mg kz iq mc b gy ml mi l mj mk">  const data = await response.json();</span><span id="27aa" class="mg kz iq mc b gy ml mi l mj mk">  console.log(data);<br/> }</span></pre><p id="2294" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">通常，您可以在常规的React组件中插入这种函数，就在render或return函数的前面。一些React元素应该指向我们的<strong class="jp ir"> clickHandler </strong>函数。在下面的例子中，一个简单的按钮将在你每次按下时执行该功能。</p><pre class="kn ko kp kq gt mb mc md me aw mf bi"><span id="8ffe" class="mg kz iq mc b gy mh mi l mj mk">&lt;button onClick ={clickHandler}/&gt;</span></pre><p id="b2b0" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在某些时候，您还需要定义<strong class="jp ir">输入的数据</strong>，它被用作我们的<strong class="jp ir"> clickHandler </strong>函数中的一个参数。例如，您可以将一些用户输入绑定到这些数据。但这不是这篇博文的重点。</p><p id="470a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我们转而研究一下<strong class="jp ir"> clickHandler </strong>函数！</p><pre class="kn ko kp kq gt mb mc md me aw mf bi"><span id="580e" class="mg kz iq mc b gy mh mi l mj mk">const response = await fetch("/api/your-api-route",</span></pre><p id="d2db" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">因为我们的<strong class="jp ir"> clickHandler </strong>函数是异步的，所以我们可以在函数体中再次使用await关键字。在这篇文章中，我使用了fetch API，它是React自带的。这段代码也可以用于任何其他库，比如axios或任何你喜欢的库。</p><p id="f804" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">作为fetch函数的第一个参数，您需要传递route。这就是我们之前定义的路线。</p><p id="ae50" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><strong class="jp ir"> <em class="mm">注意</em> </strong> <em class="mm">:您</em> <strong class="jp ir"> <em class="mm">必须</em> </strong> <em class="mm">将“your-api-route”替换为api目录中您的javascript-file的名称！这是必不可少的！</em></p><pre class="kn ko kp kq gt mb mc md me aw mf bi"><span id="f6ca" class="mg kz iq mc b gy mh mi l mj mk">{<br/>  method: "POST",<br/>  body: JSON.stringify(enteredData),<br/>  headers: <br/>  {<br/>    "Content-Type": <br/>    "application/json",<br/>  },<br/>});</span></pre><p id="7984" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">作为第二个参数，您传递一些更多的信息，这些信息指定了我们用这个API调用发出的请求。我们使用POST方法，因为我们想要写入数据。此外，我们需要将数据作为参数传递给请求体。我们在服务器上的代码依赖于传递给主体的数据。我们还将数据转换成json格式，这样我们就可以轻松地在服务器上处理数据。在头中，我们最后定义了内容的类型(这与Next.js或MongoDB没有什么特别的关系)。</p><pre class="kn ko kp kq gt mb mc md me aw mf bi"><span id="1def" class="mg kz iq mc b gy mh mi l mj mk">const data = await response.json();</span><span id="63ea" class="mg kz iq mc b gy ml mi l mj mk">console.log(data);</span></pre><p id="52c7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在最后一步中，您可以存储并打印出响应，这在这里的特定情况下是完全可选的。如果您还记得，在这种情况下，这将是消息:“数据插入成功！”。这只是我们在API中定义的响应。</p><h1 id="c88a" class="ky kz iq bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">结论</h1><p id="626c" class="pw-post-body-paragraph jn jo iq jp b jq lw js jt ju lx jw jx jy ly ka kb kc lz ke kf kg ma ki kj kk ij bi translated">在这篇文章中，您了解了如何设置自己的自定义API，以及如何在常规的React组件中调用它。在构建完整的Next.js web应用程序时，这是一项非常有用和强大的技能。我希望你喜欢这篇文章，并有一个美好的一天！</p></div></div>    
</body>
</html>