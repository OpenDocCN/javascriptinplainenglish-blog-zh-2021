<html>
<head>
<title>What You Can Do to Standardize CRUD Calls to Mongo in Node.js</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何标准化Node.js中对Mongo的CRUD调用</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/what-you-can-do-to-standardize-the-crud-calls-to-mongo-in-nodejs-7b4c569488e6?source=collection_archive---------15-----------------------#2021-03-16">https://javascript.plainenglish.io/what-you-can-do-to-standardize-the-crud-calls-to-mongo-in-nodejs-7b4c569488e6?source=collection_archive---------15-----------------------#2021-03-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><h2 id="cf4f" class="io ip iq bd b dl ir is it iu iv iw dk ix translated" aria-label="kicker paragraph">关于从Node到Mongo的CRUD调用，有一些代码方面的标准化。这里是模式及其CRUD操作的简单展示，随后是建议的标准化方法以及最终的实现。如果您是node和mongo的新手，请尽可能多地使用它！</h2><div class=""/><div class=""><h2 id="3408" class="pw-subtitle-paragraph jw iz iq bd b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dk translated">你的准则，你的标准</h2></div><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/0c05bfb483b4703a80adaffd0833c657.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MvOU--Wo77R2GoodKwks4g.jpeg"/></div></div><figcaption class="la lb gj gh gi lc ld bd b be z dk">Image Credit: <a class="ae le" href="https://unsplash.com/@kellysikkema" rel="noopener ugc nofollow" target="_blank">Kelly Sikkema</a></figcaption></figure><h1 id="6059" class="lf lg iq bd lh li lj lk ll lm ln lo lp kf lq kg lr ki ls kj lt kl lu km lv lw bi translated">Node.js？</h1><p id="9bdf" class="pw-post-body-paragraph lx ly iq lz b ma mb ka mc md me kd mf mg mh mi mj mk ml mm mn mo mp mq mr ms ij bi translated">除了轻量级和开源的特性之外，Node.js由于其效率、可伸缩性和社区支持而越来越受欢迎。它的跨平台运行时环境非常适合多平台应用程序开发。</p><p id="3513" class="pw-post-body-paragraph lx ly iq lz b ma mt ka mc md mu kd mf mg mv mi mj mk mw mm mn mo mx mq mr ms ij bi translated">此外，利用非阻塞I/O模式有助于提高流媒体服务和实时应用的可靠性。一些科技巨头如网飞、LinkedIn、Trello和PayPal也对它的可靠性下了很大的赌注！</p><h1 id="03a0" class="lf lg iq bd lh li lj lk ll lm ln lo lp kf lq kg lr ki ls kj lt kl lu km lv lw bi translated">MongoDB？</h1><p id="319c" class="pw-post-body-paragraph lx ly iq lz b ma mb ka mc md me kd mf mg mh mi mj mk ml mm mn mo mp mq mr ms ij bi translated">MongoDB是一个文档数据库，其中的数据存储为文档的集合，而不是由外键关联的特定模式的表。凭借其高度的可伸缩性和灵活性，可以通过查询和索引功能轻松存储和访问各种类型的数据。</p><h1 id="b37f" class="lf lg iq bd lh li lj lk ll lm ln lo lp kf lq kg lr ki ls kj lt kl lu km lv lw bi translated">猫鼬</h1><p id="1530" class="pw-post-body-paragraph lx ly iq lz b ma mb ka mc md me kd mf mg mh mi mj mk ml mm mn mo mp mq mr ms ij bi translated">它是被设计用于异步运行时环境<a class="ae le" href="https://nodejs.org/en/" rel="noopener ugc nofollow" target="_blank"> node.js </a>的<a class="ae le" href="https://www.mongodb.org/" rel="noopener ugc nofollow" target="_blank"> MongoDB </a>对象建模工具。此外，它确实支持体面的承诺和回电行为。</p><pre class="kp kq kr ks gt my mz na nb aw nc bi"><span id="6130" class="nd lg iq mz b gy ne nf l ng nh">npm install mongoose --S</span></pre></div><div class="ab cl ni nj hu nk" role="separator"><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn"/></div><div class="ij ik il im in"><h2 id="b7bf" class="nd lg iq bd lh np nq dn ll nr ns dp lp mg nt nu lr mk nv nw lt mo nx ny lv iw bi translated">看一看我们的模型模式</h2><blockquote class="nz oa ob"><p id="6190" class="lx ly oc lz b ma mt ka mc md mu kd mf od mv mi mj oe mw mm mn of mx mq mr ms ij bi translated">请详细说明{versionKey : false}的设置。<br/>文档将不再被版本化，这里的<a class="ae le" href="https://stackoverflow.com/questions/12495891/what-is-the-v-field-in-mongoose/31872302#31872302" rel="noopener ugc nofollow" target="_blank">将告诉您结果。</a></p></blockquote><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="og oh l"/></div><figcaption class="la lb gj gh gi lc ld bd b be z dk">Currency Model Schema</figcaption></figure></div><div class="ab cl ni nj hu nk" role="separator"><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn"/></div><div class="ij ik il im in"><h1 id="593e" class="lf lg iq bd lh li oi lk ll lm oj lo lp kf ok kg lr ki ol kj lt kl om km lv lw bi translated">样本污垢</h1><pre class="kp kq kr ks gt my mz na nb aw nc bi"><span id="69a2" class="nd lg iq mz b gy ne nf l ng nh">const <strong class="mz ja">Currency</strong> = require("../models/Currency");</span></pre><h2 id="3990" class="nd lg iq bd lh np nq dn ll nr ns dp lp mg nt nu lr mk nv nw lt mo nx ny lv iw bi translated">创建:</h2><pre class="kp kq kr ks gt my mz na nb aw nc bi"><span id="470e" class="nd lg iq mz b gy ne nf l ng nh">var data = {name: "United State Dollar", code: "USD", rate: 1}<br/>await new <strong class="mz ja">Currency</strong>(data).save();</span></pre><h2 id="313b" class="nd lg iq bd lh np nq dn ll nr ns dp lp mg nt nu lr mk nv nw lt mo nx ny lv iw bi translated">阅读:</h2><pre class="kp kq kr ks gt my mz na nb aw nc bi"><span id="160c" class="nd lg iq mz b gy ne nf l ng nh">var code = "USD"<br/>var name = "United States Dollar"</span><span id="d47c" class="nd lg iq mz b gy on nf l ng nh">// Find One<br/>await <strong class="mz ja">Currency</strong>.findOne({ code })<br/>await <strong class="mz ja">Currency</strong>.findOne({ name, code });</span><span id="4e45" class="nd lg iq mz b gy on nf l ng nh">// Find All<br/>await <strong class="mz ja">Currency</strong>.find({})<br/>await <strong class="mz ja">Currency</strong>.find({}).<strong class="mz ja">sort</strong>({ createdAt: "desc" });</span></pre><h2 id="9556" class="nd lg iq bd lh np nq dn ll nr ns dp lp mg nt nu lr mk nv nw lt mo nx ny lv iw bi translated">更新:</h2><pre class="kp kq kr ks gt my mz na nb aw nc bi"><span id="3c69" class="nd lg iq mz b gy ne nf l ng nh">var options = { useFindAndModify: false, new: true };<br/>var query = { code: "USD" }<br/>var payload = { name: "United States Dollar" }</span><span id="cfb1" class="nd lg iq mz b gy on nf l ng nh">await <strong class="mz ja">Currency</strong>.findOneAndUpdate(<strong class="mz ja">query, payload, options</strong>);</span></pre><h2 id="a3f0" class="nd lg iq bd lh np nq dn ll nr ns dp lp mg nt nu lr mk nv nw lt mo nx ny lv iw bi translated">删除:</h2><pre class="kp kq kr ks gt my mz na nb aw nc bi"><span id="7dc9" class="nd lg iq mz b gy ne nf l ng nh">await <strong class="mz ja">Currency</strong>.deleteOne( { "code" : "USD" } );</span></pre></div><div class="ab cl ni nj hu nk" role="separator"><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn"/></div><div class="ij ik il im in"><h1 id="e0d8" class="lf lg iq bd lh li oi lk ll lm oj lo lp kf ok kg lr ki ol kj lt kl om km lv lw bi translated">下一步是什么？</h1><ul class=""><li id="a904" class="oo op iq lz b ma mb md me mg oq mk or mo os ms ot ou ov ow bi translated">同一个罩下的多种型号管理</li><li id="7005" class="oo op iq lz b ma ox md oy mg oz mk pa mo pb ms ot ou ov ow bi translated">MongoDB的错误处理</li><li id="d8e2" class="oo op iq lz b ma ox md oy mg oz mk pa mo pb ms ot ou ov ow bi translated">接下来，看看<a class="ae le" href="https://seanpang.medium.com/globalize-variables-in-nodejs-application-f782f52deffe" rel="noopener"> js变量全球化</a>。</li></ul><h2 id="408b" class="nd lg iq bd lh np nq dn ll nr ns dp lp mg nt nu lr mk nv nw lt mo nx ny lv iw bi translated">引擎盖下:多模型管理</h2><pre class="kp kq kr ks gt my mz na nb aw nc bi"><span id="fbc5" class="nd lg iq mz b gy ne nf l ng nh">// mongo_db_utils.js</span><span id="a27a" class="nd lg iq mz b gy on nf l ng nh">const moment = require("moment");<br/></span><span id="e69c" class="nd lg iq mz b gy on nf l ng nh">/* Models*/<br/>const User = require("../models/User");<br/>const Shop = require("../models/Shop");<br/>const Currency = require("../models/Currency");<br/>const Listing = require("../models/Listing");</span><span id="5653" class="nd lg iq mz b gy on nf l ng nh">const <strong class="mz ja">DbModel</strong> = {<br/>  User: User,<br/>  Shop: Shop,<br/>  Listing: Listing,<br/>  Currency: Currency<br/>};</span><span id="0aed" class="nd lg iq mz b gy on nf l ng nh">const mod_db = {<br/>  <strong class="mz ja">dbGetAll</strong>: async function(table, params) {<br/>    return params<br/>    ? await DbModel[table].find(params).sort({ createdAt: "desc" })<br/>    : await DbModel[table].find({}).sort({ createdAt: "desc" });<br/>  },<br/>  <strong class="mz ja">dbGet</strong>: async function(table, key) {<br/>    return await DbModel[table].findById(key);<br/>  },<br/>  <strong class="mz ja">dbGetOne</strong>: async function(table, params) {<br/>    return await DbModel[table].findOne(params);<br/>  },<br/>  <strong class="mz ja">dbCreate</strong>: async function(table, params) { <br/>    return await new DbModel[table](params).save();<br/>  },<br/>  <strong class="mz ja">dbUpdate</strong>: async function(params) {<br/>    const options = { useFindAndModify: false, new: true };<br/>    const { table, query, payload } = params;<br/>    return <br/>      await DbModel[table].findOneAndUpdate(query,payload,options);<br/>  }<br/>};</span><span id="9b0a" class="nd lg iq mz b gy on nf l ng nh"><strong class="mz ja">module.exports = mod_db;</strong></span></pre><blockquote class="nz oa ob"><p id="cae7" class="lx ly oc lz b ma mt ka mc md mu kd mf od mv mi mj oe mw mm mn of mx mq mr ms ij bi translated">示例用法:<br/> <strong class="lz ja"> dbGetOne </strong>从我们的<strong class="lz ja"> mod_db模块</strong>导入，如上图<strong class="lz ja"> </strong>所示，分别输入<strong class="lz ja">型号名称</strong>和<strong class="lz ja">有效载荷</strong>。</p></blockquote><pre class="kp kq kr ks gt my mz na nb aw nc bi"><span id="4d6b" class="nd lg iq mz b gy ne nf l ng nh">const db = require("./helper/mongo_db_utils");</span><span id="a012" class="nd lg iq mz b gy on nf l ng nh">...</span><span id="f506" class="nd lg iq mz b gy on nf l ng nh">...</span><span id="051d" class="nd lg iq mz b gy on nf l ng nh"><strong class="mz ja">await</strong> db.<strong class="mz ja">dbGetOne</strong>("Currency", { code });</span><span id="2af4" class="nd lg iq mz b gy on nf l ng nh"><strong class="mz ja">await</strong> db.<strong class="mz ja">dbGetOne</strong>("User", { name });<br/><strong class="mz ja">await</strong> db.<strong class="mz ja">dbGetOne</strong>("Listing", { id });</span></pre><h2 id="f542" class="nd lg iq bd lh np nq dn ll nr ns dp lp mg nt nu lr mk nv nw lt mo nx ny lv iw bi translated">MongoDB创建和更新的错误处理</h2><pre class="kp kq kr ks gt my mz na nb aw nc bi"><span id="7d17" class="nd lg iq mz b gy ne nf l ng nh">const <strong class="mz ja">errorHandler</strong> = (mongoError) =&gt; {<br/>  let computedErrors = [];<br/>  if (!is_empty(mongoError["reason"])) {<br/>    const { <strong class="mz ja">kind, value, path</strong> } = mongoError;<br/>    computedErrors.push(<strong class="mz ja">`Field: ${path}, expected *${kind}*; receive'${value}'`</strong>);<br/>  }</span><span id="7e2c" class="nd lg iq mz b gy on nf l ng nh">if (!is_empty(mongoError["errors"])) {<br/>   for (var field in mongoError["errors"]) {<br/>     const { <strong class="mz ja">message, kind, path, value</strong> } = mongoError["errors"][field];<br/>    computedErrors.push(<strong class="mz ja">`${message} (Field: ${path}, expected *${kind}*; receive '${value})'`</strong>);<br/>    }<br/>  }<br/>  return <strong class="mz ja">computedErrors.join(", ")<br/></strong>}</span><span id="4379" class="nd lg iq mz b gy on nf l ng nh">...<br/>...</span><span id="ecfb" class="nd lg iq mz b gy on nf l ng nh"><br/>const <strong class="mz ja">mod_db</strong> = {<br/>  <strong class="mz ja">...<br/>  ...</strong></span><span id="51d6" class="nd lg iq mz b gy on nf l ng nh"><strong class="mz ja">  dbCreate</strong>: async function(table, params) {<br/>    let err = await new DbModel[table](params)<br/>        .validate()<br/>        .catch(errors =&gt; errors);<br/>    if (err) {<br/>      result["error"] = <strong class="mz ja">errorHandler</strong>(err);<br/>    } else {<br/>      result["data"] = <strong class="mz ja">await new DbModel[table](params).save();<br/></strong>    }</span><span id="a647" class="nd lg iq mz b gy on nf l ng nh">    return <strong class="mz ja">result</strong>;<br/>  },<br/>  ...<br/>  ...</span><span id="6945" class="nd lg iq mz b gy on nf l ng nh">};</span><span id="5479" class="nd lg iq mz b gy on nf l ng nh"><strong class="mz ja">module.exports = mod_db;</strong></span></pre></div><div class="ab cl ni nj hu nk" role="separator"><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn"/></div><div class="ij ik il im in"><h2 id="c6d9" class="nd lg iq bd lh np nq dn ll nr ns dp lp mg nt nu lr mk nv nw lt mo nx ny lv iw bi translated">完整的模块内容如下所示:</h2><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="og oh l"/></div><figcaption class="la lb gj gh gi lc ld bd b be z dk">mongo_db_utils.js</figcaption></figure><h1 id="c37b" class="lf lg iq bd lh li lj lk ll lm ln lo lp kf lq kg lr ki ls kj lt kl lu km lv lw bi translated">JavaScript变量全球化</h1><p id="816c" class="pw-post-body-paragraph lx ly iq lz b ma mb ka mc md me kd mf mg mh mi mj mk ml mm mn mo mp mq mr ms ij bi translated">轻量级JS模块非常适合作为项目中的助手。然而，当在项目中跨区域需要该模块时，可能会出现代码冗余，并且我们确实在每次需要时手动导入它们。</p><p id="efd5" class="pw-post-body-paragraph lx ly iq lz b ma mt ka mc md mu kd mf mg mv mi mj mk mw mm mn mo mx mq mr ms ij bi translated">接下来的标准化是，使函数<strong class="lz ja"> dbGetAll </strong>、<strong class="lz ja"> dbGetOne </strong>、<strong class="lz ja"> dbCreate、</strong>和<strong class="lz ja"> dbUpdate </strong>全局可达。</p><p id="1501" class="pw-post-body-paragraph lx ly iq lz b ma mt ka mc md mu kd mf mg mv mi mj mk mw mm mn mo mx mq mr ms ij bi translated">对于那些错过了这一点的人，您可以找到<a class="ae le" href="https://seanpang.medium.com/globalize-variables-in-nodejs-application-f782f52deffe" rel="noopener"> <strong class="lz ja">相关文章</strong> </a> <strong class="lz ja"> </strong>来解释Node.js中全球化变量的实现。</p></div><div class="ab cl ni nj hu nk" role="separator"><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn"/></div><div class="ij ik il im in"><h1 id="e1d1" class="lf lg iq bd lh li oi lk ll lm oj lo lp kf ok kg lr ki ol kj lt kl om km lv lw bi translated">结论</h1><p id="e760" class="pw-post-body-paragraph lx ly iq lz b ma mb ka mc md me kd mf mg mh mi mj mk ml mm mn mo mp mq mr ms ij bi translated">代码的标准化在不同的开发人员之间会有所不同。然而，我们都在寻求代码的可维护性和可伸缩性。因此，来自上面的分享发生了！<em class="oc">如果这对你有一点帮助，一定要在评论里让我知道！</em></p></div></div>    
</body>
</html>