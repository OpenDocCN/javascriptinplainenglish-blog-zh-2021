<html>
<head>
<title>Building Your First WebAssembly Component With Next.js</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Next.js构建您的第一个WebAssembly组件</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/next-js-webassembly-77df3537690?source=collection_archive---------2-----------------------#2021-05-29">https://javascript.plainenglish.io/next-js-webassembly-77df3537690?source=collection_archive---------2-----------------------#2021-05-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="f5f4" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">而不必首先设置编译器</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/32e4abd9d571c827c13b852087db565c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Q545U5YaNc9yIXH4pAiyGg.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Source: the author</figcaption></figure><p id="aa9a" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">WebAssembly就在这里——它已经准备好包含在React和Vue等主要框架中。</p><p id="dff2" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">Next.js是React的SSR框架，它提供了一种不需要大量基础知识和先验知识的非常简单的入门方法。</p><p id="11c0" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">以下是如何构建您的第一个基于WebAssembly的组件。好的一面是:你只需要一点Next.js的先验知识，而不需要安装WASM编译器——我们尽可能让它简单。</p><p id="753f" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">玩得开心！</p><h1 id="494d" class="lr ls iq bd lt lu lv lw lx ly lz ma mb jw mc jx md jz me ka mf kc mg kd mh mi bi translated">编译到WASM</h1><p id="2b81" class="pw-post-body-paragraph kv kw iq kx b ky mj jr la lb mk ju ld le ml lg lh li mm lk ll lm mn lo lp lq ij bi translated">我花了一段时间才明白，默认情况下，Emscripten无法与Next.js使用的Webpack一起正常工作。</p><p id="96d3" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">所以你不用安装任何编译器，我们只是简单的使用一个在线的IDE进行web组装——<a class="ae mo" href="https://webassembly.studio/" rel="noopener ugc nofollow" target="_blank">Web Assembly Studio</a>。</p><p id="0428" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">只需打开页面，选择您想要有一个“空C”项目。</p><p id="8586" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">然后，您应该会看到下面的界面(只是使用了不同的C代码):</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mp"><img src="../Images/4b446a581f4292bf28cdd0bf54c54d0d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_350q_8BM2PKxg-3_J5bQg.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Source: the author</figcaption></figure><p id="2c41" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在这里，我们写下了我们想要的最终可用的web汇编代码——编译后的格式叫做WASM。</p><p id="7084" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">作为一个代码示例，我们使用C中的一个简单函数将两个数相加，并最终将它们作为整数返回:</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="fbd0" class="mv ls iq mr b gy mw mx l my mz"><em class="na">#define</em> WASM_EXPORT __attribute__((visibility(“default”)))</span><span id="b301" class="mv ls iq mr b gy nb mx l my mz">WASM_EXPORT<br/>int add(int a, int b) {<br/>  <em class="na">return</em> a + b;<br/>}</span></pre><p id="1602" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">输入代码后，你可以点击顶部的“构建和运行”，然后点击“下载”</p><p id="19d3" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">您将获得一个zip文件，其中包含一个名为“out”的文件夹。这个文件夹里是我们从现在开始需要的“main.wasm”。将该文件复制到我们将创建Next.js项目的文件夹中。</p><h1 id="36a1" class="lr ls iq bd lt lu lv lw lx ly lz ma mb jw mc jx md jz me ka mf kc mg kd mh mi bi translated">创建Next.js项目</h1><p id="6025" class="pw-post-body-paragraph kv kw iq kx b ky mj jr la lb mk ju ld le ml lg lh li mm lk ll lm mn lo lp lq ij bi translated">如果你很懒，你可以从我的<a class="ae mo" href="https://github.com/LouisPetrik/next.js-webassembly" rel="noopener ugc nofollow" target="_blank"> Github repo </a>中克隆所有代码——否则，这里有一步一步的指南。</p><p id="4c34" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">设置Next.js:</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="c79d" class="mv ls iq mr b gy mw mx l my mz">yarn init -y </span><span id="1388" class="mv ls iq mr b gy nb mx l my mz">yarn add react react-dom next </span></pre><p id="f0ab" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在package.json的脚本部分，我们需要:</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="7136" class="mv ls iq mr b gy mw mx l my mz">“scripts”: {<br/>  “build”: “next build”,<br/>  “start”: “next start”,<br/>  “dev”: “next dev”<br/>}</span></pre><p id="cfb5" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">next.config.js我们需要正确处理Web组装:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="cbe4" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">确保将main.wasm直接复制到项目的根目录中。</p><p id="d8b4" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">然后我们可以创建pages-directory，默认情况下Next.js会在这个目录中查找要呈现的页面。这是有趣的事情发生的地方。这是我们应用程序主页的代码，index.js在/pages目录中。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="9759" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">首先，我们从Next.js标准库导入“动态”。它允许我们动态地包含组件。它的工作方式类似于纯React中的延迟加载，这意味着WasmComponent内部的整个逻辑只有在React注意到DOM中确实需要该组件时才会执行。</p><p id="cd22" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果你有条件地渲染组件，你会明白我的意思:即使是实际的WASM文件也只是在需要的时候才被浏览器加载。</p><p id="cd93" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">令人兴奋的是，WebAssembly代码也尽可能多地包含在Next.js的服务器端渲染中，在代码示例中，WASM代码是在服务器端执行的。当我们查看来自服务器的原始响应，即浏览器中页面的代码时，我们可以最好地看到这一点:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ne"><img src="../Images/89ac86fa7a5d648d54eb16974edd625a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ns4Z2s9cIzlNPbLHYvCPVg.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Source: the author</figcaption></figure><p id="3221" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">正如你所看到的，我们的“6”已经被渲染了，尽管它实际上是一个懒惰的组件。Next意识到在DOM中直接需要它，所以在这种情况下，WASM的执行也直接发生在服务器上。</p><p id="21e7" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">下面是代码，展示了相反的情况——由于延迟加载，WASM只在浏览器中执行，而不是在服务器上执行:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="ea5a" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">为了实现这一点，我有条件地呈现WasmComponent只要按钮被按下，它就应该呈现并显示出来。WASM代码也由浏览器加载，可以在网络选项卡中看到。因此，在这种情况下，没有WASM的服务器端渲染。</p><p id="2bd7" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">Next.js自动为我们结合了所有世界的精华。很酷吧？</p><p id="ea09" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><a class="ae mo" href="https://github.com/LouisPetrik/next.js-webassembly" rel="noopener ugc nofollow" target="_blank">你可以在这里找到完整的Github库。</a></p><p id="4395" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">感谢您的阅读！<br/> <a class="ae mo" href="http://eepurl.com/hacY0v" rel="noopener ugc nofollow" target="_blank"> <strong class="kx ir">想了解最新动态可以加入我的简讯。</strong> </a></p><p id="e5e0" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果您想了解有关WebAssembly的更多信息，请访问:</p><div class="nf ng gp gr nh ni"><a rel="noopener  ugc nofollow" target="_blank" href="/assemblyscript-4c68a3c3ecf7"><div class="nj ab fo"><div class="nk ab nl cl cj nm"><h2 class="bd ir gy z fp nn fr fs no fu fw ip bi translated">Testosterones上的TypeScript什么是AssemblyScript？</h2><div class="np l"><h3 class="bd b gy z fp nn fr fs no fu fw dk translated">轻松开始使用WebAssembly</h3></div><div class="nq l"><p class="bd b dl z fp nn fr fs no fu fw dk translated">javascript.plainenglish.io</p></div></div><div class="nr l"><div class="ns l nt nu nv nr nw kp ni"/></div></div></a></div><div class="nf ng gp gr nh ni"><a rel="noopener  ugc nofollow" target="_blank" href="/webassembly-javascript-b3eefb1f0228"><div class="nj ab fo"><div class="nk ab nl cl cj nm"><h2 class="bd ir gy z fp nn fr fs no fu fw ip bi translated">WebAssembly在Web上会有什么变化？</h2><div class="np l"><h3 class="bd b gy z fp nn fr fs no fu fw dk translated">机会、用例&amp;这对我们热爱的JavaScript意味着什么</h3></div><div class="nq l"><p class="bd b dl z fp nn fr fs no fu fw dk translated">javascript.plainenglish.io</p></div></div><div class="nr l"><div class="nx l nt nu nv nr nw kp ni"/></div></div></a></div><div class="nf ng gp gr nh ni"><a rel="noopener  ugc nofollow" target="_blank" href="/made-with-webassembly-e2115fe7d97c"><div class="nj ab fo"><div class="nk ab nl cl cj nm"><h2 class="bd ir gy z fp nn fr fs no fu fw ip bi translated">已经采用WebAssembly的3个大项目</h2><div class="np l"><h3 class="bd b gy z fp nn fr fs no fu fw dk translated">它可以用来打破JavaScript的限制</h3></div><div class="nq l"><p class="bd b dl z fp nn fr fs no fu fw dk translated">javascript.plainenglish.io</p></div></div><div class="nr l"><div class="ny l nt nu nv nr nw kp ni"/></div></div></a></div><p id="4e0a" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><em class="na">更多内容请看</em><a class="ae mo" href="http://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><em class="na">plain English . io</em></a></p></div></div>    
</body>
</html>