<html>
<head>
<title>Jest: How to Update Snapshot Tests</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Jest:如何更新快照测试</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/jest-updating-snapshot-tests-ef6c731cb68b?source=collection_archive---------3-----------------------#2021-10-06">https://javascript.plainenglish.io/jest-updating-snapshot-tests-ef6c731cb68b?source=collection_archive---------3-----------------------#2021-10-06</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/149dbbbe0a918ba82477d0a976dfd202.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*l62vIU00UuWmBntH"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Photo by <a class="ae jz" href="https://unsplash.com/@nublson?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Nubelson Fernandes</a> on <a class="ae jz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="8a47" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">快照测试是测试UI的一个很好的方法，不需要手动检查每个元素是否可见，样式是否正确，位置是否正确。每个快照测试都有一个快照、JSON、JS或HTML文件，它们通常位于这个目录<code class="fe ky kz la lb b">/__snapshots__</code>中。这些快照在您选择的时间序列化UI，并将其保存到这个目录中，以供将来比较使用。每次快照测试运行时，都会生成一个新的快照，并与<code class="fe ky kz la lb b">__snapshots__</code>中保存的快照进行比较。这就是快照测试检测用户界面变化的方式，但是如果您想要改变呢？您将如何更新保存的快照以反映预期的更改？</p><p id="ae63" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这是我用来确保快照测试根据预期的变更进行更新的工作流程:</p><ul class=""><li id="16d5" class="lc ld in kc b kd ke kh ki kl le kp lf kt lg kx lh li lj lk bi translated">*运行快照测试，确保它通过—如果没有通过，找到问题并修复它，在测试通过之前不要更改UI。</li><li id="e8ba" class="lc ld in kc b kd ll kh lm kl ln kp lo kt lp kx lh li lj lk bi translated">更改用户界面。</li><li id="c1d3" class="lc ld in kc b kd ll kh lm kl ln kp lo kt lp kx lh li lj lk bi translated">重新运行快照测试，它应该会失败，并且在失败时，它应该会检测到您所做的UI更改——如果它因为其他原因而失败，那么您可能在代码中引入了一个需要修复的bug。</li><li id="0e0c" class="lc ld in kc b kd ll kh lm kl ln kp lo kt lp kx lh li lj lk bi translated">更新快照文件。</li><li id="7c5c" class="lc ld in kc b kd ll kh lm kl ln kp lo kt lp kx lh li lj lk bi translated">重新运行快照测试；它应该通过，如果失败，您可能更新了错误的快照文件。</li><li id="a4e4" class="lc ld in kc b kd ll kh lm kl ln kp lo kt lp kx lh li lj lk bi translated">提交对UI和快照文件的更改。</li></ul><p id="f3d9" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">*这破坏了测试驱动的开发，因为我们不能提前编写测试。快照测试并不意味着驱动开发；因此TDD不适用于他们。此外，预测快照的外观并手动编辑快照也是浪费时间。</p><h1 id="a462" class="lq lr in bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">运行快照测试</h1><p id="c552" class="pw-post-body-paragraph ka kb in kc b kd mo kf kg kh mp kj kk kl mq kn ko kp mr kr ks kt ms kv kw kx ig bi translated">我使用<code class="fe ky kz la lb b">yarn</code>，但是您也可以使用<code class="fe ky kz la lb b">npm</code>来运行快照测试:</p><pre class="mt mu mv mw gt mx lb my mz aw na bi"><span id="6f78" class="nb lr in lb b gy nc nd l ne nf">yarn jest tests/snapshot_tests</span></pre><p id="5003" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我使用的是Vue，所以测试命令使用Vue CLI，它确保重要的Vue环境变量被加载并在NodeJS中工作。Vue CLI <a class="ae jz" href="https://cli.vuejs.org/core-plugins/unit-jest.html#debugging-tests" rel="noopener ugc nofollow" target="_blank">最终</a>会调用<code class="fe ky kz la lb b">jest</code>:</p><pre class="mt mu mv mw gt mx lb my mz aw na bi"><span id="4e55" class="nb lr in lb b gy nc nd l ne nf">yarn vue-cli-service test:unit tests/snapshot_tests</span></pre><p id="3a51" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">输出应该是:</p><figure class="mt mu mv mw gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi ng"><img src="../Images/c2c641c47b2cba34a920f5e7cfa7da1f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*i12wXYyklT9NKzyLCvJtZA.png"/></div></div></figure><h1 id="d879" class="lq lr in bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">更改用户界面</h1><p id="4a29" class="pw-post-body-paragraph ka kb in kc b kd mo kf kg kh mp kj kk kl mq kn ko kp mr kr ks kt ms kv kw kx ig bi translated">我在标签的措辞上做了一点小小的改动。</p><p id="f6c7" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">之前:</p><pre class="mt mu mv mw gt mx lb my mz aw na bi"><span id="e8f5" class="nb lr in lb b gy nc nd l ne nf">&lt;label for="invoiceNumber"&gt;Select {{ reference_label }}&lt;/label&gt;</span></pre><p id="7224" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">之后:</p><pre class="mt mu mv mw gt mx lb my mz aw na bi"><span id="827f" class="nb lr in lb b gy nc nd l ne nf">&lt;label for="invoiceNumber"&gt;{{ reference_label }}&lt;/label&gt;</span></pre><h1 id="8099" class="lq lr in bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">重新运行快照测试—确认更改失败</h1><p id="3c5b" class="pw-post-body-paragraph ka kb in kc b kd mo kf kg kh mp kj kk kl mq kn ko kp mr kr ks kt ms kv kw kx ig bi translated">标签从<code class="fe ky kz la lb b">Select {{ reference_label }}</code>更改为<code class="fe ky kz la lb b">{{ reference_label }}</code>。我希望快照测试能够捕捉到这种变化，所以重新运行测试，您应该会得到:</p><figure class="mt mu mv mw gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nh"><img src="../Images/a572f0962e4dcdb05fc3daeb062b33d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Pcu2yVB48eoOuNWFCLIvyg.png"/></div></div></figure><p id="ae6e" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这里需要注意两件事:</p><ul class=""><li id="65fd" class="lc ld in kc b kd ke kh ki kl le kp lf kt lg kx lh li lj lk bi translated">快照名称<code class="fe ky kz la lb b">Transaction Form renders correctly 1</code>取自测试套件名称<code class="fe ky kz la lb b">Transaction From</code>加上测试用例名称<code class="fe ky kz la lb b">renders correctly</code>，Jest附加了一个<code class="fe ky kz la lb b">1</code>——我猜是为了避免重复？</li><li id="a426" class="lc ld in kc b kd ll kh lm kl ln kp lo kt lp kx lh li lj lk bi translated">快照指出了在呈现的HTML 中失败发生的地方<strong class="kc io">，而不是在Vue代码中。您需要转到故障输出下面提供的行号(屏幕截图底部以蓝色突出显示的链接)来查找错误的原因。尽管如此，这是一个很好的方法来查看UI的变化，并确定这种变化是错误还是有意的。</strong></li></ul><h1 id="43e1" class="lq lr in bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">更新快照文件</h1><p id="9759" class="pw-post-body-paragraph ka kb in kc b kd mo kf kg kh mp kj kk kl mq kn ko kp mr kr ks kt ms kv kw kx ig bi translated">这将使用您所做的UI更改用新快照覆盖现有快照。</p><p id="3ca5" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">使用笑话:</p><pre class="mt mu mv mw gt mx lb my mz aw na bi"><span id="d58c" class="nb lr in lb b gy nc nd l ne nf">yarn jest tests/snapshot_tests/TransactionForm.spec.js -u</span></pre><p id="9cb2" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">使用Vue CLI:</p><pre class="mt mu mv mw gt mx lb my mz aw na bi"><span id="0cdc" class="nb lr in lb b gy nc nd l ne nf">yarn run vue-cli-service test:unit 'tests/snapshot_tests/TransactionForm.spec.js' -u</span></pre><p id="aa2a" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><code class="fe ky kz la lb b">-u</code>是<code class="fe ky kz la lb b">--updateSnapshot</code>的简称。</p><figure class="mt mu mv mw gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi ni"><img src="../Images/97d26d4eb8b29312c9d4a7d017fab024.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gTvinuslzPTmhknTIFEz3Q.png"/></div></div></figure><h1 id="15a7" class="lq lr in bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">重新运行快照测试—应该会通过</h1><p id="1336" class="pw-post-body-paragraph ka kb in kc b kd mo kf kg kh mp kj kk kl mq kn ko kp mr kr ks kt ms kv kw kx ig bi translated">使用笑话:</p><pre class="mt mu mv mw gt mx lb my mz aw na bi"><span id="06ad" class="nb lr in lb b gy nc nd l ne nf">yarn jest tests/snapshot_tests/TransactionForm.spec.js</span></pre><p id="e578" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">使用Vue CLI:</p><pre class="mt mu mv mw gt mx lb my mz aw na bi"><span id="91dc" class="nb lr in lb b gy nc nd l ne nf">yarn run vue-cli-service test:unit 'tests/snapshot_tests/TransactionForm.spec.js'</span></pre><figure class="mt mu mv mw gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nj"><img src="../Images/a32872866299e88c426003602170dfa8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Z2_jvGGjgIQrC-CidqI27Q.png"/></div></div></figure><h1 id="888b" class="lq lr in bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">提交更改</h1><p id="4d8a" class="pw-post-body-paragraph ka kb in kc b kd mo kf kg kh mp kj kk kl mq kn ko kp mr kr ks kt ms kv kw kx ig bi translated">既然UI已经更新了，快照也更新了，测试也通过了，那么您需要提交所有的更改:</p><ul class=""><li id="6fcf" class="lc ld in kc b kd ke kh ki kl le kp lf kt lg kx lh li lj lk bi translated">当然，用户界面会发生变化。</li><li id="36b9" class="lc ld in kc b kd ll kh lm kl ln kp lo kt lp kx lh li lj lk bi translated">更新的快照文件。</li></ul><p id="110d" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">只有当您存储快照并与您的队友共享时，快照测试才有效。因此，您需要提交快照。也就是说，它们是大文件，可能会扰乱您的拉取请求。我通常会跳过整个快照。相反，我依赖于UI更改的截图，并在快照中找到UI更改。</p><h1 id="bef3" class="lq lr in bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">过时的快照</h1><p id="cde7" class="pw-post-body-paragraph ka kb in kc b kd mo kf kg kh mp kj kk kl mq kn ko kp mr kr ks kt ms kv kw kx ig bi translated">运行快照测试时，有时您会遇到过时的快照:</p><figure class="mt mu mv mw gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nk"><img src="../Images/34ab0d5a98f60bb05dc36a4ea8176d36.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4eZS0Hw3sQV9iYqgCrSnMQ.png"/></div></div></figure><p id="2378" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这意味着在你的某个地方，tests you <a class="ae jz" href="https://stackoverflow.com/questions/57793527/what-are-obsolete-snapshots-and-snapshot-files" rel="noopener ugc nofollow" target="_blank">重命名为</a>一个测试套件或用例，Jest不能将快照测试映射到快照文件，因为名称不匹配。记住快照文件是由测试套件名称加上测试用例名称来识别的。</p><p id="2841" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">通过更新快照文件来解决此问题。这将用具有正确名称的新快照覆盖旧快照。每当您更改测试的套件或案例名称时，您都需要这样做。</p><figure class="mt mu mv mw gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nl"><img src="../Images/7e7689001fcdab0cfd0f251814c991ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dwZsNKz7qMlBVLiDaPPJ0g.png"/></div></div></figure><h1 id="e560" class="lq lr in bd ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn bi translated">来源</h1><ul class=""><li id="a7c0" class="lc ld in kc b kd mo kh mp kl nm kp nn kt no kx lh li lj lk bi translated"><a class="ae jz" href="https://jestjs.io/docs/snapshot-testing" rel="noopener ugc nofollow" target="_blank"> Jest </a>中的快照测试概述</li><li id="bf46" class="lc ld in kc b kd ll kh lm kl ln kp lo kt lp kx lh li lj lk bi translated">Vue CLI单元测试<a class="ae jz" href="https://cli.vuejs.org/core-plugins/unit-jest.html#debugging-tests" rel="noopener ugc nofollow" target="_blank">文档</a></li><li id="3dbf" class="lc ld in kc b kd ll kh lm kl ln kp lo kt lp kx lh li lj lk bi translated">过时快照<a class="ae jz" href="https://stackoverflow.com/questions/57793527/what-are-obsolete-snapshots-and-snapshot-files" rel="noopener ugc nofollow" target="_blank">测试</a></li></ul><p id="a620" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><em class="np">更多内容请看</em><a class="ae jz" href="http://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><strong class="kc io"><em class="np">plain English . io</em></strong></a></p></div></div>    
</body>
</html>