<html>
<head>
<title>Rewriting Deno’s Testing Tools</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">重写Deno的测试工具</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/rewriting-denos-testing-tools-b5f8801bc567?source=collection_archive---------10-----------------------#2021-05-10">https://javascript.plainenglish.io/rewriting-denos-testing-tools-b5f8801bc567?source=collection_archive---------10-----------------------#2021-05-10</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/a0c503d685c39adbc3f43889fc243b74.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*4BEXApj978NXyIHE"/></div></div></figure><p id="f640" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">对于过去的一个月和一些变化，实际上可能已经两个月了(写一个概念证明需要一天，实现它需要几周)。我一直在忙着重新思考Deno的测试工具。</p><p id="ed8e" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在我参与之前，我们已经有了一个试跑者，它运行得很好。但这是你能做的最简单的了，所以我全部重写了。</p><h1 id="04d2" class="kt ku in bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">新的平行赛跑运动员</h1><p id="72b1" class="pw-post-body-paragraph jv jw in jx b jy lr ka kb kc ls ke kf kg lt ki kj kk lu km kn ko lv kq kr ks ig bi translated">我们的测试运行程序是用JavaScript编写的，它可以工作，但速度很慢，因为它是一个串行测试运行程序，只是将所有测试合并到一个上下文中，然后一个接一个地运行它们。</p><p id="642d" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">也就是说，如果一个测试设置了60秒的超时，或者更现实地说，等待服务器响应，那么在测试完成之前什么都不会发生。</p><p id="2baf" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">为了解决这个问题，我在Rust中重新编写了测试运行程序，这样我就可以明确地控制线程模型。</p><p id="0687" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">每个测试模块现在都在自己的线程上运行，有自己的调度程序和运行时。</p><p id="039b" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">然而，整个模块图的编译和类型检查是提前完成的，这使得它仍然很快。</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="2456" class="mf ku in mb b gy mg mh l mi mj"><strong class="mb io">deno</strong> <strong class="mb io">test </strong>--jobs=4</span></pre><p id="fac4" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">对于整个测试套件，我们的std测试套件的测试时间减少了一半，从大约1分钟减少到30秒。</p><p id="324a" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><a class="ae mk" href="https://github.com/denoland/deno/pull/9815" rel="noopener ugc nofollow" target="_blank">这已经登陆</a>并将在Deno版本1.10中发布。</p><h1 id="856b" class="kt ku in bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">每个测试用例权限</h1><p id="a1d6" class="pw-post-body-paragraph jv jw in jx b jy lr ka kb kc ls ke kf kg lt ki kj kk lu km kn ko lv kq kr ks ig bi translated">在内部，我们实际上并没有使用<code class="fe ml mm mn mb b">deno test</code>进行我们自己的单元测试。到目前为止，我用每个测试用例的权限扩展了测试运行程序，让我们吃狗粮，并完全放弃了特别的测试运行程序。</p><p id="0731" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">因此，您的单元测试现在可以用它们所需的权限来定义，并且它们将被相应地请求/撤销。</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="98d5" class="mf ku in mb b gy mg mh l mi mj">Deno.test({<br/>  name: "write",<br/>  permissions: {<br/>    write: true,<br/>  },<br/>  async fn() {<br/>    // ...<br/>  },<br/>});</span></pre><p id="1fb6" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">但是请注意，如果您在没有权限的情况下运行<code class="fe ml mm mn mb b">deno test</code>,任何获取比您开始时更多权限的请求都将被拒绝。</p><p id="993d" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><a class="ae mk" href="https://github.com/denoland/deno/pull/10188" rel="noopener ugc nofollow" target="_blank">这已经登陆</a>并将在Deno版本1.10中发布。</p><h1 id="98e7" class="kt ku in bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">提高漂亮的输出</h1><p id="9a49" class="pw-post-body-paragraph jv jw in jx b jy lr ka kb kc ls ke kf kg lt ki kj kk lu km kn ko lv kq kr ks ig bi translated">这仍然是一项正在进行的工作，但输出格式得到了一些人的喜爱。首先，在重写Rust中的reporter时，我添加了测试的起源。</p><p id="94da" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">之前:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="9918" class="mf ku in mb b gy mg mh l mi mj">running 2 tests </span></pre><p id="f5f8" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">之后:</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="945a" class="mf ku in mb b gy mg mh l mi mj">running 2 tests from file:///home/caspervonb/test.ts</span></pre><p id="c91e" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这是一件小事，但很多事情必须到位，因为我们无法在JavaScript中做到这一点而不违反一些沙盒规则，所以这个微小的变化已经等待了几个月。</p><p id="2804" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这已经登陆，并将在Deno版本1.10中发布。</p><h1 id="89f4" class="kt ku in bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">可测试的文档代码块</h1><p id="0a4d" class="pw-post-body-paragraph jv jw in jx b jy lr ka kb kc ls ke kf kg lt ki kj kk lu km kn ko lv kq kr ks ig bi translated">我觉得这是高光比较酷的特点。至少我发现它对我们的代码库有用。事实证明，我们的很多例子都有一个偷偷摸摸的打字错误，因此虽然实际例子本身是正确的，但还是被破坏了。</p><p id="4e50" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">那么，如果您的代码示例可以进行类型检查并运行呢？嗯，有了德诺可以。</p><p id="cccf" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我已经实现了这一点，但我不认为我会在1.10中发布它，因为我想在让它在野外出现之前对它进行更多的润色。</p><figure class="lw lx ly lz gt jo"><div class="bz fp l di"><div class="mo mp l"/></div></figure><p id="5bcf" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我也对客户端代码做了一些改动，但我主要是在Deno上工作，所以我们会看到会发生什么。</p><h2 id="3341" class="mf ku in bd kv mq mr dn kz ms mt dp ld kg mu mv lh kk mw mx ll ko my mz lp na bi translated">结论</h2><p id="c7b6" class="pw-post-body-paragraph jv jw in jx b jy lr ka kb kc ls ke kf kg lt ki kj kk lu km kn ko lv kq kr ks ig bi translated">我得回去写代码了，所以这是Deno 1.10的小功能预览的结束。</p><p id="80ec" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">想帮我实现GitHub赞助商的下一个目标吗？这里有一个链接。</p><figure class="lw lx ly lz gt jo gh gi paragraph-image"><a href="https://github.com/sponsors/caspervonb"><div class="gh gi nb"><img src="../Images/74b8888ae16515de0872267fa2e732fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nXXaH0LWDTyvE-xpjzkQBw.png"/></div></a></figure><p id="6e97" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><em class="nc">更多内容尽在</em><a class="ae mk" href="http://plainenglish.io" rel="noopener ugc nofollow" target="_blank"><strong class="jx io"><em class="nc">plain English . io</em></strong></a></p></div></div>    
</body>
</html>