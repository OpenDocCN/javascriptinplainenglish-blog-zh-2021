<html>
<head>
<title>How to Schedule Emails with Node.js</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用Node.js安排邮件</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/how-to-schedule-emails-with-node-js-31e9a61e7c57?source=collection_archive---------2-----------------------#2021-12-07">https://javascript.plainenglish.io/how-to-schedule-emails-with-node-js-31e9a61e7c57?source=collection_archive---------2-----------------------#2021-12-07</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/005c4f034b8de67db93ae7164bd1a52f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0mPYLFlo0YBdPQvfI0DMKA.png"/></div></div></figure><p id="4eb3" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">每个组织都在幕后执行一系列任务，而我们大多数人甚至都没有意识到。例如，当网飞告诉你，你的帐户即将到期，这不是一些家伙谁实际上在监控你的帐户，并向你发送到期通知。这是一项持续运行BTS并保持跟踪的工作。同样，当你每天收到来自你最喜欢的网上时装商店的电子邮件时，这可能是一项为你和其他订阅它的人安排的工作。在这篇博文中，我们将尝试做一些类似于上面例子的东西。我们将创建一个电子邮件调度程序，使用我们自己的Node.js以特定的时间间隔向用户发送电子邮件。</p><blockquote class="kt ku kv"><p id="815b" class="jv jw kw jx b jy jz ka kb kc kd ke kf kx kh ki kj ky kl km kn kz kp kq kr ks ig bi translated"><a class="ae la" href="https://youtube.com/playlist?list=PL62km_yqC3ZEyoJa7JtdPOmzMgKuuZZ-x" rel="noopener ugc nofollow" target="_blank"> <strong class="jx io">你也可以在youtube上查看这个教程的视频版本。</strong> </a></p></blockquote><h2 id="8032" class="lb lc in bd ld le lf dn lg lh li dp lj kg lk ll lm kk ln lo lp ko lq lr ls lt bi translated">项目设置</h2><p id="8de5" class="pw-post-body-paragraph jv jw in jx b jy lu ka kb kc lv ke kf kg lw ki kj kk lx km kn ko ly kq kr ks ig bi translated">我假设您的系统中已经安装了Node.js。如果没有，可以从<a class="ae la" href="https://nodejs.org/en/download/" rel="noopener ugc nofollow" target="_blank">这里</a>下载安装。</p><p id="3594" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">通过在终端中键入<code class="fe lz ma mb mc b"><strong class="jx io">npm init -y</strong></code>来初始化一个节点项目。这将创建一个"<strong class="jx io"> package.json" </strong>文件，该文件主要保存与您的项目相关的信息。我们需要"<strong class="jx io"> express" </strong>和一些其他的依赖项，所以要安装它们，在你的项目终端中输入这个</p><pre class="md me mf mg gt mh mc mi mj aw mk bi"><span id="081d" class="lb lc in mc b gy ml mm l mn mo">npm i express bree nodemailer dotenv</span></pre><p id="da1e" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io"> bree: </strong>我们将使用的作业调度库<br/> <strong class="jx io"> nodemailer: </strong>库来创建和发送电子邮件<br/> <strong class="jx io"> dotenv </strong>:使用环境变量来保护我们的凭证的库</p><h2 id="2f83" class="lb lc in bd ld le lf dn lg lh li dp lj kg lk ll lm kk ln lo lp ko lq lr ls lt bi translated">创建作业调度程序</h2><p id="c55b" class="pw-post-body-paragraph jv jw in jx b jy lu ka kb kc lv ke kf kg lw ki kj kk lx km kn ko ly kq kr ks ig bi translated">首先，让我们创建我们的主服务器文件。在我们的根目录中，我们将添加一个名为app.js的文件。我们还将在同一个目录中添加一个jobs文件夹，其中包含我们打算创建的所有作业。将我们的组件分开是一个很好的做法，默认情况下，Bree也建议有一个单独的“<strong class="jx io">jobs”</strong>文件夹，尽管这不是绝对必要的。</p><p id="ba0c" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">现在我们的项目文件夹结构应该看起来像这样。</p><figure class="md me mf mg gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mp"><img src="../Images/1f564e9ebc45135f15708ed603bf4f83.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mBs-7OTszR5-D2Jm1l6FHg.png"/></div></div><figcaption class="mq mr gj gh gi ms mt bd b be z dk">Folder structure</figcaption></figure><p id="0ba9" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">你在jobs目录中看到的“<strong class="jx io">senemail . js</strong>”文件将包含我们稍后将添加的邮件程序逻辑。我们将看看服务器文件(app.js)中的代码。</p><figure class="md me mf mg gt jo"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="0d94" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我们首先从各自库中导入express和Bree。之后，我们将创建一个"<strong class="jx io"> Bree实例"</strong>，我们最终将使用它来执行我们的工作。在这个实例中，我们可以传入一些选项。你可以通过<a class="ae la" href="https://www.npmjs.com/package/bree#instance-options" rel="noopener ugc nofollow" target="_blank">点击</a>查看我们可以使用的实例选项的完整列表。我们将使用“<strong class="jx io">乔布斯”</strong>选项，这也是最重要的一个选项。</p><p id="8aab" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这个作业选项也有自己的一组<a class="ae la" href="https://www.npmjs.com/package/bree#job-options" rel="noopener ugc nofollow" target="_blank">选项</a>。它将保存与您要运行的作业相关的所有信息。因为它将是一个数组，所以您可以添加具有不同属性的多个作业。在我们的工作中，</p><p id="672e" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">名称:</strong>我们在“<strong class="jx io">作业</strong>”目录中的作业文件的名称。<br/><strong class="jx io">cron:</strong>cron表达式，作业将参考该表达式运行(稍后将详细介绍)。<br/> <strong class="jx io"> worker: </strong> Bree在幕后使用“<strong class="jx io"> worker threads </strong>”。因此，您运行的每个作业都是在节点流程中的不同工作线程上执行的。因此，如果需要，可以使用这个worker属性将附加数据传递给作业。</p><p id="2c2e" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">你可以点击查看选项列表。为了这个例子，我们将只使用"<strong class="jx io"> workerData" </strong>属性。</p><p id="26ac" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在这之后，我们只需要在这个实例上使用“<strong class="jx io"> start </strong>”方法，我们的作业将开始执行。</p><h2 id="c471" class="lb lc in bd ld le lf dn lg lh li dp lj kg lk ll lm kk ln lo lp ko lq lr ls lt bi translated">Cron语法</h2><p id="7bcf" class="pw-post-body-paragraph jv jw in jx b jy lu ka kb kc lv ke kf kg lw ki kj kk lx km kn ko ly kq kr ks ig bi translated">现在，您在上例中看到的cron键需要有特定的语法才能工作。cron表达式中的每个块都有特定的含义。如果你看一下这张图片，</p><figure class="md me mf mg gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mw"><img src="../Images/ae8aafa267926c4d8080902e01464566.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*x-Uv0ZZvTMDXTqqvpdEJQQ.png"/></div></div></figure><p id="de90" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">从左边开始，我们为“<strong class="jx io">每分钟”</strong>、“<strong class="jx io">每小时”</strong>、“<strong class="jx io">每月的每一天”</strong>、“<strong class="jx io">每月的每一天”</strong>和“<strong class="jx io">一周的每一天”</strong>。这些块中的每一个都有一个*号，这意味着它们取所有可能的值。因此，这个cron作业实际上将在一周的所有月份中的每一天、每小时的每一分钟运行😅。如果我将第一个*更改为5，这意味着现在它将在每小时的第5分钟运行(00:05、01:05、02:05等等)。我们再来看几个例子。</p><ul class=""><li id="2c3c" class="mx my in jx b jy jz kc kd kg mz kk na ko nb ks nc nd ne nf bi translated">* 10 * * *<br/>10:00后每分钟运行一次。</li><li id="472a" class="mx my in jx b jy ng kc nh kg ni kk nj ko nk ks nc nd ne nf bi translated">* * 4 * * <br/>在每月第4天的每一分钟运行。</li><li id="dfa5" class="mx my in jx b jy ng kc nh kg ni kk nj ko nk ks nc nd ne nf bi translated">* * * 3 * <br/>在三月的每一分钟运行。</li><li id="1730" class="mx my in jx b jy ng kc nh kg ni kk nj ko nk ks nc nd ne nf bi translated">* * * * 6 <br/>在星期六每分钟运行一次。</li></ul><p id="7465" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">还有一些其他的<strong class="jx io">操作符</strong>可以添加到cron语法中以获得更多的好处。我已经详细解释了一切，在这个<a class="ae la" href="https://youtu.be/LmDw-nbVLQk?t=350" rel="noopener ugc nofollow" target="_blank"> <strong class="jx io">视频</strong> </a>中，你可以观看它来更好地了解如何创造cron就业机会。您还可以尝试不同的cron作业，或者使用这个<a class="ae la" href="https://crontab.guru/#*_*_*_*_6" rel="noopener ugc nofollow" target="_blank"> <strong class="jx io">在线工具</strong> </a> <strong class="jx io">创建您自己的定制cron作业。</strong></p><p id="82d7" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">如果您根本不想在Bree实例中使用cron，您可以随时切换到日期语法或人类可读的语法，因此您可以用以下内容代替cron表达式</p><pre class="md me mf mg gt mh mc mi mj aw mk bi"><span id="b337" class="lb lc in mc b gy ml mm l mn mo">...<br/>cron : "* * * * *"    //Remove this<br/>interval : "Every 1 minute" //Add this<br/>...</span></pre><p id="0124" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这会给你同样的结果。</p><p id="6e37" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">因此，如果您现在通过在终端中键入“<strong class="jx io"> node app.js </strong>”来启动您的服务器，那么每分钟您都会看到一条类似于以下内容的消息</p><pre class="md me mf mg gt mh mc mi mj aw mk bi"><span id="45af" class="lb lc in mc b gy ml mm l mn mo">Worker for job "dummy" online<br/>Worker for job "dummy" exited with code 0 </span></pre><p id="6b39" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这意味着您已经成功创建了每分钟都会运行的cron作业。我们现在将邮件程序逻辑添加到我们的应用程序中。将以下代码复制到sendEmail.js文件中。</p><figure class="md me mf mg gt jo"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="14f9" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">让我们把它分成多个部分。我们首先在文件内部导入"<strong class="jx io"> Nodemailer" </strong>和"<strong class="jx io"> WorkerData" </strong>。WorkerData允许您访问您在调度器的worker键中传递的数据。所以，如果你回到app.js，看看Bree实例，我们在里面添加了一个对象</p><p id="558f" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">有一些描述的WorkerData。现在可以使用WorkerData在我们的作业中访问它。(<strong class="jx io"> <em class="kw"> WorkerData与emailer无关，如果愿意可以跳过。</em> </strong></p><p id="1964" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在这之后，我们创建一个main函数，在这个函数中我们有邮件程序的所有逻辑。然后在脚本的结尾调用这个主函数。</p><p id="8594" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我们的电子邮件程序首先需要一个transporter对象。这个对象接受一个选项列表。</p><p id="10ae" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">主机</strong>:我们正在连接的主机名(因为我使用我的outlook电子邮件帐户，所以我将使用他们的主机名。你可以在这里使用Gmail，但是你需要先完成几个额外的步骤。你可以在<a class="ae la" href="https://nodemailer.com/usage/using-gmail/" rel="noopener ugc nofollow" target="_blank">这里</a>了解更多。)</p><p id="a860" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">端口</strong>:我们需要连接的端口(默认为587)</p><p id="fb71" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io"> secure </strong>:如果为true，连接到服务器时将使用传输层安全性(默认为false)。</p><p id="d1f6" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io"> auth </strong>:定义认证数据(电子邮件发送者帐户的用户名和密码)</p><p id="f8c2" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">你可以在<a class="ae la" href="https://nodemailer.com/smtp/" rel="noopener ugc nofollow" target="_blank">这里</a>找到传送器选项的完整列表。</p><p id="c540" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">一旦我们准备好了传输器配置，我们需要配置我们的电子邮件消息。您可以在运输商的sendMail方法本身中配置您的电子邮件。</p><p id="33de" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">从&amp;到:</strong>您的电子邮件的发件人和收件人列表。</p><p id="1fba" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">主题:</strong>您电子邮件的主题。</p><p id="fa94" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">文本/html: </strong>邮件正文以文本或html的形式</p><p id="4808" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">你可以在<a class="ae la" href="https://nodemailer.com/message/" rel="noopener ugc nofollow" target="_blank">这里</a>找到邮件信息选项的完整列表。</p><p id="8916" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">现在，如果您再次运行您的服务器，并等待下一分钟(Bree实例中的cron作业每分钟都在运行)，您应该会在终端上看到这条消息。</p><pre class="md me mf mg gt mh mc mi mj aw mk bi"><span id="e274" class="lb lc in mc b gy ml mm l mn mo">Worker for job "sendEmail" online undefined<br/>This job will send emails.   <br/>Worker for job "sendEmail" exited with code 0</span></pre><p id="ef2f" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在此之后，你现在可以检查你的收件箱，看看你是否收到了电子邮件。</p><figure class="md me mf mg gt jo gh gi paragraph-image"><div class="gh gi nl"><img src="../Images/77cc3bccef2afc934320d26c66c0572f.png" data-original-src="https://miro.medium.com/v2/resize:fit:874/format:webp/1*xNzukZbPzSJ93kItbf2-WQ.png"/></div><figcaption class="mq mr gj gh gi ms mt bd b be z dk">Email message inside my inbox</figcaption></figure><h2 id="abf8" class="lb lc in bd ld le lf dn lg lh li dp lj kg lk ll lm kk ln lo lp ko lq lr ls lt bi translated">结论</h2><p id="2c16" class="pw-post-body-paragraph jv jw in jx b jy lu ka kb kc lv ke kf kg lw ki kj kk lx km kn ko ly kq kr ks ig bi translated">这基本上就是通常在Node.js应用程序中调度cron作业的要点。Bree是一个文档丰富、健壮的库，它的特性比我们在这里看到的要多得多。它还将工作线程用于其作业，这使得它本质上是非阻塞的，因此它还具有性能优势。你可以浏览它的<a class="ae la" href="https://www.npmjs.com/package/bree" rel="noopener ugc nofollow" target="_blank">文档</a>来更好地了解它的真正潜力。</p><p id="130f" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><a class="ae la" href="https://youtube.com/playlist?list=PL62km_yqC3ZEyoJa7JtdPOmzMgKuuZZ-x" rel="noopener ugc nofollow" target="_blank"> <strong class="jx io">你也可以在youtube上查看这个教程的视频版本。</strong>T13】</a></p><p id="ba0b" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">如果你有任何疑问或建议，你可以在评论中提出来，或者你也可以通过我的社交网站与我联系。干杯！</p><p id="0600" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><a class="ae la" href="https://www.linkedin.com/in/akilesh-rao-610357137/" rel="noopener ugc nofollow" target="_blank">LinkedIn</a><br/><a class="ae la" href="https://twitter.com/themangalorian" rel="noopener ugc nofollow" target="_blank">Twitter</a><br/><a class="ae la" href="https://github.com/AkileshRao" rel="noopener ugc nofollow" target="_blank">GitHub</a><br/><a class="ae la" href="https://www.youtube.com/channel/UCaktnqx_IENyT5T2lJ3F09w" rel="noopener ugc nofollow" target="_blank">YouTube</a></p><p id="81e1" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><em class="kw">更多内容请看</em><a class="ae la" href="http://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><strong class="jx io"><em class="kw">plain English . io</em></strong></a><strong class="jx io"><em class="kw">。</em> </strong> <em class="kw">报名参加我们的</em> <a class="ae la" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="jx io"> <em class="kw">免费每周简讯这里</em> </strong> </a> <strong class="jx io"> <em class="kw">。</em>T48】</strong></p></div></div>    
</body>
</html>