<html>
<head>
<title>How to Secure Node.js/Express Apps?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何保护Node.js/Express应用程序？</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/how-to-secure-node-js-express-apps-1d32312ff0a4?source=collection_archive---------8-----------------------#2021-07-27">https://javascript.plainenglish.io/how-to-secure-node-js-express-apps-1d32312ff0a4?source=collection_archive---------8-----------------------#2021-07-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="f562" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">可以保护您的节点应用免受安全攻击的快速提示</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/5841d4adbccbb78695847576eb39ad70.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Su_uqZVJh8_DufNEo8wVTA.jpeg"/></div></div></figure><p id="5206" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">Node.js是与Express等框架一起使用的最流行的运行时之一。它有一个蓬勃发展的开发者社区，深受每个人的喜爱。虽然使用Node.js进行开发是一种乐趣，但从安全角度考虑您构建的应用程序也很重要。</p><p id="43a4" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><a class="ln lo ep" href="https://medium.com/u/5253c50d76c1?source=post_page-----1d32312ff0a4--------------------------------" rel="noopener" target="_blank"> John Au-Yeung </a>也写了一篇关于这个主题的快速阅读文章<a class="ae lp" href="https://medium.com/swlh/node-js-best-practices-improving-security-2c772419d475" rel="noopener">这里</a>介绍了防止针对授权、根用法、eval语句等的暴力攻击的方法。在本文中，我们将讨论一些简单而有效的技巧来保护您的Node.js/Express.js应用程序免受攻击，这将在本文中进一步展开。总之，这可以成为改进Node.js应用程序安全机制的有益指南。</p><p id="e17e" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">让我们开始吧！</p><h1 id="ac2e" class="lq lr iq bd ls lt lu lv lw lx ly lz ma jw mb jx mc jz md ka me kc mf kd mg mh bi translated">验证用户的输入</h1><h2 id="f190" class="mi lr iq bd ls mj mk dn lw ml mm dp ma la mn mo mc le mp mq me li mr ms mg mt bi translated">表单验证</h2><p id="8da7" class="pw-post-body-paragraph kr ks iq kt b ku mu jr kw kx mv ju kz la mw lc ld le mx lg lh li my lk ll lm ij bi translated">开发任何软件应用程序的一个关键原则是确保流入应用程序的数据总是根据您的条件进行验证。如果没有验证，恶意输入可能会进入您的应用程序。</p><p id="a214" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在Node.js中，我们可以充分利用拥有大量库的NPM注册中心。出于验证的目的，我们可以使用<a class="ae lp" href="https://www.npmjs.com/package/validator" rel="noopener ugc nofollow" target="_blank">验证器</a>和<a class="ae lp" href="https://www.npmjs.com/package/express-validator" rel="noopener ugc nofollow" target="_blank"> express-validator </a>库。</p><p id="f137" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">例如，使用validator包，您可以进行简单的验证来检查输入的字符串是否是电子邮件:</p><pre class="kg kh ki kj gt mz na nb nc aw nd bi"><span id="d2ca" class="mi lr iq na b gy ne nf l ng nh">const validator = require('validator');<br/>validator.isEmail("abc@xyz.com");</span></pre><p id="f759" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">同样，它提供了大量的操作，如<code class="fe ni nj nk na b">isAlpha</code>和消毒功能，如<code class="fe ni nj nk na b">escape</code>或<code class="fe ni nj nk na b">trim</code>。</p><p id="a574" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">Express validator是另一个库，它是Express.js的中间件。这里显示了一个验证API调用的请求体中的字段的简单示例:</p><pre class="kg kh ki kj gt mz na nb nc aw nd bi"><span id="a290" class="mi lr iq na b gy ne nf l ng nh">// ...rest of the initial code omitted for simplicity.<br/><strong class="na ir">const</strong> { body, validationResult } = require('express-validator');<br/><br/>app.post(<br/>  '/user',<br/>  // username must be an email<br/>  body('username').isEmail(),<br/>  // password must be at least 5 chars long<br/>  body('password').isLength({ min: 5 }),<br/>  (req, res) =&gt; {<br/>    // Finds the validation errors in this request and wraps them in an object with handy functions<br/>    <strong class="na ir">const</strong> errors = validationResult(req);<br/>    <strong class="na ir">if</strong> (!errors.isEmpty()) {<br/>      <strong class="na ir">return</strong> res.status(400).json({ errors: errors.array() });<br/>    }<br/><br/>    User.create({<br/>      username: req.body.username,<br/>      password: req.body.password,<br/>    }).then(user =&gt; res.json(user));<br/>  },<br/>);</span></pre><p id="388a" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">详细文件请参见本页。</p><h2 id="6930" class="mi lr iq bd ls mj mk dn lw ml mm dp ma la mn mo mc le mp mq me li mr ms mg mt bi translated">阻止SQL注入</h2><p id="448a" class="pw-post-body-paragraph kr ks iq kt b ku mu jr kw kx mv ju kz la mw lc ld le mx lg lh li my lk ll lm ij bi translated">再一次，当来自用户的输入没有被净化时，SQL注入攻击就会出现。这会导致在表单字段中提交的SQL查询在数据库上执行。想象一下<code class="fe ni nj nk na b">DROP DATABASE dbName;</code>这样的操作会如何影响你的应用！它会清除数据。</p><p id="6234" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在这种情况下，最直接的方法也是使用validator(如上所述)这样的库来彻底净化输入，以确保特殊字符、奇怪的查询字符串等。在进入代码中的数据库层之前被移除。</p><h2 id="cd9b" class="mi lr iq bd ls mj mk dn lw ml mm dp ma la mn mo mc le mp mq me li mr ms mg mt bi translated">避免类型不匹配</h2><p id="146e" class="pw-post-body-paragraph kr ks iq kt b ku mu jr kw kx mv ju kz la mw lc ld le mx lg lh li my lk ll lm ij bi translated">接下来，我们需要避免代码中的类型不匹配。例如，当我们的函数期望一个数字时，我们不能接收一个字符串。JavaScript是一种弱类型语言。我们不需要预先指定变量的类型，JavaScript会相应地尝试“键入”它。</p><p id="0e0d" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">虽然这在开发时可能更容易，但它可能会导致一些安全缺陷和错误。为了避免这种情况，我们可以在JavaScript中使用本机转换函数，例如:</p><ul class=""><li id="638b" class="nl nm iq kt b ku kv kx ky la nn le no li np lm nq nr ns nt bi translated">号码(“123”)</li><li id="0bd6" class="nl nm iq kt b ku nu kx nv la nw le nx li ny lm nq nr ns nt bi translated">字符串(123)</li></ul><p id="486d" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">您可以使用许多其他类型转换。请务必查看<a class="ae lp" href="https://www.w3schools.com/js/js_type_conversion.asp" rel="noopener ugc nofollow" target="_blank">这一页</a>了解更多信息。</p><h1 id="32c2" class="lq lr iq bd ls lt lu lv lw lx ly lz ma jw mb jx mc jz md ka me kc mf kd mg mh bi translated">账户管理</h1><h2 id="53bc" class="mi lr iq bd ls mj mk dn lw ml mm dp ma la mn mo mc le mp mq me li mr ms mg mt bi translated">密码哈希</h2><p id="8fef" class="pw-post-body-paragraph kr ks iq kt b ku mu jr kw kx mv ju kz la mw lc ld le mx lg lh li my lk ll lm ij bi translated">应用程序的一个关键部分是用户管理。您的应用程序很可能包含允许用户登录的用户帐户。此类功能很可能会使用一些密码来登录。</p><p id="e04c" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">密码被归类为敏感信息，应该以尽可能安全的方式存储，以免被错误的人滥用。密码管理的基本方法是加盐和散列。</p><p id="e93f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">哈希是指一种单向函数，它将输入转换为一串不可解码的字节。然而，仅仅使用散列并不能解决问题。攻击者可以很容易地使用查找表，其中包含最常用密码的预计算哈希，以比较您的应用程序数据库中的哈希(以防黑客攻击)。</p><p id="8895" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这就是盐的用武之地。通过添加一个随机的“salt ”,我们将一个独特的字符串附加到用户提供的明文密码中，然后对其进行哈希处理。这样，使用查找表解码散列密码的概率大大降低。</p><p id="7477" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">对于Node.js或Express.js应用程序，我们可以利用<a class="ae lp" href="https://www.npmjs.com/package/bcrypt" rel="noopener ugc nofollow" target="_blank"> BCrypt库</a>。</p><pre class="kg kh ki kj gt mz na nb nc aw nd bi"><span id="4d44" class="mi lr iq na b gy ne nf l ng nh">const bcrypt = require('bcrypt');<br/>const saltRounds = 10;</span><span id="6cc4" class="mi lr iq na b gy nz nf l ng nh">bcrypt.genSalt(saltRounds, function(err, salt) {<br/>    bcrypt.hash(userPassword, salt, function(err, hash) {<br/>         dbHelper.save(hash);<br/>    });<br/>});</span></pre><p id="9fda" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">上面是一个简单的例子，告诉你如何用几行代码就能做到这一点！</p><p id="5c76" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><code class="fe ni nj nk na b">saltRounds</code>是salt过程的回合数，它与散列的安全性相关。更多轮次=更安全，然而更多轮次=更昂贵的操作。</p><h2 id="8ec2" class="mi lr iq bd ls mj mk dn lw ml mm dp ma la mn mo mc le mp mq me li mr ms mg mt bi translated">批准</h2><p id="7c0a" class="pw-post-body-paragraph kr ks iq kt b ku mu jr kw kx mv ju kz la mw lc ld le mx lg lh li my lk ll lm ij bi translated">帐户管理的下一部分是授权。简单来说，</p><blockquote class="oa ob oc"><p id="3661" class="kr ks od kt b ku kv jr kw kx ky ju kz oe lb lc ld of lf lg lh og lj lk ll lm ij bi translated">授权是指定对资源的访问权限/特权的功能，它与一般信息安全和计算机安全有关，尤其与访问控制有关。<br/>演职员表:<a class="ae lp" href="https://www.wikipedia.com/en/Authorization" rel="noopener ugc nofollow" target="_blank">维基百科</a></p></blockquote><p id="ada6" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">因此，使用授权，我们可以确保只有正确的人/用户才能访问正确的资源。</p><p id="8965" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在Node.js/Express.js,，我们可以使用<a class="ae lp" href="https://www.npmjs.com/package/acl2" rel="noopener ugc nofollow" target="_blank"> ACL库</a>来实现这一点。举个例子，</p><pre class="kg kh ki kj gt mz na nb nc aw nd bi"><span id="b24c" class="mi lr iq na b gy ne nf l ng nh">// allow function accepts arrays as any parameter<br/>acl.allow("member", "blogs", ["edit", "view", "delete"]);</span></pre><p id="d95e" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">上述文档中的例子表明，我们允许“成员”对名为“博客”的资源进行“编辑”、“查看”和“删除”。</p><p id="4873" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">授权和认证都很重要。不要混淆这两者，每一方面都很重要。</p><blockquote class="oa ob oc"><p id="a4d6" class="kr ks od kt b ku kv jr kw kx ky ju kz oe lb lc ld of lf lg lh og lj lk ll lm ij bi translated"><strong class="kt ir">认证</strong>是确定某人确实是他们所声称的那个人的过程。</p><p id="43cb" class="kr ks od kt b ku kv jr kw kx ky ju kz oe lb lc ld of lf lg lh og lj lk ll lm ij bi translated"><strong class="kt ir">授权</strong>指的是决定谁被允许做什么的规则。例如，Adam可能被授权创建和删除数据库，而Usama仅被授权读取。<br/>学分:<a class="ae lp" href="https://stackoverflow.com/questions/6556522/authentication-versus-authorization" rel="noopener ugc nofollow" target="_blank"> StackOverflow </a></p></blockquote><h1 id="1ce2" class="lq lr iq bd ls lt lu lv lw lx ly lz ma jw mb jx mc jz md ka me kc mf kd mg mh bi translated">网络安全性</h1><h2 id="fc1d" class="mi lr iq bd ls mj mk dn lw ml mm dp ma la mn mo mc le mp mq me li mr ms mg mt bi translated">HTTPS和SSL</h2><p id="573b" class="pw-post-body-paragraph kr ks iq kt b ku mu jr kw kx mv ju kz la mw lc ld le mx lg lh li my lk ll lm ij bi translated">除了您的应用程序，您还需要以安全的方式传输和接收数据，以避免任何窥探。今天，每个应用程序都应该支持HTTPS作为事实上的标准。</p><p id="9fa6" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">虽然不是Node.js/Express.js,独有的，但对应用程序实施SSL加密的最简单方法是使用LetsEncrypt。这是一项免费使用的服务，提供免费的SSL证书来保护您的应用程序域。</p><p id="5898" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这应该适用于web服务器级别，比如Nginx。请务必在此查看文档<a class="ae lp" href="https://letsencrypt.org/" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="d583" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">另一种方法当然是从你的云提供商那里获得SSL证书，比如AWS上的<a class="ae lp" href="https://aws.amazon.com/certificate-manager/" rel="noopener ugc nofollow" target="_blank">Amazon Certificate Manager(ACM)</a>。</p><h2 id="93f7" class="mi lr iq bd ls mj mk dn lw ml mm dp ma la mn mo mc le mp mq me li mr ms mg mt bi translated">安全标题</h2><p id="456a" class="pw-post-body-paragraph kr ks iq kt b ku mu jr kw kx mv ju kz la mw lc ld le mx lg lh li my lk ll lm ij bi translated">许多攻击可以通过一些关键安全报头的存在来防止。为了实现这个，我们可以使用<a class="ae lp" href="https://www.npmjs.com/package/helmet" rel="noopener ugc nofollow" target="_blank">头盔</a>。只需一行代码，您就可以启用多个安全头:</p><pre class="kg kh ki kj gt mz na nb nc aw nd bi"><span id="02a1" class="mi lr iq na b gy ne nf l ng nh">app.use(helmet());</span></pre><p id="c8af" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">以上内容翻译过来就是:</p><pre class="kg kh ki kj gt mz na nb nc aw nd bi"><span id="c945" class="mi lr iq na b gy ne nf l ng nh">app.use(helmet.contentSecurityPolicy());<br/>app.use(helmet.dnsPrefetchControl());<br/>app.use(helmet.expectCt());<br/>app.use(helmet.frameguard());<br/>app.use(helmet.hidePoweredBy());<br/>app.use(helmet.hsts());<br/>app.use(helmet.ieNoOpen());<br/>app.use(helmet.noSniff());<br/>app.use(helmet.permittedCrossDomainPolicies());<br/>app.use(helmet.referrerPolicy());<br/>app.use(helmet.xssFilter());</span></pre><p id="5a8a" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">简单，容易，有效！</p><h1 id="6702" class="lq lr iq bd ls lt lu lv lw lx ly lz ma jw mb jx mc jz md ka me kc mf kd mg mh bi translated">其他人</h1><h2 id="cd48" class="mi lr iq bd ls mj mk dn lw ml mm dp ma la mn mo mc le mp mq me li mr ms mg mt bi translated">CSRF / XSRF缓解</h2><p id="67e3" class="pw-post-body-paragraph kr ks iq kt b ku mu jr kw kx mv ju kz la mw lc ld le mx lg lh li my lk ll lm ij bi translated">您可能需要缓解的另一种常见攻击是跨站点请求伪造。这种攻击诱使合法用户提交恶意内容。例如，让用户在登录时执行恶意脚本(已验证状态)。</p><p id="8845" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">使用<a class="ae lp" href="https://www.npmjs.com/package/csurf" rel="noopener ugc nofollow" target="_blank"> csurf库</a>可以缓解这种攻击。这个包需要使用会话中间件或cookie解析器。最常见的是，它作为中间件与Express.js一起使用。点击查看文档<a class="ae lp" href="http://expressjs.com/en/resources/middleware/csurf.html" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="f222" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这个中间件帮助创建一个csrf令牌，它将与网络调用一起传递。然后，将根据用户的会话或cookie来验证该令牌。在这里阅读更多<a class="ae lp" href="https://stackoverflow.com/questions/57812757/how-csurf-middleware-validates-tokens#:~:text=The%20csurf%20works%20by%20storing,csrfToken()%20." rel="noopener ugc nofollow" target="_blank"/>。</p><h2 id="4683" class="mi lr iq bd ls mj mk dn lw ml mm dp ma la mn mo mc le mp mq me li mr ms mg mt bi translated">包和依赖项</h2><p id="4641" class="pw-post-body-paragraph kr ks iq kt b ku mu jr kw kx mv ju kz la mw lc ld le mx lg lh li my lk ll lm ij bi translated">虽然NPM存储库非常庞大，并提供了一种简单易用的方法来扩充您的应用程序，但我们也需要采取预防措施，以应对由于过时的软件包而带来的安全风险。</p><p id="5e7c" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">因此，定期监控以确保所有软件包都是最新的是必要的。我们可以使用<code class="fe ni nj nk na b">npm audit</code>命令很容易地做到这一点，并用<code class="fe ni nj nk na b">npm audit fix</code>自动修复可修复的问题。</p><p id="a46b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">就这么简单！</p><h1 id="a3b2" class="lq lr iq bd ls lt lu lv lw lx ly lz ma jw mb jx mc jz md ka me kc mf kd mg mh bi translated">结论</h1><p id="81d5" class="pw-post-body-paragraph kr ks iq kt b ku mu jr kw kx mv ju kz la mw lc ld le mx lg lh li my lk ll lm ij bi translated">今天，我们开发的应用程序的安全性在确保您的服务的稳定性、可靠性和持久性方面占据了极大的优先地位。保护用户信任当然是我们作为开发者的另一个巨大责任。以上提示是我们可以增强节点应用程序的一些方法，以使其安全运行并最大限度地降低安全风险。</p><p id="a470" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">编码快乐！💻</p><p id="f2cb" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><em class="od">更多内容尽在</em><a class="ae lp" href="http://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><strong class="kt ir"><em class="od">plain English . io</em></strong></a></p></div></div>    
</body>
</html>