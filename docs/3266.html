<html>
<head>
<title>Make IndexedDB work on Capacitor and iOS 14.6</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使IndexedDB在电容器和iOS 14.6上工作</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/make-indexeddb-work-on-capacitor-and-ios-14-6-a0a75141ca1a?source=collection_archive---------9-----------------------#2021-07-03">https://javascript.plainenglish.io/make-indexeddb-work-on-capacitor-and-ios-14-6-a0a75141ca1a?source=collection_archive---------9-----------------------#2021-07-03</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="3ae6" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">本文是关于修复iOS 14.6的一个问题，IndexedDB和一个PWA通过电容在iOS上运行。</h2></div><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi kc"><img src="../Images/5a6a3350d823a13c361e396a9a8aae3e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*e43ouEgtuqz_x3DJ"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Photo by <a class="ae ks" href="https://unsplash.com/@vmxhu?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Szabo Viktor</a> on <a class="ae ks" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="2701" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">苹果于5月24日发布了新版iOS 14.6。原来这个版本的固件引入了一个错误，IndexedDB: <a class="ae ks" href="https://developer.apple.com/forums/thread/681201" rel="noopener ugc nofollow" target="_blank">这里</a>苹果开发者论坛上的一个讨论，但这个问题也在其他平台上出现，比如Ionic: <a class="ae ks" href="https://developer.apple.com/forums/thread/681201" rel="noopener ugc nofollow" target="_blank">这里</a>。关于这个bug的一篇有趣的文章也在<a class="ae ks" href="https://www.theregister.com/2021/06/16/apple_safari_indexeddb_bug/" rel="noopener ugc nofollow" target="_blank">这里</a>。</p><p id="5edc" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">该问题与IndexedDB的打开有关，刷新页面应该可以解决该问题(即使可能会让您的用户感到烦恼)。</p><p id="d630" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">在我的情况下，这有点棘手:事实上，我在iOS上运行的PWA使用了Capacitor，这与在Safari上运行该应用不同。无论如何，刷新应用程序并不能解决问题。</p><p id="a942" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">您在调试日志中得到的错误是:</p><pre class="kd ke kf kg gt lp lq lr ls aw lt bi"><span id="2b20" class="lu lv in lq b gy lw lx l ly lz">You need to use the openDatabase function to create a database before you query it!</span></pre><p id="d299" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">所以你检查你的代码，看到这个:</p><pre class="kd ke kf kg gt lp lq lr ls aw lt bi"><span id="b884" class="lu lv in lq b gy lw lx l ly lz">initializeDb() {<br/>  <strong class="lq io">this</strong>.indexedDB = <strong class="lq io">new </strong>NgxIndexedDB(<strong class="lq io">this</strong>.DB_NAME, <strong class="lq io">this</strong>.DB_VERSION);<br/>  <strong class="lq io">return this</strong>.indexedDB.openDatabase(<strong class="lq io">this</strong>.DB_VERSION, evt =&gt; {<br/>     ...<br/>  });<br/>}</span></pre><p id="7d7f" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">我们实际上是在调用这个方法，为什么会这样呢？</p></div><div class="ab cl ma mb hr mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="ig ih ii ij ik"><p id="88d3" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">经过一番研究，并感谢之前发布的链接，我发现这个小代码可以有所帮助:</p><pre class="kd ke kf kg gt lp lq lr ls aw lt bi"><span id="7f54" class="lu lv in lq b gy lw lx l ly lz">&lt;<strong class="lq io">script </strong>type<strong class="lq io">="text/javascript"</strong>&gt;<br/>  window.indexedDB;<br/>&lt;/<strong class="lq io">script</strong>&gt;</span></pre><p id="6f3d" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">诀窍是这个应用程序是用Angular编写的PWA:我把应该加载到每个页面的代码放在哪里？</p><p id="27f4" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">最后，我把这个片段放到了index.html的文件中，然后数据库就可以正确加载了！在下面的截图中你可以看到项目中的<em class="mh"> src </em>包和<em class="mh">index.html</em>文件:</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi mi"><img src="../Images/b067a44b348a5ac8be4f9c5d834735ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:390/format:webp/1*vssafZ5aMBEhMB07b44fFQ.png"/></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">index.html file in the Angular project</figcaption></figure><p id="43fb" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">希望这有所帮助。如果你有任何意见，请告诉我。</p><p id="4df3" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated"><em class="mh">更多内容请看</em><a class="ae ks" href="http://plainenglish.io" rel="noopener ugc nofollow" target="_blank"><strong class="kv io"><em class="mh">plain English . io</em></strong></a></p></div></div>    
</body>
</html>