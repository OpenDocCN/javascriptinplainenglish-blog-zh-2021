<html>
<head>
<title>Rate Limiting APIs in Node.js: What Is It and How Does It Work?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Node.js中的速率限制API:它是什么，是如何工作的？</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/rate-limiting-apis-in-node-js-what-is-it-and-how-does-it-work-f19b4aff3f38?source=collection_archive---------6-----------------------#2021-11-16">https://javascript.plainenglish.io/rate-limiting-apis-in-node-js-what-is-it-and-how-does-it-work-f19b4aff3f38?source=collection_archive---------6-----------------------#2021-11-16</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/67faa27a7df4e483f233a27c9ab9de45.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sNSzGysLLeMKoscN-LFyPA.png"/></div></div></figure><p id="0083" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">速率限制是一种策略，在这种策略中，您可以通过为API的使用限制设置上限来保护API。你通常希望你的用户在使用你的API时有一个愉快的体验。假设有人向您的服务器发送大量请求，不管是合法的还是恶意的，都会给其他用户带来问题，还可能完全阻塞服务。在这篇博文中，我们将看看如何在Node.js中为我们的API实现速率限制。这种速率限制策略有助于缓解一些常见问题，如暴力攻击或DoS/DDoS攻击。</p><blockquote class="kt ku kv"><p id="7a9d" class="jv jw kw jx b jy jz ka kb kc kd ke kf kx kh ki kj ky kl km kn kz kp kq kr ks ig bi translated">你也可以看这篇文章的视频版本，点击<a class="ae la" href="https://youtu.be/iicNZf3eGCI" rel="noopener ugc nofollow" target="_blank"> <strong class="jx io">这里</strong> </a>。</p></blockquote><h2 id="18d1" class="lb lc in bd ld le lf dn lg lh li dp lj kg lk ll lm kk ln lo lp ko lq lr ls lt bi translated">项目设置</h2><p id="e78d" class="pw-post-body-paragraph jv jw in jx b jy lu ka kb kc lv ke kf kg lw ki kj kk lx km kn ko ly kq kr ks ig bi translated">要快速设置节点项目，请打开您选择的代码编辑器，并在一个空文件夹中运行以下命令。</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="3dc2" class="lb lc in me b gy mi mj l mk ml">npm init -y</span></pre><p id="7d75" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">“<strong class="jx io"> -y </strong>”标志将直接创建您的package.json文件，而不会询问任何样板问题。一旦完成，继续安装快速和快速速率限制。</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="f031" class="lb lc in me b gy mi mj l mk ml">npm install express express-rate-limit</span></pre><p id="5b44" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">之后，在您的项目目录中创建一个服务器文件，并在该文件中复制以下代码。</p><figure class="lz ma mb mc gt jo"><div class="bz fp l di"><div class="mm mn l"/></div></figure><p id="6540" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我们来分析一下。我们首先导入express并为其创建一个实例。我们还导入了快速速率限制库。</p><p id="a664" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">因为我们的API端点将返回一个帖子列表，所以我们在这里创建了一个帖子数组，并将其存储在一个变量中。之后，我们创建一个速率限制配置对象，并将其传递到“rate limit”函数中。现在，在这个配置中，有相当多的键可以传递。一些最常见的是</p><ul class=""><li id="8005" class="mo mp in jx b jy jz kc kd kg mq kk mr ko ms ks mt mu mv mw bi translated"><strong class="jx io"> max </strong> —给定时间范围内的最大请求数</li><li id="2003" class="mo mp in jx b jy mx kc my kg mz kk na ko nb ks mt mu mv mw bi translated"><strong class="jx io"> windowMs — </strong>时间范围(毫秒)</li><li id="da3c" class="mo mp in jx b jy mx kc my kg mz kk na ko nb ks mt mu mv mw bi translated"><strong class="jx io"> onLimitReached — </strong>用户第一次超过速率限制时调用的函数</li><li id="e214" class="mo mp in jx b jy mx kc my kg mz kk na ko nb ks mt mu mv mw bi translated"><strong class="jx io">跳过— </strong>用于跳过请求的功能</li></ul><p id="4cbb" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">你可以在官方<a class="ae la" href="https://www.npmjs.com/package/express-rate-limit" rel="noopener ugc nofollow" target="_blank">文档</a>中读到更多细节。对于我们的例子，我们将使用<strong class="jx io"> max </strong>和<strong class="jx io"> windowMs </strong>键来配置我们的速率限制器。最大值设置为5个请求，时间范围设置为20秒(20000毫秒)。</p><p id="b799" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在这个配置下面，我们有我们的API端点。这个端点将是一个非常基本的GET请求，它返回一组posts(我们在上面创建的那个)以及一个状态标志。</p><p id="3d14" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">最后，我们监听端口5000上的请求。就是这样。</p><p id="2ae8" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">现在我们可以运行这个应用程序并打开postman来测试我们的API端点。</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="731d" class="lb lc in me b gy mi mj l mk ml">node app</span></pre><p id="f2da" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在请求URL块中输入API端点(<strong class="jx io">http://localhost:5000/posts</strong>)，并将请求类型设置为“<strong class="jx io"> GET </strong>”。现在，如果我们将这个请求发送到我们的服务器，我们将首先得到预期的响应，即posts数组。</p><figure class="lz ma mb mc gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nc"><img src="../Images/3ede5c23f85f3b7d4bfec882ff170554.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*E7jbBMAOgqHa0VodIDb8EQ.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk">Successful request</figcaption></figure><p id="fc2c" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">现在尝试连续多次发送相同的请求。在第五次请求后，您会得到一个回应，说“<strong class="jx io">请求太多，请稍后再试</strong>”。这意味着我们的限速器工作正常。您可以使用配置中的值来测试多种情况。</p><figure class="lz ma mb mc gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nh"><img src="../Images/362408934f4d33e97f79f3b9b13ab8ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*N58iu5dO-q95ZMUkGJbUFA.png"/></div></div></figure><p id="9418" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">如果打开“回复标题”选项卡，您会看到一些新的标题被添加到列表中。</p><figure class="lz ma mb mc gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nh"><img src="../Images/e2773efa0d69e6c79dd5150d4eb193eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XwB2xSEDBAQu_34QfQS9wg.png"/></div></div></figure><ul class=""><li id="b1d7" class="mo mp in jx b jy jz kc kd kg mq kk mr ko ms ks mt mu mv mw bi translated">X-RateLimit-Limit —告诉您在时间范围内可以发出的请求总数</li><li id="3ca6" class="mo mp in jx b jy mx kc my kg mz kk na ko nb ks mt mu mv mw bi translated">X-RateLimit-Remaining —告诉您在特定时间段内剩余的请求数量</li><li id="4619" class="mo mp in jx b jy mx kc my kg mz kk na ko nb ks mt mu mv mw bi translated">X-RateLimit-Reset —重置您的使用限制上限的时间。</li></ul><p id="86d9" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">如果你看一下上面的代码，我已经尝试在我们的API控制器中控制台记录"<strong class="jx io"> req.rateLimit </strong>"这个"<strong class="jx io"> rateLimit" </strong>属性被添加到我们的请求对象中，它有几个方便的属性，可以用来通知用户它们的使用状态。</p><figure class="lz ma mb mc gt jo gh gi paragraph-image"><div class="gh gi ni"><img src="../Images/3b8dde7b63c7888b62005aa9860e0efd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1034/format:webp/1*4N_o0Y79mo1DAoJ1TimcJw.png"/></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk">req.rateLimit object</figcaption></figure><p id="8bed" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">大概就是这样。默认情况下，此限制映射到一个IP地址。因此用户仍然可以从多个IP地址向您的应用程序发出请求。因此，理想的解决方案是保持这种基于IP地址的速率限制，并在此基础上添加一个额外的基于userId的速率限制(为此需要认证)。因此，即使用户移动到不同的IP地址，他/她仍然只有一个userId。所以这个基于用户标识的速率限制可以解决这个问题。</p><p id="b58e" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">如果你更好地理解视频格式，我有一个单独的视频，你可以在这里观看<a class="ae la" href="https://youtu.be/iicNZf3eGCI" rel="noopener ugc nofollow" target="_blank"/>。如果你有任何疑问或建议，你可以在评论中提出来，或者你可以在我的任何一个社交网站上与我联系。干杯！。</p></div><div class="ab cl nj nk hr nl" role="separator"><span class="nm bw bk nn no np"/><span class="nm bw bk nn no np"/><span class="nm bw bk nn no"/></div><div class="ig ih ii ij ik"><p id="cd59" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><a class="ae la" href="https://www.linkedin.com/in/akilesh-rao-610357137/" rel="noopener ugc nofollow" target="_blank">LinkedIn</a><br/><a class="ae la" href="https://twitter.com/themangalorian" rel="noopener ugc nofollow" target="_blank">Twitter</a><br/><a class="ae la" href="https://github.com/AkileshRao" rel="noopener ugc nofollow" target="_blank">GitHub</a><br/><a class="ae la" href="https://www.youtube.com/channel/UCaktnqx_IENyT5T2lJ3F09w" rel="noopener ugc nofollow" target="_blank">YouTube</a></p><p id="f2f5" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><em class="kw">更多内容请看</em><a class="ae la" href="http://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><strong class="jx io"><em class="kw">plain English . io</em></strong></a></p></div></div>    
</body>
</html>