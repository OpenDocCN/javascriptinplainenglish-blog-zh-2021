<html>
<head>
<title>Uploading an Image to Firebase Cloud Storage and returning URL</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">上传图像到Firebase云存储并返回URL</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/uploading-an-image-to-firebase-cloud-storage-and-returning-url-with-express-nodejs-713daac7a5d4?source=collection_archive---------0-----------------------#2021-07-08">https://javascript.plainenglish.io/uploading-an-image-to-firebase-cloud-storage-and-returning-url-with-express-nodejs-713daac7a5d4?source=collection_archive---------0-----------------------#2021-07-08</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="fa70" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">天啊，文档太疯狂了。让我帮你省点时间吧！</p><p id="2a2d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">让我告诉你，Firebase文档是很特别的。这看起来简单明了，但实际上，你需要去天涯海角寻找那些微小的东西来让它工作。但是我们开始了。我们开始吧！:-)</p><h1 id="0bdb" class="ki kj in bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">步骤1:创建一个谷歌云应用程序</h1><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi lg"><img src="../Images/3b9d6e6da047618c5db0d32077105964.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EUpb0ZbqT9EV1jvIyxTBjA.png"/></div></div></figure><p id="402e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">Psst不要担心帐单。根据星火计划，这些都是免费的。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div class="gh gi ls"><img src="../Images/8736a413cbfd807a37f6227b2d9ac562.png" data-original-src="https://miro.medium.com/v2/resize:fit:1196/format:webp/1*6kJBs4Zi6ZlYoxZrN41mRQ.png"/></div></figure><h1 id="bfb6" class="ki kj in bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">第二步:在Firebase的左侧，单击存储并开始。</h1><p id="2589" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated">在指定区域设置新的云存储空间。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi ly"><img src="../Images/df97adf0496def21019306373c707554.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*T42_w_s8M4uLNeTAdqNKeQ.png"/></div></div></figure><p id="d3c5" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">一旦你设置好了，它应该是这样的，当然是空的，没有文件。:(</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi lz"><img src="../Images/9b21b67ce23445686e071e5e21fb95d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dtpL205HOVJTb1aeR_JKkg.png"/></div></div></figure><h1 id="e0ef" class="ki kj in bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">步骤3:导航到“规则”选项卡，并允许公共写访问。</h1><p id="10f7" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated">bucket不允许未经身份验证的用户上传到它，我们可以通过改变规则来改变这一点。</p><p id="268e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">因此，在“规则”选项卡中，将规则更新为以下内容:</p><pre class="lh li lj lk gt ma mb mc md aw me bi"><span id="fb79" class="mf kj in mb b gy mg mh l mi mj">rules_version = ‘2’;<br/>service firebase.storage {<br/> match /b/{bucket}/o {<br/>  match /{allPaths=**} {<br/>   // Allow access by all users<br/>   allow read, write;<br/>  }<br/> }<br/>}</span></pre><h1 id="4b4e" class="ki kj in bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">第四步:注册你的网络应用程序，获取你的firebase证书</h1><p id="c4af" class="pw-post-body-paragraph jk jl in jm b jn lt jp jq jr lu jt ju jv lv jx jy jz lw kb kc kd lx kf kg kh ig bi translated">点击&gt;网络图标开始。</p><div class="lh li lj lk gt ab cb"><figure class="mk ll ml mm mn mo mp paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><img src="../Images/8d319e38b1b2dcb20307d8dfdf9e0c85.png" data-original-src="https://miro.medium.com/v2/resize:fit:1298/format:webp/1*iSV8Bc9KYC2YGt7aF6y07Q.png"/></div></figure><figure class="mk ll mq mm mn mo mp paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><img src="../Images/4138ed7e8b86bebe90daa966c589dfa0.png" data-original-src="https://miro.medium.com/v2/resize:fit:704/format:webp/1*J59-JNyT6crdm8zz-jbcbA.png"/></div></figure></div><p id="a77f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">复制这些以备后用。我们会用这些连接到你的火焰基地。不要在您的存储库上共享或发布这些内容。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi mr"><img src="../Images/24e5ead83a766636ff0e8a4e2095a5da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yrIpgp5HB6ieMQrp0GmLeQ.png"/></div></div></figure><h1 id="d43d" class="ki kj in bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated">步骤5:用Firebase创建Node.js Express应用程序</h1><ul class=""><li id="fd73" class="ms mt in jm b jn lt jr lu jv mu jz mv kd mw kh mx my mz na bi translated">我们将使用Express创建一个Node.js后端来支持我们的API</li><li id="8f9f" class="ms mt in jm b jn nb jr nc jv nd jz ne kd nf kh mx my mz na bi translated">您可能需要Multer(或者一个替代的中间件)从前端的表单数据中获取文件</li><li id="d892" class="ms mt in jm b jn nb jr nc jv nd jz ne kd nf kh mx my mz na bi translated">您需要在项目中设置Firebase和云存储</li><li id="8d59" class="ms mt in jm b jn nb jr nc jv nd jz ne kd nf kh mx my mz na bi translated">您将需要在您的项目中安装以下软件包作为依赖项，因此<strong class="jm io"> npm安装</strong>这些坏小子:</li></ul><pre class="lh li lj lk gt ma mb mc md aw me bi"><span id="1589" class="mf kj in mb b gy mg mh l mi mj"><a class="ae ng" href="http://twitter.com/google" rel="noopener ugc nofollow" target="_blank">@google</a>-cloud/storage": "^5.8.5",<br/>    "body-parser": "^1.19.0",<br/>    "cors": "^2.8.5",<br/>    "dotenv": "^10.0.0",<br/>    "express": "^4.17.1",<br/>    "express-fileupload": "^1.2.1",<br/>    "firebase": "^8.6.8",<br/>    "firebase-admin": "^9.10.0",<br/>    "multer": "^1.4.2",<br/>    "xhr2": "^0.2.1"</span></pre><p id="3a6d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">对于Firebase设置，我们需要从步骤4中获取Firebase配置。</p><p id="2da6" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在一个<strong class="jm io"> config.js文件</strong>中，你可以导出Firebase配置。从第4步中取出firebase钥匙，放在这里。更好的方法是从。env文件(或者您可以直接将它们粘贴到这里——但是如果您在任何地方发布这些文件，这是一个不好的做法..)</p><pre class="lh li lj lk gt ma mb mc md aw me bi"><span id="8d0a" class="mf kj in mb b gy mg mh l mi mj">const {<br/>    API_KEY,<br/>    AUTH_DOMAIN,<br/>    DATABASE_URL,<br/>    PROJECT_ID,<br/>    STORAGE_BUCKET,<br/>    MESSAGING_SENDER_ID,<br/>    APP_ID,<br/>} = process.env;</span><span id="a0f6" class="mf kj in mb b gy nh mh l mi mj">module.exports = {<br/>    firebaseConfig: {<br/>        apiKey: API_KEY,<br/>        authDomain: AUTH_DOMAIN,<br/>        projectId: PROJECT_ID,<br/>        databaseURL: DATABASE_URL,<br/>        storageBucket: STORAGE_BUCKET,<br/>        messagingSenderId: MESSAGING_SENDER_ID,<br/>        appId: APP_ID<br/>    }<br/>}</span></pre><p id="547f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">然后我们可以创建一个<strong class="jm io"> db.js </strong>文件，用从我们的配置文件导入的配置来初始化我们的Firebase应用程序。</p><pre class="lh li lj lk gt ma mb mc md aw me bi"><span id="fab6" class="mf kj in mb b gy mg mh l mi mj">// Requiring firebase (as our db)<br/><strong class="mb io">const firebase = require('firebase');</strong></span><span id="fccc" class="mf kj in mb b gy nh mh l mi mj">// Importing our configuration to initialize our app<br/>const config = require('./config');</span><span id="49e8" class="mf kj in mb b gy nh mh l mi mj">// Creates and initializes a Firebase app instance. Pass options as param<br/><strong class="mb io">const db = firebase.initializeApp(config.firebaseConfig);</strong></span><span id="2c0b" class="mf kj in mb b gy nh mh l mi mj">module.exports = db;</span></pre><p id="a914" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在我们可以在应用程序的其他部分使用Firebase，就像这样</p><pre class="lh li lj lk gt ma mb mc md aw me bi"><span id="ca5b" class="mf kj in mb b gy mg mh l mi mj"><strong class="mb io">const firebase = require(‘../db’); // reference to our db</strong></span></pre><p id="84a7" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">因此，在您的<strong class="jm io"> index.js </strong>文件中，让我们用基本配置来配置我们的express应用程序，并在我们的RestAPI中设置一条路线。</p><pre class="lh li lj lk gt ma mb mc md aw me bi"><span id="c480" class="mf kj in mb b gy mg mh l mi mj">'use strict';</span><span id="34e3" class="mf kj in mb b gy nh mh l mi mj">const express = require('express');<br/>const cors = require('cors');<br/>const imageRoute = require('./routes/image-route');</span><span id="7f4b" class="mf kj in mb b gy nh mh l mi mj">// import our current configuration<br/>const config = require('./config');</span><span id="6a8e" class="mf kj in mb b gy nh mh l mi mj">// set up our app using express<br/>const app = express();</span><span id="9a54" class="mf kj in mb b gy nh mh l mi mj">// express setup<br/>app.use(express.json());<br/>app.use(cors());<br/>app.use(express.urlencoded({ extended: true }));</span><span id="3d5a" class="mf kj in mb b gy nh mh l mi mj">// routes (for uploading images to storage)<br/>app.use('/api', imageRoute.routes)</span><span id="0aa5" class="mf kj in mb b gy nh mh l mi mj">app.listen(config.port, () =&gt; {<br/>console.log ("app is listening on port:", config.port);<br/>})</span></pre><p id="9190" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">您需要指定上传图像的发布路径。您还需要在您的请求中将Multer配置为中间件，以使文件对您可用。</p><p id="8589" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">例如，在一个<strong class="jm io"> image-route.js文件中:</strong></p><pre class="lh li lj lk gt ma mb mc md aw me bi"><span id="4df6" class="mf kj in mb b gy mg mh l mi mj">const express = require('express');<br/><strong class="mb io">const multer = require('multer');</strong></span><span id="e8f8" class="mf kj in mb b gy nh mh l mi mj">const {<br/> addImage<br/>} = require('../controllers/imagesController');</span><span id="938c" class="mf kj in mb b gy nh mh l mi mj">const router = express.<strong class="mb io">Router</strong>();</span><span id="a94a" class="mf kj in mb b gy nh mh l mi mj"><em class="ni">// Setting up multer as a middleware to grab photo uploads<br/></em><strong class="mb io">const storage = multer.memoryStorage();<br/>const upload = multer({ storage: storage }).single('file');</strong></span><span id="d875" class="mf kj in mb b gy nh mh l mi mj"><em class="ni">// POST - Add Image to Cloud Storage<br/></em><strong class="mb io">router.post('/upload', upload, addImage);</strong></span><span id="ca71" class="mf kj in mb b gy nh mh l mi mj">module.exports = {</span><span id="da04" class="mf kj in mb b gy nh mh l mi mj">  routes: router</span><span id="d96f" class="mf kj in mb b gy nh mh l mi mj">}</span></pre><p id="0923" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">然后在您的<strong class="jm io"> controller.js文件</strong>中，您将实际更新存储并返回下载URL，如果成功的话。</p><ul class=""><li id="bd8b" class="ms mt in jm b jn jo jr js jv nj jz nk kd nl kh mx my mz na bi translated">首先，您需要firebase和Firebase存储</li><li id="7a96" class="ms mt in jm b jn nb jr nc jv nd jz ne kd nf kh mx my mz na bi translated">使用<strong class="jm io"> firebase.storage()创建对存储的引用。ref() </strong></li><li id="ba48" class="ms mt in jm b jn nb jr nc jv nd jz ne kd nf kh mx my mz na bi translated">使用文件名创建一个引用(作为预备步骤)</li><li id="fc1c" class="ms mt in jm b jn nb jr nc jv nd jz ne kd nf kh mx my mz na bi translated">您将文件缓冲区上传到该引用中(这实际上将它上传到google cloud)</li><li id="1999" class="ms mt in jm b jn nb jr nc jv nd jz ne kd nf kh mx my mz na bi translated">您使用<strong class="jm io"> getDownloadURL()获得下载URL</strong></li></ul><pre class="lh li lj lk gt ma mb mc md aw me bi"><span id="b887" class="mf kj in mb b gy mg mh l mi mj"><strong class="mb io">const firebase = require('../db');  // reference to our db </strong></span><span id="4f59" class="mf kj in mb b gy nh mh l mi mj">const firestore = firebase.firestore(); // if using firestore</span><span id="d46b" class="mf kj in mb b gy nh mh l mi mj"><strong class="mb io">require("firebase/storage"); // must be required for this to work</strong></span><span id="7852" class="mf kj in mb b gy nh mh l mi mj"><strong class="mb io">const storage = firebase.storage().ref(); // create a reference to storage</strong></span><span id="66d1" class="mf kj in mb b gy nh mh l mi mj"><strong class="mb io">global.XMLHttpRequest = require("xhr2"); // must be used to avoid bug</strong></span><span id="da9a" class="mf kj in mb b gy nh mh l mi mj">// Add Image to Storage and return the file path<br/>const addImage = async (req, res) =&gt; {<br/>    try {<br/>        // Grab the file<br/>        const file = req.file;</span><span id="e879" class="mf kj in mb b gy nh mh l mi mj">        // Format the filename<br/>        const timestamp = Date.now();<br/>        const name = file.originalname.split(".")[0];<br/>        const type = file.originalname.split(".")[1];<br/>        const fileName = `${name}_${timestamp}.${type}`;</span><span id="f65c" class="mf kj in mb b gy nh mh l mi mj">         // Step 1. Create reference for file name in cloud storage <br/><strong class="mb io">        const imageRef = storage.child(fileName);</strong></span><span id="9bd1" class="mf kj in mb b gy nh mh l mi mj">        // Step 2. Upload the file in the bucket storage<br/><strong class="mb io">        const snapshot = await imageRef.put(file.buffer);</strong></span><span id="b568" class="mf kj in mb b gy nh mh l mi mj">        // Step 3. Grab the public url<br/><strong class="mb io">        const downloadURL = await snapshot.ref.getDownloadURL();<br/></strong>        <br/>        res.send(downloadURL);</span><span id="a0a8" class="mf kj in mb b gy nh mh l mi mj">     }  catch (error) {<br/>        console.log (error)<br/>        res.status(400).send(error.message);<br/>    }<br/>}</span><span id="df51" class="mf kj in mb b gy nh mh l mi mj">module.exports = {<br/>    addImage<br/>}</span></pre><p id="f888" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这应该就是你所需要的！希望这是有帮助的。如需进一步阅读，请参阅官方文档:</p><p id="d5e1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><a class="ae ng" href="https://firebase.google.com/docs/storage/web/upload-files#web-v8_1" rel="noopener ugc nofollow" target="_blank">T3【https://firebase . Google . com/docs/storage/web/upload-files # we B- V8 _ 1T5】</a></p><p id="5452" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">哦，如果您想知道前端客户端API调用会是什么样子，这里有一个使用Axios的示例:</p><pre class="lh li lj lk gt ma mb mc md aw me bi"><span id="4314" class="mf kj in mb b gy mg mh l mi mj">// Uploads a single photo to the DB, returns imageURL<br/>  const uploadPhoto = async(photo) =&gt; {<br/>    const imageUploadAPIUrl = `${process.env.REACT_APP_API_SERVER}/api/upload`<br/>    const formData = new FormData();<br/>    let imageUrl = '';<br/>    formData.append('file', photo);<br/>    try {<br/>      const response = await axios.post(imageUploadAPIUrl, formData);<br/>      imageUrl = response.data;<br/>    } catch(error) {<br/>      console.error (error);<br/>    }<br/>    return imageUrl;<br/>  }</span></pre><p id="534f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><em class="ni">更多内容请看</em><a class="ae ng" href="http://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><strong class="jm io"><em class="ni">plain English . io</em></strong></a></p></div></div>    
</body>
</html>