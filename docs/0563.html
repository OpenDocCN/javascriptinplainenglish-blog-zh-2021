<html>
<head>
<title>How To Deploy Your Node.js App On AWS With NGINX And SSL</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用NGINX和SSL在AWS上部署Node.js应用程序</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/how-to-deploy-your-node-js-application-on-aws-with-nginx-ssl-and-custom-domain-6c64e0841cfb?source=collection_archive---------5-----------------------#2021-02-03">https://javascript.plainenglish.io/how-to-deploy-your-node-js-application-on-aws-with-nginx-ssl-and-custom-domain-6c64e0841cfb?source=collection_archive---------5-----------------------#2021-02-03</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/3c32d1f1ed549317213a7d44efe4af8a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*va56A8vwMRoL_PzOdoH6ZA.jpeg"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@billjelen?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Bill Jelen</a> on <a class="ae kc" href="https://unsplash.com/s/photos/spacex?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="ce93" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本教程中，我们将简要回顾在<strong class="kf ir"> AWS EC2实例</strong>上部署<strong class="kf ir">Node.js/Express</strong>应用程序的过程。让我们面对现实吧，服务器配置和应用程序部署可能是一项繁琐的任务。作为一名开发人员，你可能不知道网络安全的每一个细节，或者反向代理和负载平衡是如何工作的。第一次部署应用程序时，我浏览了大量关于堆栈溢出的信息和各种博客帖子。如果有一个循序渐进的指南来部署您的应用程序不是很好吗？我问自己。这个问题让我写了这篇博文。</p><p id="c7ec" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，我们将涵盖:</p><ol class=""><li id="2107" class="lb lc iq kf b kg kh kk kl ko ld ks le kw lf la lg lh li lj bi translated">EC2实例的配置(即网络配置、端口等)</li><li id="6ec7" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">为反向代理安装和配置<strong class="kf ir"> Nginx </strong></li><li id="53ff" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">将EC2指向自定义域(可选)</li><li id="2853" class="lb lc iq kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated">使用<strong class="kf ir"> LetsEncrypt SSL </strong>保护我们的网站</li></ol><p id="a975" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您正在使用其他云提供商，如Azure、Google Cloud Platform、IBM或Digital ocean，您也可以遵循这些步骤。</p><h1 id="eae6" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">EC2实例的配置</h1><p id="7259" class="pw-post-body-paragraph kd ke iq kf b kg mn ki kj kk mo km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">首先，我们需要创建一个虚拟机。为此，我们将转到AWS控制台，并从服务中选择EC2，如下图所示。</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ms"><img src="../Images/ef8d52180154de6088a8339246b3b3df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yGh4gPwUaAVCsAvbnZuQCQ.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">pick EC2 from AWS console</figcaption></figure><p id="8e50" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这将带您到EC2仪表板。在这里，您可以通过单击“启动实例”按钮来选择创建一个新的EC2实例。</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mx"><img src="../Images/72066f33b5d00f3a3045f04dcf50df3b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JmeR6xhwiWkk7Vhvn79zBQ.png"/></div></div></figure><p id="4bdf" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您可以选择在您的实例上运行哪个操作系统。我将使用ubuntu 20.04。</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi my"><img src="../Images/ea8a24a38340125153eea3af72a43c82.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AwqDCMYuJ0_eocvUv0EyMQ.png"/></div></div></figure><p id="e6f6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">接下来，系统会提示您选择实例类型。这里我将使用免费的<strong class="kf ir"> t2微</strong>实例。</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mz"><img src="../Images/5ef97abd233d485799948735c61d47b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*frzfpBCRm35B7DS8it90-A.png"/></div></div></figure><p id="3c64" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您可以接受步骤3、4和5的默认配置。在步骤6中，您可以选择安全组规则。这里我将选择SSH、HTTP和HTTPS。我也选择自定义TCP端口8000。我们将在8000端口上运行我们的节点应用程序。</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi na"><img src="../Images/6cf8675df55bcfe8bc2b0b7bbce4f239.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H6n4eZZ3-wvSIGU1375-iA.png"/></div></div></figure><p id="8351" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果我们愿意，我们可以在以后更改这些配置，所以如果您搞砸了，请不要担心😅。</p><p id="f3c0" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">创建实例后，继续ssh到您的实例中。我们首先需要设置Node.js本身。我将运行以下命令来获取实例中的节点。</p><pre class="mt mu mv mw gt nb nc nd ne aw nf bi"><span id="a760" class="ng lq iq nc b gy nh ni l nj nk">curl -sL https://deb.nodesource.com/setup_12.x | sudo -E bash -<br/>sudo apt install nodejs<br/><br/>node --version</span></pre><p id="4a5a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一旦我们完成了节点设置，我们就可以克隆我们的存储库并在我们的云实例中运行代码。</p><pre class="mt mu mv mw gt nb nc nd ne aw nf bi"><span id="20db" class="ng lq iq nc b gy nh ni l nj nk">git clone &lt;project_repo&gt;<br/>cd yourproject<br/>npm install<br/>npm start (or whatever your start command)<br/># stop app<br/>ctrl+C</span></pre><p id="06a3" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我正在端口<code class="fe nl nm nn nc b">8000</code>运行我的应用程序。我们可以通过访问公共ip地址和端口来测试我们的应用程序。所以对我来说是`<a class="ae kc" href="http://54.210.195.17:8000/" rel="noopener ugc nofollow" target="_blank"><em class="no">http://54.210.195.17:8000/</em></a><em class="no">`。</em></p><p id="1a67" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">接下来，我们将安装一个名为<code class="fe nl nm nn nc b">pm2</code>的库，这将保持我们的节点应用程序在后台运行。运行以下命令，用pm2启动应用程序。</p><pre class="mt mu mv mw gt nb nc nd ne aw nf bi"><span id="2e3b" class="ng lq iq nc b gy nh ni l nj nk">sudo npm i pm2 -g<br/>pm2 start app </span></pre><p id="367f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这将启动我们的应用程序。我们可以再次访问带有端口的ip地址，并将看到应用程序正在运行。</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div class="gh gi np"><img src="../Images/5e294f3344b52dbc48a1bfd9d9180772.png" data-original-src="https://miro.medium.com/v2/resize:fit:1052/format:webp/1*96aa6sD2Jns1rMumGHFmGw.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">running in browser</figcaption></figure><h1 id="4173" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">设置NGNIX和反向代理</h1><p id="e856" class="pw-post-body-paragraph kd ke iq kf b kg mn ki kj kk mo km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">接下来，我们将设置<strong class="kf ir"> NGNIX </strong>并创建一个反向代理。这将使用默认端口80重定向我们的应用程序。我们还将通过NGNIX服务器添加SSL。</p><p id="ad1c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们运行以下命令来安装<strong class="kf ir"> NGNIX: </strong></p><pre class="mt mu mv mw gt nb nc nd ne aw nf bi"><span id="8548" class="ng lq iq nc b gy nh ni l nj nk">sudo apt install nginx</span></pre><p id="7833" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一旦安装了NGNIX，我们就可以配置它来设置一个反向代理，并将我们的应用程序重定向到端口80。为此，我们必须编辑以下文件</p><p id="837f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe nl nm nn nc b">sudo nano <strong class="kf ir">/etc/nginx/sites-available/default</strong></code></p><pre class="mt mu mv mw gt nb nc nd ne aw nf bi"><span id="fb95" class="ng lq iq nc b gy nh ni l nj nk">server_name yourdomain.com www.yourdomain.com;<br/><br/>    location / {<br/>        proxy_pass <a class="ae kc" href="http://localhost:8000;" rel="noopener ugc nofollow" target="_blank">http://localhost:8000;</a> # your app's port<br/>        proxy_http_version 1.1;<br/>        proxy_set_header Upgrade $http_upgrade;<br/>        proxy_set_header Connection 'upgrade';<br/>        proxy_set_header Host $host;<br/>        proxy_cache_bypass $http_upgrade;<br/>    }</span></pre><p id="75a6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在location部分进行如上所示的更改。现在，如果您正在使用自定义域名，请到您的DNS提供商处添加一个<code class="fe nl nm nn nc b"><strong class="kf ir">A Record</strong></code> <strong class="kf ir"> </strong>，如下所示。</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nq"><img src="../Images/1378e491d9ed5f63d9a60ed6121aec0b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*F3MknBeU_cHR3Br7s2z_1Q.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">A record</figcaption></figure><p id="671a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在目标部分，我们将添加实例的公共IP地址。</p><p id="bb67" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">完成后，跳回你的终端，重启NGNIX。</p><pre class="mt mu mv mw gt nb nc nd ne aw nf bi"><span id="26cf" class="ng lq iq nc b gy nh ni l nj nk"># Restart NGINX<br/>sudo service nginx restart</span></pre><p id="f0c6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您需要给自定义域一些时间来传播。一段时间后，您可以进入您的自定义域，并看到应用程序运行。</p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div class="gh gi nr"><img src="../Images/75dfe4123a69d76a2864e815e9bc33a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1116/format:webp/1*TPDTwNipsKXcIEPuZUK9Zg.png"/></div></figure><h1 id="b926" class="lp lq iq bd lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi mj mk ml mm bi translated">使用<strong class="ak"> SSL加密保护我们的网站</strong></h1><p id="d6b9" class="pw-post-body-paragraph kd ke iq kf b kg mn ki kj kk mo km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">最后，这里剩下的唯一任务是用SSL加密来保护我们的web服务器。我们可以用<strong class="kf ir"> LetsEncrypt </strong>库很容易地做到这一点。</p><p id="135f" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">首先，我们通过运行以下命令安装到<strong class="kf ir"> certbot </strong>包</p><pre class="mt mu mv mw gt nb nc nd ne aw nf bi"><span id="c842" class="ng lq iq nc b gy nh ni l nj nk">sudo add-apt-repository ppa:certbot/certbot<br/>sudo apt-get update<br/>sudo apt-get install python3-certbot-nginx</span></pre><p id="188c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">安装完成后，我们将使用certbot cli为我们生成一个SSL证书。运行以下命令，并在提示生成SSL证书时提供您的电子邮件信息。</p><p id="ad87" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe nl nm nn nc b">sudo certbot --nginx -d yourdomain.com -d <a class="ae kc" href="http://www.yourdomain.com" rel="noopener ugc nofollow" target="_blank">www.yourdomain.com</a></code></p><p id="cf95" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">生成证书后，您应该能够通过<strong class="kf ir"> <em class="no"> https连接到您的应用程序。</em> </strong></p><figure class="mt mu mv mw gt jr gh gi paragraph-image"><div class="gh gi ns"><img src="../Images/44c0b807896d2ef078164d729a063425.png" data-original-src="https://miro.medium.com/v2/resize:fit:758/format:webp/1*mZz_4sYx0jTmoAVPJJCWvQ.png"/></div></figure><p id="f8df" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">就是这样。现在，您有了一个在EC2实例中运行的安全web应用程序。👏</p></div></div>    
</body>
</html>