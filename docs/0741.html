<html>
<head>
<title>Handling common JavaScript issues when using Timezone</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用时区时处理常见的JavaScript问题</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/handling-common-javascript-problems-when-using-timezone-76e419aee6e?source=collection_archive---------2-----------------------#2021-02-15">https://javascript.plainenglish.io/handling-common-javascript-problems-when-using-timezone-76e419aee6e?source=collection_archive---------2-----------------------#2021-02-15</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="14cd" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">我用JavaScript，Moment.js和PostgreSQL实现日历预约系统后的心得。</h2></div><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi kc"><img src="../Images/dfb5a791a746e15a9473aa6a9b596abb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KuVocc2M2PD1fZPaHtxCdA.png"/></div></div></figure><p id="9f68" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">自从我继承并完成一个Javascript预订系统项目已经有一年了，但是在这段时间里它一直给人惊喜。在这篇文章中，我想和你分享一些处理日期时应该考虑的最佳实践。</p><p id="01c0" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">使用JavaScript日期时可能遇到的3个主要问题是时区、UTC和DST，让我们仔细看看每个问题。</p><h2 id="8f64" class="lk ll in bd lm ln lo dn lp lq lr dp ls kx lt lu lv lb lw lx ly lf lz ma mb mc bi translated"><strong class="ak">常见时区问题</strong></h2><p id="5dbe" class="pw-post-body-paragraph ko kp in kq b kr md jo kt ku me jr kw kx mf kz la lb mg ld le lf mh lh li lj ig bi translated">输出您所在时区的日期似乎非常简单。然而，可能第一个问题会出现在这个项目上:<strong class="kq io">我应该保存用户时区的日期吗？</strong>所以，这取决于你的项目，但我的建议是<strong class="kq io">永远不要用用户的时区保存日期。我发现总是将日期转换成UTC并将转换后的值保存到数据库中是一个好习惯。还要确保在数据库中有一个单独的列来存储事件<strong class="kq io">时区</strong>(在我的例子中，它是创建事件的用户的时区)。从数据库中提取UTC约会日期时，将此日期转换回事件本地时区，例如:</strong></p><pre class="kd ke kf kg gt mi mj mk ml aw mm bi"><span id="0607" class="lk ll in mj b gy mn mo l mp mq">//good<br/>moment().utc().format(); // Convert date into UTC and save value<br/>moment.tz('2021-02-13T05:31:18Z', 'America/New_York').format(); // Convert back to user's timezone and display on frontend</span></pre><h2 id="9186" class="lk ll in bd lm ln lo dn lp lq lr dp ls kx lt lu lv lb lw lx ly lf lz ma mb mc bi translated"><strong class="ak">UTC常见问题—“时间旅行”</strong></h2><p id="dc3e" class="pw-post-body-paragraph ko kp in kq b kr md jo kt ku me jr kw kx mf kz la lb mg ld le lf mh lh li lj ig bi translated">我很确定你有这样的情况，当你在晚上8点或9点后在线提交订单或申请时，你会看到提交日期显示为明天的日期。我们内部称之为<strong class="kq io">“时间旅行”</strong>问题。如果您执行以下操作，通常会出现此问题:</p><ol class=""><li id="2869" class="mr ms in kq b kr ks ku kv kx mt lb mu lf mv lj mw mx my mz bi translated">将数据库中的UTC日期保存为<code class="fe na nb nc mj b">YYYY-MM-DD</code>，而不是在<code class="fe na nb nc mj b">UTC</code>中保存完整的时间戳。例如</li></ol><pre class="kd ke kf kg gt mi mj mk ml aw mm bi"><span id="f11b" class="lk ll in mj b gy mn mo l mp mq">// wrong<br/>'2021-02-13'</span><span id="4b49" class="lk ll in mj b gy nd mo l mp mq">// good<br/>'2021-02-13T05:31:18Z'</span></pre><p id="5585" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">如果您将时间戳转换为<code class="fe na nb nc mj b">UTC</code>，并且只获得<code class="fe na nb nc mj b">date</code>部分，而没有<code class="fe na nb nc mj b">time</code> ( <code class="fe na nb nc mj b">YYYY-MM-DD</code>)，则日期将变为第二天(+1天偏移)，这将导致错误的日期插入数据库，例如尝试<code class="fe na nb nc mj b">console.log()</code>这样:</p><pre class="kd ke kf kg gt mi mj mk ml aw mm bi"><span id="a1ec" class="lk ll in mj b gy mn mo l mp mq">// bad<br/>moment('2021-02-13T19:15:18-05:00').utc().format('YYYY-MM-DD');<br/>// output will be '2021-02-14' instead of '2021-02-13' we can see +1 day offset</span><span id="6c71" class="lk ll in mj b gy nd mo l mp mq">// good<br/>moment('2021-02-13T19:15:18-05:00').utc().format();</span></pre><p id="5995" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">2.另一个用例是，如果您以UTC格式保存完整的时间戳，但是当从数据库读取时，您截断了时间部分(通常在前端)。结果将与上一个示例相同，您的日期偏移+ 1天，但是这次错误位于您的前端环境中。</p><p id="8d2b" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated"><strong class="kq io">解决方案:</strong>总是将带有时间戳的完整日期保存到数据库中，并将<code class="fe na nb nc mj b">UTC</code>日期转换回用户的时区，然后截断<code class="fe na nb nc mj b">time</code>部分，例如:</p><pre class="kd ke kf kg gt mi mj mk ml aw mm bi"><span id="34bc" class="lk ll in mj b gy mn mo l mp mq">// good<br/>moment('2021-02-14T00:27:58Z').tz('America/New_York').format('YYYY-MM-DD'); // output is 2021-02-13 - converted back to user's timezone</span></pre><h2 id="489c" class="lk ll in bd lm ln lo dn lp lq lr dp ls kx lt lu lv lb lw lx ly lf lz ma mb mc bi translated"><strong class="ak">夏令时问题—夏令时</strong></h2><p id="9065" class="pw-post-body-paragraph ko kp in kq b kr md jo kt ku me jr kw kx mf kz la lb mg ld le lf mh lh li lj ig bi translated">我们在没有太多时间进行测试的情况下就上线了，这总是会让你失望。一旦夏令时(进一步夏令时)到来，我们就有一个大问题了。所有定期约会都被推迟了1小时，哎呀。我开始调试，下面是我的发现:</p><p id="b2d1" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated"><strong class="kq io">范围</strong></p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi ne"><img src="../Images/7cc3d1a0ba6ce0c73a52652c2b9ee2ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vMVedpoeQ0b9ftXwsEVY6Q.png"/></div></div><figcaption class="nf ng gj gh gi nh ni bd b be z dk">example of wrong ranges without timestamp</figcaption></figure><p id="0028" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">当我查看数据库时，我意识到<code class="fe na nb nc mj b">startDate</code>和<code class="fe na nb nc mj b">endDate</code>在数据库中被保存为范围<code class="fe na nb nc mj b">repeat_range</code>，但主要问题是它们被保存为没有<code class="fe na nb nc mj b">time</code>的只有<code class="fe na nb nc mj b">date</code>的字符串。然而在另一列中，他们将<code class="fe na nb nc mj b">meeting_time</code>存储为字符串。当我们从数据库中提取数据时，这两个字符串被连接在一起，在不知道实际时区的情况下，DST的变化并不适用于它们，这导致了+-1小时的偏差。为了保持帖子的简短，我将只发布在乞讨时应该做些什么来避免这种情况，而不是经历我采取的所有步骤来修复数据。</p><pre class="kd ke kf kg gt mi mj mk ml aw mm bi"><span id="d51d" class="lk ll in mj b gy mn mo l mp mq">// bad<br/>['2010-01-01','2021-01-01')</span><span id="8d12" class="lk ll in mj b gy nd mo l mp mq">// good<br/>['2010-01-01T14:45:00Z','2021-01-01T15:45:00Z') //<!-- -->yyyy-MM-dd’T’HH:mm:ssZ</span></pre><p id="0166" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated"><strong class="kq io">解决方案</strong>:始终将完整日期与时间戳和时区信息一起保存到数据库中。例如</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi ne"><img src="../Images/871c8a1ff721f799efb3edbd36c34e8b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bN5PZr3WDjlSBkuogU8ktA.png"/></div></div><figcaption class="nf ng gj gh gi nh ni bd b be z dk">we cannot see timezone info here since DBeaver converts automatically into a human readable date</figcaption></figure><h2 id="d092" class="lk ll in bd lm ln lo dn lp lq lr dp ls kx lt lu lv lb lw lx ly lf lz ma mb mc bi translated"><strong class="ak">总结</strong></h2><p id="c2e3" class="pw-post-body-paragraph ko kp in kq b kr md jo kt ku me jr kw kx mf kz la lb mg ld le lf mh lh li lj ig bi translated">我想用一个最佳实践列表来总结这篇文章中的所有要点。如果你同意/不同意他们或者你有类似的问题，请在评论中告诉我。</p><p id="cea6" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated"><strong class="kq io">最佳做法:</strong></p><ul class=""><li id="fd32" class="mr ms in kq b kr ks ku kv kx mt lb mu lf mv lj nj mx my mz bi translated">我强烈建议使用一个<code class="fe na nb nc mj b">UTC</code>时间戳来表示一个特定的时间点。</li><li id="7bc0" class="mr ms in kq b kr nk ku nl kx nm lb nn lf no lj nj mx my mz bi translated">总是存储在数据库用户的时区中，稍后用于以用户的本地时间转换事件。</li><li id="3077" class="mr ms in kq b kr nk ku nl kx nm lb nn lf no lj nj mx my mz bi translated">从不保存没有时间的日期(<code class="fe na nb nc mj b">YYYY-MM-DD</code>)(<code class="fe na nb nc mj b">HH:mm:ss</code>)，使用完整的时间戳<code class="fe na nb nc mj b">yyyy-MM-dd’T’HH:mm:ssZ</code></li><li id="c168" class="mr ms in kq b kr nk ku nl kx nm lb nn lf no lj nj mx my mz bi translated">使用范围时，使用完整的时间戳<code class="fe na nb nc mj b">yyyy-MM-dd’T’HH:mm:ssZ</code>，不要将日期(<code class="fe na nb nc mj b">YYYY-MM-DD</code>和时间(<code class="fe na nb nc mj b">HH:mm:ss</code>)放在不同的列中，以避免<code class="fe na nb nc mj b">DST</code>问题。</li></ul><p id="cdf2" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">即使一开始看起来很有挑战性。我想概述的是保持事情简单，总是使用UTC时间，直到显示给用户之前。</p><p id="51ab" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">黑客快乐！</p></div></div>    
</body>
</html>