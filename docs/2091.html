<html>
<head>
<title>Best Practices for Angular Localization with SSR</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">利用SSR进行角度定位的最佳实践</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/angular-localization-with-ssr-best-practice-ae75f22e2d05?source=collection_archive---------4-----------------------#2021-05-03">https://javascript.plainenglish.io/angular-localization-with-ssr-best-practice-ae75f22e2d05?source=collection_archive---------4-----------------------#2021-05-03</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/fcfd163b2415b507827ad678886dbc49.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9m-99jUn_VEmfkT54ChpeA.png"/></div></div></figure><p id="54a0" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我以前做过许多多语言网站，但当你想在搜索引擎中索引所有的网站，为每种语言建立一个专用链接，并优化加载时间时，事情就变得复杂了。</p><p id="38c2" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">因此，在本文中，我将带您了解如何使用服务器端渲染来管理Angular project中的本地化，并为您提供最佳实践来充分利用它。</p><p id="378b" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">下面是本文将要完成的任务列表</p><ol class=""><li id="ed76" class="kt ku in jx b jy jz kc kd kg kv kk kw ko kx ks ky kz la lb bi translated">创建一个新项目，并向其中添加服务器端渲染。</li><li id="b4f6" class="kt ku in jx b jy lc kc ld kg le kk lf ko lg ks ky kz la lb bi translated">用两个简单的模块和一个头文件初始化项目(使用bootstrap)。</li><li id="e591" class="kt ku in jx b jy lc kc ld kg le kk lf ko lg ks ky kz la lb bi translated">添加<a class="ae lh" href="http://@gilsdav/ngx-translate-router" rel="noopener ugc nofollow" target="_blank"> ngx-translate </a>并翻译内容。</li><li id="82d9" class="kt ku in jx b jy lc kc ld kg le kk lf ko lg ks ky kz la lb bi translated">添加更多语言。</li><li id="eb0a" class="kt ku in jx b jy lc kc ld kg le kk lf ko lg ks ky kz la lb bi translated">使用传输状态修复应用程序闪烁，这也将优化加载时间。</li><li id="f3de" class="kt ku in jx b jy lc kc ld kg le kk lf ko lg ks ky kz la lb bi translated">添加<a class="ae lh" href="https://www.npmjs.com/package/@gilsdav/ngx-translate-router" rel="noopener ugc nofollow" target="_blank"> ngx-translate-router </a>以保存所选语言，并为每种语言提供专用路径。</li><li id="0c0c" class="kt ku in jx b jy lc kc ld kg le kk lf ko lg ks ky kz la lb bi translated">RTL支持(仅当您想要支持的语言之一是RTL时)</li></ol><h1 id="26d3" class="li lj in bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated"><strong class="ak"> 1。创建一个新项目并添加服务器端渲染</strong></h1><p id="86f1" class="pw-post-body-paragraph jv jw in jx b jy mg ka kb kc mh ke kf kg mi ki kj kk mj km kn ko mk kq kr ks ig bi translated">通常用<code class="fe ml mm mn mo b">ng new</code> <em class="mp">创建一个新的角度项目。</em>以下是我的回答:</p><pre class="mq mr ms mt gt mu mo mv mw aw mx bi"><span id="dfc2" class="my lj in mo b gy mz na l nb nc">&gt; ng new<br/>? What name would you like to use for the new workspace and initial project? angular-localization<br/>? Do you want to enforce stricter type checking and stricter bundle budgets in the workspace?<br/>  This setting helps improve maintainability and catch bugs ahead of time.<br/>  For more information, see <a class="ae lh" href="https://angular.io/strict" rel="noopener ugc nofollow" target="_blank">https://angular.io/strict</a> Yes<br/>? Would you like to add Angular routing? Yes<br/>? Which stylesheet format would you like to use? SCSS [ <a class="ae lh" href="https://sass-lang.com/documentation/syntax#scss" rel="noopener ugc nofollow" target="_blank">https://sass-lang.com/documentation/syntax#scss</a> ]</span></pre><p id="5878" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">然后添加SSR，如下所示:</p><pre class="mq mr ms mt gt mu mo mv mw aw mx bi"><span id="1538" class="my lj in mo b gy mz na l nb nc">ng add @nguniversal/express-engine</span></pre><p id="f4f4" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">为了验证一切正常，运行<code class="fe ml mm mn mo b">npm run dev:ssr</code>并在它加载后，在浏览器中打开它，确保它在工作并转到源代码<code class="fe ml mm mn mo b">view-source:<a class="ae lh" href="http://localhost:4200/ar/home" rel="noopener ugc nofollow" target="_blank">http://localhost:4200</a></code>。然后确保内容被加载，如下图所示</p><figure class="mq mr ms mt gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nd"><img src="../Images/3841f360d9caa688aadd7a6e38705889.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9PAlBkKWB6VBFqZW8-Intw.png"/></div></div><figcaption class="ne nf gj gh gi ng nh bd b be z dk">left is before SSR, right is after SSR</figcaption></figure><h1 id="7f38" class="li lj in bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated"><strong class="ak"> 2。用简单的两个模块和一个头文件(使用引导程序)初始化项目</strong></h1><p id="07b4" class="pw-post-body-paragraph jv jw in jx b jy mg ka kb kc mh ke kf kg mi ki kj kk mj km kn ko mk kq kr ks ig bi translated">然后，我们应该创建两个新的简单模拟模块和一个共享模块，并将它们导入其中。</p><p id="6c2f" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">运行以下命令来生成它们:</p><pre class="mq mr ms mt gt mu mo mv mw aw mx bi"><span id="b955" class="my lj in mo b gy mz na l nb nc">ng g m shared<br/>ng g m home --route=home -m=app<br/>ng g m feature --route=feature -m=app</span></pre><p id="bf01" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这将创建3个模块，共享，家庭和功能，最后两个将添加一个组件，路由到它和懒惰加载应用程序路由模块的模块。</p><p id="661b" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我们只需要确保空的路线能回到家。以下是<code class="fe ml mm mn mo b">app-routing.module.ts</code>中的最后一张路线图:</p><pre class="mq mr ms mt gt mu mo mv mw aw mx bi"><span id="3d64" class="my lj in mo b gy mz na l nb nc">const <strong class="mo io"><em class="mp">routes</em></strong>: Routes = [<br/>  {<br/>    path: '',<br/>    redirectTo: 'home',<br/>    pathMatch: 'full',<br/>  },<br/>  {<br/>    path: 'home',<br/>    loadChildren: () =&gt; import('./home/home.module').then(m =&gt; m.HomeModule),<br/>  },<br/>  {<br/>    path: 'feature',<br/>    loadChildren: () =&gt; import('./feature/feature.module').then(m =&gt; m.FeatureModule),<br/>  },<br/>];</span></pre><p id="0b65" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">然后，我们应该只添加一个简单的标题，为此我使用自举。</p><p id="dab9" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">首先，我们需要安装<code class="fe ml mm mn mo b">ngx-bootstrap</code>和<code class="fe ml mm mn mo b">bootstrap</code>(这里将使用<code class="fe ml mm mn mo b">@next</code>安装Bootstrap 5以支持RTL，如果你不关心RTL，你可以只安装Bootstrap 4)。</p><pre class="mq mr ms mt gt mu mo mv mw aw mx bi"><span id="0142" class="my lj in mo b gy mz na l nb nc">npm i bootstrap@next ngx-bootstrap</span></pre><p id="7380" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">然后修改<code class="fe ml mm mn mo b">angular.json</code>添加引导CSS文件。它应该是这样的(请注意，我们将它包含在构建和测试中):</p><pre class="mq mr ms mt gt mu mo mv mw aw mx bi"><span id="a74d" class="my lj in mo b gy mz na l nb nc">"styles": [<br/><strong class="mo io">  "node_modules/bootstrap/dist/css/bootstrap.min.css",<br/></strong>  "src/styles.scss"<br/>]</span></pre><p id="7beb" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在<code class="fe ml mm mn mo b">app.module.ts</code>中，将<code class="fe ml mm mn mo b">CollapseModule</code>和<code class="fe ml mm mn mo b">BrowserAnimationsModule</code>(collapse module所需)添加到其导入数组中，如下所示:</p><pre class="mq mr ms mt gt mu mo mv mw aw mx bi"><span id="3650" class="my lj in mo b gy mz na l nb nc">imports: [<br/>  BrowserModule.withServerTransition({appId: 'serverApp'}),<br/>  AppRoutingModule,<br/><strong class="mo io">  BrowserAnimationsModule,<br/>  CollapseModule.forRoot(),</strong><br/>],</span></pre><p id="cdc7" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">对于头组件，使用</p><pre class="mq mr ms mt gt mu mo mv mw aw mx bi"><span id="40a2" class="my lj in mo b gy mz na l nb nc">ng g c core/components/header</span></pre><p id="7f2c" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我使用了下面的HTML代码，但是任何代码都可以工作，没有问题:</p><pre class="mq mr ms mt gt mu mo mv mw aw mx bi"><span id="71f4" class="my lj in mo b gy mz na l nb nc">&lt;nav class="navbar navbar-expand-lg navbar-light bg-light"&gt;<br/>  &lt;div class="container"&gt;<br/>    &lt;a [routerLink]="'/home'" class="navbar-brand"&gt;Localize&lt;/a&gt;<br/>    &lt;button<br/>      (click)="isCollapsed = !isCollapsed"<br/>      [attr.aria-expanded]="!isCollapsed"<br/>      aria-controls="navbarSupportedContent"<br/>      aria-label="Toggle navigation"<br/>      class="navbar-toggler"<br/>      type="button"&gt;<br/>      &lt;span class="navbar-toggler-icon"&gt;&lt;/span&gt;<br/>    &lt;/button&gt;<br/>    &lt;div [collapse]="isCollapsed" [isAnimated]="true" class="collapse navbar-collapse" id="navbarSupportedContent"&gt;<br/>      &lt;ul class="navbar-nav"&gt;<br/>        &lt;li class="nav-item"&gt;<br/>          &lt;a<br/>            [routerLinkActiveOptions]="{exact: true}"<br/>            [routerLink]="'/home'"<br/>            aria-current="page"<br/>            class="nav-link"<br/>            routerLinkActive="active"&gt;homepage&lt;/a&gt;<br/>        &lt;/li&gt;<br/><br/>        &lt;li class="nav-item"&gt;<br/>          &lt;a<br/>            [routerLinkActiveOptions]="{exact: true}"<br/>            [routerLink]="'/feature'"<br/>            class="nav-link"<br/>            routerLinkActive="active"&gt;feature&lt;/a&gt;<br/>        &lt;/li&gt;<br/>      &lt;/ul&gt;<br/>    &lt;/div&gt;<br/>  &lt;/div&gt;<br/>&lt;/nav&gt;</span></pre><p id="ee5b" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">对于TS，我只是添加了这一行<code class="fe ml mm mn mo b">isCollapsed = true;</code>。</p><p id="d5ea" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">对于<code class="fe ml mm mn mo b">app.component.html</code>，我删除了初始代码并添加了标题。现在是这样的:</p><pre class="mq mr ms mt gt mu mo mv mw aw mx bi"><span id="89e8" class="my lj in mo b gy mz na l nb nc">&lt;app-header&gt;&lt;/app-header&gt;<br/>&lt;div class="container"&gt;<br/>  &lt;router-outlet&gt;&lt;/router-outlet&gt;<br/>&lt;/div&gt;</span></pre><p id="4db0" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">通过检查导航栏中的路由是否在模块之间导航来测试一切是否正常</p><h2 id="8684" class="my lj in bd lk ni nj dn lo nk nl dp ls kg nm nn lw kk no np ma ko nq nr me ns bi translated"><strong class="ak"> 3 .添加ngx-翻译并翻译内容</strong></h2><p id="d4aa" class="pw-post-body-paragraph jv jw in jx b jy mg ka kb kc mh ke kf kg mi ki kj kk mj km kn ko mk kq kr ks ig bi translated">我们将从添加<code class="fe ml mm mn mo b">ngx-translate</code>作为依赖项开始:</p><pre class="mq mr ms mt gt mu mo mv mw aw mx bi"><span id="3f2f" class="my lj in mo b gy mz na l nb nc">npm i @ngx-translate/core @ngx-translate/http-loader</span></pre><p id="ae8b" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在资产中添加一个名为<code class="fe ml mm mn mo b">i18n</code>的文件夹和一个你现在使用的每种语言的文件，我会用这个添加<code class="fe ml mm mn mo b">en.json</code>。</p><pre class="mq mr ms mt gt mu mo mv mw aw mx bi"><span id="a853" class="my lj in mo b gy mz na l nb nc">{<br/>  "HOMEPAGE_WORKS": "homepage works",<br/>  "FEATURE_WORKS": "feature works",<br/>  "HOMEPAGE": "homepage",<br/>  "FEATURE": "feature"<br/>}</span></pre><p id="2362" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">然后开始使用类似<code class="fe ml mm mn mo b">{{'HOMEPAGE' | translate}}</code>的翻译管道翻译内容，其中<code class="fe ml mm mn mo b">HOMEPAGE</code>是JSON中的键，用它在每种语言中的值替换，我们将在所有的HTML文件中这样做。</p><p id="948a" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">然后我们将在<code class="fe ml mm mn mo b">AppModule</code>和<code class="fe ml mm mn mo b">AppServerModule</code>中添加<code class="fe ml mm mn mo b">TranslateModule</code>，但是我们将为每个添加自定义加载器，在<code class="fe ml mm mn mo b">AppModule</code>中它将使用HTTP请求，在<code class="fe ml mm mn mo b">AppServerModule</code>中它将使用节点fs来加载它。</p><p id="3382" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我更喜欢将文件添加到一个新的文件夹<code class="fe ml mm mn mo b">src/app/core/utils</code>中，但是你可以随意将它们添加到任何地方。</p><p id="0376" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">以下是每一个的加载程序:</p><p id="5920" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><code class="fe ml mm mn mo b">translate-browser.loader.ts</code></p><pre class="mq mr ms mt gt mu mo mv mw aw mx bi"><span id="a665" class="my lj in mo b gy mz na l nb nc">import { Observable } from 'rxjs';<br/>import { TranslateLoader } from '@ngx-translate/core';<br/>import { TranslateHttpLoader } from '@ngx-translate/http-loader';<br/>import { HttpClient } from '@angular/common/http';<br/><br/>export class TranslateBrowserLoader implements TranslateLoader {<br/>  constructor(<br/>    private http: HttpClient,<br/>  ) {<br/>  }<br/><br/>  public getTranslation(lang: string): Observable&lt;unknown&gt; {<br/>    return new TranslateHttpLoader(this.http).getTranslation(lang);<br/>  }<br/>}<br/><br/>export function translateBrowserLoaderFactory(<br/>  httpClient: HttpClient,<br/>): TranslateBrowserLoader {<br/>  return new TranslateBrowserLoader(httpClient);<br/>}</span></pre><p id="45b2" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">translate-server.loader.ts</p><pre class="mq mr ms mt gt mu mo mv mw aw mx bi"><span id="fe70" class="my lj in mo b gy mz na l nb nc">import { join } from 'path';<br/>import { Observable } from 'rxjs';<br/>import { TranslateLoader } from '@ngx-translate/core';<br/>import * as fs from 'fs';<br/><br/>export class TranslateServerLoader implements TranslateLoader {<br/>  constructor(<br/>    private prefix: string = 'i18n',<br/>    private suffix: string = '.json',<br/>  ) {<br/>  }<br/><br/>  public getTranslation(lang: string): Observable&lt;any&gt; {<br/>    return new Observable((observer) =&gt; {<br/>      const assetsFolder = join(<br/>        <strong class="mo io"><em class="mp">process</em></strong>.cwd(),<br/>        'dist',<br/>        'localize', // Your project name here<br/>        'browser',<br/>        'assets',<br/>        this.prefix,<br/>      );<br/><br/>      const jsonData = <strong class="mo io"><em class="mp">JSON</em></strong>.parse(<br/>        fs.readFileSync(`${assetsFolder}/${lang}${this.suffix}`, 'utf8'),<br/>      );<br/><br/>      observer.next(jsonData);<br/>      observer.complete();<br/>    });<br/>  }<br/>}<br/><br/>export function translateServerLoaderFactory(): TranslateLoader {<br/>  return new TranslateServerLoader();<br/>}</span></pre><p id="5ee1" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">然后在<code class="fe ml mm mn mo b">AppModule</code>导入里面这样使用它</p><pre class="mq mr ms mt gt mu mo mv mw aw mx bi"><span id="d80f" class="my lj in mo b gy mz na l nb nc">TranslateModule.forRoot({<br/>  defaultLanguage: 'en',<br/>  loader: {<br/>    provide: TranslateLoader,<br/>    useFactory: translateBrowserLoaderFactory,<br/>    deps: [HttpClient]<br/>  }<br/>}),</span></pre><p id="ae7b" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">也不要忘记导入<code class="fe ml mm mn mo b">HttpClientModule</code>。</p><p id="5647" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">然后在<code class="fe ml mm mn mo b">AppServerModule</code>导入里面添加</p><pre class="mq mr ms mt gt mu mo mv mw aw mx bi"><span id="5968" class="my lj in mo b gy mz na l nb nc">TranslateModule.forRoot({<br/>  defaultLanguage: 'en',<br/>  loader: {<br/>    provide: TranslateLoader,<br/>    useFactory: translateServerLoaderFactory,<br/>    deps: []<br/>  }<br/>}),</span></pre><p id="d1b1" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">最后，进出口<code class="fe ml mm mn mo b">TranslateModule</code>中的<code class="fe ml mm mn mo b">SharedModule</code></p><p id="3856" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">为了验证到目前为止一切都很好，确保所有的单词都被正确翻译了，例如，主页显示“主页工作！”而不是“主页_工作！”</p><h1 id="6e6f" class="li lj in bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated"><strong class="ak"> 4 .添加更多语言</strong></h1><p id="a6ab" class="pw-post-body-paragraph jv jw in jx b jy mg ka kb kc mh ke kf kg mi ki kj kk mj km kn ko mk kq kr ks ig bi translated">现在我将添加另外两种语言阿拉伯语(RTL)和法语，并将向您展示如何在它们之间切换。</p><p id="fa4c" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">首先，你需要在头中给它们添加一个切换链接。</p><p id="ead8" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">首先，我将使头TS文件像这样(新增加的粗体)。</p><pre class="mq mr ms mt gt mu mo mv mw aw mx bi"><span id="fed0" class="my lj in mo b gy mz na l nb nc">import { Component, OnInit } from '@angular/core';<br/><strong class="mo io">import { TranslateService } from '@ngx-translate/core';<br/></strong><br/>@Component({<br/>  selector: 'app-header',<br/>  templateUrl: './header.component.html',<br/>  styleUrls: ['./header.component.scss']<br/>})<br/>export class HeaderComponent implements OnInit {<br/>  isCollapsed = true;<br/><strong class="mo io">  locales = ['en', 'fr', 'ar'];<br/></strong><br/>  constructor(<br/><strong class="mo io">    private translateService: TranslateService,<br/></strong>  ) { }<br/><br/>  ngOnInit(): void {<br/>  }<br/><br/><strong class="mo io">  changeLanguage(locale: string): void {<br/>    this.translateService.use(locale);<br/>  }</strong><br/>}</span></pre><p id="7834" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">然后，我将把HTML改为</p><pre class="mq mr ms mt gt mu mo mv mw aw mx bi"><span id="5852" class="my lj in mo b gy mz na l nb nc">&lt;nav class="navbar navbar-expand-lg navbar-light bg-light"&gt;<br/>  &lt;div class="container"&gt;<br/>    &lt;a [routerLink]="'/home'" class="navbar-brand"&gt;Localize&lt;/a&gt;<br/>    &lt;button<br/>      (click)="isCollapsed = !isCollapsed"<br/>      [attr.aria-expanded]="!isCollapsed"<br/>      aria-controls="navbarSupportedContent"<br/>      aria-label="Toggle navigation"<br/>      class="navbar-toggler"<br/>      type="button"&gt;<br/>      &lt;span class="navbar-toggler-icon"&gt;&lt;/span&gt;<br/>    &lt;/button&gt;<br/>    &lt;div [collapse]="isCollapsed" [isAnimated]="true" class="collapse navbar-collapse" id="navbarSupportedContent"&gt;<br/>      &lt;ul class="navbar-nav"&gt;<br/>        &lt;li class="nav-item"&gt;<br/>          &lt;a<br/>            [routerLinkActiveOptions]="{exact: true}"<br/>            [routerLink]="'/home'"<br/>            aria-current="page"<br/>            class="nav-link"<br/>            routerLinkActive="active"&gt;{{'HOMEPAGE' | translate}}&lt;/a&gt;<br/>        &lt;/li&gt;<br/><br/>        &lt;li class="nav-item"&gt;<br/>          &lt;a<br/>            [routerLinkActiveOptions]="{exact: true}"<br/>            [routerLink]="'/feature'"<br/>            class="nav-link"<br/>            routerLinkActive="active"&gt;{{'FEATURE' | translate}}&lt;/a&gt;<br/>        &lt;/li&gt;<br/>      &lt;/ul&gt;<br/><br/><strong class="mo io">      &lt;ul class="navbar-nav language-dropdown"&gt;<br/>        &lt;li class="nav-item dropdown" dropdown&gt;<br/>          &lt;a<br/>            aria-expanded="false"<br/>            class="nav-link dropdown-toggle"<br/>            data-bs-toggle="dropdown"<br/>            dropdownToggle<br/>            id="navbarDropdown"<br/>            role="button"&gt;<br/>            {{'CHANGE_LANGUAGE' | translate}}<br/>          &lt;/a&gt;<br/>          &lt;ul *dropdownMenu aria-labelledby="navbarDropdown" class="dropdown-menu"&gt;<br/>            &lt;li *ngFor="let locale of locales"&gt;<br/>              &lt;a<br/>                class="dropdown-item"<br/>                role="button"<br/>                (click)="changeLanguage(locale)"<br/>                &gt;<br/>                {{locale}}<br/>              &lt;/a&gt;<br/>            &lt;/li&gt;<br/>          &lt;/ul&gt;</strong><br/>        &lt;/li&gt;<br/>      &lt;/ul&gt;<br/>    &lt;/div&gt;<br/>  &lt;/div&gt;<br/>&lt;/nav&gt;</span></pre><p id="6099" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我将添加这个简单的SCSS代码来制作右侧的语言菜单。</p><pre class="mq mr ms mt gt mu mo mv mw aw mx bi"><span id="d758" class="my lj in mo b gy mz na l nb nc">.language-dropdown {<br/>  margin-left: auto;<br/>}</span></pre><p id="d81b" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">然后，我将在<code class="fe ml mm mn mo b">en.json</code>文件中添加<code class="fe ml mm mn mo b">"CHANGE_LANGUAGE": "change language"</code>，并为每种语言添加一个新文件:</p><p id="ff87" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><code class="fe ml mm mn mo b">fr.json</code></p><pre class="mq mr ms mt gt mu mo mv mw aw mx bi"><span id="8d21" class="my lj in mo b gy mz na l nb nc">{<br/>  "HOMEPAGE": "page d'accueil",<br/>  "FEATURE": "FONCTIONNALITÉ",<br/>  "HOMEPAGE_WORKS": "page d'accueil fonctionne",<br/>  "FEATURE_WORKS": "fonctionnalité fonctionne",<br/>  "CHANGE_LANGUAGE": "changer de langue"<br/>}</span></pre><p id="a6e4" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><code class="fe ml mm mn mo b">ar.json</code></p><pre class="mq mr ms mt gt mu mo mv mw aw mx bi"><span id="444c" class="my lj in mo b gy mz na l nb nc">{<br/>  "HOMEPAGE": "الصفحة الرئيسية",<br/>  "FEATURE": "ميزة",<br/>  "HOMEPAGE_WORKS": "الصفحة الرئيسية تشتغل",<br/>  "FEATURE_WORKS": "الميزة تشتغل",<br/>  "CHANGE_LANGUAGE": "غير اللغة"<br/>}</span></pre><p id="9ae7" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">最后，在<code class="fe ml mm mn mo b">AppModule</code>导入数组中添加<code class="fe ml mm mn mo b">BsDropdownModule.forRoot()</code>。</p><p id="e805" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">现在，当你点击另一种语言，它应该加载网站在其中。如果是这样的话，哇哦！您已成功将本地化添加到您的应用程序中。</p><p id="4ddb" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">当网站运行时，你一定注意到了3个问题:</p><ol class=""><li id="66a1" class="kt ku in jx b jy jz kc kd kg kv kk kw ko kx ks ky kz la lb bi translated">应用程序加载后闪烁</li><li id="7e59" class="kt ku in jx b jy lc kc ld kg le kk lf ko lg ks ky kz la lb bi translated">当你刷新页面时，它总是返回到英文</li><li id="17bf" class="kt ku in jx b jy lc kc ld kg le kk lf ko lg ks ky kz la lb bi translated">对于阿拉伯语，网站以LTR显示</li></ol><p id="8d07" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这些是我接下来要解决的问题。</p><h1 id="c410" class="li lj in bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated"><strong class="ak"> 5。使用传输状态修复应用程序闪烁；这也将优化加载时间。</strong></h1><p id="7c9a" class="pw-post-body-paragraph jv jw in jx b jy mg ka kb kc mh ke kf kg mi ki kj kk mj km kn ko mk kq kr ks ig bi translated">TL；DR:使网站闪烁的核心问题是因为在SSR中内容被正确地呈现为静态HTML，但是当Angular在浏览器中启动时，它用交互式内容替换静态HTML内容，但是为了工作，translate pipe需要像<code class="fe ml mm mn mo b">en.json</code>这样的翻译文件，并且在文件加载之前内容将是空的。然后内容再次返回</p><p id="a1d6" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">解决方案:</strong>解决方案<strong class="jx io"> </strong>就是避免等待HTTP请求到<code class="fe ml mm mn mo b">en.json</code>文件，发送带有SSR内容的翻译文件。</p><p id="77f6" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">虽然这看起来是一项复杂的任务，但谢天谢地Angular有一个内置的解决方案，那就是<code class="fe ml mm mn mo b">ServerTransferStateModule</code>，一旦你在<code class="fe ml mm mn mo b">AppServerModule</code>中导入了它，再次转到SSR内容的源代码，你会注意到添加了如下图所示的带有空对象的脚本:</p><figure class="mq mr ms mt gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nd"><img src="../Images/b140440d9736b584113ecfa1d320ef00.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VbGqQwXauA17WBlNyWboJQ.png"/></div></div><figcaption class="ne nf gj gh gi ng nh bd b be z dk">at left after adding the module, at right before</figcaption></figure><p id="21e2" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">现在让我们用翻译的数据填充这个对象。为此，我们将使用<code class="fe ml mm mn mo b">TransferState</code>服务:</p><p id="f405" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">首先，将<code class="fe ml mm mn mo b">app.server.module.ts</code>编辑为:</p><pre class="mq mr ms mt gt mu mo mv mw aw mx bi"><span id="6ba9" class="my lj in mo b gy mz na l nb nc">import { NgModule } from '@angular/core';<br/>import { ServerModule<strong class="mo io">, ServerTransferStateModule </strong>} from '@angular/platform-server';<br/>import { AppModule } from './app.module';<br/>import { AppComponent } from './app.component';<br/>import { TranslateLoader, TranslateModule } from '@ngx-translate/core';<br/>import { translateServerLoaderFactory } from './core/utils/translate-server.loader';<br/><strong class="mo io">import { TransferState } from '@angular/platform-browser';<br/></strong><br/>@NgModule({<br/>  imports: [<br/>    AppModule,<br/>    ServerModule,<br/><strong class="mo io">    ServerTransferStateModule,<br/></strong>    TranslateModule.forRoot({<br/>      defaultLanguage: 'en',<br/>      loader: {<br/>        provide: TranslateLoader,<br/>        useFactory: translateServerLoaderFactory,<br/>        deps: [<strong class="mo io">TransferState</strong>]<br/>      }<br/>    }),<br/>  ],<br/>  bootstrap: [AppComponent],<br/>})<br/>export class AppServerModule {}</span></pre><p id="c166" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">然后将<code class="fe ml mm mn mo b">translate-server.loader.ts</code>修改为</p><pre class="mq mr ms mt gt mu mo mv mw aw mx bi"><span id="aefe" class="my lj in mo b gy mz na l nb nc">import { join } from 'path';<br/>import { Observable } from 'rxjs';<br/>import { TranslateLoader } from '@ngx-translate/core';<br/>import * as fs from 'fs';<br/><strong class="mo io">import { makeStateKey, StateKey, TransferState } from '@angular/platform-browser';<br/></strong><br/>export class TranslateServerLoader implements TranslateLoader {<br/>  constructor(<br/><strong class="mo io">    private transferState: TransferState,<br/></strong>    private prefix: string = 'i18n',<br/>    private suffix: string = '.json',<br/>  ) {<br/>  }<br/><br/>  public getTranslation(lang: string): Observable&lt;any&gt; {<br/>    return new Observable((observer) =&gt; {<br/>      const assetsFolder = join(<br/>        <strong class="mo io"><em class="mp">process</em></strong>.cwd(),<br/>        'dist',<br/>        'localize', // Your project name here<br/>        'browser',<br/>        'assets',<br/>        this.prefix,<br/>      );<br/><br/>      const jsonData = <strong class="mo io"><em class="mp">JSON</em></strong>.parse(<br/>        fs.readFileSync(`${assetsFolder}/${lang}${this.suffix}`, 'utf8'),<br/>      );<br/><br/><strong class="mo io">      // Here we save the translations in the transfer-state<br/>      const key: StateKey&lt;number&gt; = makeStateKey&lt;number&gt;(<br/>        'transfer-translate-' + lang,<br/>      );<br/>      this.transferState.set(key, jsonData);</strong><br/><br/>      observer.next(jsonData);<br/>      observer.complete();<br/>    });<br/>  }<br/>}<br/><br/>export function translateServerLoaderFactory(<strong class="mo io">transferState: TransferState</strong>): TranslateLoader {<br/>  return new TranslateServerLoader(<strong class="mo io">transferState</strong>);<br/>}</span></pre><p id="eeb5" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">现在，让我们保存并再次查看源代码的内容</p><figure class="mq mr ms mt gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nd"><img src="../Images/a1deaeb178cd51f6bda45ae38f9e3d9b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ecmOjO4z8F8Ey72ThmrDgA.png"/></div></div></figure><p id="8c29" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">如您所见，翻译数据现在与我们的SSR一起返回，但我们仍然没有使用它。</p><p id="951a" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">现在让我们将<code class="fe ml mm mn mo b">app.module.ts</code>修改为:</p><pre class="mq mr ms mt gt mu mo mv mw aw mx bi"><span id="1d28" class="my lj in mo b gy mz na l nb nc">import { NgModule } from '@angular/core';<br/>import { BrowserModule, <strong class="mo io">BrowserTransferStateModule, TransferState</strong> } from '@angular/platform-browser';<br/>import { AppRoutingModule } from './app-routing.module';<br/>import { AppComponent } from './app.component';<br/>import { HeaderComponent } from './core/components/header/header.component';<br/>import { CollapseModule } from 'ngx-bootstrap/collapse';<br/>import { BrowserAnimationsModule } from '@angular/platform-browser/animations';<br/>import { TranslateLoader, TranslateModule } from '@ngx-translate/core';<br/>import { HttpClient, HttpClientModule } from '@angular/common/http';<br/>import { translateBrowserLoaderFactory } from './core/utils/translate-browser.loader';<br/>import { BsDropdownModule } from 'ngx-bootstrap/dropdown';<br/><br/>@NgModule({<br/>  declarations: [<br/>    AppComponent,<br/>    HeaderComponent<br/>  ],<br/>  imports: [<br/>    BrowserModule.withServerTransition({appId: 'serverApp'}),<br/>    AppRoutingModule,<br/>    BrowserAnimationsModule,<br/>    HttpClientModule,<br/><strong class="mo io">    BrowserTransferStateModule,<br/></strong>    CollapseModule.forRoot(),<br/>    BsDropdownModule.forRoot(),<br/>    TranslateModule.forRoot({<br/>      defaultLanguage: 'en',<br/>      loader: {<br/>        provide: TranslateLoader,<br/>        useFactory: translateBrowserLoaderFactory,<br/>        deps: [HttpClient<strong class="mo io">, TransferState</strong>]<br/>      }<br/>    }),<br/>  ],<br/>  providers: [],<br/>  bootstrap: [AppComponent]<br/>})<br/>export class AppModule { }</span></pre><p id="ac97" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">为了向我们的<code class="fe ml mm mn mo b">translate-browser.loader.ts</code>提供<code class="fe ml mm mn mo b">TransferState</code>服务，请这样做:</p><pre class="mq mr ms mt gt mu mo mv mw aw mx bi"><span id="e4d3" class="my lj in mo b gy mz na l nb nc">import { Observable } from 'rxjs';<br/>import { TranslateLoader } from '@ngx-translate/core';<br/>import { TranslateHttpLoader } from '@ngx-translate/http-loader';<br/>import { HttpClient } from '@angular/common/http';<br/><strong class="mo io">import { makeStateKey, StateKey, TransferState } from '@angular/platform-browser';<br/></strong><br/>export class TranslateBrowserLoader implements TranslateLoader {<br/>  constructor(<br/>    private http: HttpClient,<br/><strong class="mo io">    private transferState: TransferState,<br/></strong>  ) {<br/>  }<br/><br/>  public getTranslation(lang: string): Observable&lt;unknown&gt; {<br/><strong class="mo io">    const key: StateKey&lt;number&gt; = makeStateKey&lt;number&gt;(<br/>      'transfer-translate-' + lang,<br/>    );<br/>    const data = this.transferState.get(key, null);<br/><br/>    // if none found, http load as fallback<br/>    if (data) {<br/>      return new Observable((observer) =&gt; {<br/>        observer.next(data);<br/>        observer.complete();<br/>      });<br/>    } else {</strong><br/>      return new TranslateHttpLoader(this.http).getTranslation(lang);<br/><strong class="mo io">    }<br/></strong>  }<br/>}<br/><br/>export function translateBrowserLoaderFactory(<br/>  httpClient: HttpClient,<br/><strong class="mo io">  transferState: TransferState,<br/></strong>): TranslateBrowserLoader {<br/>  return new TranslateBrowserLoader(httpClient<strong class="mo io">, transferState</strong>);<br/>}</span></pre><p id="1cea" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">要再次检查问题是否不再存在，您可以检查浏览器上的网络选项卡，您不会发现对<code class="fe ml mm mn mo b">en.json</code>文件的任何请求。</p><h1 id="e23a" class="li lj in bd lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf bi translated"><strong class="ak"> 6 .添加ngx-translate-router以保存所选语言，并为每种语言指定一条专用路径。</strong></h1><p id="7c45" class="pw-post-body-paragraph jv jw in jx b jy mg ka kb kc mh ke kf kg mi ki kj kk mj km kn ko mk kq kr ks ig bi translated">现在我们面临的另一个问题是，当我们改变语言时，我们的新语言选择不会被保存，一旦刷新，用户会再次得到我们在<code class="fe ml mm mn mo b">AppModule</code>中定义的默认语言。</p><p id="d19b" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">虽然这个问题有很多解决方案，但我更喜欢使用ngx-translate-router，因为它可以处理很多现成的内容，当人们互相共享页面或将其保存为书签，或者甚至将其发送到他们的另一台设备时，发现它没有打开他正在阅读的同一种语言时，为每个内容创建一个专用链接是很重要的。</p><p id="b3a7" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这个问题到此为止，让我们专注于解决方案。</p><p id="aeb7" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">您需要做的第一件事是使用以下命令将其作为依赖项安装:</p><pre class="mq mr ms mt gt mu mo mv mw aw mx bi"><span id="27e6" class="my lj in mo b gy mz na l nb nc">npm i @gilsdav/ngx-translate-router @gilsdav/ngx-translate-router-http-loader</span></pre><p id="976f" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">然后，我们将创建一个名为<code class="fe ml mm mn mo b">locales.json</code>的文件，包含以下内容</p><pre class="mq mr ms mt gt mu mo mv mw aw mx bi"><span id="c146" class="my lj in mo b gy mz na l nb nc">{<br/>  "locales": [<br/>    "en",<br/>    "ar",<br/>    "fr"<br/>  ],<br/>  "prefix": "ROUTES."<br/>}</span></pre><p id="7ba8" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">然后，我们将在翻译加载器文件旁边创建两个新的加载器</p><p id="96b4" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><code class="fe ml mm mn mo b">localize-server.loader.ts</code></p><pre class="mq mr ms mt gt mu mo mv mw aw mx bi"><span id="fd63" class="my lj in mo b gy mz na l nb nc">import { LocalizeParser, LocalizeRouterSettings } from '@gilsdav/ngx-translate-router';<br/>import { Routes } from '@angular/router';<br/>import * as fs from 'fs';<br/>import { TranslateService } from '@ngx-translate/core';<br/>import { Location } from '@angular/common';<br/>import { join } from 'path';<br/>import { makeStateKey, StateKey, TransferState } from '@angular/platform-browser';<br/><br/>export class LocalizeServerLoader extends LocalizeParser {<br/><br/>  isLoaded = false;<br/>  constructor(<br/>    translate: TranslateService,<br/>    location: Location,<br/>    settings: LocalizeRouterSettings,<br/>    private transferState: TransferState,<br/>  ) {<br/>    super(translate, location, settings);<br/>  }<br/><br/>  <em class="mp">/**<br/>   * Gets config from the server<br/>   */<br/>  </em>public load(routes: Routes): Promise&lt;any&gt; {<br/>    // this because we load LocalizeRouterModule with forRoot twice once in AppModule and another in AppServerModule<br/>    // so this will be called twice, so we need to ignore the second one<br/>    if (this.isLoaded) {<br/>      return <strong class="mo io"><em class="mp">Promise</em></strong>.resolve();<br/>    } else {<br/>      this.isLoaded = true;<br/>    }<br/>    return new <strong class="mo io"><em class="mp">Promise</em></strong>((resolve: any) =&gt; {<br/>      const assetsFolder = join(<br/>        <strong class="mo io"><em class="mp">process</em></strong>.cwd(),<br/>        'dist',<br/>        'localize', // Your project name here<br/>        'browser',<br/>        'assets',<br/>        'locales.json',<br/>      );<br/>      const data: any = <strong class="mo io"><em class="mp">JSON</em></strong>.parse(fs.readFileSync(assetsFolder, 'utf8'));<br/><br/>      // Here we save the locales in the transfer-state<br/>      const key: StateKey&lt;number&gt; = makeStateKey&lt;number&gt;(<br/>        'transfer-locales',<br/>      );<br/>      this.transferState.set(key, data);<br/><br/>      this.locales = data.locales;<br/>      this.prefix = data.prefix;<br/>      this.init(routes).then(resolve);<br/>    });<br/>  }<br/>}<br/><br/>export function localizeServerLoaderFactory(<br/>  translate: TranslateService,<br/>  location: Location,<br/>  settings: LocalizeRouterSettings,<br/>  transferState: TransferState,<br/>): LocalizeServerLoader {<br/>  return new LocalizeServerLoader(translate, location, settings, transferState);<br/>}</span></pre><p id="9faf" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><code class="fe ml mm mn mo b">localize-browser.loader.ts</code></p><pre class="mq mr ms mt gt mu mo mv mw aw mx bi"><span id="45a8" class="my lj in mo b gy mz na l nb nc">import { LocalizeParser, LocalizeRouterSettings } from '@gilsdav/ngx-translate-router';<br/>import { Routes } from '@angular/router';<br/>import { TranslateService } from '@ngx-translate/core';<br/>import { Location } from '@angular/common';<br/>import { HttpClient } from '@angular/common/http';<br/>import { makeStateKey, StateKey, TransferState } from '@angular/platform-browser';<br/>import { LocalizeRouterHttpLoader } from '@gilsdav/ngx-translate-router-http-loader';<br/><br/>export class LocalizeBrowserLoader extends LocalizeParser {<br/>  private translateService: TranslateService;<br/>  private LocalLocation: Location;<br/>  private localizeRouterSettings: LocalizeRouterSettings;<br/><br/>  constructor(<br/>    translateService: TranslateService,<br/>    location: Location,<br/>    settings: LocalizeRouterSettings,<br/>    private data: any,<br/>  ) {<br/>    super(translateService, location, settings);<br/>    this.translateService = translateService;<br/>    this.LocalLocation = location;<br/>    this.localizeRouterSettings = settings;<br/>  }<br/><br/>  public load(routes: Routes): Promise&lt;any&gt; {<br/>    return new <strong class="mo io"><em class="mp">Promise</em></strong>((resolve: any) =&gt; {<br/>      this.locales = this.data.locales;<br/>      this.prefix = this.data.prefix;<br/>      this.init(routes).then(resolve);<br/>    });<br/>  }<br/>}<br/><br/>export function localizeBrowserLoaderFactory(<br/>  translate: TranslateService,<br/>  location: Location,<br/>  settings: LocalizeRouterSettings,<br/>  httpClient: HttpClient,<br/>  transferState: TransferState,<br/>): LocalizeParser {<br/>  const key: StateKey&lt;number&gt; = makeStateKey&lt;number&gt;(<br/>    'transfer-locales',<br/>  );<br/>  const data = transferState.get(key, null);<br/>  if (data) {<br/>    return new LocalizeBrowserLoader(translate, location, settings, data);<br/>  } else {<br/>    return new LocalizeRouterHttpLoader(<br/>      translate,<br/>      location,<br/>      settings,<br/>      httpClient,<br/>    );<br/>  }<br/>}</span></pre><p id="8e36" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">导入前的最后一步是修改<code class="fe ml mm mn mo b">app-routing.module.ts</code>使其在导入<code class="fe ml mm mn mo b">LocalizeRouterModule</code>时根据需要导出<code class="fe ml mm mn mo b"><strong class="jx io"><em class="mp">routes</em></strong></code> <strong class="jx io"> <em class="mp"> </em> </strong>。并将initialNavigation选项设置为禁用，因为initialNavigation将由模块处理。现在是这样的:</p><pre class="mq mr ms mt gt mu mo mv mw aw mx bi"><span id="f8b0" class="my lj in mo b gy mz na l nb nc">import { NgModule } from '@angular/core';<br/>import { RouterModule, Routes } from '@angular/router';<br/><br/><strong class="mo io">export </strong>const <strong class="mo io"><em class="mp">routes</em></strong>: Routes = [<br/>  {path: '', redirectTo: 'home', pathMatch: 'full'},<br/>  {path: 'home', loadChildren: () =&gt; import('./home/home.module').then(m =&gt; m.HomeModule)},<br/>  {path: 'feature', loadChildren: () =&gt; import('./feature/feature.module').then(m =&gt; m.FeatureModule)},<br/>];<br/><br/>@NgModule({<br/>  imports: [RouterModule.forRoot(<strong class="mo io"><em class="mp">routes</em></strong>, {<br/>    initialNavigation: '<strong class="mo io">disabled</strong>',<br/>  })],<br/>  exports: [RouterModule],<br/>})<br/>export class AppRoutingModule {<br/>}</span></pre><p id="0ecf" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">然后我们将使用<code class="fe ml mm mn mo b">app.server.module.ts</code>内部的这个加载器导入模块，如下所示:</p><pre class="mq mr ms mt gt mu mo mv mw aw mx bi"><span id="f91c" class="my lj in mo b gy mz na l nb nc">LocalizeRouterModule.forRoot(routes, {<br/>  parser: {<br/>    provide: LocalizeParser,<br/>    useFactory: localizeServerLoaderFactory,<br/>    deps: [TranslateService, Location, LocalizeRouterSettings, TransferState],<br/>  },<br/>  initialNavigation: true,<br/>}),</span></pre><p id="6073" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><code class="fe ml mm mn mo b">app.module.ts</code>里面是这样的:</p><pre class="mq mr ms mt gt mu mo mv mw aw mx bi"><span id="a897" class="my lj in mo b gy mz na l nb nc">LocalizeRouterModule.forRoot(routes, {<br/>  parser: {<br/>    provide: LocalizeParser,<br/>    useFactory: localizeBrowserLoaderFactory,<br/>    deps: [TranslateService, Location, LocalizeRouterSettings, HttpClient, TransferState],<br/>  },<br/>  initialNavigation: true,<br/>}),</span></pre><p id="6065" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">但是一定要添加<code class="fe ml mm mn mo b">import { Location } from ‘@angular/common’;</code>，因为IDE可能不会自动导入它。</p><p id="67eb" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">现在一切都好了。但是你会发现所有的链接都不起作用(因为它应该到<code class="fe ml mm mn mo b">en/home</code>或者<code class="fe ml mm mn mo b">ar/home</code>而不仅仅是<code class="fe ml mm mn mo b">home</code>)。为了解决这个问题，我们需要在所有绝对路由上调用<code class="fe ml mm mn mo b">localize</code>管道，在路由的起点添加当前区域设置，并在区域设置改变时更新它。</p><p id="20ea" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">此外，你会发现改变语言并不会改变网址，刷新加载我们的默认设置。为了解决这个问题，我们将使语言成为锚标记，以指向另一种语言的当前URL，本地化模块将自动重新加载翻译，因此不再需要调用<code class="fe ml mm mn mo b">this.translateService.use(locale);</code>。</p><p id="88c3" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">下面是标题TS的完整代码:</p><pre class="mq mr ms mt gt mu mo mv mw aw mx bi"><span id="8fbc" class="my lj in mo b gy mz na l nb nc">import { Component, OnInit } from '@angular/core';<br/><strong class="mo io">import { LocalizeRouterService } from '@gilsdav/ngx-translate-router';<br/>import { NavigationEnd, Router } from '@angular/router';<br/>import { filter } from 'rxjs/operators';<br/></strong><br/>@Component({<br/>  selector: 'app-header',<br/>  templateUrl: './header.component.html',<br/>  styleUrls: ['./header.component.scss']<br/>})<br/>export class HeaderComponent implements OnInit {<br/>  isCollapsed = true;<br/><strong class="mo io">  locales = this.localizeRouterService.parser.locales;<br/>  currentUrl = '';<br/></strong><br/>  constructor(<br/><strong class="mo io">    private localizeRouterService: LocalizeRouterService,<br/>    private router: Router,<br/></strong>  ) { }<br/><br/>  ngOnInit(): void {<br/><strong class="mo io">    this.setCurrentUrl();<br/><br/>    this.router.events.pipe(<br/>      filter(event =&gt; event instanceof NavigationEnd),<br/>    ).subscribe(() =&gt; {<br/>      this.setCurrentUrl();<br/>    });<br/></strong>  }<br/><br/><strong class="mo io">  private setCurrentUrl(): void {<br/>    this.currentUrl = this.router.url<br/>      .replace('/' + this.localizeRouterService.parser.currentLang, '')<br/>      .split('?')[0];<br/>  }</strong><br/>}</span></pre><p id="7d45" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">和它的HTML now:</p><pre class="mq mr ms mt gt mu mo mv mw aw mx bi"><span id="32b4" class="my lj in mo b gy mz na l nb nc">&lt;nav class="navbar navbar-expand-lg navbar-light bg-light"&gt;<br/>  &lt;div class="container"&gt;<br/>    &lt;a [routerLink]="'/home' <strong class="mo io">| localize</strong>" class="navbar-brand"&gt;Localize&lt;/a&gt;<br/>    &lt;button<br/>      (click)="isCollapsed = !isCollapsed"<br/>      [attr.aria-expanded]="!isCollapsed"<br/>      aria-controls="navbarSupportedContent"<br/>      aria-label="Toggle navigation"<br/>      class="navbar-toggler"<br/>      type="button"&gt;<br/>      &lt;span class="navbar-toggler-icon"&gt;&lt;/span&gt;<br/>    &lt;/button&gt;<br/>    &lt;div [collapse]="isCollapsed" [isAnimated]="true" class="collapse navbar-collapse" id="navbarSupportedContent"&gt;<br/>      &lt;ul class="navbar-nav"&gt;<br/>        &lt;li class="nav-item"&gt;<br/>          &lt;a<br/>            [routerLinkActiveOptions]="{exact: true}"<br/>            [routerLink]="'/home' <strong class="mo io">| localize</strong>"<br/>            aria-current="page"<br/>            class="nav-link"<br/>            routerLinkActive="active"&gt;{{'HOMEPAGE' | translate}}&lt;/a&gt;<br/>        &lt;/li&gt;<br/><br/>        &lt;li class="nav-item"&gt;<br/>          &lt;a<br/>            [routerLinkActiveOptions]="{exact: true}"<br/>            [routerLink]="'/feature'<strong class="mo io"> | localize</strong>"<br/>            class="nav-link"<br/>            routerLinkActive="active"&gt;{{'FEATURE' | translate}}&lt;/a&gt;<br/>        &lt;/li&gt;<br/>      &lt;/ul&gt;<br/><br/>      &lt;ul class="navbar-nav language-dropdown"&gt;<br/>        &lt;li class="nav-item dropdown" dropdown&gt;<br/>          &lt;a<br/>            aria-expanded="false"<br/>            class="nav-link dropdown-toggle"<br/>            data-bs-toggle="dropdown"<br/>            dropdownToggle<br/>            id="navbarDropdown"<br/>            role="button"&gt;<br/>            {{'CHANGE_LANGUAGE' | translate}}<br/>          &lt;/a&gt;<br/>          &lt;ul <em class="mp">*dropdownMenu </em>aria-labelledby="navbarDropdown" class="dropdown-menu"&gt;<br/>            &lt;li <em class="mp">*ngFor</em>="let locale of locales"&gt;<br/>              &lt;a<br/>                class="dropdown-item"<br/><strong class="mo io">                queryParamsHandling="merge"<br/>                routerLink="/{{locale}}/{{currentUrl}}"<br/>                routerLinkActive="active"&gt;<br/></strong>                {{locale}}<br/>              &lt;/a&gt;<br/>            &lt;/li&gt;<br/>          &lt;/ul&gt;<br/>        &lt;/li&gt;<br/>      &lt;/ul&gt;<br/>    &lt;/div&gt;<br/>  &lt;/div&gt;<br/>&lt;/nav&gt;</span></pre><p id="601b" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">还有wohoo！我们终于完成了。</p><p id="e28c" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">现在当你刷新的时候，它应该会保留你选择的语言，即使我们把它从URL中移除，直接进入<a class="ae lh" href="http://localhost:4200/" rel="noopener ugc nofollow" target="_blank"> http://localhost:4200/ </a>，打开<a class="ae lh" href="http://localhost:4200/ar/home" rel="noopener ugc nofollow" target="_blank">http://localhost:4200/ar/home</a>应该会打开阿拉伯语的home。</p><h2 id="2e46" class="my lj in bd lk ni nj dn lo nk nl dp ls kg nm nn lw kk no np ma ko nq nr me ns bi translated"><strong class="ak"> 7。RTL支持</strong></h2><p id="2b64" class="pw-post-body-paragraph jv jw in jx b jy mg ka kb kc mh ke kf kg mi ki kj kk mj km kn ko mk kq kr ks ig bi translated">这是这篇长文的最后一部分。如果您使用的语言都不是RTL语，您可以放心地忽略这一部分。如果没有，这一部分将对你非常重要</p><p id="ab9f" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">现在，您应该还记得我提到过使用Bootstrap 5来支持RTL，在这里我们将从它开始。</p><p id="36c0" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">转到<code class="fe ml mm mn mo b">angular.json</code>并将样式列表更新成这样(但这次只在构建中):</p><pre class="mq mr ms mt gt mu mo mv mw aw mx bi"><span id="d0b4" class="my lj in mo b gy mz na l nb nc">"styles": [<br/>  {<br/>    "input": "node_modules/bootstrap/dist/css/bootstrap.rtl.min.css",<br/>    "inject": false<br/>  },<br/>  {<br/>    "input": "node_modules/bootstrap/dist/css/bootstrap.min.css",<br/>    "inject": false<br/>  },<br/>  "src/styles.scss"<br/>],</span></pre><p id="eecf" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这将告诉Angular编译器将这些文件复制到dist，但不会对它们做任何事情。我们将选择在运行时使用哪一个。</p><p id="b91d" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">然后，为了确定哪个地区是RTL，哪个不是，我将在翻译文件中添加一个名为<code class="fe ml mm mn mo b">DIR</code>的新键来保存<code class="fe ml mm mn mo b">rtl</code>或<code class="fe ml mm mn mo b">rtl</code>。有很多方法可以确定这一点，但在我们的例子中，在<code class="fe ml mm mn mo b">ar.json</code>中是<code class="fe ml mm mn mo b">rtl</code>，而在另外两个中是<code class="fe ml mm mn mo b">ltr</code>。</p><p id="a50e" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">然后，我们需要根据<code class="fe ml mm mn mo b">DIR</code>来查看要加载哪些文件，还要将本机<code class="fe ml mm mn mo b">html</code>标签中的<code class="fe ml mm mn mo b">dir</code>设置为正确的值，我们将在<code class="fe ml mm mn mo b">app.component.ts</code>中处理所有这些。</p><pre class="mq mr ms mt gt mu mo mv mw aw mx bi"><span id="df95" class="my lj in mo b gy mz na l nb nc">import { Component, Inject } from '@angular/core';<br/>import { DOCUMENT } from '@angular/common';<br/>import { TranslateService } from '@ngx-translate/core';<br/><br/>@Component({<br/>  selector: 'app-root',<br/>  templateUrl: './app.component.html',<br/>  styleUrls: ['./app.component.scss']<br/>})<br/>export class AppComponent {<br/>  constructor(<br/>    private translateService: TranslateService,<br/>    @Inject(DOCUMENT) private document: Document,<br/>  ) {<br/>    this.translateService.stream('DIR').subscribe(dir =&gt; {<br/>      this.directionChanged(dir);<br/>    });<br/>  }<br/><br/>  private directionChanged(dir: string): void {<br/>    const htmlTag = this.document.getElementsByTagName('html')[0] as HTMLHtmlElement;<br/>    htmlTag.dir = dir === 'rtl' ? 'rtl' : 'ltr';<br/>    this.changeCssFile(dir);<br/>  }<br/><br/>  private changeCssFile(dir: string): void {<br/>    const headTag = this.document.getElementsByTagName('head')[0] as HTMLHeadElement;<br/>    const existingLink = this.document.getElementById('bootstrap-css') as HTMLLinkElement;<br/>    const bundleName = dir === 'rtl' ? 'bootstrap.rtl.min.css' : 'bootstrap.min.css';<br/><br/>    if (existingLink) {<br/>      existingLink.href = bundleName;<br/>    } else {<br/>      const newLink = this.document.createElement('link');<br/>      newLink.rel = 'stylesheet';<br/>      newLink.id = 'bootstrap-css';<br/>      newLink.href = bundleName;<br/>      headTag.appendChild(newLink);<br/>    }<br/>  }<br/>}</span></pre><p id="50fd" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">您会注意到，更改之后，除了一件小事之外，一切都很好——在阿拉伯语版本中，locale下拉菜单位于菜单的其余部分旁边，您会在实际项目中发现许多类似的情况。</p><p id="add7" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">问题是在RTL的情况下，<code class="fe ml mm mn mo b">header.component.scss</code>中的<code class="fe ml mm mn mo b">margin-left: auto;</code>需要变成<code class="fe ml mm mn mo b">margin-right: auto;</code>。但是如何在Angular中实现呢？</p><p id="5044" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我有一个小技巧来解决这个问题，将整个样式包装在<code class="fe ml mm mn mo b">:host</code>中，然后添加<code class="fe ml mm mn mo b">[dir=rtl] &amp;</code>选择器，并在其中添加RTL样式。例如，<code class="fe ml mm mn mo b">header.component.scss</code>应该是这样的:</p><pre class="mq mr ms mt gt mu mo mv mw aw mx bi"><span id="c702" class="my lj in mo b gy mz na l nb nc">:host {<br/>  .language-dropdown {<br/>    margin-left: auto;<br/><br/>    [dir=rtl] &amp; {<br/>      margin-left: unset;<br/>      margin-right: auto;<br/>    }<br/>  }<br/>}</span></pre><p id="ff92" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">为了理解这是如何工作的，让我们看看生成的CSS代码</p><pre class="mq mr ms mt gt mu mo mv mw aw mx bi"><span id="2b3c" class="my lj in mo b gy mz na l nb nc">[_nghost-serverApp-c22] .language-dropdown[_ngcontent-serverApp-c22] {<br/>  margin-left: auto;<br/>}<br/>[dir=rtl] [_nghost-serverApp-c22] .language-dropdown[_ngcontent-serverApp-c22] {<br/>  margin-left: unset;<br/>  margin-right: auto;<br/>}</span></pre><p id="2ee4" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">你看，<code class="fe ml mm mn mo b">[dir=rtl]</code>没有像其他选择器那样附加<code class="fe ml mm mn mo b">[_ngcontent-serverApp-c22]</code>。那是因为我说那是在<code class="fe ml mm mn mo b">:host</code>选择器之前。</p><p id="5c49" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">为了让它更清楚，让我们试试不带<code class="fe ml mm mn mo b">:host</code>的。</p><pre class="mq mr ms mt gt mu mo mv mw aw mx bi"><span id="75ee" class="my lj in mo b gy mz na l nb nc">.language-dropdown[_ngcontent-serverApp-c22] {<br/>  margin-left: auto;<br/>}<br/>[dir=rtl][_ngcontent-serverApp-c22]   .language-dropdown[_ngcontent-serverApp-c22] {<br/>  margin-left: unset;<br/>  margin-right: auto;<br/>}</span></pre><p id="872b" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">现在你看到<code class="fe ml mm mn mo b">[dir=rtl]</code>被追加了<code class="fe ml mm mn mo b">[_ngcontent-serverApp-c22]</code>，这将使得它总是不匹配任何元素(除非在header组件本身内部有一个带有<code class="fe ml mm mn mo b">dir=rtl</code>的元素)。</p><p id="dd70" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">最后，我们完成了。</p><p id="28d1" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">你可以在我的GitHub资源库中看到整个项目:</p><p id="0de5" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><a class="ae lh" href="https://github.com/robertIsaac/angular-localization" rel="noopener ugc nofollow" target="_blank">https://github.com/robertIsaac/angular-localization</a></p><p id="236d" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">非常感谢您阅读这篇文章。我希望它符合你的期望。如果你有任何反馈，我将非常感谢，因为这是我的第一篇关于媒体的文章。</p><p id="80c3" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><em class="mp">更多内容请看</em><a class="ae lh" href="http://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><em class="mp">plain English . io</em></a></p></div></div>    
</body>
</html>