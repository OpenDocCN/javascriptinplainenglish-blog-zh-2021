<html>
<head>
<title>How to Make Next.js Image Optimization Work on AWS Elastic Beanstalk</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何让Next.js图像优化在AWS弹性豆茎上工作</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/how-to-make-next-js-image-optimization-work-on-aws-elastic-beanstalk-2776ea255eff?source=collection_archive---------5-----------------------#2021-12-07">https://javascript.plainenglish.io/how-to-make-next-js-image-optimization-work-on-aws-elastic-beanstalk-2776ea255eff?source=collection_archive---------5-----------------------#2021-12-07</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="e6f9" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">不使用Vercel，充分利用Next.js应用程序</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/f40a45fb243efb521b9849a31de0f6cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*E5ddqegbPXpgpXmh"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Photo by <a class="ae kv" href="https://unsplash.com/@afgprogrammer?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Mohammad Rahmani</a> on <a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="ca6a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我最近参与了一个大型的<a class="ae kv" href="https://nextjs.org/" rel="noopener ugc nofollow" target="_blank"> Next.js </a>项目，并将其部署到<a class="ae kv" href="https://aws.amazon.com/elasticbeanstalk/" rel="noopener ugc nofollow" target="_blank"> AWS Elastic Beanstalk </a>中。一切工作正常，除了<a class="ae kv" href="https://nextjs.org/docs/basic-features/image-optimization" rel="noopener ugc nofollow" target="_blank"> Next.js图像优化</a>。在网上寻找解决方法时，我意识到这是一个相当普遍的问题。</p><p id="f2bb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">事实上，我了解到许多其他开发人员在使用Next.js图像优化特性时遇到了麻烦。显然，当使用除Vercel之外的平台来部署Next.js应用程序时，这种情况尤其常见。</p><p id="383d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">虽然受欢迎，但几乎没有在线文档。因此，让我们看看如何解决这个问题，并在将Next.js部署到AWS Elastic Beanstalk时使图像优化按预期工作。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="c2f0" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">诊断映像优化问题</h1><p id="ede5" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">要验证Next.js图像优化功能是否如预期的那样工作，请确保使用Next.js内置的<code class="fe mw mx my mz b"><a class="ae kv" href="https://nextjs.org/docs/api-reference/next/image" rel="noopener ugc nofollow" target="_blank">&lt;Image&gt;</a></code>组件，而不是标准的HTML <code class="fe mw mx my mz b">&lt;img&gt;</code>标签。请记住<a class="ae kv" href="https://nextjs.org/blog/next-10#built-in-image-component-and-automatic-image-optimization" rel="noopener ugc nofollow" target="_blank">该特性仅在Next.js 10 </a>中可用。</p><p id="fbc8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后，将您的应用程序部署到AWS Elastic Beanstalk。</p><p id="e25f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，访问一个包含至少一个通过<code class="fe mw mx my mz b">&lt;Image&gt;</code>组件渲染的图像的网页，用浏览器开发工具检查它。您应该能够看到类似这样的内容:</p><pre class="kg kh ki kj gt na mz nb nc aw nd bi"><span id="3e07" class="ne ma iq mz b gy nf ng l nh ni">&lt;img alt="Foo image" src="/_next/image?url=https%3A%2F%2FyourCDN.com%2Ffoo.jpg&amp;w=1920&amp;q=75" decoding="async" data-nimg="intrinsic" style="position: absolute; inset: 0px; box-sizing: border-box; padding: 0px; border: none; margin: auto; display: block; width: 0px; height: 0px; min-width: 100%; max-width: 100%; min-height: 100%; max-height: 100%;" srcset="/_next/image?url=https%3A%2F%2FyourCDN.com%2Ffoo.jpg&amp;w=1080&amp;q=75 1x, /_next/image?url=https%3A%2F%2FyourCDN.com%2Ffoo.jpg&amp;w=1920&amp;q=75 2x"&gt;</span></pre><p id="a0ef" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要确保一切正常，请遵循以下步骤:</p><p id="adde" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">1.通过将您的网站URL与<code class="fe mw mx my mz b">&lt;img&gt;</code>的<code class="fe mw mx my mz b">src</code>属性连接起来，构建转换后的图像URL，如下所示:</p><pre class="kg kh ki kj gt na mz nb nc aw nd bi"><span id="e524" class="ne ma iq mz b gy nf ng l nh ni">https://yourwebsite.com/_next/image?url=https%3A%2F%2FyourCDN.com%2Ffoo.jpg&amp;w=1920&amp;q=75</span></pre><p id="e2b5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">2.提取<code class="fe mw mx my mz b">url</code>查询参数中包含的字符串:</p><pre class="kg kh ki kj gt na mz nb nc aw nd bi"><span id="3d2b" class="ne ma iq mz b gy nf ng l nh ni">https%3A%2F%2FyourCDN.com%2Ffoo.jpg</span></pre><p id="cd54" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">3.解码<a class="ae kv" href="https://meyerweb.com/eric/tools/dencoder/" rel="noopener ugc nofollow" target="_blank">此处</a>获取原图网址:</p><pre class="kg kh ki kj gt na mz nb nc aw nd bi"><span id="0af2" class="ne ma iq mz b gy nf ng l nh ni">https://yourCDN.com/foo.jpg</span></pre><p id="badd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">4.比较步骤1中检索到的图像文件。在3中检索图像文件。如果1。不同于3。，则Next.js图像优化功能将按预期工作。特别是1。应该是<a class="ae kv" href="https://it.wikipedia.org/wiki/WebP" rel="noopener ugc nofollow" target="_blank"> WebP </a>格式(<code class="fe mw mx my mz b">.webp</code>扩展名)并且明显轻于3。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="168f" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">解决Next.js图像优化问题</h1><p id="a806" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">让我们看一下如何在使用AWS Elastic Beanstalk时使用Next.js图像优化特性解决上述问题的分步指南。</p><h2 id="428a" class="ne ma iq bd mb nj nk dn mf nl nm dp mj lf nn no ml lj np nq mn ln nr ns mp nt bi translated">1.将<code class="fe mw mx my mz b">sharp</code>添加到项目的依赖项中</h2><blockquote class="nu nv nw"><p id="7ea4" class="kw kx nx ky b kz la jr lb lc ld ju le ny lg lh li nz lk ll lm oa lo lp lq lr ij bi translated">当在您的生产环境中使用<code class="fe mw mx my mz b">next start</code>时，强烈建议您通过在您的项目目录中运行<code class="fe mw mx my mz b">yarn add sharp</code>来安装<code class="fe mw mx my mz b"><a class="ae kv" href="https://www.npmjs.com/package/sharp" rel="noopener ugc nofollow" target="_blank">sharp</a></code>。这对于Vercel部署来说是不必要的，因为<code class="fe mw mx my mz b">sharp</code>是自动安装的。— <a class="ae kv" href="https://nextjs.org/docs/basic-features/image-optimization" rel="noopener ugc nofollow" target="_blank">下一张/图片</a></p></blockquote><p id="0063" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">正如官方文档中的<a class="ae kv" href="https://nextjs.org/docs/basic-features/image-optimization" rel="noopener ugc nofollow" target="_blank">所述，Next.js映像优化特性依赖于npm <code class="fe mw mx my mz b">sharp</code>库。但这是一个Next.js <code class="fe mw mx my mz b"><a class="ae kv" href="https://docs.npmjs.com/cli/v8/configuring-npm/package-json#optionaldependencies" rel="noopener ugc nofollow" target="_blank">optionalDependency</a></code>可能没有安装。因此，您应该使用以下命令将其显式添加到项目的依赖项中:</a></p><pre class="kg kh ki kj gt na mz nb nc aw nd bi"><span id="4f4b" class="ne ma iq mz b gy nf ng l nh ni">npm install sharp</span></pre><p id="be06" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">或等效物:</p><pre class="kg kh ki kj gt na mz nb nc aw nd bi"><span id="602b" class="ne ma iq mz b gy nf ng l nh ni">yarn add sharp</span></pre><p id="c4e9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，在将应用程序部署到AWS Elastic Beanstalk时，您可能会遇到以下错误消息:</p><pre class="kg kh ki kj gt na mz nb nc aw nd bi"><span id="6ace" class="ne ma iq mz b gy nf ng l nh ni">ERR! sharp EACCES: permission denied, mkdir '/tmp/.npm/_libvips' info sharp Attempting to build from source via node-gyp but this may fail due to the above error info sharp.</span><span id="bafe" class="ne ma iq mz b gy ob ng l nh ni">Please see <a class="ae kv" href="https://sharp.pixelplumbing.com/page/install" rel="noopener ugc nofollow" target="_blank">https://sharp.pixelplumbing.com/page/install</a> for required dependencies</span></pre><p id="a56a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">正如这里的<a class="ae kv" href="https://stackoverflow.com/questions/54996422/installing-sharp-on-elastic-beanstalk" rel="noopener ugc nofollow" target="_blank">所解释的那样</a>，解决方案包括创建一个包含以下行的<code class="fe mw mx my mz b">.npmrc</code>文件:</p><pre class="kg kh ki kj gt na mz nb nc aw nd bi"><span id="3ee7" class="ne ma iq mz b gy nf ng l nh ni">unsafe-perm=true</span></pre><p id="d8e6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">特别是，通过将<code class="fe mw mx my mz b">unsafe-perm</code>设置为<code class="fe mw mx my mz b">true</code>，您将强制npm尝试总是在运行脚本的上下文中运行。换句话说，这个选项强制软件包安装程序永远不要切换当前用户和组。因此，在AWS Elastic Beanstalk的情况下，这意味着npm安装过程将以root用户身份执行。这防止你有任何类型的权限问题，并使<code class="fe mw mx my mz b">sharp</code>安装完美无瑕。</p><h2 id="15e7" class="ne ma iq bd mb nj nk dn mf nl nm dp mj lf nn no ml lj np nq mn ln nr ns mp nt bi translated">2.修复/var/app/current/build/cache/images权限</h2><p id="5e7d" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">安装<code class="fe mw mx my mz b">sharp</code>应该足以解决问题，但是您可能还会遇到另一个问题。具体来说，如果图像优化功能仍然不起作用，请检查您在AWS Elastic Beanstalk上的Next.js应用程序编写的日志。</p><p id="7805" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您可能会无意中发现类似这样的消息:</p><pre class="kg kh ki kj gt na mz nb nc aw nd bi"><span id="13f0" class="ne ma iq mz b gy nf ng l nh ni">Dec  6 15:42:47 ip-VVV-XXX-YYY-ZZZ web: [Error: EACCES: permission denied, mkdir '/var/app/current/build/cache/images'] {<br/>Dec  6 15:42:47 ip-VVV-XXX-YYY-ZZZ web: errno: -13,<br/>Dec  6 15:42:47 ip-VVV-XXX-YYY-ZZZ web: code: 'EACCES',<br/>Dec  6 15:42:47 ip-VVV-XXX-YYY-ZZZ web: syscall: 'mkdir',<br/>Dec  6 15:42:47 ip-VVV-XXX-YYY-ZZZ web: path: '/var/app/current/build/cache/images'<br/>Dec  6 15:42:47 ip-VVV-XXX-YYY-ZZZ web: }</span></pre><p id="6e14" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这意味着Next.js试图在<code class="fe mw mx my mz b">/var/app/current/build/cache/images</code>下创建一个文件夹，但是它没有正确的权限。这其实也是Next.js图像优化功能不起作用的原因。事实上，通过深入研究它是如何工作的，你会了解到它将生成的转换图像存储在<code class="fe mw mx my mz b">build</code>内的<code class="fe mw mx my mz b">cache/images</code>文件夹中。</p><p id="32c2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这实际上是一个完整的Next.js应用程序中的<code class="fe mw mx my mz b">build/cache/images</code>文件夹的样子。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi oc"><img src="../Images/48d8d895abf80a0a5a701b67951d3a96.png" data-original-src="https://miro.medium.com/v2/resize:fit:976/format:webp/1*N20RlKJ3vq2lLDl1zvsXMA.png"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">The <code class="fe mw mx my mz b">build/cache/images</code> folder when Next.js image optimization works</figcaption></figure><p id="c29b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">换句话说，为了使图像优化特性工作，Next.js应用程序需要对<code class="fe mw mx my mz b">build/cache/images</code>文件夹的读/写权限。为此，创建一个bash <code class="fe mw mx my mz b">build.sh</code>文件，如下所示:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="od oe l"/></div></figure><p id="8949" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，确保您的<code class="fe mw mx my mz b">package.json</code>文件在“脚本”部分包含以下“构建”字段:</p><pre class="kg kh ki kj gt na mz nb nc aw nd bi"><span id="25ec" class="ne ma iq mz b gy nf ng l nh ni">"scripts": {<br/>  "build": "./build.sh"<br/>}</span></pre><p id="4c8a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当执行<code class="fe mw mx my mz b">npm run build</code>命令时，将启动<code class="fe mw mx my mz b">./build.sh</code>命令，结果是<code class="fe mw mx my mz b">build.sh</code>脚本运行。</p><p id="9f91" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">瞧啊！您的构建脚本现在将负责创建所需的具有正确权限的<code class="fe mw mx my mz b">build/cache/images</code>文件夹。这应该足以让Next.js图像优化特性按预期工作。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="4c42" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">结论</h1><p id="de33" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">在Next.js 10中引入的图像优化特性代表了一个很大的改进，可以让你构建现代快速的网站。另一方面，在将您的应用程序部署到不同于Vercel的平台时，让它按预期工作可能会成为一个挑战。在处理AWS弹性豆茎的时候尤其如此。幸运的是，有一个解决方案，并且展示了如何解决与该特性相关的最常见的问题，这正是本文所要讨论的。</p><p id="39ef" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">感谢阅读！我希望这篇文章对你有所帮助。请随意留下任何问题、评论或建议。</p><p id="2cc4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="nx">更多内容看</em> <a class="ae kv" href="http://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="ky ir"> <em class="nx">说白了. io </em> </strong> </a> <strong class="ky ir"> <em class="nx">。</em> </strong> <em class="nx">报名参加我们的</em> <a class="ae kv" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="ky ir"> <em class="nx">免费每周简讯点击这里</em> </strong> </a> <strong class="ky ir"> <em class="nx">。</em> </strong></p></div></div>    
</body>
</html>