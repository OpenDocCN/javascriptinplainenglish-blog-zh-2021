<html>
<head>
<title>How to Add Dark Mode to a Gatsby Website</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何给盖茨比网站添加黑暗模式</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/how-to-add-dark-mode-in-a-gatsby-website-23df7289b220?source=collection_archive---------10-----------------------#2021-03-31">https://javascript.plainenglish.io/how-to-add-dark-mode-in-a-gatsby-website-23df7289b220?source=collection_archive---------10-----------------------#2021-03-31</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/2d0a4c0381a8cc5a25d46ad957986fc8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ll9jXUyfhZerQtxwumTufQ.png"/></div></div></figure><p id="7ec2" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">网站(和应用)的最新趋势之一是<strong class="ka ir">黑暗模式</strong>，在黑暗模式下网站(和应用)看起来是黑暗的(！！！)，通常是深色背景，浅色文字，和一些强调色。许多公司现在要求在他们的界面中提供这一功能，因为黑暗模式可以减少电池消耗(特别是在有机发光二极管手机上)，可以在弱光下更好地阅读，据信可以帮助有视觉障碍的人更好地阅读，等等。</p><h1 id="1c33" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">黑暗模式工作流(通常)如何工作</h1><p id="bc0e" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">当您访问一个站点时，站点本身应该检查您是否有存储的首选项，并根据它显示正确的模式，如果您没有首选项，它应该检查您的操作系统是否支持黑暗模式，并且您已经启用了它，激活正确的模式(或默认模式)并将首选项保存在客户端上。它也应该给用户改变其偏好。</p><h1 id="3bb6" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">为什么黑暗模式对盖茨比来说很棘手</h1><p id="ebd5" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">如果站点在DOM已经呈现(或正在呈现)时检查客户端，然后激活黑暗模式(如果需要)，屏幕将从默认模式闪烁到黑暗模式(是的，Youtube从明亮模式闪烁到黑暗模式！).在身体开始渲染之前，我们需要用<em class="lz">阻塞脚本</em>实现检查。在Gatsby中(但通常在每个静态生成器中)，我们不能访问页面的这一部分，所以我们需要在编译时使用<code class="fe ma mb mc md b">gatsby-ssr.js</code>注入代码。我们还需要确保我们注入的脚本确实是高性能的，因为我们在读/写用户首选项时会阻塞渲染。</p><h1 id="8af0" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">我们要实现什么</h1><p id="c599" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">首先，我们正在编写一个脚本，它将在站点构建期间注入到我们的header中，它将负责从<em class="lz"> LocalStorage </em>中读取用户首选项，或者如果需要的话，从OS颜色模式首选项中读取用户首选项，如果用户想要一个深色主题，它将在&lt; html &gt;级别添加类<em class="lz"> dark </em>，然后该类可用于在CSS变量之间切换或用CSS框架实现深色主题(例如，Tailwind使用<a class="ae me" href="https://tailwindcss.com/docs/dark-mode#toggling-dark-mode-manually" rel="noopener ugc nofollow" target="_blank">类策略</a>支持深色主题)。在此之后，我们将实现一个组件，我们可以在我们的网站上使用，允许用户切换模式并保存首选项。</p><figure class="mg mh mi mj gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi mf"><img src="../Images/1c388ebe33690a1625435361ea158415.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*QfaexuZTGHeyMpypOoC2Dg.gif"/></div></div></figure><h1 id="55b9" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">先决条件</h1><p id="d2fb" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">要理解这篇文章，你至少需要掌握React JS、Gatsby(及其文件结构和SSR API)的基本知识，以及一点CSS/SCSS。您还可以<a class="ae me" href="https://github.com/popeating/dark-mode" rel="noopener ugc nofollow" target="_blank">克隆这个项目</a>的存储库。</p><h1 id="bc29" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">盖茨比项目</h1><p id="9e0b" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">设置新的Gatsby项目:</p><pre class="mg mh mi mj gt mk md ml mm aw mn bi"><span id="329d" class="mo kx iq md b gy mp mq l mr ms">npm init gatsby</span></pre><p id="fdd3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">选择并安装您需要的插件和库，然后进入项目文件夹并运行:</p><pre class="mg mh mi mj gt mk md ml mm aw mn bi"><span id="9224" class="mo kx iq md b gy mp mq l mr ms">gatsby develop</span></pre><p id="c5c1" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">新创建的站点应该在<code class="fe ma mb mc md b"><a class="ae me" href="http://localhost:8000" rel="noopener ugc nofollow" target="_blank">http://localhost:8000</a></code>可用</p><p id="1f9b" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">正如我之前提到的，我们需要在所有生成的页面中注入一个<em class="lz">渲染阻塞</em>脚本，为此我们将创建<code class="fe ma mb mc md b">gatsby-ssr.js</code>文件，并使用函数<em class="lz"> onRenderBody </em>将一个脚本放在带有<em class="lz"> setHeadComponents </em>参数的头中:</p><figure class="mg mh mi mj gt jr"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="0b96" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">该脚本将负责读取关于黑暗模式的用户偏好:它将首先检查用户是否在<em class="lz"> localStorage </em>中保存了偏好</p><pre class="mg mh mi mj gt mk md ml mm aw mn bi"><span id="3967" class="mo kx iq md b gy mp mq l mr ms">preferredTheme = localStorage.getItem('color-theme');</span></pre><p id="cd94" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后，它使用<a class="ae me" href="https://dev.to/juwanpetty/prefers-color-scheme-2op1" rel="noopener ugc nofollow" target="_blank"> <em class="lz">首选颜色方案</em> CSS媒体查询</a>来查询操作系统。我们现在可以将一个窗口范围的变量<code class="fe ma mb mc md b">window.__theme</code>设置为找到的主题值(稍后将从我们的组件中访问)，如果需要的话，在我们的HTML元素中放置一个“黑暗”类。</p><p id="ea46" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">代码还定义了一个窗口范围的函数<code class="fe ma mb mc md b">window.__setPreferredTheme</code>，它可以从我们的站点访问，当用户手动选择一个主题时，它将更新主题并保存它的首选项。</p><h1 id="5bae" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">CSS变量</h1><p id="a7f0" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">在这一点上，我们的HTML标签可以有也可以没有深色类，我们可以用它来切换颜色:使用<a class="ae me" href="https://www.w3schools.com/css/css3_variables.asp" rel="noopener ugc nofollow" target="_blank"> CSS变量</a>的根选择器。为了在我们的CSS文件中实现这一点，我们需要以变量的形式声明颜色，包括亮主题和暗主题:</p><figure class="mg mh mi mj gt jr"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="6313" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">例如，您将背景颜色定义为白色，但是如果:root元素(HTML标记)有一个类dark，那么背景将是黑色的。</p><p id="a706" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">然后在所有的CSS中，不像通常那样声明颜色，而是引用CSS变量:</p><pre class="mg mh mi mj gt mk md ml mm aw mn bi"><span id="991d" class="mo kx iq md b gy mp mq l mr ms">body { background: var(--color-background); }</span></pre><p id="f9c8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">CSS变量不需要页面刷新(这在用户切换主题时很有用)，一旦你改变了变量的值，页面就会自动改变。</p><p id="8fdc" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">请记住，对于需要根据主题进行更改的每个属性，您需要以亮暗模式“复制”所有的var声明，基本上，您可能只需要背景和文本颜色，但您可以进一步使用边框、阴影、强调颜色等。</p><h1 id="581b" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">切换主题</h1><p id="3a95" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">目前，我们的网站是黑暗的(或光明的)基于操作系统的偏好，但我们希望允许用户在导航期间改变主题。</p><p id="da9e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">为此，我们将编写一个“Toggler”(可以是一个按钮、一个链接、一个图像，或者是你在你的站点中使用或适合的东西)，它可以显示在导航栏或一个首选项页面中。</p><figure class="mg mh mi mj gt jr"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="c3e7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们的基本toggler只能在访问window(在浏览器中使用)时工作，Gatsby在服务器端渲染时无法引用<em class="lz"> window </em>，所以我们首先需要检查是否可以访问<em class="lz"> window </em>来设置将被传递到<em class="lz">主题</em>状态的websiteTheme变量。<em class="lz">主题</em>状态用于显示组件右侧的按钮。被点击的按钮将执行窗口函数<em class="lz">_ _ setpreferedtheme，</em>我们的主函数，它将更新标题中的主题并将主题首选项存储在<em class="lz"> localStorage中。</em>更新主题将改变HTML中的类，触发CSS变量更新并立即切换到所选主题。</p><p id="a1c9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在只需要在某个地方包含这个toggler，如果你有一个包含变量的基本CSS，你可以切换主题。</p><h1 id="4da8" class="kw kx iq bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">下一步是什么</h1><p id="0e00" class="pw-post-body-paragraph jy jz iq ka b kb lu kd ke kf lv kh ki kj lw kl km kn lx kp kq kr ly kt ku kv ij bi translated">这个例子可以在很多方面改进，比如可以进一步优化和缩小头脚本(否则就按原样注入)；切换偏好可以有三种状态(暗、亮、自动)。您可以将首选项保存在<em class="lz">上下文</em>中，而不是放在标题中(但是请注意，如果处理不当，您可能会经历闪烁)。你可以扩展你的CSS来拥有一个完整的暗/亮主题，或者在一个框架中实现，比如Bootstrap，或者Tailwind，或者Material。</p><p id="f5c3" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="lz">更多内容看</em> <a class="ae me" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="ka ir"> <em class="lz">说白了. io </em> </strong> </a></p></div></div>    
</body>
</html>