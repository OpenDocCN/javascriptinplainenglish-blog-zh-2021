<html>
<head>
<title>React + Stripe — Charge saved cards and explore products, invoice, subscriptions, schedules</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">React + Stripe —为保存的卡充值，并浏览产品、发票、订阅和时间表</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/react-stripe-charge-saved-cards-and-explore-products-invoice-subscriptions-schedules-27b2445b3f9e?source=collection_archive---------10-----------------------#2021-01-05">https://javascript.plainenglish.io/react-stripe-charge-saved-cards-and-explore-products-invoice-subscriptions-schedules-27b2445b3f9e?source=collection_archive---------10-----------------------#2021-01-05</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/da5b9503a266f992fc41adb7bd887004.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3_j_kIhgxnod_RyI11m20A.png"/></div></div></figure><p id="5bc3" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在本系列的第二部分中，我们将使用Stripe为储值卡充值，深入了解Stripe产品、发票、订阅和时间表。</p><p id="f9e0" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">如果你不知道如何创建一个条纹客户和保存他们的卡的细节，请检查我的<a class="ae kt" href="https://imchetanyadav.medium.com/react-stripe-accept-payment-through-paymentintent-api-and-save-card-details-aa90c55fcdb2" rel="noopener">以前的职位</a>。</p><h1 id="434c" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">检索保存的卡详细信息</h1><p id="25bb" class="pw-post-body-paragraph jv jw in jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated">在您的服务器上，您可以调用stripe <code class="fe lx ly lz ma b">paymentMethods</code> list方法来检索保存的客户卡的详细信息。</p><pre class="mb mc md me gt mf ma mg mh aw mi bi"><span id="4e38" class="mj kv in ma b gy mk ml l mm mn">stripe.paymentMethods.list({<br/>  customer: data.customerId,<br/>  type: "card",<br/>});</span></pre><p id="1c8e" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">它将返回一个具有数据属性的对象，该属性包含用户存储的卡的详细信息列表。将它传递给前端，并允许用户选择一张卡片。查看<a class="ae kt" href="https://stripe.com/docs/api/payment_methods/list?lang=node" rel="noopener ugc nofollow" target="_blank">响应结构</a>以在UI上显示必要的细节。</p></div><div class="ab cl mo mp hr mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="ig ih ii ij ik"><h1 id="9a70" class="ku kv in bd kw kx mv kz la lb mw ld le lf mx lh li lj my ll lm ln mz lp lq lr bi translated">为保存的卡充值</h1><p id="3212" class="pw-post-body-paragraph jv jw in jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated">允许用户选择一张保存的卡片并记下它的id。之后，当您创建PaymentIntent时，将该id作为payment_method传递。你可以跟随我的<a class="ae kt" href="https://imchetanyadav.medium.com/react-stripe-accept-payment-through-paymentintent-api-and-save-card-details-aa90c55fcdb2" rel="noopener">上一篇文章</a>学习如何通过PaymentIntent API向用户收费。</p><p id="9590" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">您还可以将该卡设定为客户的默认支付方式，以便Stripe在需要支付发票或订阅时使用该卡。</p><ul class=""><li id="0494" class="na nb in jx b jy jz kc kd kg nc kk nd ko ne ks nf ng nh ni bi translated"><strong class="jx io">设置客户默认付款方式</strong></li></ul><pre class="mb mc md me gt mf ma mg mh aw mi bi"><span id="75b4" class="mj kv in ma b gy mk ml l mm mn">stripe.customers.update(data.customerId, {<br/>  invoice_settings: {<br/>    default_payment_method: data.paymentMethodId,<br/>  },<br/>});</span></pre></div><div class="ab cl mo mp hr mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="ig ih ii ij ik"><h1 id="5b3c" class="ku kv in bd kw kx mv kz la lb mw ld le lf mx lh li lj my ll lm ln mz lp lq lr bi translated">产品和价格</h1><p id="8075" class="pw-post-body-paragraph jv jw in jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated">Stripe允许您为您销售的项目或服务创建产品。创建产品后，您可以将多个价格附加到它，这允许您拥有产品的不同层级或变体，并根据用户的需求向他们收费。您可以从<a class="ae kt" href="https://dashboard.stripe.com/products" rel="noopener ugc nofollow" target="_blank">仪表板</a>或<a class="ae kt" href="https://stripe.com/docs/api/products/create?lang=node" rel="noopener ugc nofollow" target="_blank"> API </a>创建产品。确保指定正确的定价和间隔(一次性或选择重复以获得更多选项)。一旦创建了产品和价格，请务必记下价格id。我们需要他们向顾客收费。</p></div><div class="ab cl mo mp hr mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="ig ih ii ij ik"><h1 id="98e2" class="ku kv in bd kw kx mv kz la lb mw ld le lf mx lh li lj my ll lm ln mz lp lq lr bi translated"><strong class="ak">一次性产品使用发票收费</strong></h1><pre class="mb mc md me gt mf ma mg mh aw mi bi"><span id="19f7" class="mj kv in ma b gy mk ml l mm mn"><em class="nj">// </em>Create invoice item with product price id and attach to a customer<em class="nj"><br/>await</em> stripe.invoiceItems.create({<br/>  customer: data.customerId,<br/>  price: data.priceId,<br/>});</span><span id="0b1d" class="mj kv in ma b gy nk ml l mm mn">// Create invoice<br/>const invoice = <em class="nj">await</em> stripe.invoices.create({<br/>  customer: data.customerId,<br/>});</span><span id="ff01" class="mj kv in ma b gy nk ml l mm mn">// Finalize invoice<br/>const finalizeInvoice = <em class="nj">await</em> stripe.invoices.finalizeInvoice(invoice.id);</span><span id="445c" class="mj kv in ma b gy nk ml l mm mn">// Charge customer<br/><em class="nj">await</em> stripe.invoices.pay(invoice.id);</span></pre></div><div class="ab cl mo mp hr mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="ig ih ii ij ik"><h1 id="347c" class="ku kv in bd kw kx mv kz la lb mw ld le lf mx lh li lj my ll lm ln mz lp lq lr bi translated"><strong class="ak">定期认购产品费用</strong></h1><p id="6ab9" class="pw-post-body-paragraph jv jw in jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated">您可以通过提供客户id和价格id为用户注册订阅</p><pre class="mb mc md me gt mf ma mg mh aw mi bi"><span id="a1cc" class="mj kv in ma b gy mk ml l mm mn">stripe.subscriptions.create({<br/>  customer: data.customerId,<br/>  items: [{ price: data.priceId }],<br/>});</span></pre><ul class=""><li id="f090" class="na nb in jx b jy jz kc kd kg nc kk nd ko ne ks nf ng nh ni bi translated"><strong class="jx io">在对订阅收费之前向客户提供试用</strong></li></ul><p id="9aa4" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">例如，您想在10天试用期后或下月初向客户收费，请相应地指定<code class="fe lx ly lz ma b">billing_cycle_anchor</code>和<code class="fe lx ly lz ma b">trial_end</code>。</p><pre class="mb mc md me gt mf ma mg mh aw mi bi"><span id="6944" class="mj kv in ma b gy mk ml l mm mn">stripe.subscriptions.create({<br/>  customer: data.customerId,<br/>  items: [{ price: data.priceId }],<br/>  billing_cycle_anchor: data.billingStart, // specify date when billing start<br/>  trial_end: data.trialEnd, // specify date when trial should end<br/>});</span></pre><ul class=""><li id="9f38" class="na nb in jx b jy jz kc kd kg nc kk nd ko ne ks nf ng nh ni bi translated"><strong class="jx io">取消订阅</strong></li></ul><pre class="mb mc md me gt mf ma mg mh aw mi bi"><span id="f00f" class="mj kv in ma b gy mk ml l mm mn">stripe.subscriptions.del(<!-- -->data.subscriptionId<!-- -->);</span></pre><p id="9a17" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">您也可以指定<code class="fe lx ly lz ma b">cancel_at</code>在以后取消计划</p><pre class="mb mc md me gt mf ma mg mh aw mi bi"><span id="2134" class="mj kv in ma b gy mk ml l mm mn">stripe.subscriptions.update(data.subscriptionId, {<br/>  cancel_at: data.cancellationDate,<br/>});</span></pre><p id="a6f1" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">或者指定<code class="fe lx ly lz ma b">cancel_at_period_end</code>在当前计费周期后自动取消订阅。</p><pre class="mb mc md me gt mf ma mg mh aw mi bi"><span id="63f8" class="mj kv in ma b gy mk ml l mm mn">stripe.subscriptions.update(<!-- -->data.subscriptionId<!-- -->, {<br/>  cancel_at_period_end: true<br/>});</span></pre><ul class=""><li id="506d" class="na nb in jx b jy jz kc kd kg nc kk nd ko ne ks nf ng nh ni bi translated"><strong class="jx io">升级或降级客户订阅</strong></li></ul><p id="6cd6" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">有时，您的客户可能想要升级或降级他们的计划，因此您可以遵循以下方法来实现这一点。</p><pre class="mb mc md me gt mf ma mg mh aw mi bi"><span id="7da5" class="mj kv in ma b gy mk ml l mm mn">// Retrieve subscription details<br/>const subscription = await stripe.subscriptions.retrieve(<!-- -->data.subscriptionId<!-- -->);</span><span id="ee1b" class="mj kv in ma b gy nk ml l mm mn">// Update subscription<br/>stripe.subscriptions.update(<!-- -->data.subscriptionId<!-- -->, {<br/>  cancel_at_period_end: false,<br/>  proration_behavior: 'create_prorations',<br/>  items: [{<br/>    id: subscription.items.data[0].id,<br/>    price: 'price_CBb6IXqvTLXp3f',<br/>  }]<br/>});</span></pre><p id="a4d4" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">更改订阅通常会导致<a class="ae kt" href="https://stripe.com/docs/billing/subscriptions/prorations" rel="noopener ugc nofollow" target="_blank">按比例分配</a>。确保正确理解，并在必要时通过将<code class="fe lx ly lz ma b">proration_behavior</code>设置为<code class="fe lx ly lz ma b">none</code>将其禁用。</p></div><div class="ab cl mo mp hr mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="ig ih ii ij ik"><h1 id="dede" class="ku kv in bd kw kx mv kz la lb mw ld le lf mx lh li lj my ll lm ln mz lp lq lr bi translated"><strong class="ak">安排订阅变更</strong></h1><p id="db52" class="pw-post-body-paragraph jv jw in jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated">有时，您希望为某个特定日期安排订阅更改，如下个月初或下一个计费周期。</p><p id="28e9" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在下面的示例中，订阅计划包含两个阶段:第一个阶段在特定日期结束当前订阅，第二个阶段在同一天开始新的订阅，不进行按比例分配。</p><pre class="mb mc md me gt mf ma mg mh aw mi bi"><span id="338f" class="mj kv in ma b gy mk ml l mm mn">// Retrieve subscription details<br/>const subscription = await stripe.subscriptions.retrieve(<!-- -->data.subscriptionId<!-- -->);</span><span id="e1e0" class="mj kv in ma b gy nk ml l mm mn">// Check whether subscription already has a schedule attached<br/>let scheduleId = subscription.schedule;</span><span id="7059" class="mj kv in ma b gy nk ml l mm mn"><em class="nj">// </em>Create a schedule if it does not exists<em class="nj"><br/>if</em> (!scheduleId) {<br/>  const schedule = <em class="nj">await</em> stripe.subscriptionSchedules.create({<br/>    from_subscription: data.subscriptionId,<br/>  });<br/>  scheduleId = schedule.id;<br/>}</span><span id="d2e4" class="mj kv in ma b gy nk ml l mm mn"><em class="nj"><br/>// </em>Update schedule<em class="nj"><br/>await</em> stripe.subscriptionSchedules.update(scheduleId, {<br/>  phases: [<br/>    {<br/>      items: [{ price: data.currentProductPriceId }],<br/>      start_date: subscription.current_period_start,<br/>      end_date: data.nextBillingStartDate,<br/>      proration_behavior: "none",<br/>    },<br/>    {<br/>      items: [{ price: data.newProductPriceId }],<br/>      start_date: date.nextBillingStartDate,<br/>      proration_behavior: "none",<br/>    },<br/>  ],<br/>  proration_behavior: "none",<br/>});</span></pre><p id="8273" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">为了正常运行，您还应该设置<a class="ae kt" href="https://stripe.com/docs/webhooks" rel="noopener ugc nofollow" target="_blank"> webhooks </a>,以便您可以监听各种stripe事件并在您的门户上采取必要的措施。您可以收听的一些事件示例</p><ul class=""><li id="8ef3" class="na nb in jx b jy jz kc kd kg nc kk nd ko ne ks nf ng nh ni bi translated"><code class="fe lx ly lz ma b">invoice.payment_failed</code>通知用户支付失败的事件，并限制用户访问，直到他们结清支付</li><li id="a881" class="na nb in jx b jy nl kc nm kg nn kk no ko np ks nf ng nh ni bi translated"><code class="fe lx ly lz ma b">invoice.paid</code>付款后允许他们访问受限资源的事件</li><li id="8ae8" class="na nb in jx b jy nl kc nm kg nn kk no ko np ks nf ng nh ni bi translated"><code class="fe lx ly lz ma b">customer.subscription.deleted</code>取消订阅后限制内容访问的事件</li><li id="94cf" class="na nb in jx b jy nl kc nm kg nn kk no ko np ks nf ng nh ni bi translated"><code class="fe lx ly lz ma b">customer.subscription.updated</code>验证客户是否改变了他们的计划并为他们提供正确的资源访问权的事件。</li></ul><p id="3865" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">本教程到此为止。希望对你有帮助。在insta gram<a class="ae kt" href="https://www.instagram.com/imchetanyadav/" rel="noopener ugc nofollow" target="_blank">和Twitter</a><a class="ae kt" href="https://twitter.com/im_chetanyadav/" rel="noopener ugc nofollow" target="_blank">上关注我，获取更多信息。</a></p></div></div>    
</body>
</html>