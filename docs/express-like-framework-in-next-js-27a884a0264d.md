# åœ¨ Next.js ä¸­åˆ›å»ºä¸€ä¸ªç±»ä¼¼ Express çš„æ¡†æ¶

> åŸæ–‡ï¼š<https://javascript.plainenglish.io/express-like-framework-in-next-js-27a884a0264d?source=collection_archive---------7----------------------->

![](img/345ad969a0db60f79e2cfb9e843e7add.png)

åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å°†æ¼”ç¤ºå¦‚ä½•åœ¨ Next.js ä¸­æ„å»ºç±»ä¼¼ Express çš„ APIï¼Œè€Œä¸éœ€è¦éƒ¨ç½² Express æœåŠ¡å™¨ï¼Œåªéœ€åšä¸€äº›è°ƒæ•´ã€‚

å¦‚æœæ‚¨æ­£åœ¨å¯»æ‰¾ Express æ¡†æ¶çš„å¥½å¤„ï¼Œä½†å¯¹æ‚¨çš„åº”ç”¨ç¨‹åºä¿æŒæ— æœåŠ¡å™¨çŠ¶æ€æ„Ÿåˆ°æ»¡æ„ï¼Œè¿™å¯èƒ½æ˜¯æ‚¨çš„ä¸€ä¸ªé€‰æ‹©ã€‚

# ä½¿ç”¨ Next.js çš„æ³¨æ„äº‹é¡¹

æˆ‘ä» Next.js å¼€å§‹äº†æˆ‘çš„æ—…ç¨‹ï¼Œå› ä¸ºå®ƒä½¿ React çš„æœåŠ¡å™¨ç«¯å‘ˆç°å˜å¾—ç®€å•æ˜äº†ã€‚å®ƒå…è®¸æˆ‘åœ¨é¡µé¢åŠ è½½ä¹‹å‰è½»æ¾åœ°é€‰æ‹©è¦å‘ˆç°çš„å†…å®¹ï¼Œå¹¶ä¸”æœ‰ä¸€ä¸ª pages æ–‡ä»¶å¤¹ç”¨äºç›´è§‚çš„è·¯ç”±ã€‚æˆ‘è¿˜å‘ç°äº†[æ— æœåŠ¡å™¨çš„å…¶ä»–å¥½å¤„](https://blog.newrelic.com/engineering/what-is-serverless-architecture/),æ¯”å¦‚æ˜“äºéƒ¨ç½²ï¼Œæ›´æ³¨é‡äº§å“å¼€å‘è€Œä¸æ˜¯ç®¡ç†æœåŠ¡å™¨ã€‚

> *ä»¥åæƒ³çœ‹è¿™ä¸ªæ•…äº‹å—ï¼Ÿ* [*ä¿å­˜åœ¨æ—¥è®°æœ¬ä¸Šã€‚*](https://usejournal.com/?utm_source=medium.com&utm_medium=noteworthy_blog&utm_campaign=tech&utm_content=guest_post_read_later_text)

è¿™æ„å‘³ç€ä½ è¿™è¾¹çš„å·¥ä½œæ›´å°‘ï¼Œä½†æ§åˆ¶ä¹Ÿæ›´å°‘ã€‚é˜…è¯» Vercel å¹³å°çš„é™åˆ¶[ä»¥äº†è§£å®ƒæ˜¯å¦é€‚åˆæ‚¨çš„åº”ç”¨ç¨‹åºæ˜¯å¾ˆæœ‰ç”¨çš„ï¼Œæ³¨æ„åœ¨æ²¡æœ‰ä¼ä¸šè®¡åˆ’çš„æƒ…å†µä¸‹ï¼Œæœ‰ 1000 ä¸ªå¹¶å‘è¯·æ±‚çš„é™åˆ¶](https://vercel.com/docs/platform/limits#)[ã€‚](https://vercel.com/docs/platform/limits#)

# Next.js çš„ API vs Expresss

æˆ‘ä¸»è¦å…³å¿ƒçš„æ˜¯å¦‚ä½•è®¾è®¡æˆ‘çš„ APIã€‚å¯¹äº[æ— æœåŠ¡å™¨å‡½æ•°](https://vercel.com/docs/serverless-functions/introduction)ï¼Œç†æƒ³çš„æ¨¡å¼æ˜¯è®©æ¯ä¸ªè·¯ç”±åœ¨ pages/api ç›®å½•ä¸­çš„å•ä¸ªæ–‡ä»¶ä¸­æä¾›å•ä¸ªå‡½æ•°(ä¾‹å¦‚ **GET '/api/user/:id'** )ã€‚

æˆ‘æ­£åœ¨ä»ä¸€ä¸ªå¿«é€Ÿç¯å¢ƒä¸­è¿ç§»ï¼Œå¹¶äº«å—å°†åŠŸèƒ½ç•™ç»™æ§åˆ¶å™¨çš„é€»è¾‘æµç¨‹ã€‚æˆ‘çš„åº”ç”¨ç¨‹åºæœ‰ä¸€ä¸ªå®šåˆ¶çš„èº«ä»½éªŒè¯æµï¼Œæ‰€ä»¥åƒ **/api/login/** è¿™æ ·çš„ç«¯ç‚¹å¤ªå¤§äº†ï¼Œå¾ˆéš¾é™åˆ¶åœ¨ä¸€ä¸ªå‡½æ•°ä¸­ã€‚æ›´ä¸ç”¨è¯´æˆ‘æƒ³é‡ç”¨å…¶ä¸­çš„ä¸€äº›åŠŸèƒ½ï¼Œæ‰€ä»¥å°†è¿™ä¸ªé€»è¾‘å­˜å‚¨åœ¨éš”ç¦»çš„ç«¯ç‚¹å¯¹æˆ‘æ¥è¯´æ²¡æœ‰æ„ä¹‰ã€‚

é—®é¢˜å˜æˆäº†:

# æˆ‘å¯ä»¥ç®€å•åœ°å°† Express ä¸ Next.js ä¸€èµ·ä½¿ç”¨å—ï¼Ÿ

æ˜¯çš„ï¼Œä½†ä¸æ˜¯æ²¡æœ‰ä¸€äº›æƒè¡¡ã€‚

ä¸€ç§é€‰æ‹©æ˜¯è®¾ç½®ä¸€ä¸ªå®šåˆ¶æœåŠ¡å™¨ï¼Œä½†æ˜¯è¿™é¦–å…ˆå°±å¦å®šäº†ä½¿ç”¨ Next.js çš„ä¸€äº›ç†ç”±ï¼Œå› ä¸ºæ‚¨ä¸èƒ½åœ¨ Vercel ä¸Šéƒ¨ç½²ï¼Œå¹¶ä¸”æ‚¨ä¸å†æ˜¯æ— æœåŠ¡å™¨çš„ã€‚ç„¶è€Œï¼Œå¯¹äºè®¸å¤šåº”ç”¨ç¨‹åºæ¥è¯´ï¼Œè¿™æ˜¯æ­£ç¡®çš„é€‰æ‹©ï¼Œå°¤å…¶æ˜¯é‚£äº›å—ç›Šäºç®¡ç†è‡ªå·±çš„æœåŠ¡å™¨çš„å¤§å‹åº”ç”¨ç¨‹åºã€‚

å¦ä¸€ä¸ªé€‰æ‹©æ˜¯[åœ¨æ— æœåŠ¡å™¨åŠŸèƒ½](https://vercel.com/guides/using-express-with-vercel)å†…ä½¿ç”¨ Expressã€‚Vercel å»ºè®®è¿™åªæ˜¯ä¸€ç§è¿ç§»ä½ çš„åº”ç”¨ç¨‹åºçš„æ–¹æ³•ï¼Œæœ¬è´¨ä¸Šæ˜¯å°†ä½ è‡ªå·±ä»ä¸€ä¸ªä¸“ç”¨çš„æœåŠ¡å™¨ä¸­åˆ†ç¦»å‡ºæ¥ã€‚ä¸ªäººè§‰å¾—åœ¨æ— æœåŠ¡å™¨ç¯å¢ƒä¸‹è¿è¡Œ Express æœ‰ç‚¹å‚»ã€‚è¿™ä¹Ÿæ„å‘³ç€æ‚¨åœ¨å¯¹æ¯ä¸ªè¯·æ±‚æ‰§è¡Œå®Œæ•´çš„æœåŠ¡å™¨å®ç°ï¼Œè¿™è¿åäº†æ— æœåŠ¡å™¨åŠŸèƒ½æœåŠ¡äºä¸€ä¸ªç›®çš„çš„æ¨¡å¼ã€‚ä½†æˆ‘å¹¶ä¸æ˜¯è¯´è¿™å¯¹ä½ æ²¡ç”¨ã€‚

æˆ‘å†³å®šç•™åœ¨ Next.js çš„ç¼“å†²åŒºå†…ï¼Œå¹¶å°è¯•åœ¨ä¸ä½¿ç”¨ Express çš„æƒ…å†µä¸‹ä» Express çš„æ¡†æ¶ä¸­è·å¾—æˆ‘æƒ³è¦çš„å¥½å¤„ã€‚

# æˆ‘é‡åˆ°çš„é—®é¢˜

æˆ‘åœ¨æˆ‘çš„åº”ç”¨ç¨‹åºä¸­è®¾ç½®äº†ä¸€ä¸ªæ§åˆ¶å™¨ç›®å½•ï¼Œåœ¨é‚£é‡Œæˆ‘å¯¼å‡ºäº†æ— æ•°çš„å‡½æ•°ï¼Œå¹¶ä»æˆ‘çš„æ— æœåŠ¡å™¨å‡½æ•°ä¸­åƒè°ƒç”¨ä¸­é—´ä»¶ä¸€æ ·è°ƒç”¨å®ƒä»¬ã€‚

ç„¶è€Œï¼Œåœ¨ Next.js ä¸­è¿™æ ·åšå¾ˆéº»çƒ¦ï¼Œå› ä¸ºå®ƒç¼ºå°‘ä¸€ä¸ª Next()å‡½æ•°ï¼ŒExpress ä½¿ç”¨è¿™ä¸ªå‡½æ•°æ¥**è½¬ä¹‰**ä¸­é—´ä»¶é“¾å’Œ**ç»•è¿‡**å…¶ä½™çš„åŠŸèƒ½ã€‚

ä»æœ¬è´¨ä¸Šè¯´ï¼Œä¸èƒ½è®¿é—® next()æ„å‘³ç€æˆ‘ä¸èƒ½è½»æ˜“æ‘†è„±ä¸­é—´ä»¶ã€‚

# ä¸è¦åšä»€ä¹ˆ:

åœ¨æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªç«¯ç‚¹ï¼Œå®ƒåœ¨å‘é€ç”¨æˆ·æ•°æ®ä¹‹å‰ç­‰å¾…ä»¤ç‰Œçš„éªŒè¯ã€‚å¦‚æœä¸­é—´ä»¶åŠŸèƒ½å‘Šè¯‰æˆ‘ä»¬æ²¡æœ‰é€šè¿‡éªŒè¯ï¼Œæˆ‘ä»¬éœ€è¦å¤„ç†è¿™ä¸ªå“åº”ï¼Œé¿å…æ‰§è¡Œä¸‹ä¸€ä¸ªä¸­é—´ä»¶åŠŸèƒ½ã€‚

```
**/api/authenticateUser**import authController from 'controllers/authController';export default async (req, res) => {try { **// Controller sends back a boolean "verified" and "userId"**
  const result = await authController.verifyToken(req, res);
  if (result.verified === false) {
    return res.json({ error: 'Not authenticated'})
  }; const payload = { userId: result.userId }; **// Fetch user data by userId. Returns username**  const data = await authController.header(req, res, payload);
  const { username } = data; return res.json({ username });} catch(e) {
  return res.status(500).send(e.message);
}};
```

å¦‚æ‚¨æ‰€è§ï¼Œè¿™çœ‹èµ·æ¥ä¸€ç‚¹ä¹Ÿä¸åƒæˆ‘ä»¬åœ¨ Express ä¸­ä¹ æƒ¯çš„å¹²å‡€çš„ä¸­é—´ä»¶é“¾ã€‚æˆ‘å¿…é¡»å°†ç±»ä¼¼{ verified: true }çš„ä¿¡æ¯ä¼ é€’å›â€œwaitingâ€å‡½æ•°ï¼Œä»¥ä¾¿å¤„ç†å¼‚å¸¸ã€‚

åœ¨ express ä¸­ï¼Œæˆ‘ä»¬åªéœ€åœ¨æ§åˆ¶å™¨å†…éƒ¨è¿”å›ç±»ä¼¼ next(err)æˆ– RES . JSON({ error:' custom error ' })**ï¼Œ**çš„å†…å®¹ï¼Œå¦‚æœæˆ‘ä»¬æ²¡æœ‰å‘½ä¸­ next()è¯­å¥ï¼Œå°±ä¸ä¼šç»§ç»­ã€‚è¿™é‡Œï¼Œå¦‚æœæˆ‘ä»¬ä»æ§åˆ¶å™¨è°ƒç”¨ res.json()ï¼Œå®ƒå°†ä»å‡½æ•°ä¸­è¿”å›ï¼Œä½†ä¸ä¼šä¸€èµ·ç»“æŸå“åº”ã€‚

è¿˜è¦æ³¨æ„ï¼Œæ²¡æœ‰ res.locals å¯¹è±¡åœ¨å®ƒä»¬ä¹‹é—´ä¼ é€’æ•°æ®æ˜¯å¤šä¹ˆç¬¨æ‹™ã€‚æˆ‘ä»¬å¿…é¡»å°†æ•°æ®æ‰“åŒ…åˆ°æœ‰æ•ˆè½½è·ä¸­ï¼Œå¹¶å°†æ¯ä¸ªæ§åˆ¶å™¨è°ƒç”¨çš„ç»“æœè§£åŒ…ã€‚

# è§£å†³æ–¹æ¡ˆæ˜¯:

(è§£é‡Šå¦‚ä¸‹)

```
import wrapper from â€˜utils/wrapperâ€™;
import authController from â€˜controllers/authControllerâ€™;const handler = async (req, res, middlewareChain) => { await middlewareChain
  (
    authController.verifyToken,
    authController.getUserId,  
  )
  .then(result => { if (!result) return; })
  .catch(e => { res.status(500).send(e.message); }) return res.json({
    username: res.locals.username
  });};export default wrapper(handler);
```

å¦‚æœä¸å‘æ‚¨å±•ç¤ºæˆ‘åœ¨é¡¶éƒ¨å¯¼å…¥çš„åŒ…è£…å‡½æ•°ï¼Œè¿™å¹¶ä¸èƒ½è§£é‡Šå¤ªå¤šã€‚è¯·æ³¨æ„ï¼Œæˆ‘ä»¬ä¸æ˜¯å¯¼å‡ºå‡½æ•°ï¼Œè€Œæ˜¯ä¼ é€’å‡½æ•°çš„åŒ…è£…å™¨ã€‚

## åŒ…è£…ææ–™:

åŒ…è£…å‡½æ•°å…è®¸æˆ‘ä»¬ä½¿ç”¨ä¿®æ”¹è¿‡çš„ res å’Œ req å‡½æ•°æ¥æ‰§è¡Œå‡½æ•°ï¼Œä»¥åŠå°†ä»»ä½•å…¶ä»–å‡½æ•°æ·»åŠ åˆ°æˆ‘ä»¬çš„å‚æ•°ä¸­(æ¯”å¦‚ middlewareChain)ã€‚

åŒ…è£…æ–‡ä»¶å¦‚ä¸‹æ‰€ç¤º:

```
**utils/wrapper**const wrapper = handler => {return (req, res, middlewareChain) => {

    **/* res.locals object */** res.locals = {}; **/* middlewareChain function */** middlewareChain = async (...funcs) => {
      let finished = true;
      for (const func of funcs) {
        await func(req, res)
        if (res.finished) {
          finished = false;
          break;
        };
      };
    return next;
    }; return handler(req, res, middlewareChain);
  };
};module.exports = wrapper;
```

é¦–å…ˆï¼Œæ‚¨å°†çœ‹åˆ°æˆ‘ä»¬å¯ä»¥åƒä½¿ç”¨ Express ä¸€æ ·å£°æ˜å’Œä½¿ç”¨ **res.locals** ã€‚è¿™ä½¿å¾—æˆ‘ä»¬å¯ä»¥è½»æ¾åœ°åœ¨å‡½æ•°ä¹‹é—´ä¼ é€’æ•°æ®ã€‚

è‡³äº **middlewareChain** å‡½æ•°ï¼Œå®ƒå°†æ‰€æœ‰æ§åˆ¶å™¨å‡½æ•°ä½œä¸ºå‚æ•°ã€‚å¯¹äºæ¯ä¸ªå‡½æ•°ï¼Œæˆ‘ä»¬ç­‰å¾…å“åº”å¹¶æ£€æŸ¥æˆ‘ä»¬æ˜¯å¦è°ƒç”¨äº† res.json()æˆ– res.send()ã€‚æˆ‘ä»¬é€šè¿‡åˆ©ç”¨ res å¯¹è±¡å›ºæœ‰çš„ **res.finished** å±æ€§æ¥æ£€æŸ¥è¿™ä¸€ç‚¹ã€‚å½“æ‚¨è°ƒç”¨ res.json()æˆ– res.send()æ—¶ï¼Œå®ƒçš„å€¼ä¼šä» true å˜ä¸º falseã€‚(è¿™é€šå¸¸æ˜¯ä¸ºäº†ç¡®ä¿æˆ‘ä»¬ä¸ä¼šè®¾ç½®ä¸¤æ¬¡å“åº”)ã€‚

å¦‚æœæˆ‘æƒ³æ—©ç‚¹é€€å‡ºæˆ‘çš„æ§åˆ¶å™¨å‡½æ•°ï¼Œå¯ä»¥è°ƒç”¨ **return res.json({data})** ã€‚æˆ‘çš„ middlewareChain å°†æ•æ‰åˆ°æˆ‘æƒ³è¿”å›ä¸€ä¸ªå“åº”å¹¶è·³å‡ºå¾ªç¯ã€‚é™¤äº†è°ƒç”¨ **break** ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜å°†ä¸€ä¸ª **finished** å˜é‡è®¾ç½®ä¸º falseï¼Œä½¿å¾— middlewareChain çš„è¿”å›å€¼ä¸ºå¸ƒå°”å€¼ã€‚æˆ‘ä»¬åœ¨**ä¸­å¤„ç†è¿™ä¸ªå“åº”ã€‚ç„¶å()**ï¼Œè¯´å¦‚æœå®ƒæ±‚å€¼ä¸º falseï¼Œè¿”å›ã€‚

å½“ç„¶ï¼Œæ‰“ç ´æ§åˆ¶å™¨åŠŸèƒ½çš„å¦ä¸€ç§æ–¹å¼æ˜¯æŠ›å‡ºä¸€ä¸ªé”™è¯¯ï¼Œä½†æ˜¯è¿™å¹¶ä¸é€‚åˆæ¯ç§æƒ…å†µã€‚

## ä½¿ç”¨åŒ…è£…å™¨è¿˜å¯ä»¥åšå…¶ä»–äº‹æƒ…:

åœ¨æˆ‘çš„åº”ç”¨ç¨‹åºä¸­ï¼Œæˆ‘è¿˜å°†é”™è¯¯å¤„ç†å’Œ cookie å¤„ç†å‡½æ•°( **res.cookie** )æ”¾åœ¨äº†å“åº”å¯¹è±¡ä¸Šï¼Œè¿™æ˜¯æˆ‘å¼ºçƒˆæ¨èçš„ã€‚æˆ‘åœ¨è¿™é‡Œå†™äº†ä¸€ç¯‡å…³äº[ä»¥ç±»ä¼¼å¿«é€’çš„æ–¹å¼å¤„ç† cookies çš„æ–‡ç« ](https://justinjaeger.medium.com/next-js-using-cookies-in-getserversideprops-89c03a216b0b)ã€‚

è¦ç‚¹æ˜¯ï¼Œæ‚¨å¯ä»¥å°†ä»»ä½•ç±»å‹å‡½æ•°æˆ–å¯¹è±¡é™„åŠ åˆ° req å’Œ res ä¸Šï¼Œè¿™ä½¿æ‚¨çš„ç”Ÿæ´»æ›´è½»æ¾ï¼Œæˆ–è€…å»æ‰é‡å¤çš„ä»£ç ã€‚

# æœ€å

è¿™ç§ç­–ç•¥å¯ä»¥å¸®åŠ©æ‚¨ä¿æŒç±»ä¼¼ Express çš„å·¥ä½œæµï¼Œè€Œä¸éœ€è¦åˆ›å»ºå®šåˆ¶çš„æœåŠ¡å™¨**å’Œ**,ä¹Ÿä¸éœ€è¦ç‰ºç‰²ä½¿ç”¨å¯ä»¥åœæ­¢â€œä¸­é—´ä»¶â€é“¾çš„æ§åˆ¶å™¨çš„èƒ½åŠ›ã€‚

ğŸ“æŠŠè¿™ä¸ªæ•…äº‹ä¿å­˜åœ¨[æ‚å¿—](https://usejournal.com/?utm_source=medium.com&utm_medium=noteworthy_blog&utm_campaign=tech&utm_content=guest_post_read_later_text)ä¸Šã€‚