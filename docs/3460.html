<html>
<head>
<title>React Monorepo Using Yarn Workspaces Only (No Lerna)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">仅使用Yarn工作空间反应Monorepo(无Lerna)</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/react-monorepo-using-yarn-workspaces-only-no-lerna-766c7a395140?source=collection_archive---------0-----------------------#2021-07-13">https://javascript.plainenglish.io/react-monorepo-using-yarn-workspaces-only-no-lerna-766c7a395140?source=collection_archive---------0-----------------------#2021-07-13</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jn jo jp jq gh gi paragraph-image"><div role="button" tabindex="0" class="jr js di jt bf ju"><div class="gh gi ca"><img src="../Images/bb22b9668b182283d6c2efd5cbbbd8c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yvHp2z2X1dkHnyr-bf0Dxw.png"/></div></div></figure><blockquote class="jx"><p id="98e4" class="jy jz iq bd ka kb kc kd ke kf kg kh dk translated">我希望将我的一个GitHub回购转换成monorepo。我做了一点研究，发现有几个解决方案。我给了Lerna一个机会，因为它非常受欢迎，拥有大量用户。它做到了它所说的，“一个用多个包管理JavaScript项目的工具。”</p></blockquote><p id="9f5a" class="pw-post-body-paragraph ki kj iq kk b kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le kh ij bi translated">后来才发现Lerna使用了Yarn，但也有一些与我的用例不相关的高级特性。管理monorepo也可以仅通过Yarn工作空间来实现！</p><p id="136f" class="pw-post-body-paragraph ki kj iq kk b kl lf kn ko kp lg kr ks kt lh kv kw kx li kz la lb lj ld le kh ij bi translated">这个概念并不新鲜，近十年前，像谷歌这样的公司使用monorepos来管理大型代码库。单个存储库包含其他独立的存储库，它们可以作为依赖关系相互导入。</p><p id="0b5b" class="pw-post-body-paragraph ki kj iq kk b kl lf kn ko kp lg kr ks kt lh kv kw kx li kz la lb lj ld le kh ij bi translated">想象一个web应用程序，它的iOS应用程序，它的Android应用程序和其他共享的UI组件和模块。在我的用例中，我有一个表单管理模块库，以及一个使用表单管理作为依赖项的示例应用程序。我想同时开发主模块和示例应用程序。这可以通过将两个回购合并为一个并设置一个带有Yarn工作空间的monorepo配置来实现。</p><h1 id="9ab0" class="lk ll iq bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">和Lerna比怎么样？</h1><p id="7ee2" class="pw-post-body-paragraph ki kj iq kk b kl mi kn ko kp mj kr ks kt mk kv kw kx ml kz la lb mm ld le kh ij bi translated">“Yarn的工作空间是像Lerna这样的工具可以(和<a class="ae mn" href="https://github.com/lerna/lerna/pull/899" rel="noopener ugc nofollow" target="_blank">做</a>)的低级原语！)使用。他们永远不会尝试支持Lerna提供的高级功能，但通过实现解决方案的核心逻辑和连接Yarn本身的步骤，我们希望能够实现新的用途并提高性能。”——来自纱线工作区<a class="ae mn" href="https://classic.yarnpkg.com/en/docs/workspaces/" rel="noopener ugc nofollow" target="_blank">文档</a>。</p><p id="cc0b" class="pw-post-body-paragraph ki kj iq kk b kl lf kn ko kp lg kr ks kt lh kv kw kx li kz la lb lj ld le kh ij bi translated">当我在搜索monorepos时，我发现GitHub上有许多样板文件演示如何用Lerna设置monorepo，但事实上它们都没有利用Lerna的高级功能，如<code class="fe mo mp mq mr b">lerna publish</code>或<code class="fe mo mp mq mr b">lerna bootstrap</code>，那么为什么还要额外的npm包呢？我的原则是少即是多，记得吗？纱线也有类似的特征。</p><h1 id="a85f" class="lk ll iq bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">概观</h1><p id="b9a9" class="pw-post-body-paragraph ki kj iq kk b kl mi kn ko kp mj kr ks kt mk kv kw kx ml kz la lb mm ld le kh ij bi translated">在本教程中，我们将基于React应用程序创建一个monorepo，其结构如下:</p><ol class=""><li id="76ae" class="ms mt iq kk b kl lf kp lg kt mu kx mv lb mw kh mx my mz na bi translated">一个主根回购与一个中央<code class="fe mo mp mq mr b">package.json</code>文件管理使用纱。</li><li id="8401" class="ms mt iq kk b kl nb kp nc kt nd kx ne lb nf kh mx my mz na bi translated">一个表单管理(主模块)，使用Rollup构建，准备发布到npm。</li><li id="a9ad" class="ms mt iq kk b kl nb kp nc kt nd kx ne lb nf kh mx my mz na bi translated">使用craco构建的React应用程序示例使用表单管理模块作为依赖项。</li></ol><p id="e1fc" class="pw-post-body-paragraph ki kj iq kk b kl lf kn ko kp lg kr ks kt lh kv kw kx li kz la lb lj ld le kh ij bi translated">当然，monorepo将使用TypeScript进行类型化，因此我们需要一个特定的<code class="fe mo mp mq mr b">tsconfig.json</code>来扩展到嵌套的repos中，并在必要时更改编译器选项。</p><p id="bc36" class="pw-post-body-paragraph ki kj iq kk b kl lf kn ko kp lg kr ks kt lh kv kw kx li kz la lb lj ld le kh ij bi translated">当谈到典型的create-react-app配置时，在monorepo <a class="ae mn" href="https://twitter.com/dan_abramov/status/1045809734069170176" rel="noopener ugc nofollow" target="_blank">中嵌套一个包会破坏create-react-app的功能，因为它不是非常可定制的，并且使它在monorpo中工作有一些严重的挑战。这就是为什么我们将使用</a><a class="ae mn" href="https://medium.com/gsoft-tech/why-i-built-craco-33ff39f4fc94" rel="noopener"> craco </a>来代替。创作者是这样描述的:<em class="ng">“短而甜，是在</em> <a class="ae mn" href="https://github.com/facebook/create-react-app" rel="noopener ugc nofollow" target="_blank"> <em class="ng">之上的hacky层创建React App (CRA) </em> </a> <em class="ng">自定义其配置。”。</em></p><p id="b7a4" class="pw-post-body-paragraph ki kj iq kk b kl lf kn ko kp lg kr ks kt lh kv kw kx li kz la lb lj ld le kh ij bi translated">monorepo的目录结构如下:</p><figure class="nh ni nj nk gt jq"><div class="bz fp l di"><div class="nl nm l"/></div></figure><h1 id="6a39" class="lk ll iq bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">📑该方法</h1><p id="8b36" class="pw-post-body-paragraph ki kj iq kk b kl mi kn ko kp mj kr ks kt mk kv kw kx ml kz la lb mm ld le kh ij bi translated">回到我之前提到的用例，我们有:</p><ol class=""><li id="fead" class="ms mt iq kk b kl lf kp lg kt mu kx mv lb mw kh mx my mz na bi translated">一个使用Rollup.js构建的表单管理库，只是因为它不包含任何HTML或React，只是一个模块包。</li><li id="88b4" class="ms mt iq kk b kl nb kp nc kt nd kx ne lb nf kh mx my mz na bi translated">用<code class="fe mo mp mq mr b">craco.config</code>替换<code class="fe mo mp mq mr b">create-react-app</code>提供的常用<code class="fe mo mp mq mr b">react-scripts</code>配置的应用包示例。</li></ol><p id="d746" class="pw-post-body-paragraph ki kj iq kk b kl lf kn ko kp lg kr ks kt lh kv kw kx li kz la lb lj ld le kh ij bi translated">顶层package.json定义了项目的根。用yarn设置工作空间只需添加一个<code class="fe mo mp mq mr b">workspaces</code>属性:</p><figure class="nh ni nj nk gt jq"><div class="bz fp l di"><div class="nl nm l"/></div><figcaption class="nn no gj gh gi np nq bd b be z dk"><strong class="ak">File path: </strong>./package.json</figcaption></figure><p id="e44c" class="pw-post-body-paragraph ki kj iq kk b kl lf kn ko kp lg kr ks kt lh kv kw kx li kz la lb lj ld le kh ij bi translated">Private设置为<code class="fe mo mp mq mr b">true</code>是因为我们不想将monorepo本身和其中的所有源代码发布给npm，我们只对发布主模块包中的<code class="fe mo mp mq mr b">dist/</code>目录感兴趣。将其设置为<code class="fe mo mp mq mr b">true</code>可防止monorepo在运行<code class="fe mo mp mq mr b">npm publish</code>或<code class="fe mo mp mq mr b">yarn publish</code>命令时发布到npm。</p><p id="2cf4" class="pw-post-body-paragraph ki kj iq kk b kl lf kn ko kp lg kr ks kt lh kv kw kx li kz la lb lj ld le kh ij bi translated">回购配置如下:</p><h2 id="2086" class="nr ll iq bd lm ns nt dn lq nu nv dp lu kt nw nx ly kx ny nz mc lb oa ob mg oc bi translated">1.📦“主模块”包</h2><figure class="nh ni nj nk gt jq"><div class="bz fp l di"><div class="nl nm l"/></div><figcaption class="nn no gj gh gi np nq bd b be z dk"><strong class="ak">File path:</strong> packages/main/package.json</figcaption></figure><p id="876e" class="pw-post-body-paragraph ki kj iq kk b kl lf kn ko kp lg kr ks kt lh kv kw kx li kz la lb lj ld le kh ij bi translated">版本设置正确，包不是私有的。这份报告准备向国家预防机制发表:<a class="ae mn" href="https://www.npmjs.com/package/reactjs-use-form" rel="noopener ugc nofollow" target="_blank">https://npmjs.com/package/reactjs-use-form</a></p><h2 id="33bc" class="nr ll iq bd lm ns nt dn lq nu nv dp lu kt nw nx ly kx ny nz mc lb oa ob mg oc bi translated">2.🕹️“示例应用程序”包</h2><figure class="nh ni nj nk gt jq"><div class="bz fp l di"><div class="nl nm l"/></div><figcaption class="nn no gj gh gi np nq bd b be z dk"><strong class="ak">File path: </strong>packages/examples/package.json</figcaption></figure><p id="a60c" class="pw-post-body-paragraph ki kj iq kk b kl lf kn ko kp lg kr ks kt lh kv kw kx li kz la lb lj ld le kh ij bi translated">注意我们在这里也是如何将<code class="fe mo mp mq mr b">private</code>属性设置为<code class="fe mo mp mq mr b">true</code>的。此外，这里我们将主模块作为一个依赖项使用，并将在运行<code class="fe mo mp mq mr b">yarn install</code>时正确链接。主模块包<code class="fe mo mp mq mr b">reactjs-use-form</code>作为依赖项安装。</p><p id="c8e4" class="pw-post-body-paragraph ki kj iq kk b kl lf kn ko kp lg kr ks kt lh kv kw kx li kz la lb lj ld le kh ij bi translated">craco配置如下:</p><figure class="nh ni nj nk gt jq"><div class="bz fp l di"><div class="nl nm l"/></div></figure><p id="4040" class="pw-post-body-paragraph ki kj iq kk b kl lf kn ko kp lg kr ks kt lh kv kw kx li kz la lb lj ld le kh ij bi translated">这是一个使用craco创建的webpack配置，它获取<code class="fe mo mp mq mr b">src/</code>目录的内容并使用<a class="ae mn" href="https://babeljs.io/" rel="noopener ugc nofollow" target="_blank"> babel </a>构建它。</p><p id="1426" class="pw-post-body-paragraph ki kj iq kk b kl lf kn ko kp lg kr ks kt lh kv kw kx li kz la lb lj ld le kh ij bi translated">“Lerna为每个包多次调用<code class="fe mo mp mq mr b">yarn install</code>，这造成了开销，因为每个<code class="fe mo mp mq mr b">package.json</code>被认为是独立的，它们不能相互共享依赖关系。这导致了每个<code class="fe mo mp mq mr b">node_modules</code>文件夹的大量重复，这些文件夹经常使用相同的第三方包。”—来自纱线工作区<a class="ae mn" href="https://classic.yarnpkg.com/en/docs/workspaces/" rel="noopener ugc nofollow" target="_blank">文档</a>。</p><p id="3ccf" class="pw-post-body-paragraph ki kj iq kk b kl lf kn ko kp lg kr ks kt lh kv kw kx li kz la lb lj ld le kh ij bi translated">当我们配置工作空间时，当我们在项目中运行<code class="fe mo mp mq mr b">yarn install</code>时，Yarn会创建一个优化的依赖结构。由于示例应用程序包使用主模块包，Yarn将这些包链接在一起，使我们能够开发和观察变化。</p><p id="0075" class="pw-post-body-paragraph ki kj iq kk b kl lf kn ko kp lg kr ks kt lh kv kw kx li kz la lb lj ld le kh ij bi translated">对于根<code class="fe mo mp mq mr b">package.json</code>中的主脚本，我们有如下:</p><figure class="nh ni nj nk gt jq"><div class="bz fp l di"><div class="nl nm l"/></div></figure><p id="8cd3" class="pw-post-body-paragraph ki kj iq kk b kl lf kn ko kp lg kr ks kt lh kv kw kx li kz la lb lj ld le kh ij bi translated">工作区由:<code class="fe mo mp mq mr b">yarn workspace &lt;workspacename&gt; &lt;scriptname&gt; </code>从我们运行的CI环境中访问，例如:<code class="fe mo mp mq mr b">npm run test</code>。</p><p id="b23c" class="pw-post-body-paragraph ki kj iq kk b kl lf kn ko kp lg kr ks kt lh kv kw kx li kz la lb lj ld le kh ij bi translated">我推荐阅读Yarn <a class="ae mn" href="https://classic.yarnpkg.com/en/docs/workspaces/" rel="noopener ugc nofollow" target="_blank">文档</a>了解更多关于它的特性。</p><p id="3b0c" class="pw-post-body-paragraph ki kj iq kk b kl lf kn ko kp lg kr ks kt lh kv kw kx li kz la lb lj ld le kh ij bi translated">📄<strong class="kk ir">源代码:</strong><a class="ae mn" href="https://github.com/amir0ff/reactjs-use-form" rel="noopener ugc nofollow" target="_blank">https://github.com/amir0ff/reactjs-use-form</a></p><h1 id="4a3c" class="lk ll iq bd lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh bi translated">让我们看看✨</h1><p id="9a1a" class="pw-post-body-paragraph ki kj iq kk b kl mi kn ko kp mj kr ks kt mk kv kw kx ml kz la lb mm ld le kh ij bi translated">这是我们的示例React应用程序更新，当它的一个依赖项更新时，因为Yarn正在以所需的方式链接依赖项，因为我们希望更改主模块文件并观察消费者组件(示例应用程序)中的更改。</p><figure class="nh ni nj nk gt jq gh gi paragraph-image"><div class="gh gi od"><img src="../Images/b26beaa6a7d657de4076be5931de65df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1140/1*V9J_SiNWogFhzFynI03Nng.gif"/></div><figcaption class="nn no gj gh gi np nq bd b be z dk"><code class="fe mo mp mq mr b">$<strong class="bd oe"> </strong>yarn workspace <strong class="bd oe">reactjs-use-form</strong> dev</code></figcaption></figure><figure class="nh ni nj nk gt jq gh gi paragraph-image"><div class="gh gi od"><img src="../Images/e6357d738537d2d8d925051f375fc52e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1140/1*N_02GolmbN9r5ATmVlJZIQ.gif"/></div><figcaption class="nn no gj gh gi np nq bd b be z dk"><code class="fe mo mp mq mr b">$<strong class="bd oe"> </strong>yarn workspace <strong class="bd oe">reactjs-use-form-example</strong> start</code></figcaption></figure><figure class="nh ni nj nk gt jq gh gi paragraph-image"><div class="gh gi od"><img src="../Images/2cd46ecd83ab76df7f8c506320d4b13e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1140/1*xDqXKuUGtjJEltAP9eOCXg.gif"/></div><figcaption class="nn no gj gh gi np nq bd b be z dk">changes in the IDE</figcaption></figure><figure class="nh ni nj nk gt jq gh gi paragraph-image"><div class="gh gi of"><img src="../Images/24967470fd8c73d5db9202e19ed0e122.png" data-original-src="https://miro.medium.com/v2/resize:fit:1004/1*lp3t2IPlfXej2_5yqNjVrA.gif"/></div><figcaption class="nn no gj gh gi np nq bd b be z dk">in the browser</figcaption></figure></div><div class="ab cl og oh hu oi" role="separator"><span class="oj bw bk ok ol om"/><span class="oj bw bk ok ol om"/><span class="oj bw bk ok ol"/></div><div class="ij ik il im in"><h1 id="7ce7" class="lk ll iq bd lm ln on lp lq lr oo lt lu lv op lx ly lz oq mb mc md or mf mg mh bi translated">结论</h1><p id="9c10" class="pw-post-body-paragraph ki kj iq kk b kl mi kn ko kp mj kr ks kt mk kv kw kx ml kz la lb mm ld le kh ij bi translated">我们设置了一个只有一个依赖项的React monorepo。已经打印好了。Yarn比npm快，所以我们也获得了速度提升！</p><p id="fe50" class="pw-post-body-paragraph ki kj iq kk b kl lf kn ko kp lg kr ks kt lh kv kw kx li kz la lb lj ld le kh ij bi translated">我希望你喜欢阅读，<br/>请<strong class="kk ir"> </strong> <a class="ae mn" href="https://medium.com/@amir0ff" rel="noopener"> <strong class="kk ir">关注</strong> </a>和<strong class="kk ir">分享</strong>更多科技内容🤖💖</p><figure class="nh ni nj nk gt jq gh gi paragraph-image"><div role="button" tabindex="0" class="jr js di jt bf ju"><div class="gh gi os"><img src="../Images/4876c1387b10213e26ba6418d19c9447.png" data-original-src="https://miro.medium.com/v2/resize:fit:292/1*ZSBco9mgoreP377dkXVJNQ.gif"/></div></div></figure><h2 id="44f5" class="nr ll iq bd lm ns nt dn lq nu nv dp lu kt nw nx ly kx ny nz mc lb oa ob mg oc bi translated">进一步阅读</h2><div class="ot ou gp gr ov ow"><a href="https://bit.cloud/blog/painless-monorepo-dependency-management-with-bit-l4f9fzyw" rel="noopener  ugc nofollow" target="_blank"><div class="ox ab fo"><div class="oy ab oz cl cj pa"><h2 class="bd ir gy z fp pb fr fs pc fu fw ip bi translated">使用Bit进行无痛monorepo依赖管理</h2><div class="pd l"><h3 class="bd b gy z fp pb fr fs pc fu fw dk translated">简化monorepo中的依赖关系管理，以避免虚拟依赖关系和版本问题。了解…</h3></div><div class="pe l"><p class="bd b dl z fp pb fr fs pc fu fw dk translated">比特云</p></div></div><div class="pf l"><div class="pg l ph pi pj pf pk jv ow"/></div></div></a></div><p id="262b" class="pw-post-body-paragraph ki kj iq kk b kl lf kn ko kp lg kr ks kt lh kv kw kx li kz la lb lj ld le kh ij bi translated"><em class="ng">更多内容请看</em><a class="ae mn" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><strong class="kk ir"><em class="ng">plain English . io</em></strong></a><em class="ng">。报名参加我们的</em> <a class="ae mn" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kk ir"> <em class="ng">免费周报</em> </strong> </a> <em class="ng">。关注我们关于</em><a class="ae mn" href="https://twitter.com/inPlainEngHQ" rel="noopener ugc nofollow" target="_blank"><strong class="kk ir"><em class="ng">Twitter</em></strong></a><a class="ae mn" href="https://www.linkedin.com/company/inplainenglish/" rel="noopener ugc nofollow" target="_blank"><strong class="kk ir"><em class="ng">LinkedIn</em></strong></a><strong class="kk ir"><em class="ng"/></strong><a class="ae mn" href="https://www.youtube.com/channel/UCtipWUghju290NWcn8jhyAw" rel="noopener ugc nofollow" target="_blank"><strong class="kk ir"><em class="ng">YouTube</em></strong></a><strong class="kk ir"><em class="ng">，以及</em></strong><em class="ng"/><a class="ae mn" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"><strong class="kk ir"><em class="ng">不和</em> </strong> </a>  <em class="ng">对成长黑客感兴趣？检查</em> <a class="ae mn" href="https://circuit.ooo/" rel="noopener ugc nofollow" target="_blank"> <strong class="kk ir"> <em class="ng">电路</em> </strong> </a> <strong class="kk ir"> <em class="ng">。</em> </strong></p></div></div>    
</body>
</html>