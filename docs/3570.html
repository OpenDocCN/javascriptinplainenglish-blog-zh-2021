<html>
<head>
<title/>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1/>
<blockquote>原文：<a href="https://javascript.plainenglish.io/use-ionic-angular-leaflet-to-build-a-pwa-to-show-a-map-that-works-offline-part-1-b69126386ce6?source=collection_archive---------2-----------------------#2021-07-18">https://javascript.plainenglish.io/use-ionic-angular-leaflet-to-build-a-pwa-to-show-a-map-that-works-offline-part-1-b69126386ce6?source=collection_archive---------2-----------------------#2021-07-18</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><h2 id="3a8d" class="il im in bd io ip iq dn ir is it dp iu iv iw ix iy iz ja jb jc jd je jf jg jh bi translated">使用Ionic和传单构建PWA地图应用程序🗺 🧭</h2><p id="41fd" class="pw-post-body-paragraph ji jj in jk b jl jm jn jo jp jq jr js iv jt ju jv iz jw jx jy jd jz ka kb kc ig bi translated">具有谷歌地址搜索集成，全球定位系统和层切换器。(逐步指南)</p><figure class="ke kf kg kh gt ki gh gi paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="gh gi kd"><img src="../Images/4111bb9e67ee88b32d89323b6b0c9c06.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*V44KKR8bjY188HE_LGnPEA.png"/></div></div></figure><p id="c5ea" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated">你好朋友，帕勒姆在这里与另一个分步指南。</p><p id="eb9d" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated">这一次，我们将构建一个显示地图的Ionic PWA应用程序，但这不是全部。</p><p id="66f7" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated">快速预览一下最终结果是什么:</p><figure class="ke kf kg kh gt ki"><div class="bz fp l di"><div class="ku kv l"/></div></figure><p id="7bac" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated">以下是应用程序的功能、实现每个部分时您可以学到的内容以及每个部分的难度:</p><h2 id="28a4" class="il im in bd io ip iq dn ir is it dp iu iv iw ix iy iz ja jb jc jd je jf jg jh bi translated">1.使用Ionic CLI创建一个空白应用程序。</h2><p id="4ecb" class="pw-post-body-paragraph ji jj in jk b jl jm jn jo jp jq jr js iv jt ju jv iz jw jx jy jd jz ka kb kc ig bi translated">您将学习如何使用Ionic CLI创建Ionic/Angular应用程序。(难度:简单)</p><h2 id="771d" class="il im in bd io ip iq dn ir is it dp iu iv iw ix iy iz ja jb jc jd je jf jg jh bi translated">2.将传单地图添加到您的Ionic应用程序。</h2><p id="f2d9" class="pw-post-body-paragraph ji jj in jk b jl jm jn jo jp jq jr js iv jt ju jv iz jw jx jy jd jz ka kb kc ig bi translated">你将学习如何实现一个离子，传单和角度的基本地图集成。(难度:简单)</p><h2 id="efc6" class="il im in bd io ip iq dn ir is it dp iu iv iw ix iy iz ja jb jc jd je jf jg jh bi translated">3.添加一个基础层切换器以在不同的基础地图之间切换</h2><p id="18af" class="pw-post-body-paragraph ji jj in jk b jl jm jn jo jp jq jr js iv jt ju jv iz jw jx jy jd jz ka kb kc ig bi translated">您将学习如何与基本的传单API交互，如<code class="fe kw kx ky kz b">TileLayer</code>、<code class="fe kw kx ky kz b">LayerGroup</code>和Map方法。(难度等级:中级)</p><h2 id="0e03" class="il im in bd io ip iq dn ir is it dp iu iv iw ix iy iz ja jb jc jd je jf jg jh bi translated">4.地理定位API集成使用设备GPS和查找用户当前位置</h2><p id="318f" class="pw-post-body-paragraph ji jj in jk b jl jm jn jo jp jq jr js iv jt ju jv iz jw jx jy jd jz ka kb kc ig bi translated">您将学习如何使用地理定位API来查找设备位置和处理相关错误。(难度等级:中级)</p><h2 id="2b22" class="il im in bd io ip iq dn ir is it dp iu iv iw ix iy iz ja jb jc jd je jf jg jh bi translated">5.地址搜索使用google地址搜索来查找位置。</h2><p id="0dca" class="pw-post-body-paragraph ji jj in jk b jl jm jn jo jp jq jr js iv jt ju jv iz jw jx jy jd jz ka kb kc ig bi translated">您将学习如何使用Google Places APIs进行地址搜索，并找到与地址相关的坐标。(难度等级:中级)</p><h2 id="22d0" class="il im in bd io ip iq dn ir is it dp iu iv iw ix iy iz ja jb jc jd je jf jg jh bi translated">6.做一个PWA</h2><p id="35b3" class="pw-post-body-paragraph ji jj in jk b jl jm jn jo jp jq jr js iv jt ju jv iz jw jx jy jd jz ka kb kc ig bi translated">你将学习如何使用<code class="fe kw kx ky kz b">@angular/pwa</code>让你的应用成为可安装的PWA。(难度等级:中级)</p><h2 id="93db" class="il im in bd io ip iq dn ir is it dp iu iv iw ix iy iz ja jb jc jd je jf jg jh bi translated">7.把它带回家</h2><p id="9b9b" class="pw-post-body-paragraph ji jj in jk b jl jm jn jo jp jq jr js iv jt ju jv iz jw jx jy jd jz ka kb kc ig bi translated">如果我们不能炫耀这一切，那么建造这一切又有什么意义呢？让我们使用<a class="ae la" href="https://vercel.com/" rel="noopener ugc nofollow" target="_blank"> Vercel </a>部署您的新应用，并向我们的朋友展示它😀(难度:简单)</p><p id="0d44" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated">下面是第一部分演示:<a class="ae la" href="https://ionic-angular-leaflet-offline-map-pwa-one.vercel.app/#/home" rel="noopener ugc nofollow" target="_blank">使用Vercel </a>部署的演示</p><p id="915d" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated">这里是Github代码库:<a class="ae la" href="https://github.com/pazel-io/ionic-angular-leaflet-offline-map-pwa.git" rel="noopener ugc nofollow" target="_blank">ionic-angular-leaflet-offline-map-pwa</a></p><p id="7b05" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated">本文最初发表于<a class="ae la" href="https://pazel.dev/ionic-angular-leaflet-pwa-offline-maps-part-1" rel="noopener ugc nofollow" target="_blank"> pazel.dev </a></p><h1 id="3c7c" class="lb im in bd io lc ld le ir lf lg lh iu li lj lk iy ll lm ln jc lo lp lq jg lr bi translated">我们开始吧</h1><h2 id="f0e1" class="il im in bd io ip iq dn ir is it dp iu iv iw ix iy iz ja jb jc jd je jf jg jh bi translated">1.使用Ionic CLI创建基础应用程序</h2><p id="1ad3" class="pw-post-body-paragraph ji jj in jk b jl jm jn jo jp jq jr js iv jt ju jv iz jw jx jy jd jz ka kb kc ig bi translated">如果您之前没有安装Ionic CLI，请前往<a class="ae la" href="https://ionicframework.com/docs/intro/cli" rel="noopener ugc nofollow" target="_blank">ionicframework.com/docs/intro/cli</a>并按照说明安装CLI。</p><p id="cb5b" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated">接下来，让我们通过运行ionic start <code class="fe kw kx ky kz b">ionic-leaflet-offline-map-pwa</code>使用CLI创建一个应用程序。CLI应提示您选择前端技术和更多选项。</p><figure class="ke kf kg kh gt ki gh gi paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="gh gi ls"><img src="../Images/a12c9922ab8056e8ed6897db218378ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*YyvFm0jwsyQe4hXz"/></div></div></figure><p id="10ff" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated">我将与角和空白启动项目。Ionic CLI询问您是否喜欢电容集成。这不是本教程所必需的。选择选项后，CLI将下载所有必需的npm软件包。(这可能需要几分钟)</p><p id="e3ff" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated">Ionic CLI询问您在npm软件包安装后是否需要一个免费的Ionic帐户。这不是本教程所必需的。您最终会看到一些日志，表明设置已经完成。</p><figure class="ke kf kg kh gt ki gh gi paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="gh gi lt"><img src="../Images/b2df841e2601100a560fd804f3b218a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*cxaJ-ha8Ot-O_15S"/></div></div></figure><p id="3a53" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated">让我们转到刚刚创建的新项目并运行<code class="fe kw kx ky kz b">ionic serve</code>。这将运行本地web服务器，并在您的默认浏览器中打开应用程序。(默认端口为8100)</p><figure class="ke kf kg kh gt ki gh gi paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="gh gi lu"><img src="../Images/06cf51a6b102dbd7df9cf60a991784cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*oLl97Psfeqc_1_Rb"/></div></div></figure><h2 id="73ef" class="il im in bd io ip iq dn ir is it dp iu iv iw ix iy iz ja jb jc jd je jf jg jh bi translated">2.使用传单添加地图</h2><p id="a678" class="pw-post-body-paragraph ji jj in jk b jl jm jn jo jp jq jr js iv jt ju jv iz jw jx jy jd jz ka kb kc ig bi translated"><a class="ae la" href="https://leafletjs.com/" rel="noopener ugc nofollow" target="_blank">传单</a>是一个开源的JavaScript库，用于移动友好的交互式地图。它提供了大量很酷的功能来处理地图。使用我们需要显示地图的功能，我们将只是触及表面。所以相对容易。</p><p id="3609" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated">我们使用有棱角的传单包装，以便于整合。我们将使用<code class="fe kw kx ky kz b">@asymmetrik/ngx-leaflet</code>项目。这个包不是Angular的官方部分，但它是可靠的，我在许多prod应用程序中使用过它。</p><p id="b005" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated">运行<code class="fe kw kx ky kz b">npm i leaflet @asymmetrik/ngx-leaflet</code>安装<code class="fe kw kx ky kz b">leaflet</code>和<code class="fe kw kx ky kz b">ngx-leaflet</code>。</p><p id="75a9" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated">我们喜欢打字稿，所以让我们添加适当的传单打字。</p><p id="d777" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated">运行<code class="fe kw kx ky kz b">npm i @types/leaflet -D</code>将类型作为开发依赖项安装。</p><p id="b1cf" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated">好了，我们完成了安装。让我们给我们的Angular应用程序添加一张地图吧！</p><p id="0493" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated">我将把地图添加到我们的<code class="fe kw kx ky kz b">HomePage(home.page.ts)</code>组件中。这很简单。</p><h2 id="87a3" class="il im in bd io ip iq dn ir is it dp iu iv iw ix iy iz ja jb jc jd je jf jg jh bi translated">将<code class="fe kw kx ky kz b">LeafletModule</code>添加到<code class="fe kw kx ky kz b">HomePageModule(home.module.ts)</code>中的<code class="fe kw kx ky kz b">imports</code>数组</h2><pre class="ke kf kg kh gt lv kz lw lx aw ly bi"><span id="2d2d" class="il im in kz b gy lz ma l mb mc">import { NgModule } from '@angular/core';<br/>import { CommonModule } from '@angular/common';<br/>import { LeafletModule } from '@asymmetrik/ngx-leaflet';<br/>import { IonicModule } from '@ionic/angular';<br/>import { FormsModule } from '@angular/forms';<br/>import { HomePage } from './home.page';</span><span id="bb07" class="il im in kz b gy md ma l mb mc">import { HomePageRoutingModule } from './home-routing.module';<br/></span><span id="1965" class="il im in kz b gy md ma l mb mc">@NgModule({<br/>  imports: [<br/>    CommonModule,<br/>    FormsModule,<br/>    IonicModule,<br/>    LeafletModule,<br/>    HomePageRoutingModule<br/>  ],<br/>  declarations: [HomePage]<br/>})<br/>export class HomePageModule {}</span></pre><h2 id="7508" class="il im in bd io ip iq dn ir is it dp iu iv iw ix iy iz ja jb jc jd je jf jg jh bi translated">添加地图<code class="fe kw kx ky kz b">options</code>和<code class="fe kw kx ky kz b">OnMapReady</code></h2><p id="21eb" class="pw-post-body-paragraph ji jj in jk b jl jm jn jo jp jq jr js iv jt ju jv iz jw jx jy jd jz ka kb kc ig bi translated"><code class="fe kw kx ky kz b">options</code>定义地图中心、最大缩放、基本图层等。</p><p id="8a2b" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated"><code class="fe kw kx ky kz b">onMapReady</code>将在活页地图准备就绪时被调用，并接收地图实例。稍后我们将需要这个实例与地图进行交互。</p><pre class="ke kf kg kh gt lv kz lw lx aw ly bi"><span id="6945" class="il im in kz b gy lz ma l mb mc">import { Component } from '@angular/core';<br/>import { Map as LMap, TileLayer } from 'leaflet';</span><span id="e252" class="il im in kz b gy md ma l mb mc">@Component({<br/>  selector: 'app-home',<br/>  templateUrl: 'home.page.html',<br/>  styleUrls: ['home.page.scss'],<br/>})<br/>export class HomePage {</span><span id="c4b4" class="il im in kz b gy md ma l mb mc">  public map: LMap;<br/>  public center = [<br/>    -28.690259,<br/>    131.5190514,<br/>  ];</span><span id="2958" class="il im in kz b gy md ma l mb mc">  public options = {<br/>    zoom: 5,<br/>    maxZoom: 18,<br/>    zoomControl: false,<br/>    preferCanvas: true,<br/>    attributionControl: true,<br/>    center: this.center,<br/>    layers: [<br/>      new TileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png')<br/>    ],<br/>  };</span><span id="2632" class="il im in kz b gy md ma l mb mc">  constructor() {}</span><span id="a84b" class="il im in kz b gy md ma l mb mc">  public async onMapReady(lMap: LMap) {<br/>    this.map = lMap;<br/>    setTimeout(() =&gt; lMap.invalidateSize(true), 0);<br/>  }</span><span id="f5ad" class="il im in kz b gy md ma l mb mc">}</span></pre><h2 id="cddf" class="il im in bd io ip iq dn ir is it dp iu iv iw ix iy iz ja jb jc jd je jf jg jh bi translated">在我们的<code class="fe kw kx ky kz b">home.page.html</code>中添加地图容器。</h2><pre class="ke kf kg kh gt lv kz lw lx aw ly bi"><span id="3677" class="il im in kz b gy lz ma l mb mc">&lt;ion-header [translucent]="true"&gt;<br/>  &lt;ion-toolbar&gt;<br/>    &lt;ion-title&gt;<br/>      Ionic Leaflet Map<br/>    &lt;/ion-title&gt;<br/>  &lt;/ion-toolbar&gt;<br/>&lt;/ion-header&gt;</span><span id="9399" class="il im in kz b gy md ma l mb mc">&lt;ion-content [fullscreen]="true"&gt;<br/>  &lt;div class="leaflet" leaflet<br/>       [leafletOptions]="options"<br/>       (leafletMapReady)="onMapReady($event)"&gt;<br/>  &lt;/div&gt;<br/>&lt;/ion-content&gt;</span></pre><h2 id="dfba" class="il im in bd io ip iq dn ir is it dp iu iv iw ix iy iz ja jb jc jd je jf jg jh bi translated">将活页CSS添加到我们的全球CSS列表中。</h2><p id="6a57" class="pw-post-body-paragraph ji jj in jk b jl jm jn jo jp jq jr js iv jt ju jv iz jw jx jy jd jz ka kb kc ig bi translated">打开项目根目录下的<code class="fe kw kx ky kz b">angular.json</code>文件，并从</p><p id="c16c" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated"><code class="fe kw kx ky kz b">"styles": ["src/theme/variables.scss", "src/global.scss"],</code>至:</p><pre class="ke kf kg kh gt lv kz lw lx aw ly bi"><span id="2f8d" class="il im in kz b gy lz ma l mb mc">"styles": ["src/theme/variables.scss", "src/global.scss", "./node_modules/leaflet/dist/leaflet.css"],</span></pre><p id="ada0" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated">并将地图容器CSS添加到<code class="fe kw kx ky kz b">home.page.scss</code>。更新后的文件如下所示。</p><pre class="ke kf kg kh gt lv kz lw lx aw ly bi"><span id="2d8f" class="il im in kz b gy lz ma l mb mc">.leaflet {<br/>  height: 100%;<br/>  width: 100%;<br/>  position: absolute;<br/>  z-index: 0;<br/>}</span></pre><p id="9fee" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated">重启服务器以确保新的CSS正确加载。您应该会看到这样的屏幕。</p><figure class="ke kf kg kh gt ki gh gi paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="gh gi lu"><img src="../Images/2a52fe1407004cce3005192fb413bb18.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ULdyUzJuDSW99irX"/></div></div></figure><p id="241d" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated">恭喜！我们现在已经将一张地图整合到了离子应用程序中。</p><h1 id="f974" class="lb im in bd io lc ld le ir lf lg lh iu li lj lk iy ll lm ln jc lo lp lq jg lr bi translated">3.添加切换基础地图的功能</h1><p id="0203" class="pw-post-body-paragraph ji jj in jk b jl jm jn jo jp jq jr js iv jt ju jv iz jw jx jy jd jz ka kb kc ig bi translated">我们已经在定义的<code class="fe kw kx ky kz b">options</code>中添加了一个基础地图。我想改变它，使用自行车和交通基础地图，并使用一个按钮在它们之间切换。</p><p id="d186" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated">让我们想象一下，从离子添加一个FAB按钮来进行层切换。继续，在您的<code class="fe kw kx ky kz b">&lt;ion-content&gt;</code>内添加一个带有选项列表的FAB按钮。更新后的代码如下所示。</p><pre class="ke kf kg kh gt lv kz lw lx aw ly bi"><span id="3c85" class="il im in kz b gy lz ma l mb mc">&lt;ion-header [translucent]="true"&gt;<br/>  &lt;ion-toolbar&gt;<br/>    &lt;ion-title&gt;<br/>      Ionic Leaflet Map<br/>    &lt;/ion-title&gt;<br/>  &lt;/ion-toolbar&gt;<br/>&lt;/ion-header&gt;</span><span id="e16d" class="il im in kz b gy md ma l mb mc">&lt;ion-content [fullscreen]="true"&gt;<br/>  &lt;ion-fab vertical="top" horizontal="end" slot="fixed"&gt;<br/>    &lt;ion-fab-button&gt;<br/>      &lt;ion-icon name="layers-outline"&gt;&lt;/ion-icon&gt;<br/>    &lt;/ion-fab-button&gt;<br/>    &lt;ion-fab-list side="bottom"&gt;<br/>      &lt;ion-fab-button color="danger"&gt;<br/>        &lt;ion-icon name="bicycle"&gt;&lt;/ion-icon&gt;<br/>      &lt;/ion-fab-button&gt;<br/>      &lt;ion-fab-button&gt;<br/>        &lt;ion-icon name="car"&gt;&lt;/ion-icon&gt;<br/>      &lt;/ion-fab-button&gt;<br/>    &lt;/ion-fab-list&gt;<br/>  &lt;/ion-fab&gt;<br/>  &lt;div class="leaflet" leaflet<br/>       [leafletOptions]="options"<br/>       (leafletMapReady)="onMapReady($event)"&gt;<br/>  &lt;/div&gt;<br/>&lt;/ion-content&gt;</span></pre><p id="710a" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated">更新后的屏幕将在右上角有一个FAB按钮，有两个选项(骑自行车和运输)可供选择。</p><figure class="ke kf kg kh gt ki gh gi paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="gh gi lu"><img src="../Images/e70866bc09b8061215c7b30a1a208552.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*690BG5sPBgIxWuIR"/></div></div></figure><p id="b5f7" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated">当我们点击新按钮时，我们需要添加代码来实际切换基础地图。别担心。我抓住你了！</p><p id="f3ec" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated">我会给你看更新后的代码，我们会一个接一个地进行修改。这是新的<code class="fe kw kx ky kz b">home.page.ts</code>文件。</p><pre class="ke kf kg kh gt lv kz lw lx aw ly bi"><span id="159a" class="il im in kz b gy lz ma l mb mc">import { Component } from '@angular/core';<br/>import { LayerGroup, Map as LMap, TileLayer } from 'leaflet';<br/>import { BaseLayer } from './BaseLayer.enum';</span><span id="edd8" class="il im in kz b gy md ma l mb mc">@Component({<br/>  selector: 'app-home',<br/>  templateUrl: 'home.page.html',<br/>  styleUrls: ['home.page.scss'],<br/>})<br/>export class HomePage {</span><span id="c7fa" class="il im in kz b gy md ma l mb mc">  public map: LMap;<br/>  public center = [<br/>    -37.8182711,<br/>    144.9648731<br/>  ];</span><span id="c2d0" class="il im in kz b gy md ma l mb mc">  public options = {<br/>    zoom: 15,<br/>    maxZoom: 18,<br/>    zoomControl: false,<br/>    preferCanvas: true,<br/>    attributionControl: true,<br/>    center: this.center,<br/>  };</span><span id="1efb" class="il im in kz b gy md ma l mb mc">  public baseMapUrls = {<br/>    [BaseLayer.cycling]: 'http://c.tile.thunderforest.com/cycle/{z}/{x}/{y}.png',<br/>    [BaseLayer.transport]: 'http://c.tile.thunderforest.com/transport/{z}/{x}/{y}.png',<br/>  };</span><span id="0f9d" class="il im in kz b gy md ma l mb mc">  public selectedBaseLayer = BaseLayer.cycling;</span><span id="3edc" class="il im in kz b gy md ma l mb mc">  public baseLayer = BaseLayer;</span><span id="36e4" class="il im in kz b gy md ma l mb mc">  private baseMapLayerGroup = new LayerGroup();</span><span id="34f1" class="il im in kz b gy md ma l mb mc">  constructor() {<br/>  }</span><span id="25f5" class="il im in kz b gy md ma l mb mc">  public async onMapReady(lMap: LMap) {<br/>    this.map = lMap;<br/>    this.map.addLayer(this.baseMapLayerGroup);<br/>    this.switchBaseLayer(this.selectedBaseLayer);<br/>    setTimeout(() =&gt; lMap.invalidateSize(true), 0);<br/>  }</span><span id="985d" class="il im in kz b gy md ma l mb mc">  public switchBaseLayer(baseLayerName: string) {<br/>    this.baseMapLayerGroup.clearLayers();<br/>    const baseMapTileLayer = new TileLayer(this.baseMapUrls[baseLayerName]);<br/>    this.baseMapLayerGroup.addLayer(baseMapTileLayer);<br/>    this.selectedBaseLayer = BaseLayer[baseLayerName];<br/>  }</span><span id="f03a" class="il im in kz b gy md ma l mb mc">}</span></pre><p id="08a4" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated">我从地图<code class="fe kw kx ky kz b">options</code>中移除了<code class="fe kw kx ky kz b">layers</code>数组，取而代之的是，我添加了底图，一个对象。键是地图名称，值是地图切片的URL。对于键，我使用了TypeScript枚举，以便在重用相同的字符串时更容易。Enum位于一个名为<code class="fe kw kx ky kz b">BaseLayer.enum.ts</code>的新文件中，下面是代码:</p><pre class="ke kf kg kh gt lv kz lw lx aw ly bi"><span id="7a5f" class="il im in kz b gy lz ma l mb mc">export enum BaseLayer {<br/>  cycling = 'cycling',<br/>  transport = 'transport',<br/>}</span></pre><p id="b5ce" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated">接下来，我们有<code class="fe kw kx ky kz b">selectedBaseLayer</code>属性来跟踪用户选择了哪个基层。我已经使用相同的枚举用循环基础地图初始化了它。</p><p id="b02d" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated">接下来，我们有指向<code class="fe kw kx ky kz b">BaseLayer</code>枚举的<code class="fe kw kx ky kz b">baseLayer</code>属性。这是为了让枚举对我们的地图HTML模板可用，并在那里使用它。</p><p id="9532" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated">接下来，我们有<code class="fe kw kx ky kz b">private baseMapLayerGroup = new LayerGroup();</code>。<code class="fe kw kx ky kz b">LayerGroup</code>是一种在地图上对多个图层进行分组并将它们与其他图层分开的活页方式。在这里使用它可以更容易地管理基础层。我们以后会使用更多的图层组来添加地址搜索和GPS搜索结果。</p><p id="c4f1" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated">接下来，我们有<code class="fe kw kx ky kz b">switchBaseLayer</code>法。它采用一个基本层名称，并可以切换基本层。它首先清除图层组中的任何图层，然后通过从<code class="fe kw kx ky kz b">baseMapUrls</code>对象中查找配置来添加新图层。请注意，我们添加的图层属于<code class="fe kw kx ky kz b">TileLayer</code>类型。传单世界中的这种特殊类型的图层可以显示用于基础地图的图块。</p><p id="2454" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated">这是你在HTML中需要的改变。基本上是给按钮添加了<code class="fe kw kx ky kz b">click</code>功能。此外，检查<code class="fe kw kx ky kz b">selectedBaseLayer</code>将代表所选基础层的按钮颜色变为红色(危险)，以突出显示该按钮的颜色。请注意，我使用了相同的<code class="fe kw kx ky kz b">BaseLayer</code>枚举值来最大化重用，而不是重复我自己。</p><pre class="ke kf kg kh gt lv kz lw lx aw ly bi"><span id="5a97" class="il im in kz b gy lz ma l mb mc">&lt;ion-header [translucent]="true"&gt;<br/>  &lt;ion-toolbar&gt;<br/>    &lt;ion-title&gt;<br/>      Ionic Leaflet Map<br/>    &lt;/ion-title&gt;<br/>  &lt;/ion-toolbar&gt;<br/>&lt;/ion-header&gt;</span><span id="dde4" class="il im in kz b gy md ma l mb mc">&lt;ion-content [fullscreen]="true"&gt;<br/>  &lt;ion-fab vertical="top" horizontal="end" slot="fixed"&gt;<br/>    &lt;ion-fab-button&gt;<br/>      &lt;ion-icon name="layers-outline"&gt;&lt;/ion-icon&gt;<br/>    &lt;/ion-fab-button&gt;<br/>    &lt;ion-fab-list side="bottom"&gt;<br/>      &lt;ion-fab-button [color]="selectedBaseLayer === baseLayer.cycling ? 'danger' : 'primary'"<br/>                      (click)="switchBaseLayer(baseLayer.cycling)"&gt;<br/>        &lt;ion-icon name="bicycle"&gt;&lt;/ion-icon&gt;<br/>      &lt;/ion-fab-button&gt;<br/>      &lt;ion-fab-button [color]="selectedBaseLayer === baseLayer.transport ? 'danger' : 'primary'"<br/>                      (click)="switchBaseLayer(baseLayer.transport)"&gt;<br/>        &lt;ion-icon name="car"&gt;&lt;/ion-icon&gt;<br/>      &lt;/ion-fab-button&gt;<br/>    &lt;/ion-fab-list&gt;<br/>  &lt;/ion-fab&gt;<br/>  &lt;div class="leaflet" leaflet<br/>       [leafletOptions]="options"<br/>       (leafletMapReady)="onMapReady($event)"&gt;<br/>  &lt;/div&gt;<br/>&lt;/ion-content&gt;</span></pre><h1 id="8d9e" class="lb im in bd io lc ld le ir lf lg lh iu li lj lk iy ll lm ln jc lo lp lq jg lr bi translated">4.使用设备GPS并找到用户的当前位置</h1><p id="e1d6" class="pw-post-body-paragraph ji jj in jk b jl jm jn jo jp jq jr js iv jt ju jv iz jw jx jy jd jz ka kb kc ig bi translated">我们将使用<a class="ae la" href="https://developer.mozilla.org/en-US/docs/Web/API/Geolocation_API" rel="noopener ugc nofollow" target="_blank">地理定位API </a>来查找设备位置。这是一个标准的web API。出于隐私原因，用户将被要求授权访问他们的位置。因此，用户可以允许或拒绝访问，我们需要处理这个过程中的潜在错误。</p><p id="d856" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated">首先，让我们添加一个方法来读取设备的位置。</p><pre class="ke kf kg kh gt lv kz lw lx aw ly bi"><span id="8706" class="il im in kz b gy lz ma l mb mc">public async locate() {<br/>    this.locationLayerGroup.clearLayers();<br/>    if (!navigator.geolocation) {<br/>      console.error('Geolocation is not supported by your browser');<br/>      return;<br/>    }<br/>    await this.presentLoading();<br/>    navigator.geolocation.getCurrentPosition(<br/>      (position) =&gt; this.onLocationSuccess(position),<br/>      (error) =&gt; this.onLocateError(error),<br/>      {enableHighAccuracy: true}<br/>    );<br/>  }</span></pre><p id="da8e" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated">你可能已经注意到了，我已经在名为<code class="fe kw kx ky kz b">locationLayerGroup</code>的地图上添加了另一个用于GPS定位的<code class="fe kw kx ky kz b">LayerGroup</code>。</p><p id="1144" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated">接下来，我正在检查是否支持<code class="fe kw kx ky kz b">navigator.geolocation</code>。注意，如果不支持，我会记录一个错误，并使用<code class="fe kw kx ky kz b">return</code>语句退出该函数。与使用if/else相比，这是一个更好的选择，并且使您的代码更具可读性。</p><p id="ba91" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated">如果它受支持，我会显示一条加载消息。然后，我调用<code class="fe kw kx ky kz b">getCurrentPosition</code>，它返回设备的当前位置(如果您喜欢观察位置，还有另一种方法，这有利于跟踪用例)。</p><p id="da0e" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated"><code class="fe kw kx ky kz b">getCurrentPosition</code>需要三个参数。首先，成功回调函数，当位置被成功获取时调用。第二个是错误回调，如果有错误就会调用它。像位置访问被拒绝或超时错误，如果GPS卫星不可用。第三个是<code class="fe kw kx ky kz b">PositionOptions</code>，我用它来启用<code class="fe kw kx ky kz b">HighAccuracy</code>位置。启用此选项将导致位置读取花费更长时间，但会使它更准确。</p><p id="6c37" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated">下面是成功回调的代码</p><pre class="ke kf kg kh gt lv kz lw lx aw ly bi"><span id="5900" class="il im in kz b gy lz ma l mb mc">private onLocationSuccess(position: GeolocationPosition) {<br/>    const {accuracy, latitude, longitude} = position.coords;<br/>    const latlng = [latitude, longitude];<br/>    this.hideLoading();<br/>    this.map.setView(latlng, 18);<br/>    const accuracyValue = accuracy &gt; 1000 ? accuracy / 1000 : accuracy;<br/>    const accuracyUnit = accuracy &gt; 1000 ? 'km' : 'm';<br/>    placeLocationMarker(this.locationLayerGroup, latlng, `Accuracy is ${accuracyValue} ${accuracyUnit}`);<br/>    const locationCircle = circle(latlng, accuracy);<br/>    this.locationLayerGroup.addLayer(locationCircle);<br/>  }</span></pre><p id="7c1c" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated">这里我从我收到的<code class="fe kw kx ky kz b">GeolocationPosition</code>中读取一些属性。我使用纬度和经度创建一个传单LatLng数组，可以在地图上居中。为此，我使用了地图的<code class="fe kw kx ky kz b">setView</code>方法，传递了一个缩放级别(18)。</p><p id="ef99" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated">我们在这里得到的精度是米，所以如果它大于1000，我就把它转换成千米，这样在呈现给用户时可读性更好。</p><p id="2a83" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated">我使用<code class="fe kw kx ky kz b">placeLocationMarker</code>在地图上显示设备位置的标记。我提取了这个函数，因为我想在标记上显示一个工具提示，它显示了精确度。由于这是一个传单工具提示，整个DOM的创建都是由传单处理的，所以如何处理触摸事件就有点复杂了。这种复杂性在<code class="fe kw kx ky kz b">placeLocationMarker</code>函数中处理。</p><p id="a332" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated">最后，我使用活页<code class="fe kw kx ky kz b">circle</code>功能在地图上画了一个圆，直观地向用户展示了精度。这个圆以设备位置为中心，半径和精度一样大。</p><p id="4d0a" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated">在你觉得太无聊之前，以下是结果</p><figure class="ke kf kg kh gt ki gh gi paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="gh gi lu"><img src="../Images/4a2369c8d788dfe66abfd5f814f717ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*4eJVrm4B4RcyPOam"/></div></div></figure><p id="39bc" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated">请注意，我使用Chrome Devtools来伪造GPS位置。您可以通过点击控制台旁边的三个点并选择<code class="fe kw kx ky kz b">Sensors</code>在<code class="fe kw kx ky kz b">console</code>选项卡中访问该功能。</p><figure class="ke kf kg kh gt ki gh gi paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="gh gi me"><img src="../Images/cb068c23fac810c2a91654367f589403.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*eFcbdLM5hWUJftCA"/></div></div></figure><p id="5317" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated">好了，我们来快速看一下错误回调。这个很简单。出错时，我们隐藏加载并使用Ionic的警报组件通知用户问题。可能会发生3个错误。权限被拒绝，超时，位置不可用。前两种情况很明显，第三种可能发生在GPS硬件出现故障时。对于每个错误，您都会得到一条消息和代码。如果你需要定制信息，使用代码并起草你自己的信息。</p><pre class="ke kf kg kh gt lv kz lw lx aw ly bi"><span id="2d43" class="il im in kz b gy lz ma l mb mc">private async onLocateError(error) {<br/>    this.hideLoading();<br/>    const alert = await this.alertController.create({<br/>      header: 'GPS error',<br/>      message: error.message,<br/>      buttons: ['OK']<br/>    });</span><span id="a5dc" class="il im in kz b gy md ma l mb mc">    await alert.present();<br/>  }</span></pre><p id="0f6e" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated">最后，这里是<code class="fe kw kx ky kz b">placeLocationMarker</code>函数的代码。此代码位于同名的单独文件中。它做三件事。</p><ul class=""><li id="393f" class="mf mg in jk b jl kp jp kq iv mh iz mi jd mj kc mk ml mm mn bi translated">使用自定义图标创建传单标记。</li><li id="b062" class="mf mg in jk b jl mo jp mp iv mq iz mr jd ms kc mk ml mm mn bi translated">将传单弹出绑定到显示精确度值和删除链接按钮的标记。为什么我们需要删除？因为当用户向地图添加标记时，他们需要一种方法在完成后将其移除。</li><li id="cd50" class="mf mg in jk b jl mo jp mp iv mq iz mr jd ms kc mk ml mm mn bi translated">侦听特定标记弹出窗口上的click事件，以处理删除按钮单击。如前所述，这里的DOM操作完全发生在Angular世界之外，所以我使用RxJS <code class="fe kw kx ky kz b">fromEvent</code>函数来过滤和接收来自这个删除按钮的点击事件。</li></ul><p id="56c1" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated">只有当弹出窗口打开时，才会订阅click事件，一旦关闭，就会取消订阅。</p><p id="344b" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated">这里的另一个好的实践是提取<code class="fe kw kx ky kz b">placeLocationMarker</code>。这使得它尽可能的纯净。所以这个函数只依赖于它的输入来运行。</p><pre class="ke kf kg kh gt lv kz lw lx aw ly bi"><span id="9e31" class="il im in kz b gy lz ma l mb mc">import { LatLng, LayerGroup, marker, Marker } from 'leaflet';<br/>import { fromEvent, Subscription } from 'rxjs';<br/>import { filter, map, tap } from 'rxjs/operators';<br/>import { markerIcon } from './markerIcon';</span><span id="8e84" class="il im in kz b gy md ma l mb mc">const subscribeToDeleteLocationMarker = (id: string, marco: Marker, layerGroup: LayerGroup): Subscription =&gt; {<br/>  return fromEvent(document, 'click')<br/>    .pipe(<br/>      tap((event) =&gt; event.stopPropagation()),<br/>      map((event) =&gt; event.target),<br/>      filter((target: HTMLElement) =&gt; target.id === id),<br/>    )<br/>    .subscribe(($event) =&gt; layerGroup.clearLayers());<br/>};</span><span id="ce79" class="il im in kz b gy md ma l mb mc">const bindMarkerPopup = (marco: Marker, text: string, layerGroup: LayerGroup) =&gt; {<br/>  const id = `location-marker-${Date.now()}`;<br/>  marco.bindPopup(`<br/>        &lt;p&gt;${text}&lt;/p&gt;<br/>        &lt;div class="location-marker-popup__buttons"&gt;<br/>            &lt;a class="location-marker-popup__button" id="${id}"&gt;delete&lt;/a&gt;<br/>        &lt;/div&gt;<br/>      `,          {<br/>    maxWidth: 200,<br/>    maxHeight: 120,<br/>    className: 'location-marker-popup',<br/>  });<br/>  let deleteMarkerSubscription;<br/>  marco.on('popupopen', () =&gt; deleteMarkerSubscription = subscribeToDeleteLocationMarker(id, marco, layerGroup));<br/>  marco.on('popupclose', () =&gt; deleteMarkerSubscription.unsubscribe());<br/>  marco.openPopup();<br/>};</span><span id="5dee" class="il im in kz b gy md ma l mb mc">export const placeLocationMarker = (layerGroup: LayerGroup, latLng: LatLng, text: string) =&gt; {<br/>  layerGroup.clearLayers();<br/>  const marco = marker(latLng, {icon: markerIcon()});<br/>  layerGroup.addLayer(marco);<br/>  bindMarkerPopup(marco, text, layerGroup);<br/>};</span></pre><h1 id="36b2" class="lb im in bd io lc ld le ir lf lg lh iu li lj lk iy ll lm ln jc lo lp lq jg lr bi translated">6.做一个PWA</h1><p id="57fe" class="pw-post-body-paragraph ji jj in jk b jl jm jn jo jp jq jr js iv jt ju jv iz jw jx jy jd jz ka kb kc ig bi translated">这一步很简单，因为Angular CLI会为您完成所有繁重的工作。只需运行<code class="fe kw kx ky kz b">npx ng add @angular/pwa</code>。该命令会将所有必需的包添加到您的项目中，配置您的服务人员，并添加用于缓存的默认资产。您可能需要与之交互的唯一文件是<code class="fe kw kx ky kz b">ngsw-config.json</code>。</p><p id="ab40" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated">这个文件告诉Angular service worker，要缓存什么资产以及使用什么缓存策略。</p><p id="2c3b" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated">例如，当所有图像资产都被延迟缓存时，所有JS文件都被急切地缓存。您可以在<a class="ae la" href="https://angular.io/guide/service-worker-config#assetgroups" rel="noopener ugc nofollow" target="_blank">维修工人配置</a>的Angular文档中了解更多关于管理该文件的信息。</p><pre class="ke kf kg kh gt lv kz lw lx aw ly bi"><span id="b074" class="il im in kz b gy lz ma l mb mc">{<br/>  "$schema": "./node_modules/@angular/service-worker/config/schema.json",<br/>  "index": "/index.html",<br/>  "assetGroups": [<br/>    {<br/>      "name": "app",<br/>      "installMode": "prefetch",<br/>      "resources": {<br/>        "files": [<br/>          "/favicon.ico",<br/>          "/index.html",<br/>          "/manifest.webmanifest",<br/>          "/*.css",<br/>          "/*.js"<br/>        ]<br/>      }<br/>    },<br/>    {<br/>      "name": "assets",<br/>      "installMode": "lazy",<br/>      "updateMode": "prefetch",<br/>      "resources": {<br/>        "files": [<br/>          "/assets/**",<br/>          "/*.(eot|svg|cur|jpg|png|webp|gif|otf|ttf|woff|woff2|ani)"<br/>        ]<br/>      }<br/>    }<br/>  ]<br/>}</span></pre><p id="4936" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated">和往常一样，确保在本地测试您的PWA。为此，运行构建命令<code class="fe kw kx ky kz b">ionic build</code>。</p><p id="f8f6" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated">这将生成<code class="fe kw kx ky kz b">www</code>文件夹。此文件夹中的应用程序是PWA。你可以使用像<code class="fe kw kx ky kz b">serve</code>这样的本地服务器来运行它。</p><p id="5bd6" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated">服务人员要求应用程序托管在安全的环境中。为了服务于构建，我们使用本地节点服务器。通过运行<code class="fe kw kx ky kz b">npm i serve -g</code>安装<code class="fe kw kx ky kz b">npmjs.com/package/serve</code>。</p><p id="258a" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated">接下来，我们可以运行<code class="fe kw kx ky kz b">serve www</code>命令。这在<a class="ae la" href="http://localhost:5000/" rel="noopener ugc nofollow" target="_blank"> localhost:5000 </a>上运行应用程序，幸运的是，使用localhost被认为是安全的，你现在不需要HTTPS origin来测试我们的PWA。</p><figure class="ke kf kg kh gt ki gh gi paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="gh gi mt"><img src="../Images/eb4ff5eeeb5ba3a93ace905130494733.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*s7HS7A_ByLgY9WjP"/></div></div></figure><p id="7fa3" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated">在chrome中打开一个隐身窗口，打开<code class="fe kw kx ky kz b">http://localhost:5000</code>。你会注意到另一个问题。当您刷新页面时，应用程序将不会加载。这是因为<code class="fe kw kx ky kz b">serve</code>试图找到<code class="fe kw kx ky kz b">localhost:5000/home</code>并期望一个包含index.html文件的主文件夹，而这个文件并不存在。有多种方法可以解决这个问题。对于本教程，我将使用散列路由。</p><p id="62be" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated">你需要做的所有改变就是转到你的<code class="fe kw kx ky kz b">app-routing.module.ts</code>文件，并将<code class="fe kw kx ky kz b">useHash: true</code>添加到你的路由器选项中。现在，页面URL将看起来像localhost:5000/#/home，您可以毫无问题地刷新。</p><pre class="ke kf kg kh gt lv kz lw lx aw ly bi"><span id="d087" class="il im in kz b gy lz ma l mb mc">import { NgModule } from '@angular/core';<br/>import { PreloadAllModules, RouterModule, Routes } from '@angular/router';</span><span id="f186" class="il im in kz b gy md ma l mb mc">const routes: Routes = [<br/>  {<br/>    path: 'home',<br/>    loadChildren: () =&gt; import('./home/home.module').then( m =&gt; m.HomePageModule)<br/>  },<br/>  {<br/>    path: '',<br/>    redirectTo: 'home',<br/>    pathMatch: 'full'<br/>  },<br/>];</span><span id="32f2" class="il im in kz b gy md ma l mb mc">@NgModule({<br/>  imports: [<br/>    RouterModule.forRoot(routes, { preloadingStrategy: PreloadAllModules, useHash: true })<br/>  ],<br/>  exports: [RouterModule]<br/>})<br/>export class AppRoutingModule { }</span></pre><p id="a738" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated">修复路由问题后，打开“localhost:5000”。然后打开Chrome Devtools，打开Lighthouse选项卡，为Progressive web app生成报告。这是我的测试结果，显示PWA应用程序有一个问题需要解决。</p><ul class=""><li id="e78a" class="mf mg in jk b jl kp jp kq iv mh iz mi jd mj kc mk ml mm mn bi translated">没有苹果触摸图标。</li></ul><p id="a5c6" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated">将以下代码添加到index.html的head标记中，以解决第二个和第三个问题。</p><pre class="ke kf kg kh gt lv kz lw lx aw ly bi"><span id="e603" class="il im in kz b gy lz ma l mb mc">&lt;link rel="apple-touch-icon" href="%PUBLIC_URL%/assets/icon/icon-192x192.png"&gt;</span></pre><p id="39af" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated">我们都准备好了。让我们再次构建和测试PWA应用程序。运行<code class="fe kw kx ky kz b">ionic build</code>，然后运行<code class="fe kw kx ky kz b">serve www</code>。打开Chrome隐姓埋名窗口，用Lighthouse测试。</p><p id="6b72" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated">您应该看到这样的结果，表明您的PWA已经准备好并可以安装了。</p><figure class="ke kf kg kh gt ki gh gi paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="gh gi lu"><img src="../Images/3c0ac9762a592a63801fd467987555d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*me7Ijqd2Yi-hEHTf"/></div></div></figure><p id="4956" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated">如果你想测试安装，你可以在一个正常的窗口打开你的应用程序(不是匿名的)，你应该可以在Chrome地址栏看到安装按钮。</p><h1 id="2529" class="lb im in bd io lc ld le ir lf lg lh iu li lj lk iy ll lm ln jc lo lp lq jg lr bi translated">7.使用Vercel在不到5分钟内部署您的新应用</h1><p id="e791" class="pw-post-body-paragraph ji jj in jk b jl jm jn jo jp jq jr js iv jt ju jv iz jw jx jy jd jz ka kb kc ig bi translated">为了在手机上测试我们的PWA，可以更容易地部署应用程序，通过HTTPS上的URL轻松访问它。我会用Vercel做这个。Vercel是一个零配置的云CI/CD，它可以理解我们的Ionic项目的结构，并开箱即用地进行部署。</p><p id="a686" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated">为此，请前往<a class="ae la" href="http://vercel.com/" rel="noopener ugc nofollow" target="_blank">vercel.com</a>注册一个免费账户。</p><p id="a391" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated">登录，您可以选择从您的Git repo导入一个项目。如前所述，我正在使用Github。所以我将从我的Github导入项目。</p><p id="b4ef" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated">Vercel已经知道您的项目是Ionic Angular，并且知道运行什么命令来构建它。只需点击部署即可。这将运行构建并为您提供一个URL，您的项目将在该URL上可用。</p><p id="129f" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated">只需点击“访问”按钮即可访问您部署的应用程序。</p><figure class="ke kf kg kh gt ki gh gi paragraph-image"><div role="button" tabindex="0" class="kj kk di kl bf km"><div class="gh gi mu"><img src="../Images/798f134731cfdfd52940ea53a735ac5c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*g5a8D0g7El5gm51t"/></div></div></figure><h1 id="1baa" class="lb im in bd io lc ld le ir lf lg lh iu li lj lk iy ll lm ln jc lo lp lq jg lr bi translated">结论</h1><p id="3881" class="pw-post-body-paragraph ji jj in jk b jl jm jn jo jp jq jr js iv jt ju jv iz jw jx jy jd jz ka kb kc ig bi translated">如果您已经完成了本教程，那么恭喜您。👏</p><p id="0210" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated">感谢阅读。我将在这里结束第一部分，希望您在第二部分继续关注更多令人兴奋的特性。</p><p id="a065" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated">像往常一样，如果你有任何问题，请在这里给我留言或在Twitter上给我发DM。</p><p id="f8af" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated">下面是演示:<a class="ae la" href="https://ionic-angular-leaflet-offline-map-pwa-one.vercel.app/#/home" rel="noopener ugc nofollow" target="_blank">使用Vercel </a>部署的演示</p><p id="5e28" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated">这里是代码库:<a class="ae la" href="https://github.com/pazel-io/ionic-angular-leaflet-offline-map-pwa.git" rel="noopener ugc nofollow" target="_blank">离子-角度-传单-离线-地图-pwa </a></p><p id="99ec" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated">推特:<a class="ae la" href="https://twitter.com/_pazel" rel="noopener ugc nofollow" target="_blank">_帕泽尔</a></p><p id="391e" class="pw-post-body-paragraph ji jj in jk b jl kp jn jo jp kq jr js iv kr ju jv iz ks jx jy jd kt ka kb kc ig bi translated"><em class="mv">更多内容请看</em><a class="ae la" href="http://plainenglish.io" rel="noopener ugc nofollow" target="_blank"><strong class="jk mw"><em class="mv">plain English . io</em></strong></a></p></div></div>    
</body>
</html>