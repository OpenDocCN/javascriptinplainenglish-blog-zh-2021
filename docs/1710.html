<html>
<head>
<title>How to create an Authentication System using JWT and Node.js</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用JWT和Node.js创建认证系统</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/authentication-systems-using-jwt-and-node-js-9c3cc14aaf82?source=collection_archive---------0-----------------------#2021-04-12">https://javascript.plainenglish.io/authentication-systems-using-jwt-and-node-js-9c3cc14aaf82?source=collection_archive---------0-----------------------#2021-04-12</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/146eb493a995c643777945fab862c066.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IHssbtIDUCY9feEBJn4Zbg.jpeg"/></div></div></figure><h2 id="4681" class="jv jw in bd jx jy jz dn ka kb kc dp kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">本教程简介</h2><p id="fd08" class="pw-post-body-paragraph kr ks in kt b ku kv kw kx ky kz la lb ke lc ld le ki lf lg lh km li lj lk ll ig bi translated">在本教程中，您将了解如何在Node.js中使用JSON Web令牌(JWT)来验证用户身份。如果你对JWT不熟悉，你可以点击这里的链接<a class="ae lm" href="https://medium.com/swlh/understand-the-concept-of-jwt-json-web-tokens-4ee18682a583" rel="noopener"/>——这用许多有趣的例子解释了JWT的一切。</p><p id="952d" class="pw-post-body-paragraph kr ks in kt b ku ln kw kx ky lo la lb ke lp ld le ki lq lg lh km lr lj lk ll ig bi translated">在本教程中，我们将使用Node.js为注册、登录和注销创建API。首先，让我们回忆一下JWT的基础知识。</p><p id="4a4a" class="pw-post-body-paragraph kr ks in kt b ku ln kw kx ky lo la lb ke lp ld le ki lq lg lh km lr lj lk ll ig bi translated">JW令牌由3部分组成:</p><h2 id="eabd" class="jv jw in bd jx jy jz dn ka kb kc dp kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">1.页眉</h2><p id="4e79" class="pw-post-body-paragraph kr ks in kt b ku kv kw kx ky kz la lb ke lc ld le ki lf lg lh km li lj lk ll ig bi translated">报头包括用于生成令牌的算法类型。看起来是这样的:</p><pre class="ls lt lu lv gt lw lx ly lz aw ma bi"><span id="1b03" class="jv jw in lx b gy mb mc l md me">{<br/> “alg”: “HS256”,<br/> “typ”: “JWT”<br/>}</span></pre><h2 id="ed9e" class="jv jw in bd jx jy jz dn ka kb kc dp kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">2.<strong class="ak">有效载荷</strong></h2><p id="3812" class="pw-post-body-paragraph kr ks in kt b ku kv kw kx ky kz la lb ke lc ld le ki lf lg lh km li lj lk ll ig bi translated">有效负载就是用户数据。</p><pre class="ls lt lu lv gt lw lx ly lz aw ma bi"><span id="1f13" class="jv jw in lx b gy mb mc l md me">{<br/> “id”:”920021",<br/> “name”: “Krishna”<br/>}</span></pre><h2 id="f749" class="jv jw in bd jx jy jz dn ka kb kc dp kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">3.<strong class="ak">签名</strong></h2><p id="891d" class="pw-post-body-paragraph kr ks in kt b ku kv kw kx ky kz la lb ke lc ld le ki lf lg lh km li lj lk ll ig bi translated">签名是由服务器生成的密钥。</p><p id="9dbf" class="pw-post-body-paragraph kr ks in kt b ku ln kw kx ky lo la lb ke lp ld le ki lq lg lh km lr lj lk ll ig bi translated">这三个部分组合起来就形成了一个JW令牌，看起来有点像这样:</p><pre class="ls lt lu lv gt lw lx ly lz aw ma bi"><span id="356c" class="jv jw in lx b gy mb mc l md me">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjkyMDAyMSIsIm5hbWUiOiJLcmlzaG5hIn0.tvORZ0xRXmRhVB_sYnckoEN8HYe-q4YUlZJ-ZNaWBiM</span></pre></div><div class="ab cl mf mg hr mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="ig ih ii ij ik"><p id="f166" class="pw-post-body-paragraph kr ks in kt b ku ln kw kx ky lo la lb ke lp ld le ki lq lg lh km lr lj lk ll ig bi translated">首先，要完成本教程，我们需要以下内容:</p><ol class=""><li id="7496" class="mm mn in kt b ku ln ky lo ke mo ki mp km mq ll mr ms mt mu bi translated"><strong class="kt io"> Postman: </strong>用作API客户端来创建或测试API。</li><li id="e56f" class="mm mn in kt b ku mv ky mw ke mx ki my km mz ll mr ms mt mu bi translated"><strong class="kt io"> npm </strong>:您的系统中必须安装节点程序包管理器(npm)。</li><li id="8328" class="mm mn in kt b ku mv ky mw ke mx ki my km mz ll mr ms mt mu bi translated"><strong class="kt io"> Node.js: </strong> Node.js是用来构建可伸缩应用的平台。</li></ol><p id="27a8" class="pw-post-body-paragraph kr ks in kt b ku ln kw kx ky lo la lb ke lp ld le ki lq lg lh km lr lj lk ll ig bi translated">现在，让我们创建一个Node.js项目。</p><p id="06a7" class="pw-post-body-paragraph kr ks in kt b ku ln kw kx ky lo la lb ke lp ld le ki lq lg lh km lr lj lk ll ig bi translated">创建Node.js项目的第一步是生成一个<strong class="kt io"> package.json </strong>文件。使用以下命令:</p><pre class="ls lt lu lv gt lw lx ly lz aw ma bi"><span id="6e2b" class="jv jw in lx b gy mb mc l md me">npm init</span></pre><p id="45c9" class="pw-post-body-paragraph kr ks in kt b ku ln kw kx ky lo la lb ke lp ld le ki lq lg lh km lr lj lk ll ig bi translated">现在您需要安装所需的依赖项:</p><pre class="ls lt lu lv gt lw lx ly lz aw ma bi"><span id="4adb" class="jv jw in lx b gy mb mc l md me">npm install express<br/>npm install jsonwebtoken<br/>npm install nodemon </span></pre><p id="d9d7" class="pw-post-body-paragraph kr ks in kt b ku ln kw kx ky lo la lb ke lp ld le ki lq lg lh km lr lj lk ll ig bi translated">创建一个<strong class="kt io"> index.js </strong>文件，它是项目的主文件。检查您的项目结构是否如下图所示:</p><figure class="ls lt lu lv gt jo gh gi paragraph-image"><div class="gh gi na"><img src="../Images/a7596eb4c7ea69cbd887ac473cf9751a.png" data-original-src="https://miro.medium.com/v2/resize:fit:458/format:webp/1*PTwUex_lEFFVSAgocHVw9A.png"/></div></figure><p id="a318" class="pw-post-body-paragraph kr ks in kt b ku ln kw kx ky lo la lb ke lp ld le ki lq lg lh km lr lj lk ll ig bi translated">现在，打开<strong class="kt io"> index.js </strong>文件，使用下面的代码导入所有的包或依赖项:</p><pre class="ls lt lu lv gt lw lx ly lz aw ma bi"><span id="db41" class="jv jw in lx b gy mb mc l md me">const express = require('express');</span><span id="e660" class="jv jw in lx b gy nb mc l md me">const app = express();</span><span id="0ad7" class="jv jw in lx b gy nb mc l md me">const jwt = require('jsonwebtoken');</span></pre><p id="af66" class="pw-post-body-paragraph kr ks in kt b ku ln kw kx ky lo la lb ke lp ld le ki lq lg lh km lr lj lk ll ig bi translated">让我们测试这个项目。创建一个简单的GET API，检查是否一切都按预期运行。使用下面的代码:</p><pre class="ls lt lu lv gt lw lx ly lz aw ma bi"><span id="c14c" class="jv jw in lx b gy mb mc l md me">app.get('/api/testing', (req,res) =&gt; {</span><span id="67d9" class="jv jw in lx b gy nb mc l md me">res.send('Hello Developer!')</span><span id="b2e7" class="jv jw in lx b gy nb mc l md me">})</span><span id="346f" class="jv jw in lx b gy nb mc l md me">app.listen(9999,() =&gt; console.log('Server is Up and Running'));</span></pre><p id="b5b0" class="pw-post-body-paragraph kr ks in kt b ku ln kw kx ky lo la lb ke lp ld le ki lq lg lh km lr lj lk ll ig bi translated">现在，要测试这个API，您需要使用以下命令运行项目:</p><pre class="ls lt lu lv gt lw lx ly lz aw ma bi"><span id="acba" class="jv jw in lx b gy mb mc l md me">nodemon</span></pre><p id="5f12" class="pw-post-body-paragraph kr ks in kt b ku ln kw kx ky lo la lb ke lp ld le ki lq lg lh km lr lj lk ll ig bi translated">打开Postman并添加以下URL:</p><p id="8d86" class="pw-post-body-paragraph kr ks in kt b ku ln kw kx ky lo la lb ke lp ld le ki lq lg lh km lr lj lk ll ig bi translated"><a class="ae lm" href="http://localhost:9999/api/testing" rel="noopener ugc nofollow" target="_blank">http://localhost:9999/API/测试</a></p><blockquote class="nc nd ne"><p id="7f40" class="kr ks nf kt b ku ln kw kx ky lo la lb ng lp ld le nh lq lg lh ni lr lj lk ll ig bi translated">注意:验证你是否向邮递员发出了GET请求。</p></blockquote><p id="945e" class="pw-post-body-paragraph kr ks in kt b ku ln kw kx ky lo la lb ke lp ld le ki lq lg lh km lr lj lk ll ig bi translated">你的成功回应应该是这样的:</p><p id="efa7" class="pw-post-body-paragraph kr ks in kt b ku ln kw kx ky lo la lb ke lp ld le ki lq lg lh km lr lj lk ll ig bi translated"><em class="nf">开发者您好！</em></p></div><div class="ab cl mf mg hr mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="ig ih ii ij ik"><p id="492e" class="pw-post-body-paragraph kr ks in kt b ku ln kw kx ky lo la lb ke lp ld le ki lq lg lh km lr lj lk ll ig bi translated">现在，让我们为注册创建一个API。</p><ol class=""><li id="dddd" class="mm mn in kt b ku ln ky lo ke mo ki mp km mq ll mr ms mt mu bi translated">注册API从客户端获取用户名和密码凭证。</li><li id="be7f" class="mm mn in kt b ku mv ky mw ke mx ki my km mz ll mr ms mt mu bi translated">此外，它还为该数据或有效载荷生成一个JW令牌。这里，我们将为这个特定的用户id创建一个令牌。然后，这个令牌被发送回客户端。</li></ol><h2 id="3736" class="jv jw in bd jx jy jz dn ka kb kc dp kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated"><em class="nj">注册API </em></h2><pre class="ls lt lu lv gt lw lx ly lz aw ma bi"><span id="dae0" class="jv jw in lx b gy mb mc l md me">app.post('/api/signup' , (req,res) =&gt; {</span><span id="705f" class="jv jw in lx b gy nb mc l md me">const id  = req.body.id;</span><span id="0e98" class="jv jw in lx b gy nb mc l md me">const username = req.body.username;</span><span id="3101" class="jv jw in lx b gy nb mc l md me">const password = req.body.password;<br/></span><span id="4f44" class="jv jw in lx b gy nb mc l md me">jwt.sign(id , 'secret_key' , (err,token) =&gt; {</span><span id="c2db" class="jv jw in lx b gy nb mc l md me">if(err){</span><span id="06c0" class="jv jw in lx b gy nb mc l md me">res.status(400).send({msg : 'Error'})</span><span id="5322" class="jv jw in lx b gy nb mc l md me">}</span><span id="08da" class="jv jw in lx b gy nb mc l md me">else{</span><span id="6ebf" class="jv jw in lx b gy nb mc l md me">res.send({msg:'success' , token: token})</span><span id="d3b7" class="jv jw in lx b gy nb mc l md me">}</span><span id="2d62" class="jv jw in lx b gy nb mc l md me">})</span><span id="01b4" class="jv jw in lx b gy nb mc l md me">})</span></pre><blockquote class="nc nd ne"><p id="3a6c" class="kr ks nf kt b ku ln kw kx ky lo la lb ng lp ld le nh lq lg lh ni lr lj lk ll ig bi translated"><strong class="kt io">注意:</strong>在这里，我们不打算将数据保存到数据库中，因为我们希望更专注于理解JWT概念。</p></blockquote><p id="ea34" class="pw-post-body-paragraph kr ks in kt b ku ln kw kx ky lo la lb ke lp ld le ki lq lg lh km lr lj lk ll ig bi translated">一旦运行了这段代码，Postman的响应将如下所示:</p><p id="8253" class="pw-post-body-paragraph kr ks in kt b ku ln kw kx ky lo la lb ke lp ld le ki lq lg lh km lr lj lk ll ig bi translated"><strong class="kt io">响应</strong></p><pre class="ls lt lu lv gt lw lx ly lz aw ma bi"><span id="396d" class="jv jw in lx b gy mb mc l md me">{</span><span id="7768" class="jv jw in lx b gy nb mc l md me">"msg": "success",</span><span id="75ac" class="jv jw in lx b gy nb mc l md me">"token":"eyJhbGciOiJIUzI1NiJ9.MQ.gaKRuIIRNvXiTlyNPE1Kp3SpAQfhrI3r9MrSB1YdMz8"</span><span id="28b3" class="jv jw in lx b gy nb mc l md me">}</span></pre><p id="c660" class="pw-post-body-paragraph kr ks in kt b ku ln kw kx ky lo la lb ke lp ld le ki lq lg lh km lr lj lk ll ig bi translated">响应返回一个带有JW令牌的成功消息，该令牌经过加密，还带有报头、数据(id)和签名。现在，这个令牌将帮助用户发出对受保护路由的每个请求。</p><p id="5b7a" class="pw-post-body-paragraph kr ks in kt b ku ln kw kx ky lo la lb ke lp ld le ki lq lg lh km lr lj lk ll ig bi translated">现在，让我们继续登录API。</p><p id="210d" class="pw-post-body-paragraph kr ks in kt b ku ln kw kx ky lo la lb ke lp ld le ki lq lg lh km lr lj lk ll ig bi translated">在我们创建登录API之前，我们需要创建一个<strong class="kt io">中间件</strong>函数来验证从客户端发送到服务器端的令牌。</p><blockquote class="nc nd ne"><p id="c277" class="kr ks nf kt b ku ln kw kx ky lo la lb ng lp ld le nh lq lg lh ni lr lj lk ll ig bi translated"><strong class="kt io">注意:</strong>中间件函数是可以访问请求对象、响应对象以及应用程序的请求-响应周期中的下一个函数的函数。</p></blockquote><pre class="ls lt lu lv gt lw lx ly lz aw ma bi"><span id="f9d0" class="jv jw in lx b gy mb mc l md me">function verifyToken(req, res, next) {</span><span id="ff6d" class="jv jw in lx b gy nb mc l md me">const authHeader = req.headers["authorization"];</span><span id="033d" class="jv jw in lx b gy nb mc l md me">const token = authHeader &amp;&amp; authHeader.split(" ")[1];</span><span id="db38" class="jv jw in lx b gy nb mc l md me">if (token == null) return res.sendStatus(403);</span><span id="27f4" class="jv jw in lx b gy nb mc l md me">jwt.verify(token, "secret_key", (err, user) =&gt; {</span><span id="0dd3" class="jv jw in lx b gy nb mc l md me">if (err) return res.sendStatus(404);</span><span id="78af" class="jv jw in lx b gy nb mc l md me">req.user = user;</span><span id="d226" class="jv jw in lx b gy nb mc l md me">next();</span><span id="0ddd" class="jv jw in lx b gy nb mc l md me">});</span><span id="b07b" class="jv jw in lx b gy nb mc l md me">}</span></pre><p id="c024" class="pw-post-body-paragraph kr ks in kt b ku ln kw kx ky lo la lb ke lp ld le ki lq lg lh km lr lj lk ll ig bi translated">这个中间件功能将帮助我们验证在每个受保护的路由请求上从客户端传递到服务器端的令牌。我们可以在我们的API中使用这个中间件，只需将它作为一个参数添加到API端点和回调函数之间。</p><h2 id="e200" class="jv jw in bd jx jy jz dn ka kb kc dp kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">登录API</h2><pre class="ls lt lu lv gt lw lx ly lz aw ma bi"><span id="bb1e" class="jv jw in lx b gy mb mc l md me">app.post('/api/login' , verifyToken , (req,res) =&gt; {</span><span id="8a49" class="jv jw in lx b gy nb mc l md me">res.send('You are Authorized!')</span><span id="54e5" class="jv jw in lx b gy nb mc l md me">})</span></pre><p id="9d37" class="pw-post-body-paragraph kr ks in kt b ku ln kw kx ky lo la lb ke lp ld le ki lq lg lh km lr lj lk ll ig bi translated">发送响应的技巧如下。如果你向邮递员请求这个API，它肯定会给出一个错误——<em class="nf">403未授权</em>。这就是我们在API中使用中间件的原因。现在，要使用这个受保护的路由，您必须在Postman中设置头。</p><blockquote class="nc nd ne"><p id="14ac" class="kr ks nf kt b ku ln kw kx ky lo la lb ng lp ld le nh lq lg lh ni lr lj lk ll ig bi translated"><strong class="kt io">注意:</strong>要设置标题，请转到标题选项，添加一个值为“无记名&lt;令牌&gt;的密钥“授权”。查看下图。</p></blockquote><figure class="ls lt lu lv gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nk"><img src="../Images/9fa5a936b2e04d06301f0884dbc2d41d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Trw_kmMQzPYNCy96FT_OkQ.png"/></div></div></figure><p id="a203" class="pw-post-body-paragraph kr ks in kt b ku ln kw kx ky lo la lb ke lp ld le ki lq lg lh km lr lj lk ll ig bi translated">单击左边的框，检查并发送登录请求。它应该用<em class="nf">回应“你被授权了。”</em></p><h2 id="01ff" class="jv jw in bd jx jy jz dn ka kb kc dp kd ke kf kg kh ki kj kk kl km kn ko kp kq bi translated">注销API</h2><p id="71a1" class="pw-post-body-paragraph kr ks in kt b ku kv kw kx ky kz la lb ke lc ld le ki lf lg lh km li lj lk ll ig bi translated">现在，我们必须创建注销API。</p><p id="4e6f" class="pw-post-body-paragraph kr ks in kt b ku ln kw kx ky lo la lb ke lp ld le ki lq lg lh km lr lj lk ll ig bi translated">为了创建注销API，我们必须首先检查请求是否有效，然后对请求做出响应。这里，重要的一步是注销用户，在后台，我们必须从标题中删除JWT令牌。但是不幸的是，我们没有任何这样的选项来删除头中的JWT令牌。因此，我们将用一个将在1秒后过期的空字符串替换JWT令牌。其代码如下所示:</p><pre class="ls lt lu lv gt lw lx ly lz aw ma bi"><span id="3bb9" class="jv jw in lx b gy mb mc l md me">app.put("/api/logout", authToken, function (req, res) {</span><span id="b8f6" class="jv jw in lx b gy nb mc l md me">const authHeader = req.headers["authorization"];</span><span id="887a" class="jv jw in lx b gy nb mc l md me">jwt.sign(authHeader, "", { expiresIn: 1 } , (logout, err) =&gt; {</span><span id="a4ea" class="jv jw in lx b gy nb mc l md me">if (logout) {</span><span id="8482" class="jv jw in lx b gy nb mc l md me">res.send({msg : 'You have been Logged Out' });</span><span id="329b" class="jv jw in lx b gy nb mc l md me">} else {</span><span id="fc93" class="jv jw in lx b gy nb mc l md me">res.send({msg:'Error'});</span><span id="c241" class="jv jw in lx b gy nb mc l md me">}</span><span id="70e2" class="jv jw in lx b gy nb mc l md me">});</span><span id="6165" class="jv jw in lx b gy nb mc l md me">});</span></pre><p id="2402" class="pw-post-body-paragraph kr ks in kt b ku ln kw kx ky lo la lb ke lp ld le ki lq lg lh km lr lj lk ll ig bi translated">只有当您通过添加带有报头的JW令牌来发送请求时，此API才会起作用，其响应如下:</p><pre class="ls lt lu lv gt lw lx ly lz aw ma bi"><span id="064d" class="jv jw in lx b gy mb mc l md me">{</span><span id="5860" class="jv jw in lx b gy nb mc l md me">"msg": "You have been Logged Out"</span><span id="86a5" class="jv jw in lx b gy nb mc l md me">}</span></pre><p id="4910" class="pw-post-body-paragraph kr ks in kt b ku ln kw kx ky lo la lb ke lp ld le ki lq lg lh km lr lj lk ll ig bi translated">在这里，我们已经成功地建立了一个授权系统，我希望你们都知道JWT是如何运作的。谢谢你，祝你愉快！</p></div></div>    
</body>
</html>