<html>
<head>
<title>Understanding Node.js Performance</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">了解Node.js性能</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/understanding-nodejs-performance-dc9f2673455e?source=collection_archive---------3-----------------------#2021-02-14">https://javascript.plainenglish.io/understanding-nodejs-performance-dc9f2673455e?source=collection_archive---------3-----------------------#2021-02-14</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/0bb1915c248b5179dcbee53a87d5a55f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NqEsteabAso1K1UlToaGDg.jpeg"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">GSLV-F08 liftoff © <a class="ae jz" href="https://www.isro.gov.in/" rel="noopener ugc nofollow" target="_blank">https://www.isro.gov.in/</a></figcaption></figure><p id="fa71" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">许多开发人员和架构师在听说了令人难以置信的速度和它的异步IO之后，都投身于NodeJS。他们中的大多数人对NodeJS的工作原理没有清晰的理解。理解事件循环是如何工作的有助于产生更好的NodeJS解决方案。</p><p id="89b5" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我不打算深究事件循环。一个简单的搜索应该提供丰富的资源。对于我们的讨论，让我们假设事件循环负责处理NodeJS中的异步I/O。事件循环使单线程NodeJS运行时处理并发。</p><p id="df2e" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">对于本文的其余部分，我们将采用一个简单的HTTP服务，分析回调处理时间和阻塞代码对NodeJS运行时的响应处理能力的影响。</p><h2 id="4d22" class="ky kz in bd la lb lc dn ld le lf dp lg kl lh li lj kp lk ll lm kt ln lo lp lq bi translated"><strong class="ak">闭锁代码</strong></h2><p id="e564" class="pw-post-body-paragraph ka kb in kc b kd lr kf kg kh ls kj kk kl lt kn ko kp lu kr ks kt lv kv kw kx ig bi translated">根据定义，任何阻止事件循环选取其队列中的下一项的代码都是阻塞代码。阻塞代码的一个例子是大型for或while语句。</p><h2 id="6f11" class="ky kz in bd la lb lc dn ld le lf dp lg kl lh li lj kp lk ll lm kt ln lo lp lq bi translated"><strong class="ak">一个简单的HTTP服务器</strong></h2><p id="6d3c" class="pw-post-body-paragraph ka kb in kc b kd lr kf kg kh ls kj kk kl lt kn ko kp lu kr ks kt lv kv kw kx ig bi translated">神奇的三线HTTP服务器。是不是很美？</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="5f7f" class="ky kz in mb b gy mf mg l mh mi">const http = require(‘http’)</span><span id="4540" class="ky kz in mb b gy mj mg l mh mi">http.createServer((req, res) =&gt; {<br/>    res.writeHead(200)<br/>    res.end(‘Hello, World!’)<br/>}).listen(8888)</span></pre><p id="f5d6" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我们将使用自动扫描。让我们在全球范围内安装</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="fafa" class="ky kz in mb b gy mf mg l mh mi">npm i -g autocannon</span></pre><p id="0e60" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">测试服务器的基本性能，让我们使用100个连接和默认的10秒持续时间来生成流量。</p><p id="097b" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">在我的机器上，这是得到的结果。</p><figure class="lw lx ly lz gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mk"><img src="../Images/88f14fcb43bdb27c04843b2ec613fcfc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*x_JNgjyX6yv2s7Qj3qNPuw.png"/></div></div></figure><h2 id="0a11" class="ky kz in bd la lb lc dn ld le lf dp lg kl lh li lj kp lk ll lm kt ln lo lp lq bi translated"><strong class="ak">带异步回调的HTTP服务器</strong></h2><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="033f" class="ky kz in mb b gy mf mg l mh mi">const http = require('http')<br/>const getResponse = async () =&gt; {<br/>    return new Promise((resolve, reject) =&gt; {<br/>        setTimeout(() =&gt; {<br/>            return resolve('Hello, world!')<br/>        }, 10) // Simulate a 10 ms delay for the data fetch<br/>    })<br/>}</span><span id="9e65" class="ky kz in mb b gy mj mg l mh mi">// Our server is using the get response to fetch the 'Hello, World!' string. This is to simulate a DB request</span><span id="f597" class="ky kz in mb b gy mj mg l mh mi">http.createServer(async (req, res) =&gt; {<br/>    const result = await getResponse()<br/>    res.writeHead(200)<br/>    res.end(result)<br/>}).listen(8888)</span></pre><p id="4c77" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">让我们模拟一个可能的用例，比如从数据库获取数据。对于这个测试，让我们将响应持续时间保持在10毫秒。这个迭代的结果是</p><figure class="lw lx ly lz gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi ml"><img src="../Images/8a1045d96dc5d3b6a72d1e4532c3c38f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oolYRe-wihdVa8auCHw1tA.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">At 10 ms per request</figcaption></figure><p id="5410" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">让我们重复测试50、100、500和1000毫秒的延迟。</p><p id="ef2a" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这是结果。</p><p id="b65b" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">50毫秒时</strong></p><figure class="lw lx ly lz gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mm"><img src="../Images/bc3626ec785651e75dc16141500aa602.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*i0dPVw-xA33kaRBF-WFRGg.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">At 50 ms per request</figcaption></figure><p id="0b2c" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">100毫秒时</strong></p><figure class="lw lx ly lz gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mn"><img src="../Images/535c67380a7204d8c7f55c6f34ec4391.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nFPKzHZ8Mn0SEBzZMeb7dQ.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">At 100 ms per request</figcaption></figure><p id="09cd" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">在500毫秒时</strong></p><figure class="lw lx ly lz gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mo"><img src="../Images/7925be064443a78f365fbf14f93b1c7f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Sv9qLspYfuaBkVoJ3K4rcw.png"/></div></div></figure><p id="6b3b" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">在1000毫秒时</strong></p><figure class="lw lx ly lz gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mp"><img src="../Images/77ba1499378d499f9b1489a0e77bd99e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SBvvNSt-fEiOa4EQJ_1VXw.png"/></div></div></figure><h2 id="7f6c" class="ky kz in bd la lb lc dn ld le lf dp lg kl lh li lj kp lk ll lm kt ln lo lp lq bi translated"><strong class="ak">阻塞事件循环——大罪</strong></h2><p id="32a6" class="pw-post-body-paragraph ka kb in kc b kd lr kf kg kh ls kj kk kl lt kn ko kp lu kr ks kt lv kv kw kx ig bi translated">让我们调整一下第一个例子。我们将引入睡眠功能。据我所知，没有原生睡眠。我们的睡眠功能阻塞了事件循环，非常适合这个演示。</p><pre class="lw lx ly lz gt ma mb mc md aw me bi"><span id="073d" class="ky kz in mb b gy mf mg l mh mi">const http = require('http')</span><span id="554e" class="ky kz in mb b gy mj mg l mh mi">const sleep = (delayInMs) =&gt; {<br/>  const start = Date.now()<br/>  while (true) {<br/>    if (Date.now() - start &gt;= delayInMs) {<br/>      break;<br/>    }<br/>  }<br/>}</span><span id="ca48" class="ky kz in mb b gy mj mg l mh mi">http.createServer(async (req, res) =&gt; {<br/>  // Sleep for 500 ms<br/>  sleep(500)<br/>  res.writeHead(200)<br/>  res.end('Hello, world!')<br/>}).listen(8888)</span></pre><p id="8ae1" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">结果就在这里，而且是惨淡！只需查看每秒请求数和错误数。</p><figure class="lw lx ly lz gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mq"><img src="../Images/3214aeed329417171f38eab649723b52.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TUvRx7yaR3_dXDT4bhNsgw.png"/></div></div></figure><h2 id="aced" class="ky kz in bd la lb lc dn ld le lf dp lg kl lh li lj kp lk ll lm kt ln lo lp lq bi translated"><strong class="ak">观察结果</strong></h2><figure class="lw lx ly lz gt jo gh gi paragraph-image"><div class="gh gi mr"><img src="../Images/1f997a8d757dd4bcebd09668238c197a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1208/format:webp/1*odlmGpI0pszJ5gC1yvejqQ.png"/></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Latency with request callback time — Y-Axis Latency in ms</figcaption></figure><figure class="lw lx ly lz gt jo gh gi paragraph-image"><div class="gh gi mr"><img src="../Images/9368ae9ea79e40f86fabeb03928b3326.png" data-original-src="https://miro.medium.com/v2/resize:fit:1208/format:webp/1*RLbzhaC7MHsACOnDG041yg.png"/></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Request per second with request callback time — Y-Axis RPS</figcaption></figure><p id="e142" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">图表非常清楚地显示，更短的回调响应时间可以显著提高性能。</p><h1 id="66ff" class="ms kz in bd la mt mu mv ld mw mx my lg mz na nb lj nc nd ne lm nf ng nh lp ni bi translated"><strong class="ak">课程</strong></h1><h2 id="754e" class="ky kz in bd la lb lc dn ld le lf dp lg kl lh li lj kp lk ll lm kt ln lo lp lq bi translated">缩短您的请求处理时间。</h2><p id="a557" class="pw-post-body-paragraph ka kb in kc b kd lr kf kg kh ls kj kk kl lt kn ko kp lu kr ks kt lv kv kw kx ig bi translated">较短的处理时间可以显著提高性能。理想情况下，尽量将其保持在10 ms以下。如果这不可能，请尽量将其保持在最低水平。请求处理时间和所需的服务器数量直接相关。更短的请求处理时间具有显著的成本节约优势。</p><h2 id="7d8c" class="ky kz in bd la lb lc dn ld le lf dp lg kl lh li lj kp lk ll lm kt ln lo lp lq bi translated"><strong class="ak">千万不要阻塞事件循环。</strong></h2><p id="1fc1" class="pw-post-body-paragraph ka kb in kc b kd lr kf kg kh ls kj kk kl lt kn ko kp lu kr ks kt lv kv kw kx ig bi translated">正如我们所见，阻塞事件循环甚至500毫秒都是灾难性的。后台你所有的阻塞呼叫队列和工人。</p><h2 id="c04d" class="ky kz in bd la lb lc dn ld le lf dp lg kl lh li lj kp lk ll lm kt ln lo lp lq bi translated"><strong class="ak">工具</strong></h2><p id="cb94" class="pw-post-body-paragraph ka kb in kc b kd lr kf kg kh ls kj kk kl lt kn ko kp lu kr ks kt lv kv kw kx ig bi translated">使用以下工具来理解您的NodeJS代码并对其进行调优</p><ol class=""><li id="e39b" class="nj nk in kc b kd ke kh ki kl nl kp nm kt nn kx no np nq nr bi translated">https://github.com/mcollina/autocannon(作者马特奥·科里纳)</li><li id="9cd6" class="nj nk in kc b kd ns kh nt kl nu kp nv kt nw kx no np nq nr bi translated">https://github.com/davidmarkclements/0x的0x—<a class="ae jz" href="https://github.com/davidmarkclements/0x" rel="noopener ugc nofollow" target="_blank"/></li><li id="d6b7" class="nj nk in kc b kd ns kh nt kl nu kp nv kt nw kx no np nq nr bi translated">诊所—【https://clinicjs.org/doctor/ T4】(来自近表单)</li></ol><h2 id="ca07" class="ky kz in bd la lb lc dn ld le lf dp lg kl lh li lj kp lk ll lm kt ln lo lp lq bi translated"><strong class="ak">附加阅读</strong></h2><p id="1371" class="pw-post-body-paragraph ka kb in kc b kd lr kf kg kh ls kj kk kl lt kn ko kp lu kr ks kt lv kv kw kx ig bi translated">一些关于节点性能的有用文章和视频</p><ol class=""><li id="3faa" class="nj nk in kc b kd ke kh ki kl nl kp nm kt nn kx no np nq nr bi translated">保持Node.js快速运行:制作高性能Node.js服务器的工具、技术和技巧—<a class="ae jz" href="https://www.smashingmagazine.com/2018/06/nodejs-tools-techniques-performance-servers/" rel="noopener ugc nofollow" target="_blank">https://www . smashingmagazine . com/2018/06/nodejs-Tools-Techniques-Performance-Servers/</a></li><li id="64d0" class="nj nk in kc b kd ns kh nt kl nu kp nv kt nw kx no np nq nr bi translated">让你的HTTP服务器达到可笑的速度[I]——<a class="ae jz" href="https://www.youtube.com/watch?v=gltzZjKYK1I" rel="noopener ugc nofollow" target="_blank">https://www.youtube.com/watch?v=gltzZjKYK1I</a></li></ol><p id="3ca5" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">https://www.isro.gov.in/ GSLV-F08升空<a class="ae jz" href="https://www.isro.gov.in/" rel="noopener ugc nofollow" target="_blank"/></p></div></div>    
</body>
</html>