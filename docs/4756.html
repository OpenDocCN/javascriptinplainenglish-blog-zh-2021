<html>
<head>
<title>Task Scheduler with Firebase to Trigger Everyday Tasks</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">带有Firebase的任务调度程序，可触发日常任务</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/task-scheduler-with-firebase-to-trigger-everyday-tasks-7a2d53c26521?source=collection_archive---------14-----------------------#2021-09-22">https://javascript.plainenglish.io/task-scheduler-with-firebase-to-trigger-everyday-tasks-7a2d53c26521?source=collection_archive---------14-----------------------#2021-09-22</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/f89e1073b930bafbf9ddce36be7918b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LRFR_50Y5hQ6T0MSkNHu6w.jpeg"/></div></div></figure><p id="387b" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">要详细说明什么是任务调度器，可以把它看作一个在特定时间运行并执行特定任务的核心作业。Google实际上有一个云调度器，但这需要额外的知识，所以在这篇文章中，我将写一下如何通过使用云功能和Firestore来实现它。</p><p id="6f66" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">为了给你一些你想要使用任务调度器的例子，假设你有一个图片上传功能，但是事情是这样的，为了在工作完成后节省空间，你可能想要删除文件。对吗？而不是在工作完成后，也许你想在工作完成后将它保存在你的系统中一天。你可以在工作完成后立即执行一个任务来删除图像，这将会非常完美，但是在没有交互的情况下过一段时间或一段时间后再执行是不可能的，除非你有某种corn-job。</p><p id="b942" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">因此，解决这个复杂问题的秘诀是首先考虑需要完成的任务列表，一旦完成，我们可以随时将状态更改为“已完成”。</p><p id="05e2" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">那么我们有:<br/> - <strong class="jx io">类型</strong>的任务。<br/> -这是什么样的<strong class="jx io">任务</strong>。<br/> -其当前<strong class="jx io">状态</strong>是什么。<br/> -何时执行<strong class="jx io"/><br/>-执行时需要传递给什么<strong class="jx io">选项</strong>。</p><p id="62d0" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在收集上述数据之前，假设我们有一个每分钟运行一次的云函数。让我们来看看编写一个函数的代码，这个函数将在每一分钟后运行。</p><pre class="kt ku kv kw gt kx ky kz la aw lb bi"><span id="dc5b" class="lc ld in ky b gy le lf l lg lh">// The stars indicate an expression, you can look this link up <a class="ae li" href="https://crontab.guru/#*_*_*_*_*" rel="noopener ugc nofollow" target="_blank">Crontab.guru - The cron schedule expression editor</a></span><span id="b73b" class="lc ld in ky b gy lj lf l lg lh">exports.taskRunner = functions.pubsub.schedule('* * * * *').onRun(Firestore.taskRunner)</span><span id="77a2" class="lc ld in ky b gy lj lf l lg lh">const taskRunner = () =&gt; {<br/>}</span><span id="060c" class="lc ld in ky b gy lj lf l lg lh">const Firestore = {taskRunner}</span></pre><p id="57c6" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">上面的代码声明了一个每分钟运行一次的函数，你可以通过上面给出的链接更改时间来创建另一个表达式，所以如果我每次都运行它，你可以让它每5分钟或每天运行一次，这完全取决于你。</p><p id="66fb" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">下一步是编写一个函数来帮助我们添加任务。我们来看下面这个函数写任务的代码。</p><pre class="kt ku kv kw gt kx ky kz la aw lb bi"><span id="1ae8" class="lc ld in ky b gy le lf l lg lh">exports.addATask = functions.https.onRequest(Firestore.addATask);</span><span id="0ea5" class="lc ld in ky b gy lj lf l lg lh">const addATask = async (req, res) =&gt; {</span><span id="8890" class="lc ld in ky b gy lj lf l lg lh">const { type, status, task, data, performAt } = JSON.parse(req.body);</span><span id="98a9" class="lc ld in ky b gy lj lf l lg lh">const newData = JSON.parse(data);</span><span id="fc1d" class="lc ld in ky b gy lj lf l lg lh">// The 0 there is the key, which sets the date to the epoch<br/>const de = new Date(0); <br/>de.setUTCSeconds(performAt);</span><span id="4253" class="lc ld in ky b gy lj lf l lg lh">// creating a tasks colletion with a document in it, with following feilds : type, performAt, status, task, options.</span><span id="c424" class="lc ld in ky b gy lj lf l lg lh">const d = await admin<br/>    .firestore()<br/>    .collection('tasks')<br/>    .add({<br/>      type,<br/>      performAt: de,<br/>      status,<br/>      task,<br/>      options: {<br/>        ...newData,<br/>      },<br/>    });<br/>  res.send('success');<br/>};</span><span id="f26a" class="lc ld in ky b gy lj lf l lg lh">const Firestore = {addATask}</span></pre><p id="489a" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">上面的代码非常简单。我们声明了一个函数，它是一个HTTPS请求函数，这意味着它也可以从HTTPS请求中执行，在该函数中，我们以纪元格式获得<strong class="jx io"> performAt </strong>，我们将其转换为时间戳，然后用其余数据创建一个Firestore条目。</p><p id="0e25" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">现在是时候编写一个<strong class="jx io"> taskRunner </strong>了，同样，它只是负责运行一个任务或一系列未完成的任务。所以，</p><pre class="kt ku kv kw gt kx ky kz la aw lb bi"><span id="48a7" class="lc ld in ky b gy le lf l lg lh">const taskRunner = async (context) =&gt; {<br/>  // fetch the pending task to run.<br/>  const now = admin.firestore.Timestamp.now();</span><span id="4511" class="lc ld in ky b gy lj lf l lg lh">// Fetch all the task that are pending and is due, meaning the performAt time is greater than equal to the current time<br/> const query = admin<br/>    .firestore()<br/>    .collection('tasks')<br/>    .where('performAt', '&lt;=', now)<br/>    .where('status', '==', 'pending');<br/> const tasks = await query.get();<br/>  const jobs = [];<br/>  tasks.forEach((snapshot) =&gt; {<br/>    const data = snapshot.data();<br/>    const job = Tasks[data.task](data.options)<br/>      .then((e) =&gt; snapshot.ref.update({ status: 'complete' }))<br/>      .catch((e) =&gt; snapshot.ref.update({ status: 'failed', reason: e.message }));<br/>    jobs.push(job);<br/>  });</span><span id="f105" class="lc ld in ky b gy lj lf l lg lh">await Promise.all(jobs);<br/>};</span></pre><p id="592a" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在上面的代码中，我们只是获取所有未决的任务，我们得到了一个长度数组，然后我们对所有这些任务进行foreach并一个接一个地执行它们。所以上面代码中的<strong class="jx io">任务</strong>是一个定义了一堆<strong class="jx io">类型</strong>任务函数的对象，我们在其中传递选项。所以可能是这样的。</p><pre class="kt ku kv kw gt kx ky kz la aw lb bi"><span id="6457" class="lc ld in ky b gy le lf l lg lh">const sendEmail = (options) =&gt; {};<br/>const notifyUser = (options) =&gt; {};<br/>const deleteFile = (options) =&gt; {};</span><span id="fdc2" class="lc ld in ky b gy lj lf l lg lh">const Tasks = {<br/>sendEmail, <br/>notifyUser, <br/>deleteFile<br/>}</span></pre><p id="7365" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我们不需要导出任务的功能，因为它只是服务器内部的。所有的任务都被假定为承诺，在那里解决或拒绝，我们决定它是否被完成，我们更新当前运行的任务的状态为<strong class="jx io">完成</strong>或<strong class="jx io">失败</strong>，如果失败，什么原因。上面的代码非常简单明了。</p><p id="8480" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">本文的目的是让您对正在发生的事情有一个概念和清晰的理解，而不是复制这里的所有代码，这样您就可以在不知道幕后发生了什么的情况下进行复制。</p><p id="ce3f" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">要创建一个任务，您只需触发一个HTTP函数。你可以用Axios或者fetch，我用的是<strong class="jx io">信标。</strong></p><pre class="kt ku kv kw gt kx ky kz la aw lb bi"><span id="64a7" class="lc ld in ky b gy le lf l lg lh">const current = Math.floor(new Date() / 1000);<br/>window.navigator.sendBeacon(<br/>        ADD_TASK,<br/>        JSON.stringify({<br/>            task: ADD_TASK_NAME,<br/>            performAt: current,<br/>            data: JSON.stringify({<br/>                data,<br/>                refs: `/meeting/${webID}/guests/${attendeeId}`,<br/>            }),<br/>            type: "schedule",<br/>            status: "pending",<br/>        })<br/>    );</span></pre><ul class=""><li id="ecc4" class="lk ll in jx b jy jz kc kd kg lm kk ln ko lo ks lp lq lr ls bi translated"><strong class="jx io"> ADD_TASK </strong>是您可以从firebase控制台轻松获得的功能的部署URL。</li><li id="e22f" class="lk ll in jx b jy lt kc lu kg lv kk lw ko lx ks lp lq lr ls bi translated"><strong class="jx io"> ADD_TASK_NAME </strong>是后端<strong class="jx io"> Tasks </strong>对象中定义的任务名称。</li></ul><figure class="kt ku kv kw gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi ly"><img src="../Images/bf444d9c7dde3a6b61dc3ea4e62ec7b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4vjzEhTLgavWY5P-ybSM5w.png"/></div></div><figcaption class="lz ma gj gh gi mb mc bd b be z dk">the successfully executed task might look something like this.</figcaption></figure><figure class="kt ku kv kw gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi md"><img src="../Images/c0abbc16eba4a72fe75c093b78b0723a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q6yzi_YKxccM7HM1l6HySA.png"/></div></div><figcaption class="lz ma gj gh gi mb mc bd b be z dk">The failed task will drop a reason field to easily debug</figcaption></figure><p id="e889" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">您还可以使用云函数日志来了解更多关于错误的信息。</p><p id="39e0" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">就是这样，伙计们，我对反馈特别是纠正持开放态度，所以请随意评论。</p><p id="6aef" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi">— — — — — — — — — — — — — — — — — — — — — — — — — — — -</p><p id="9185" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">找自由职业者？通过fiverr 雇佣我。</p><p id="eb9e" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi">— — — — — — — — — — — — — — — — — — — — — — — — — — — -</p><p id="b764" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><em class="me">更多内容看</em> <a class="ae li" href="http://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="jx io"> <em class="me">说白了. io </em> </strong> </a></p></div></div>    
</body>
</html>