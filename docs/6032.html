<html>
<head>
<title>Speed Up Jest Tests By Using The Correct Environment</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过使用正确的环境加速Jest测试</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/speed-up-jest-tests-by-using-the-correct-environment-24954dcaab82?source=collection_archive---------5-----------------------#2021-12-27">https://javascript.plainenglish.io/speed-up-jest-tests-by-using-the-correct-environment-24954dcaab82?source=collection_archive---------5-----------------------#2021-12-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="ceb1" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">DOM很贵。只在需要的时候使用。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/3c39672367483aff7168e8ef08c548e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*oQSqIqIb0BDsdJrg"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Photo by <a class="ae kv" href="https://unsplash.com/@sleblanc01?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Stephanie LeBlanc</a> on <a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="ed7d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最近在<a class="ae kv" href="https://www.getparallax.com/" rel="noopener ugc nofollow" target="_blank"> Parallax </a>，我们注意到我们的UI测试套件花了越来越长的时间才完成。这是几分钟的事，所以不是什么大问题。至少现在还没有。然而，这是一个影响开发和延长反馈周期的问题。这是我们希望尽快解决的问题。</p><p id="004c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们决定调查一下，看看能否加快速度。</p><h1 id="da60" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">问题</h1><p id="f0c7" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">在撰写本文时，我们的UI应用程序有大约1600个单元测试。我们使用<a class="ae kv" href="https://jestjs.io/" rel="noopener ugc nofollow" target="_blank">Jest</a>T7】TypeScript和<a class="ae kv" href="https://testing-library.com/docs/react-testing-library/intro/" rel="noopener ugc nofollow" target="_blank"> React测试库</a>。我们大约一半的测试是针对需要一个<a class="ae kv" href="https://developer.mozilla.org/en-US/docs/Web/API/Document_Object_Model/Introduction" rel="noopener ugc nofollow" target="_blank"> DOM </a>的<a class="ae kv" href="https://reactjs.org/" rel="noopener ugc nofollow" target="_blank"> React </a>组件。另一半是纯函数或者<a class="ae kv" href="https://www.typescriptlang.org/docs/handbook/classes.html" rel="noopener ugc nofollow" target="_blank">类型脚本类</a>。这些不需要DOM来测试，只需要一个<a class="ae kv" href="https://nodejs.org/en/" rel="noopener ugc nofollow" target="_blank">节点</a>环境。</p><p id="bb81" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Jest使用节点通过CLI运行。Node里不存在<code class="fe mp mq mr ms b">window</code>、<code class="fe mp mq mr ms b">document</code>之类的东西。因此，我们必须向Node提供一个假的DOM。可以想象，需要DOM的测试增加了对某种DOM库的依赖。</p><p id="d573" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Jest测试的Jest文档指出<a class="ae kv" href="https://github.com/jsdom/jsdom" rel="noopener ugc nofollow" target="_blank"> jsdom </a>是这项工作的推荐工具。您可以通过两种方式设置Jest环境；通过Jest配置，或者通过在单独的测试文件中使用一个特殊的doc块。</p><p id="6251" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我应该提到，在我们的配置中，默认的全局环境被设置为<code class="fe mp mq mr ms b">jsdom</code>。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mt"><img src="../Images/1d5ff0603ae279496bf719c5b7282fda.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*nLV9ihUwb4WbqFQa"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Photo by <a class="ae kv" href="https://unsplash.com/@freegraphictoday?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">AbsolutVision</a> on <a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="2c57" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">解决办法</h1><p id="89da" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">对我们如何让事情变得更好有什么猜测吗？我已经暗示过了。我给你一分钟考虑一下。</p></div><div class="ab cl mu mv hu mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="ij ik il im in"><p id="22ff" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">从高层次来看，我们的解决方案是将默认Jest环境设置为<code class="fe mp mq mr ms b">node</code>。然后，在需要DOM的测试中，我们添加了一个<a class="ae kv" href="https://en.wikipedia.org/wiki/Docblock" rel="noopener ugc nofollow" target="_blank"> docblock </a>来告诉Jest使用<code class="fe mp mq mr ms b">jsdom</code>环境而不是<code class="fe mp mq mr ms b">node</code>。</p><p id="fc99" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我想承认，我们并不仅仅是靠自己解决了这个问题。像任何优秀的工程师一样，我们首先在互联网上找到了答案。</p><div class="nc nd gp gr ne nf"><a href="https://itnext.io/how-to-make-your-sluggish-jest-v23-tests-go-faster-1d4f3388bcdd" rel="noopener  ugc nofollow" target="_blank"><div class="ng ab fo"><div class="nh ab ni cl cj nj"><h2 class="bd ir gy z fp nk fr fs nl fu fw ip bi translated">如何让你缓慢的Jest v23测试进行得更快</h2><div class="nm l"><h3 class="bd b gy z fp nk fr fs nl fu fw dk translated">让单元测试再次变得伟大</h3></div><div class="nn l"><p class="bd b dl z fp nk fr fs nl fu fw dk translated">itnext.io</p></div></div><div class="no l"><div class="np l nq nr ns no nt kp nf"/></div></div></a></div><p id="af8d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了在我们的项目中实施这个修复，我们通过三个简单的步骤来完成:</p><h2 id="b93f" class="nu lt iq bd lu nv nw dn ly nx ny dp mc lf nz oa me lj ob oc mg ln od oe mi of bi translated">将<code class="fe mp mq mr ms b">node</code>设置为默认测试环境</h2><p id="f234" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">这对速度产生了直接的积极影响。但也导致我们一半的测试失败。我们预料到了这一点，因为node没有DOM。因此，需要DOM的测试现在都有点麻烦了。</p><h2 id="79e0" class="nu lt iq bd lu nv nw dn ly nx ny dp mc lf nz oa me lj ob oc mg ln od oe mi of bi translated">将jsdom Docblock添加到组件测试文件中</h2><p id="76ce" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">一旦我们转移到<code class="fe mp mq mr ms b">node</code>作为默认测试环境，我们突然有了一个失败测试的集合。我们的目录结构使得找到大多数组件测试变得非常容易。一旦定位了组件测试，就需要在文件的顶部添加一个具有正确环境的doc块。</p><pre class="kg kh ki kj gt og ms oh oi aw oj bi"><span id="bdb9" class="nu lt iq ms b gy ok ol l om on"><em class="nb">/**</em><br/><em class="nb"> * @jest-environment jsdom</em><br/><em class="nb"> */</em></span></pre><p id="aefa" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后，我们重新运行测试，并验证事情再次通过。很简单！</p><h2 id="4493" class="nu lt iq bd lu nv nw dn ly nx ny dp mc lf nz oa me lj ob oc mg ln od oe mi of bi translated">更新组件生成器以包含jsdom Docblock</h2><p id="996f" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">最后一步同样重要:更新我们的生成器，使其包含文档块。这样，就可以用正确的文档块创建新的组件测试。</p><p id="63f5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">多年来，<a class="oo op ep" href="https://medium.com/u/32c8aef7a385?source=post_page-----24954dcaab82--------------------------------" rel="noopener" target="_blank"> Robert S (codeBelt) </a>已经建立了一个健康的<a class="ae kv" href="https://medium.com/@robertsavian/generate-template-files-with-ease-19b320615359" rel="noopener">生成器集合</a>，我们在我们的项目中使用它。这些生成器使得在我们的项目中创建新文件变得非常简单。</p></div><div class="ab cl mu mv hu mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="ij ik il im in"><h1 id="3652" class="ls lt iq bd lu lv oq lx ly lz or mb mc jw os jx me jz ot ka mg kc ou kd mi mj bi translated">结论</h1><p id="28ee" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">这实际上产生了多大的影响？我们的测试现在运行得更快了。这是有意义的，考虑到我们只有在需要的时候才旋转DOM(大约一半的时间)。</p><p id="7124" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在我们做了这个改变之后，我们从每次运行大约120秒下降到大约80秒。这不是一个巨大的变化，但确实有所不同。</p></div><div class="ab cl mu mv hu mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="ij ik il im in"><h2 id="cf94" class="nu lt iq bd lu nv nw dn ly nx ny dp mc lf nz oa me lj ob oc mg ln od oe mi of bi translated">参考</h2><ul class=""><li id="7751" class="ov ow iq ky b kz mk lc ml lf ox lj oy ln oz lr pa pb pc pd bi translated"><a class="ae kv" href="https://www.getparallax.com/" rel="noopener ugc nofollow" target="_blank">https://www.getparallax.com/</a></li><li id="7310" class="ov ow iq ky b kz pe lc pf lf pg lj ph ln pi lr pa pb pc pd bi translated"><a class="ae kv" href="https://jestjs.io/" rel="noopener ugc nofollow" target="_blank">https://jestjs.io/</a></li><li id="e07c" class="ov ow iq ky b kz pe lc pf lf pg lj ph ln pi lr pa pb pc pd bi translated"><a class="ae kv" href="https://www.typescriptlang.org/" rel="noopener ugc nofollow" target="_blank">https://www.typescriptlang.org/</a></li><li id="604f" class="ov ow iq ky b kz pe lc pf lf pg lj ph ln pi lr pa pb pc pd bi translated"><a class="ae kv" href="https://testing-library.com/docs/react-testing-library/intro/" rel="noopener ugc nofollow" target="_blank">https://testing-library . com/docs/react-testing-library/intro/</a></li><li id="cc6b" class="ov ow iq ky b kz pe lc pf lf pg lj ph ln pi lr pa pb pc pd bi translated">【https://reactjs.org/ T2】号</li><li id="f892" class="ov ow iq ky b kz pe lc pf lf pg lj ph ln pi lr pa pb pc pd bi translated"><a class="ae kv" href="https://developer.mozilla.org/en-US/docs/Web/API/Document_Object_Model/Introduction" rel="noopener ugc nofollow" target="_blank">https://developer . Mozilla . org/en-US/docs/Web/API/Document _ Object _ Model/简介</a></li><li id="55df" class="ov ow iq ky b kz pe lc pf lf pg lj ph ln pi lr pa pb pc pd bi translated"><a class="ae kv" href="https://www.typescriptlang.org/docs/handbook/classes.html" rel="noopener ugc nofollow" target="_blank">https://www.typescriptlang.org/docs/handbook/classes.html</a></li><li id="0c0a" class="ov ow iq ky b kz pe lc pf lf pg lj ph ln pi lr pa pb pc pd bi translated"><a class="ae kv" href="https://nodejs.org/en/" rel="noopener ugc nofollow" target="_blank">https://nodejs.org/en/</a></li><li id="99fa" class="ov ow iq ky b kz pe lc pf lf pg lj ph ln pi lr pa pb pc pd bi translated"><a class="ae kv" href="https://jestjs.io/docs/configuration#testenvironment-string" rel="noopener ugc nofollow" target="_blank">https://jestjs.io/docs/configuration#testenvironment-string</a></li><li id="e030" class="ov ow iq ky b kz pe lc pf lf pg lj ph ln pi lr pa pb pc pd bi translated"><a class="ae kv" href="https://github.com/jsdom/jsdom" rel="noopener ugc nofollow" target="_blank">https://github.com/jsdom/jsdom</a></li><li id="3a3f" class="ov ow iq ky b kz pe lc pf lf pg lj ph ln pi lr pa pb pc pd bi translated"><a class="ae kv" href="https://en.wikipedia.org/wiki/Docblock" rel="noopener ugc nofollow" target="_blank">https://en.wikipedia.org/wiki/Docblock</a></li><li id="a075" class="ov ow iq ky b kz pe lc pf lf pg lj ph ln pi lr pa pb pc pd bi translated"><a class="ae kv" href="https://itnext.io/how-to-make-your-sluggish-jest-v23-tests-go-faster-1d4f3388bcdd" rel="noopener ugc nofollow" target="_blank">https://it next . io/how-to-make-your-sleep-jest-v 23-tests-go-faster-1d4f 3388 bcdd</a></li><li id="a526" class="ov ow iq ky b kz pe lc pf lf pg lj ph ln pi lr pa pb pc pd bi translated"><a class="ae kv" href="https://medium.com/@robertsavian/generate-template-files-with-ease-19b320615359" rel="noopener">https://medium . com/@ Roberts avian/generate-template-files-with-ease-19b 320615359</a></li></ul><p id="b9df" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="nb">更多内容看</em> <a class="ae kv" href="http://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <em class="nb">说白了就是</em> </a> <em class="nb">。报名参加我们的</em> <a class="ae kv" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <em class="nb">免费每周简讯</em> </a> <em class="nb">。在我们的</em> <a class="ae kv" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"> <em class="nb">社区不和谐</em> </a> <em class="nb">获得独家获取写作机会和建议。</em></p></div></div>    
</body>
</html>