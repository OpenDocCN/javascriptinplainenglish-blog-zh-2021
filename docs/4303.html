<html>
<head>
<title>Spotify Authentication with React Native</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用React Native进行Spotify认证</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/spotify-authentication-with-reactnative-2b6156573d19?source=collection_archive---------0-----------------------#2021-08-27">https://javascript.plainenglish.io/spotify-authentication-with-reactnative-2b6156573d19?source=collection_archive---------0-----------------------#2021-08-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div class="gh gi jn"><img src="../Images/3a579d19e41323acb34d04e9b63f0775.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/1*flB1EtNM1wCZKRYhxW10uQ.png"/></div></figure><h1 id="9233" class="ju jv iq bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">介绍</h1><p id="357f" class="pw-post-body-paragraph ks kt iq ku b kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">当我第一次开始这个项目时，我面临的问题是，关于认证Spotify用户的教程没有我预期的那么多。这就是为什么我决定公布我解决这个问题的方法。</p><p id="4756" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">这将是由两篇文章组成的系列文章。在第一个步骤中，我将通过Spotify、ReactNative和expo-auth-session完成认证过程。第二部分是以tinderlike swipecards的形式展示和播放你个人当前的20首热门歌曲。观看这个<a class="ae lv" href="https://www.youtube.com/watch?v=UmSQqXhGjkA" rel="noopener ugc nofollow" target="_blank">视频</a>进行快速演示。</p><p id="2deb" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">整个项目可以在<a class="ae lv" href="https://github.com/kevintomas1995/spotify_top_songs_player" rel="noopener ugc nofollow" target="_blank">这里</a>找到</p><figure class="lx ly lz ma gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi lw"><img src="../Images/a3c8e802076e1b4bc0b6e7f70c8d903f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*u11wldgImvCqwXYTnme1zA.jpeg"/></div></div></figure><h1 id="4baf" class="ju jv iq bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">设置</h1><p id="0fe3" class="pw-post-body-paragraph ks kt iq ku b kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">在深入研究代码之前，我们首先要设置一些关于Spotify的事情。前往<a class="ae lv" href="https://developer.spotify.com/dashboard/applications" rel="noopener ugc nofollow" target="_blank">这个网站</a>，用你的Spotify账户登录。之后，创建一个app。在以下屏幕中，您稍后将需要<strong class="ku ir">客户端id </strong>。</p><figure class="lx ly lz ma gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi mf"><img src="../Images/529d87c337392ff4e6ff7753b5050a13.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8vWFGE_61KUVEmPOqpoAgw.jpeg"/></div></div></figure><p id="cbde" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">接下来，您需要进入<strong class="ku ir">“编辑设置”</strong>屏幕。在那里，您需要插入一个重定向URI。在我的例子中，它是“exp://127.0.0.1:19000/”，因为我在本地机器上使用expo。</p><figure class="lx ly lz ma gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="mb mc di md bf me"><div class="gh gi mf"><img src="../Images/de336151de44b78fc2c56c1ab8916e08.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GUi07zwt8L3BvFTYXx7qDw.jpeg"/></div></div></figure><p id="20b3" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">这都是关于设置！现在让我们深入研究代码吧！</p><h1 id="4dd3" class="ju jv iq bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">登录屏幕</h1><pre class="lx ly lz ma gt mg mh mi mj aw mk bi"><span id="33c4" class="ml jv iq mh b gy mm mn l mo mp">import { StatusBar } from "expo-status-bar";<br/>import React from "react";<br/>import { View, StyleSheet, KeyboardAvoidingView, Text } from "react-native";<br/>import { Button, Image } from "react-native-elements";<br/>import { useEffect, useState } from "react";<br/>import { ResponseType, useAuthRequest } from "expo-auth-session";<br/>import { useSelector, useDispatch } from "react-redux";<br/>import * as tokenAction from "../store/actions/token";<br/>import axios from "axios";<br/>import * as songAction from "../store/actions/topSongs";</span><span id="b64e" class="ml jv iq mh b gy mq mn l mo mp">const discovery = {<br/>  authorizationEndpoint: <br/>  "https://accounts.spotify.com/authorize",<br/>  tokenEndpoint: <br/>  "https://accounts.spotify.com/api/token",<br/>};</span><span id="4402" class="ml jv iq mh b gy mq mn l mo mp">const LoginScreen = ({ navigation }) =&gt; {<br/>  const dispatch = useDispatch();<br/>  const [token, setToken] = useState("");<br/>  const [request, response, promptAsync] = <br/>  useAuthRequest(<br/>    {<br/>      responseType: ResponseType.Token,<br/>      clientId: "YOUR_CLIENT_ID",<br/>      scopes: [<br/>        "user-read-currently-playing",<br/>        "user-read-recently-played",<br/>        "user-read-playback-state",<br/>        "user-top-read",<br/>        "user-modify-playback-state",<br/>        "streaming",<br/>        "user-read-email",<br/>        "user-read-private",<br/>      ],<br/>      // In order to follow the "Authorization Code Flow" <br/>      // to fetch token after authorizationEndpoint<br/>      // this must be set to false<br/>      usePKCE: false,<br/>      redirectUri: "exp://127.0.0.1:19000/",<br/>    },<br/>    discovery<br/>  );</span><span id="c4a8" class="ml jv iq mh b gy mq mn l mo mp">  useEffect(() =&gt; {<br/>    if (response?.type === "success") {<br/>      const { access_token } = response.params;<br/>      setToken(access_token);<br/>    }<br/>  }, [response]);</span><span id="efdf" class="ml jv iq mh b gy mq mn l mo mp">  useEffect(() =&gt; {<br/>    if (token) {<br/>      axios(<br/>        "https://api.spotify.com/v1/me/top/<br/>        tracks?time_range=short_term", {<br/>        method: "GET",<br/>        headers: {<br/>          Accept: "application/json",<br/>          "Content-Type": "application/json",<br/>          Authorization: "Bearer " + token,<br/>        },<br/>      })<br/>        .then((response) =&gt; {<br/>          dispatch(songAction.addTopSongs(response));<br/>        })<br/>        .catch((error) =&gt; {<br/>          console.log("error", error.message);<br/>        });</span><span id="0c8d" class="ml jv iq mh b gy mq mn l mo mp">      setTimeout(<br/>        () =&gt;<br/>          navigation.replace("Home", {<br/>            token: token,<br/>            <br/>          }),<br/>        500<br/>      );</span><span id="5848" class="ml jv iq mh b gy mq mn l mo mp">      dispatch(tokenAction.addToken(token));<br/>    }<br/>  });</span><span id="625e" class="ml jv iq mh b gy mq mn l mo mp">  return (<br/>    &lt;KeyboardAvoidingView behavior="padding" <br/>    style={styles.container}&gt;<br/>      &lt;StatusBar style="light" /&gt;<br/>      &lt;Text<br/>        style={{<br/>          fontSize: 30,<br/>          fontWeight: "bold",<br/>          color: "white",<br/>          marginBottom: "20%",<br/>        }}<br/>      &gt;<br/>        top song player<br/>      &lt;/Text&gt;<br/>      &lt;Button<br/>        title="Login with Spotify"<br/>        style={styles.button}<br/>        onPress={() =&gt; {<br/>          promptAsync();<br/>        }}<br/>      /&gt;<br/>      &lt;View style={{ height: 100 }} /&gt;<br/>    &lt;/KeyboardAvoidingView&gt;<br/>  );<br/>};</span><span id="831c" class="ml jv iq mh b gy mq mn l mo mp">export default LoginScreen;</span><span id="871f" class="ml jv iq mh b gy mq mn l mo mp">const styles = StyleSheet.create({<br/>  container: {<br/>    flex: 1,<br/>    alignItems: "center",<br/>    justifyContent: "center",<br/>    backgroundColor: "black",<br/>  },</span><span id="c01b" class="ml jv iq mh b gy mq mn l mo mp">  button: {<br/>    width: 200,<br/>    marginTop: 50,<br/>  },<br/>});</span></pre><p id="3b0d" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">如果你看一下导入，你可以看到我使用<strong class="ku ir"> redux </strong>进行状态管理，使用<strong class="ku ir"> axios </strong>进行数据获取，使用<strong class="ku ir"> expo-auth-session </strong>进行实际的认证。其他进口货都很标准。</p><p id="64b2" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">一般来说，我们使用的是<strong class="ku ir">隐式</strong> <a class="ae lv" href="https://developer.spotify.com/documentation/general/guides/authorization-guide/#implicit-grant-flow" rel="noopener ugc nofollow" target="_blank">认证流程</a>。</p><pre class="lx ly lz ma gt mg mh mi mj aw mk bi"><span id="c776" class="ml jv iq mh b gy mm mn l mo mp">const discovery = {<br/>  authorizationEndpoint: <br/>  "https://accounts.spotify.com/authorize",<br/>  tokenEndpoint: <br/>  "https://accounts.spotify.com/api/token",<br/>};</span></pre><p id="a255" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">第一个常量<strong class="ku ir"> discovery </strong>包含两个链接，这对认证过程至关重要。<strong class="ku ir">授权端点</strong>将是您点击登录按钮后将被重定向到的链接。第二个是<strong class="ku ir"> tokenEndpoint </strong>，它将调用spotify api，以便为您当前的会话创建一个唯一的spotify令牌。</p><pre class="lx ly lz ma gt mg mh mi mj aw mk bi"><span id="a083" class="ml jv iq mh b gy mm mn l mo mp">const [request, response, promptAsync] = <br/>useAuthRequest(<br/>    {<br/>      responseType: ResponseType.Token,<br/>      clientId: "YOUR_CLIENT_ID",<br/>      scopes: [<br/>        "user-read-currently-playing",<br/>        "user-read-recently-played",<br/>        "user-read-playback-state",<br/>        "user-top-read",<br/>        "user-modify-playback-state",<br/>        "streaming",<br/>        "user-read-email",<br/>        "user-read-private",<br/>      ],<br/>      // In order to follow the "Authorization Code Flow" to <br/>      // fetch token after authorizationEndpoint<br/>      // this must be set to false<br/>      usePKCE: false,<br/>      redirectUri: "exp://127.0.0.1:19000/",<br/>    },<br/>    discovery<br/>  );</span></pre><p id="13e8" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">关于<strong class="ku ir">使用权限请求</strong>钩子的详细解释请看<a class="ae lv" href="https://docs.expo.dev/guides/authentication/#spotify" rel="noopener ugc nofollow" target="_blank">这里</a>。这段代码中要编辑的最重要的东西首先是<strong class="ku ir"> clientId </strong>。您必须在设置步骤中插入您的客户端ID。其次，你需要定义<strong class="ku ir">范围</strong>。这对您可以成功使用哪个spotify api端点有影响。看看<a class="ae lv" href="https://developer.spotify.com/documentation/web-api/quick-start/" rel="noopener ugc nofollow" target="_blank"> spotify api文档</a>。这里最后一个重要的东西是<strong class="ku ir"> redirectUri </strong>，在成功连接到spotify后，您需要在这里插入您希望重定向您的用户的url。在我的例子中，它是exp://127.0.0.1:19000/。这个<strong class="ku ir">必须和</strong>和你设置中的URL一样！</p><pre class="lx ly lz ma gt mg mh mi mj aw mk bi"><span id="28d7" class="ml jv iq mh b gy mm mn l mo mp">useEffect(() =&gt; {<br/>    if (response?.type === "success") {<br/>      const { access_token } = response.params;<br/>      setToken(access_token);<br/>    }<br/>  }, [response]);</span></pre><p id="6fd5" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">在本节中，我们将检查身份验证过程是否成功。如果是这样的话，我们将从之前代码片段返回的响应中提取访问令牌，并存储它。</p><p id="b35d" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">之后，我们就可以使用访问令牌从spotify api获取数据了！</p><pre class="lx ly lz ma gt mg mh mi mj aw mk bi"><span id="6299" class="ml jv iq mh b gy mm mn l mo mp">useEffect(() =&gt; {<br/>  if (token) {<br/>    axios(<br/>      "https://api.spotify.com/v1/me/top/tracks?time_range=short_term",<br/>       {<br/>      method: "GET",<br/>      headers: {<br/>        Accept: "application/json",<br/>        "Content-Type": "application/json",<br/>        Authorization: "Bearer " + token,<br/>      },<br/>    })<br/>      .then((response) =&gt; {<br/>        dispatch(songAction.addTopSongs(response));<br/>      })<br/>      .catch((error) =&gt; {<br/>        console.log("error", error.message);<br/>      });</span><span id="e5d5" class="ml jv iq mh b gy mq mn l mo mp">    setTimeout(<br/>      () =&gt;<br/>        navigation.replace("Home", {<br/>          token: token,<br/>         <br/>        }),<br/>      500<br/>    );</span><span id="ce6f" class="ml jv iq mh b gy mq mn l mo mp">    dispatch(tokenAction.addToken(token));<br/>  }<br/>});</span></pre><p id="8a64" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">此时，我们正在调用<a class="ae lv" href="https://developer.spotify.com/console/get-current-user-top-artists-and-tracks/?type=artists" rel="noopener ugc nofollow" target="_blank"> top tracks端点</a>以获取当前热门歌曲。在头中，我们使用访问令牌来访问这个端点。此外，我还将热门歌曲和访问令牌发送到redux商店。因为我们只有两个屏幕，所以这不是很必要，你也可以通过你的组件传递数据。尽管如此，如果应用程序变得更加复杂，这将变得非常有用。最后一步，我们用主屏幕替换登录屏幕。</p><p id="aa1f" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">代码的其余部分实际上是非常标准的反应式代码！</p><p id="ae16" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated">正如我在介绍中提到的，请随意查看github回购</p><h1 id="ba36" class="ju jv iq bd jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr bi translated">结论</h1><p id="aadc" class="pw-post-body-paragraph ks kt iq ku b kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">在这个系列的第二部分，我们将介绍你当前热门歌曲的显示和播放。一如既往的感谢你阅读我的故事！</p><p id="17ac" class="pw-post-body-paragraph ks kt iq ku b kv lq kx ky kz lr lb lc ld ls lf lg lh lt lj lk ll lu ln lo lp ij bi translated"><em class="mr">更多内容请看</em><a class="ae lv" href="http://plainenglish.io" rel="noopener ugc nofollow" target="_blank"><strong class="ku ir"><em class="mr">plain English . io</em></strong></a></p></div></div>    
</body>
</html>