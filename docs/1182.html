<html>
<head>
<title>Connecting Netlify Forms to Angular</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将网络形式连接到角度</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/connecting-netlify-forms-to-angular-template-driven-or-reactive-forms-b3f053c5cd56?source=collection_archive---------11-----------------------#2021-03-12">https://javascript.plainenglish.io/connecting-netlify-forms-to-angular-template-driven-or-reactive-forms-b3f053c5cd56?source=collection_archive---------11-----------------------#2021-03-12</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="9ac5" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">模板驱动或反应式表单</h2></div><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi kc"><img src="../Images/d25a708304e95fcfe543c8f4177d416f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aawmsQmJEhPdOubnJ-abLA.png"/></div></div></figure><p id="b279" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">Netlify是一个很好的部署解决方案，尤其是对于简单的点对点应用程序。它提供了表单功能，消除了只为表单处理和电子邮件发送而创建后端的需要。</p><p id="7e47" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">Angular是最受欢迎的前端框架之一，提供了大量优秀的特性。其中有两种表单类型——反应式和模板驱动式。</p><p id="a877" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">这两者不能“开箱即用”,所以让我们让它们发挥作用吧！</p><h1 id="ada3" class="lk ll in bd lm ln lo lp lq lr ls lt lu jt lv ju lw jw lx jx ly jz lz ka ma mb bi translated">问题是</h1><p id="edd2" class="pw-post-body-paragraph ko kp in kq b kr mc jo kt ku md jr kw kx me kz la lb mf ld le lf mg lh li lj ig bi translated">简而言之，Angular使用组件，这意味着我们的表单将由客户端JavaScript呈现。因此，Netlify机器人无法识别表单及其字段，因为它们在部署期间不存在。</p><h1 id="fc6b" class="lk ll in bd lm ln lo lp lq lr ls lt lu jt lv ju lw jw lx jx ly jz lz ka ma mb bi translated">解决方案</h1><p id="8a9a" class="pw-post-body-paragraph ko kp in kq b kr mc jo kt ku md jr kw kx me kz la lb mf ld le lf mg lh li lj ig bi translated">我们需要在我们的<code class="fe mh mi mj mk b">index.html</code>中创建一个可以被机器人发现的“不可见”表单，我们将提交它。这将通过对我们的索引页面的POST请求来实现。</p><p id="93c0" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">在我们了解所有的本质细节之前，如果你像我一样，你可能会喜欢为下一个应用程序准备一份清单。以下是我的供参考:</p><ul class=""><li id="c639" class="ml mm in kq b kr ks ku kv kx mn lb mo lf mp lj mq mr ms mt bi translated">在<code class="fe mh mi mj mk b">index.html</code>中编写您的不可见表单(使用与实际表单相同的“name”属性)</li><li id="586d" class="ml mm in kq b kr mu ku mv kx mw lb mx lf my lj mq mr ms mt bi translated">为你需要的数据写一个合适的接口</li><li id="c3cb" class="ml mm in kq b kr mu ku mv kx mw lb mx lf my lj mq mr ms mt bi translated">用<code class="fe mh mi mj mk b">ng g s NetlifyForms</code>生成一个网络表单服务</li><li id="5bbb" class="ml mm in kq b kr mu ku mv kx mw lb mx lf my lj mq mr ms mt bi translated">向包含重定向规则<code class="fe mh mi mj mk b">/* /index.html 200</code>的src文件夹添加一个<code class="fe mh mi mj mk b">_redirects</code> glob</li><li id="9d2f" class="ml mm in kq b kr mu ku mv kx mw lb mx lf my lj mq mr ms mt bi translated">通过添加以下代码行，将glob包含在您的<code class="fe mh mi mj mk b">angular.json</code>资产数组中:</li></ul><pre class="kd ke kf kg gt mz mk na nb aw nc bi"><span id="29fa" class="nd ll in mk b gy ne nf l ng nh">{ "glob": "_redirects", "input": "src", "output": "/" }</span></pre><ul class=""><li id="ae5b" class="ml mm in kq b kr ks ku kv kx mn lb mo lf mp lj mq mr ms mt bi translated">在包含表单的组件中使用NetlifyForms服务来提交表单</li></ul><p id="391c" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">好的，这是一个快速的概述，希望能在未来节省你的时间，并确保你不会错过任何重要的细节。</p><p id="fc6e" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">现在进行深入的过程。</p><p id="bdcc" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">下面是我的可视表单的样子:</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="65a2" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">如你所见，我使用的是模板驱动的表单，但这种方法也适用于反应式表单。然而，<strong class="kq io">文件上传不被支持</strong>，所以请记住这一点。</p><p id="63cf" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">首先，我们需要在<code class="fe mh mi mj mk b">index.html</code>中创建一个我们表单的克隆。这是我的样子:</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="8aca" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">重要的是，你要给<strong class="kq io"> name属性赋予与你的实际表单</strong>相同的值，还要添加<code class="fe mh mi mj mk b">netlify</code>属性来通知机器人你希望通过Netlify处理这个表单，最后添加<code class="fe mh mi mj mk b">netlify-honeypot="bot-field"</code>属性来激活所提供的垃圾邮件机器人保护。</p><p id="23e1" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">您还可以通过指定<code class="fe mh mi mj mk b">data-netlify-recaptcha="true"</code>属性向表单中添加reCAPTCHA，并向表单中希望显示挑战的位置添加div。完成的reCAPTCHA表单应该是这样的:</p><pre class="kd ke kf kg gt mz mk na nb aw nc bi"><span id="150b" class="nd ll in mk b gy ne nf l ng nh">&lt;form name="contact" method="POST" data-netlify-recaptcha="true" data-netlify="true"&gt;<br/>  &lt;p&gt;<br/>    &lt;label&gt;Email: &lt;input type="text" name="name" /&gt;&lt;/label&gt;<br/>  &lt;/p&gt;<br/>  &lt;p&gt;<br/>    &lt;label&gt;Message: &lt;textarea name="message"&gt;&lt;/textarea&gt;&lt;/label&gt;<br/>  &lt;/p&gt;<br/>  &lt;div data-netlify-recaptcha="true"&gt;&lt;/div&gt;<br/>  &lt;p&gt;<br/>    &lt;button type="submit"&gt;Send&lt;/button&gt;<br/>  &lt;/p&gt;<br/>&lt;/form&gt;</span></pre><p id="ef92" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">接下来，我们需要创建一个适合我们将要发送的数据类型的接口。我的将被命名为<code class="fe mh mi mj mk b">Feedback</code>，并将驻留在与我的表单所在的组件相同的文件夹中的一个<code class="fe mh mi mj mk b">feedback.ts</code>文件中。</p><p id="c823" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">这是我完成的反馈界面文件的样子:</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="ff33" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">我们现在应该创建我们的Angular服务，它将处理我们对索引页面表单的提交。</p><p id="d53a" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">运行<code class="fe mh mi mj mk b">ng g s NetlifyForms</code>来创建服务。</p><p id="3c46" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">下面是你的<code class="fe mh mi mj mk b">netlify-forms.service.ts</code>文件应该是什么样子:</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="398a" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">如您所见，我们有两个私有函数来处理错误记录和实际提交，第三个函数可供其他组件访问，以便转换反馈。<strong class="kq io">为了以正确的数据类型提交表单，我们必须在POST请求中包含</strong> <code class="fe mh mi mj mk b">Content-Type</code> <strong class="kq io">标题</strong>，并<strong class="kq io">将其设置为</strong> <code class="fe mh mi mj mk b">application/x-www-form-urlencoded</code>，这一点很重要。</p><p id="9f0e" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">现在，我们可以在提交表单的组件中使用我们的新服务(例如，通常通过对服务器的请求)。为了向我的用户表明他们的查询已经提交或者没有发送，我在我的表单下面显示了一个弹出窗口。这就是为什么我有<code class="fe mh mi mj mk b">emailSent</code>和<code class="fe mh mi mj mk b">emailFailed</code>变量(它们不是必需的)。下面是我的<code class="fe mh mi mj mk b">contact.component.ts</code>文件的样子:</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="27f6" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">您还会注意到，我们订阅了我们的<code class="fe mh mi mj mk b">submitFeedback()</code>函数，因此在<code class="fe mh mi mj mk b">ngOnDestroy</code>生命周期方法中取消订阅是很好的，这样可以防止可能的数据泄漏。</p><p id="6bc7" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">到目前为止一切顺利，但即使你现在尝试提交表格，它也不会工作。我们需要做的是将每个请求重新路由到我们的<code class="fe mh mi mj mk b">index.html</code>文件，以便Angular可以处理它。</p><p id="11f1" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">我们写了一个非常简单的规则，规定<code class="fe mh mi mj mk b">/* /index.html 200</code>。<code class="fe mh mi mj mk b">/*</code>捕获任何路由并将其重定向到我们的<code class="fe mh mi mj mk b">index.html</code>文件，并返回一个状态代码<code class="fe mh mi mj mk b">200</code>，而不是通常用于重定向的<code class="fe mh mi mj mk b">301</code>。</p><p id="2119" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">上面的规则放在一个名为<code class="fe mh mi mj mk b">_redirects</code>的文件中(不需要扩展名，因为它只是一个glob ),这个文件位于我们的<code class="fe mh mi mj mk b">src</code>文件夹中。我们还需要将它包含在我们的<code class="fe mh mi mj mk b">angular.json</code>中的<code class="fe mh mi mj mk b">assets</code>数组中，这是通过以下代码行实现的:</p><pre class="kd ke kf kg gt mz mk na nb aw nc bi"><span id="5c55" class="nd ll in mk b gy ne nf l ng nh">"assets": ["src/favicon.ico", "src/assets",{ "glob": "_redirects", "input": "src", "output": "/" }]</span></pre><p id="5090" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">如果您在localhost上运行<code class="fe mh mi mj mk b">ng serve</code>进行开发，您可能仍然会收到404状态代码。这是因为您运行在开发服务器上，它被设置为服务于我们的静态文件以及响应路由到根的GET请求(<code class="fe mh mi mj mk b">/</code>)。因此，当我们发出一个包含表单数据的POST请求时，我们最终会遇到一个<code class="fe mh mi mj mk b">404 Not Found</code>错误。不过不要担心，因为这个<strong class="kq io">将在Netlify上工作</strong>。</p><p id="fd19" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">在这里，您已经准备好将您漂亮的应用程序部署到Netlify，并直接从表单仪表板上阅读您提交的所有表单，如果您愿意，甚至可以设置电子邮件通知。</p><h1 id="7b5b" class="lk ll in bd lm ln lo lp lq lr ls lt lu jt lv ju lw jw lx jx ly jz lz ka ma mb bi translated">结论</h1><p id="0a88" class="pw-post-body-paragraph ko kp in kq b kr mc jo kt ku md jr kw kx me kz la lb mf ld le lf mg lh li lj ig bi translated">感谢您从头到尾阅读本文，我希望这种方法能够解决您的问题。如果您也对Netlify上的部署工作方式感兴趣，您应该查看本文<a class="ae nk" href="https://www.smashingmagazine.com/2020/10/angular-feedback-netlify-forms-edge/" rel="noopener ugc nofollow" target="_blank"/>,其中详细介绍了这两个步骤，也是我自己找到原始解决方案的地方。</p></div></div>    
</body>
</html>