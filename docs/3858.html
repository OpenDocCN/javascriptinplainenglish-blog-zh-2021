<html>
<head>
<title>Building a Signaling Server for Simple-Peer</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为简单对等体构建信令服务器</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/building-a-signaling-server-for-simple-peer-f92d754edc85?source=collection_archive---------3-----------------------#2021-08-03">https://javascript.plainenglish.io/building-a-signaling-server-for-simple-peer-f92d754edc85?source=collection_archive---------3-----------------------#2021-08-03</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="46ed" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">信令、STUN和TURN的快速介绍，以及用于简单对等的开源信令服务器和包装器。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi kj"><img src="../Images/2937c08716a5102b316c8fc793764ea9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*Wv-IU2-NB_pi-jzgkd1k-g.gif"/></div></div></figure><p id="a20d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">早在2015年，我就构建了<a class="ae kv" href="https://kinectron.github.io/#/" rel="noopener ugc nofollow" target="_blank">一个依赖于<a class="ae kv" href="https://peerjs.com/" rel="noopener ugc nofollow" target="_blank"> PeerJS </a>的开源工具</a>。几年后，我对该工具进行了改造，并注意到PeerJS出现了一些错误，该工具在2014年左右被其最初的开发者弃用。在对PeerJS的替代方案进行了一些研究之后，我发现Feross的<a class="ae kv" href="https://github.com/feross/simple-peer" rel="noopener ugc nofollow" target="_blank"> simple-peer </a>被很好地记录、维护，并被许多项目使用。但是它缺少了一个重要的组件——一个<a class="ae kv" href="https://developer.mozilla.org/en-US/docs/Web/API/WebRTC_API/Signaling_and_video_calling" rel="noopener ugc nofollow" target="_blank">信令服务器</a>。</p><p id="31e6" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">从那以后，我一直在慢慢收集关于信令、STUN和TURN服务器的信息，并最终创建了我自己的开源<a class="ae kv" href="https://github.com/lisajamhoury/simple-peer-server" rel="noopener ugc nofollow" target="_blank">信令服务器</a>和用于简单对等的<a class="ae kv" href="https://github.com/lisajamhoury/simple-peer-wrapper" rel="noopener ugc nofollow" target="_blank">包装器</a>。以下是我所学到的东西的汇编，我发现有用的资源，以及对我所构建的工具的简短介绍。</p><h1 id="0a28" class="kw kx in bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">什么是信令服务器，我为什么需要信令服务器？</h1><p id="d4fd" class="pw-post-body-paragraph jk jl in jm b jn lu jp jq jr lv jt ju jv lw jx jy jz lx kb kc kd ly kf kg kh ig bi translated">重要的事情先来。对等连接是<a class="ae kv" href="https://webrtc.org/" rel="noopener ugc nofollow" target="_blank"> WebRTC </a>的一部分，是两台计算机(称为“对等方”)之间的直接连接，用于在两台计算机之间直接发送视频、音频和数据。对等连接不同于到服务器的连接，因为它们允许对等方之间直接交换信息，而不是通过服务器。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi lz"><img src="../Images/2ccfb5c90c39068b270d58be057a5973.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cPqlzNWMLRL7BWMyK8cAtw.png"/></div></div><figcaption class="ma mb gj gh gi mc md bd b be z dk">Peer connections allow for direct communication between two computers, rather than communicating through a server.</figcaption></figure><p id="bf58" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">虽然一旦有了对等连接，两个对等体就可以直接相互通信，但是WebRTC没有给对等体一种找到彼此以建立连接的方法——这就是信令服务器的用武之地。</p><p id="c571" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">信令服务器是允许对等体找到彼此并建立对等体连接的服务器。它存在于WebRTC之外，但却是建立对等连接的必要组件。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi me"><img src="../Images/67a67553f701580d47f509a4046afeee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*a5kh2ZGgXLU74kdOKMzEbw.png"/></div></div><figcaption class="ma mb gj gh gi mc md bd b be z dk">A signaling server is a server that allows peers to find each other and to establish a peer connection.</figcaption></figure><h1 id="b16f" class="kw kx in bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">用于简单对等体的信令服务器</h1><p id="cae7" class="pw-post-body-paragraph jk jl in jm b jn lu jp jq jr lv jt ju jv lw jx jy jz lx kb kc kd ly kf kg kh ig bi translated"><a class="ae kv" href="https://github.com/feross/simple-peer" rel="noopener ugc nofollow" target="_blank"> Simple-peer </a>是一个创建一对一对等连接的库，但是它不包括信令服务器。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi me"><img src="../Images/547bd91f167f1557770c99ff7254ebcb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wN2HJNZJyaUYy9fQHf5uBQ.png"/></div></div><figcaption class="ma mb gj gh gi mc md bd b be z dk">The simple-peer library creates peer connections, but does not handle signaling.</figcaption></figure><p id="89b3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我想在我的项目中使用simple-peer，但是我找不到一个开源的信令服务器。因此，我在与WebRTC 实时通信的<a class="ae kv" href="https://codelabs.developers.google.com/codelabs/webrtc-web#0" rel="noopener ugc nofollow" target="_blank"> Codelab的帮助下构建了一个。一年后，我在NYU </a>用同龄人给<a class="ae kv" href="https://github.com/lisajamhoury/The-Body-Everywhere-And-Here/blob/master/syllabus.md" rel="noopener ugc nofollow" target="_blank">上课，我意识到我需要一个工具来为我的班级范例使用。这促使我将我编写的信令服务器开发成其他人可以使用的东西。</a></p><p id="10d7" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我构建的工具由两个模块组成:<a class="ae kv" href="https://github.com/lisajamhoury/simple-peer-server" rel="noopener ugc nofollow" target="_blank">简单对等服务器</a>和<a class="ae kv" href="https://github.com/lisajamhoury/simple-peer-wrapper" rel="noopener ugc nofollow" target="_blank">简单对等包装器</a>。首先，您需要启动并运行服务器。</p><pre class="kk kl km kn gt mf mg mh mi aw mj bi"><span id="4b36" class="mk kx in mg b gy ml mm l mn mo">// in your terminal — install the module <br/>npm install simple-peer-server</span><span id="6017" class="mk kx in mg b gy mp mm l mn mo">// in your application file — create the server<br/>const SimplePeerServer = require('simple-peer-server');<br/>const http = require('http');<br/>const server = http.createServer();<br/>const spServer = new SimplePeerServer(server);server.listen(8081);</span><span id="e222" class="mk kx in mg b gy mp mm l mn mo">// in your terminal — run it!<br/>node app.js</span></pre><p id="cc6c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">然后，您需要在客户端代码中包含包装器。</p><pre class="kk kl km kn gt mf mg mh mi aw mj bi"><span id="bf4b" class="mk kx in mg b gy ml mm l mn mo">// in your terminal — install the module <br/>npm install simple-peer-wrapper</span><span id="028b" class="mk kx in mg b gy mp mm l mn mo">// in your client code - create a wrapper and connect to your server<br/>const options = {<br/>  serverUrl: 'http://localhost:8081',<br/>};<br/><br/>const spw = new SimplePeerWrapper(options);<br/>spw.connect();</span><span id="9d3d" class="mk kx in mg b gy mp mm l mn mo">spw.on('data', (data) =&gt; {<br/>  const partnerData = data.data;<br/>});</span><span id="9824" class="mk kx in mg b gy mp mm l mn mo">// make sure you close the connection before you close the window<br/>window.onbeforeunload = () =&gt; {<br/>  spw.close();<br/>};</span></pre><p id="b00c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">上面的代码连接到信令服务器，使用simple-peer创建一个对等连接，并将从另一个对等方接收的数据存储在一个变量中。完整的文档和示例代码可以在<a class="ae kv" href="https://github.com/lisajamhoury/simple-peer-server" rel="noopener ugc nofollow" target="_blank">这里(服务器)</a>和<a class="ae kv" href="https://github.com/lisajamhoury/simple-peer-wrapper" rel="noopener ugc nofollow" target="_blank">这里(包装器)</a>获得。</p><h1 id="a062" class="kw kx in bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">关于眩晕/转身服务器的一个注释</h1><p id="57b3" class="pw-post-body-paragraph jk jl in jm b jn lu jp jq jr lv jt ju jv lw jx jy jz lx kb kc kd ly kf kg kh ig bi translated">简单对等服务器和简单对等包装器一起提供了在两个或多个对等体之间建立连接的信令服务器和客户端。</p><p id="200d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">他们使用<a class="ae kv" href="https://socket.io/" rel="noopener ugc nofollow" target="_blank">插座。IO </a>传输信令消息，然后通过<a class="ae kv" href="https://github.com/feross/simple-peer" rel="noopener ugc nofollow" target="_blank">简单对等</a>创建对等连接。</p><p id="a232" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">要启动并运行，您可以在您的<a class="ae kv" href="https://whatismyipaddress.com/localhost" rel="noopener ugc nofollow" target="_blank">本地主机</a>上运行一个信令服务器和您的客户端代码。</p><p id="51da" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果您在公共互联网上启动您的应用程序，您可能还需要STUN和TURN服务器。STUN和TURN服务器负责获取对等体的IP地址。STUN服务器可以为大约86%的连接获取公共IP地址。如果您只是在本地测试或创建一个类项目，STUN服务器可能会做到这一点。对于另外14%的连接，以及需要在公共互联网上可靠工作的应用程序，需要一个TURN服务器来通过某些防火墙。</p><p id="ba2f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">默认的STUN服务器由simple-peer提供。(尽管它们可以在简单对等和简单对等包装器中被覆盖。)TURN服务器的维护成本可能很高，需要由应用程序开发人员提供(如果您正在阅读本文，那么开发人员可能就是您；).</p><p id="d089" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">要了解更多关于信令、STUN和TURN服务器的信息，我推荐Sam Dutton的这篇优秀文章。如果你需要一个TURN服务器，你可能会发现这篇由Gabriel Turner撰写的关于<a class="ae kv" href="https://gabrieltanner.org/blog/turn-server" rel="noopener ugc nofollow" target="_blank">如何使用Coturn </a>设置和配置你自己的TURN服务器的文章很有帮助。你也可以查看付费服务，如<a class="ae kv" href="https://www.twilio.com/stun-turn" rel="noopener ugc nofollow" target="_blank"> Twilio的网络遍历服务</a>。</p><p id="0c5c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">一旦你设置好你的TURN服务器，参见<a class="ae kv" href="https://github.com/lisajamhoury/simple-peer-wrapper#new-simplepeerwrapperoptions" rel="noopener ugc nofollow" target="_blank">简单对等包装文档</a>了解如何将它们添加到你的对等连接中。</p><h1 id="d925" class="kw kx in bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">有用的资源</h1><p id="83f8" class="pw-post-body-paragraph jk jl in jm b jn lu jp jq jr lv jt ju jv lw jx jy jz lx kb kc kd ly kf kg kh ig bi translated">以下是我在研究和构建时发现有用的参考资料。请在评论中分享其他有用的资源:)</p><h2 id="1a80" class="mk kx in bd ky mq mr dn lc ms mt dp lg jv mu mv lk jz mw mx lo kd my mz ls na bi translated"><strong class="ak">文章</strong></h2><ul class=""><li id="8f78" class="nb nc in jm b jn lu jr lv jv nd jz ne kd nf kh ng nh ni nj bi translated"><a class="ae kv" href="https://www.html5rocks.com/en/tutorials/webrtc/infrastructure/" rel="noopener ugc nofollow" target="_blank">构建WebRTC应用程序所需的后端服务:STUN、TURN和signaling</a>Sam dutt on</li><li id="92da" class="nb nc in jm b jn nk jr nl jv nm jz nn kd no kh ng nh ni nj bi translated"><a class="ae kv" href="https://codelabs.developers.google.com/codelabs/webrtc-web#0" rel="noopener ugc nofollow" target="_blank"> Codelab:与WebRTC的实时通信</a></li><li id="39fe" class="nb nc in jm b jn nk jr nl jv nm jz nn kd no kh ng nh ni nj bi translated"><a class="ae kv" href="https://computer.howstuffworks.com/nat.htm" rel="noopener ugc nofollow" target="_blank">网络地址转换的工作原理</a>杰夫·泰森</li><li id="0c84" class="nb nc in jm b jn nk jr nl jv nm jz nn kd no kh ng nh ni nj bi translated"><a class="ae kv" href="https://gabrieltanner.org/blog/turn-server" rel="noopener ugc nofollow" target="_blank">如何使用Coturn </a>设置和配置自己的TURN服务器</li><li id="ff8e" class="nb nc in jm b jn nk jr nl jv nm jz nn kd no kh ng nh ni nj bi translated"><a class="ae kv" href="https://bloggeek.me/google-free-turn-server/" rel="noopener ugc nofollow" target="_blank">Google为什么不提供免费的TURN服务器？</a>作者BlogGeek。我(感谢<a class="ae kv" href="https://twitter.com/HCornflower" rel="noopener ugc nofollow" target="_blank">菲利普·汉克</a>为<a class="ae kv" href="https://twitter.com/HCornflower/status/1422654574649913346" rel="noopener ugc nofollow" target="_blank">提供参考</a></li></ul><h2 id="aa4b" class="mk kx in bd ky mq mr dn lc ms mt dp lg jv mu mv lk jz mw mx lo kd my mz ls na bi translated">代码参考/工具</h2><ul class=""><li id="07e4" class="nb nc in jm b jn lu jr lv jv nd jz ne kd nf kh ng nh ni nj bi translated"><a class="ae kv" href="https://github.com/coturn/coturn" rel="noopener ugc nofollow" target="_blank">转</a></li><li id="2d1b" class="nb nc in jm b jn nk jr nl jv nm jz nn kd no kh ng nh ni nj bi translated">Feross的简单同行</li><li id="b54f" class="nb nc in jm b jn nk jr nl jv nm jz nn kd no kh ng nh ni nj bi translated">Sagivo的WebRTC stun / turn服务器列表</li><li id="00b8" class="nb nc in jm b jn nk jr nl jv nm jz nn kd no kh ng nh ni nj bi translated"><a class="ae kv" href="https://webrtc.github.io/samples/src/content/peerconnection/trickle-ice/" rel="noopener ugc nofollow" target="_blank"> WebRTC样本:滴流冰</a></li></ul><p id="2723" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><em class="ki">更多内容尽在</em><a class="ae kv" href="http://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><strong class="jm io"><em class="ki">plain English . io</em></strong></a></p></div></div>    
</body>
</html>