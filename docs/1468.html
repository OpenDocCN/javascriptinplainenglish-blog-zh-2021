<html>
<head>
<title>How to Query Remote GraphQL Data with Apollo in Gatsby</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Gatsby中用Apollo查询远程GraphQL数据</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/how-to-query-remote-graphql-data-with-apollo-in-gatsby-d199a3e618d0?source=collection_archive---------1-----------------------#2021-03-29">https://javascript.plainenglish.io/how-to-query-remote-graphql-data-with-apollo-in-gatsby-d199a3e618d0?source=collection_archive---------1-----------------------#2021-03-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/f45f7f5eba69dc112122ac9d06fbc83a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GYj__5SpuSXmQU-s7zKrKQ.png"/></div></div></figure><p id="eefd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">Gatsby是一个依赖于GraphQL的React静态站点生成器。它可以将(几乎)任何来源任何数据转换为GraphQL，允许您查询这些数据，并使用这些数据来构建静态网站；静态网站意味着巨大的安全性，惊人的性能，搜索引擎优化反应。</p><p id="382c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这是完美的，特别是如果你有一个“内容”网站，如博客、新闻网站、作品集，以及一般情况下可以在内容更新时生成的网站(Gatsby也可以增量构建)，并且不需要在运行时访问远程数据。</p><p id="6e33" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">但是，让我们假设您正在使用WooCommerce编写一个电子商务网站(是的，您可以通过GraphQL访问您的商店数据并构建一个超快速的静态目录)，并且您需要在显示“添加到购物车”按钮之前检查某个产品的可用性，或者您想要验证用户并跟踪会话、购物车，在您的远程WooCommerce上保存订单。或者你想在你的博客上添加评论，或者向认证用户显示更多的数据(或者不同的价格)。</p><p id="e637" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">案例是无限的，一般来说，有些时候你需要访问远程和最新的数据，并在你的静态Gatsby页面中组合结果，在这些时候你会在你的Gatsby项目中需要<a class="ae kw" href="https://www.apollographql.com/docs/" rel="noopener ugc nofollow" target="_blank"> Apollo Client </a>。</p><h1 id="1572" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">阿波罗基础</h1><p id="8d1f" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">要访问Apollo的“功能”,您可以将应用程序包装在一个提供者中(带有客户端属性，如GraphQL URL ),然后在您的页面中，您可以访问几个挂钩(主要是useQuery)来查询数据。因为我们使用Gatsby，所以我们将使用<code class="fe ma mb mc md b">gatsby-browser.js</code>和<code class="fe ma mb mc md b">gatsby-ssr.js</code>来包装使用<code class="fe ma mb mc md b">wrapRootElement</code>函数的代码，这样项目中的任何页面和任何组件都可以查询或改变远程GraphQL源，允许您在静态页面中拥有“活”数据。</p><h1 id="ddbd" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">我们将创造什么</h1><p id="4728" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">我们将构建一个紧凑的(无用的)天气应用程序，它将从我在Heroku上找到的GraphQL API请求数据并显示结果，我们还将添加一个下拉列表来选择一个城市，我们将实现Apollo的<code class="fe ma mb mc md b">refetch()</code>功能，以始终获得最新数据。您还可以克隆本教程的<a class="ae kw" href="https://github.com/popeating/gatsby-apollo" rel="noopener ugc nofollow" target="_blank">库。</a></p><h1 id="2305" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">先决条件</h1><p id="11c8" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">要理解这一点，您至少需要对React JS、Gatsby(及其文件结构)、一点GraphQL(以及如何查询它)有基本的了解</p><h1 id="a335" class="kx ky iq bd kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu bi translated">盖茨比项目</h1><h2 id="429f" class="me ky iq bd kz mf mg dn ld mh mi dp lh kj mj mk ll kn ml mm lp kr mn mo lt mp bi translated">初始化项目</h2><p id="5696" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">我们从一个空白项目开始，我将我的项目命名为gatsby-apollo，除了sass之外，我没有安装任何插件(但是你可以省略它或者选择另一种样式方法)。让我们从以下内容开始:</p><pre class="mq mr ms mt gt mu md mv mw aw mx bi"><span id="337a" class="me ky iq md b gy my mz l na nb">npm init gatsby</span></pre><p id="82f0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">设置完成后，进入项目的文件夹以完成模块的安装。</p><p id="5277" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们需要几个模块，<em class="nc">同构获取</em>，它是获取函数的一个<a class="ae kw" href="https://en.wikipedia.org/wiki/Polyfill_(programming)" rel="noopener ugc nofollow" target="_blank">多填充器</a>:</p><pre class="mq mr ms mt gt mu md mv mw aw mx bi"><span id="3915" class="me ky iq md b gy my mz l na nb">npm install — save isomorphic-fetch</span></pre><p id="d860" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">最后是Apollo客户端和graphql库</p><pre class="mq mr ms mt gt mu md mv mw aw mx bi"><span id="1da1" class="me ky iq md b gy my mz l na nb">npm install @apollo/client graphql</span></pre><p id="c07c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">此时，您可以用如下空白模板替换文件<em class="nc"> pages/index.js </em>的内容:</p><figure class="mq mr ms mt gt jr"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="068c" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">运行以下命令并访问<code class="fe ma mb mc md b">http://localhost:8000</code></p><pre class="mq mr ms mt gt mu md mv mw aw mx bi"><span id="5eb9" class="me ky iq md b gy my mz l na nb">gatsby develop</span></pre><p id="7dfd" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">您应该会看到一个只有“Hello World”的空白页面。</p><h2 id="07bc" class="me ky iq bd kz mf mg dn ld mh mi dp lh kj mj mk ll kn ml mm lp kr mn mo lt mp bi translated">定义阿波罗提供者</h2><p id="894c" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">我们现在要定义将包装我们的应用程序的Apollo提供者和客户端。</p><p id="46ca" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在您的<code class="fe ma mb mc md b">src</code>文件夹中，创建一个名为<code class="fe ma mb mc md b">apollo</code>的新文件夹(或者您可以随意命名)，在这个文件夹中，我创建了两个文件<code class="fe ma mb mc md b">client.js</code>，它们定义了Apollo客户端属性，比如我们将要查询的URL、获取命令、缓存类型等等。这是一个基本示例，但是客户端可能会更复杂，有时您希望从响应中读取一些报头，或者您希望<a class="ae kw" href="https://www.apollographql.com/docs/react/networking/authentication/#header" rel="noopener ugc nofollow" target="_blank">在您的请求</a>中发送一个无记名身份验证令牌:</p><figure class="mq mr ms mt gt jr"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="92d8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">另一个文件是<code class="fe ma mb mc md b">provider.js</code>,它将把我们的应用程序包装在Apollo provider中，将客户端暴露给所有的子元素:</p><figure class="mq mr ms mt gt jr"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="cca5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">此时，您需要使用Gatsby浏览器API和Gatsby服务器呈现API，在提供HTML内容时(通过浏览器和SSR)对其进行操作，并用ApolloProvider包装根元素。</p><p id="c466" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在项目的根目录下创建<code class="fe ma mb mc md b">gatsby-browser.js</code>和<code class="fe ma mb mc md b">gatsby-ssr.js</code>文件，并在这两个文件中添加以下代码行(如果您需要关于这些API的更多信息，可以在Gatsby中找到:<a class="ae kw" href="https://www.gatsbyjs.com/docs/reference/config-files/gatsby-ssr/#wrapRootElement" rel="noopener ugc nofollow" target="_blank">https://www . Gatsby js . com/docs/reference/config-files/Gatsby-SSR/# wrapRootElement</a>):</p><figure class="mq mr ms mt gt jr"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="f606" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这就是所有的配置，如果你重新加载你的应用程序，它应该没有改变，但如果没有错误，这意味着你的索引页面现在包装在ApolloProvider中，可以访问我们之前定义的客户端配置。</p><h2 id="30a5" class="me ky iq bd kz mf mg dn ld mh mi dp lh kj mj mk ll kn ml mm lp kr mn mo lt mp bi translated">第一次查询</h2><p id="2f6a" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">让我们回到index.js，用一个基本查询来试试是否一切都如预期的那样工作:</p><figure class="mq mr ms mt gt jr"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="2976" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们现在从Apollo导入了useQuery钩子，我们定义了一个基本的查询(我不会详细描述这个查询和它的数据，你可以在这里找到它的端点和文档:【https://graphql-weather-api.herokuapp.com/)<br/>然后我们使用钩子将查询传递给它(它可以接受更多的参数，稍后会更详细一点)，它返回一个加载布尔值、一个错误对象和一个数据对象。根据结果，我们可以在页面上打印不同的内容，例如，加载状态、结果或错误</p><p id="1748" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果一切正常，我们可以开始构建动态查询并格式化结果。</p><p id="c80a" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们修改查询以获得几个参数<code class="fe ma mb mc md b">location</code>和<code class="fe ma mb mc md b">unit</code>并返回相关数据:</p><figure class="mq mr ms mt gt jr"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="c408" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们将发送给查询的参数和结果存储在状态中:</p><figure class="mq mr ms mt gt jr"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="5650" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在我们可以执行传递参数的查询，这一次我们向<em class="nc"> useQuery </em>添加了一个<em class="nc"> refetch </em>属性，因为我们希望在参数改变时重新提取数据(否则Apollo将缓存结果)。</p><figure class="mq mr ms mt gt jr"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="f94e" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">正如您所看到的，useQuery钩子像以前一样有查询引用(W_Q)和一个配置对象。在这个对象中，我们指定了变量数据(来自我们的状态组件)、用于在refect时更新组件的<em class="nc">notifyOnNetworkStatusChange</em>参数，以及一个<em class="nc"> onCompleted </em>方法，该方法将在数据加载后执行回调；在这种情况下，设置天气状态和日期状态(将时间戳转换为可读日期)。</p><p id="1458" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">现在，我们在state组件中几乎拥有了一切，所以剩下的就是将数据放入我们的接口，并处理城市和单位的更新，以触发<em class="nc"> refetch(): </em></p><figure class="mq mr ms mt gt jr"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="7b60" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们定义了几个函数(稍后将绑定到select)来更新两个状态，这些更新将触发useEffect中的refetch()。</p><p id="14e0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">对于渲染部分，这只是一个基本的页面，可能没有优化，有很多重复，一些基本的检查。</p><p id="12b9" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">页面根据<em class="nc">位置</em>状态显示天气，一旦选择的位置发生变化，位置状态就会更新并触发重新提取(位置是一个useEffect依赖项)，重新提取后页面会重新呈现。</p><figure class="mq mr ms mt gt jr"><div class="bz fp l di"><div class="nd ne l"/></div></figure><h2 id="a02c" class="me ky iq bd kz mf mg dn ld mh mi dp lh kj mj mk ll kn ml mm lp kr mn mo lt mp bi translated">后续步骤</h2><p id="034e" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">至此，您已经有了一个关于如何使用Apollo在静态项目中检索和使用动态数据的完整示例；将您的“客户机”连接到GraphQL数据源，您就可以开始工作了。</p><p id="25ba" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">当然，这是一个基本的例子，但是GraphQL也可以用useMutation钩子‘写’到一个源；Apollo客户端也可以比我们在这里创建的更复杂，允许处理会话、身份验证令牌等等。<br/>一个经典的例子是使用JWT的认证:你使用登录突变进行认证，GraphQL将向你发回一个令牌，你获取该令牌并将其存储在某个地方(例如LocalStorage)，在将来的请求中，你可以将该令牌(如果存在的话)包含在客户端报头中，这样GraphQL服务器就知道该请求来自一个授权用户。例如，用户可以通过认证访问他们的愿望清单或订单历史，他们的<em class="nc">待办事项</em>，等等。</p><h2 id="c71d" class="me ky iq bd kz mf mg dn ld mh mi dp lh kj mj mk ll kn ml mm lp kr mn mo lt mp bi translated">免费公共图表</h2><p id="78fe" class="pw-post-body-paragraph jy jz iq ka b kb lv kd ke kf lw kh ki kj lx kl km kn ly kp kq kr lz kt ku kv ij bi translated">有很多免费的GraphQL API可以连接到Apollo上玩，例如<a class="ae kw" href="https://graphql.org/swapi-graphql" rel="noopener ugc nofollow" target="_blank">星球大战API </a>或<a class="ae kw" href="https://developer.github.com/v4/explorer/" rel="noopener ugc nofollow" target="_blank"> GitHub API </a>，如果你在<a class="ae kw" href="https://docs.datastax.com/en/astra/docs/using-the-astra-graphql-api.html" rel="noopener ugc nofollow" target="_blank"> Datastax上有一个无服务器数据库，也可以通过GraphQL </a>访问。此外，Apollo提供了一个工具来<a class="ae kw" href="https://www.apollographql.com/docs/intro/platform/#1-build-your-graph-with-apollo-server" rel="noopener ugc nofollow" target="_blank">创建GraphQL模式，并用您数据源</a>填充它。</p><p id="ebda" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated"><em class="nc">更多内容请看</em><a class="ae kw" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><strong class="ka ir"><em class="nc">plain English . io</em></strong></a></p></div></div>    
</body>
</html>