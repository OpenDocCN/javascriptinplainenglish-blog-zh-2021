# 重写 Deno 的测试工具

> 原文：<https://javascript.plainenglish.io/rewriting-denos-testing-tools-b5f8801bc567?source=collection_archive---------10----------------------->

![](img/a0c503d685c39adbc3f43889fc243b74.png)

对于过去的一个月和一些变化，实际上可能已经两个月了(写一个概念证明需要一天，实现它需要几周)。我一直在忙着重新思考 Deno 的测试工具。

在我参与之前，我们已经有了一个试跑者，它运行得很好。但这是你能做的最简单的了，所以我全部重写了。

# 新的平行赛跑运动员

我们的测试运行程序是用 JavaScript 编写的，它可以工作，但速度很慢，因为它是一个串行测试运行程序，只是将所有测试合并到一个上下文中，然后一个接一个地运行它们。

也就是说，如果一个测试设置了 60 秒的超时，或者更现实地说，等待服务器响应，那么在测试完成之前什么都不会发生。

为了解决这个问题，我在 Rust 中重新编写了测试运行程序，这样我就可以明确地控制线程模型。

每个测试模块现在都在自己的线程上运行，有自己的调度程序和运行时。

然而，整个模块图的编译和类型检查是提前完成的，这使得它仍然很快。

```
**deno** **test** --jobs=4
```

对于整个测试套件，我们的 std 测试套件的测试时间减少了一半，从大约 1 分钟减少到 30 秒。

[这已经登陆](https://github.com/denoland/deno/pull/9815)并将在 Deno 版本 1.10 中发布。

# 每个测试用例权限

在内部，我们实际上并没有使用`deno test`进行我们自己的单元测试。到目前为止，我用每个测试用例的权限扩展了测试运行程序，让我们吃狗粮，并完全放弃了特别的测试运行程序。

因此，您的单元测试现在可以用它们所需的权限来定义，并且它们将被相应地请求/撤销。

```
Deno.test({
  name: "write",
  permissions: {
    write: true,
  },
  async fn() {
    // ...
  },
});
```

但是请注意，如果您在没有权限的情况下运行`deno test`,任何获取比您开始时更多权限的请求都将被拒绝。

[这已经登陆](https://github.com/denoland/deno/pull/10188)并将在 Deno 版本 1.10 中发布。

# 提高漂亮的输出

这仍然是一项正在进行的工作，但输出格式得到了一些人的喜爱。首先，在重写 Rust 中的 reporter 时，我添加了测试的起源。

之前:

```
running 2 tests 
```

之后:

```
running 2 tests from file:///home/caspervonb/test.ts
```

这是一件小事，但很多事情必须到位，因为我们无法在 JavaScript 中做到这一点而不违反一些沙盒规则，所以这个微小的变化已经等待了几个月。

这已经登陆，并将在 Deno 版本 1.10 中发布。

# 可测试的文档代码块

我觉得这是高光比较酷的特点。至少我发现它对我们的代码库有用。事实证明，我们的很多例子都有一个偷偷摸摸的打字错误，因此虽然实际例子本身是正确的，但还是被破坏了。

那么，如果您的代码示例可以进行类型检查并运行呢？嗯，有了德诺可以。

我已经实现了这一点，但我不认为我会在 1.10 中发布它，因为我想在让它在野外出现之前对它进行更多的润色。

我也对客户端代码做了一些改动，但我主要是在 Deno 上工作，所以我们会看到会发生什么。

## 结论

我得回去写代码了，所以这是 Deno 1.10 的小功能预览的结束。

想帮我实现 GitHub 赞助商的下一个目标吗？这里有一个链接。

[![](img/74b8888ae16515de0872267fa2e732fb.png)](https://github.com/sponsors/caspervonb)

*更多内容尽在*[***plain English . io***](http://plainenglish.io)