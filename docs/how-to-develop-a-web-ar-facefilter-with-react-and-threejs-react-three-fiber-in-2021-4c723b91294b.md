# 2021 å¹´å¦‚ä½•ç”¨ React å’Œ ThreeJS / React ä¸‰çº¤å¼€å‘ Web AR Facefilter

> åŸæ–‡ï¼š<https://javascript.plainenglish.io/how-to-develop-a-web-ar-facefilter-with-react-and-threejs-react-three-fiber-in-2021-4c723b91294b?source=collection_archive---------9----------------------->

ä¸ºäº†ğŸ§™çš„ä¸‰å‘¨å¹´çºªå¿µğŸ¼â€â™‚ï¸30 çº§å·«å¸ˆæˆ‘ä»¬å¸Œæœ›å»ºç«‹ä¸€äº›ä¸æˆ‘ä»¬çš„å·¥ä½œã€å“ç‰Œå’Œå…´è¶£ç›¸å…³çš„ä¸œè¥¿ã€‚æˆ‘ä»¬æœ€ç»ˆä¸º Web AR æˆ– Web XR åˆ›å»ºäº†ä¸€ä¸ªç±»ä¼¼ facefilter çš„ Snapchatã€‚

ä½ å¯ä»¥åœ¨è¿™é‡Œè¯•ç”¨æœ€ç»ˆäº§å“: [Facefilter æ¼”ç¤º](https://level30wizards.com/experiments/facefilter/)

# æ— è€»çš„æ’å¤´

> *å˜¿ï¼Œä½ æ­£åœ¨ä¸ºä¸€ä¸ªå®¢æˆ·æˆ–é¡¹ç›®å»ºç«‹ä¸€ä¸ª Facefilter å—ï¼Ÿæˆ‘ä»¬å¾ˆä¹æ„å¸®å¿™ã€‚*

[å‘é€é‚®ä»¶ï¼](mailto:merlin@level30wizards.com)

# ä»‹ç»

ç§»åŠ¨ç½‘ç»œæµè§ˆå‘å±•è¿…é€Ÿã€‚æˆ‘ä»¬èƒ½å¤Ÿä» NFC è¯»å¡å™¨ã€å­˜å‚¨å™¨å’Œæ‘„åƒå¤´è·å–æ•°æ®ã€‚é—æ†¾çš„æ˜¯ï¼Œæˆªè‡³ç›®å‰ï¼Œæˆ‘ä»¬ä¸å…è®¸åœ¨ iPhones æˆ– iPads ä¸Šä½¿ç”¨ ARKitã€‚

æœ‰å¾ˆå¤šå¾ˆæ£’çš„å›¾ä¹¦é¦†ï¼Œæ¯”å¦‚ç¬¬å…«å¢™æˆ– Zapparï¼Œä½†å®ƒä»¬é€šå¸¸ä»·æ ¼ä¸è²ã€‚å¹¸è¿çš„æ˜¯ï¼Œè®¸å¤šèªæ˜äººå»ºç«‹äº†èƒ½å¤Ÿä» 2D å±å¹•ä¸Šè¯†åˆ«äººè„¸çš„ç¥ç»ç½‘ç»œã€‚

WebAR å…è®¸æ‚¨åˆ©ç”¨è®¡ç®—æœºæˆ–æ•°æ®å¯è§†åŒ–ï¼Œé™¤äº†é»˜è®¤çš„ web æµè§ˆå™¨ä¹‹å¤–ï¼Œæ— éœ€ä¸‹è½½åº”ç”¨ç¨‹åºã€‚Web AR å¯ä»¥ä½¿ç”¨ SLAM(åŒæ­¥å®šä½å’Œç»˜å›¾)å’Œå›¾åƒè¯†åˆ«æŠ€æœ¯æ¥æ•°å­—åŒ–åœ°å¯è§†åŒ–æ‚¨çš„å†…å®¹ã€‚ç”±äºå®ƒä»ç„¶æ˜¯ä¸€ä¸ªç½‘é¡µï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ AR ä½“éªŒä¸­æ·»åŠ å„ç§ web ç‰¹æ€§å’ŒåŠŸèƒ½ã€‚è¿™åœ¨ç½‘ç»œä¸Šæ‰“å¼€äº†å¤§é‡çš„æœºä¼šã€‚

å¢å¼ºç°å®å°†æ˜¯å¯¹è®¸å¤šç°æœ‰ç½‘é¡µçš„æœ‰ä»·å€¼çš„è¡¥å……ã€‚ä¾‹å¦‚ï¼Œå®ƒå¯ä»¥å¸®åŠ©äººä»¬åœ¨æ•™è‚²ç½‘ç«™ä¸Šå­¦ä¹ ï¼Œæˆ–è€…å…è®¸æ½œåœ¨ä¹°å®¶åœ¨è´­ç‰©æ—¶å¯è§†åŒ–å®¶ä¸­çš„ç‰©å“ã€‚

# ç›®æ ‡

ç›®æ ‡æ˜¯åœ¨æˆ‘ä»¬çš„è„¸ä¸ŠæŠ•å°„ä¸€ä¸ª 3D æ¨¡å‹ã€‚

![](img/e2f9a200f78867725e4fea80072141e3.png)

# å·¥å…·

*   [GSAP](https://greensock.com/?ref=68708)
*   [Three.js](https://threejs.org/)
*   [ååº”ä¸‰çº¤ç»´](https://docs.pmnd.rs/react-three-fiber/getting-started/introduction)
*   [å‰è‰å…¹](https://jeeliz.com/)

# åŸå‹å…è´£å£°æ˜

æˆ‘ä»¬åšçš„è¿™ä¸ªå®éªŒæ˜¯ä¸€ä¸ªå®Œæ•´çš„åŸå‹ã€‚æˆ‘ä»¬ä¸å»ºè®®æ‚¨åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨å®ƒã€‚è¿™ä¸ªä¾‹å­éœ€è¦å¤§é‡çš„è°ƒæ•´æ‰èƒ½åœ¨ç”Ÿäº§ä¸­ä½¿ç”¨ã€‚

# ä»£ç :ç®€ä»‹

åœ¨æˆ‘ä»¬å±•ç¤ºç›¸æœºä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦ä¸€äº›æ—¶é—´æ¥åŠ è½½ 3D æ¨¡å‹å¹¶è®¡ç®—ä¸€äº›ä½ç½®ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬é€‰æ‹©äº†ä¸€ä¸ªä»‹ç»å±å¹•æ¥å¢åŠ ä¸€äº›æ‚¬å¿µã€‚

> *æ¼‚äº®çš„æ³¢æµªæ–‡å­—æ¥è‡ªä»¥å‰çš„æ•™ç¨‹ï¼* [*æ³¢æµªå½¢æ–‡æœ¬åŠ¨ç”»ä½¿ç”¨ React é’©å­ä¸ GSAP v3*](https://webanimation.blog/blog/wavy-text-animation-using-react-hooks-with-gsap-v3/)

```
import gsap from 'gsap';
import React, { useEffect } from 'react';export const Intro = () => {
  useEffect(() => {
    gsap.set('.wavy', { perspective: 400 });const sequence = (id, reverse) => {
      const tl = gsap.timeline({ delay: 0.5 });tl.from(`.wavy[data-id="${id}"]`, {
        duration: 0.5,
        autoAlpha: 0,
        ease: 'back',
        stagger: 1,
      })
        .from(`.wavy[data-id="${id}"] [data-letter]`, {
          duration: 0.5,
          autoAlpha: 0,
          scale: 1,
          y: -30,
          rotationX: -90,
          transformOrigin: '0% 50% -50',
          ease: 'back',
          stagger: 0.025,
        })
        .to(`.wavy[data-id="${id}"] [data-letter]`, {
          duration: 0.5,
          delay: 1.25,
          autoAlpha: 0,
          scale: 1,
          y: -30,
          rotationX: -90,
          transformOrigin: '0% 50% -50',
          ease: 'back',
          stagger: 0.025,
        })
        .to(`.wavy[data-id="${id}"]`, {
          duration: 0.25,
          autoAlpha: 0,
          ease: 'back',
          stagger: 1,
        });return tl;
    };const tl = gsap.timeline();tl.add(sequence('one'))
      .add(sequence('two'))
      .add(sequence('three'))
      .to('.intro', {
        duration: 1,
        autoAlpha: 0,
      });tl.timeScale(1.2);tl.play();
    return () => {
      tl.kill();
    };
  }, []);return (
    <div className="intro">
      <AnimatedText id="one" text={'Level30Wizards Presents...'} />
      <AnimatedText id="two" text={'Are you a true wizard?'} />
      <AnimatedText id="three" text={"Let's find out!"} />
      <img
        src="[https://level30wizards.com/images/branded/brand-image-6.png](https://level30wizards.com/images/branded/brand-image-6.png)"
        alt="Dragon"
        className="dragon"
      />
      <a href="[https://level30wizards.com](https://level30wizards.com)" aria-label="level30wizards">
        <img
          src="[https://level30wizards.com/images/svg/logo.svg](https://level30wizards.com/images/svg/logo.svg)"
          alt="Level30Wizards"
          className="logo"
        />
      </a>
    </div>
  );
};
```

# å·«å¸ˆå¸½

ä¸ºäº†åŠ è½½ 3D æ¨¡å‹ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† [GLTFJSX](https://www.npmjs.com/package/gltfjsx) ã€‚

```
npx gltfjsx model.gltf -t
```

è¿™å¯¼è‡´äº†ä»¥ä¸‹ç»“æœ:

```
// [@ts](http://twitter.com/ts)-nocheck
/*
Auto-generated by: [https://github.com/pmndrs/gltfjsx](https://github.com/pmndrs/gltfjsx)
author: Paulina ([https://sketchfab.com/Byakko](https://sketchfab.com/Byakko))
license: CC-BY-NC-4.0 ([http://creativecommons.org/licenses/by-nc/4.0/](http://creativecommons.org/licenses/by-nc/4.0/))
source: [https://sketchfab.com/3d-models/wizards-hat-68a9fb2dbd8442a5bacf9c0141320308](https://sketchfab.com/3d-models/wizards-hat-68a9fb2dbd8442a5bacf9c0141320308)
title: Wizard's hat
*/import { useGLTF } from '[@react](http://twitter.com/react)-three/drei';
import React, { useRef } from 'react';export default function Model(props) {
  const group = useRef();
  const { nodes, materials } = useGLTF('/models/wizards_hat/scene.gltf');
  return (
    <group ref={group} {...props} dispose={null}>
      <group rotation={[-Math.PI / 2, 0, 0]}>
        <group rotation={[Math.PI / 2, 0, 0]}>
          <mesh
            geometry={nodes.defaultMaterial.geometry}
            material={nodes.defaultMaterial.material}
          />
          <mesh
            geometry={nodes.defaultMaterial_1.geometry}
            material={nodes.defaultMaterial_1.material}
          />
          <mesh
            geometry={nodes.defaultMaterial_2.geometry}
            material={nodes.defaultMaterial_2.material}
          />
          <mesh
            geometry={nodes.defaultMaterial_3.geometry}
            material={nodes.defaultMaterial_3.material}
          />
          <mesh
            geometry={nodes.defaultMaterial_4.geometry}
            material={nodes.defaultMaterial_4.material}
          />
          <mesh
            geometry={nodes.defaultMaterial_5.geometry}
            material={nodes.defaultMaterial_5.material}
          />
        </group>
      </group>
    </group>
  );
}useGLTF.preload('/models/wizards_hat/scene.gltf');
```

# Web AR åº“

æˆ‘ä»¬ä½¿ç”¨äº† [Jeeliz R3F æ¼”ç¤º](https://github.com/jeeliz/jeelizFaceFilter/tree/master/reactThreeFiberDemo)ï¼Œå¹¶å°†å…¶ä¸æ¥è‡ªä»–ä»¬ [Matrix æ¼”ç¤º](https://github.com/jeeliz/jeelizFaceFilter/tree/master/demos/threejs/matrix)çš„ä¸€äº›é€»è¾‘ç›¸ç»“åˆã€‚å¦‚æœä½ æƒ³ï¼Œæ¯«æ— ç¾è€»åœ°å¤åˆ¶ç²˜è´´è¿™ç¯‡åšå®¢æ¥åˆ›é€ ä¸€ä¸ªå·¥ä½œäº§å“â€¦ä½ è¿æ°”ä¸å¥½ã€‚å‚è€ƒæ¼”ç¤ºå¹¶è‡ªå·±åŠ¨æ‰‹ä¿®æ”¹ï¼Œä½ å¯èƒ½ä¼šå­¦åˆ°æ›´å¤šã€‚

å®Œæˆå¤§éƒ¨åˆ†å·¥ä½œçš„ç»“æœä»£ç çœ‹èµ·æ¥æœ‰ç‚¹åƒè¿™æ ·:

```
const FaceFollower = props => {
  const objRef = useRef();
  useEffect(() => {
    const threeObject3D = objRef.current;
    _faceFollowers[props.faceIndex] = threeObject3D;
  });return (
    <object3D ref={objRef}>
      <Suspense fallback={null}>
        <WizardsHat
          rotation={[0, -Math.PI, 0]}
          position={[0, 1.825, 0]}
          scale={[1.5, 1.5, 1.5]}
          renderOrder={2}
        />
        <Head position={[0, -0.1435, 0]} scale={[1.125, 1, 1.125]} />
      </Suspense>
    </object3D>
  );
};
```

æˆ‘ä»¬ä½¿ç”¨äº†ä¸€ä¸ªäººç±»å¤´éƒ¨çš„æ¨¡å‹ï¼Œå¹¶ä½¿ç”¨äº†ä¸€ä¸ªå¸¦æœ‰`colorWrite`å’Œ`renderOrder`çš„æŠ€å·§ã€‚æˆ‘ä»¬åˆšç”¨äº†ä¸€äº› SketchFab çš„äººå¤´ï¼Œä½èšçš„ä¹Ÿå¯ä»¥ã€‚

```
const hiderMat = new THREE.MeshPhongMaterial({
  attach: 'material',
  color: 'hotpink',
  colorWrite: false,
  renderOrder: 1,
});
```

å¦‚æœæˆ‘ä»¬ä¸è¿™æ ·åšï¼Œå½“ä½ å¤§ç¬‘æ—¶ï¼Œå¸½å­ä¼šå¤¹ä½ä½ çš„è„¸ï¼Œå› ä¸º web ar ä½“éªŒå¤ªæ£’äº†ã€‚

# å¿«ç…§ï¼

å¦‚æœä½ åœ¨åšå’Œå¹³æ‰‹åŠ¿å’Œåƒé¸­å­ä¸€æ ·èˆ”å˜´å”‡çš„æ—¶å€™ä¸èƒ½æ‹ç…§ï¼Œé‚£å°±ä¸æ˜¯é¢éƒ¨è¿‡æ»¤å™¨äº†ã€‚

å¯¹äºæˆ‘ä»¬çš„ä¸‹ä¸€ä¸ªæŠ€å·§ï¼Œæˆ‘ä½¿ç”¨äº† 3 ä¸ªç”»å¸ƒå…ƒç´ ã€‚æ˜¯çš„ï¼Œæˆ‘ä»¬çŸ¥é“ã€‚

æˆ‘ä»¬å°†ç›¸æœºç”»å¸ƒã€åŒ…å«â€œå¸½å­â€å’Œâ€œå¤´â€çš„ç”»å¸ƒä»¥åŠæˆ‘ä»¬æŠ•å½±å¾½æ ‡çš„ç”»å¸ƒç»“åˆåœ¨ä¸€èµ·ã€‚

```
const faceFilterCanvasRef = useRef(null);
const canvasRef = useRef(null);
const pictureCanvasRef = useRef(null);
const logoCanvasRef = useRef(null);const snapshot = useCallback(() => {
  const canvas = pictureCanvasRef.current;
  canvas.getContext('2d').drawImage(faceFilterCanvasRef.current, 0, 0);const img = new Image();
  img.src = '/images/logo.png';img.addEventListener('error', e => {
    console.error(e);
  });
  img.addEventListener('load', e => {
    logoCanvasRef.current
      .getContext('2d')
      .drawImage(
        img,
        sizing.width - (144 + 24),
        sizing.height - (42.38 + 24),
        144,
        42.38
      );mergeImages([
      canvas.toDataURL('image/png'),
      canvasRef.current.toDataURL('image/png'),
      logoCanvasRef.current.toDataURL('image/png'),
    ]).then(b64 => {
      setDownloadUrl(b64);
      setShareData(b64);
    });
  });
}, []);
```

# æ˜¾ç¤ºæœ€ç»ˆå›¾åƒ

ä¸ºäº†ä¸‹è½½å’Œåˆ†äº«ä½ çš„ç…§ç‰‡ï¼Œæˆ‘ä»¬å°è¯•å®ç°æœ¬åœ°å…±äº« APIã€‚ä½†æ˜¯ï¼Œè¯¥ API è¦æ±‚æˆ‘ä»¬ä¿å­˜å›¾åƒï¼Œæˆ‘ä»¬ä¸å–œæ¬¢è¿™æ ·ï¼Œå› ä¸ºè¿™æ˜¯ä¸€ä¸ªéšç§é—®é¢˜ã€‚è¯·è€ƒè™‘åˆ°è¿™ä¸€ç‚¹ï¼Œå¦‚æœä½ è‡ªå·±å»ºç«‹è¿™ä¸ªã€‚ä½¿ç”¨ä»¤ç‰Œæˆ–æŸç§æ–¹å¼æ¥éªŒè¯æŸ¥çœ‹å›¾åƒçš„ç”¨æˆ·æ˜¯æ¥è‡ªå…±äº«é“¾æ¥è¿˜æ˜¯å½“å‰ç”¨æˆ·ã€‚

```
<div
  style={{
    display: shareData ? 'block' : 'none',
    position: 'fixed',
    zIndex: 3,
    borderRadius: '50%',
    overflow: 'hidden',
  }}
>
  <img
    style={{
      position: 'fixed',
      zIndex: 4,
      width: 'auto',
      height: '100%',
      top: '50%',
      left: '50%',
      transform: 'translate(-50%,-50%)',
    }}
    src={shareData}
    alt="generated"
  />
</div>
```

å°±è¿™äº›äº†ï¼Œè°¢è°¢ã€‚

![](img/51f0d88fea5463f39712c4264f019776.png)

## PSã€‚

[æŸ¥çœ‹å®é™…ä¾‹å­ï¼æˆ‘ä»¬æ­£åœ¨ğŸ§™ç ”ç©¶ä¸€äº›ç¥å¥‡çš„ä¸œè¥¿ğŸ¼â€â™‚ï¸30 çº§å·«å¸ˆ](https://level30wizards.com/experiments/facefilter)ï¼Œä¸€å®šè¦å…³æ³¨æˆ‘ä»¬çš„ç¤¾äº¤æ´»åŠ¨ï¼Œç•™æ„æ–°ç‰ˆæœ¬ã€‚

## æ„Ÿè°¢é˜…è¯»ï¼

æˆ‘ä»¬å¸Œæœ›æ‚¨ä»è¿™ç¯‡æ–‡ç« ä¸­å­¦åˆ°äº†ä¸€äº›å…³äº web æµè§ˆå™¨ä¸­å¢å¼ºç°å®çš„çŸ¥è¯†ã€‚å¦‚æœä½ ä½¿ç”¨è¿™é¡¹æŠ€æœ¯ï¼Œè¯·è´Ÿè´£ä»»åœ°è¿™æ ·åšã€‚

*åŸè½½äº*[*https://web animation . blog*](https://webanimation.blog/blog/how-to-develop-web-ar-facefilter-react-threejs/)*ã€‚*