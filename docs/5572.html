<html>
<head>
<title>4 Steps to Create Google Authentication API in Node.js</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Node.js中创建Google认证API的4个步骤</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/4-steps-to-create-google-authentication-api-in-node-js-e4bab8f744bc?source=collection_archive---------7-----------------------#2021-11-19">https://javascript.plainenglish.io/4-steps-to-create-google-authentication-api-in-node-js-e4bab8f744bc?source=collection_archive---------7-----------------------#2021-11-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="6281" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用Passport.js + JWT &amp;快递</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/a4fe847af555e862916d76ab70f44b3e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uOD4V57U2q9J4xQc_WZHGQ.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk"><a class="ae lb" href="http://www.passportjs.org/" rel="noopener ugc nofollow" target="_blank">Screenshot of Passport.js website</a></figcaption></figure><h2 id="b7ee" class="lc ld iq bd le lf lg dn lh li lj dp lk jy ll lm ln kc lo lp lq kg lr ls lt lu bi translated">在后台</h2><p id="8a61" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">故事开始于我的朋友问我关于将Passport.js和JSON Web Token (JWT)集成在一起的问题。他想创建一个API或端点，通过Express和JWT使用Passport.js提供Google身份验证。所以我想为什么不写一个故事来帮助市场上的许多开发人员，这样你就真的不必阅读StackOverflow或文档了？</p></div><div class="ab cl ma mb hu mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="ij ik il im in"><h2 id="fcb4" class="lc ld iq bd le lf lg dn lh li lj dp lk jy ll lm ln kc lo lp lq kg lr ls lt lu bi translated">入门指南</h2><p id="42a6" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">在我们开始之前，请记住，谷歌认证或脸书或Github需要一个客户端ID和客户端密码，您可以从他们相应的开发人员控制台或仪表板上获取。但总的来说，所有第三方OAuth都基于相同的客户端id和客户端机密原则工作。只需4个步骤，我们将使用Passport.js和JWT创建一个Google认证API。</p></div><div class="ab cl ma mb hu mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="ij ik il im in"><h2 id="88ef" class="lc ld iq bd le lf lg dn lh li lj dp lk jy ll lm ln kc lo lp lq kg lr ls lt lu bi translated">总流量</h2><p id="aceb" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">这将是整个流程—</p><ul class=""><li id="a0c2" class="mh mi iq jp b jq jr ju jv jy mj kc mk kg ml kk mm mn mo mp bi translated">通过向策略实例添加配置来初始化passport。</li><li id="e6c3" class="mh mi iq jp b jq mq ju mr jy ms kc mt kg mu kk mm mn mo mp bi translated">创建一条路线<code class="fe mv mw mx my b">/v1/auth/google</code>，该路线将开始谷歌认证并为用户打开谷歌电子邮件选择模式。(基本上重定向到谷歌登录页面)</li><li id="c6ad" class="mh mi iq jp b jq mq ju mr jy ms kc mt kg mu kk mm mn mo mp bi translated">添加passport google authentication作为用于<code class="fe mv mw mx my b">/v1/auth/google</code>路线的中间件，作为中间件，我们将调用passport authentication方法，并向中间件函数提供我们的客户端id和秘密。</li><li id="e64b" class="mh mi iq jp b jq mq ju mr jy ms kc mt kg mu kk mm mn mo mp bi translated">一旦passport <code class="fe mv mw mx my b">_verify</code>回调被成功调用，它将返回包含用户电子邮件和用户名的配置文件。使用从passport中间件返回的用户配置文件详细信息，创建一个JWT令牌，如果需要的话，用一个令牌将用户详细信息存储在数据库中。</li><li id="215f" class="mh mi iq jp b jq mq ju mr jy ms kc mt kg mu kk mm mn mo mp bi translated">最后，在定制服务器中处理您在google开发人员控制台中提到的回调URL。作为响应，这个回调URL将处理重定向或将令牌传递给客户端。</li></ul></div><div class="ab cl ma mb hu mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="ij ik il im in"><h2 id="bc42" class="lc ld iq bd le lf lg dn lh li lj dp lk jy ll lm ln kc lo lp lq kg lr ls lt lu bi translated">正在初始化Passport.js</h2><p id="72ef" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">初始化非常简单，因为它只需要3/4步。</p><ul class=""><li id="c9b7" class="mh mi iq jp b jq jr ju jv jy mj kc mk kg ml kk mm mn mo mp bi translated">添加所需的Passport.js npm包，如<code class="fe mv mw mx my b">passport</code> &amp; <code class="fe mv mw mx my b">passport-google-oauth20</code></li><li id="6c2f" class="mh mi iq jp b jq mq ju mr jy ms kc mt kg mu kk mm mn mo mp bi translated">将auth策略和回调传递给passport use方法。</li><li id="0321" class="mh mi iq jp b jq mq ju mr jy ms kc mt kg mu kk mm mn mo mp bi translated">参数中添加的授权策略需要<code class="fe mv mw mx my b">clientId</code>、<code class="fe mv mw mx my b">clientSecret</code>、&amp;、<code class="fe mv mw mx my b">callbackURL</code></li><li id="2ca7" class="mh mi iq jp b jq mq ju mr jy ms kc mt kg mu kk mm mn mo mp bi translated">使用相应的方法序列化和反序列化passport发送的用户。</li><li id="6212" class="mh mi iq jp b jq mq ju mr jy ms kc mt kg mu kk mm mn mo mp bi translated">最后，添加这个确认的passport实例，并使用express中间件方法初始化它们。</li></ul><p id="0a6a" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在middleware/passport目录中添加以下代码。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mz na l"/></div><figcaption class="kx ky gj gh gi kz la bd b be z dk">Configuring passport by providing authentication strategy.</figcaption></figure><p id="ec43" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最后，通过添加以下代码，使用express中间件方法初始化导出的passport。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="07c6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">让我解释一下我们在这里做什么—</p><ul class=""><li id="abfd" class="mh mi iq jp b jq jr ju jv jy mj kc mk kg ml kk mm mn mo mp bi translated">我们基本上将认证策略传递给passport use方法，因为我们使用google认证，所以clientId、clientSecret和callbackURL是必需的。</li><li id="1df7" class="mh mi iq jp b jq mq ju mr jy ms kc mt kg mu kk mm mn mo mp bi translated">然后，我们刚刚定义了回调函数，当passport端的一切都成功时，将调用该函数。</li><li id="c07c" class="mh mi iq jp b jq mq ju mr jy ms kc mt kg mu kk mm mn mo mp bi translated">最后，我们刚刚添加了序列化和反序列化的方法</li><li id="82b9" class="mh mi iq jp b jq mq ju mr jy ms kc mt kg mu kk mm mn mo mp bi translated">然后在<code class="fe mv mw mx my b">server.js</code>文件中，我们使用express use方法初始化导出的passport方法。</li></ul><p id="9973" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">注意—请不要删除序列化和反序列化方法，因为我们需要它们来读取登录的用户数据。</p><h2 id="2dc2" class="lc ld iq bd le lf lg dn lh li lj dp lk jy ll lm ln kc lo lp lq kg lr ls lt lu bi translated">为Google登录创建路径</h2><p id="28bb" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">这是一个基本的获取途径，我们不需要从客户端发送任何东西。这条路线的议程是调用passport中间件。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mz na l"/></div><figcaption class="kx ky gj gh gi kz la bd b be z dk">Basic GET route to call passport middleware</figcaption></figure><p id="bbcf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们还提供了passport身份验证方法的范围和身份验证策略。</p></div><div class="ab cl ma mb hu mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="ij ik il im in"><h2 id="a8b7" class="lc ld iq bd le lf lg dn lh li lj dp lk jy ll lm ln kc lo lp lq kg lr ls lt lu bi translated">保存用户配置文件并创建JWT令牌</h2><p id="daea" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">故事的高潮来了，现在一旦passport中间件被调用，我们得到了用户配置文件的细节，我们只需处理JSON web token和我们的数据库系统。如何处理令牌完全取决于您的选择，有些开发人员喜欢将令牌存储在数据库中，有些则不喜欢。我个人总是在用户成功登录后发送cookie中的令牌。</p><p id="9ea8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在Passport.js中，当调用passport use方法的回调时，它将返回我们已经安慰过的用户配置文件。这是我们将创建JWT令牌的地方，如果需要，可以将用户详细信息存储在数据库中。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mz na l"/></div><figcaption class="kx ky gj gh gi kz la bd b be z dk">Creating JWT token and sending the required details to the request object in the callback URL.</figcaption></figure><pre class="km kn ko kp gt nb my nc nd aw ne bi"><span id="3131" class="lc ld iq my b gy nf ng l nh ni"><a class="ae lb" rel="noopener ugc nofollow" target="_blank" href="/most-secured-authentication-via-json-web-token-a45ae52a76df?source=your_stories_page----------------------------------------">If you are new to JWT then I recommend reading this story.</a></span></pre><h2 id="56ad" class="lc ld iq bd le lf lg dn lh li lj dp lk jy ll lm ln kc lo lp lq kg lr ls lt lu bi translated">处理回调URL</h2><p id="480b" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">最后一部分是处理回调重定向URL。如果您还记得，我们已经在google开发者控制台中添加了一个回调URL，但是这个回调URL在我们的定制服务器中并不存在。在目前的情况下，一旦创建了令牌，用户就登录了，用户将被重定向到重定向回调URL，现在作为开发人员，我们的工作是定义登录用户应该被抛出的实际方法或路由。</p><figure class="km kn ko kp gt kq"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="1c3f" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我将cookie中的令牌发送给用户，并在他/她成功登录后重定向他。只有当一切按计划进行并且用户使用google认证成功登录时，才会调用这个回调URL。</p><p id="33a5" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在客户端，从cookie中获取令牌，并使用另一个API进行验证，以确认令牌的真实性，并确认用户已成功登录。</p><p id="4da7" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">将令牌保存在cookies中有其自身的优点，它可以轻松处理跨多个标签和设备的用户会话。</p></div><div class="ab cl ma mb hu mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="ij ik il im in"><h2 id="f2fd" class="lc ld iq bd le lf lg dn lh li lj dp lk jy ll lm ln kc lo lp lq kg lr ls lt lu bi translated">结论</h2><p id="025b" class="pw-post-body-paragraph jn jo iq jp b jq lv js jt ju lw jw jx jy lx ka kb kc ly ke kf kg lz ki kj kk ij bi translated">我把这个故事分为4个步骤，但实际上，我花了一些时间来理解这个想法，特别是如果你是这个节点和护照世界的新手。这就是为什么我试图用4个步骤来完成整个故事，这样你就可以同时记住这4个步骤。下次再见，祝大家愉快。</p><pre class="km kn ko kp gt nb my nc nd aw ne bi"><span id="4f5c" class="lc ld iq my b gy nf ng l nh ni">For more such stories, visit our website - 💻<a class="ae lb" href="http://ihatereading.in" rel="noopener ugc nofollow" target="_blank">iHateReading</a></span></pre><p id="9ce4" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="nj">更多内容看</em> <a class="ae lb" href="http://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <em class="nj">说白了. io </em> </a> <em class="nj">。在这里注册我们的</em> <a class="ae lb" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <em class="nj">免费周报</em> </a> <em class="nj">。</em></p></div></div>    
</body>
</html>