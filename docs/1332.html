<html>
<head>
<title>How to Improve The Speed of Your Tests</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何提高测试的速度</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/how-to-improve-the-speed-of-your-tests-fa2deb021c32?source=collection_archive---------13-----------------------#2021-03-20">https://javascript.plainenglish.io/how-to-improve-the-speed-of-your-tests-fa2deb021c32?source=collection_archive---------13-----------------------#2021-03-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="66d7" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">衡量，然后行动</h2></div><p id="3c02" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">今天，我被提醒要先测量，而不是做假设。</p><p id="1324" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我想我应该写一篇文章浏览一下——这样至少会有一些有用的东西出来，如果它能帮助别人的话。</p><h2 id="31fd" class="lb lc iq bd ld le lf dn lg lh li dp lj ko lk ll lm ks ln lo lp kw lq lr ls lt bi translated">背景</h2><p id="7db9" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">在过去的几天里，我一直在努力提高测试运行速度。一开始还不错，但是我添加的测试越多，运行时间就越长。当在某些部分每个测试花费了<strong class="kh ir">600-1300毫秒</strong>的时候，我已经厌倦了去做一些事情。</p><figure class="lz ma mb mc gt md gh gi paragraph-image"><div class="ab gu cl me"><img src="../Images/51b7097faef0f8f5f4f094a7684dfd89.png" data-original-src="https://miro.medium.com/v2/format:webp/1*C5XqDbdR1H_qoLI_MOcY4g.png"/></div></figure><h2 id="bc64" class="lb lc iq bd ld le lf dn lg lh li dp lj ko lk ll lm ks ln lo lp kw lq lr ls lt bi translated">出发点</h2><p id="8eb1" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">我怀疑这可能是一个数据库问题，但是我想我最好先尝试一些基本的节点概要分析，看看是否有确凿的证据能有所帮助。</p><p id="58cc" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">该页面上的说明说<code class="fe mi mj mk ml b">--prof</code>将启用节点概要分析。我想从运行Mocha中获得概要结果，而不是“仅仅”Node。将标志添加为<code class="fe mi mj mk ml b">--v8-prof</code>意味着Mocha会将标志传递给Node:</p><pre class="lz ma mb mc gt mm ml mn mo aw mp bi"><span id="7b66" class="lb lc iq ml b gy mq mr l ms mt">$ NODE_ENV=test mocha --v8-prof --require test/fixtures.js<br/>$ node --prof-process isolate-0x102d57000-8614-v8.log &gt; processed.txt</span></pre><p id="013c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">不幸的是，这里没有显示任何明显的东西，但是C++入口点确实巩固了数据库理论。</p><pre class="lz ma mb mc gt mm ml mn mo aw mp bi"><span id="3298" class="lb lc iq ml b gy mq mr l ms mt">[C++ entry points]:<br/>   ticks    cpp   total   name<br/>   3497   72.1%   58.8%  T __ZN2v88internal21Builtin_HandleApiCallEiPmPNS0_7IsolateE<br/>   1290   26.6%   21.7%  T</span></pre><p id="b98d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe mi mj mk ml b">HandleApiCall</code>的72%<strong class="kh ir">——我们进行的唯一API调用是对数据库的调用，所以这看起来是一个很好的起点。</strong></p><h2 id="548f" class="lb lc iq bd ld le lf dn lg lh li dp lj ko lk ll lm ks ln lo lp kw lq lr ls lt bi translated">徒劳的搜索</h2><p id="bede" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">不幸的是，这就是我搞砸的地方。我忘记了试图找出问题到底是什么，只是开始尝试修复东西。</p><ul class=""><li id="3c73" class="mu mv iq kh b ki kj kl km ko mw ks mx kw my la mz na nb nc bi translated">我浪费时间测试从<a class="ae mh" href="https://www.npmjs.com/package/knex-cleaner" rel="noopener ugc nofollow" target="_blank"> knex-cleaner </a>到使用<code class="fe mi mj mk ml b">knex("table").del()</code>单独删除对象的变化。</li><li id="8c12" class="mu mv iq kh b ki nd kl ne ko nf ks ng kw nh la mz na nb nc bi translated">很多测试都是重新播种，我浪费时间试图加速种子中的表截断。</li><li id="afd2" class="mu mv iq kh b ki nd kl ne ko nf ks ng kw nh la mz na nb nc bi translated">我尝试从PostgreSQL转换到SQLite进行测试</li><li id="6d62" class="mu mv iq kh b ki nd kl ne ko nf ks ng kw nh la mz na nb nc bi translated">我甚至开始考虑重写种子文件</li></ul><h2 id="4ec3" class="lb lc iq bd ld le lf dn lg lh li dp lj ko lk ll lm ks ln lo lp kw lq lr ls lt bi translated">停止追逐鹅</h2><p id="339e" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">最后，我记得测量一下，看看问题到底出在哪里。假设不是测试，我们这里有两个阶段，<code class="fe mi mj mk ml b">clean</code>和<code class="fe mi mj mk ml b">seed</code>。让我们试着确定哪一个是问题。</p><pre class="lz ma mb mc gt mm ml mn mo aw mp bi"><span id="2d82" class="lb lc iq ml b gy mq mr l ms mt">exports.dbCleanAndSeed = async function () {<br/>  let cleanFinishedMs, seedFinishedMs, startMs;<br/>  const options = { ignoreTables: ["knex_migrations", "knex_migrations_lock"] };<br/>  startMs = Date.now()<br/>  await knexCleaner.clean(database, options);<br/>  cleanFinishedMs = Date.now();<br/>  await database.seed.run();<br/>  seedFinishedMs = Date.now();<br/>  console.log("Clean took: %i; seed took %i", cleanFinishedMs - startMs, seedFinishedMs - cleanFinishedMs);<br/>}</span></pre><p id="c4d2" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它成功了，告诉我应该往哪里看:</p><pre class="lz ma mb mc gt mm ml mn mo aw mp bi"><span id="91a1" class="lb lc iq ml b gy mq mr l ms mt">site tests<br/>Clean took: 28; seed took 675<br/>    ✓ can get the sites page (732ms)<br/>Clean took: 28; seed took 743<br/>    ✓ get the 'add a new site page' (776ms)<br/>Clean took: 29; seed took 592<br/>    ✓ add a new site (630ms)<br/>Clean took: 26; seed took 594<br/>    ✓ add a site and see it on the sites page (628ms)<br/>Clean took: 29; seed took 748<br/>    ✓ can't add a new site with no creds (779ms)<br/>Clean took: 27; seed took 652<br/>    ✓ gets 404 for a site that doesn't exist (684ms)<br/>Clean took: 30; seed took 732<br/>    ✓ can't add a new site with no domain (769ms)<br/>Clean took: 26; seed took 609<br/>    ✓ can't add a new site with no active value (640ms)</span></pre><p id="eb42" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">好吧。所以，清洁——绝对不是问题！</p><p id="f528" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">虽然我有五个种子文件；想知道是否有特定的文件是问题所在？我们确实有<a class="ae mh" href="https://knexjs.org" rel="noopener ugc nofollow" target="_blank"> knex </a>的源代码，所以让我们找到种子加载位，看看它是否容易检测。</p><p id="fe74" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">看起来<code class="fe mi mj mk ml b">knex/lib/seed/Seeder.js</code>中的<code class="fe mi mj mk ml b">_waterfallBatch()</code>是负责实际加载种子的函数，所以让我们在那里做一些时间标记。</p><pre class="lz ma mb mc gt mm ml mn mo aw mp bi"><span id="4ac5" class="lb lc iq ml b gy mq mr l ms mt">async _waterfallBatch(seeds) {<br/>    const { knex } = this;<br/>    const log = [];<br/>    for (const seedPath of seeds) {<br/>      const importFile = require('../util/import-file'); // late import<br/>      const seed = await importFile(seedPath);<br/>      try {<br/>        const startMs = Date.now()<br/>        await seed.seed(knex);<br/>        const endMs = Date.now()<br/>        console.log(`${seedPath} took ${endMs - startMs} ms`);<br/>[...]</span></pre><p id="0785" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">运行它…</p><pre class="lz ma mb mc gt mm ml mn mo aw mp bi"><span id="ce78" class="lb lc iq ml b gy mq mr l ms mt">seeds/01_user_seed.js took 147 ms<br/>seeds/02_site_seed.js took 6 ms<br/>seeds/03_review_seed.js took 3 ms<br/>seeds/04_campaign_seed.js took 5 ms<br/>seeds/05_redirect_seed.js took 461 ms</span></pre><p id="49ca" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">哦。是啊，这是相当确凿的。</p><p id="32e9" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">查看重定向文件，我看到了可能的原因。</p><p id="1e36" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe mi mj mk ml b">05_redirect_seed.js</code>:</p><pre class="lz ma mb mc gt mm ml mn mo aw mp bi"><span id="4078" class="lb lc iq ml b gy mq mr l ms mt">const geoIpData = await iplocate(remoteIp);</span></pre><p id="e236" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一个<a class="ae mh" href="https://www.npmjs.com/package/node-iplocate" rel="noopener ugc nofollow" target="_blank">地理IP查找</a>为每一个种子加载。那就行了。</p><p id="465b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><code class="fe mi mj mk ml b">01_user_seed.js</code>:</p><pre class="lz ma mb mc gt mm ml mn mo aw mp bi"><span id="38bd" class="lb lc iq ml b gy mq mr l ms mt">return knex('users').insert([<br/>        {email: 'johnwatson@bakerstreet.com',<br/>         passwordHash: Bcrypt.hashSync("Sherlock",<br/>         parseInt(process.env.BCRYPT_SALT_ROUNDS))<br/>        }])</span></pre><p id="b342" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">以及针对每个插入的用户的<a class="ae mh" href="https://en.wikipedia.org/wiki/Bcrypt" rel="noopener ugc nofollow" target="_blank"> bcrypt </a>散列。这就解释了那个人。</p><h2 id="f1ff" class="lb lc iq bd ld le lf dn lg lh li dp lj ko lk ll lm ks ln lo lp kw lq lr ls lt bi translated">结论</h2><p id="cddf" class="pw-post-body-paragraph kf kg iq kh b ki lu jr kk kl lv ju kn ko lw kq kr ks lx ku kv kw ly ky kz la ij bi translated">对于用户种子，我将Bcrypt salt轮数减少到1 —这只是本地测试，因此不需要抵御攻击。</p><p id="7710" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">对于重定向，我为种子文件中使用的IP实现了一个查找表。结果可以立即看到:</p><pre class="lz ma mb mc gt mm ml mn mo aw mp bi"><span id="1c5d" class="lb lc iq ml b gy mq mr l ms mt">seeds/01_user_seed.js took 9 ms<br/>seeds/02_site_seed.js took 5 ms<br/>seeds/03_review_seed.js took 5 ms<br/>seeds/04_campaign_seed.js took 5 ms<br/>seeds/05_redirect_seed.js took 8 ms</span></pre><figure class="lz ma mb mc gt md gh gi paragraph-image"><div class="ab gu cl me"><img src="../Images/f4a6005f7444e9afdc32a5c3b6816514.png" data-original-src="https://miro.medium.com/v2/format:webp/1*n0YQ98vONyJ4eq9jHFPlQA.png"/></div></figure><p id="4c12" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">就这样结束了。希望这对其他人有所帮助！</p></div></div>    
</body>
</html>