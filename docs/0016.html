<html>
<head>
<title>Redux Toolkit (Immer &amp; Thunk)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Redux工具包(Immer &amp; Thunk)</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/redux-toolkit-immer-thunk-5bcac23968d7?source=collection_archive---------4-----------------------#2021-01-02">https://javascript.plainenglish.io/redux-toolkit-immer-thunk-5bcac23968d7?source=collection_archive---------4-----------------------#2021-01-02</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/19c63dde2d59e218ad692941067f0634.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rKO94vMhCG3pn0dQiBBbSA.jpeg"/></div></div></figure><blockquote class="jv jw jx"><p id="a4cf" class="jy jz ka kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">在我的上一篇文章中，我简要介绍了如何重构现有的Redux代码，以利用Redux工具包和React-Redux挂钩。那篇文章可以在(<a class="ae kx" href="https://medium.com/javascript-in-plain-english/refactoring-existing-redux-w-redux-toolkit-hooks-550a628d74a9" rel="noopener">这里</a>)找到，因为我将把它添加到从那里开始的演示中，所以它可能是一个很好的起点。现在，我想介绍的Redux Toolkit的另外两个功能是处理我们的片内的直接状态变化(感谢Immer ),然后还进行异步HTTP调用(感谢Thunk)。所以请不要离开，我将带您完成将这些功能添加到我们之前的演示中的过程。</p></blockquote><p id="e9ab" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj ky kl km kn kz kp kq kr la kt ku kv kw ig bi translated">让我们先快速浏览一下之前的代码。</p><figure class="lc ld le lf gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi lb"><img src="../Images/76183982047468e53536e9b5fd0e251a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XbCOKaqPaZcrUsZZwR7CAw.png"/></div></div><figcaption class="lg lh gj gh gi li lj bd b be z dk">Store (left), Slice(center), App Component(right)</figcaption></figure><p id="137b" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj ky kl km kn kz kp kq kr la kt ku kv kw ig bi translated">我们有基本的商店设置，我们的应用程序组件订阅的一些简单状态的切片，以及将增加我们状态中的“itemCount”的调度方法。</p><figure class="lc ld le lf gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi lk"><img src="../Images/57ec6bc70827b5aab6b5a2e04f94e505.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*h90YmTugnM4SLwe-8W6C0Q.png"/></div></div><figcaption class="lg lh gj gh gi li lj bd b be z dk">Adding &lt;form&gt; to App.js</figcaption></figure><p id="edf2" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj ky kl km kn kz kp kq kr la kt ku kv kw ig bi translated">让我们直接对我们的应用程序组件进行一些更改。我将从现在开始将实际的项目对象合并到我们的应用程序中。它将有一个简单的形式，我们的用户将填写创建一个新的项目，并将其添加到他们的购物车。将onSubmit留为空白，一旦我们编写了将它添加到Redux中的状态的dispatch方法，我们将马上回来处理它。接下来，我们需要去我们的商店。</p><p id="4a27" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj ky kl km kn kz kp kq kr la kt ku kv kw ig bi translated">鉴于我们将使用实际项目的数组，我们的itemCount变成了一个冗余，所以我们将把它换成一个我们称之为items的数组。因此，我们也可以利用我们的reducers和导出的selectItemCount中的increaseCount()。我们将用数组的功能替换所有这些功能，然后我们的应用程序组件将订阅这些功能，并能够根据数组的长度确定项目数。重构应该会产生如下所示的storeSlice:</p><figure class="lc ld le lf gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi lk"><img src="../Images/07ceb9cab69b4f79d7b8c29f0be73613.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kFCqSGUSfMSdZDQ36pG0Kg.png"/></div></div><figcaption class="lg lh gj gh gi li lj bd b be z dk">Refactored storeSlice for items: []</figcaption></figure><p id="e1e7" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj ky kl km kn kz kp kq kr la kt ku kv kw ig bi translated">因此，随着这些新的变化，我们已经设置了我们的切片来利用Immer。以前在Redux中，最佳实践表明，状态的改变必须在不直接改变状态的情况下进行，即创建当前状态的副本，操作该副本，然后将状态重新分配给改变后的副本。Immer在幕后为您完成所有这些工作。他们的医生是这样描述的:</p><blockquote class="jv jw jx"><p id="4b1d" class="jy jz ka kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">“基本的想法是，你将把你所有的修改应用到一个临时的<em class="in"> draftState </em>，它是<em class="in"> currentState </em>的代理。一旦你所有的突变都完成了，Immer将会基于草稿状态的突变产生<em class="in">下一个状态</em>。这意味着您可以通过简单地修改数据来与数据进行交互，同时保留不可变数据的所有优势。”</p><p id="57fa" class="jy jz ka kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">“使用Immer就像拥有了一个私人助理；他拿了一封信(当前状态)并给了你一份副本(草稿),让你在上面草草修改。一旦你完成了，助理会拿走你的草稿，为你产生真正的不可改变的，最终的信(下一个状态)。”</p></blockquote><p id="ab9f" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj ky kl km kn kz kp kq kr la kt ku kv kw ig bi translated">这对我们来说意味着一个超级简单的方法来处理和改变我们的Redux状态。我们可以直接推入' items '数组，让Immer为我们做一堆幕后工作。完成后，我们将继续对我们的应用程序组件进行更多的更改，现在可以反映我们更改的部分。</p><figure class="lc ld le lf gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi ll"><img src="../Images/884ed1534844e1e768a46fcdb23f5d29.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5VrnBCyAaEZtZpC_m1ii1g.png"/></div></div><figcaption class="lg lh gj gh gi li lj bd b be z dk">Refactored App component</figcaption></figure><p id="5993" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj ky kl km kn kz kp kq kr la kt ku kv kw ig bi translated">我们开始从storeSlice向addItem(我们的调度方法)和selectItem(我们订阅的状态片段)修复我们的导入。现在，我们只需为表单添加一个提交处理程序，它会将用户创建的项目发送到Redux存储中。Immer将会适当地改变我们的状态，一旦物品被添加到我们的物品数组中，它将会反映在第26行的物品计数中。这只是一个小例子，说明我们如何在Immer的帮助下，在Redux工具包中改变状态。</p></div><div class="ab cl lm ln hr lo" role="separator"><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr"/></div><div class="ig ih ii ij ik"><p id="27ef" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj ky kl km kn kz kp kq kr la kt ku kv kw ig bi translated">接下来让我们回到我们的storeSlice，在这里我们可以实现一个对伪API的GET请求，这个伪API理论上会在应用程序的初始加载时填充我们的items数组。这些都可以在我们的storeSlice中完成，使用Redux Toolkit中内置的Thunk中间件对外部源(通常是数据库)进行异步调用。当然，您可以使用其他中间件选项来进行异步调用，但是Thunk是Redux Toolkit的“开箱即用”产品，并且易于使用，这是在Redux中编写异步调用的一个很好的起点。</p><figure class="lc ld le lf gt jo gh gi paragraph-image"><div class="gh gi lt"><img src="../Images/57cffce0abc6bba7874941715c4db69f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1384/format:webp/1*szrxYrlU28BsUUomQZdviQ.png"/></div><figcaption class="lg lh gj gh gi li lj bd b be z dk">storeSlice.js w/Async Fetch Call</figcaption></figure><p id="e867" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj ky kl km kn kz kp kq kr la kt ku kv kw ig bi translated">因此，在我们的storeSlice中，我们添加了两件事情，首先是一个“fetch all”reducer操作，它将把我们的items数组设置为从fetch调用返回的任何内容。出于演示的目的，我们假设我们的fetch调用将从我们的DB返回一个项目数组。其次，我们添加实际的fetch调用‘items fetch ’,在我们的dispatch中传递，并在幕后的Thunk的帮助下，为我们进行异步调用。然后，我们当然会解析返回的数据，并随后调用fetchAll() reducer方法，用刚刚接收到的数据给items数组赋值。</p><p id="28ad" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj ky kl km kn kz kp kq kr la kt ku kv kw ig bi translated">相当简单，比以前编写Redux异步调用和相应的reducer方法要干净得多。现在，我们只需要在我们的应用程序组件中使用or itemsFetch方法，利用useEffect钩子，并通过我们的Redux工具包进行初始异步Fetch调用(使用Thunk)，Redux工具包可以直接改变状态(使用Immer)。就这么简单。下面是我们最终的应用程序组件和StoreSlice文件。</p><figure class="lc ld le lf gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi lu"><img src="../Images/ed96aabbee3c029ff8e9fcb0555eaa59.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GPzNVcon0sAMMPllQ6bppw.png"/></div></div><figcaption class="lg lh gj gh gi li lj bd b be z dk">Final App.js (left) &amp; storeSlice.js (right)</figcaption></figure><p id="d373" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj ky kl km kn kz kp kq kr la kt ku kv kw ig bi translated">这里有两个小例子说明如何继续构建Redux功能。这只是皮毛，因为我相信你可以想象你可以轻松地构建它，并将其扩展为一个完整的应用程序。这只是希望让您体验一下，使用Redux Toolkit可以简化以前复杂且经常令人费解的Redux代码的编写。</p><p id="dd28" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj ky kl km kn kz kp kq kr la kt ku kv kw ig bi translated">当然，如果你想更深入地了解它的功能，Redux Toolkit、Immer和Thunk的文档都列在下面，有一些更好的例子和用例！</p></div><div class="ab cl lm ln hr lo" role="separator"><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr"/></div><div class="ig ih ii ij ik"><p id="2cdc" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj ky kl km kn kz kp kq kr la kt ku kv kw ig bi translated"><em class="ka">【1】:Redux-Toolkit Docs(</em>【https://redux-toolkit.js.org/】T2)</p><p id="4032" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj ky kl km kn kz kp kq kr la kt ku kv kw ig bi translated"><em class="ka">【2】:Immer Docs(</em><a class="ae kx" href="https://immerjs.github.io/immer/docs/introduction" rel="noopener ugc nofollow" target="_blank">https://immerjs.github.io/immer/docs/introduction</a>)</p><p id="4249" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj ky kl km kn kz kp kq kr la kt ku kv kw ig bi translated"><em class="ka">【3】:Thunk Docs(</em><a class="ae kx" href="https://github.com/reduxjs/redux-thunk" rel="noopener ugc nofollow" target="_blank">https://github.com/reduxjs/redux-thunk</a>)</p></div></div>    
</body>
</html>