<html>
<head>
<title>We Almost Lost Our Production Database</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我们几乎失去了我们的生产数据库</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/we-almost-lost-our-production-database-268b90aac282?source=collection_archive---------5-----------------------#2021-08-26">https://javascript.plainenglish.io/we-almost-lost-our-production-database-268b90aac282?source=collection_archive---------5-----------------------#2021-08-26</a></blockquote><div><div class="fc if ig ih ii ij"/><div class="ik il im in io"><div class=""/><div class=""><h2 id="0daf" class="pw-subtitle-paragraph jo iq ir bd b jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf dk translated">对现实危机的技术剖析</h2></div><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gi gj kg"><img src="../Images/239b1b40ea33c343ef702daa6edbf17c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6piKzXVy9QUc38c2suoVQQ.jpeg"/></div></div><figcaption class="ks kt gk gi gj ku kv bd b be z dk">Photo by <a class="ae kw" href="https://www.pexels.com/@olly?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank">Andrea Piacquadio</a> from <a class="ae kw" href="https://www.pexels.com/photo/shallow-focus-photo-of-man-reading-newspaper-3799099/?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank">Pexels</a></figcaption></figure><p id="4cd2" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">上周五，我接到朋友(也是我的生意伙伴)的电话。一些客户打电话给他，说他们在仪表板上看不到任何数据。</p><p id="6cbb" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">“你确定他们可以登录吗？”我问我的朋友。</p><p id="b452" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">“是的，他们可以，但登录后看不到任何东西，”他回答说。</p><p id="3d12" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">他不是技术人员，也没有开发人员在我们国家的假期打电话。他让我调查这个问题。</p><p id="9327" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">事情就是这样开始的…</p><h1 id="815b" class="lt lu ir bd lv lw lx ly lz ma mb mc md jx me jy mf ka mg kb mh kd mi ke mj mk bi translated">可能的原因</h1><p id="97f3" class="pw-post-body-paragraph kx ky ir kz b la ml js lc ld mm jv lf lg mn li lj lk mo lm ln lo mp lq lr ls ik bi translated">我在之前的工作中已经面对了足够多的类似情况。我立即想到的可能原因是。</p><ul class=""><li id="ede9" class="mq mr ir kz b la lb ld le lg ms lk mt lo mu ls mv mw mx my bi translated">用户做错了什么。(非常不可能)</li><li id="73bf" class="mq mr ir kz b la mz ld na lg nb lk nc lo nd ls mv mw mx my bi translated">由于某种原因，获取用户详细信息API不工作</li><li id="0f6e" class="mq mr ir kz b la mz ld na lg nb lk nc lo nd ls mv mw mx my bi translated">凭证不知怎么搞混了(可能是前端缓存什么的)</li><li id="299e" class="mq mr ir kz b la mz ld na lg nb lk nc lo nd ls mv mw mx my bi translated">最坏的情况-数据丢失</li></ul><p id="5cb8" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">现在，我需要仔细检查每一种可能性，找出真正的问题所在。</p><h1 id="e78e" class="lt lu ir bd lv lw lx ly lz ma mb mc md jx me jy mf ka mg kb mh kd mi ke mj mk bi translated">放弃第一种可能性</h1><p id="7b9f" class="pw-post-body-paragraph kx ky ir kz b la ml js lc ld mm jv lf lg mn li lj lk mo lm ln lo mp lq lr ls ik bi translated">让我半技术性地概述一下这个东西是如何工作的。</p><p id="0410" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">我们使用firebase进行身份验证。成功登录后，firebase返回一个令牌，然后用这个令牌向提供JWT的Node.js后端发出后续请求。</p><p id="9438" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">所以如果用户可以登录，就意味着凭据是正确的，因为Firebase不会出错，对吗？😛</p><p id="d8c4" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">所以我们这边肯定有问题。</p><h1 id="4e6b" class="lt lu ir bd lv lw lx ly lz ma mb mc md jx me jy mf ka mg kb mh kd mi ke mj mk bi translated">最可怕的噩梦！</h1><p id="f491" class="pw-post-body-paragraph kx ky ir kz b la ml js lc ld mm jv lf lg mn li lj lk mo lm ln lo mp lq lr ls ik bi translated">在这种情况下，首先要找出特定用户的凭证，以检查出了什么问题。但在我看来，询问顾客的证件似乎是错误的。这会向他们传达一个错误的信息。</p><p id="e721" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">于是我创建了一个新用户，尝试登录。这是成功的，令我惊讶的是，我能够在仪表板上看到细节！</p><p id="617c" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">经证实，firebase上的身份验证在此阶段正常工作，我们的API也正常工作！所以只剩下一个选择了。</p><blockquote class="ne"><p id="0811" class="nf ng ir bd nh ni nj nk nl nm nn ls dk translated">数据丢失！</p></blockquote><p id="8035" class="pw-post-body-paragraph kx ky ir kz b la no js lc ld np jv lf lg nq li lj lk nr lm ln lo ns lq lr ls ik bi translated">好，好，好。这是一家公司可能发生的最糟糕的事情。此外，我们谈论的客户是付费客户，在该用户的个人资料中存储了一些敏感信息。</p><p id="22eb" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">因此，找出问题所在至关重要。</p><h1 id="d9c5" class="lt lu ir bd lv lw lx ly lz ma mb mc md jx me jy mf ka mg kb mh kd mi ke mj mk bi translated">这不是结束！</h1><p id="f778" class="pw-post-body-paragraph kx ky ir kz b la ml js lc ld mm jv lf lg mn li lj lk mo lm ln lo mp lq lr ls ik bi translated">在发现API工作正常后，我打电话给我的朋友，收集了更多的客户信息，并检查了他们的资料。</p><p id="8efb" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">事实证明，我们过去6个月的所有客户的仪表板上都没有任何数据。所有的凭据都是正确的，但不幸的是，他们中没有人能看到任何数据。</p><p id="3700" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">我别无选择。我想不出任何可能的答案或理由。</p><h1 id="a8a1" class="lt lu ir bd lv lw lx ly lz ma mb mc md jx me jy mf ka mg kb mh kd mi ke mj mk bi translated">所以我们召集了一次会议</h1><p id="745c" class="pw-post-body-paragraph kx ky ir kz b la ml js lc ld mm jv lf lg mn li lj lk mo lm ln lo mp lq lr ls ik bi translated">我们召集利益相关者召开了紧急会议。因为是周末，不可能让开发人员参加会议。</p><p id="b027" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">"有什么新功能可以让用户删除所有内容吗？"我问。</p><p id="cb3b" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">这是一个愚蠢的问题，但在过去的几个月里，我并没有参与开发过程，所以我并不了解最新的特性。</p><p id="7b99" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">事实证明，有部分删除用户信息的要求。后端API已经准备好了，但是前端并没有进行修改。</p><p id="6995" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">所以客户不可能自己从数据库中删除一些数据！</p><p id="bd83" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">我想，“好吧。有没有可能所有用户都调用了这个API？”。在检查后端代码后，我没有发现删除用户重要信息的更改，所以我们不得不放弃这个选项。</p><h1 id="00b1" class="lt lu ir bd lv lw lx ly lz ma mb mc md jx me jy mf ka mg kb mh kd mi ke mj mk bi translated">新线索！</h1><p id="8a70" class="pw-post-body-paragraph kx ky ir kz b la ml js lc ld mm jv lf lg mn li lj lk mo lm ln lo mp lq lr ls ik bi translated">我们的一个朋友查看了过去几个月应用程序的部署过程。我们公司正处于转型期，目前还没有积极的发展。</p><p id="f513" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">我们设计了使用GitHub管道部署后端的常用流程，该管道将应用程序部署到AWS ECS集群中。这是一个自动的过程。</p><p id="874f" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">看了部署流程的朋友告诉我们，之前的部署流程被改了。现在我们将部署到一个EC2实例。</p><p id="96e3" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">好，好，好。我想起了以前的一个事件，环境文件被交换，导致API命中错误的数据库。</p><h1 id="609d" class="lt lu ir bd lv lw lx ly lz ma mb mc md jx me jy mf ka mg kb mh kd mi ke mj mk bi translated">抓住你了。</h1><p id="ad4c" class="pw-post-body-paragraph kx ky ir kz b la ml js lc ld mm jv lf lg mn li lj lk mo lm ln lo mp lq lr ls ik bi translated">当我们没有选择的时候，我们最终决定再次手动部署应用程序。我不确定这是为什么，但是在使用正确的环境文件进行新的部署之后，一切都神奇地工作了！</p><h1 id="5a8c" class="lt lu ir bd lv lw lx ly lz ma mb mc md jx me jy mf ka mg kb mh kd mi ke mj mk bi translated">自我反省的时刻</h1><p id="7e14" class="pw-post-body-paragraph kx ky ir kz b la ml js lc ld mm jv lf lg mn li lj lk mo lm ln lo mp lq lr ls ik bi translated">就这些吗？我们浪费了两天时间才发现重新部署是解决方案？到底发生了什么？</p><p id="1e74" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">事实证明，我的朋友手工制作了一个数据库的克隆。他不是数据管理方面的专家，所以他想，让我们用新克隆的数据库来学习吧。</p><p id="b832" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">出于某种原因，我仍然不确定为什么。有些表没有被克隆。API一直指向错误的数据库。我们还在错误的数据库中搜索数据。</p><h1 id="0c34" class="lt lu ir bd lv lw lx ly lz ma mb mc md jx me jy mf ka mg kb mh kd mi ke mj mk bi translated">我们学到了什么？</h1><p id="4704" class="pw-post-body-paragraph kx ky ir kz b la ml js lc ld mm jv lf lg mn li lj lk mo lm ln lo mp lq lr ls ik bi translated">这件事再一次告诉我们，一个不好的流程会带来什么灾难。由于公司正在经历一段艰难的时期，没有积极的开发活动，我的朋友觉得没有必要通知我们他对数据库和部署过程所做的更改。</p><p id="d600" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">结果，我们失去了客户的信任，白白浪费了两天时间。</p><blockquote class="ne"><p id="985e" class="nf ng ir bd nh ni nj nk nl nm nn ls dk translated">但是即使是不好的事情也有好的一面，对吗？</p></blockquote><p id="34aa" class="pw-post-body-paragraph kx ky ir kz b la no js lc ld np jv lf lg nq li lj lk nr lm ln lo ns lq lr ls ik bi translated">也许下次类似的事情发生时，我会建议不看任何东西就重新部署:P也许我会鼓励每个人和我自己更多地遵循好的实践。</p><p id="48cd" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">不管是什么？我希望这样的事情永远不要再发生。</p><p id="7661" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">感谢阅读。祝您愉快！</p><p id="1342" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated"><strong class="kz is">通过</strong> <a class="ae kw" href="https://www.linkedin.com/in/56faisal/" rel="noopener ugc nofollow" target="_blank"> <strong class="kz is"> LinkedIn </strong> </a> <strong class="kz is">或我的</strong> <a class="ae kw" href="https://www.mohammadfaisal.dev/" rel="noopener ugc nofollow" target="_blank"> <strong class="kz is">个人网站</strong> </a> <strong class="kz is">与我取得联系。</strong></p><p id="1e9e" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated"><em class="nt">更多内容看</em><a class="ae kw" href="http://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><strong class="kz is"><em class="nt">plain English . io</em></strong></a></p></div></div>    
</body>
</html>