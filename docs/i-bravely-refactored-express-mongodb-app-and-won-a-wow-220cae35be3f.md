# 我勇敢地重构了 Express MongoDB App，赢得了一片叫好

> 原文：<https://javascript.plainenglish.io/i-bravely-refactored-express-mongodb-app-and-won-a-wow-220cae35be3f?source=collection_archive---------6----------------------->

## 润色你的代码。了解如何修复千层面架构。

![](img/d8757534fb67b09f3ff9a32428c7b9e9.png)

Polish your code. Made by Roset from Shutterstock

我给你讲个故事吧。推特上有个家伙。他有 3000 名忠实粉丝，并且增长迅速。他贴了一个 [Express+MongoDB=CRUD](https://twitter.com/SuhailKakar/status/1465386042849038337) 教程。人们喜欢这个教程！有人甚至称之为见解深刻。

![](img/cb75b0161b0f95acf88a326336cc6fb7.png)

These are not bots but real developers with life

教程看起来不错。它获得了很多好评。

不过，代号是*就咩*。代码尝起来像[千层面建筑](https://thevaluable.dev/kiss-principle-explained/#lasagna-architecture)。

我发现了两层薄薄的千层面。路由器()API 的误用。重复样板错误处理。这个项目比预期的要难两倍。

就在这个时候，它让我大开眼界:

> Dev 社区显然缺少了我所拥有的一项有价值的知识。我可以重构这个应用程序，并教其他人这个例子。

我不只是说说而已，而且我也在行动。我重构了这个应用程序，使它缩小了两倍，可读性提高了两倍。我给原作者看了新版本，赢得了**的喝彩**:

故事并没有到此结束。今天我想教你如何成为一个更好的开发者。让我向您展示我是如何重构原始应用程序的。我将解释我的思维过程。你会学到并获得有价值的见解。

我们将遵循以下计划:

*   首先，我们将研究原始应用程序
*   然后我们会把它擦亮

如果你想从这篇文章中记住一件事，就让它成为:

> 薄薄的千层面会悄悄地吸干你的灵魂。毫无悔意地杀了他们。

计算中的间接性意味着使用一个(或多个)中间人来调用某些东西。例如，从橙子到橙子的 1:1 转换。

> 间接可以使你的软件对变化更加灵活。请确定您需要这种灵活性！如果您打算交换一些实现，请确保您的代码库中现在有不止一个可用的实现。
> 
> — [什么是软件工程中的抽象并举例](https://thevaluable.dev/abstraction-type-software-example/)

# CRUD 应用程序要求

我们希望有一个云中的消息集合。我们的应用程序允许您创建/阅读/更新/删除消息。

90%的 web 应用都是这样。

# 应用架构

我们正在制作一个快递应用程序。然而，我们用 require()以非规范的方式连接了额外的路由。require()返回一个函数，该函数向传递的应用程序添加更多路线:

当您有一个专门用于这种情况的快速路由器()时，这是一个奇怪的选择。

## 薄薄的千层面

从 require()中检查魔法函数。我称之为纸一样薄的千层面。如果您需要添加/删除/更新路线，您需要在两个文件中进行更改:

*   在这个`app.routes.js`
*   而在`app.controller.js`

每增加一层，工作量就会增加一倍。添加的层越多，浏览和理解代码就越难。

> 这个代码库充满了良好的意图。负责这个庞然大物的开发人员并不想故意创建一个复杂的系统。他们想通过创造一些极其灵活、优雅、简洁、完美的软件来帮助每个人。
> 
> — [软件中 KISS 原理的详细说明](https://thevaluable.dev/kiss-principle-explained/#lasagna-architecture)

薄薄的千层面静静地躺在你的代码库中，慢慢地吸干你的灵魂。每当你添加一个特性或者重构的时候，他们都在浪费你的生命。当你看到一个薄的间接层时，考虑删除它。

## 样板核心

让我们无所畏惧地接近应用核心，钻到应用控制器。这是我们应用程序的核心。检查笨重的积垢路径。你可以立即看到他们有许多重复的代码:

不要误会我的意思。在我们的工艺中到处复制粘贴是必不可少的，它节省了大量的时间。然而，这个文件有 5 个函数使用了同样庞大的样板文件。在这种情况下，复制粘贴会使代码更难阅读和维护。

## 孤独的猫鼬模型

最后，我们还有一个文件:孤独的猫鼬模型。

它位于一个单独的文件夹中，一个单独的文件中。在那里感觉有点孤独。他正在考虑转向 routes，这样开发者就可以访问它。

# 判决

我在这里看到一个很酷的小应用程序，但是这个应用程序有一些问题:

*   薄薄的千层面。你能很容易地修理它。您需要删除路线文件和模型文件。这将使代码更容易阅读和维护
*   重复的样板文件。错误处理逻辑在每个路由中重复。404 逻辑在每个路由中重复。这种样板文件使程序变得庞大。您可以通过提取一个函数来轻松修复它

# 重构的应用架构

我们知道该怎么做:删除千层面的薄层，提取重复的代码。但首先，让我们修复应用程序路由。

## 重构路由

我们将使用`messages = Router()`。这样，我们可以用`app.use(path, router)`将我们的消息服务附加到一个特定的路径上。

我们也将通过`app.use((err, req, res, next) =>…)`来集中我们所有的错误处理。Express 在每个错误时调用这个钩子。我们应用程序中的所有错误都将在这里出现——我们编写的样板文件更少。

另外，观察突然的变化。我们将“/消息”API 重命名为“/消息”API:

> 在 API 端点中资源应该总是复数**，如果我们想要访问资源的一个实例，我们可以总是在 URL 中传递 id。— [RESTful API 设计指南](https://medium.com/hackernoon/restful-api-designing-guidelines-the-best-practices-60e1d954e7c9)**

## **重构的消息服务**

**我们删除了 2 个多余的图层:`app.routes.js`和`app.model.js`。把所有的代码都放到一个文件里。我们还将路由样板文件提取到一个 wrap()函数中。**

**我们将项目大小从 4 个文件削减到 2 个。看看没有千层面的代码是如何容易阅读的。**

## **现在轮到你了**

**如果你想从这篇文章中获得最大的收获，你需要练习:**

*   **叉[原 app 回购](https://github.com/suhailkakar/Node-Express-MongoDB-Restful-CRUD-API)**
*   **重构它**
*   **将这篇文章作为指导方针**

**这样你将在安全的环境中学习，并获得最大的洞察力价值。**

# **结论**

**从这个重构练习中，你应该学会 3 个要点:**

*   **薄薄的千层面悄悄地吸干了开发者社区的灵魂。你应该尽量避免[千层面架构](https://thevaluable.dev/kiss-principle-explained/#lasagna-architecture)。这将使你的代码 x2 更小，你的 x2 更有生产力**
*   **集中你的错误处理，这将节省你的样板文件**
*   **复制和粘贴是一个可怕的技术，你应该使用它。然而，当被误用时，它会降低代码的可读性**

**我希望你从这篇文章中学到了什么，今天你会觉得更有灵感。再见。**

# **发送代码给我，我会免费重构它**

*   **不确定如何重构代码？**
*   **在 Medium、Twitter 或网络的其他地方找到了一段有趣的代码？**

**把代码发给我，cirnotoss@gmail.com，我会把它打磨得闪闪发光。我们将一起帮助开发社区成长。**

***更多内容看* [***说白了。*** *报名参加我们的*](http://plainenglish.io/) [***免费每周简讯这里***](http://newsletter.plainenglish.io/) ***。*****