<html>
<head>
<title>Integrate JWT to your Authentication system within 10 minutes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在10分钟内将JWT集成到您的认证系统中</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/jwt-integration-with-an-example-referral-system-using-nodejs-mongodb-and-expressjs-17be91b35f1c?source=collection_archive---------5-----------------------#2021-01-16">https://javascript.plainenglish.io/jwt-integration-with-an-example-referral-system-using-nodejs-mongodb-and-expressjs-17be91b35f1c?source=collection_archive---------5-----------------------#2021-01-16</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="6c15" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">通过使用Node.js、MongoDB和Express建立一个查询系统</h2></div><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi kc"><img src="../Images/9c1cc69bc074de5d350151663c6c9c7e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZwQ3ZKff44MesgyrNOoA0w.jpeg"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Photo by <a class="ae ks" href="https://unsplash.com/@jefflssantos?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Jefferson Santos</a> on <a class="ae ks" href="https://unsplash.com/s/photos/programming?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="120e" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">欢迎光临！在这篇文章中，我们将学习如何使用JSON Web令牌(JWT)管理用户会话。最后，我们还将构建一个简单的推荐系统来演示JWT的工作流程。</p><p id="365c" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">如果您已经有了一个用户认证系统，那么您可以参考这篇文章，将JSON web令牌安全地集成到您现有的项目中。</p><p id="64a7" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">不要在介绍上浪费更多的时间，让我们开始吧。</p><blockquote class="lp lq lr"><p id="3f0d" class="kt ku ls kv b kw kx jo ky kz la jr lb lt ld le lf lu lh li lj lv ll lm ln lo ig bi translated">这篇文章是我上一篇文章(第二部分)的继续，在那篇文章中，我展示了带有电子邮件验证、忘记密码和重置密码功能的用户注册的实现。如果你想看看第一部分，使用这个<a class="ae ks" href="https://pranesh-a-s.medium.com/how-to-build-simple-and-secure-rest-api-for-user-authentication-using-node-js-jwt-and-mongodb-2bdeb3e5427e" rel="noopener">链接</a>。</p></blockquote><p id="78bb" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">让我们看看我们的登录API。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi lw"><img src="../Images/a40985afed9c40e3a3a30db93ce5bcab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Gvp74EpXca2Y7-JDhpBClg.png"/></div></div></figure><p id="c6f5" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">在这里，我们可以看到，一旦用户登录，我们只返回成功标志和一条消息，这不足以创建有效的会话。现在让我们为每次登录创建一个访问令牌(有效期为1小时),并将其发送给客户端。</p><h1 id="7645" class="lx ly in bd lz ma mb mc md me mf mg mh jt mi ju mj jw mk jx ml jz mm ka mn mo bi translated">什么是JWT？</h1><blockquote class="lp lq lr"><p id="a627" class="kt ku ls kv b kw kx jo ky kz la jr lb lt ld le lf lu lh li lj lv ll lm ln lo ig bi translated">JWT只是一种会话数据有效负载JSON格式，由服务器加密签名。</p></blockquote><p id="2454" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">更详细的<a class="ae ks" href="https://jwt.io/introduction/" rel="noopener ugc nofollow" target="_blank">解释</a>:</p><p id="17e2" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">JSON Web Token (JWT)是一个开放标准(<a class="ae ks" href="https://tools.ietf.org/html/rfc7519" rel="noopener ugc nofollow" target="_blank"> RFC 7519 </a>)，它定义了一种紧凑且独立的方式，以JSON对象的形式在各方之间安全地传输信息。该信息可以被验证和信任，因为它是数字签名的。jwt可以使用秘密(使用HMAC算法)或使用RSA或ECDSA的公钥/私钥对进行签名。</p><h2 id="993c" class="mp ly in bd lz mq mr dn md ms mt dp mh lc mu mv mj lg mw mx ml lk my mz mn na bi translated"><strong class="ak">生成令牌</strong></h2><p id="b04a" class="pw-post-body-paragraph kt ku in kv b kw nb jo ky kz nc jr lb lc nd le lf lg ne li lj lk nf lm ln lo ig bi translated">使用以下命令安装“<code class="fe ng nh ni nj b">jsonwebtoken</code>”模块:</p><pre class="kd ke kf kg gt nk nj nl nm aw nn bi"><span id="d140" class="mp ly in nj b gy no np l nq nr">npm i jsonwebtoken --save</span></pre><p id="12ce" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">在用户/助手文件夹中，创建一个文件<code class="fe ng nh ni nj b">generateJwt.js</code></p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="9e71" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">将你的JWT秘密添加到<code class="fe ng nh ni nj b">.env</code>文件中</p><pre class="kd ke kf kg gt nk nj nl nm aw nn bi"><span id="d152" class="mp ly in nj b gy no np l nq nr">JWT_SECRET = &lt;SOME_LONG_SECRET_KEY&gt;</span></pre><p id="4f6c" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">这个JWT秘密将被用作签署有效载荷的密钥。</p><p id="ddd8" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">保存文件并启动服务器。</p><blockquote class="lp lq lr"><p id="1007" class="kt ku ls kv b kw kx jo ky kz la jr lb lt ld le lf lu lh li lj lv ll lm ln lo ig bi translated"><strong class="kv io">注意</strong>:秘密越长，我们的应用就越安全。因为我们使用的是HMAC算法(对称)，所以一个密钥就足够签名了。如果我们使用RSA，那么我们需要2个密钥(私有和公共)。</p></blockquote><p id="b038" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">更新用户模式以存储accessToken。</p><pre class="kd ke kf kg gt nk nj nl nm aw nn bi"><span id="3184" class="mp ly in nj b gy no np l nq nr">accessToken: { type: String, default: null }</span></pre><p id="95a9" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">让我们在<code class="fe ng nh ni nj b">user.controller.js file</code>中导入<code class="fe ng nh ni nj b">generateJwt</code>函数，并用它来创建一个访问令牌。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="4983" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">是的，我们正在数据库中保存访问令牌。你们中的许多人可能认为使用JWT不是正确的方式，因为JWT的主要用途是方便<strong class="kv io">无状态</strong>认证，这意味着我们不需要在服务器中存储信息。因为JWT本身包含过期时间、有效载荷、发行者等信息。，但我的目标是使用JWT创建一个<strong class="kv io">安全</strong> API，我是认真的。</p><blockquote class="lp lq lr"><p id="f24b" class="kt ku ls kv b kw kx jo ky kz la jr lb lt ld le lf lu lh li lj lv ll lm ln lo ig bi translated"><strong class="kv io"> <em class="in">注</em> </strong> <em class="in"> : </em> JWT自身并不安全。让它安全的是我们如何在我们的系统中使用它。我不愿意把这篇文章带走，因为这篇文章的目的是展示JWT与我们的认证系统的集成。</p></blockquote><p id="90d9" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">对于那些仍然对我为什么在DB中存储访问令牌感兴趣的人来说，我所做的是<code class="fe ng nh ni nj b">whitelisting</code>令牌。为了提高底层系统的安全性，我们必须将令牌列入白名单或黑名单。最首选的方法是黑名单，与白名单相比，搜索空间要小得多。</p><blockquote class="lp lq lr"><p id="0f6e" class="kt ku ls kv b kw kx jo ky kz la jr lb lt ld le lf lu lh li lj lv ll lm ln lo ig bi translated"><strong class="kv io"> <em class="in"> PS </em> </strong>:当然，我不是安全专家。所以，如果我在安全方面错了，请让我知道。我很乐意学习。</p></blockquote><p id="9f9a" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">现在让我们从邮差处登录:</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi nu"><img src="../Images/db2852a922ac3e30de32d1694bef71cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1390/format:webp/1*qDnEmkVp6bSvs6piqS8zNg.png"/></div></div></figure><p id="02ec" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">酷！我们得到了1小时内有效的访问令牌。我们不会每次都得到相同的令牌。每次都会为每个人生成不同的令牌。</p><h1 id="0268" class="lx ly in bd lz ma mb mc md me mf mg mh jt mi ju mj jw mk jx ml jz mm ka mn mo bi translated"><strong class="ak"> JWT逮到你了</strong></h1><p id="52b1" class="pw-post-body-paragraph kt ku in kv b kw nb jo ky kz nc jr lb lc nd le lf lg ne li lj lk nf lm ln lo ig bi translated">关于JSON web令牌的另一个误解是，令牌是加密的，存储的所有信息都是完全安全的。我们必须明白，我们的有效载荷是“签名”的，而不是“加密”的。</p><p id="ece0" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">让我们做一些实验。</p><p id="66af" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">这是我在响应中收到的访问令牌:</p><pre class="kd ke kf kg gt nk nj nl nm aw nn bi"><span id="2c15" class="mp ly in nj b gy no np l nq nr">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6InNhdG9zaGlAZ21haWwuY29tIiwiaWQiOiJjYzkyZWNiYi1lOTlhLTQ4NWItOWFjMy04MTcwMWNkOWU5YmUiLCJpYXQiOjE2MTA3MzkwOTAsImV4cCI6MTYxMDgyNTQ5MH0.WKE_E3WB8s1yCpB1KO63wYtqxd_sjY_DDVldsxbrMqc</span></pre><p id="650f" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">在浏览器中打开一个新标签，访问<a class="ae ks" href="http://calebb.net/" rel="noopener ugc nofollow" target="_blank">http://calebb.net/</a>并粘贴令牌。</p><p id="6948" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">你会看到这样的东西</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi nv"><img src="../Images/44355af2571a8bd300cbb23579b1df5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1372/format:webp/1*MOxfAMuewEYOSkqlyp6fzw.png"/></div></figure><p id="905c" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">是的，在没有密钥的情况下，通过解码<strong class="kv io">来检索我们存储在JWT中的JSON有效载荷是可能的。仅在验证JWT是否有效时才需要密钥。因此，我们不应该在JWT有效载荷中存储敏感信息，如密码、API密钥等。</strong></p><p id="dc09" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">我再次强调，JWT本身并不安全。这取决于我们如何使用它。</p><h1 id="4df7" class="lx ly in bd lz ma mb mc md me mf mg mh jt mi ju mj jw mk jx ml jz mm ka mn mo bi translated"><strong class="ak">实施简单转诊制度</strong></h1><p id="5e46" class="pw-post-body-paragraph kt ku in kv b kw nb jo ky kz nc jr lb lc nd le lf lg ne li lj lk nf lm ln lo ig bi translated">为了理解如何实现安全端点，我们将创建一个简单的引用系统。</p><p id="13b9" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">它是这样工作的:</p><ul class=""><li id="cecc" class="nw nx in kv b kw kx kz la lc ny lg nz lk oa lo ob oc od oe bi translated">在注册期间为用户生成推荐代码，并将代码保存在数据库中。</li><li id="af2f" class="nw nx in kv b kw of kz og lc oh lg oi lk oj lo ob oc od oe bi translated">注册时，从用户处获取推荐代码。</li><li id="fe3c" class="nw nx in kv b kw of kz og lc oh lg oi lk oj lo ob oc od oe bi translated">检查数据库中是否存在该推荐代码。</li><li id="c282" class="nw nx in kv b kw of kz og lc oh lg oi lk oj lo ob oc od oe bi translated">如果存在，那么存储细节，否则抛出一个错误。</li></ul><p id="6ea4" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">为了生成推荐代码，我们将使用一个简短的唯一Id生成器“<code class="fe ng nh ni nj b">nanoid</code>”。</p><p id="3258" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">安装依赖项:<code class="fe ng nh ni nj b">npm i nanoid --save</code></p><p id="6dc9" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">我们将使用包含字符a-z、A-Z和0–9的自定义字符集来生成推荐代码。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="94a0" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">另外，将以下字段添加到用户模式中。</p><pre class="kd ke kf kg gt nk nj nl nm aw nn bi"><span id="41dd" class="mp ly in nj b gy no np l nq nr">referralCode: { type: String, unique: true },<br/>referrer: { type: String, default: null }</span></pre><p id="c60e" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">完成所有更改后，我们的用户模型将如下所示:</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="1ef2" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">现在保存文件并重启服务器。</p><p id="d592" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">让我们注册并检查是否一切都如预期的那样运行良好。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi ok"><img src="../Images/82e9ac5c473af89603e9ce75a7b5990d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Qe23LARE4KEXt6BdtWFL8w.png"/></div></div></figure><p id="f2db" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">酷！我们得到了我们的推荐代码<code class="fe ng nh ni nj b">RiNb08qd</code>。让我们看看我们的DB系列。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi ol"><img src="../Images/cafb15806aa4f560110d47c9b92c0c50.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dZc5SisF1TPv-o3WynSdwA.png"/></div></div></figure><p id="3ee2" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">我们可以看到<code class="fe ng nh ni nj b">referralCode</code>已经被添加到用户集合中。</p><p id="b842" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">让我们假设我们已经与我们的一些朋友分享了这个推荐代码。所以他/她在注册时输入我们的推荐代码。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi om"><img src="../Images/51f92852fe8dad115b73454441480741.png" data-original-src="https://miro.medium.com/v2/resize:fit:1392/format:webp/1*3g_ki9FqZ1O84Pv5Wcm09w.png"/></div></figure><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi on"><img src="../Images/ed413c0683a560e5af3eeba84dc57d00.png" data-original-src="https://miro.medium.com/v2/resize:fit:1022/format:webp/1*XzAt-uL5D0RPKaz0H1Ls_Q.png"/></div></figure><p id="5f77" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">有用！我们的朋友可以用我们的推荐代码注册。</p><p id="ecac" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">现在让我们为我们的项目添加更多的功能。比方说，我们需要检索所有使用我们的推荐代码注册的帐户，当我们登录时，它必须显示在我们的仪表板上。</p><h2 id="2aa8" class="mp ly in bd lz mq mr dn md ms mt dp mh lc mu mv mj lg mw mx ml lk my mz mn na bi translated"><strong class="ak">流程</strong></h2><ul class=""><li id="0f10" class="nw nx in kv b kw nb kz nc lc oo lg op lk oq lo ob oc od oe bi translated">成功登录后，将JWT存储在客户端(在本地存储中，索引数据库等)。</li><li id="0f05" class="nw nx in kv b kw of kz og lc oh lg oi lk oj lo ob oc od oe bi translated">然后用授权头中的访问令牌调用<code class="fe ng nh ni nj b">GET /referred</code>端点。</li><li id="07f8" class="nw nx in kv b kw of kz og lc oh lg oi lk oj lo ob oc od oe bi translated">验证令牌是否有效，通过从JWT有效负载中解码用户id来找到用户id。</li><li id="3de8" class="nw nx in kv b kw of kz og lc oh lg oi lk oj lo ob oc od oe bi translated">使用用户id获取引用代码，然后查找referrer字段与<code class="fe ng nh ni nj b">referralCode</code>匹配的所有集合。</li></ul><p id="700c" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">但是我们如何验证头中传递的JWT呢？简单来说，我们需要调用存在于<code class="fe ng nh ni nj b">jsonwebtoken</code>模块中的<code class="fe ng nh ni nj b">verify</code> API，因为我们使用了<code class="fe ng nh ni nj b">sign</code> API。让我们继续实现用于验证访问令牌的中间件。</p><p id="1961" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">在middlewares文件夹中，创建一个名为<code class="fe ng nh ni nj b">validateToken.js</code>的文件</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="c695" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">这是验证JWT令牌的一种更安全的方式。我们不只是验证令牌，而是对照我们的白名单(在数据库中)进行检查。</p><p id="ca69" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">现在，让我们定义控制器来获取所有引用的帐户。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="6be7" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">然后，我们必须将端点添加到我们的路由器。在<code class="fe ng nh ni nj b">routes/users.js</code>文件中，导入<code class="fe ng nh ni nj b">validateToken</code>中间件，并在新创建的端点中使用它。</p><pre class="kd ke kf kg gt nk nj nl nm aw nn bi"><span id="6cd7" class="mp ly in nj b gy no np l nq nr"><strong class="nj io">const { validateToken } = require(“../middlewares/validateToken”);<br/></strong>const AuthController = require(“../src/users/user.controller”);<br/>router.post(“/signup”, cleanBody, AuthController.Signup);</span><span id="43d9" class="mp ly in nj b gy or np l nq nr">...<br/>...</span><span id="bfda" class="mp ly in nj b gy or np l nq nr"><strong class="nj io">router.get(“/referred”, validateToken, AuthController.ReferredAccounts);</strong></span></pre><p id="23a0" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">更新文件后，让我们测试我们的端点。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi om"><img src="../Images/2840f48f0a1a40c7f4a89a6f618c6b2f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1392/format:webp/1*GZ5S_cDW2604dgOc_0AggQ.png"/></div></figure><p id="6b80" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">我们的中间件抛出错误<code class="fe ng nh ni nj b">Access token is missing</code>。让我们通过传递一个随机令牌作为标头来测试。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi om"><img src="../Images/76caa20f4da1d39ef7031f4165b40e92.png" data-original-src="https://miro.medium.com/v2/resize:fit:1392/format:webp/1*3Cw-RQpXZZXUU-R_4M12Bw.png"/></div></figure><p id="c32d" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">有用！现在让我们登录以获得一个有效的访问令牌。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi nu"><img src="../Images/db2852a922ac3e30de32d1694bef71cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1390/format:webp/1*qDnEmkVp6bSvs6piqS8zNg.png"/></div></div></figure><p id="feb3" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">现在让我们在<code class="fe ng nh ni nj b">Authorization header</code>中传递这个访问令牌作为<code class="fe ng nh ni nj b">Bearer</code>令牌。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi os"><img src="../Images/b9be548ac37b0cc0fc853ad6f78d17f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BNkHniavJ-7ZqcVZ1URaXA.png"/></div></div></figure><p id="e30e" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">嘣！我们得到了所有使用我们的推荐代码注册的账户。因此，使用JSON Web令牌，我们可以保护尽可能多的端点，就像我们对<code class="fe ng nh ni nj b"> GET /referred</code>端点所做的那样。</p><p id="2c03" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">现在，让我们定义注销用户的控制器和端点。用户注销控制器很简单。我们只需要从数据库中清除访问令牌就行了。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="3ffe" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">它还是一个受保护的端点，只有拥有有效访问令牌的登录用户才能注销。</p><p id="2e4c" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">在将注销端点添加到我们的<code class="fe ng nh ni nj b">routes/users.js file</code>之后，它将看起来像这样。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="4454" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">最后，让我们检查注销端点。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi ot"><img src="../Images/aa6c9cdb9ffc3a342f648afb29128bcd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rMsQIXzR3NOKeG09TWieoA.png"/></div></div></figure><p id="79e9" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">让我们尝试使用相同的令牌获取引用的帐户。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi ot"><img src="../Images/f886123691fd7b1253f4c8540a93c425.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gJcStTfBeKUkLrX0iIdkSA.png"/></div></div></figure><p id="598f" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">太好了！它像预期的那样工作。如果检查用户的集合，访问令牌将从用户文档中清除。因此，我们已经成功地(<strong class="kv io">和安全地</strong>)将JWT集成到我们的认证系统中。</p><p id="5bb1" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">你可以在这个<a class="ae ks" href="https://github.com/PraneshASP/node-authentication-jwt-mongodb" rel="noopener ugc nofollow" target="_blank"> GitHub库</a>中找到完整的源代码。</p><h2 id="ea70" class="mp ly in bd lz mq mr dn md ms mt dp mh lc mu mv mj lg mw mx ml lk my mz mn na bi translated"><strong class="ak">结论</strong></h2><p id="b6ac" class="pw-post-body-paragraph kt ku in kv b kw nb jo ky kz nc jr lb lc nd le lf lg ne li lj lk nf lm ln lo ig bi translated">在这个现代网络时代，没有什么叫做“这是正确的方法”来实现一个特性。根据需求的不同，它会因系统而异。所以，让我们每天都探索和学习新的东西吧！</p><p id="4650" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">如果你对这篇文章有任何疑问，我随时欢迎讨论。</p><p id="9b6f" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">感谢阅读！</p></div></div>    
</body>
</html>