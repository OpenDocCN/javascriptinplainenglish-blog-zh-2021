<html>
<head>
<title>Handle Tasks Asynchronously: Web Push Notification System With RabbitMQ</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">异步处理任务:使用RabbitMQ的Web推送通知系统</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/handle-tasks-asynchronously-web-push-notification-system-with-rabbitmq-dabab19d4652?source=collection_archive---------13-----------------------#2021-05-15">https://javascript.plainenglish.io/handle-tasks-asynchronously-web-push-notification-system-with-rabbitmq-dabab19d4652?source=collection_archive---------13-----------------------#2021-05-15</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/dd1812947b92ddcbfb6fe589a94176f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ENQ-fZHhPTOxkJndTsmFEA.png"/></div></div></figure><p id="0687" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">异步可能是一件复杂的事情。但是它绝对值得你花时间去了解，也就是说，如果你想构建一个可伸缩的后端系统。并创建一个促进良好用户体验的前端。</p><p id="1344" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">通知系统就是一个很好的例子。当您想要向所有用户发送通知时，可能该任务会花费很多时间。不需要等到任务完成了，那个时候还想做别的。能够异步处理任务的系统将解决您的问题。</p><p id="a9bb" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">本文将向您展示如何构建一个简单的<a class="ae kt" href="https://developers.google.com/web/fundamentals/push-notifications/how-push-works" rel="noopener ugc nofollow" target="_blank"> web推送通知</a>系统。该系统可以向订阅该系统的客户端用户的浏览器发送推送通知。</p><h1 id="3ab1" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">初始化项目</h1><p id="e648" class="pw-post-body-paragraph jv jw in jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated">本文的源代码是基于<a class="ae kt" href="https://levelup.gitconnected.com/tdd-with-typescript-and-jest-url-shortener-6956e2387ce8" rel="noopener ugc nofollow" target="_blank"> TDD和TypeScript和Jest:Url shorter</a>story的源代码。用Express、MongoDB、Mongoose和TypeScript构建HTTP服务器很容易。</p><p id="8340" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">克隆项目:</p><pre class="lx ly lz ma gt mb mc md me aw mf bi"><span id="04a1" class="mg kv in mc b gy mh mi l mj mk">$ git clone <a class="ae kt" href="https://github.com/hoangsetup/url-shortener.git" rel="noopener ugc nofollow" target="_blank">https://github.com/hoangsetup/url-shortener.git</a> ts-rabbitMQ<br/>$ code ts-rabbitMQ</span></pre><p id="907a" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">带<code class="fe ml mm mn mc b">ts-rabbitMQ</code>的是我们的项目文件夹。</p><p id="63dd" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">更新项目信息:可以更新<code class="fe ml mm mn mc b">package.json</code>中的项目名称和项目信息，也可以删除多余的文件(<em class="mo"> /urls </em> API和相关文件)。</p></div><div class="ab cl mp mq hr mr" role="separator"><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu"/></div><div class="ig ih ii ij ik"><p id="69d0" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在这个项目中，我们使用<code class="fe ml mm mn mc b">mongodb</code>作为数据库来存储订阅数据。并使用<a class="ae kt" href="https://www.rabbitmq.com/" rel="noopener ugc nofollow" target="_blank"> RabbitMQ </a>作为消息代理。然后我们需要安装它们进行开发，最简单的方法之一就是使用docker。</p><p id="a359" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><code class="fe ml mm mn mc b">docker-composer.yml</code></p><figure class="lx ly lz ma gt jo"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="7227" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">您可以向您的终端提供<code class="fe ml mm mn mc b">RABBITMQ_USERNAME</code>和<code class="fe ml mm mn mc b">RABBITMQ_PASSWORD</code>或将其设置在<code class="fe ml mm mn mc b">.env</code>文件中(从<code class="fe ml mm mn mc b">.env.example</code>复制)。</p><p id="3c21" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><code class="fe ml mm mn mc b">.env</code></p><pre class="lx ly lz ma gt mb mc md me aw mf bi"><span id="56ee" class="mg kv in mc b gy mh mi l mj mk">PORT=3000<br/>MONGO_URI="mongodb://localhost:27017/cats_news_push"</span><span id="611c" class="mg kv in mc b gy my mi l mj mk">RABBITMQ_USERNAME=rabbitmq<br/>RABBITMQ_PASSWORD=r@bb1tmq</span></pre><p id="42e6" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">启动mongo服务和RabbitMQ:</p><pre class="lx ly lz ma gt mb mc md me aw mf bi"><span id="e58c" class="mg kv in mc b gy mh mi l mj mk">$ docker-compose up -d</span></pre><h1 id="7c14" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">简单的客户端用户界面</h1><p id="c7d3" class="pw-post-body-paragraph jv jw in jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated">客户端将在用户浏览器中请求推送通知，并向服务器发送订阅id。</p><figure class="lx ly lz ma gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mz"><img src="../Images/a38eac9f7dfd9f6a40e1861c2f8831a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*c6ycBXp7L261opzKr34KFQ.png"/></div></div></figure><p id="759b" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">您可以通过完成<a class="ae kt" href="https://codelabs.developers.google.com/codelabs/push-notifications" rel="noopener ugc nofollow" target="_blank">向web应用添加推送通知</a>教程来获取客户端源代码。您可以从以下位置获取客户端源代码:</p><div class="na nb gp gr nc nd"><a href="https://github.com/GoogleChromeLabs/web-push-codelab/tree/master/completed/07-unsubscribe" rel="noopener  ugc nofollow" target="_blank"><div class="ne ab fo"><div class="nf ab ng cl cj nh"><h2 class="bd io gy z fp ni fr fs nj fu fw im bi translated">Google chrome labs/web-push-code lab</h2><div class="nk l"><h3 class="bd b gy z fp ni fr fs nj fu fw dk translated">在GitHub上创建一个帐户，为Google chrome labs/we b-push-code lab开发做贡献。</h3></div><div class="nl l"><p class="bd b dl z fp ni fr fs nj fu fw dk translated">github.com</p></div></div><div class="nm l"><div class="nn l no np nq nm nr jt nd"/></div></div></a></div><p id="b85e" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">让我们将客户端文件复制到我们项目的<code class="fe ml mm mn mc b">public</code>文件夹中:</p><figure class="lx ly lz ma gt jo gh gi paragraph-image"><div class="gh gi ns"><img src="../Images/5963955fbac3d947442fc02eddf86605.png" data-original-src="https://miro.medium.com/v2/resize:fit:1172/format:webp/1*Nu654NzxbY3-brYQghV9CQ.png"/></div></figure></div><div class="ab cl mp mq hr mr" role="separator"><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu"/></div><div class="ig ih ii ij ik"><p id="31d2" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我们使用<a class="ae kt" href="https://www.npmjs.com/package/web-push" rel="noopener ugc nofollow" target="_blank">网络推送</a>来生成VAPIDKeys和推送通知。</p><pre class="lx ly lz ma gt mb mc md me aw mf bi"><span id="6079" class="mg kv in mc b gy mh mi l mj mk">$ npm install web-push -S<br/>$ npm install @types/web-push -D</span><span id="a781" class="mg kv in mc b gy my mi l mj mk"># Generate VAPID keys<br/>$ npx web-push generate-vapid-keys</span></pre><p id="04f5" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">输出:</p><pre class="lx ly lz ma gt mb mc md me aw mf bi"><span id="f1f4" class="mg kv in mc b gy mh mi l mj mk">=======================================</span><span id="70e6" class="mg kv in mc b gy my mi l mj mk">Public Key:<br/>BHCrHXuxQaiH8rApE67U_YM0P7kg31S_a9jojfSd4WX9yCapq7q_PG698P4KrOd8qoFFpdl99vM25nUyBl7YXz0</span><span id="ece8" class="mg kv in mc b gy my mi l mj mk">Private Key:<br/>GVr1jsYqkvOFIbiluiIJQpik9-QNOxElPl3bTLexjG8</span><span id="20ba" class="mg kv in mc b gy my mi l mj mk">=======================================</span></pre><p id="457c" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">为客户端保存密钥并更新公钥值:</p><ul class=""><li id="eb38" class="nt nu in jx b jy jz kc kd kg nv kk nw ko nx ks ny nz oa ob bi translated"><code class="fe ml mm mn mc b">./public/scripts/main.js</code>(第25行):<code class="fe ml mm mn mc b">applicationServerPublicKey</code>变量值。</li><li id="f0d1" class="nt nu in jx b jy oc kc od kg oe kk of ko og ks ny nz oa ob bi translated"><code class="fe ml mm mn mc b">./public/sw.js</code>(第27行):<code class="fe ml mm mn mc b">applicationServerPublicKey</code>变量值。</li></ul></div><div class="ab cl mp mq hr mr" role="separator"><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu"/></div><div class="ig ih ii ij ik"><p id="b814" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">提供静态文件并处理用户会话。我们想控制哪些用户订阅系统，然后我为每个客户端创建一个唯一的id(您可以使用您的用户id代替)。</p><p id="5787" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">更新<code class="fe ml mm mn mc b">ApiApp.ts</code></p><figure class="lx ly lz ma gt jo"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="87d6" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">带<code class="fe ml mm mn mc b">CookieHelper.ts</code></p><figure class="lx ly lz ma gt jo"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="9285" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我们还需要更新<code class="fe ml mm mn mc b">package.json</code>文件:</p><figure class="lx ly lz ma gt jo"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="0601" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">最后，启动开发服务器:</p><pre class="lx ly lz ma gt mb mc md me aw mf bi"><span id="9ed2" class="mg kv in mc b gy mh mi l mj mk">$ npm run dev</span></pre><p id="c94b" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">进入<code class="fe ml mm mn mc b"><a class="ae kt" href="http://localhost:3000" rel="noopener ugc nofollow" target="_blank">http://localhost:3000</a></code>。客户端到<code class="fe ml mm mn mc b">ENABLE PUSH MESSAGING</code>并接受推送通知权限，那么您的订阅就应该已经出现了。<code class="fe ml mm mn mc b">userId</code>饼干也可以被创造出来。</p><figure class="lx ly lz ma gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi oh"><img src="../Images/36e7b42f365c8f00f532957abfb25c5a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XKSB4AYU45YSpGO-e8N9Ug.png"/></div></div></figure><h1 id="ea87" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">商店预订</h1><p id="1cd6" class="pw-post-body-paragraph jv jw in jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated">在这一部分，我们将创建2个新的API。</p><ul class=""><li id="fdfb" class="nt nu in jx b jy jz kc kd kg nv kk nw ko nx ks ny nz oa ob bi translated"><code class="fe ml mm mn mc b">POST /subscriptions</code>将用户订阅保存到系统数据库中。</li><li id="78a6" class="nt nu in jx b jy oc kc od kg oe kk of ko og ks ny nz oa ob bi translated"><code class="fe ml mm mn mc b">DELETE /subscriptions</code>删除系统数据库中的用户订阅。</li></ul><h2 id="ff41" class="mg kv in bd kw oi oj dn la ok ol dp le kg om on li kk oo op lm ko oq or lq os bi translated">服务器端</h2><p id="3a62" class="pw-post-body-paragraph jv jw in jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated">客户端订阅将如下所示:</p><pre class="lx ly lz ma gt mb mc md me aw mf bi"><span id="b290" class="mg kv in mc b gy mh mi l mj mk">{<br/>  "endpoint": "<a class="ae kt" href="https://fcm.googleapis.com/fcm/send/fz1Fk7x05XY:APA91xxxx" rel="noopener ugc nofollow" target="_blank">https://fcm.googleapis.com/fcm/send/fz1Fk7x05XY:APA91xxxx</a>",<br/>  "expirationTime": null,<br/>  "keys": {<br/>    "p256dh": "BC7fA_62dG3jc3lN9POVbANyUzMvrEponujWnNwv1DAPAPz6V-zKmV4ScfyWiyQlnKeRIvNMsn89BAH-zU23NVQ",<br/>    "auth": "O8gfelLkz3YX3nzV6DkqbQ"<br/>  }<br/>}</span></pre><p id="5e03" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">然后<code class="fe ml mm mn mc b">SubscriptionModel</code>将被设计用于处理该数据:</p><p id="7715" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><code class="fe ml mm mn mc b">./src/models/SubsriptionModel.ts</code></p><figure class="lx ly lz ma gt jo"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="6d14" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><code class="fe ml mm mn mc b">./src/controllers/SubscriptionController.ts</code></p><figure class="lx ly lz ma gt jo"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="95c4" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><code class="fe ml mm mn mc b">./src/routers/SubscriptionRoute.ts</code></p><figure class="lx ly lz ma gt jo"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="f092" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">最后申请<code class="fe ml mm mn mc b">SubscriptionRoute</code>申请:</p><p id="f63f" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><code class="fe ml mm mn mc b">./src/ApiApp.ts</code></p><figure class="lx ly lz ma gt jo"><div class="bz fp l di"><div class="mw mx l"/></div></figure><h2 id="f7c4" class="mg kv in bd kw oi oj dn la ok ol dp le kg om on li kk oo op lm ko oq or lq os bi translated">客户端</h2><p id="51c4" class="pw-post-body-paragraph jv jw in jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated">更新<code class="fe ml mm mn mc b">./public/scripts/main.ts</code>中的<code class="fe ml mm mn mc b">updateSubscriptionOnServer</code>功能订阅/取消订阅:</p><figure class="lx ly lz ma gt jo"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="9a20" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">保存所有文件并重新加载浏览器。那就试着看看MongoDB的<code class="fe ml mm mn mc b">cats_news_push</code>收藏吧。</p><pre class="lx ly lz ma gt mb mc md me aw mf bi"><span id="ae09" class="mg kv in mc b gy mh mi l mj mk">$ docker compose exec mongodb</span><span id="13d8" class="mg kv in mc b gy my mi l mj mk"># In docker container<br/>$ mongo<br/>&gt; use cats_news_push<br/>&gt; db.subscriptions.find({}).pretty()</span></pre><p id="e479" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">输出如下所示:</p><pre class="lx ly lz ma gt mb mc md me aw mf bi"><span id="0891" class="mg kv in mc b gy mh mi l mj mk">{<br/>        "_id" : ObjectId("609f926c591101f7ed1a020e"),<br/>        "userId" : "c860cf1a-ba56-4fe9-b575-33a43b40dd6c",<br/>        "endpoint" : "<a class="ae kt" href="https://fcm.googleapis.com/fcm/send/fz1Fk7x05XY:APA91bF2m6Pl30yCjAivz787XIZEm4UF5SpshifmzbLEh-MRKSMAsrDaMfZwN4uYhUItVD-BLTTuQx4V1vWWwHRCUIi626SD1LzNQZJNzItGNpctp92TjzUg8LaL5DzVUd0a0PSy70jk" rel="noopener ugc nofollow" target="_blank">https://fcm.googleapis.com/fcm/send/fz1Fk7x05XY:x</a>xxx",<br/>        "expirationTime" : null,<br/>        "keys" : {<br/>                "p256dh" : "BC7fA_62dG3jc3lN9POVbANyxx",<br/>                "auth" : "O8gfelLkzxxx"<br/>        },<br/>        "createdAt" : ISODate("2021-05-15T09:20:44.288Z"),<br/>        "updatedAt" : ISODate("2021-05-15T09:20:44.288Z"),<br/>        "__v" : 0<br/>}</span></pre><h1 id="e5dd" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">推送通知</h1><p id="15ad" class="pw-post-body-paragraph jv jw in jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated">我们将创建一个允许通过用户id向客户端浏览器发送通知的API。</p><p id="7706" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">首先，创建一个使用<code class="fe ml mm mn mc b">web-push</code>向订阅发送通知的功能。</p><p id="3e40" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><code class="fe ml mm mn mc b">./src/libs/WebPush.ts</code></p><figure class="lx ly lz ma gt jo"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="737b" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">功能<code class="fe ml mm mn mc b">pushtoSubscription</code>接收<code class="fe ml mm mn mc b">subscription</code>、<code class="fe ml mm mn mc b">data</code>作为参数。</p><p id="ce24" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">Web-push的<a class="ae kt" href="https://gist.github.com/hoangsetup/f6a84f3851560afb5d2b6bde288869ce" rel="noopener ugc nofollow" target="_blank"> sendNotification </a>函数将被调用，其中的选项包括<code class="fe ml mm mn mc b">publicKey</code>和<code class="fe ml mm mn mc b">privateKey</code>——我们在上一步中生成的密钥。</p><p id="f035" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><code class="fe ml mm mn mc b">.env</code></p><pre class="lx ly lz ma gt mb mc md me aw mf bi"><span id="acd2" class="mg kv in mc b gy mh mi l mj mk">PORT=3000<br/>MONGO_URI="mongodb://localhost:27017/cats_news_push"</span><span id="07fc" class="mg kv in mc b gy my mi l mj mk">RABBITMQ_USERNAME=rabbitmq<br/>RABBITMQ_PASSWORD=r@bb1tmq</span><span id="cef4" class="mg kv in mc b gy my mi l mj mk">VAPID_PUBLIC_KEY=BPUJMX4Zxxxx<br/>VAPID_PRIVATE_KEY=kKY_b2jGGxxx</span></pre></div><div class="ab cl mp mq hr mr" role="separator"><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu"/></div><div class="ig ih ii ij ik"><p id="d19d" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><code class="fe ml mm mn mc b">./src/NotificationController.ts</code></p><figure class="lx ly lz ma gt jo"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="41b4" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><code class="fe ml mm mn mc b">./src/routers/NotificationRoute.ts</code></p><figure class="lx ly lz ma gt jo"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="3a63" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">然后，为我们的应用注册<code class="fe ml mm mn mc b">NotificationRoute</code>:</p><p id="6818" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><code class="fe ml mm mn mc b">./src/ApiApp.ts</code></p><figure class="lx ly lz ma gt jo"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="5f5d" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">现在，让我们尝试通过调用<code class="fe ml mm mn mc b">POST /notifications/:userId</code>向用户推送通知</p><pre class="lx ly lz ma gt mb mc md me aw mf bi"><span id="e9a2" class="mg kv in mc b gy mh mi l mj mk">curl --location --request POST '<a class="ae kt" href="http://localhost:3000/notifications/c860cf1a-ba56-4fe9-b575-33a43b40dd6c'" rel="noopener ugc nofollow" target="_blank">http://localhost:3000/notifications/c860cf1a-ba56-4fe9-b575-33a43b40dd6c'</a> \<br/>--header 'Content-Type: application/json' \<br/>--data-raw '{<br/>    "title": "Cats news",<br/>    "message": "We noticed you left something in your cart!"<br/>}'</span></pre><figure class="lx ly lz ma gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/b94d40370f84241b2109bbe831b503a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GhsvLTU1qu1uieYvuxIFEQ.png"/></div></div></figure><p id="d284" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">它仍然显示带有默认标题和正文新通知。因为我们还没有处理推体。</p><p id="15b8" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">更新<code class="fe ml mm mn mc b">./public/sw.js</code></p><figure class="lx ly lz ma gt jo"><div class="bz fp l di"><div class="mw mx l"/></div></figure><h1 id="0697" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">异步处理推送任务</h1><p id="f2f9" class="pw-post-body-paragraph jv jw in jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated">如您所见，一个用户可以有多个订阅(针对每个浏览器、每个设备)，我们的系统将有多个用户。当我们想要通知所有用户一个通知时，发送过程将在我们的主过程上花费大量时间，并且API超时应该被延长。</p><p id="7ff7" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">让我们将任务分配给另一个人——消费者，而不是在主流程中处理发送任务。我们使用RabbitMQ作为消息代理，在主流程(生产者和消费者)之间进行通信。</p><p id="a564" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我们使用<a class="ae kt" href="https://www.npmjs.com/package/amqp" rel="noopener ugc nofollow" target="_blank"> amqp </a>与RabbitMQ合作。</p><pre class="lx ly lz ma gt mb mc md me aw mf bi"><span id="b29a" class="mg kv in mc b gy mh mi l mj mk">$ npm install amqp -S<br/>$ npm install @types/amqp -D</span></pre><p id="6734" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在<code class="fe ml mm mn mc b">.env</code>文件中设置默认连接信息和队列名称:</p><pre class="lx ly lz ma gt mb mc md me aw mf bi"><span id="e766" class="mg kv in mc b gy mh mi l mj mk">PORT=3000<br/>MONGO_URI="mongodb://localhost:27017/cats_news_push"</span><span id="152a" class="mg kv in mc b gy my mi l mj mk">RABBITMQ_USERNAME=rabbitmq<br/>RABBITMQ_PASSWORD=r@bb1tmq</span><span id="f4ed" class="mg kv in mc b gy my mi l mj mk">RABBITMQ_HOST=localhost<br/>RABBITMQ_PORT=5672<br/>RABBITMQ_PUSH_QUEUE=push_notification_task</span><span id="79ed" class="mg kv in mc b gy my mi l mj mk">VAPID_PUBLIC_KEY=BPUJMX4ZNDRv0GwxE-uU5mmTIo6ntzPZz1RVgm67bxC-wJJnX_Nux27YAG_Ilz9_BgH__snMhL4cGDJnTTcURks<br/>VAPID_PRIVATE_KEY=kKY_b2jGG3NmfaWKYwI_0oNExScO1nO2YpdHXJtcM80</span></pre><h2 id="2d51" class="mg kv in bd kw oi oj dn la ok ol dp le kg om on li kk oo op lm ko oq or lq os bi translated">生产者</h2><p id="86ef" class="pw-post-body-paragraph jv jw in jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated"><code class="fe ml mm mn mc b">./src/libs/RabbitMQHelper.ts</code></p><figure class="lx ly lz ma gt jo"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="e370" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">更新<code class="fe ml mm mn mc b">NotificationController.ts</code>以更新<code class="fe ml mm mn mc b">pushNoticationToUser</code>函数并创建<code class="fe ml mm mn mc b">pushAll</code>函数。</p><figure class="lx ly lz ma gt jo"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="225a" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">只需向队列发送数据并完成HTTP请求。使用<code class="fe ml mm mn mc b">pushAll</code>功能，如果订阅数量超过100，我们会将数据拆分成许多项。</p><h2 id="1a5d" class="mg kv in bd kw oi oj dn la ok ol dp le kg om on li kk oo op lm ko oq or lq os bi translated">消费者</h2><p id="306c" class="pw-post-body-paragraph jv jw in jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated">消费者进程将独立于主进程运行。<strong class="jx io">我们可以运行多个消费者实例。</strong></p><p id="c471" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><code class="fe ml mm mn mc b">./src/RabbitMQConsumer.ts</code></p><figure class="lx ly lz ma gt jo"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="8fef" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">从<code class="fe ml mm mn mc b">.env</code>文件加载配置。监听队列，从消息内容中获取<code class="fe ml mm mn mc b">subscriptions</code>列表和通知正文，并推送通知。</p></div><div class="ab cl mp mq hr mr" role="separator"><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu"/></div><div class="ig ih ii ij ik"><p id="f33e" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在新的终端窗口中，让我们启动消费者进程:</p><pre class="lx ly lz ma gt mb mc md me aw mf bi"><span id="b0e8" class="mg kv in mc b gy mh mi l mj mk">$ node ./dist/RabbitMQConsumer.js<br/>[*] Waiting for messages in push_notification_task. To exit press CTRL+C</span></pre><p id="0a64" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">调用<code class="fe ml mm mn mc b">POST /notifications</code> API向所有用户发送通知:</p><pre class="lx ly lz ma gt mb mc md me aw mf bi"><span id="3857" class="mg kv in mc b gy mh mi l mj mk">curl --location --request POST '<a class="ae kt" href="http://localhost:3000/notifications'" rel="noopener ugc nofollow" target="_blank">http://localhost:3000/notifications'</a> \<br/>--header 'Content-Type: application/json' \<br/>--data-raw '{<br/>    "title": "Cats news",<br/>    "message": "We noticed you left something in your cart!"<br/>}'</span></pre><p id="e6d0" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在消费者终端窗口中，将出现一条日志消息:</p><pre class="lx ly lz ma gt mb mc md me aw mf bi"><span id="a102" class="mg kv in mc b gy mh mi l mj mk">[x] Received {"subscriptions":[{"keys":{"p256dh":"BC7fA_xxx","auth":"O8xxx"},"_id":"609f926c591101f7ed1a020e","userId":"c860cf1a-ba56-4fe9-b575-33a43b40dd6c","endpoint":"<a class="ae kt" href="https://fcm.googleapis.com/fcm/send/fz1Fk7x05XY:APA91bF2m6Pl30yCjAivz787XIZEm4UF5SpshifmzbLEh-MRKSMAsrDaMfZwN4uYhUItVD-BLTTuQx4V1vWWwHRCUIi626SD1LzNQZJNzItGNpctp92TjzUg8LaL5DzVUd0a0PSy70jk" rel="noopener ugc nofollow" target="_blank">https://fcm.googleapis.com/fcm/send/fz1Fk7x05XY:APA91bFx</a>","expirationTime":null,"createdAt":"2021-05-15T09:20:44.288Z","updatedAt":"2021-05-15T09:20:44.288Z","__v":0},{"keys":{"p256dh":"BC7fA_xxxx","auth":"O8gfexxxx"},"_id":"609fde12bd09d43761cba485","userId":"a041cc76-bac7-4a51-bc2c-920ad9ab6f60","endpoint":"<a class="ae kt" href="https://fcm.googleapis.com/fcm/send/fz1Fk7x05XY:APA91bF2m6Pl30yCjAivz787XIZEm4UF5SpshifmzbLEh-MRKSMAsrDaMfZwN4uYhUItVD-BLTTuQx4V1vWWwHRCUIi626SD1LzNQZJNzItGNpctp92TjzUg8LaL5DzVUd0a0PSy70jk" rel="noopener ugc nofollow" target="_blank">https://fcm.googleapis.com/fcm/send/fz1Fk7x05XY:APx</a>x","expirationTime":null,"createdAt":"2021-05-15T14:43:30.072Z","updatedAt":"2021-05-15T14:43:30.072Z","__v":0}],"body":{"title":"Cats news","message":"We noticed you left something in your cart!"}}</span></pre><p id="1cd0" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">确保您的客户端浏览器仍能收到通知。</p><p id="4fbb" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">仅此而已！</p><h1 id="e00e" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">摘要</h1><p id="3530" class="pw-post-body-paragraph jv jw in jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated">我们完成了一个使用异步系统的例子。希望我的文章能为你提出一些“关键词”，你能更好的在你的系统中实现事情。</p><p id="81b2" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">该项目的完整代码已经发布在<a class="ae kt" href="https://github.com/codetheworld-io/ts-rabbitMQ" rel="noopener ugc nofollow" target="_blank"> Github </a>上。</p><p id="63d3" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">感谢您的阅读！</p><p id="12b6" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><em class="mo">更多内容尽在</em><a class="ae kt" href="http://plainenglish.io/" rel="noopener ugc nofollow" target="_blank">T5】plain English . ioT7】</a></p></div></div>    
</body>
</html>