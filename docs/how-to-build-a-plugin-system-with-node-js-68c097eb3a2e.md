# 如何用 Node.js 构建插件系统

> 原文：<https://javascript.plainenglish.io/how-to-build-a-plugin-system-with-node-js-68c097eb3a2e?source=collection_archive---------3----------------------->

![](img/a53d20c39947268f0c9ac5b3fb1448ec.png)

Photo by [Thomas Jensen](https://unsplash.com/@thomasjsn?utm_source=medium&utm_medium=referral) on [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral)

如果你正在构建一个极简的产品，但是想要增加额外的定制或者扩展，那么插件是一个很好的方法。它们允许用任何人都可以创建的额外代码定制每个实例。

在本教程中，我们将用一个插件系统扩展一个最小的 web 服务器，创建一个插件，并在服务器上使用该插件。我已经创建了一个非常基本的网络服务器。我们将用它作为起始代码。

# 什么是插件

但是在我们开始之前，什么是插件？插件是一段额外的代码，它扩展了程序通常能做的事情。Web 扩展就是一个很好的例子。他们利用现有的 API，并在其上构建新的功能。在某些情况下，它们还可以用来修补主要软件提供商尚未解决的错误和缺陷。

在本教程中，我们将构建一个请求计数插件，以及加载和卸载该插件的系统。

# 入门指南

让我们首先创建一个新的 Node.js 项目。我将在本教程中使用 NPM，但我也会添加纱线命令。

1.  `mkdir my-plugin-app`
2.  `cd my-plugin-app`
3.  `npm init -y` ( `yarn init -y`)
4.  `npm i express` ( `yarn add express`)

我们不会为我们的插件系统创建一个应用程序。相反，我们将使用这个起始代码。只有一个端点的简单服务器。创建一个`index.js`文件并添加这个启动代码。

# **我们的第一个插件**

为了了解我们的插件系统将会做什么，让我们创建一个包含插件需要的所有东西的小插件。我们将要实现的插件系统类型有两个事件。`load`和`unload`是我们将直接调用插件中任何代码的两次。`load`设置任何额外的路由、中间件或任何其他插件的一部分，而`unload`告诉我们安全地停止我们正在做的任何事情并保存任何持久数据。

这个插件将建立一个中间件来统计我们收到的请求数量。此外，它将添加一个 API 路由，这样我们就可以查询到目前为止已经发出的请求的数量。该插件将导出两个不同的函数，每个事件一个。

# **加载插件**

我们的插件系统将与主应用程序放在一个单独的类中，我们将把它放在一个新文件`plugins.js`中。这个类的目的是加载和卸载插件。

`load`函数获取一个插件文件的路径，并使用`require`方法在运行时加载它。`loadFromConfig`方法允许我们加载配置文件中定义的插件。

我们将使用一个`plugins.json`文件来存储我们希望加载的所有插件的路径，然后调用`loadFromConfig`方法来一次性加载它们。将`plugins.json`文件放在与代码相同的目录中。

最后，我们将在应用程序中创建一个插件实例。导入`Plugins`类，在构造函数中创建一个实例，调用`loadFromConfig`，将路径留空(默认为`./plugins.json`)。

# **卸载插件**

我们现在需要处理从插件中导出的`unload`方法。一旦我们这样做了，我们需要从插件集合中删除它。我们还将包含一个`stop`方法，它将卸载所有插件。我们稍后将使用这种方法来实现安全关机。

# **安全关机**

为了确保插件在应用关闭时有机会卸载，我们需要调用`Plugins.stop`。在`index.js`代码中，我包含了一个`stop`方法，当应用程序被终止时会调用这个方法，我们刚刚在`Plugins`类中添加了一个`stop`方法。所以当我们的 app `stop`方法被调用时，我们就调用`Plugins.stop`方法。

将以下内容添加到`App.stop`方法中。

# **结论**

插件很酷，我们可以毫不费力地将它们添加到我们的应用程序中。插件系统可能比我在这里介绍的要复杂得多，但是现在你已经对什么是插件有了基本的了解，并且知道如何构建一个系统来为应用程序添加插件。

# **挑战**

我们只是触及了表面，所以这里有一些挑战，让你更进一步。

*   添加一些检查，以确保在每个插件中都导出了“load”和“unload”方法。
*   增加了对节点包的支持，可以作为一个插件使用，而不是一个单独的文件。在加载模块之前，请注意安装依赖项。
*   最后，将此添加到您自己的项目中。找一个可以进行额外定制的项目，尝试添加你自己的插件管理器。

*更多内容看*[***plain English . io***](http://plainenglish.io/)