<html>
<head>
<title>Redis at the Edge with Cloudflare Workers</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Redis与Cloudflare工人站在一起</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/redis-at-the-edge-with-cloudflare-workers-c5181da0c66e?source=collection_archive---------13-----------------------#2021-06-15">https://javascript.plainenglish.io/redis-at-the-edge-with-cloudflare-workers-c5181da0c66e?source=collection_archive---------13-----------------------#2021-06-15</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/b3a95a21a79d96d6f2b030b7987f02aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CQTTFatVWioyLpeTgUYYsA.png"/></div></div></figure><p id="055d" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">边缘计算是近年来最令人兴奋的功能之一。CDN可以让你的文件离用户更近。边缘计算使您能够在离用户更近的地方运行应用。这有助于开发人员构建全球分布的高性能应用程序。</p><p id="8147" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">Cloudflare Workers是目前该领域的领先产品。它给你一个没有冷启动的无服务器处理环境。您可以利用Cloudflare的全球网络来最大限度地减少应用程序的延迟。你可以用JavaScript，Rust，C和C++写你的函数。</p><p id="df48" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">类似于无服务器功能(AWS Lambda等。)，Cloudflare工作人员是无国籍的。正如你在<a class="ae kt" href="https://workers.cloudflare.com/node" rel="noopener ugc nofollow" target="_blank"> Cloudflare的调查</a>中看到的，开发人员正在询问从Edge功能连接他们的数据库的方法。不幸的是，大多数数据库不是为无服务器环境设计的，它们需要持久连接。我们在Redis上开发了REST API，使无服务器的edge函数能够以最简单、最快的方式访问Upstash。</p><h1 id="8bac" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">与Cloudflare Workers KV比较</h1><p id="6911" class="pw-post-body-paragraph jv jw in jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated">Cloudflare有一个基本的键值存储，可以用来存储Edge函数的状态。Upstash Redis在几个方面优于Cloudflare KV:</p><ul class=""><li id="12da" class="lx ly in jx b jy jz kc kd kg lz kk ma ko mb ks mc md me mf bi translated">Cloudflare KV仅提供基本的获取/设置/删除功能。Upstash为您提供了所有Redis数据结构，您可以在其中构建更复杂的功能(哈希、列表、排序集、范围、追加、增量等)。</li><li id="2b6f" class="lx ly in jx b jy mg kc mh kg mi kk mj ko mk ks mc md me mf bi translated">Cloudflare KV旨在从Cloudflare生态系统中访问，而您可以从任何地方访问和使用Upstash Redis，因为它支持Redis和REST API。您可以将数据从Edge卸载到Redis，然后由任何Redis客户端处理。</li><li id="411f" class="lx ly in jx b jy mg kc mh kg mi kk mj ko mk ks mc md me mf bi translated">Cloudflare KV针对读取繁重的应用程序进行了优化。写入可能需要60秒才能复制到其他位置。对于Upstash，写入延迟以毫秒为单位。</li></ul><p id="7427" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">现在让我们编写一个简单的示例来展示Cloudflare+Redis组合的强大功能。</p><h1 id="bb3e" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">边缘分析</h1><p id="6f31" class="pw-post-body-paragraph jv jw in jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated">网络分析是所有网站所有者非常普遍的需求。谷歌分析是强大的，但许多开发者不喜欢与谷歌分享他们的流量数据，并向用户的浏览器注入cookies。由于您的网站流量来自CDN，您可以在边缘层轻松跟踪您的流量。在这里，我们将实现一个非常简单的示例来展示如何跟踪来自Cloudflare Workers的用户流量。我们将拦截Cloudflare Workers中的流量，并将用户请求保存到Upstash Redis。然后，我们将编写一个基本的独立应用程序，它将分析请求，并在选定的一天给我以下信息:</p><ul class=""><li id="f6dc" class="lx ly in jx b jy jz kc kd kg lz kk ma ko mb ks mc md me mf bi translated">页面视图</li><li id="5d17" class="lx ly in jx b jy mg kc mh kg mi kk mj ko mk ks mc md me mf bi translated">独特的访问者</li><li id="d318" class="lx ly in jx b jy mg kc mh kg mi kk mj ko mk ks mc md me mf bi translated">游客数量最多的国家</li><li id="f2c1" class="lx ly in jx b jy mg kc mh kg mi kk mj ko mk ks mc md me mf bi translated">最常访问的页面</li></ul><h1 id="da13" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">设置</h1><p id="5614" class="pw-post-body-paragraph jv jw in jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated">如果您没有数据库，请按照本<a class="ae kt" href="https://docs.upstash.com/" rel="noopener ugc nofollow" target="_blank">指南</a>创建一个数据库。在数据库页面中，单击REST API按钮并复制REST URL。如果你有一个Cloudflare帐户，你可以创建一个Workers函数，或者你也可以在没有帐户的情况下使用<a class="ae kt" href="https://cloudflareworkers.com/#36ebe026bf3510a2e5acace89c09829f:about:blank" rel="noopener ugc nofollow" target="_blank"> the playground </a>。</p><h1 id="3a57" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">Cloudflare工人代码</h1><p id="5efa" class="pw-post-body-paragraph jv jw in jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated">Cloudflare Workers函数接受<code class="fe ml mm mn mo b">request</code>作为参数。使用Upstash的REST API，我将请求记录到Redis列表中。我使用当前日期作为Redis列表的关键字。因此，我们将每天的请求记录在单独的列表中。</p><p id="2a25" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">Upstash REST API需要一个端点和一个令牌。创建数据库后，您可以从控制台点击<code class="fe ml mm mn mo b">REST API</code>按钮<a class="ae kt" href="https://console.upstash.com/" rel="noopener ugc nofollow" target="_blank">复制端点和令牌。使用以下代码更新您的Cloudflare Workers函数，替换端点和令牌:</a></p><figure class="mp mq mr ms gt jo"><div class="bz fp l di"><div class="mt mu l"/></div></figure><h1 id="f90e" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">分析工具代码</h1><p id="0e10" class="pw-post-body-paragraph jv jw in jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated">现在让我们编写一个简单的命令行应用程序，它将日期作为参数，并返回我们的分析数据。创建一个文件夹并运行<code class="fe ml mm mn mo b">npm init</code>。然后用<code class="fe ml mm mn mo b">npm install ioredis</code>安装Redis客户端。将<code class="fe ml mm mn mo b">.env.example</code>复制为<code class="fe ml mm mn mo b">.env</code>文件，并设置你的Redis URL (ioredis)。使用以下内容更新index.js:</p><figure class="mp mq mr ms gt jo"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="0deb" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">现在你可以用<code class="fe ml mm mn mo b">node index 2021-6-16</code>或者仅仅用<code class="fe ml mm mn mo b">node index</code>来运行你的应用程序。后一个将查询今天。</p><figure class="mp mq mr ms gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mv"><img src="../Images/fcab6b7706eb7fc6096829b510484c2b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*yQYCu15jQdqXbdEk.png"/></div></div></figure><p id="09fc" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">你可以把这个例子当作一个起点。您可以根据您的分析需求开发一个包含图表和表格的富web应用程序。您可以使用其他Redis数据结构进行更强大的分析。</p><h1 id="7ec7" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">Upstash Edge路线图</h1><p id="2afe" class="pw-post-body-paragraph jv jw in jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated">REST API是我们Edge故事的第一步。我们计划今年进行两项重要的开发。</p><ul class=""><li id="7ba1" class="lx ly in jx b jy jz kc kd kg lz kk ma ko mb ks mc md me mf bi translated">边缘缓存:现在，所有的REST请求都到达数据库区域。我们将很快支持边缘缓存，因此您的REST请求将在全球所有边缘位置进行缓存。这将使Upstash Redis能够像Cloudflare KV一样在全球范围内提供低延迟。</li><li id="350c" class="lx ly in jx b jy mg kc mh kg mi kk mj ko mk ks mc md me mf bi translated">全局复制数据库:全局(多区域)复制会将您的数据复制到多个区域。因此所有请求(Redis和REST API)都将到达最近的位置。这将为您提供全局低延迟，同时对一致性的牺牲最小。</li></ul><p id="7979" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我计划写一篇博客，专门介绍我们的Edge路线图。请继续关注我们的推特。</p></div><div class="ab cl mw mx hr my" role="separator"><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb"/></div><div class="ig ih ii ij ik"><p id="1b3b" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><em class="nd">原载于2021年6月15日</em><a class="ae kt" href="https://blog.upstash.com/redis-cloudflare-workers" rel="noopener ugc nofollow" target="_blank"><em class="nd">【https://blog.upstash.com】</em></a><em class="nd">。</em></p><h2 id="38ac" class="ne kv in bd kw nf ng dn la nh ni dp le kg nj nk li kk nl nm lm ko nn no lq np bi translated">进一步阅读</h2><div class="nq nr gp gr ns nt"><a href="https://bit.cloud/blog/how-to-build-a-reusable-cloudflare-worker-component-l4bf0swo" rel="noopener  ugc nofollow" target="_blank"><div class="nu ab fo"><div class="nv ab nw cl cj nx"><h2 class="bd io gy z fp ny fr fs nz fu fw im bi translated">如何构建可重用的Cloudflare Worker组件</h2><div class="oa l"><h3 class="bd b gy z fp ny fr fs nz fu fw dk translated">生成和部署无服务器Cloudflare worker的过程非常简单:派生一个现有的Cloudflare…</h3></div><div class="ob l"><p class="bd b dl z fp ny fr fs nz fu fw dk translated">比特云</p></div></div><div class="oc l"><div class="od l oe of og oc oh jt nt"/></div></div></a></div><p id="e315" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><em class="nd">更多内容看</em> <a class="ae kt" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="jx io"> <em class="nd">说白了。报名参加我们的</em> <a class="ae kt" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="jx io"> <em class="nd">免费周报</em> </strong> </a> <em class="nd">。关注我们上</em> <a class="ae kt" href="https://twitter.com/inPlainEngHQ" rel="noopener ugc nofollow" target="_blank"> <strong class="jx io"> <em class="nd">推特</em> </strong> </a>，<a class="ae kt" href="https://www.linkedin.com/company/inplainenglish/" rel="noopener ugc nofollow" target="_blank"><strong class="jx io"><em class="nd">LinkedIn</em></strong></a><strong class="jx io"><em class="nd">，</em></strong><a class="ae kt" href="https://www.youtube.com/channel/UCtipWUghju290NWcn8jhyAw" rel="noopener ugc nofollow" target="_blank"><strong class="jx io"><em class="nd">YouTube</em></strong></a><strong class="jx io"><em class="nd">，以及</em></strong><em class="nd"><a class="ae kt" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"><strong class="jx io"><em class="nd">不和</em> </strong> </a></em> </strong> <em class="nd">对成长黑客感兴趣？检查出</em> </a><a class="ae kt" href="https://circuit.ooo/" rel="noopener ugc nofollow" target="_blank"> <strong class="jx io"> <em class="nd">电路</em> </strong> </a> <strong class="jx io"> <em class="nd">。</em>T75】</strong></p></div></div>    
</body>
</html>