<html>
<head>
<title>Scheduling Tasks on Heroku</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Heroku上计划任务</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/scheduling-tasks-on-heroku-ebfa63c124dd?source=collection_archive---------9-----------------------#2021-05-15">https://javascript.plainenglish.io/scheduling-tasks-on-heroku-ebfa63c124dd?source=collection_archive---------9-----------------------#2021-05-15</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="f194" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">使用Heroku调度程序在Heroku上免费运行Cron任务</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/f73102bd5ed66402c380bfc2f90cfd09.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wygngCBGvBdSaUsiy9sdkQ.png"/></div></div></figure><h1 id="fa1c" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">涉及的步骤</h1><ol class=""><li id="6cf6" class="ls lt in jm b jn lu jr lv jv lw jz lx kd ly kh lz ma mb mc bi translated">使用<em class="md"> node-cron </em>在本地运行Cron任务</li><li id="2f65" class="ls lt in jm b jn me jr mf jv mg jz mh kd mi kh lz ma mb mc bi translated">在本地<em class="md">检查要执行的任务</em></li><li id="9497" class="ls lt in jm b jn me jr mf jv mg jz mh kd mi kh lz ma mb mc bi translated">在<em class="md"> Heroku服务器</em>上部署变更</li><li id="7d1e" class="ls lt in jm b jn me jr mf jv mg jz mh kd mi kh lz ma mb mc bi translated">通过<strong class="jm io"> <em class="md"> Heroku调度器</em> </strong>在Heroku上调度任务</li></ol><blockquote class="mj mk ml"><p id="e22f" class="jk jl md jm b jn jo jp jq jr js jt ju mm jw jx jy mn ka kb kc mo ke kf kg kh ig bi translated">Cronjobs可以通过npm包—<a class="ae mp" href="https://www.npmjs.com/package/cron" rel="noopener ugc nofollow" target="_blank">node—cron</a>在本地运行。但是在Heroku中，由node_cron调度的作业不会在您的空闲dynos休眠时运行，也就是说，如果cron的执行被安排在您的服务器离线的时候，那么它就不会工作。为此，我们使用<em class="in"/><a class="ae mp" href="https://devcenter.heroku.com/articles/scheduler" rel="noopener ugc nofollow" target="_blank"><strong class="jm io">Heroku scheduler</strong></a><em class="in"/>来执行Cron任务(我们可以使用自由计划为每<strong class="jm io"> 10分钟</strong>或<strong class="jm io"> 1小时</strong>或<strong class="jm io"> 1天</strong>安排一个任务)。这里我以每10分钟运行一个API为例。</p></blockquote><h1 id="ea2a" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated"><strong class="ak">使用node-cron在本地运行Cron任务</strong></h1><p id="8ccd" class="pw-post-body-paragraph jk jl in jm b jn lu jp jq jr lv jt ju jv mq jx jy jz mr kb kc kd ms kf kg kh ig bi translated">Node-Cron是一个非常简单而强大的npm包，通过它我们可以轻松地调度从几秒到几天或几个月不等的不同时间段的任务。要从本地开始，请遵循以下步骤→</p><ol class=""><li id="12f2" class="ls lt in jm b jn jo jr js jv mt jz mu kd mv kh lz ma mb mc bi translated">在终端中安装cron</li><li id="dc34" class="ls lt in jm b jn me jr mf jv mg jz mh kd mi kh lz ma mb mc bi translated">在您的JavaScript文件中使用以下代码—</li></ol><pre class="kj kk kl km gt mw mx my mz aw na bi"><span id="864a" class="nb kv in mx b gy nc nd l ne nf"><strong class="mx io">var CronJob = require('cron').CronJob;</strong></span><span id="6f23" class="nb kv in mx b gy ng nd l ne nf"><strong class="mx io">var job = new CronJob('* * * * * *', function() {</strong></span><span id="ed81" class="nb kv in mx b gy ng nd l ne nf"><strong class="mx io">console.log('You will see this message every second');<br/>// ENTER YOUR TASK HERE</strong></span><span id="fba2" class="nb kv in mx b gy ng nd l ne nf"><strong class="mx io">}, null, true, 'America/Los_Angeles');</strong></span><span id="5518" class="nb kv in mx b gy ng nd l ne nf"><strong class="mx io">job.start();</strong></span></pre><p id="6999" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">3.星号表示两次执行之间的时间段。您可以使用<a class="ae mp" href="https://crontab.cronhub.io/" rel="noopener ugc nofollow" target="_blank"> crontab </a>计算周期</p><h1 id="e70d" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">在本地检查要执行的任务<em class="nh"/></h1><p id="c1d4" class="pw-post-body-paragraph jk jl in jm b jn lu jp jq jr lv jt ju jv mq jx jy jz mr kb kc kd ms kf kg kh ig bi translated">调用corn函数内部的API来重复执行它。可以使用各种方法调用API，在这里检查所有这些<a class="ae mp" href="https://levelup.gitconnected.com/all-possible-ways-of-making-an-api-call-in-plain-javascript-c0dee3c11b8b" rel="noopener ugc nofollow" target="_blank"/>。在示例中，我使用Axios来调用API。</p><h1 id="fa94" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">在Heroku服务器上部署更改</h1><p id="2534" class="pw-post-body-paragraph jk jl in jm b jn lu jp jq jr lv jt ju jv mq jx jy jz mr kb kc kd ms kf kg kh ig bi translated">一旦确认node-cron和任务执行工作正常，我们就必须对Heroku调度程序进行必要的修改。<em class="md">如果在任务中执行任何API，它必须被托管，并且不能在本地主机上。这是因为Heroku调度程序创建了一个单独的服务器并在那里执行文件。</em></p><ol class=""><li id="2553" class="ls lt in jm b jn jo jr js jv mt jz mu kd mv kh lz ma mb mc bi translated">在根目录下创建一个“bin”文件夹。</li><li id="da9f" class="ls lt in jm b jn me jr mf jv mg jz mh kd mi kh lz ma mb mc bi translated">将JavaScript文件添加到“bin”文件夹中(例如→ <em class="md"> bin/Schedulertest.js </em>)。</li><li id="8be3" class="ls lt in jm b jn me jr mf jv mg jz mh kd mi kh lz ma mb mc bi translated">这个javascript文件的内容将定期执行。因此，将任务代码添加到这个文件中，而不添加node-cron(例如任何API调用)。</li><li id="9e2a" class="ls lt in jm b jn me jr mf jv mg jz mh kd mi kh lz ma mb mc bi translated">向Heroku服务器添加、提交和推送更改。</li></ol><h1 id="f8c5" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">通过<strong class="ak"> <em class="nh"> Heroku调度器</em> </strong>在Heroku上调度任务</h1><p id="c2bd" class="pw-post-body-paragraph jk jl in jm b jn lu jp jq jr lv jt ju jv mq jx jy jz mr kb kc kd ms kf kg kh ig bi translated">现在，我们已经成功地设置了环境和代码，以便在Node.js中使用Heroku scheduler。</p><p id="39c8" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">从终端(<a class="ae mp" href="https://devcenter.heroku.com/articles/scheduler#installing-the-add-on" rel="noopener ugc nofollow" target="_blank">指令</a>)或通过<strong class="jm io">网站→应用程序→资源→插件</strong>安装Heroku-Scheduler插件</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ni"><img src="../Images/a343f356c0b9bf0b3efd293ffe237795.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SX-_7qrbnlqWJRv_cF6gKA.png"/></div></div><figcaption class="nj nk gj gh gi nl nm bd b be z dk">Heroku dashboard to add “Heroku Scheduler”</figcaption></figure><p id="544f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">打开调度程序并添加作业及其频率。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nn"><img src="../Images/abc62876fdd2e844254dae92b82807e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AeUNfWoiUKanWI9EDaDnPA.png"/></div></div></figure><p id="c243" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">就是这样。是的，你没看错，<strong class="jm io">任务调度设置完成</strong>。保存作业并享受Heroku调度程序的功能。</p><p id="a6b5" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">可以通过Heroku add-on -&gt; <a class="ae mp" href="https://elements.heroku.com/addons/one-off-metrics" rel="noopener ugc nofollow" target="_blank"> <em class="md">一次性动态指标</em> </a>确认工作。或者，我们可以在文件中安慰一些要定期执行的东西。使用“Heroku logs--tail”在网站或终端上打开Heroku的日志，以确保其正常工作。</p><p id="30a7" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">这里是我的基本代码和设置库</strong>。如果需要，一定要提出问题，如果对你有帮助，就开始吧。</p><div class="no np gp gr nq nr"><a href="https://github.com/Srezzx/Herokuscheduler" rel="noopener  ugc nofollow" target="_blank"><div class="ns ab fo"><div class="nt ab nu cl cj nv"><h2 class="bd io gy z fp nw fr fs nx fu fw im bi translated">Srezzx/Herokuscheduler</h2><div class="ny l"><h3 class="bd b gy z fp nw fr fs nx fu fw dk translated">描述Heroku调度程序基本工作的存储库</h3></div><div class="nz l"><p class="bd b dl z fp nw fr fs nx fu fw dk translated">github.com</p></div></div><div class="oa l"><div class="ob l oc od oe oa of ks nr"/></div></div></a></div><p id="b916" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><em class="md">感谢阅读，希望有所帮助！:)</em></p><p id="80cf" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><em class="md">更多内容请看</em><a class="ae mp" href="http://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><em class="md">plain English . io</em></a></p></div></div>    
</body>
</html>