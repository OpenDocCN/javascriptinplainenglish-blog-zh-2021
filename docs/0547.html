<html>
<head>
<title>How to test stdout output in Node.js</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Node.js中测试stdout输出</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/how-to-test-stdout-output-in-node-js-6c36edc610d1?source=collection_archive---------6-----------------------#2021-02-02">https://javascript.plainenglish.io/how-to-test-stdout-output-in-node-js-6c36edc610d1?source=collection_archive---------6-----------------------#2021-02-02</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/dd1996e4d5963dd494019a23ac6fb03b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fBdE_gJHFkqh8U1oWpxZXg.png"/></div></div></figure><p id="de02" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我写这篇文章是为了给那些一直在寻找像这样的术语的人:</p><ul class=""><li id="5079" class="kt ku in jx b jy jz kc kd kg kv kk kw ko kx ks ky kz la lb bi translated">如何在节点中测试标准输出</li><li id="2d2b" class="kt ku in jx b jy lc kc ld kg le kk lf ko lg ks ky kz la lb bi translated">如何使用Jest监视Node中的stdout</li><li id="617c" class="kt ku in jx b jy lc kc ld kg le kk lf ko lg ks ky kz la lb bi translated">如何在节点中存根stdout</li></ul><p id="16fe" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><em class="lh">这花了我一天的时间，但是多亏了我的同事</em><a class="ae li" href="https://github.com/jransome" rel="noopener ugc nofollow" target="_blank"><em class="lh">James Ransome</em></a><em class="lh">建议使用Node的child_process来做这件事，最后还是相当容易的！</em></p><p id="8d28" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">注:</strong>如果你赶时间，我整理了一份回购协议，你可以在这里克隆:<a class="ae li" href="https://github.com/nkhil/testing-stdout" rel="noopener ugc nofollow" target="_blank">https://github.com/nkhil/testing-stdout</a></p><h1 id="c455" class="lj lk in bd ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg bi translated"><strong class="ak">我想测试Pino到stdout的输出</strong></h1><p id="ba5c" class="pw-post-body-paragraph jv jw in jx b jy mh ka kb kc mi ke kf kg mj ki kj kk mk km kn ko ml kq kr ks ig bi translated"><strong class="jx io">注意</strong> : <em class="lh">我知道这可以算作测试一个依赖项的实现细节，但是在这个例子中，我正在开发一个定制的记录器库，它包装了Pino并做了一些额外的事情。Pino决定在v6.x.x中引入突破性的变化，日志记录字符串和logger.info(string，object)之类的对象不会像预期的那样工作(它们会忽略第二个参数)</em></p><p id="debe" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">测试用例基本如下:</p><pre class="mm mn mo mp gt mq mr ms mt aw mu bi"><span id="6d1e" class="mv lk in mr b gy mw mx l my mz">// when I log multiple params using the logger<br/>logger.info('something1', 'something2');</span><span id="5ba5" class="mv lk in mr b gy na mx l my mz">// then I see this in stdout<br/>{"level":30,"time":1612227699012,"msg":"something1 something2","pid":69753,"hostname":"whatever","v":1}</span></pre><p id="135a" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">一旦我们能够访问输出，我们就能够JSON.parse()它，并断言上面例子中msg的值。</p><h2 id="27e5" class="mv lk in bd ll nb nc dn lp nd ne dp lt kg nf ng lx kk nh ni mb ko nj nk mf nl bi translated">工作解决方案✅</h2><p id="23d2" class="pw-post-body-paragraph jv jw in jx b jy mh ka kb kc mi ke kf kg mj ki kj kk mk km kn ko ml kq kr ks ig bi translated">解决方案是在node中生成一个子进程，然后监听。(' data ')事件来做我们的断言。</p><p id="e4d0" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">设置</strong></p><p id="c720" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">创建一个使用日志记录器的文件，或者您想要测试的记录到stdout的任何代码。</p><figure class="mm mn mo mp gt jo"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="871e" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">测试</strong></p><figure class="mm mn mo mp gt jo"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="8c82" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">快速解释一下上面的测试是怎么回事</strong></p><ul class=""><li id="d6ba" class="kt ku in jx b jy jz kc kd kg kv kk kw ko kx ks ky kz la lb bi translated">我们设置了一个日志文件，它将把事情记录到stdout(上面例子中的logger.js)</li><li id="9cc7" class="kt ku in jx b jy lc kc ld kg le kk lf ko lg ks ky kz la lb bi translated">我们产生了一个新的子进程</li><li id="dbed" class="kt ku in jx b jy lc kc ld kg le kk lf ko lg ks ky kz la lb bi translated">我们使用新产生的子进程来运行<code class="fe no np nq mr b">node logger.js</code>(它将事情记录到标准输出中</li><li id="8fa8" class="kt ku in jx b jy lc kc ld kg le kk lf ko lg ks ky kz la lb bi translated">我们使用<code class="fe no np nq mr b">child_process.stdout.on('data', (data) =&gt; &lt;do stuff with data&gt;)</code>模式“监听”正在记录的数据。</li><li id="6370" class="kt ku in jx b jy lc kc ld kg le kk lf ko lg ks ky kz la lb bi translated">我们<code class="fe no np nq mr b">JSON.parse()</code>这些数据，让我们断言我们注销的值</li><li id="c86c" class="kt ku in jx b jy lc kc ld kg le kk lf ko lg ks ky kz la lb bi translated">最后一步:利润💲💲💲</li></ul><h2 id="e2cb" class="mv lk in bd ll nb nc dn lp nd ne dp lt kg nf ng lx kk nh ni mb ko nj nk mf nl bi translated">我们尝试过但没有成功的事情🙅</h2><p id="838d" class="pw-post-body-paragraph jv jw in jx b jy mh ka kb kc mi ke kf kg mj ki kj kk mk km kn ko ml kq kr ks ig bi translated">最初，我们试图直接使用EventEmitter的<code class="fe no np nq mr b">.on('data', (callback) =&gt; {})</code>而不产生子进程。我对<code class="fe no np nq mr b">child_process</code>还是很陌生，所以我不确定为什么这个不行。</p><p id="5949" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我试过的另一个不起作用的方法是使用Jest监视stdout。幸运的是，我发现<a class="ae li" href="https://github.com/facebook/jest/issues/9984" rel="noopener ugc nofollow" target="_blank">这个最近的Jest问题</a>暗示，由于Jest是如何编写的，这不会起作用。</p><h2 id="e64a" class="mv lk in bd ll nb nc dn lp nd ne dp lt kg nf ng lx kk nh ni mb ko nj nk mf nl bi translated">结论</h2><p id="7987" class="pw-post-body-paragraph jv jw in jx b jy mh ka kb kc mi ke kf kg mj ki kj kk mk km kn ko ml kq kr ks ig bi translated">希望这对你有帮助。如果我有什么地方错了，或者你想补充，我会很感激你的评论让我知道。</p></div></div>    
</body>
</html>