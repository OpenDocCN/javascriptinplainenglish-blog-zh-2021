<html>
<head>
<title>Testing a Component in Vue.js</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">测试Vue.js中的组件</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/test-driving-a-list-component-in-vue-js-c162724e4fe8?source=collection_archive---------11-----------------------#2021-03-10">https://javascript.plainenglish.io/test-driving-a-list-component-in-vue-js-c162724e4fe8?source=collection_archive---------11-----------------------#2021-03-10</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="f754" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">应用TDD开发列表显示组件</h2></div><h1 id="1ba2" class="kc kd in bd ke kf kg kh ki kj kk kl km jt kn ju ko jw kp jx kq jz kr ka ks kt bi translated">语境</h1><p id="1500" class="pw-post-body-paragraph ku kv in kw b kx ky jo kz la lb jr lc ld le lf lg lh li lj lk ll lm ln lo lp ig bi translated">我需要创建一个Vue.js组件，显示一系列带有特定信息的<code class="fe lq lr ls lt b">Post</code>对象。它是一个创建和实践TDD的简单组件。</p><p id="3692" class="pw-post-body-paragraph ku kv in kw b kx lu jo kz la lv jr lc ld lw lf lg lh lx lj lk ll ly ln lo lp ig bi translated">我会用一个默认的<a class="ae lz" href="https://cli.vuejs.org/" rel="noopener ugc nofollow" target="_blank"> <strong class="kw io"> Vue-CLI </strong> </a> Vue 2项目，和<a class="ae lz" href="https://vue-test-utils.vuejs.org/" rel="noopener ugc nofollow" target="_blank"><strong class="kw io">@ Vue/test-utils</strong></a>with<a class="ae lz" href="https://jestjs.io/" rel="noopener ugc nofollow" target="_blank"><strong class="kw io">jest</strong></a><strong class="kw io"/>来试驾一下。与后端同事商定的职位资源结构是:</p><pre class="ma mb mc md gt me lt mf mg aw mh bi"><span id="c4ec" class="mi kd in lt b gy mj mk l ml mm">const post = {<br/>  id: 1,<br/>  title: "Test driving a list component in Vue.js.",<br/>  readTimeEstimate: "4 minutes read.",<br/>  publishedAt: new Date("Mar 01 2021"),<br/>  postContentSynopsis: "How to test drive a list component"<br/>}</span></pre><h1 id="dd17" class="kc kd in bd ke kf kg kh ki kj kk kl km jt kn ju ko jw kp jx kq jz kr ka ks kt bi translated">初始设置</h1><p id="737e" class="pw-post-body-paragraph ku kv in kw b kx ky jo kz la lb jr lc ld le lf lg lh li lj lk ll lm ln lo lp ig bi translated">我们需要添加所需的测试工具，你可以在<a class="ae lz" href="https://vue-test-utils.vuejs.org/installation/#using-vue-test-utils-with-jest-recommended" rel="noopener ugc nofollow" target="_blank"> <strong class="kw io"> @vue/test-utils </strong>文档</a>中阅读如何安装。</p><p id="2ae7" class="pw-post-body-paragraph ku kv in kw b kx lu jo kz la lv jr lc ld lw lf lg lh lx lj lk ll ly ln lo lp ig bi translated">首先，我们看一下客户提供的需求。对于帖子列表，我们只需要在一个列表中显示所有的帖子。但是对于每个帖子，我们需要:</p><ul class=""><li id="be09" class="mn mo in kw b kx lu la lv ld mp lh mq ll mr lp ms mt mu mv bi translated">显示发布数据</li><li id="ff2d" class="mn mo in kw b kx mw la mx ld my lh mz ll na lp ms mt mu mv bi translated">显示发布日期，格式:<code class="fe lq lr ls lt b">mm dd, yyyy</code></li><li id="6d80" class="mn mo in kw b kx mw la mx ld my lh mz ll na lp ms mt mu mv bi translated">点击后重定向到帖子显示页面(/posts/:id)</li></ul><p id="5b78" class="pw-post-body-paragraph ku kv in kw b kx lu jo kz la lv jr lc ld lw lf lg lh lx lj lk ll ly ln lo lp ig bi translated">我们也有一个高级模型作为参考:</p><figure class="ma mb mc md gt nc gh gi paragraph-image"><div role="button" tabindex="0" class="nd ne di nf bf ng"><div class="gh gi nb"><img src="../Images/74992e7ab041d7596384589eae2556f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iTSMx4ox_WO4vdrJR-oKmA.png"/></div></div><figcaption class="nj nk gj gh gi nl nm bd b be z dk">High level mockup for post list components</figcaption></figure><h1 id="33d1" class="kc kd in bd ke kf kg kh ki kj kk kl km jt kn ju ko jw kp jx kq jz kr ka ks kt bi translated">首次测试</h1><p id="774d" class="pw-post-body-paragraph ku kv in kw b kx ky jo kz la lb jr lc ld le lf lg lh li lj lk ll lm ln lo lp ig bi translated">遵循TDD过程，我开始创建<code class="fe lq lr ls lt b">PostListItem.spec.js</code>和一个空的<code class="fe lq lr ls lt b">PostListItem.vue</code>，以及我能想到的最简单的测试，断言组件呈现文章标题:</p><figure class="ma mb mc md gt nc"><div class="bz fp l di"><div class="nn no l"/></div></figure><p id="9e0f" class="pw-post-body-paragraph ku kv in kw b kx lu jo kz la lv jr lc ld lw lf lg lh lx lj lk ll ly ln lo lp ig bi translated">与<code class="fe lq lr ls lt b">yarn jest</code>一起跑步时:</p><figure class="ma mb mc md gt nc gh gi paragraph-image"><div role="button" tabindex="0" class="nd ne di nf bf ng"><div class="gh gi np"><img src="../Images/bff3d86dafe8482cf288e5713710cab7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*F4eVGfukvWk3QBtj5wIHHg.png"/></div></div><figcaption class="nj nk gj gh gi nl nm bd b be z dk">Failing test</figcaption></figure><p id="2b79" class="pw-post-body-paragraph ku kv in kw b kx lu jo kz la lv jr lc ld lw lf lg lh lx lj lk ll ly ln lo lp ig bi translated">我们有一个失败的测试，这很好，我们在红色州。继续进行TDD，我们需要编写尽可能简单的代码来通过测试。在这种情况下，我们只需要用文章标题制作一个<code class="fe lq lr ls lt b">h1</code>。</p><figure class="ma mb mc md gt nc"><div class="bz fp l di"><div class="nn no l"/></div></figure><p id="a60f" class="pw-post-body-paragraph ku kv in kw b kx lu jo kz la lv jr lc ld lw lf lg lh lx lj lk ll ly ln lo lp ig bi translated">再次运行测试:</p><figure class="ma mb mc md gt nc gh gi paragraph-image"><div role="button" tabindex="0" class="nd ne di nf bf ng"><div class="gh gi np"><img src="../Images/6a0b39ad662f9a340d27fd8c422b9884.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xb7Ec79K6SsEIpdDQIon8Q.png"/></div></div></figure><p id="c163" class="pw-post-body-paragraph ku kv in kw b kx lu jo kz la lv jr lc ld lw lf lg lh lx lj lk ll ly ln lo lp ig bi translated">每次我在绿州的时候我都喜欢提交，因为这样我就有一个检查点可以回去了。</p><h1 id="054b" class="kc kd in bd ke kf kg kh ki kj kk kl km jt kn ju ko jw kp jx kq jz kr ka ks kt bi translated">测试其他帖子属性显示</h1><p id="b3ee" class="pw-post-body-paragraph ku kv in kw b kx ky jo kz la lb jr lc ld le lf lg lh li lj lk ll lm ln lo lp ig bi translated">我们还需要该组件来显示阅读时间，出版格式和文章摘要。我们可以使用第一个测试中的相同策略，检查组件是否包含所需的文本:</p><figure class="ma mb mc md gt nc"><div class="bz fp l di"><div class="nn no l"/></div></figure><p id="8f33" class="pw-post-body-paragraph ku kv in kw b kx lu jo kz la lv jr lc ld lw lf lg lh lx lj lk ll ly ln lo lp ig bi translated">再次运行测试将导致失败。我们又一次站在了红色州。我们需要编写尽可能少的代码来通过测试:</p><figure class="ma mb mc md gt nc"><div class="bz fp l di"><div class="nn no l"/></div></figure><p id="902c" class="pw-post-body-paragraph ku kv in kw b kx lu jo kz la lv jr lc ld lw lf lg lh lx lj lk ll ly ln lo lp ig bi translated">运行测试，看到我们又回到了绿色状态，这是提交的最佳时机。请注意，我还没有格式化<code class="fe lq lr ls lt b">published_at</code>日期，这不在我们刚刚编写的测试范围内。让我们扩展我们的测试套件来保证这个功能。</p><h1 id="6c6b" class="kc kd in bd ke kf kg kh ki kj kk kl km jt kn ju ko jw kp jx kq jz kr ka ks kt bi translated">测试已发布_日期</h1><p id="62f6" class="pw-post-body-paragraph ku kv in kw b kx ky jo kz la lb jr lc ld le lf lg lh li lj lk ll lm ln lo lp ig bi translated">为了验证组件是否显示了正确的格式化日期，我们需要用<code class="fe lq lr ls lt b">setProps</code>方法传递不同的<code class="fe lq lr ls lt b">publishedAt</code>属性。测试看起来会像这样:</p><figure class="ma mb mc md gt nc"><div class="bz fp l di"><div class="nn no l"/></div></figure><p id="42c4" class="pw-post-body-paragraph ku kv in kw b kx lu jo kz la lv jr lc ld lw lf lg lh lx lj lk ll ly ln lo lp ig bi translated">通过运行测试来确认我们处于红色状态。为了让它们通过，我将创建一个计算属性，该属性将格式化日期并返回其格式化字符串。你可以使用第三方库，如<code class="fe lq lr ls lt b">momentjs</code>或<code class="fe lq lr ls lt b">date-fns</code>，我将只使用Javascript的默认<code class="fe lq lr ls lt b">Date</code>包。</p><figure class="ma mb mc md gt nc"><div class="bz fp l di"><div class="nn no l"/></div></figure><p id="177c" class="pw-post-body-paragraph ku kv in kw b kx lu jo kz la lv jr lc ld lw lf lg lh lx lj lk ll ly ln lo lp ig bi translated">在继续之前，我们的规范中有一些重复的代码。在绿色状态的最后一次提交的支持下，我们可以尝试一些重构。我可以看到3种提取帮助函数的方法:</p><ol class=""><li id="2893" class="mn mo in kw b kx lu la lv ld mp lh mq ll mr lp nq mt mu mv bi translated">发布对象创建</li><li id="cbd9" class="mn mo in kw b kx mw la mx ld my lh mz ll na lp nq mt mu mv bi translated">包装创建</li><li id="0256" class="mn mo in kw b kx mw la mx ld my lh mz ll na lp nq mt mu mv bi translated">格式化日期断言</li></ol><p id="b44f" class="pw-post-body-paragraph ku kv in kw b kx lu jo kz la lv jr lc ld lw lf lg lh lx lj lk ll ly ln lo lp ig bi translated">我会让你做这个重构，但你可以在这里找到我的代码<a class="ae lz" href="https://github.com/ps1312/simple_blog/blob/fe82901662123d677304b4e165cef1391881fd32/tests/unit/PostListItem.spec.js" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="b60d" class="pw-post-body-paragraph ku kv in kw b kx lu jo kz la lv jr lc ld lw lf lg lh lx lj lk ll ly ln lo lp ig bi translated">在删除了重复的代码并使断言更加清晰之后，让我们回头看看我们对post项的需求。我们需要确保组件在点击时重定向到post show页面(<code class="fe lq lr ls lt b">/posts/:id</code>)。</p><h1 id="57b0" class="kc kd in bd ke kf kg kh ki kj kk kl km jt kn ju ko jw kp jx kq jz kr ka ks kt bi translated">测试href标签</h1><p id="73f0" class="pw-post-body-paragraph ku kv in kw b kx ky jo kz la lb jr lc ld le lf lg lh li lj lk ll lm ln lo lp ig bi translated">我们可以通过断言<code class="fe lq lr ls lt b">href</code>设置正确来验证相同的行为，而不是测试组件是否在点击时重定向。对于测试，我们有:</p><figure class="ma mb mc md gt nc"><div class="bz fp l di"><div class="nn no l"/></div></figure><p id="9a7a" class="pw-post-body-paragraph ku kv in kw b kx lu jo kz la lv jr lc ld lw lf lg lh lx lj lk ll ly ln lo lp ig bi translated">为了通过测试，用带有<code class="fe lq lr ls lt b">:href="'/post/' + post.id</code>的锚标签包裹组件。在继续之前，您可以像前面的测试一样删除重复的测试代码，我将让您自己完成这项重构工作。</p><p id="dd9b" class="pw-post-body-paragraph ku kv in kw b kx lu jo kz la lv jr lc ld lw lf lg lh lx lj lk ll ly ln lo lp ig bi translated">你可以在这里找到重构后的代码<a class="ae lz" href="https://github.com/ps1312/simple_blog/blob/a67cc62d8ed25e976ed68815b4dd0c16e7b96c95/tests/unit/PostListItem.spec.js" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="033d" class="pw-post-body-paragraph ku kv in kw b kx lu jo kz la lv jr lc ld lw lf lg lh lx lj lk ll ly ln lo lp ig bi translated">我认为它与<code class="fe lq lr ls lt b">PostListItem.vue</code>规格都很好。现在我们只需要保证列表组件显示所提供的帖子的正确列表。</p><h1 id="45c9" class="kc kd in bd ke kf kg kh ki kj kk kl km jt kn ju ko jw kp jx kq jz kr ka ks kt bi translated">测试后列表</h1><p id="1ac5" class="pw-post-body-paragraph ku kv in kw b kx ky jo kz la lb jr lc ld le lf lg lh li lj lk ll lm ln lo lp ig bi translated">让我们首先创建我们的spec ( <code class="fe lq lr ls lt b">PostList.spec.js</code>)文件以及我们的组件(<code class="fe lq lr ls lt b">PostList.vue</code>)。我们应该做的第一个断言是，当提供一个空的<code class="fe lq lr ls lt b">posts</code>数组时，组件应该显示一个空的状态消息，在我们的例子中是<code class="fe lq lr ls lt b">No posts around here 🧐</code>。测试看起来会像这样:</p><figure class="ma mb mc md gt nc"><div class="bz fp l di"><div class="nn no l"/></div></figure><p id="edd2" class="pw-post-body-paragraph ku kv in kw b kx lu jo kz la lv jr lc ld lw lf lg lh lx lj lk ll ly ln lo lp ig bi translated">同样，我们需要保持TDD只编写最少的<em class="nr">产品代码来通过测试，在这种情况下，我们只需要一个标签:<code class="fe lq lr ls lt b">&lt;span&gt;No posts around here 🧐&lt;/span&gt;</code>来再次进入绿色状态。在那之后，是做出承诺的最佳时机。</em></p><p id="a60a" class="pw-post-body-paragraph ku kv in kw b kx lu jo kz la lv jr lc ld lw lf lg lh lx lj lk ll ly ln lo lp ig bi translated">继续我们的测试，我们现在还有两个期望要满足:</p><ol class=""><li id="842f" class="mn mo in kw b kx lu la lv ld mp lh mq ll mr lp nq mt mu mv bi translated">检查渲染的<code class="fe lq lr ls lt b">PostListItem</code>数量是否正确。</li><li id="923f" class="mn mo in kw b kx mw la mx ld my lh mz ll na lp nq mt mu mv bi translated">检查<code class="fe lq lr ls lt b">PostListItem</code>是否收到相应的<code class="fe lq lr ls lt b">post</code>作为道具。</li></ol><p id="297f" class="pw-post-body-paragraph ku kv in kw b kx lu jo kz la lv jr lc ld lw lf lg lh lx lj lk ll ly ln lo lp ig bi translated">为了检查第一个期望，我们可以使用<code class="fe lq lr ls lt b">wrapper.findAllComponents()</code>并检查长度。对于后者，我们可以遍历已经找到的组件并检查它们的属性:</p><figure class="ma mb mc md gt nc"><div class="bz fp l di"><div class="nn no l"/></div></figure><h1 id="50c8" class="kc kd in bd ke kf kg kh ki kj kk kl km jt kn ju ko jw kp jx kq jz kr ka ks kt bi translated">使href测试适应路由器链路</h1><p id="4e9b" class="pw-post-body-paragraph ku kv in kw b kx ky jo kz la lb jr lc ld le lf lg lh li lj lk ll lm ln lo lp ig bi translated">我选择了<a class="ae lz" href="https://router.vuejs.org/installation.html#direct-download-cdn" rel="noopener ugc nofollow" target="_blank"> <strong class="kw io"> VueRouter </strong> </a>处理应用程序路由，所以我需要使用<code class="fe lq lr ls lt b">router-link</code>而不是<code class="fe lq lr ls lt b">PostListItem.vue</code>中的<code class="fe lq lr ls lt b">&lt;a /&gt;</code>。在这个问题上,<code class="fe lq lr ls lt b">@vue/test-utils</code>库提供了一个很棒的<a class="ae lz" href="https://vue-test-utils.vuejs.org/guides/using-with-vue-router.html#testing-components-that-use-router-link-or-router-view" rel="noopener ugc nofollow" target="_blank">文档。简而言之，您需要向<code class="fe lq lr ls lt b">shallowMount</code>提供一个<code class="fe lq lr ls lt b">router-link</code>存根，并基于<code class="fe lq lr ls lt b">router-link</code>的标签<code class="fe lq lr ls lt b">to</code>做出断言(例如<code class="fe lq lr ls lt b">wrapper.find(`[to="/posts/${postId}"]`)</code>)。你可以在这里</a>找到我的代码<a class="ae lz" href="https://github.com/ps1312/simple_blog/blob/main/tests/unit/PostListItem.spec.js" rel="noopener ugc nofollow" target="_blank">，看<code class="fe lq lr ls lt b">assertLinkUrl()</code>。</a></p><h1 id="fca8" class="kc kd in bd ke kf kg kh ki kj kk kl km jt kn ju ko jw kp jx kq jz kr ka ks kt bi translated">最终考虑</h1><p id="ddc5" class="pw-post-body-paragraph ku kv in kw b kx ky jo kz la lb jr lc ld le lf lg lh li lj lk ll lm ln lo lp ig bi translated">这是一个很好的组成部分，了解一些具体的主题✅:</p><ol class=""><li id="f244" class="mn mo in kw b kx lu la lv ld mp lh mq ll mr lp nq mt mu mv bi translated">TDD过程(例如，失败、成功、重构)</li><li id="12d6" class="mn mo in kw b kx mw la mx ld my lh mz ll na lp nq mt mu mv bi translated">使用<code class="fe lq lr ls lt b">@vue/test-utils</code>断言文本、计算属性、属性、HTML属性和标签。</li><li id="9ed2" class="mn mo in kw b kx mw la mx ld my lh mz ll na lp nq mt mu mv bi translated">不同的选择器(例如<code class="fe lq lr ls lt b">wrapper.find</code>和<code class="fe lq lr ls lt b">wrapper.findAllComponents</code>)</li><li id="1ba1" class="mn mo in kw b kx mw la mx ld my lh mz ll na lp nq mt mu mv bi translated">短截线组件(例如<code class="fe lq lr ls lt b">router-link</code></li></ol><p id="c42e" class="pw-post-body-paragraph ku kv in kw b kx lu jo kz la lv jr lc ld lw lf lg lh lx lj lk ll ly ln lo lp ig bi translated">我们仍然需要将样式应用到组件中，但是这与TDD无关，你可以在这里找到带有样式的完整代码。</p><p id="30be" class="pw-post-body-paragraph ku kv in kw b kx lu jo kz la lv jr lc ld lw lf lg lh lx lj lk ll ly ln lo lp ig bi translated">感谢你阅读✋</p></div></div>    
</body>
</html>