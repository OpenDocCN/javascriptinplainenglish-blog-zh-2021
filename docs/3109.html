<html>
<head>
<title>Building a Push Service that Scales to 1 Million Subscribers with Firebase</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Firebase构建可扩展到100万用户的推送服务</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/building-a-push-service-that-scales-to-1m-subscribers-with-firebase-958b502a2a3d?source=collection_archive---------7-----------------------#2021-06-24">https://javascript.plainenglish.io/building-a-push-service-that-scales-to-1m-subscribers-with-firebase-958b502a2a3d?source=collection_archive---------7-----------------------#2021-06-24</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/c550002a3ba4e01f1bfc81d68c40b647.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ms8yywAn4jXEAfIKkHCUsw.jpeg"/></div></div></figure><p id="69fb" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在我们通常称之为<em class="kt">渐进式网络应用</em> (PWA)的功能网络中，有一个我一直觉得特别有趣:<strong class="jx io">推送通知</strong>。</p><p id="d350" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我构建了<a class="ae ku" href="https://progressier.com?ref=m0623" rel="noopener ugc nofollow" target="_blank"> <strong class="jx io"> Progressier </strong> </a>来帮助开发者不用写任何代码就能把任何网站变成PWA。所以，在这个过程中，我必须构建一个推送解决方案。哦，天哪…这可不容易。</p><p id="cb26" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在本文中，我将带您了解我们在Firebase/GCP开发过程中遇到的一些挑战，以及我们是如何克服这些挑战的。请注意，本文不包含任何代码片段。</p><h1 id="9afb" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">挑战1:个性化与营销</h1><p id="7827" class="pw-post-body-paragraph jv jw in jx b jy lt ka kb kc lu ke kf kg lv ki kj kk lw km kn ko lx kq kr ks ig bi translated">推送通知…它们是干什么用的？嗯，向用户发送推送通知主要有两种情况:</p><p id="5e2a" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">一个</strong>。个性化的应用内事件，例如<em class="kt">有人对自己写的帖子发表了评论</em>。</p><p id="4299" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io"> B </strong>。营销活动，例如<em class="kt">您刚刚为所有用户发布了一项新功能</em></p><p id="9cd6" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">一些解决方案(如<a class="ae ku" href="https://onesignal.com/" rel="noopener ugc nofollow" target="_blank"> OneSignal </a>或<a class="ae ku" href="https://subscribers.com/" rel="noopener ugc nofollow" target="_blank">Subscribers.com</a>)特别适合第二种用例。您向一大群订户发送相同的通知。第一个用例需要个性化—每个特定通知通常只有一个收件人。</p><p id="eb3b" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><a class="ae ku" href="https://progressier.com?ref=m0623" rel="noopener ugc nofollow" target="_blank"> <strong class="jx io"> Progressier </strong> </a>意在成为PWA功能的一体化解决方案。因此，您应该能够向某个特定用户或整个用户群发送通知——同样容易。</p><figure class="lz ma mb mc gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi ly"><img src="../Images/2980d8ce639492a1b164bd2fdc239ee3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hpxl7lh7rAJza-DpasF8zA.png"/></div></div><figcaption class="md me gj gh gi mf mg bd b be z dk">Progressier has a dashboard that lets you preview your notification on different devices</figcaption></figure><p id="be5f" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">需要注意的是，使用<em class="kt">用例B </em>，通知是可预测地发送的。因此，你只需登录<a class="ae ku" href="https://progressier.com?ref=m0623" rel="noopener ugc nofollow" target="_blank"> <strong class="jx io"> Progressier </strong> </a>仪表盘，当你有值得推送的内容<em class="kt"/>要说时(一个功能发布，你的黑色星期五销售，等等)，就可以向所有订阅者发送通知。</p><p id="a025" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">有了<em class="kt">用例A </em>，你的方法必须是程序化的。你不知道用户什么时候会评论另一个用户的帖子。所以你需要一个API。您需要将该API与您自己的代码集成在一起。每当<em class="kt">值得推送的</em>事件发生时(一个用户给你发了一条私人消息，你的信用卡过期了，有人喜欢你的帖子，等等)，你调用我们的API来通知细节。</p><p id="2bac" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">因为<a class="ae ku" href="https://progressier.com?ref=m0623" rel="noopener ugc nofollow" target="_blank"><strong class="jx io">Progressier</strong></a><strong class="jx io"/>是一个无代码解决方案，它必须适应两种用例。因此，当你注册<a class="ae ku" href="https://progressier.com?ref=m0623" rel="noopener ugc nofollow" target="_blank"> <strong class="jx io"> Progressier </strong> </a>时，你就可以同时访问仪表盘和API。所以不管你对代码有多精通，这个解决方案都会为你工作。</p><p id="8873" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">挑战是<a class="ae ku" href="https://en.wikipedia.org/wiki/Don%27t_repeat_yourself" rel="noopener ugc nofollow" target="_blank">不重复我们自己</a>。一般来说，设计架构时尽可能减少维护工作量是一个好主意。所以我们首先构建了API。然后，我们围绕API设计了仪表板。所以在幕后，仪表板实际上只是API的前端。这实际上使得测试API更加容易。</p><figure class="lz ma mb mc gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi ly"><img src="../Images/1ab48c692d25015f52687127c1df812b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tYvnejqpNNwn3UTptinVmg.png"/></div></div><figcaption class="md me gj gh gi mf mg bd b be z dk">Neat little trick: the dashboard lets you preview what the request would look like if you directly used the API. And when you click “Send now”, this is the exact request it will make.</figcaption></figure><h1 id="b8c4" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated"><strong class="ak">挑战2:连接用户数据</strong></h1><p id="a960" class="pw-post-body-paragraph jv jw in jx b jy lt ka kb kc lu ke kf kg lv ki kj kk lw km kn ko lx kq kr ks ig bi translated">大多数推送服务允许你根据地理位置、浏览器或设备对用户进行细分。细分通常是一个瓶颈。你更有可能用特定的电子邮件、特定的类型(例如免费还是付费)或特定的计划向用户发送通知。</p><p id="d693" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">一旦你在你的应用中嵌入了<a class="ae ku" href="https://progressier.com?ref=m0623" rel="noopener ugc nofollow" target="_blank"> <strong class="jx io"> Progressier </strong> </a>(实际上只有一行代码)，你就可以在<a class="ae ku" href="https://progressier.com?ref=m0623" rel="noopener ugc nofollow" target="_blank"> <strong class="jx io"> Progressier </strong> </a>的匹配用户档案中添加你自己的用户数据。因此，当需要发送通知时，您可以将刚刚连接的数据锁定为目标用户。用户登录后，您只需在客户端代码中调用以下方法。</p><figure class="lz ma mb mc gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi ly"><img src="../Images/1f7394ab4dda28a226e94224b94bea20.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*drHAEKBdAynWutN9C8oRNQ.png"/></div></div><figcaption class="md me gj gh gi mf mg bd b be z dk">Call progressier.add with your user data to add it to Progressier</figcaption></figure><p id="6662" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">挑战在于Firestore的数据查询选项有限。所以目前我们只支持<em class="kt">精确匹配查询</em>。您可以向其<em class="kt">用户类型</em>为"<em class="kt">免费</em>"、其<em class="kt">电子邮件</em>为"<em class="kt">john@example.com</em>"或其<em class="kt">国家</em>为"<em class="kt">德国"</em>"的任何人发送通知。或者两者的混合。但比如你不能针对订阅费<em class="kt">大于</em> 10美元的用户。您不能在用户配置文件中添加任何不是数字/布尔值/字符串的内容。虽然有限，但仍然比大多数推送服务提供的要多——通常只是让你给用户订阅<em class="kt">主题。</em></p><h1 id="792a" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">挑战3:统计用户数量</h1><figure class="lz ma mb mc gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi ly"><img src="../Images/b58f34d41c9382bbfa67c863853f5abc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nMosOPIqqJjzrNUMv52iwA.png"/></div></div></figure><p id="53c9" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我们的分析功能可让您随时跟踪订阅和应用安装情况。尽管看起来相当简单，但在幕后，它真的很复杂。</p><p id="8036" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">首先，没有检测应用程序安装的实际方法。不同浏览器的应用程序安装构成也不同。因此，这主要是一个猜测游戏，虽然没有完美的解决方案，但我们的方法是对实际在设备上安装给定PWA的用户数量的一个很好的估计。</p><p id="73b2" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">其次，我们的一些客户每天都有1000多名新订户在他们的应用程序中注册推送通知。因此，我们的分析不能只是在我们的客户打开分析页面时计算所有订户。这将导致非常昂贵和缓慢的查询。</p><p id="b896" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">当有人注册推送通知时，具体会发生什么:</p><ul class=""><li id="7d75" class="mh mi in jx b jy jz kc kd kg mj kk mk ko ml ks mm mn mo mp bi translated">推送订阅的端点保存在Progressier的用户配置文件中</li><li id="6ce7" class="mh mi in jx b jy mq kc mr kg ms kk mt ko mu ks mm mn mo mp bi translated">我们随机增加我们为那一天创建的500个分布式计数器中的一个。我们需要很多计数器，因为不建议每秒更新一个Firestore文档<a class="ae ku" href="https://cloud.google.com/firestore/docs/best-practices" rel="noopener ugc nofollow" target="_blank">超过一次</a>。因此，通过每天为每个应用程序创建500个计数器，我们可以在许多不同的文档上传播更新。</li><li id="6dd2" class="mh mi in jx b jy mq kc mr kg ms kk mt ko mu ks mm mn mo mp bi translated">在每天结束时(大约00:05 GMT)，一个预定的函数检索所有500个计数器，并将它们变成一个，然后将当天的最终订阅/安装数保存在一个新文档中</li><li id="5bb6" class="mh mi in jx b jy mq kc mr kg ms kk mt ko mu ks mm mn mo mp bi translated">在该预定功能期间，我们还增加了一个全局计数器，用于跟踪该特定应用的订阅/安装总数。所以你可以看到你的总数，而不必每天加载。</li></ul><h1 id="f28b" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated"><strong class="ak">挑战4:发送给100万用户</strong></h1><p id="5c4f" class="pw-post-body-paragraph jv jw in jx b jy lt ka kb kc lu ke kf kg lv ki kj kk lw km kn ko lx kq kr ks ig bi translated">下面是发送推送通知在幕后如何工作的一个小提示:</p><ol class=""><li id="ce35" class="mh mi in jx b jy jz kc kd kg mj kk mk ko ml ks mv mn mo mp bi translated">您要求用户允许您的应用程序中的通知。如果他们点击“<em class="kt">允许</em>，你会得到一个唯一的端点。根据数据库中的用户配置文件保存该端点。</li><li id="df30" class="mh mi in jx b jy mq kc mr kg ms kk mt ko mu ks mv mn mo mp bi translated">要向该特定用户发送通知，您需要从数据库中查询用户配置文件，并向该端点发出一个HTTP请求，其中包含推送通知的详细信息。</li></ol><p id="5259" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">总而言之，向用户发送推送通知并不比向任何随机端点发出POST请求复杂多少。更困难的是同时发送给多个用户。</p><p id="52e1" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">20个用户？还是容易。您只需遍历您的用户列表并发出20个HTTP请求。</p><p id="4d59" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">100万用户？你需要一个完全不同的策略。</p><p id="b921" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">秘制酱的具体配方我就不透露了，不过在<a class="ae ku" href="https://progressier.com?ref=m0623" rel="noopener ugc nofollow" target="_blank"> <strong class="jx io"> Progressier </strong> </a>中，涉及到<a class="ae ku" href="https://cloud.google.com/tasks" rel="noopener ugc nofollow" target="_blank">云任务</a>、<a class="ae ku" href="https://firebase.google.com/docs/functions/firestore-events?hl=en" rel="noopener ugc nofollow" target="_blank"> Firestore触发器</a>、<a class="ae ku" href="https://firebase.google.com/docs/firestore/query-data/query-cursors?hl=en" rel="noopener ugc nofollow" target="_blank"> Firestore分页</a>。</p><p id="c5ba" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">一旦您在<a class="ae ku" href="https://progressier.com?ref=m0623" rel="noopener ugc nofollow" target="_blank"> <strong class="jx io"> Progressier </strong> </a>仪表板中点击<em class="kt"> Send </em>(或使用我们的API)，通知的详细信息就会保存在数据库中。Firestore触发器侦听该事件，然后调用一个函数来检索应该接收该事件的所有用户的分页列表——基于您的目标。</p><p id="7037" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">然后，对于分页列表中的每个用户，服务器在云任务队列中创建一个任务。然后进入下一页用户。</p><p id="bbca" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">然后，云任务队列中的所有任务都以预定义的速率一个接一个地被处理(这样我们就不会因为一次发送给太多用户而导致整个系统崩溃！).</p><p id="2ee1" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">为此寻找合适的基础设施是一项挑战。以及更多的测试。幸运的是，我们<a class="ae ku" rel="noopener ugc nofollow" target="_blank" href="/building-a-pwa-was-our-best-idea-ever-b7b233726b41?source=your_stories_page-------------------------------------">也拥有一个超过10万用户的应用</a>我们可以在上面测试<a class="ae ku" href="https://progressier.com?ref=m0623" rel="noopener ugc nofollow" target="_blank"> <strong class="jx io"> Progressier </strong> </a>。</p><h1 id="f793" class="kv kw in bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated">结论</h1><p id="b2cf" class="pw-post-body-paragraph jv jw in jx b jy lt ka kb kc lu ke kf kg lv ki kj kk lw km kn ko lx kq kr ks ig bi translated">所以，如果你想为自己或其他开发者建立一个推送服务。希望这篇文章能帮助你理解你将要面临的一些挑战。</p><p id="b8f4" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">如果你不想花费时间和资源来建立一个，你也可以注册<a class="ae ku" href="https://progressier.com?ref=m0623" rel="noopener ugc nofollow" target="_blank"> <strong class="jx io"> Progressier </strong> </a>并在5分钟内让它在你的网站上运行。😉</p></div></div>    
</body>
</html>