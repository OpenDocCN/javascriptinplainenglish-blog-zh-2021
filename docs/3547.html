<html>
<head>
<title>React Native: Streaming Agora Cloud-Recording Videos from an S3 Bucket</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">反应本地:流Agora云记录视频从S3桶</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/react-native-streaming-agora-cloud-recording-videos-from-an-s3-bucket-1bff83e3ee49?source=collection_archive---------8-----------------------#2021-07-16">https://javascript.plainenglish.io/react-native-streaming-agora-cloud-recording-videos-from-an-s3-bucket-1bff83e3ee49?source=collection_archive---------8-----------------------#2021-07-16</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/62edf46c5393274e00712c1ee6b7bfb9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HtRsLYfoo1-QmwBh3Z7uQw.png"/></div></div></figure><p id="3904" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在<a class="ae kt" href="https://medium.com/geekculture/cloud-recording-for-react-native-video-chat-using-agora-d7669201e50f" rel="noopener">之前的博客</a>中，我们看到了如何将Agora云记录添加到视频聊天应用程序中，以便将记录存储在亚马逊S3桶中。在这里，我们将介绍如何在React本地应用程序中获取和回放录制的视频。</p><p id="10c4" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我们更新了上一篇博文中的<a class="ae kt" href="https://github.com/EkaanshArora/Agora-RN-Record-Playback" rel="noopener ugc nofollow" target="_blank">应用</a>和<a class="ae kt" href="https://github.com/EkaanshArora/Agora-Cloud-Recording-Example" rel="noopener ugc nofollow" target="_blank">后端</a>，将所有内容整合在一起。如果您只是想要演示，您可以部署后端，并从提供的链接构建应用程序。</p><h1 id="6ad8" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">先决条件</h1><ul class=""><li id="533f" class="ls lt in jx b jy lu kc lv kg lw kk lx ko ly ks lz ma mb mc bi translated">一个集市开发者<a class="ae kt" href="https://sso.agora.io/en/signup?utm_source=medium&amp;utm_medium=blog&amp;utm_campaign=react-native-streaming-agora-cloud-recording-videos-from-an-s3-bucket/" rel="noopener ugc nofollow" target="_blank">账户</a></li><li id="c340" class="ls lt in jx b jy md kc me kg mf kk mg ko mh ks lz ma mb mc bi translated">亚马逊AWS账户</li><li id="4900" class="ls lt in jx b jy md kc me kg mf kk mg ko mh ks lz ma mb mc bi translated">Heroku帐户或其他服务来部署后端</li><li id="d4b3" class="ls lt in jx b jy md kc me kg mf kk mg ko mh ks lz ma mb mc bi translated">对React Native的理解</li></ul><h1 id="bebc" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">集市设置</h1><ol class=""><li id="673a" class="ls lt in jx b jy lu kc lv kg lw kk lx ko ly ks mi ma mb mc bi translated"><strong class="jx io">创建项目:</strong>拥有Agora账户后，点击控制台中的<a class="ae kt" href="https://console.agora.io/projects" rel="noopener ugc nofollow" target="_blank">项目管理标签</a>。单击创建按钮。输入项目的名称。创建项目时选择安全模式。</li><li id="2626" class="ls lt in jx b jy md kc me kg mf kk mg ko mh ks mi ma mb mc bi translated"><strong class="jx io">启用云录制:</strong>点击查看使用情况按钮，选择启用云录制的选项。</li><li id="90a4" class="ls lt in jx b jy md kc me kg mf kk mg ko mh ks mi ma mb mc bi translated"><strong class="jx io">获取应用凭证:</strong>将应用ID和应用证书从同一个页面复制到一个文本文件中。我们以后会用到这些。</li><li id="e977" class="ls lt in jx b jy md kc me kg mf kk mg ko mh ks mi ma mb mc bi translated"><strong class="jx io">获取客户凭证:</strong>访问<a class="ae kt" href="https://console.agora.io/restfulApi" rel="noopener ugc nofollow" target="_blank"> RESTful API页面</a>并点击Add Secret按钮。将客户ID和客户机密复制到文本文件中。</li></ol><h1 id="8ca8" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">AWS设置</h1><p id="6624" class="pw-post-body-paragraph jv jw in jx b jy lu ka kb kc lv ke kf kg mj ki kj kk mk km kn ko ml kq kr ks ig bi translated">一旦你创建了一个AWS帐户，我们需要创建一个亚马逊S3桶来存储我们的视频记录和一个IAM用户来访问我们的桶。如果您已经完成了此设置，可以跳过这一部分。</p><ol class=""><li id="db2a" class="ls lt in jx b jy jz kc kd kg mm kk mn ko mo ks mi ma mb mc bi translated">去你的<a class="ae kt" href="https://console.aws.amazon.com/iam/home#/users" rel="noopener ugc nofollow" target="_blank"> AWS IAM控制台</a>创建一个用户。添加带有编程访问的AmazonS3FullAccess策略。将AWS访问密钥和秘密密钥复制到文本文件中。</li><li id="dae7" class="ls lt in jx b jy md kc me kg mf kk mg ko mh ks mi ma mb mc bi translated">创建一个亚马逊<a class="ae kt" href="https://s3.console.aws.amazon.com/s3/home" rel="noopener ugc nofollow" target="_blank"> S3桶</a>:</li></ol><figure class="mq mr ms mt gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mp"><img src="../Images/1e60235d3cb70771fcc94a1e091217bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2LAlWLeGZNd7QGibCKFEbA.png"/></div></div></figure><p id="524e" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">为您的存储桶选择一个名称，并将其复制到文本文件中。我们稍后将使用这个文本文件。通过取消选中阻止所有公共访问复选框，允许公共访问您存储桶中的流媒体。单击创建存储桶按钮。</p><p id="ad76" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">注意:</strong>有了你录音的网址，互联网上的任何人都可以观看。我们将在文章的最后讨论如何保证录音的安全。</p><p id="7ec0" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我们还需要所选AWS地区的地区号。转到这个<a class="ae kt" href="https://docs.agora.io/en/cloud-recording/cloud_recording_api_rest?platform=RESTful#a-namestorageconfigacloud-storage-configuration" rel="noopener ugc nofollow" target="_blank">表格</a>，点击亚马逊S3选项卡，并记下您的地区号。例如，如果您正在使用<code class="fe mu mv mw mx b">US_EAST_1</code>区域，那么您的存储桶编号是0。</p><p id="3078" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">3.添加存储桶策略。</p><p id="bd82" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">为了让所有用户都可以访问文件，我们将添加一个存储桶策略。转到新创建的存储桶中的Permissions选项卡，并添加此策略:</p><pre class="mq mr ms mt gt my mx mz na aw nb bi"><span id="62ee" class="nc kv in mx b gy nd ne l nf ng">{<br/>    "Version": "2012-10-17",<br/>    "Id": "Policy1620917655085",<br/>    "Statement": [<br/>        {<br/>            "Sid": "Stmt1620917653925",<br/>            "Effect": "Allow",<br/>            "Principal": "*",<br/>            "Action": "s3:GetObject",<br/>            "Resource": "arn:aws:s3:::agora-rec123/*"<br/>        }<br/>    ]<br/>}</span></pre><h1 id="d10a" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">部署我们的后端</h1><p id="2e07" class="pw-post-body-paragraph jv jw in jx b jy lu ka kb kc lv ke kf kg mj ki kj kk mk km kn ko ml kq kr ks ig bi translated">在部署我们的后端之前，我们需要以下变量。(是时候使用我们的文本文件了。)我们将使用Heroku一键式部署，让我们的后端启动和运行变得超级简单。您也可以使用任何其他服务。</p><blockquote class="nh ni nj"><p id="849c" class="jv jw nk jx b jy jz ka kb kc kd ke kf nl kh ki kj nm kl km kn nn kp kq kr ks ig bi translated"><strong class="jx io">注意:</strong>我们已经更新了后端，所以如果你使用的是上一篇文章的后端，你应该现在就更新。</p></blockquote><pre class="mq mr ms mt gt my mx mz na aw nb bi"><span id="8be5" class="nc kv in mx b gy nd ne l nf ng">APP_ID=<br/>APP_CERTIFICATE=<br/>RECORDING_VENDOR=<br/>RECORDING_REGION=<br/>BUCKET_NAME=<br/>BUCKET_ACCESS_KEY=<br/>BUCKET_ACCESS_SECRET=<br/>CUSTOMER_ID=<br/>CUSTOMER_CERTIFICATE=</span></pre><blockquote class="nh ni nj"><p id="4814" class="jv jw nk jx b jy jz ka kb kc kd ke kf nl kh ki kj nm kl km kn nn kp kq kr ks ig bi translated"><strong class="jx io">注意:</strong>对于AWS，RECORDING_VENDOR=1。点击此<a class="ae kt" href="https://docs.agora.io/en/cloud-recording/cloud_recording_api_rest?platform=RESTful#a-namestorageconfigacloud-storage-configuration" rel="noopener ugc nofollow" target="_blank">链接</a>了解更多信息。</p></blockquote><ol class=""><li id="b5c7" class="ls lt in jx b jy jz kc kd kg mm kk mn ko mo ks mi ma mb mc bi translated">如果您还没有在Heroku 上创建帐户，请创建一个。</li><li id="a450" class="ls lt in jx b jy md kc me kg mf kk mg ko mh ks mi ma mb mc bi translated">点击<a class="ae kt" href="https://heroku.com/deploy?template=https://github.com/EkaanshArora/Agora-Cloud-Recording-Example/tree/master" rel="noopener ugc nofollow" target="_blank">此链接</a>使用Heroku一键式部署。</li><li id="cda1" class="ls lt in jx b jy md kc me kg mf kk mg ko mh ks mi ma mb mc bi translated">输入您的变量，然后单击页面底部的部署应用程序按钮。</li><li id="0d43" class="ls lt in jx b jy md kc me kg mf kk mg ko mh ks mi ma mb mc bi translated">等几分钟。部署完成后，将您的后端URL保存在文本文件中，我们将在应用程序中使用该文件。</li></ol><h1 id="afda" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">构建我们的应用</h1><p id="1c20" class="pw-post-body-paragraph jv jw in jx b jy lu ka kb kc lv ke kf kg mj ki kj kk mk km kn ko ml kq kr ks ig bi translated">我们将从我们在上一篇文章中开发的应用程序开始，该应用程序允许您参加群组视频通话并进行录音。我已经重构了应用程序，将所有视频通话和录音组件都移到了<code class="fe mu mv mw mx b"><a class="ae kt" href="https://github.com/EkaanshArora/Agora-RN-Record-Playback/blob/main/components/Call.tsx" rel="noopener ugc nofollow" target="_blank">./components/Call.tsx</a></code>。我们将从一个新文件开始:<code class="fe mu mv mw mx b"><a class="ae kt" href="https://github.com/EkaanshArora/Agora-RN-Record-Playback/blob/main/components/PlayRecording.tsx" rel="noopener ugc nofollow" target="_blank">./components/PlayRecording.tsx</a></code></p><figure class="mq mr ms mt gt jo"><div class="bz fp l di"><div class="no np l"/></div></figure><p id="7fbb" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我们将使用来自<code class="fe mu mv mw mx b"><a class="ae kt" href="https://github.com/react-native-video/react-native-video" rel="noopener ugc nofollow" target="_blank">react-native-video</a></code>的视频组件进行HLS回放。我们接受后端URL、应用程序ID和频道名称作为我们的<code class="fe mu mv mw mx b">PlayRecording</code>组件的道具。我们为状态定义了一个接口。曲目将包含每个m3u8文件的URL数组。<code class="fe mu mv mw mx b">currentTrack</code>是我们正在玩的URL的索引。<code class="fe mu mv mw mx b">statusMsg</code>保存显示视频播放器当前状态的字符串。</p><figure class="mq mr ms mt gt jo"><div class="bz fp l di"><div class="no np l"/></div></figure><p id="6345" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我们定义组件和初始状态。在<code class="fe mu mv mw mx b">componentDidMount</code>中，我们对后端服务器的<code class="fe mu mv mw mx b">/api/get/recordingUrls/&lt;ChannelName&gt;</code>路由执行一个GET请求。我们得到响应JSON并更新<code class="fe mu mv mw mx b">tracks</code>状态数组。</p><figure class="mq mr ms mt gt jo"><div class="bz fp l di"><div class="no np l"/></div></figure><p id="47bb" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在我们的渲染方法中，我们使用一个<code class="fe mu mv mw mx b">ScrollView</code>返回一个包含在<code class="fe mu mv mw mx b">TouchableOpacity</code>中的曲目列表。当选择一个轨道时，我们用轨道索引更新<code class="fe mu mv mw mx b">currentTrack</code>状态。</p><figure class="mq mr ms mt gt jo"><div class="bz fp l di"><div class="no np l"/></div></figure><p id="fa4d" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我们使用将source设置为我们想要播放的URL的<code class="fe mu mv mw mx b">Video</code>组件(<code class="fe mu mv mw mx b">tracks</code>数组的<code class="fe mu mv mw mx b">currentTrack</code>索引)。我们有事件处理程序来更新我们的<code class="fe mu mv mw mx b">statusMsg</code>。我们还在文本组件中显示了<code class="fe mu mv mw mx b">statusMsg</code>。</p><h1 id="6e3d" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">把它放回原处</h1><figure class="mq mr ms mt gt jo"><div class="bz fp l di"><div class="no np l"/></div></figure><p id="c1bc" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我们使用<code class="fe mu mv mw mx b">App.tsx</code>中的<code class="fe mu mv mw mx b">PlayRecording</code>组件和<code class="fe mu mv mw mx b">Call</code>组件将所有东西放回一起。</p><blockquote class="nh ni nj"><p id="96c0" class="jv jw nk jx b jy jz ka kb kc kd ke kf nl kh ki kj nm kl km kn nn kp kq kr ks ig bi translated"><strong class="jx io">安全考虑:</strong>正如我们所讨论的，在我们当前的配置下，存储在S3存储桶上的所有记录都是公开的，因此React本地客户端可以访问它们。在我们将应用程序用于生产之前，为我们的视频设置访问控制非常重要。一旦我们对用户进行了身份验证，我们就可以授予他们访问文件的权限，同时保持文件对其他所有人都是私有的。你可以找到更多信息<a class="ae kt" href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/s3-access-control.html" rel="noopener ugc nofollow" target="_blank">在这里</a>和<a class="ae kt" href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/access-control-overview.html" rel="noopener ugc nofollow" target="_blank">在这里</a>。</p></blockquote><h1 id="8024" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">结论</h1><p id="c0c5" class="pw-post-body-paragraph jv jw in jx b jy lu ka kb kc lv ke kf kg mj ki kj kk mk km kn ko ml kq kr ks ig bi translated">你可以在这里找到更多关于云录制<a class="ae kt" href="https://docs.agora.io/en/cloud-recording/landing-page?platform=RESTful" rel="noopener ugc nofollow" target="_blank">的信息。如果你刚开始使用Agora SDKs，看看</a><a class="ae kt" href="https://docs.agora.io/en/Video/landing-page?platform=React%20Native" rel="noopener ugc nofollow" target="_blank"> Agora视频通话快速入门指南</a>和<a class="ae kt" href="https://www.agora.io/en/blog/how-to-build-a-react-native-video-calling-app-using-agora/" rel="noopener ugc nofollow" target="_blank">这篇博客</a>的帖子。</p><p id="4731" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我邀请你加入Agora开发者松弛社区。欢迎在<code class="fe mu mv mw mx b">#react-native-help-me</code>频道提出任何React原生问题，在<code class="fe mu mv mw mx b">#cloud-recording-help-me</code>频道提出云录制问题。</p><p id="e67d" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><em class="nk">更多内容请看</em><a class="ae kt" href="http://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><strong class="jx io"><em class="nk">plain English . io</em></strong></a></p></div></div>    
</body>
</html>