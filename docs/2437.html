<html>
<head>
<title>Avoid Terrible Mistakes when Deploying Websites with Git and Node</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Git和Node部署网站时避免可怕的错误</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/avoid-terrible-mistakes-when-deploying-websites-with-git-and-node-e80a6e0a3e28?source=collection_archive---------16-----------------------#2021-05-19">https://javascript.plainenglish.io/avoid-terrible-mistakes-when-deploying-websites-with-git-and-node-e80a6e0a3e28?source=collection_archive---------16-----------------------#2021-05-19</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="32ac" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们都会犯错。一些简单的安全措施可以带来很大的不同。</p><p id="7ed0" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">TLDR:在你的项目中安装<a class="ae ki" href="https://www.npmjs.com/package/git-check-stop" rel="noopener ugc nofollow" target="_blank"> git-check-stop </a>作为开发资源，这样你就不会再犯令人尴尬的构建或部署错误了。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div class="gh gi kj"><img src="../Images/1bbe85bfd34d1f29a7ac5d62d52b76f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:946/format:webp/1*bmo1-pqubXPug3jsKnZOqA.png"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">What if I type npm run deploy-live by mistake?</figcaption></figure><p id="83ef" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我敢肯定，你和我一样，从来没有打过字</p><pre class="kk kl km kn gt kv kw kx ky aw kz bi"><span id="c924" class="la lb in kw b gy lc ld l le lf">npm run deploy-live</span></pre><p id="e947" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">当你的意思是</p><pre class="kk kl km kn gt kv kw kx ky aw kz bi"><span id="3774" class="la lb in kw b gy lc ld l le lf">npm run deploy-staging</span></pre><p id="6035" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我知道。谁会犯这样的错误？不是我们。</p><p id="9c8e" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">嗯，以防万一有人过来在我们的电脑上打字，让我们采取一些安全措施。</p><p id="e4ca" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果您使用git，有大量的节点包可以帮助我们与它集成。当我在寻找一种方法来阻止自己犯下让自己后悔的错误时，我找到了两个方法:</p><h1 id="80da" class="lg lb in bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">git-状态</h1><p id="808d" class="pw-post-body-paragraph jk jl in jm b jn md jp jq jr me jt ju jv mf jx jy jz mg kb kc kd mh kf kg kh ig bi translated">这个<a class="ae ki" href="https://www.npmjs.com/package/git-status" rel="noopener ugc nofollow" target="_blank">包</a>非常有用，因为它给你的信息与你输入:</p><pre class="kk kl km kn gt kv kw kx ky aw kz bi"><span id="a586" class="la lb in kw b gy lc ld l le lf">git status -s</span></pre><p id="47dc" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在你的终端里。输出如下所示:</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div class="gh gi mi"><img src="../Images/b4f11ecea9be08b01ce56f97a611d2fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:730/format:webp/1*BGsF2u3LLVOUxvSZ1nfM4Q.png"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">One file modified. One not added.</figcaption></figure><p id="8f4a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><a class="ae ki" href="https://www.npmjs.com/package/git-status" rel="noopener ugc nofollow" target="_blank"> <strong class="jm io"> git-status </strong> </a>使用<a class="ae ki" href="https://www.npmjs.com/package/parse-git-status" rel="noopener ugc nofollow" target="_blank"><strong class="jm io">parse-git-status</strong></a>将结果作为一个JavaScript对象传递给我们，如下所示:</p><pre class="kk kl km kn gt kv kw kx ky aw kz bi"><span id="b3a9" class="la lb in kw b gy lc ld l le lf">{<br/>  x: 'A', // status code character<br/>  y: 'A', // status code character<br/>  to: 'bar.js', // the destination path<br/>  from: 'foo.js', // the source path if a rename (null otherwise)<br/>}</span></pre><p id="9621" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">出于我们的目的，我们并不真正关心返回状态的内容是什么:我们只知道如果有不止一个修改的对象，那么我们有未提交的更改。所以我们可以这样写代码:</p><pre class="kk kl km kn gt kv kw kx ky aw kz bi"><span id="4dae" class="la lb in kw b gy lc ld l le lf">const gitStatus = require('git-status')</span><span id="206d" class="la lb in kw b gy mj ld l le lf">gitStatus((err, data) =&gt; {<br/>  if(err) {<br/>    console.log('git error', err)<br/>    process.exit(1)<br/>  }<br/>  if(data.length &gt; 0) {<br/>    console.log('STOP You have ' + data.length + ' uncommitted     changes.'))<br/>    process.exit(1)<br/>  }<br/>  console.log('OK git all up to date.')<br/>})</span></pre><p id="17e8" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">还有一件事让我担心:如果所有的事情都提交了，但是我在一个实验性的分支上工作，然后我将我的代码部署到实时服务器而不是一个临时站点，那该怎么办？这也可能是一场灾难。这就是为什么我们还需要:</p><h1 id="d31b" class="lg lb in bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">git-branch</h1><p id="78aa" class="pw-post-body-paragraph jk jl in jm b jn md jp jq jr me jt ju jv mf jx jy jz mg kb kc kd mh kf kg kh ig bi translated">你可以在npm上的这里找到<a class="ae ki" href="https://www.npmjs.com/package/git-branch" rel="noopener ugc nofollow" target="_blank"> git-branch。这个实现了承诺，所以比git-status更容易处理。为了搞清楚自己在哪个分支上，就装然后；</a></p><pre class="kk kl km kn gt kv kw kx ky aw kz bi"><span id="c3f2" class="la lb in kw b gy lc ld l le lf">const branch = require('git-branch')</span><span id="2f58" class="la lb in kw b gy mj ld l le lf">branch().then((name) =&gt; {<br/>  console.log('You are on branch', name)<br/>})</span></pre><p id="dd31" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">有了这两个包，我很快就能构建一个命令行应用程序，可以使用npm的<strong class="jm io"> pre </strong>脚本运行。你可以在这里看到我在<a class="ae ki" href="https://github.com/davidmold/git-check-stop" rel="noopener ugc nofollow" target="_blank"> GitHub上整理的代码，在一个名为</a><a class="ae ki" href="https://www.npmjs.com/package/git-check-stop" rel="noopener ugc nofollow" target="_blank"><strong class="jm io">git-check-stop</strong></a>的项目中。</p><h1 id="c423" class="lg lb in bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">git-检查-停止</h1><p id="126c" class="pw-post-body-paragraph jk jl in jm b jn md jp jq jr me jt ju jv mf jx jy jz mg kb kc kd mh kf kg kh ig bi translated">你可以很容易地安装它，只需运行</p><pre class="kk kl km kn gt kv kw kx ky aw kz bi"><span id="90cb" class="la lb in kw b gy lc ld l le lf">npm install -D git-check-stop</span></pre><p id="6b0c" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">D是因为您可能只是希望它作为开发依赖项，而不是生产构建的一部分。安装后，您可以在自己的项目中使用它，为您的所有敏感操作添加<strong class="jm io"> pre </strong>脚本，这样它们会在允许您构建或部署之前测试您的git状态。例如，下面是来自Vue项目的package.json:</p><pre class="kk kl km kn gt kv kw kx ky aw kz bi"><span id="9195" class="la lb in kw b gy lc ld l le lf">...<br/>"scripts": {<br/>  "serve": "vue-cli-service serve",<br/>  "build": "vue-cli-service build",<br/>  "lint": "vue-cli-service lint",<br/>  "predeploy-staging":"npx git-check-stop",<br/>  "deploy-staging": "node deploy-staging",<br/>  "predeploy-live":"npx git-check-stop master",<br/>  "deploy-live": "node deploy-live"<br/>}<br/>...</span></pre><p id="0768" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">Npm将在运行任何具有相同名称但前缀为“pre”的脚本之前运行该脚本。这保证了如果您运行<strong class="jm io"> deploy-staging </strong>，first git-check-stop将确保您已经提交了对git存储库的所有更改。</p><p id="dec8" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">用这一行:</p><pre class="kk kl km kn gt kv kw kx ky aw kz bi"><span id="acc0" class="la lb in kw b gy lc ld l le lf">"predeploy-live":"npx git-check-stop master",</span></pre><p id="d9f9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们确保我们所有的文件都被检入，并且我们在主分支上——只是为了确保我们不会意外地从不同的分支上传任何实验代码(当然，我们不会做这样的事情)。您可以在这里使用任何名称，以确保如果您在指定的分支上，部署将<em class="mk">仅</em>运行。</p><p id="b3e2" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果您尝试运行deploy，并且有未提交的更改，您将在控制台中看到如下消息:</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div class="gh gi ml"><img src="../Images/ada498bcd4b38ec6e3692ceaec437793.png" data-original-src="https://miro.medium.com/v2/resize:fit:734/format:webp/1*_cNRdcLSlaY-z5XG_24KAA.png"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Oops</figcaption></figure><p id="3dc1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果您在一个实验分支上尝试将部署到live，您将看到如下消息:</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div class="gh gi mm"><img src="../Images/9e531b98c4171c1f2b50d5218f542dc8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1054/format:webp/1*9OxkvC0QpQ_7ujrwJmawTA.png"/></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Not that we would ever do this, of course.</figcaption></figure><p id="7e71" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我希望你觉得这是有用的。毫无疑问，这个工具可以被扩展以使编码更加安全，但是现在，它已经把我从相当多的尴尬时刻中拯救出来，我希望它也能为你做同样的事情。编码快乐！</p><p id="29a3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><em class="mk">更多内容请看</em><a class="ae ki" href="http://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><em class="mk">plain English . io</em></a></p></div></div>    
</body>
</html>