<html>
<head>
<title>We Reduced Our JavaScript SDK Load Time from 200ms to 20ms</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我们将JavaScript SDK的加载时间从200毫秒减少到了20毫秒</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/javascript-sdk-from-200ms-to-20ms-5886e0b356d2?source=collection_archive---------22-----------------------#2021-07-14">https://javascript.plainenglish.io/javascript-sdk-from-200ms-to-20ms-5886e0b356d2?source=collection_archive---------22-----------------------#2021-07-14</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/9998bbed322c4deda11aeca5ad68ac7b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JOTtBov9uehJSrV0Q212JA.png"/></div></div></figure><p id="e666" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">回到2018年<a class="ae kt" href="https://developers.google.com/web/updates/2018/07/search-ads-speed" rel="noopener ugc nofollow" target="_blank">，谷歌宣布</a>加载速度将是谷歌搜索和谷歌广告的一个因素。这在市场人士中引发了一场关于业绩的大讨论。性能一直很重要，尤其是在电子商务环境下，但当谷歌加大赌注时，它成了一个紧迫的问题。</p><p id="7a2b" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">随着谷歌和脸书等公司为即时、无摩擦的应用和网站性能设定了标准，加载速度已成为任何互联网体验的最重要因素之一。如果你的加载时间超过2秒，用户就不会在你的页面上停留足够长的时间。</p><p id="6c6a" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">网站性能可能会因为各种原因而受到影响，但这些问题通常与营销团队想要在网站上运行的JavaScript有关。从广告像素到跟踪器到CRM嵌入，每一个未优化的JavaScript SDK都被营销用来获取更多数据。</p><p id="cb95" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">值得庆幸的是，顶级公司越来越将网站速度视为一个工程问题，尤其是当加载时间直接转化为收入时。</p><p id="79af" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">虽然工程团队可能不会回避SDK营销部门需要的每一种产品，但是有一些现代工具允许工程部门在不牺牲性能的情况下为营销部门提供他们需要的数据。</p><p id="190f" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这篇文章讨论了RudderStack如何与我们的客户Loveholidays合作开发高性能<a class="ae kt" href="https://docs.rudderstack.com/rudderstack-sdk-integration-guides/rudderstack-javascript-sdk" rel="noopener ugc nofollow" target="_blank"> JavaScript SDK </a>，将执行时间从200–300毫秒减少到20–60毫秒。如果你更愿意观看我们关于这个主题的点播网上研讨会，你可以<a class="ae kt" href="https://rudderstack.com/video-library/real-time-ecommerce-analytics-with-big-query-and-rudderstack/" rel="noopener ugc nofollow" target="_blank">点击这里</a>观看。</p><h1 id="e3ba" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">问题是</h1><p id="cc6c" class="pw-post-body-paragraph jv jw in jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated">影响网页性能的主要因素之一是所使用的第三方库。这些库有两种方法来减缓加载时间:</p><ul class=""><li id="51b6" class="lx ly in jx b jy jz kc kd kg lz kk ma ko mb ks mc md me mf bi translated">必须将库加载到浏览器中。如果图书馆有相当大的规模，我们将不得不等待。</li><li id="6b16" class="lx ly in jx b jy mg kc mh kg mi kk mj ko mk ks mc md me mf bi translated">库执行任务。在许多情况下，他们必须通过网络通信来执行这些任务，这增加了延迟。</li></ul><p id="186e" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">还有其他因素。例如，库可能有缺陷或缺乏优化的实现，这是任何软件产品生命周期中的常见问题。虽然可以理解，但如果一个网站加载太慢，漏洞和缓慢的代码确实会影响收入。</p><h1 id="3dd3" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">站点速度和方向舵堆栈JavaScript SDK</h1><p id="6f4a" class="pw-post-body-paragraph jv jw in jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated">对于RudderStack这样的产品，事情就更复杂了。以下是与性能相关的两个主要复杂性:</p><h1 id="8c93" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">目标集成影响库大小</h1><p id="128d" class="pw-post-body-paragraph jv jw in jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated">RudderStack JavaScript SDK就像我们客户的网站和他们发送数据的许多不同目的地之间的中间件。目标需求因客户而异，因此库的最终大小可能会有很大变化。</p><h1 id="d7f2" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">用户定义的JSON有效负载的变化</h1><p id="be4c" class="pw-post-body-paragraph jv jw in jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated">额外性能复杂性的另一个原因是RudderStack Javascript SDK必须提供的有效负载。</p><p id="2d3a" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">具体来说，当检测到DOM发生特定变化时，RudderStack用户定义通过网络发送的任意JSON文档。由于DOM受到用户操作的影响，一些元数据被捕获并包含在有效载荷中。然后，该库确保JSON文档以正确的顺序交付给服务器。</p><h1 id="ba2e" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">走向解决</h1><p id="e0ef" class="pw-post-body-paragraph jv jw in jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated">由于以上两个条件，在SDK部署到生产环境之前，很难在所有库使用中提供一致的体验或关于性能的理由。</p><p id="17e4" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">一段时间以来，我们一直致力于提高JavaScript SDK的性能，特别是因为我们为多家企业电子商务公司提供服务，但我们有幸在Loveholidays与David Annez一起完成并测试了高性能库。</p><p id="6d56" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我们是这样做的。</p><h1 id="367d" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">提高JavaScript SDK的性能</h1><p id="1a68" class="pw-post-body-paragraph jv jw in jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated">我们前面提到的两个问题需要不同的策略来提高速度。我们将首先解释我们是如何处理任意大小的已用库的。</p><h1 id="e039" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">缩小图书馆的规模</h1><p id="be9e" class="pw-post-body-paragraph jv jw in jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated">就其本身而言，JavaScript SDK的初始大小很小。当需要支持本地目的地时，问题就出现了。</p><p id="b93f" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">本地目的地是数据被直接推入其中的任何目的地，而不是将数据发送到方向舵堆栈数据平面并将其路由到应用。例如，我们的许多客户通过RudderStack JavaScript SDK原生运行Google Analytics、Hotjar和Firebase SDKs。其中一个主要原因是性能，但也有目的地不提供公开可用的API的情况。无论如何，这是必须的。</p><p id="b07d" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">获取本地库不可避免地增加了延迟；然而，主要的问题是，随着我们支持更多的库，更多的工具被添加到RudderStack JavaScript SDK中，并且它的大小也增加了。</p><h1 id="02bf" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">解决方案:仅加载您需要的内容</h1><p id="125d" class="pw-post-body-paragraph jv jw in jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated">这里的高级解决方案非常简单，这在很大程度上要归功于David和他的团队的一些好想法。</p><p id="6fbc" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在基本层面上，高性能JavaScript SDK没有将终端目的地的插装代码捆绑在核心SDK中。相反，SDK只从RudderStack仪表板获取目的地配置设置(如track ID、API key、secret等。)使用<code class="fe ml mm mn mo b">requireIntegration_</code>方法。</p><p id="28bd" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">让我们看一个简单的例子，看看这在实践中是如何工作的。</p><p id="0b3d" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">一旦JavaScript SDK接收到类似于<code class="fe ml mm mn mo b">rudderanalytics.requireIntegration("GA")</code>的调用，它就会自动获取Google Analytics instrumentation代码(例如GAPlugin.js ),该代码处理RudderStack事件有效负载的转换和映射逻辑。这包括调用类型和API调用。</p><p id="6b30" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">核心SDK为所有调用维护一个队列。当一个<code class="fe ml mm mn mo b">requireIntegration</code>调用发生时，任何相关的调用被排队，SDK开始获取必要的库。完成后，队列将开始执行入队的调用。</p><p id="be61" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">通过这种策略实现了以下目标:</p><ul class=""><li id="4d17" class="lx ly in jx b jy jz kc kd kg lz kk ma ko mb ks mc md me mf bi translated">只有在需要时(或者换句话说，只有在发生需要库的调用时)，才会将任何本地库提取到客户端。</li><li id="b6bc" class="lx ly in jx b jy mg kc mh kg mi kk mj ko mk ks mc md me mf bi translated">同时，任何后续的调用都被排队，所以在客户机上没有阻塞，因此没有额外的性能损失。</li><li id="d344" class="lx ly in jx b jy mg kc mh kg mi kk mj ko mk ks mc md me mf bi translated">这种策略允许JavaScript库保持最小的大小，并确保页面首次加载的速度损失尽可能小。</li></ul><p id="2472" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">通过实现上述内容并删除不必要的集成片段，Loveholidays的加载时间比之前的解决方案(Segment的analytics.js)减少了近10倍。</p><p id="7938" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">受控测试记录的加载时间在20-60毫秒之间，低于200-300毫秒。</p><h1 id="e796" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">XHR与发送信标或同步与异步</h1><p id="a2bb" class="pw-post-body-paragraph jv jw in jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated">为了进一步提高我们的SDK的性能，我们决定用sendBeacon进行实验。</p><p id="b011" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><a class="ae kt" href="https://developer.mozilla.org/en-US/docs/Web/API/Navigator/sendBeacon" rel="noopener ugc nofollow" target="_blank">信标API </a>用于向web服务器异步发送少量数据。引入它的主要原因是为了分析用例，这非常适合我们许多注重性能的电子商务客户。</p><p id="0cf2" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">然而，最重要的方面是Beacon的异步特性。我们假设通过使用sendBeacon，我们可以进一步减少输入延迟。</p><h1 id="b3c0" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">细节:灯塔对XHR</h1><p id="b013" class="pw-post-body-paragraph jv jw in jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated">运行同步XHR调用进行跟踪可能会影响页面的第一个输入延迟(FID ),从而降低用灯塔之类的工具测量时的响应速度。</p><p id="7394" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我们与大卫和Loveholidays团队合作，对方向舵堆栈SDK的Beacon vs. XHR进行了A/B测试。剧透:成功了。我们看到使用Beacon时，平均FID从200 ms下降到20ms。对此的大部分理由是卸载到新RudderStack SDK支持的batch + async调用。</p><p id="4211" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这是来自爱情假期测试的真实图表:</p><figure class="mq mr ms mt gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mp"><img src="../Images/5889817f07501aa2e4ca8e602ddc89a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*HXAdmjVqsanX24Eq.png"/></div></div><figcaption class="mu mv gj gh gi mw mx bd b be z dk"><strong class="bd my">Actual Chart from the Loveholidays Test</strong></figcaption></figure><p id="2e73" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">虽然通过Beacon异步发送数据可能不适合每家公司，但它可以推动高性能敏感用例的实质性改进。</p><h1 id="6451" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">结论</h1><p id="4dbb" class="pw-post-body-paragraph jv jw in jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated">在RudderStack，我们的使命是尽可能构建性能最佳的客户数据管道。我们知道，无论我们对SDK做什么，都会影响最终用户的体验，因此，我们非常重视性能。</p><p id="4491" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我们在Javascript SDK上执行的上述更改使我们能够将SDK的执行时间从200多毫秒减少到20-60毫秒，与该领域的其他供应商相比，这不仅是一个巨大的改进，而且是一个标准设定。</p><p id="ca0e" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">当然，作为工程师，我们仍在探索许多事情来进一步提高性能。我们的下一个实验将是实现Beacon API和一个队列。</p><p id="25af" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">性能是迷人的，也越来越重要，所以请关注工程团队关于我们如何确保我们的SDK尽可能优化的更新。</p><h1 id="6568" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">免费注册并开始发送数据</h1><p id="92e0" class="pw-post-body-paragraph jv jw in jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated">测试我们的事件流、ELT和反向ETL管道。使用我们的HTTP源在不到5分钟的时间内发送数据，或者在您的网站或应用程序中安装我们12个SDK中的一个。<a class="ae kt" href="https://app.rudderlabs.com/signup?type=freetrial" rel="noopener ugc nofollow" target="_blank">入门</a>。</p><p id="31d2" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><em class="mz">本博客最初发表于:<br/></em><a class="ae kt" href="https://rudderstack.com/blog/javascript-sdk-from-200ms-to-20ms" rel="noopener ugc nofollow" target="_blank"><em class="mz">https://rudder stack . com/blog/JavaScript-SDK-from-200 ms-to-20 ms</em></a></p><p id="8d49" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><em class="mz">更多内容请看</em><a class="ae kt" href="http://plainenglish.io" rel="noopener ugc nofollow" target="_blank"><strong class="jx io"><em class="mz">plain English . io</em></strong></a></p></div></div>    
</body>
</html>