<html>
<head>
<title>Faster CSV File Reader and Processor in Node.js</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Node.js中更快的CSV文件阅读器和处理器</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/faster-csv-file-reader-and-processor-in-nodejs-e69bbc19f465?source=collection_archive---------3-----------------------#2021-06-17">https://javascript.plainenglish.io/faster-csv-file-reader-and-processor-in-nodejs-e69bbc19f465?source=collection_archive---------3-----------------------#2021-06-17</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><figure class="im in gp gr io ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi il"><img src="../Images/d0505d72e51b733a1c9394881edf1514.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/1*I4CnfQFMpJcN4v0yTU56Ew.jpeg"/></div></div></figure><div class=""/><h1 id="3b9d" class="jv jw iy bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">有什么问题？</h1><p id="8708" class="pw-post-body-paragraph kt ku iy kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq ig bi translated">首先，我想解释一下我的问题是什么，以及我是如何解决的。有一天，我的一个同事发给我一个<strong class="kv iz"> 1GB CSV </strong>(关于<strong class="kv iz"> 60M </strong>线的一些东西)文件，并说有许多客户的电话号码，其中一些是重复的，我们不需要它们。请将它们<strong class="kv iz">插入数据库</strong>，并给我表格名称。</p><h1 id="45d9" class="jv jw iy bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">一开始我做了什么？</h1><p id="a9dd" class="pw-post-body-paragraph kt ku iy kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq ig bi translated">起初，我认为这很容易，并开始逐行读取文件。<br/>对于每个数据，我通过<strong class="kv iz"> SQL查询</strong>检查数据库，如果我之前添加了这个数字，跳过插入过程，如果没有，将数字插入表中。</p><p id="5389" class="pw-post-body-paragraph kt ku iy kv b kw lr ky kz la ls lc ld le lt lg lh li lu lk ll lm lv lo lp lq ig bi translated">这样，我遇到了三个问题:</p><ol class=""><li id="6f6b" class="lw lx iy kv b kw lr la ls le ly li lz lm ma lq mb mc md me bi translated">由于<strong class="kv iz">内存限制</strong>，我无法用fs库这样的普通文件阅读器读取大文件</li><li id="3863" class="lw lx iy kv b kw mf la mg le mh li mi lm mj lq mb mc md me bi translated">为每个号码运行一个查询需要花费太多的时间。</li><li id="aa7d" class="lw lx iy kv b kw mf la mg le mh li mi lm mj lq mb mc md me bi translated"><strong class="kv iz">我无法通过这种方式运行子进程</strong>，所以需要10多天。</li></ol><h1 id="1b16" class="jv jw iy bd jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks bi translated">我是如何解决这个问题的？</h1><p id="d2c3" class="pw-post-body-paragraph kt ku iy kv b kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq ig bi translated">总结一下:</p><ul class=""><li id="cfb7" class="lw lx iy kv b kw lr la ls le ly li lz lm ma lq mk mc md me bi translated"><strong class="kv iz"> </strong> <a class="ae ml" href="https://www.npmjs.com/package/line-reader" rel="noopener ugc nofollow" target="_blank"> <strong class="kv iz">行阅读器</strong> </a>用于读取文件。</li><li id="99b8" class="lw lx iy kv b kw mf la mg le mh li mi lm mj lq mk mc md me bi translated"><strong class="kv iz"> MySQL </strong>作为<strong class="kv iz">数据库</strong></li><li id="f951" class="lw lx iy kv b kw mf la mg le mh li mi lm mj lq mk mc md me bi translated"><a class="ae ml" href="https://www.rabbitmq.com/" rel="noopener ugc nofollow" target="_blank"><strong class="kv iz">rabbit MQ</strong></a><strong class="kv iz"/>为<strong class="kv iz">消息控制</strong></li><li id="8f75" class="lw lx iy kv b kw mf la mg le mh li mi lm mj lq mk mc md me bi translated"><a class="ae ml" href="https://www.npmjs.com/package/pm2" rel="noopener ugc nofollow" target="_blank"> <strong class="kv iz"> PM2 </strong> </a>用于在后台运行服务</li></ul><p id="d3a9" class="pw-post-body-paragraph kt ku iy kv b kw lr ky kz la ls lc ld le lt lg lh li lu lk ll lm lv lo lp lq ig bi translated">起初，我决定将我的数据库表<strong class="kv iz">结构</strong>改为<strong class="kv iz">以避免</strong>使用<strong class="kv iz"> SQL查询</strong>来查找这个数字是否与<strong class="kv iz">重复</strong>。所以我把number列结构改成了unique。</p><pre class="mm mn mo mp gt mq mr ms mt aw mu bi"><span id="f9d7" class="mv jw iy mr b gy mw mx l my mz">ALTER TABLE numbers<br/>ADD CONSTRAINT constraint_name UNIQUE (number);</span></pre><p id="411e" class="pw-post-body-paragraph kt ku iy kv b kw lr ky kz la ls lc ld le lt lg lh li lu lk ll lm lv lo lp lq ig bi translated">更改后，我不会检查号码是否重复，我只是插入号码，<strong class="kv iz">数据库将决定</strong>是否是新号码。为了提高效率，我通过以下命令将索引添加到我的列中:</p><pre class="mm mn mo mp gt mq mr ms mt aw mu bi"><span id="aa9d" class="mv jw iy mr b gy mw mx l my mz">CREATE UNIQUE INDEX number_idx ON numbers (number);</span></pre></div><div class="ab cl na nb hr nc" role="separator"><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf"/></div><div class="ig ih ii ij ik"><p id="f113" class="pw-post-body-paragraph kt ku iy kv b kw lr ky kz la ls lc ld le lt lg lh li lu lk ll lm lv lo lp lq ig bi translated">为了读取文件，我开始通过<a class="ae ml" href="https://www.npmjs.com/package/line-reader" rel="noopener ugc nofollow" target="_blank"> <strong class="kv iz">行阅读器</strong> </a>包<strong class="kv iz">读取文件</strong>，因为它帮助我逐行读取文件<strong class="kv iz">缓冲</strong>和<strong class="kv iz">。但问题是，它不能是同步的，所以如果我想在读取文件时插入数据，我会得到一个错误，因为我向数据库并行发送了太多的数据。</strong></p><p id="d86e" class="pw-post-body-paragraph kt ku iy kv b kw lr ky kz la ls lc ld le lt lg lh li lu lk ll lm lv lo lp lq ig bi translated">起初，我写了这段代码:</p><pre class="mm mn mo mp gt mq mr ms mt aw mu bi"><span id="a4fd" class="mv jw iy mr b gy mw mx l my mz"><em class="nh">const </em>lineReader = require('line-reader');<br/><em class="nh">async function </em>start() {<br/>    <em class="nh">const </em>csvFile = __dirname + "/assets/data.csv";<br/>    lineReader.eachLine(csvFile, <em class="nh">async function</em>(line, last, cb) {<br/>        <em class="nh">// My insertion Process</em><br/>        cb();<br/>    });<br/>}</span></pre><p id="603f" class="pw-post-body-paragraph kt ku iy kv b kw lr ky kz la ls lc ld le lt lg lh li lu lk ll lm lv lo lp lq ig bi translated">在这之后，我决定用<strong class="kv iz"> RabbitMQ </strong>来解决这个问题。</p><p id="c4c2" class="pw-post-body-paragraph kt ku iy kv b kw lr ky kz la ls lc ld le lt lg lh li lu lk ll lm lv lo lp lq ig bi translated">我创建了两个服务，一个<strong class="kv iz">阅读器服务</strong>，一个<strong class="kv iz">插入服务</strong>，我通过RabbitMQ连接它们。</p><p id="9b28" class="pw-post-body-paragraph kt ku iy kv b kw lr ky kz la ls lc ld le lt lg lh li lu lk ll lm lv lo lp lq ig bi translated">我从阅读器服务发布数据，从插入服务读取数据并将其插入数据库。为了提高速度，我克隆了三个插入服务。</p><p id="902b" class="pw-post-body-paragraph kt ku iy kv b kw lr ky kz la ls lc ld le lt lg lh li lu lk ll lm lv lo lp lq ig bi translated">在这里，我分享我的服务准则:</p><figure class="mm mn mo mp gt ip"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="1adc" class="pw-post-body-paragraph kt ku iy kv b kw lr ky kz la ls lc ld le lt lg lh li lu lk ll lm lv lo lp lq ig bi translated">让我解释一些重要的事情:</p><ul class=""><li id="3d09" class="lw lx iy kv b kw lr la ls le ly li lz lm ma lq mk mc md me bi translated">在第<strong class="kv iz"> 23 </strong>行，我使用了<strong class="kv iz">持久</strong>因为当服务关闭时，所有的数据都会丢失。可以<strong class="kv iz">降低速度</strong>但是值得。</li><li id="96b0" class="lw lx iy kv b kw mf la mg le mh li mi lm mj lq mk mc md me bi translated">在第<strong class="kv iz"> 19 </strong>行，因为我使用的是持久数据，所以我需要有一个选项，在我需要的时候，我可以<strong class="kv iz">清除队列</strong>。</li></ul></div><div class="ab cl na nb hr nc" role="separator"><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf"/></div><div class="ig ih ii ij ik"><figure class="mm mn mo mp gt ip"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="b403" class="pw-post-body-paragraph kt ku iy kv b kw lr ky kz la ls lc ld le lt lg lh li lu lk ll lm lv lo lp lq ig bi translated">我来解释一些<strong class="kv iz">重要的</strong>事情:</p><ul class=""><li id="32e6" class="lw lx iy kv b kw lr la ls le ly li lz lm ma lq mk mc md me bi translated">在<strong class="kv iz"> 39 </strong>行中，<strong class="kv iz"> ack </strong>表示我们的服务收到了消息，流程结束，消息代理<strong class="kv iz">可以将</strong>从<strong class="kv iz">队列</strong>中移除。</li><li id="f8e0" class="lw lx iy kv b kw mf la mg le mh li mi lm mj lq mk mc md me bi translated">在第<strong class="kv iz"> 37 </strong>行中，prefetch表示消息代理在我们调用ack之前不会发送文本消息。这意味着我们的服务将逐个插入数据。</li></ul><p id="118c" class="pw-post-body-paragraph kt ku iy kv b kw lr ky kz la ls lc ld le lt lg lh li lu lk ll lm lv lo lp lq ig bi translated">由于<strong class="kv iz">预取</strong>，我们的第二个服务是一个接一个的读取数据<strong class="kv iz"/>，所以我们可以从第二个服务中打开<strong class="kv iz">多个</strong>，我们的数据库可以支持<strong class="kv iz">提高速度。</strong></p><p id="7614" class="pw-post-body-paragraph kt ku iy kv b kw lr ky kz la ls lc ld le lt lg lh li lu lk ll lm lv lo lp lq ig bi translated">部署之后，我想从我们的服务器上关闭我的<strong class="kv iz"> SSH </strong>，所以我想使用<a class="ae ml" href="https://www.npmjs.com/package/pm2" rel="noopener ugc nofollow" target="_blank"> PM2 </a>。为了管理它，我创建了一个文件，并将其命名为<strong class="kv iz"> run.json </strong></p><pre class="mm mn mo mp gt mq mr ms mt aw mu bi"><span id="b2df" class="mv jw iy mr b gy mw mx l my mz">{<br/>  "apps": [<br/>    {<br/>      "name": "reader-service",<br/>      "script": "./reader.service.js",<br/>      "autorestart": true<br/>    },<br/>    {<br/>      "name": "insertion-service-1",<br/>      "script": "./insertion-service.js",<br/>      "autorestart": true<br/>    },<br/>    {<br/>      "name": "insertion-service-2",<br/>      "script": "./insertion-service.js",<br/>      "autorestart": true<br/>    }<br/>  ]<br/>}</span></pre><p id="2172" class="pw-post-body-paragraph kt ku iy kv b kw lr ky kz la ls lc ld le lt lg lh li lu lk ll lm lv lo lp lq ig bi translated"><em class="nh">更多内容请看</em><a class="ae ml" href="http://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><em class="nh">plain English . io</em></a></p></div></div>    
</body>
</html>