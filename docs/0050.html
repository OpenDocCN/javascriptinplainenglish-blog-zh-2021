<html>
<head>
<title>React + Stripe — Accept payment through PaymentIntent API and save card details</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">React + Stripe —通过PaymentIntent API接受付款并保存卡的详细信息</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/react-stripe-accept-payment-through-paymentintent-api-and-save-card-details-aa90c55fcdb2?source=collection_archive---------7-----------------------#2021-01-04">https://javascript.plainenglish.io/react-stripe-accept-payment-through-paymentintent-api-and-save-card-details-aa90c55fcdb2?source=collection_archive---------7-----------------------#2021-01-04</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/2f52b316b8118063df1758ee76e008e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CqiSQOHNGX6pp3q-Pwyfmg.png"/></div></div></figure><p id="255f" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在本系列的第一部分中，我们将使用Stripe PaymentIntent API来接受支付，创建Stripe客户，并保存卡的详细信息以备将来支付。</p><p id="eef7" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我们将使用React作为前端，使用Node作为服务器。</p><h1 id="14c2" class="kt ku in bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated"><strong class="ak">接受付款</strong></h1><p id="1e56" class="pw-post-body-paragraph jv jw in jx b jy lr ka kb kc ls ke kf kg lt ki kj kk lu km kn ko lv kq kr ks ig bi translated">1.<strong class="jx io">设置服务器</strong></p><ul class=""><li id="94d2" class="lw lx in jx b jy jz kc kd kg ly kk lz ko ma ks mb mc md me bi translated">安装条带节点库</li></ul><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="e717" class="mo ku in mk b gy mp mq l mr ms">npm install --save stripe</span></pre><ul class=""><li id="ba5f" class="lw lx in jx b jy jz kc kd kg ly kk lz ko ma ks mb mc md me bi translated">创建付款意向</li></ul><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="adde" class="mo ku in mk b gy mp mq l mr ms">// Specify Stripe secret api key here<br/>const stripe = require("stripe")("stripe_secret_api_key");</span><span id="1e64" class="mo ku in mk b gy mt mq l mr ms">// Create a PaymentIntent with the order amount and currency<br/>const paymentIntent = await stripe.paymentIntents.create({<br/>  amount: 1200, // Specify amount here<br/>  currency: "usd" // Specify currency here<br/>});</span><span id="2b7d" class="mo ku in mk b gy mt mq l mr ms">// Return client secret<br/>res.send({<br/>  clientSecret: paymentIntent.client_secret<br/>});<br/></span></pre><p id="bbcf" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io"> 2。在客户端建立一个结帐页面</strong></p><ul class=""><li id="b92e" class="lw lx in jx b jy jz kc kd kg ly kk lz ko ma ks mb mc md me bi translated">向您的React应用程序添加条纹</li></ul><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="4880" class="mo ku in mk b gy mp mq l mr ms">npm install --save <a class="ae mu" href="http://twitter.com/stripe/react-stripe-js" rel="noopener ugc nofollow" target="_blank">@stripe/react-stripe-js</a> <a class="ae mu" href="http://twitter.com/stripe/stripe-js" rel="noopener ugc nofollow" target="_blank">@stripe/stripe-js</a></span></pre><ul class=""><li id="f08e" class="lw lx in jx b jy jz kc kd kg ly kk lz ko ma ks mb mc md me bi translated">加载条带及其元素</li></ul><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="28fa" class="mo ku in mk b gy mp mq l mr ms">import React from "react";<br/>import { loadStripe } from "@stripe/stripe-js";<br/>import { Elements } from "@stripe/react-stripe-js";</span><span id="a94a" class="mo ku in mk b gy mt mq l mr ms">import CheckoutForm from "./CheckoutForm";</span><span id="0e1d" class="mo ku in mk b gy mt mq l mr ms">// Make sure to call loadStripe outside of a component’s render to avoid recreating the Stripe object on every render.</span><span id="0737" class="mo ku in mk b gy mt mq l mr ms">// Specicy Stripe Publishable API key here<br/>const promise = loadStripe("stripe_publish_api_key");</span><span id="4ede" class="mo ku in mk b gy mt mq l mr ms">// Initialize Stripe Elements<br/>export default function App() {<br/>  return (<br/>    &lt;div <em class="mv">className</em>="App"&gt;<br/>      &lt;Elements <em class="mv">stripe</em>={promise}&gt;<br/>      &lt;CheckoutForm /&gt;<br/>      &lt;/Elements&gt;<br/>    &lt;/div&gt;<br/>  );<br/>}</span></pre><ul class=""><li id="2170" class="lw lx in jx b jy jz kc kd kg ly kk lz ko ma ks mb mc md me bi translated">构建签出表单</li></ul><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="8f88" class="mo ku in mk b gy mp mq l mr ms"><em class="mv">import</em> React, { useState, useEffect } <em class="mv">from</em> "react";<br/><em class="mv">import</em> { CardElement, useStripe, useElements } <em class="mv">from</em> "@stripe/react-stripe-js";</span><span id="52e2" class="mo ku in mk b gy mt mq l mr ms"><em class="mv">export</em> <em class="mv">default</em> function CheckoutForm() {<br/>  // 1️⃣ Setup state to track client secret, errors and checkout status<br/>  const [succeeded, setSucceeded] = useState(false);<br/>  const [error, setError] = useState(null);<br/>  const [processing, setProcessing] = useState("");<br/>  const [disabled, setDisabled] = useState(true);<br/>  const [clientSecret, setClientSecret] = useState("");</span><span id="6da4" class="mo ku in mk b gy mt mq l mr ms">  // 2️⃣ Store reference to Stripe<br/>  const stripe = useStripe();<br/>  const elements = useElements();</span><span id="7c25" class="mo ku in mk b gy mt mq l mr ms">  useEffect(() =&gt; {<br/>    <em class="mv">// 3️⃣ Create PaymentIntent and fetch client secret as soon as the page loads<br/>    </em>window.fetch("/create-payment-intent", {<br/>      method: "POST",<br/>      headers: {<br/>        "Content-Type": "application/json",<br/>      },<br/>      body: JSON.stringify({ items: [{ id: "xl-tshirt" }] }),<br/>    }).then((res) =&gt; { <br/>      <em class="mv">return</em> res.json();<br/>    }).then((data) =&gt; {<br/>      setClientSecret(data.clientSecret);<br/>    });<br/>  }, []);</span><span id="f070" class="mo ku in mk b gy mt mq l mr ms">  const handleChange = async (event) =&gt; {<br/>    <em class="mv">// 4️⃣ Listen for changes in the CardElement and display any errors as the customer types their card details<br/>    </em>setDisabled(event.empty);<br/>    setError(event.error ? event.error.message : "");<br/>  };</span><span id="620e" class="mo ku in mk b gy mt mq l mr ms">  const handleSubmit = async (ev) =&gt; {<br/>    ev.preventDefault();<br/>    setProcessing(true);</span><span id="4e05" class="mo ku in mk b gy mt mq l mr ms">   // 5️⃣ Confirm Card Payment.<br/>    const payload = <em class="mv">await</em> stripe.confirmCardPayment(clientSecret, {<br/>      payment_method: {<br/>        card: elements.getElement(CardElement),<br/>      },<br/>    });</span><span id="d81e" class="mo ku in mk b gy mt mq l mr ms"><em class="mv">    if</em> (payload.error) {<br/>      setError(`Payment failed ${payload.error.message}`);<br/>      setProcessing(false);<br/>    } <em class="mv">else</em> {<br/>      setError(null);<br/>      setProcessing(false);<br/>      setSucceeded(true);<br/>    }<br/>  };</span><span id="d7a6" class="mo ku in mk b gy mt mq l mr ms">// 6️⃣ Construct UI.<br/><em class="mv">return</em> (<br/>    &lt;form id="payment-form" onSubmit={handleSubmit}&gt;<br/>      &lt;CardElement <br/>        id="card-element"<br/>        {<em class="mv">/* </em>Specify styles here <em class="mv">*/</em>}<br/>        options={{}} <br/>        onChange={handleChange}<br/>      /&gt;<br/>      &lt;button disabled={processing || disabled || succeeded} id="submit"&gt;<br/>        &lt;span id="button-text"&gt;<br/>          {processing ? &lt;div className="spinner" id="spinner"&gt;&lt;/div&gt; : "Pay"}<br/>        &lt;/span&gt;<br/>      &lt;/button&gt;<br/>      {<em class="mv">/* Show any error that happens when processing the payment */</em>}<br/>      {error &amp;&amp; (<br/>        &lt;div className="card-error" role="alert"&gt;{error}&lt;/div&gt;<br/>      )}</span><span id="b2f1" class="mo ku in mk b gy mt mq l mr ms">      {<em class="mv">/* Show a success message upon completion */</em>}<br/>      &lt;p className={succeeded ? "result-message" : "result-message hidden"}&gt;Payment succeeded!&lt;/p&gt;<br/>    &lt;/form&gt;<br/>  );<br/>}</span></pre><ul class=""><li id="2da4" class="lw lx in jx b jy jz kc kd kg ly kk lz ko ma ks mb mc md me bi translated"><strong class="jx io">可选:</strong>显示卡片详细信息的单独输入</li></ul><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="499a" class="mo ku in mk b gy mp mq l mr ms"><em class="mv">import</em> {<br/>  Elements,<br/>  useStripe,<br/>  useElements,<br/>  CardNumberElement,<br/>  CardExpiryElement,<br/>  CardCvcElement,<br/>} <em class="mv">from</em> "@stripe/react-stripe-js";</span><span id="90f4" class="mo ku in mk b gy mt mq l mr ms">// 5️⃣ Confirm Card Payment.<br/>    const payload = <em class="mv">await</em> stripe.confirmCardPayment(clientSecret, {<br/>      payment_method: {<br/>        card: elements.getElement(CardNumberElement),<br/>      },<br/>    });</span><span id="8ef4" class="mo ku in mk b gy mt mq l mr ms">// 6️⃣ Construct UI.<br/><em class="mv">return</em> (<br/>    &lt;form id="payment-form" onSubmit={handleSubmit}&gt;<br/>      &lt;CardNumberElement<br/>        {<em class="mv">/* </em>Specify styles here <em class="mv">*/</em>}<br/>        options={{}}<br/>        onChange={handleChange}<br/>      /&gt;<br/>      &lt;CardCvcElement<br/>        {<em class="mv">/* </em>Specify styles here <em class="mv">*/</em>}<br/>        options={{}}<br/>        onChange={handleChange}<br/>      /&gt;<br/>      &lt;CardExpiryElement<br/>        {<em class="mv">/* </em>Specify styles here <em class="mv">*/</em>}<br/>        options={{}}<br/>        onChange={handleChange}<br/>      /&gt;</span><span id="8d11" class="mo ku in mk b gy mt mq l mr ms">      {<em class="mv">/* ...other ui elements */</em>}</span><span id="bbb6" class="mo ku in mk b gy mt mq l mr ms">    &lt;/form&gt;<br/>  );<br/>}</span></pre><ul class=""><li id="3cb0" class="lw lx in jx b jy jz kc kd kg ly kk lz ko ma ks mb mc md me bi translated"><strong class="jx io">可选但推荐:</strong>包括账单邮政编码，以允许发卡方验证支付。</li></ul><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="79c0" class="mo ku in mk b gy mp mq l mr ms">// 5️⃣ Confirm Card Payment.<br/>    const payload = <em class="mv">await</em> stripe.confirmCardPayment(clientSecret, {<br/>      payment_method: {<br/>        card: elements.getElement(CardNumberElement),<br/>        billing_details: {<br/>          // include other billing details like customer name<br/>          address: {<br/>            postal_code: data.postalCode, // pass customer postal code<br/>          },<br/>        },<br/>      },<br/>    });</span></pre></div><div class="ab cl mw mx hr my" role="separator"><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb"/></div><div class="ig ih ii ij ik"><h1 id="0b55" class="kt ku in bd kv kw nd ky kz la ne lc ld le nf lg lh li ng lk ll lm nh lo lp lq bi translated">保存卡详细信息</h1><p id="5eb1" class="pw-post-body-paragraph jv jw in jx b jy lr ka kb kc ls ke kf kg lt ki kj kk lu km kn ko lv kq kr ks ig bi translated">为了存储用户卡的详细信息，我们需要在Stripe上创建一个客户，这为我们提供了其他好处，如从Stripe仪表板跟踪客户付款、将他们注册为定期订阅等。</p><ul class=""><li id="46e7" class="lw lx in jx b jy jz kc kd kg ly kk lz ko ma ks mb mc md me bi translated">当有人在您的服务器上注册时，创建一个新的Stripe客户并传递必要的数据</li></ul><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="0756" class="mo ku in mk b gy mp mq l mr ms">const customer = <em class="mv">await</em> stripe.customers.create({<br/>  email: data.email, // Pass email (Optional)<br/>  name: data.name, // Pass name (Optional)<br/>});</span><span id="4e6a" class="mo ku in mk b gy mt mq l mr ms">// Store customer.id to your database for future reference</span></pre><ul class=""><li id="d5fc" class="lw lx in jx b jy jz kc kd kg ly kk lz ko ma ks mb mc md me bi translated">更新付款意向以包括客户详细信息</li></ul><pre class="mf mg mh mi gt mj mk ml mm aw mn bi"><span id="be3c" class="mo ku in mk b gy mp mq l mr ms">const paymentIntent = await stripe.paymentIntents.create({<br/>  amount: 1200, // Specify amount here<br/>  currency: "usd" // Specify currency here</span><span id="b3be" class="mo ku in mk b gy mt mq l mr ms">  customer: customer.id, // Specify customer id</span><span id="5eca" class="mo ku in mk b gy mt mq l mr ms">  setup_future_usage: 'off_session', // Include this if you plan to charge card off session (where user is not involved like recurring payments)<br/>});</span></pre></div><div class="ab cl mw mx hr my" role="separator"><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb"/></div><div class="ig ih ii ij ik"><p id="e03f" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">查看该系列的下一部分:<a class="ae mu" href="https://imchetanyadav.medium.com/react-stripe-charge-saved-cards-and-explore-products-invoice-subscriptions-schedules-27b2445b3f9e" rel="noopener"> React + Stripe —为储值卡充值，并探索产品、发票、订阅、时间表</a>。</p><p id="3c71" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">本教程到此为止。希望对你有帮助。在<a class="ae mu" href="https://www.instagram.com/imchetanyadav/" rel="noopener ugc nofollow" target="_blank"> Instagram </a>和<a class="ae mu" href="https://twitter.com/im_chetanyadav/" rel="noopener ugc nofollow" target="_blank"> Twitter </a>上关注我，获取更多信息。</p></div></div>    
</body>
</html>