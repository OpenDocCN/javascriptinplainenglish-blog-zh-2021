<html>
<head>
<title>Using Core Node.js Modules in React Native Apps</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在React本地应用中使用核心Node.js模块</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/using-core-node-js-modules-in-react-native-apps-e6002a33b6ff?source=collection_archive---------4-----------------------#2021-06-24">https://javascript.plainenglish.io/using-core-node-js-modules-in-react-native-apps-e6002a33b6ff?source=collection_archive---------4-----------------------#2021-06-24</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/68958797600e3bce45bd4ed493e139c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l0jKaOxh8TbB08AuHVlqjg.png"/></div></div></figure><p id="21c2" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">有时，在React Native中创建高级应用程序时，您可能希望对发送到web的数据进行加密，以实现安全的web通信。您也可以使用此模块对发送到支付网关的支付相关数据进行加密。</p><p id="05d6" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">假设您想使用<code class="fe kt ku kv kw b"><a class="ae kx" href="https://nodejs.org/api/crypto.html?ref=hackernoon.com#crypto_crypto" rel="noopener ugc nofollow" target="_blank">crypto</a> </code>模块创建一些加密数据。这样做似乎很自然:</p><pre class="ky kz la lb gt lc kw ld le aw lf bi"><span id="4a8a" class="lg lh in kw b gy li lj l lk ll">var crypto = require('crypto');<br/><br/>var mykey = crypto.createCipher('aes-128-cbc', 'mypassword');<br/>var mystr = mykey.update('abc', 'utf8', 'hex')<br/>mystr += mykey.final('hex');<br/><br/>console.log(mystr);//34feb914c099df25794bf9ccb85bea72</span></pre><p id="7390" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">只需导入一个模块并创建一个加密字符串，对吗？对吗？没有。</p><p id="8d5e" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">这个不行，</strong>因为crypto是一个核心Node.js模块，也就是说它很可能是捆绑了Node.js二进制的C++代码，而不是JavaScript。React本机打包程序不能将它[1]与您的应用程序的JavaScript包一起打包，因此您会得到一个运行时错误:</p><pre class="ky kz la lb gt lc kw ld le aw lf bi"><span id="1566" class="lg lh in kw b gy li lj l lk ll">Unable to resolve module 'crypto'<!-- --> </span></pre><p id="5ae2" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这使得核心模块如crypto、stream等，以及依赖它们的数千个npm模块对React Native不可用。幸运的是，这个问题有一个解决方案，但是需要一些工作。</p><h1 id="5e94" class="lm lh in bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">解决办法</h1><p id="0b67" class="pw-post-body-paragraph jv jw in jx b jy mj ka kb kc mk ke kf kg ml ki kj kk mm km kn ko mn kq kr ks ig bi translated">如果您熟悉模块捆绑器<a class="ae kx" href="http://browserify.org/?ref=hackernoon.com" rel="noopener ugc nofollow" target="_blank"> Browserify </a>，您可能知道它允许您在使用polyfills[2]的浏览器中使用核心Node.js模块，如<code class="fe kt ku kv kw b">crypto </code>。因此，让我们尝试创建一个独立的JavaScript文件，其中包含用于<code class="fe kt ku kv kw b">crypto</code>模块的polyfill，并在我们的应用程序中使用它:</p><p id="4e42" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">1.首先安装<code class="fe kt ku kv kw b">browserify </code>:这里我们是全局安装browserify。如果您之前已经全局安装了它，则不需要执行下面的命令。</p><pre class="ky kz la lb gt lc kw ld le aw lf bi"><span id="e2d2" class="lg lh in kw b gy li lj l lk ll">npm install -g browserify</span></pre><p id="8686" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">2.在根目录下创建一个文件crypto-in . js；</p><p id="111b" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在crypto-in.js文件中，导入模块crypto并将其导出到同一个文件中。确保您没有在<code class="fe kt ku kv kw b">node_modules</code>目录中创建crypto-in.js。如果您在<code class="fe kt ku kv kw b">node_modules</code>目录中创建它，那么每次执行<code class="fe kt ku kv kw b">npm install</code>时，这个文件都会丢失。</p><pre class="ky kz la lb gt lc kw ld le aw lf bi"><span id="5935" class="lg lh in kw b gy li lj l lk ll">var crypto = require("crypto");<br/>module.exports=crypto<br/></span></pre><p id="6432" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">3.使用<code class="fe kt ku kv kw b">browserify</code>创建一个独立的JavaScript包<code class="fe kt ku kv kw b">crypto-custom.js </code>。</p><pre class="ky kz la lb gt lc kw ld le aw lf bi"><span id="aa41" class="lg lh in kw b gy li lj l lk ll">browserify crypto-in.js -o crypto-custom.js</span></pre><p id="f96d" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这创建了一个文件<code class="fe kt ku kv kw b">crypto-custom.js</code>，它包含大约26，660行代码(包含polyfills)。最后几行包含我们来自<code class="fe kt ku kv kw b">crypto-in.js</code>的代码。</p><pre class="ky kz la lb gt lc kw ld le aw lf bi"><span id="2c9f" class="lg lh in kw b gy li lj l lk ll">// <!-- -->//26,656 lines above<!-- -->..<br/>},{"indexof":100}],153:[function(require,module,exports){<br/>  // Our code from crypto-in.js<br/>  var crypto = require("crypto");<br/>  module.exports = crypto;<br/>},{"crypto":56}]},{},[153]);</span></pre><p id="697a" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在这一点上，它可能看起来像我们完成了，但我们没有！如果你替换这条线</p><pre class="ky kz la lb gt lc kw ld le aw lf bi"><span id="6d82" class="lg lh in kw b gy li lj l lk ll">const crypto = require('crypto');</span></pre><p id="8892" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在应用程序代码中</p><pre class="ky kz la lb gt lc kw ld le aw lf bi"><span id="15b5" class="lg lh in kw b gy li lj l lk ll">const crypto = require('./crypto-custom');<br/>//here iam in root directory and crypto-custom.js file is also in <br/>//rootdirectory</span></pre><p id="61d8" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">并尝试运行该应用程序，您会得到以下错误:</p><p id="046b" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><code class="fe kt ku kv kw b">Unable to resolve module bn.js</code></p><p id="e7fb" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">原来单词<code class="fe kt ku kv kw b">require </code>被React本机打包程序给予了特殊处理，并且您不能将其重新定义为其他意思，这正是Browserify试图在包中做的。如果你仔细观察<code class="fe kt ku kv kw b">crypto-custom.js</code>内部，你会注意到它总是传入一个自定义的<code class="fe kt ku kv kw b">require </code>函数作为参数，而从来没有真正使用全局的<code class="fe kt ku kv kw b">require</code>。有一个简单的方法可以解决这个问题，解释如下。</p><p id="ebc2" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">4.在文本编辑器中打开文件<code class="fe kt ku kv kw b">crypto-custom.js </code>，用其他东西替换单词<code class="fe kt ku kv kw b">require</code>的所有实例，例如<code class="fe kt ku kv kw b">req</code>。确保它是唯一的，这样它就不会与任何现有的代码冲突，也不会把事情弄糟。</p><p id="64e3" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">如果您现在保存<code class="fe kt ku kv kw b">crypto-custom.js </code>并重新加载应用程序，之前的错误将会消失，但会出现新的错误:</p><figure class="ky kz la lb gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mo"><img src="../Images/d9b98e3230a99a385295d3d1710689bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JceRFh5tEyfVvMs88K5Tzw.jpeg"/></div></div></figure><p id="e6a6" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">打包程序无法找到方法<code class="fe kt ku kv kw b">createCipher</code>，因为<code class="fe kt ku kv kw b">crypto </code>没有从<code class="fe kt ku kv kw b">crypto-custom.js</code>中正确导出。如果你看看这个包的最后几行，你会发现这是因为我们没有在全局<code class="fe kt ku kv kw b">modules</code>对象上设置<code class="fe kt ku kv kw b">module.exports </code>，而是在作为函数参数传入的其他对象上:</p><pre class="ky kz la lb gt lc kw ld le aw lf bi"><span id="3a18" class="lg lh in kw b gy li lj l lk ll">//26,656 lines above..<br/>},{}],187:[function(req,module,exports){</span><span id="795d" class="lg lh in kw b gy mp lj l lk ll">var crypto = req("crypto");</span><span id="6b86" class="lg lh in kw b gy mp lj l lk ll">module.exports = crypto;</span><span id="fb0d" class="lg lh in kw b gy mp lj l lk ll">},{"crypto":71}]},{},[187]);</span></pre><p id="aefd" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">5.为了从<code class="fe kt ku kv kw b">crypto-custom.js</code>中正确导出<code class="fe kt ku kv kw b">crypto </code>，我们需要对文件做一些修改:</p><ul class=""><li id="f8fd" class="mq mr in jx b jy jz kc kd kg ms kk mt ko mu ks mv mw mx my bi translated">在文件<code class="fe kt ku kv kw b">crypto-custom.js</code>的顶部添加语句<code class="fe kt ku kv kw b">var crypto </code></li><li id="9ca6" class="mq mr in jx b jy mz kc na kg nb kk nc ko nd ks mv mw mx my bi translated">将语句<code class="fe kt ku kv kw b">var crypto = require('crypto');</code>替换为<code class="fe kt ku kv kw b">crypto = require('crypto'); </code>来设置外部变量，而不是在函数体内创建局部变量。</li><li id="bb27" class="mq mr in jx b jy mz kc na kg nb kk nc ko nd ks mv mw mx my bi translated">将函数体外部的行<code class="fe kt ku kv kw b">module.exports = crypto;</code>移动到文件的底部，使其引用全局<code class="fe kt ku kv kw b">module </code>对象。</li></ul><p id="318c" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">修改后，<code class="fe kt ku kv kw b">crypto-custom.js </code>应该是这样的:</p><pre class="ky kz la lb gt lc kw ld le aw lf bi"><span id="7c6a" class="lg lh in kw b gy li lj l lk ll">var crypto;  //at top of the file at line 1</span><span id="17e9" class="lg lh in kw b gy mp lj l lk ll">// Some 26,656 lines of polyfills..<br/>},{"indexof":100}],153:[function(req,module,exports){<br/>  crypto = req("crypto");<br/>},{"crypto":56}]},{},[153]);<br/><br/>module.exports = crypto; </span></pre><p id="116a" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">就是这样！</strong>如果你现在运行这个应用程序，它应该可以完美运行:</p><blockquote class="ne nf ng"><p id="753d" class="jv jw nh jx b jy jz ka kb kc kd ke kf ni kh ki kj nj kl km kn nk kp kq kr ks ig bi translated">有一个替代模块<code class="fe kt ku kv kw b">expo-crypto</code>也可用于加密数据，但与核心加密模块相比，它的方法很少</p><p id="d610" class="jv jw nh jx b jy jz ka kb kc kd ke kf ni kh ki kj nj kl km kn nk kp kq kr ks ig bi translated">还有一个模块<a class="ae kx" href="https://www.npmjs.com/package/react-native-crypto" rel="noopener ugc nofollow" target="_blank"> react-native-crypto </a>也可以使用，但是它没有createCipheriv方法。</p></blockquote><h2 id="d65e" class="lg lh in bd ln nl nm dn lr nn no dp lv kg np nq lz kk nr ns md ko nt nu mh nv bi translated">感谢阅读！</h2><h1 id="3095" class="lm lh in bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">参考</h1><ul class=""><li id="67ce" class="mq mr in jx b jy mj kc mk kg nw kk nx ko ny ks mv mw mx my bi translated">[1]—<a class="ae kx" href="https://github.com/facebook/react-native/issues/1871?ref=hackernoon.com" rel="noopener ugc nofollow" target="_blank">https://github.com/facebook/react-native/issues/1871</a></li><li id="6c68" class="mq mr in jx b jy mz kc na kg nb kk nc ko nd ks mv mw mx my bi translated">[2]——【https://github.com/substack/browserify-handbook#builtins T2</li><li id="66f3" class="mq mr in jx b jy mz kc na kg nb kk nc ko nd ks mv mw mx my bi translated">[3]——【https://github.com/facebook/react-native/issues/6253 T4】</li></ul><p id="d7a5" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><em class="nh">更多内容请看</em><a class="ae kx" href="http://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><strong class="jx io"><em class="nh">plain English . io</em></strong></a></p></div></div>    
</body>
</html>