<html>
<head>
<title>OTP Verification with Vonage</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Vonage进行OTP验证</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/otp-verification-with-vonage-b7ddc4a64b28?source=collection_archive---------8-----------------------#2021-05-30">https://javascript.plainenglish.io/otp-verification-with-vonage-b7ddc4a64b28?source=collection_archive---------8-----------------------#2021-05-30</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/2ff88dfdefb5c78ac2e98ddec7662ab2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LomylmIzuMa3eo9hwkcxqQ.jpeg"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Photo by <a class="ae jz" href="https://unsplash.com/@firmbee?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Firmbee.com</a> on <a class="ae jz" href="https://unsplash.com/s/photos/sms?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="201e" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">OTP验证已经成为现代web和移动应用程序的一个常见特征。无论是用户注册、多因素认证还是密码更改机制，OTP验证似乎都是最完美的选择。此外，短信或电话验证被认为比电子邮件链接更安全可靠。</p><p id="3291" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">在本文中，我将解释Vonage与Node.js (Express)服务器集成的验证API。它还提供了一个OTP特性，因此您不必每次都重新发明轮子。你可以点击查看更多信息<a class="ae jz" href="https://www.vonage.com/communications-apis/verify/" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="c8bf" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">让我们从一个非常基本的express服务器开始。</p><figure class="ky kz la lb gt jo"><div class="bz fp l di"><div class="lc ld l"/></div></figure><p id="f42a" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io"> server.js </strong>文件包含一个非常基本的web服务器，有2个路由。</p><ul class=""><li id="002c" class="le lf in kc b kd ke kh ki kl lg kp lh kt li kx lj lk ll lm bi translated">/API/请求令牌</li><li id="a802" class="le lf in kc b kd ln kh lo kl lp kp lq kt lr kx lj lk ll lm bi translated">/API/验证令牌</li></ul><p id="3930" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">每个端点的业务逻辑都在<code class="fe ls lt lu lv b">vonage.service.js</code> <strong class="kc io">中。</strong>服务文件使用<code class="fe ls lt lu lv b">@vonage/server-sdk</code>；Vonage API的官方JS库。订购该服务后，可在仪表板上获得<code class="fe ls lt lu lv b">Vonage API Key</code>和<code class="fe ls lt lu lv b">API Secret</code>。</p><p id="f345" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">服务文件有三种方法:请求、验证和取消令牌。</p><figure class="ky kz la lb gt jo"><div class="bz fp l di"><div class="lc ld l"/></div></figure><p id="4064" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">首先，<code class="fe ls lt lu lv b">vonage</code>对象用从Vonage获得的apiKey和secret首字母签名。整个工作流程有两部分:请求代码&amp;验证。让我们深入探讨每一个问题。</p><h1 id="cf4d" class="lw lx in bd ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt bi translated">请求OTP</h1><p id="caed" class="pw-post-body-paragraph ka kb in kc b kd mu kf kg kh mv kj kk kl mw kn ko kp mx kr ks kt my kv kw kx ig bi translated">该方法的一项工作是向给定的电话号码发送OTP令牌。Vonage验证服务以一种冷静的方式处理它。截至写这篇文章的时候，它发送短信给指定的号码。如果OTP在这段时间内没有被验证，它会调用SIM卡上的号码，或者在我的情况下，它会调用Viber上的号码。当你得到OTP代码后，你可以把它发送给API进行验证。这一过程看似简单，但在实施过程中可能会很棘手。</p><blockquote class="mz na nb"><p id="1a29" class="ka kb nc kc b kd ke kf kg kh ki kj kk nd km kn ko ne kq kr ks nf ku kv kw kx ig bi translated">我遇到的一些警告:</p><p id="9ff7" class="ka kb nc kc b kd ke kf kg kh ki kj kk nd km kn ko ne kq kr ks nf ku kv kw kx ig bi translated">-无法在30秒间隔内向电话号码发送并发OTP。</p><p id="9466" class="ka kb nc kc b kd ke kf kg kh ki kj kk nd km kn ko ne kq kr ks nf ku kv kw kx ig bi translated">-无法多次取消OTP请求。如果这样做，它将反复抛出错误。</p></blockquote><p id="c12b" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">考虑到这几点，让我们从代码开始。首先让我们完成<code class="fe ls lt lu lv b">vonage.service.js</code>文件中的<code class="fe ls lt lu lv b">requestCode</code>方法。</p><figure class="ky kz la lb gt jo"><div class="bz fp l di"><div class="lc ld l"/></div></figure><p id="458f" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">该方法获取一个电话号码，并返回最重要的内容<code class="fe ls lt lu lv b">request_id</code>。</p><blockquote class="mz na nb"><p id="f76a" class="ka kb nc kc b kd ke kf kg kh ki kj kk nd km kn ko ne kq kr ks nf ku kv kw kx ig bi translated">通常情况下，您无法访问Vonage发送的OTP代码。如果您需要，请访问他们的<a class="ae jz" href="https://www.vonage.com/communications-apis/verify/pricing/" rel="noopener ugc nofollow" target="_blank">定价部分</a>。</p></blockquote><p id="fa90" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">如果您得到了响应<code class="fe ls lt lu lv b">request_id</code>，这是一个成功的请求，否则就有一些错误。</p><p id="d92f" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">该机制的另一部分是取消令牌请求。可能存在需要取消OTP请求的情况。其中一个突出的原因是:Vonage对OTP到期有5分钟的限制。在现实世界中，这是一个漫长的等待。最坏的情况:谁等了5分钟才收到OTP😂</p><p id="75f3" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">因此，您可能需要取消挂起的请求并重新发送另一个OTP。取消请求的代码如下所示。</p><figure class="ky kz la lb gt jo"><div class="bz fp l di"><div class="lc ld l"/></div></figure><p id="07a2" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这是一个非常简单的代码，需要OTP的<code class="fe ls lt lu lv b">request_id</code>来取消它。正如您可能已经看到的，<code class="fe ls lt lu lv b">request_id</code>是跟踪您的OTP的唯一方法。所以，要安全存放。</p><p id="b9a6" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这两种方法足以申请一个动态口令。现在让我们转到<code class="fe ls lt lu lv b">server.js</code>来实现这些方法。</p><figure class="ky kz la lb gt jo"><div class="bz fp l di"><div class="lc ld l"/></div></figure><p id="f8ae" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">首先，检查电话号码是否存在。然后删除所有现有的空白。有时电话号码的格式很奇怪(+12 345 678 890)。这可能会给Vonage等服务带来问题。但是它需要国家代码。</p><p id="fd5c" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">基本上，上面的代码通过<code class="fe ls lt lu lv b">vonage.service.js</code>请求OTP。如果成功，则执行<code class="fe ls lt lu lv b">onOtpSuccess</code>功能，如果错误，则执行<code class="fe ls lt lu lv b">onOtpError</code>。如果在5分钟内并发OTP请求相同的号码，Vonage抛出状态为10的错误。这种情况是通过用其<code class="fe ls lt lu lv b">request_id</code>取消OTP并重新发送请求来处理的。如果它再次失败，它被标记为错误。</p><p id="c643" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">至此，您已经了解了如何请求OTP，如何取消它(如果需要的话)。另一个难题是验证OTP。</p><h1 id="d7fc" class="lw lx in bd ly lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt bi translated">验证OTP</h1><p id="fc12" class="pw-post-body-paragraph ka kb in kc b kd mu kf kg kh mv kj kk kl mw kn ko kp mx kr ks kt my kv kw kx ig bi translated">回想一下:我们有两个文件<code class="fe ls lt lu lv b">server.js</code>、<code class="fe ls lt lu lv b">vonage.service.js</code>和<code class="fe ls lt lu lv b">request_id</code>是跟踪您的OTP的唯一方法。</p><p id="af5b" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">与OTP请求机制不同，验证的逻辑非常简单。首先，我们来看一下<code class="fe ls lt lu lv b">vonage.service.js</code>的实现。</p><figure class="ky kz la lb gt jo"><div class="bz fp l di"><div class="lc ld l"/></div></figure><p id="8983" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">验证通过以下方式完成</p><ul class=""><li id="910e" class="le lf in kc b kd ke kh ki kl lg kp lh kt li kx lj lk ll lm bi translated"><code class="fe ls lt lu lv b">request_id</code>存储在数据库中或从用户处接收</li><li id="928a" class="le lf in kc b kd ln kh lo kl lp kp lq kt lr kx lj lk ll lm bi translated">用户通过手机短信或电话收到的OTP代码。</li></ul><p id="c479" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">成功验证将返回状态为0的结果。</p><p id="2ad6" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">转到<code class="fe ls lt lu lv b">server.js</code>文件，<code class="fe ls lt lu lv b">verifyOtp</code>方法是这样使用的。</p><figure class="ky kz la lb gt jo"><div class="bz fp l di"><div class="lc ld l"/></div></figure><p id="7226" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这里，OTP和<code class="fe ls lt lu lv b">request_id</code>都是从API请求中获取的。这可能取决于您的实现。</p><p id="9d13" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">这样，您可以将OTP代码发送到用户的设备，并使用Vonage的验证API对其进行验证。你也可以在Vonage的JS指南中找到一个基本的实现。本文为在Express JS服务器上实现它提供了更详细的指导。</p><p id="fdd4" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><em class="nc">更多内容看</em><a class="ae jz" href="http://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><strong class="kc io"><em class="nc">plain English . io</em></strong></a></p></div></div>    
</body>
</html>