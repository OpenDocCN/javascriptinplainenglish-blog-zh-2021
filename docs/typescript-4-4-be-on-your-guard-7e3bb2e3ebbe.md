# TypeScript 4.4 中的类型保护和控制流分析

> 原文：<https://javascript.plainenglish.io/typescript-4-4-be-on-your-guard-7e3bb2e3ebbe?source=collection_archive---------7----------------------->

## 警惕

![](img/9b13f35ccef25c4dc6d5a39a406170fd.png)

The Guard

为了庆祝 [TypeScript 4.4](https://devblogs.microsoft.com/typescript/announcing-typescript-4-4/) 的发布，我探索了 TypeScript 中的类型联合，以及该语言如何使用类型保护和控制流分析来自动细化变量的类型。

我将报道:

*   什么是类型联合
*   类型保护和控制流分析
*   4.4 的 CFA 用于混叠条件和鉴别条件

# 介绍

我以前谈到过 TypeScript 的实用主义，用类型安全来增强 JavaScript，以改善开发体验。但是它不仅仅是 JavaScript 上的一层薄薄的静态类型，它还有一个非常强大的类型系统。在 TypeScript 中，可以使用类型联合、类型交集、映射类型和条件类型从现有类型派生新类型。这种类型编程能力允许我们减少代码重复，并在定义类型时拥有单一的真实来源。

在这篇文章中，我将深入研究类型联合，因为 [TypeScript 4.4](https://devblogs.microsoft.com/typescript/announcing-typescript-4-4/) 增加了编译器对联合类型检查的更自然使用的支持。如果你想在上面的任何一个项目上发帖，一定要喜欢并留下评论。

# 类型联合太棒了

类型联合允许我们定义一个新的类型，它代表一组可能的类型中的任何一个。例如:

这里，类型联合`Primitive`意味着`x`可以引用一个`string`或`number`或`boolean`值。

这在 JavaScript 世界中尤其重要，因为 API 经常包含接受或返回不同类型值的函数。库利用动态类型将许多不同的行为压缩到一个函数中。有了 TypeScript 中的联合，我们就可以安全地限制到一组有效的类型，而不是去最高的抽象层`any`或`unknown`。

但是如果`x`可以是这些可能类型中的任何一种，我们*可以安全地*用`x`做什么呢。事实证明，在这种情况下，不太多:

自动完成显示我们能做的只有`valueOf`、`toString`和`toLocaleString`。我们可以安全地在一个联合中使用的唯一 API 是那些对联合的所有成员通用的 API。

我们当然可以对特定类型使用类型断言:

但是我们怎么知道我们的断言是正确的，值是正确的类型呢？当然，如果我们有任何疑问，在 JavaScript 中，我们会写一些代码来测试数据。

TypeScript 通过检查我们程序的控制流(`if` s、`switch` es 等)来简化这种代码，并自动提炼或**缩小变量的类型(在其他语言中可能被称为**智能转换**)。因此，在`if`块中，它自动将`x`解释为`number`。**

此外，在这个`if`的`else`块上，`x`的类型将是联合的剩余部分。因此，在这种情况下，它将被缩小到`string | boolean`。

编译器在这里做的叫做**控制流分析** (CFA)，我们写的条件叫做**类型保护**。编译器可以通过`if`、`switch`、`throw`、`return`以及逻辑(`&&`、`||`)、赋值、等式、三元(`? :`)等运算符来分析控制流。

真正优雅的是，我们编写的代码与用 JavaScript 编写的代码相同——注意，上面没有类型注释。打字稿的区别是我们得到了**型安全**和**更好的工具**。

# 铅字护板的类型

使用`typeof`只是一个保护示例。让我们来分解一下类型守卫的类型。我拒绝把它们归类为太难打字的类型。打字！

# `null`守卫

`null`检查是最常见的警卫之一。

当然，我们可以使用可选的链接来简化这一点:

# `typeof`守卫

我们已经看到了`typeof`守卫的行动。这是另一个使用开关的例子:

记住`typeof`只能告诉我们一个类型是不是`string`、`number`、`boolean`、`symbol`、`function`、`bigint`、`undefined`。其他的都要回归`"object"`。

# `instanceof`守卫

使用`instanceof`我们可以测试一个对象是否是一个类的实例，或者是从一个类派生的。

注意，if/else 块中的所有属性集在外部都会失败，因为它们不是两种类型所共有的。

# `in`守卫

`in`操作符允许我们测试一个对象是否存在成员。在下面的代码中，只有`HTMLTextAreaElement`有一个`rows`属性，所以通过测试它的存在，编译器确定每个分支上的`input`变量的类型并缩小类型。

注意，`in`只能在**联合的所有**成员都是对象类型(非原语)时使用。

# 受歧视的工会警卫

鉴别联合是这样一种设计，其中联合中的每个类型都包含一个唯一标识或允许编译器鉴别该类型的成员。例如:

这里，`kind`属性对所有类型都是通用的，所以我们可以在类型为`Animal`的变量上访问它。TypeScript 可以使用此属性与可能值的比较来适当缩小类型。

再次强调，这里最棒的是我们没有编写任何类型注释或断言，但是编译器仍然在进行错误检查，IDE 可以给我们很多自动完成和支持。

# 用户定义的防护

在 TypeScript 4.4 之前，用户定义的保护是提高这类代码可读性的唯一方法。用户定义的守卫允许我们将类型检查逻辑和守卫分解到命名函数中。

例如，考虑前面检查 HTML 元素的代码:

我经常会把这样的检查分解到一个函数中，但是编译器不会深入到函数中去寻找类型保护，所以缩小**不会发生**。

我们必须做的是将返回类型从`boolean`改为类型谓词。如果我们的布尔函数返回`true`，这允许我们提供关于输入参数的编译器类型信息。

# 断言函数

我们可以以类似的方式使用断言函数。断言函数通知编译器，如果某个条件不成立，它将抛出一个错误。我们可以使用它们来断言一个输入参数具有某种类型，然后 CFA 将适当地缩小范围。语法类似于用户定义的类型保护，只是我们在类型谓词前面加上了前缀`asserts`。

这里的优势是它消除了缩进，仍然缩小。这对于开发人员在函数顶部(旧的含义是“守卫”)或测试中的断言非常有用。

# TypeScript 4.4 改进了什么

尽管用户定义的类型保护和断言函数有助于提高可读性，但它们是一种粗糙的工具。TypeScript 4.4 编译器带来了保留变量的控制流分析信息的能力，因此我们可以编写更自然的代码并保留缩小功能。

例如，下面的代码在 TypeScript 4.4 之前将不起作用，因为保护被分解为一个变量:

在 TypeScript 4.4 中，这段代码可以正常工作。变量`isTextArea`保留了表示`input`是否为`HTMLTextAreaElement`的信息，这可以被 CFA 拾取。它称这些**为别名条件**。

这些条件可以使用到目前为止描述的所有保护，可以合并多个条件，甚至可以过渡性地工作。

`canSpeak`变量是另外两个变量的“或”,但是这两个变量的类型信息被组合并应用到`canSpeak`。

# 限制

以下限制本身并不是批评，而仅仅是我为了更好地理解这个特性而进行的实验。

## 只有条件有别名

这种类型的信息别名只对条件有效。如果我们创建变量来包含关键信息，然后根据这些信息构建条件，那么类型保护行为就不起作用了。例如，这里我们将`typeof`结果存储在一个变量中。

## 仅顶层变量

TypeScript 足够聪明，普通类型保护支持嵌套属性的缩小。例如:

这里我们有一个防止属性嵌套在一个对象中两层的类型保护，但是编译器仍然缩小了范围。但是，这不适用于新的别名条件(即使是单层嵌套)。它必须是顶级变量。

## 过渡深度极限

编译器在多大程度上应用传递规则也是有限制的。我很好奇这个限制是什么，所以写了下面的(可怕的)代码:

因此，我们有一个大的区别对待的联盟，其中所有成员都有一个`child`属性，只有一个除外`Terminal`。接下来，我创建了一系列相互依赖的条件。

我的目标是看看我们丢失了哪个变量的类型保护信息，以确保`root`不是`Terminal`类型。我所发现的是，下面的行工作作为`root`已知有一个`child`:

而下面一行并不像编译器不知道`root`是什么:

指示 4 级嵌套混淆。我不认为这是一个问题——我只是好奇，觉得测试一下会很有趣。

# 结论

我希望你能找到和我一样酷的警卫。TypeScript 4.4 的更新并不是很华丽，但这一变化对于保持代码的整洁和安全非常有用，无需添加大量的类型注释。

如果您还没有这样做，请查看我的帖子，这些帖子展示了 [TypeScript 4.1](https://medium.com/swlh/crazy-powerful-typescript-4-1-features-26036f4de6bc) 、 [TypeScript 4.2](https://levelup.gitconnected.com/crazy-powerful-typescript-tuple-types-9b121e0a690c) 和 [TypeScript 4.3](https://levelup.gitconnected.com/typescript-4-3-i-object-your-honour-2db0368c07cb) 中的一些有用功能。

此外，请务必查看我们的[打字稿](https://instil.co/courses/introduction-to-typescript-course/)课程。我们也很乐意使用 TypeScript 提供[Angular](https://instil.co/courses/introduction-to-angular/)&[React](https://instil.co/courses/react-with-typescript-course/)培训。我们几乎为世界各地的公司提供服务，并且很乐意根据您团队的水平和具体需求定制我们的课程。来看看我们是否能帮助你和你的团队。

原贴[此处](https://instil.co/blog/typescript-44-type-guards/)。

# 关于标题图像

帖子的标题图片是布莱丹·格里森，取自电影《警卫 T21》。这是一部关于爱尔兰警察的黑色喜剧。爱尔兰的警察部门被称为“爱尔兰和平卫士”，其成员被称为“卫士”。我喜欢空洞的电影参考。