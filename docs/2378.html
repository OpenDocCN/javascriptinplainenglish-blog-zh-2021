<html>
<head>
<title>Make Mongoose Queries Faster without Losing Your Defaults</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">让Mongoose查询更快，而不丢失默认值</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/make-mongoose-queries-faster-without-losing-your-defaults-340ac1f824a6?source=collection_archive---------15-----------------------#2021-05-17">https://javascript.plainenglish.io/make-mongoose-queries-faster-without-losing-your-defaults-340ac1f824a6?source=collection_archive---------15-----------------------#2021-05-17</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="ff0e" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">如何在保持数据一致性的同时让查询速度更快</h2></div><p id="0b37" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">使用Mongoose在Node.js中与MongoDB交互时提供了许多优势。在构建、建模和存储应用程序的数据时，类型转换、验证、查询构建、业务逻辑挂钩、默认值都是必须的。Mongoose提供了所有这一切，无需编写太多样板代码或使用多个库。</p><figure class="kz la lb lc gt ld gh gi paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="gh gi ky"><img src="../Images/bc27d2b98f550405caa5a8411a389288.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Vnbr8wBTMgap1cVidSQsig.png"/></div></div></figure><p id="1131" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">Mongoose通过为查询的每个结果文档添加大量魔法来实现这一点。这种<em class="lk">水合</em>将一个普通的旧JavaScript对象(POJOs)转换成一个奇妙而神奇的Mongoose文档。这是有代价的，因为Mongoose文档平均比POJO文档大8到10倍。</p><p id="c20c" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">为了使我们的应用程序的性能尽可能快，我们需要尽可能有效和高效地查询我们的数据库。假设我们在一个查询中检索数千甚至数十万个文档，将每个文档缩小10倍将会在性能上获得巨大的提升。</p><figure class="kz la lb lc gt ld gh gi paragraph-image"><div role="button" tabindex="0" class="le lf di lg bf lh"><div class="gh gi ll"><img src="../Images/b471a8cf33fb8ab30397a057cdfe1e6c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sR9QGcQxPHn8XPhq-vGVTQ.jpeg"/></div></div><figcaption class="lm ln gj gh gi lo lp bd b be z dk">Picture by <a class="ae lq" href="https://www.pexels.com/es-es/@vovaflame?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank">Vova Krasilnikov</a></figcaption></figure><h1 id="485a" class="lr ls in bd lt lu lv lw lx ly lz ma mb jt mc ju md jw me jx mf jz mg ka mh mi bi translated">倾斜</h1><p id="47c6" class="pw-post-body-paragraph kc kd in ke b kf mj jo kh ki mk jr kk kl ml kn ko kp mm kr ks kt mn kv kw kx ig bi translated">Mongoose的人已经考虑到了这一点，并为我们提供了一个简洁的解决方案，精益。Lean跳过每个文档的水化，返回普通的旧POJOs。<br/> <br/>取以下猫鼬查询。</p><pre class="kz la lb lc gt mo mp mq mr aw ms bi"><span id="f104" class="mt ls in mp b gy mu mv l mw mx"><br/>const leanPerson = await Person.findOne()</span></pre><p id="a597" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">使用精益的确非常简单。</p><pre class="kz la lb lc gt mo mp mq mr aw ms bi"><span id="6ff3" class="mt ls in mp b gy mu mv l mw mx">const leanPerson = await Person.findOne().lean()</span></pre><p id="dac0" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">当精益传播到填充的文档时，它甚至与<strong class="ke io">填充</strong>一起工作。</p><pre class="kz la lb lc gt mo mp mq mr aw ms bi"><span id="3e34" class="mt ls in mp b gy mu mv l mw mx">const leanPerson = await Person.findOne().lean().populate("interests")</span></pre><p id="7cb1" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">完美！我们通过添加最少的代码极大地提高了查询性能。</p><h1 id="4a4d" class="lr ls in bd lt lu lv lw lx ly lz ma mb jt mc ju md jw me jx mf jz mg ka mh mi bi translated">维护默认值</h1><p id="d5b8" class="pw-post-body-paragraph kc kd in ke b kf mj jo kh ki mk jr kk kl ml kn ko kp mm kr ks kt mn kv kw kx ig bi translated">扩展应用程序时，保持数据一致性至关重要。<br/>尽管MongoDB允许我们以JSON对象的形式存储文档，但使用Mongoose的原因之一是它添加了验证和默认设置<strong class="ke io">之类的东西</strong>。</p><p id="72ce" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">为了在使用<strong class="ke io"> lean的同时保持我们的默认值，</strong>我们必须在定义我们的mongose模式时使用一个NPM包形式的漂亮的小插件，名为<strong class="ke io">mongose-lean-defaults</strong>。</p><pre class="kz la lb lc gt mo mp mq mr aw ms bi"><span id="3c10" class="mt ls in mp b gy mu mv l mw mx">const mongooseLeanDefaults = require('mongoose-lean-defaults').default</span><span id="5681" class="mt ls in mp b gy my mv l mw mx">const person = new mongoose.Schema({<br/>  name: {<br/>    type: String,<br/>    default: 'Carlos',<br/>  },<br/>  language: {<br/>    type: String,<br/>    default: 'English',<br/>  },<br/>});<br/><br/>person.plugin(mongooseLeanDefaults);</span></pre><p id="8d56" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">然后只需在执行查询时添加<em class="lk"> defaults: true </em>选项即可。</p><pre class="kz la lb lc gt mo mp mq mr aw ms bi"><span id="b623" class="mt ls in mp b gy mu mv l mw mx">const carlos = await Person.findOne().lean({ defaults: true });<br/>/**<br/> * carlos = {<br/> *    _id: ...,<br/> *    name: 'Carlos',<br/> *    language: 'English'<br/> * }<br/> */</span></pre><p id="cba1" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">现在你知道了。您现在可以查询数千个文档，同时保持数据一致性。</p><p id="4ca9" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">希望这篇小文章能帮助你把你的下一个应用从100个用户提升到100，000个用户。</p><p id="38ed" class="pw-post-body-paragraph kc kd in ke b kf kg jo kh ki kj jr kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><em class="lk">更多内容请看</em><a class="ae lq" href="http://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><em class="lk">plain English . io</em></a></p></div></div>    
</body>
</html>