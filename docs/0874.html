<html>
<head>
<title>Build an IP lookup microservice using Node.js</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Node.js构建一个IP查找微服务</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/build-an-ip-lookup-microservice-using-node-js-67d7aaaf4b34?source=collection_archive---------7-----------------------#2021-02-23">https://javascript.plainenglish.io/build-an-ip-lookup-microservice-using-node-js-67d7aaaf4b34?source=collection_archive---------7-----------------------#2021-02-23</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="c333" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">提取用户的位置，时区和更多。</h2></div><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi kc"><img src="../Images/803e0294e68ecaa2419eac306de56cdb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HQXJ4BkzMefPaCyyU3sCwg.jpeg"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Photo by <a class="ae ks" href="https://www.pexels.com/@wendy-van-zyl-312082?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank"><strong class="bd kt">Wendy van Zyl</strong></a> from <a class="ae ks" href="https://www.pexels.com/photo/brown-book-page-1112048/?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank"><strong class="bd kt">Pexels</strong></a></figcaption></figure><p id="1f03" class="pw-post-body-paragraph ku kv in kw b kx ky jo kz la lb jr lc ld le lf lg lh li lj lk ll lm ln lo lp ig bi translated">在这个演示中，我们将构建一个微服务，使用Node.js和Express从用户IP地址中提取详细信息。有些情况下，我们需要获取应用程序用户的一些信息，以便为他们提供更好的用户体验，比如交付基于位置的内容等等。</p><p id="9e1d" class="pw-post-body-paragraph ku kv in kw b kx ky jo kz la lb jr lc ld le lf lg lh li lj lk ll lm ln lo lp ig bi translated">不用浪费太多时间，让我们把手弄脏吧！</p><h1 id="c657" class="lq lr in bd ls lt lu lv lw lx ly lz ma jt mb ju mc jw md jx me jz mf ka mg mh bi translated">实现服务✨</h1><p id="2079" class="pw-post-body-paragraph ku kv in kw b kx mi jo kz la mj jr lc ld mk lf lg lh ml lj lk ll mm ln lo lp ig bi translated">首先，让我们通过运行<code class="fe mn mo mp mq b">npm init -y</code>命令来初始化我们的项目。</p><p id="95fa" class="pw-post-body-paragraph ku kv in kw b kx ky jo kz la lb jr lc ld le lf lg lh li lj lk ll lm ln lo lp ig bi translated">现在，我们需要安装依赖项。</p><p id="94da" class="pw-post-body-paragraph ku kv in kw b kx ky jo kz la lb jr lc ld le lf lg lh li lj lk ll lm ln lo lp ig bi translated"><code class="fe mn mo mp mq b">npm install express geoip-lite --save</code></p><p id="6bea" class="pw-post-body-paragraph ku kv in kw b kx ky jo kz la lb jr lc ld le lf lg lh li lj lk ll lm ln lo lp ig bi translated">Express模块将用于处理来自客户端的http请求。</p><p id="6ba6" class="pw-post-body-paragraph ku kv in kw b kx ky jo kz la lb jr lc ld le lf lg lh li lj lk ll lm ln lo lp ig bi translated"><a class="ae ks" href="https://www.npmjs.com/package/geoip-lite" rel="noopener ugc nofollow" target="_blank"> Geoip-lite </a>将用于ip查找。我们可以使用这个库通过传递IP地址来获取各种信息。</p><p id="4cfa" class="pw-post-body-paragraph ku kv in kw b kx ky jo kz la lb jr lc ld le lf lg lh li lj lk ll lm ln lo lp ig bi translated">安装完依赖项后，在项目的根目录下创建一个文件“app.js”。在app.js文件中添加以下内容。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="mr ms l"/></div></figure><p id="b9f7" class="pw-post-body-paragraph ku kv in kw b kx ky jo kz la lb jr lc ld le lf lg lh li lj lk ll lm ln lo lp ig bi translated">现在保存文件。</p><p id="57aa" class="pw-post-body-paragraph ku kv in kw b kx ky jo kz la lb jr lc ld le lf lg lh li lj lk ll lm ln lo lp ig bi translated">您可以根据需要重构这个端点。为了简单起见，我只返回用户所在的城市、州和国家。</p><p id="c772" class="pw-post-body-paragraph ku kv in kw b kx ky jo kz la lb jr lc ld le lf lg lh li lj lk ll lm ln lo lp ig bi translated">从你的终端运行<code class="fe mn mo mp mq b">node app.js</code>。</p><p id="8de0" class="pw-post-body-paragraph ku kv in kw b kx ky jo kz la lb jr lc ld le lf lg lh li lj lk ll lm ln lo lp ig bi translated">您的输出应该显示消息:<strong class="kw io"> IP查找服务已启动！</strong></p><p id="8c22" class="pw-post-body-paragraph ku kv in kw b kx ky jo kz la lb jr lc ld le lf lg lh li lj lk ll lm ln lo lp ig bi translated">如果我们尝试在不使用代理的情况下检索IP地址，我们将得到类似这样的IP地址<strong class="kw io"> ::ffff:127.0.0.1 </strong></p><p id="5878" class="pw-post-body-paragraph ku kv in kw b kx ky jo kz la lb jr lc ld le lf lg lh li lj lk ll lm ln lo lp ig bi translated">如果不使用代理，我们无法在本地主机上测试这个应用程序。因此我们将使用NGROK。您可以参考这个<a class="ae ks" href="https://ngrok.com/download" rel="noopener ugc nofollow" target="_blank">链接</a>来安装和配置NGROK。</p><p id="06c5" class="pw-post-body-paragraph ku kv in kw b kx ky jo kz la lb jr lc ld le lf lg lh li lj lk ll lm ln lo lp ig bi translated">可以通过运行命令- <code class="fe mn mo mp mq b">./ngrok http 5000</code>来启动ngrok。确保节点应用程序在端口5000上启动并运行。</p><p id="1194" class="pw-post-body-paragraph ku kv in kw b kx ky jo kz la lb jr lc ld le lf lg lh li lj lk ll lm ln lo lp ig bi translated">如果一切正常，ngrok的输出应该是这样的。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi mt"><img src="../Images/c39dabfa61d430308a954f8dab55d05d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0mO7PUaSyXhcG3Pa2rPXvQ.png"/></div></div></figure><p id="934f" class="pw-post-body-paragraph ku kv in kw b kx ky jo kz la lb jr lc ld le lf lg lh li lj lk ll lm ln lo lp ig bi translated">现在，打开浏览器，导航到您的ngrok根URL，后跟<code class="fe mn mo mp mq b">/lookup</code>端点。</p><p id="ae0a" class="pw-post-body-paragraph ku kv in kw b kx ky jo kz la lb jr lc ld le lf lg lh li lj lk ll lm ln lo lp ig bi translated">在我的例子中，根url是<a class="ae ks" href="https://50bb377c3857.ngrok.io" rel="noopener ugc nofollow" target="_blank">https://50bb 377 c 3857 . ngrok . io</a>所以完整的URL是be<a class="ae ks" href="https://50bb377c3857.ngrok.io/lookup" rel="noopener ugc nofollow" target="_blank">https://50bb377c3857.ngrok.io/lookup</a></p><p id="eb1e" class="pw-post-body-paragraph ku kv in kw b kx ky jo kz la lb jr lc ld le lf lg lh li lj lk ll lm ln lo lp ig bi translated">输出将如下所示:</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div class="gh gi mu"><img src="../Images/7e209a1e31948ef645ac9315c55d23d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:640/0*TRSurOJXpZTH9y5P"/></div></figure><p id="ecbc" class="pw-post-body-paragraph ku kv in kw b kx ky jo kz la lb jr lc ld le lf lg lh li lj lk ll lm ln lo lp ig bi translated">如果<code class="fe mn mo mp mq b">req.ip</code>不起作用，您可以尝试下面的代码从请求中获取IP地址。</p><pre class="kd ke kf kg gt mv mq mw mx aw my bi"><span id="f802" class="mz lr in mq b gy na nb l nc nd">const ip = (req.headers["x-forwarded-for"] || "").split(",").pop()||<br/>          req.connection.remoteAddress ||<br/>          req.socket.remoteAddress ||<br/>          req.connection.socket.remoteAddress;</span></pre><p id="518d" class="pw-post-body-paragraph ku kv in kw b kx ky jo kz la lb jr lc ld le lf lg lh li lj lk ll lm ln lo lp ig bi translated"><strong class="kw io"> <em class="ne">注意</em> </strong> <em class="ne">:如果想在AWS EB这样的云服务提供商上托管这个服务，需要配置</em> <code class="fe mn mo mp mq b"><em class="ne">nginx.config</em></code> <em class="ne">文件来检索请求源IP。</em></p><p id="780c" class="pw-post-body-paragraph ku kv in kw b kx ky jo kz la lb jr lc ld le lf lg lh li lj lk ll lm ln lo lp ig bi translated">这是所有的乡亲。一如既往，请在评论区自由表达你的想法。✨</p><p id="a735" class="pw-post-body-paragraph ku kv in kw b kx ky jo kz la lb jr lc ld le lf lg lh li lj lk ll lm ln lo lp ig bi translated">编码快乐！</p></div></div>    
</body>
</html>