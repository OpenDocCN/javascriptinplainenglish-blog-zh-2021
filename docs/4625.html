<html>
<head>
<title>An Introduction to Kafka with TypeScript using NestJS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用NestJS的打字稿介绍卡夫卡</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/a-beginners-introduction-to-kafka-with-typescript-using-nestjs-7c92fe78f638?source=collection_archive---------0-----------------------#2021-09-15">https://javascript.plainenglish.io/a-beginners-introduction-to-kafka-with-typescript-using-nestjs-7c92fe78f638?source=collection_archive---------0-----------------------#2021-09-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="e8a4" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">一个实用的方法，用真实的例子向你介绍Kafka，KafkaJS，NestJS微服务。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/f057f3f8e1857c0bd123465dd1aa805d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*u3IjD13EgKyfby4MD6SAmw.jpeg"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">We will use all Kafka APIs</figcaption></figure><p id="88f0" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">嘿，在这篇文章中，我们将介绍Kafka的基本操作，使用NestJS作为我们选择的基于Typescript的后端。</p><blockquote class="lr ls lt"><p id="181a" class="kv kw lu kx b ky kz jr la lb lc ju ld lv lf lg lh lw lj lk ll lx ln lo lp lq ij bi translated">像往常一样，如果你不想阅读，但看到了源代码…在文章的最后，你会发现我的git库，一切都设置好了。</p></blockquote><p id="68bb" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果你是新来的，我正在用媒体写一些随机的软件工程内容，特别是用打字稿。最近我用NestJS添加了一些关于GraphQL和T2 REST API的教程。在本文中，我将尝试跳过REST/GraphQL的一些内容，专注于Kafka和NestJS。</p><p id="ed04" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在继续之前，需要了解Docker、Node.js和Typescript/Javascript的基础知识，以便在没有太多问题的情况下遵循实用指南。</p><div class="lz ma gp gr mb mc"><a rel="noopener  ugc nofollow" target="_blank" href="/graphql-backend-in-nodejs-made-easy-with-nestjs-1489be18b994"><div class="md ab fo"><div class="me ab mf cl cj mg"><h2 class="bd ir gy z fp mh fr fs mi fu fw ip bi translated">使用NestJS简化Node.js中的GraphQL后端</h2><div class="mj l"><h3 class="bd b gy z fp mh fr fs mi fu fw dk translated">在本文中，我将向您展示如何以一种非常非常简单的方式开始一个GraphQL后端项目…使用NestJS！</h3></div><div class="mk l"><p class="bd b dl z fp mh fr fs mi fu fw dk translated">javascript.plainenglish.io</p></div></div><div class="ml l"><div class="mm l mn mo mp ml mq kp mc"/></div></div></a></div><h1 id="b331" class="mr ms iq bd mt mu mv mw mx my mz na nb jw nc jx nd jz ne ka nf kc ng kd nh ni bi translated">酷，那么卡夫卡是什么？</h1><p id="9fc4" class="pw-post-body-paragraph kv kw iq kx b ky nj jr la lb nk ju ld le nl lg lh li nm lk ll lm nn lo lp lq ij bi translated">在动手之前，简单的解释总是有效的。我们使用Kafka，但正式的方式是Apache Kafka，它是一个使用流处理的软件总线的框架实现，并且是开源的。维基百科给出了更详细的解释<a class="ae ly" href="https://en.wikipedia.org/wiki/Apache_Kafka" rel="noopener ugc nofollow" target="_blank">这里</a>。</p><p id="6482" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">试着抽象一下解释，你可以考虑一种方法，你可以发送消息到特定的地方，在那里你“不在乎”谁会收到它，如果他们会收到的话。你放消息的这些特定地方被称为<strong class="kx ir">主题</strong>，你可以认为当你在那里添加一条消息时，你就是一个<strong class="kx ir">生产者</strong>，任何获取这条信息的人都可以被认为是一个<strong class="kx ir">消费者。</strong>这一过程可以让数百万消费者以某种方式获得所发送的信息。</p><p id="eed4" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">该过程是完全异步的，包含五个主要的API:</p><ul class=""><li id="c474" class="no np iq kx b ky kz lb lc le nq li nr lm ns lq nt nu nv nw bi translated">生产者:负责创建消息</li><li id="c15e" class="no np iq kx b ky nx lb ny le nz li oa lm ob lq nt nu nv nw bi translated">消费者:负责…消费信息</li><li id="3e67" class="no np iq kx b ky nx lb ny le nz li oa lm ob lq nt nu nv nw bi translated">连接器:可以“重用”生产者/消费者API和链接主题</li><li id="1fb3" class="no np iq kx b ky nx lb ny le nz li oa lm ob lq nt nu nv nw bi translated">流:负责将输入转换为输出结果</li><li id="5790" class="no np iq kx b ky nx lb ny le nz li oa lm ob lq nt nu nv nw bi translated">Admin:用于管理Kafka主题。</li></ul><p id="0f4f" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们可能要花几百个小时去深入了解卡夫卡是什么、为什么以及如何有趣，但现在我们将集中在一个简短的现实生活例子中使用它。</p><blockquote class="lr ls lt"><p id="dca0" class="kv kw lu kx b ky kz jr la lb lc ju ld lv lf lg lh lw lj lk ll lx ln lo lp lq ij bi translated">想看看谁也用卡夫卡？所有财富100强企业的<a class="ae ly" href="https://kafka.apache.org/" rel="noopener ugc nofollow" target="_blank"> ~80%呢？</a></p></blockquote><p id="f8ad" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">对于使用卡夫卡，你是幸运的！你不需要做太多的事情来使它运行起来。在<a class="ae ly" href="https://www.docker.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="kx ir"> Docker </strong> </a> <strong class="kx ir"> </strong>的帮助下，您将能够使用我的示例运行Docker命令来设置所有需要的服务器，并包括一个仪表板工具来简化我们的过程。</p><p id="ba3e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们可以开始了吗？</p></div><div class="ab cl oc od hu oe" role="separator"><span class="of bw bk og oh oi"/><span class="of bw bk og oh oi"/><span class="of bw bk og oh"/></div><div class="ij ik il im in"><p id="47c3" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在动手之前，我们必须确保我们已经配置了一个Kafka，并且正在运行。继续之前，请确保您的计算机中有Docker。由于我们要使用NestJS，我将使用一个名为nestjs-kafka-tutorial的文件夹，其中将包含我要共享的<a class="ae ly" href="https://github.com/makinhs/nestjs-kafka-tutorial" rel="noopener ugc nofollow" target="_blank"> github项目</a>。因此，在您的工作文件夹中，让我们首先创建一个允许我们运行我们需要运行的文件，名为<strong class="kx ir"> docker-compose.yml </strong>，包含以下内容:</p><pre class="kg kh ki kj gt oj ok ol om aw on bi"><span id="2021" class="oo ms iq ok b gy op oq l or os">version: '2'<br/>services:<br/>  zookeeper:<br/>    image: confluentinc/cp-zookeeper:latest<br/>    environment:<br/>      ZOOKEEPER_CLIENT_PORT: 2181<br/>      ZOOKEEPER_TICK_TIME: 2000<br/>    ports:<br/>      - 22181:2181<br/><br/>  kafka:<br/>    image: confluentinc/cp-kafka:latest<br/>    depends_on:<br/>      - zookeeper<br/>    ports:<br/>      - 29092:29092<br/>    environment:<br/>      KAFKA_BROKER_ID: 1<br/>      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181<br/>      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:29092<br/>      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT<br/>      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT<br/>      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1<br/><br/>  kafka_ui:<br/>    image: provectuslabs/kafka-ui:latest<br/>    depends_on:<br/>      - kafka<br/>    ports:<br/>      - 8080:8080<br/>    environment:<br/>      KAFKA_CLUSTERS_0_ZOOKEEPER: zookeeper:2181<br/>      KAFKA_CLUSTERS_0_NAME: local<br/>      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:9092</span></pre><p id="d031" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">简而言之，我们正在运行一个必需的服务器、将被编排的代理和一个UI工具。那里的图片可以在网上免费使用，在我写这篇文章的时候仍然可以免费使用。</p><p id="f750" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这样，我们可以在您的根文件夹中运行以下命令:</p><pre class="kg kh ki kj gt oj ok ol om aw on bi"><span id="1aae" class="oo ms iq ok b gy op oq l or os">docker compose up -d</span></pre><p id="e50a" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这将反映在以下内容中:</p><pre class="kg kh ki kj gt oj ok ol om aw on bi"><span id="a0c1" class="oo ms iq ok b gy op oq l or os">➜  nestjs-kafka-tutorial git:(main) ✗ docker compose up -d<br/>[+] Running 4/4<br/> ⠿ Network nestjs-kafka-tutorial_default        Created                                                                                                                                                     0.1s<br/> ⠿ Container nestjs-kafka-tutorial_zookeeper_1  Started                                                                                                                                                     0.6s<br/> ⠿ Container nestjs-kafka-tutorial_kafka_1      Started                                                                                                                                                     1.5s<br/> ⠿ Container nestjs-kafka-tutorial_kafka_ui_1   Started                                                                                                                                                     2.4s<br/>➜  nestjs-kafka-tutorial git:(main) ✗</span></pre><p id="3ba9" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果将脱离终端(它将在后台运行),并将“神奇地”为您启动卡夫卡。要查看它是否工作，您只需打开<a class="ae ly" href="http://localhost:8080/" rel="noopener ugc nofollow" target="_blank"> http://localhost:8080/ </a>，将会看到以下内容:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ot"><img src="../Images/6c2af7228a6ee2dc2002d3aa575db42e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jIE1TXvHbf0-E4UnacdKhw.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">UI for Apache Kafka using the docker compose file</figcaption></figure><p id="6fc3" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果您有在线集群，您就可以开始了！</p><p id="4fb9" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们就来测试一下能不能和卡夫卡“玩”起来。让我们在主题按钮中创建一个<strong class="kx ir">主题</strong>，然后添加一个主题:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ou"><img src="../Images/ae08fe33ee4b4bcba80199c53f97a0f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*65LyjqB-Dv3Gmqk3J9s43w.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Adding a topic…</figcaption></figure><p id="5514" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在，我们可以用任何名称创建一个新主题(建议搜索命名模式):</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ov"><img src="../Images/30f29b4b35ca072a470d35a575b967a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NPYTxUaGkzBXpxV6u_b36A.png"/></div></div><figcaption class="kr ks gj gh gi kt ku bd b be z dk">Creating a medium.rocks topic</figcaption></figure><p id="015e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">通过这个设置，我们可以向一个名为“medum.rocks”的主题发送消息。现在，要使用仪表板发送消息，我们可以执行以下操作:</p><ul class=""><li id="84a3" class="no np iq kx b ky kz lb lc le nq li nr lm ns lq nt nu nv nw bi translated">点击<strong class="kx ir">产生信息</strong></li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ow"><img src="../Images/0deda6166516f246dca4024ef5cdca37.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ekysS1-NcBFqz62mT7YjEA.png"/></div></div></figure><ul class=""><li id="3e79" class="no np iq kx b ky kz lb lc le nq li nr lm ns lq nt nu nv nw bi translated">添加密钥和内容并发送</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ox"><img src="../Images/5b63421762ea57c7d4fa9427d2bee0c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vxJgRcmWJElSNpnwGSUaaA.png"/></div></div></figure><p id="64d4" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果刷新浏览器，您将看到以下内容:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oy"><img src="../Images/bcbf4ca118203525444079e0d936d9d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AMlNwMMaRpCHOatV2OrrVQ.png"/></div></div></figure><p id="519c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果你做了这些工作，我们就可以开始编码了！不要担心，在本文中，我们将通过STRING或其他方式共享JSON内容。毕竟，我们是爱打字稿的不是吗？</p></div><div class="ab cl oc od hu oe" role="separator"><span class="of bw bk og oh oi"/><span class="of bw bk og oh oi"/><span class="of bw bk og oh"/></div><div class="ij ik il im in"><p id="8b5e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">让我们做<a class="ae ly" href="https://nestjs.com/" rel="noopener ugc nofollow" target="_blank"> NestJS </a>！NestJS是一个非常可扩展的框架，默认情况下使用ExpressJS来支持构建API。它支持构建整体的和非整体的API。为了简化本文，我将在我的git repo中创建两个迷你项目，一个包含生产者项目，另一个包含消费者项目。我可能会在另一篇文章中回顾一下微服务配置和搭建，但这篇文章我们将让Kafka发挥作用！</p><p id="8438" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">因此，请确保安装他们的CLI:</p><pre class="kg kh ki kj gt oj ok ol om aw on bi"><span id="5f3a" class="oo ms iq ok b gy op oq l or os">npm i -g @nestjs/cli</span></pre><p id="e4fd" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在我们的根文件夹中，让我们创建生产者API！</p><pre class="kg kh ki kj gt oj ok ol om aw on bi"><span id="3da6" class="oo ms iq ok b gy op oq l or os">nest new producer</span></pre><p id="371e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我将使用yarn作为包管理器，但您可以随意使用您想要的任何东西:</p><pre class="kg kh ki kj gt oj ok ol om aw on bi"><span id="5bda" class="oo ms iq ok b gy op oq l or os"><strong class="ok ir">nestjs-kafka-tutorial</strong> <strong class="ok ir">git:(main)</strong> nest new producer</span><span id="2f50" class="oo ms iq ok b gy oz oq l or os">⚡  We will scaffold your app in a few seconds..</span><span id="0454" class="oo ms iq ok b gy oz oq l or os">CREATE producer/.eslintrc.js (631 bytes)</span><span id="dc73" class="oo ms iq ok b gy oz oq l or os">CREATE producer/.prettierrc (51 bytes)</span><span id="6790" class="oo ms iq ok b gy oz oq l or os">CREATE producer/README.md (3339 bytes)</span><span id="0316" class="oo ms iq ok b gy oz oq l or os">CREATE producer/nest-cli.json (64 bytes)</span><span id="9f35" class="oo ms iq ok b gy oz oq l or os">CREATE producer/package.json (1964 bytes)</span><span id="4040" class="oo ms iq ok b gy oz oq l or os">CREATE producer/tsconfig.build.json (97 bytes)</span><span id="6b92" class="oo ms iq ok b gy oz oq l or os">CREATE producer/tsconfig.json (365 bytes)</span><span id="9784" class="oo ms iq ok b gy oz oq l or os">CREATE producer/src/app.controller.spec.ts (617 bytes)</span><span id="055c" class="oo ms iq ok b gy oz oq l or os">CREATE producer/src/app.controller.ts (274 bytes)</span><span id="3557" class="oo ms iq ok b gy oz oq l or os">CREATE producer/src/app.module.ts (249 bytes)</span><span id="bb8e" class="oo ms iq ok b gy oz oq l or os">CREATE producer/src/app.service.ts (142 bytes)</span><span id="1723" class="oo ms iq ok b gy oz oq l or os">CREATE producer/src/main.ts (208 bytes)</span><span id="f9b9" class="oo ms iq ok b gy oz oq l or os">CREATE producer/test/app.e2e-spec.ts (630 bytes)</span><span id="c94c" class="oo ms iq ok b gy oz oq l or os">CREATE producer/test/jest-e2e.json (183 bytes)</span><span id="36c2" class="oo ms iq ok b gy oz oq l or os">? <strong class="ok ir">Which package manager would you ❤️  to use?</strong> yarn</span><span id="8e77" class="oo ms iq ok b gy oz oq l or os">✔ Installation in progress... ☕</span><span id="fe60" class="oo ms iq ok b gy oz oq l or os">🚀  Successfully created project producer</span><span id="9c7e" class="oo ms iq ok b gy oz oq l or os">👉  Get started with the following commands:</span><span id="9d1e" class="oo ms iq ok b gy oz oq l or os">$ cd producer</span><span id="b712" class="oo ms iq ok b gy oz oq l or os">$ yarn run start</span><span id="ec4f" class="oo ms iq ok b gy oz oq l or os">Thanks for installing Nest 🙏</span><span id="a8dc" class="oo ms iq ok b gy oz oq l or os">Please consider donating to our open collective</span><span id="1563" class="oo ms iq ok b gy oz oq l or os">to help us maintain this package.</span><span id="3cc2" class="oo ms iq ok b gy oz oq l or os"><strong class="ok ir">🍷  Donate:</strong> https://opencollective.com/nest</span></pre><p id="6bae" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这应该足够搭建基本的NestJS项目了。NestJS项目的基本框架给出了一个最小的配置，其中设置了一个REST端点，运行在端口3000上。对于这一部分，请确保在您的终端中，您正在名为“producer”的文件夹中工作。</p><p id="950c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在生成器内部执行任何操作之前，请移除。git文件夹和。gitignore因为在这个项目中我们已经有了。git在我们的根，我们避免过度配置和不谈论卡夫卡。</p><pre class="kg kh ki kj gt oj ok ol om aw on bi"><span id="bf3d" class="oo ms iq ok b gy op oq l or os">nestjs-kafka-tutorial git:(main) ✗ cd producer<br/>producer git:(master) ✗ rm -rf .git<br/>➜  producer git:(main) ✗<br/>➜  producer git:(main) ✗ rm -rf .gitignore <br/>➜  producer git:(main) ✗</span></pre><p id="7e71" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们现在需要添加Kafka和微服务模块。</p><p id="90ea" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">添加卡夫卡很简单，如下所示:</p><pre class="kg kh ki kj gt oj ok ol om aw on bi"><span id="40e6" class="oo ms iq ok b gy op oq l or os">yarn add kafkajs</span></pre><p id="4bd7" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">回应会是这样的:</p><pre class="kg kh ki kj gt oj ok ol om aw on bi"><span id="19d6" class="oo ms iq ok b gy op oq l or os"><strong class="ok ir">➜  producer</strong> <strong class="ok ir">git:(main) ✗</strong> yarn add kafkajs</span><span id="a5d3" class="oo ms iq ok b gy oz oq l or os"><strong class="ok ir">yarn add v1.22.10</strong></span><span id="832c" class="oo ms iq ok b gy oz oq l or os">warning ../../../package.json: No license field</span><span id="3329" class="oo ms iq ok b gy oz oq l or os">[1/4] 🔍  Resolving packages...</span><span id="062a" class="oo ms iq ok b gy oz oq l or os">[2/4] 🚚  Fetching packages...</span><span id="55df" class="oo ms iq ok b gy oz oq l or os">[3/4] 🔗  Linking dependencies...</span><span id="d5cb" class="oo ms iq ok b gy oz oq l or os">warning " &gt; ts-loader@9.2.5" has unmet peer dependency "webpack@^5.0.0".</span><span id="ebcb" class="oo ms iq ok b gy oz oq l or os">[4/4] 🔨  Building fresh packages...</span><span id="8906" class="oo ms iq ok b gy oz oq l or os">success Saved lockfile.</span><span id="a227" class="oo ms iq ok b gy oz oq l or os">success Saved 1 new dependency.</span><span id="6c25" class="oo ms iq ok b gy oz oq l or os">info Direct dependencies</span><span id="11c8" class="oo ms iq ok b gy oz oq l or os">└─ kafkajs@1.15.0</span><span id="529d" class="oo ms iq ok b gy oz oq l or os">info All dependencies</span><span id="0842" class="oo ms iq ok b gy oz oq l or os">└─ kafkajs@1.15.0</span><span id="aaa5" class="oo ms iq ok b gy oz oq l or os">✨  Done in 3.61s.</span></pre><p id="ad2c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在，微服务模块:</p><pre class="kg kh ki kj gt oj ok ol om aw on bi"><span id="3b56" class="oo ms iq ok b gy op oq l or os">yarn add @nestjs/microservices</span></pre><p id="d4c7" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">大概是这样的:</p><pre class="kg kh ki kj gt oj ok ol om aw on bi"><span id="de2a" class="oo ms iq ok b gy op oq l or os"><strong class="ok ir">➜  producer</strong> <strong class="ok ir">git:(main) ✗</strong> yarn add @nestjs/microservices</span><span id="0d56" class="oo ms iq ok b gy oz oq l or os"><strong class="ok ir">yarn add v1.22.10</strong></span><span id="e80c" class="oo ms iq ok b gy oz oq l or os">warning ../../../package.json: No license field</span><span id="5fd1" class="oo ms iq ok b gy oz oq l or os">[1/4] 🔍  Resolving packages...</span><span id="6a6e" class="oo ms iq ok b gy oz oq l or os">[2/4] 🚚  Fetching packages...</span><span id="e670" class="oo ms iq ok b gy oz oq l or os">[3/4] 🔗  Linking dependencies...</span><span id="df91" class="oo ms iq ok b gy oz oq l or os">warning " &gt; ts-loader@9.2.5" has unmet peer dependency "webpack@^5.0.0".</span><span id="dc6f" class="oo ms iq ok b gy oz oq l or os">[4/4] 🔨  Building fresh packages...</span><span id="73c5" class="oo ms iq ok b gy oz oq l or os">success Saved lockfile.</span><span id="8186" class="oo ms iq ok b gy oz oq l or os">success Saved 2 new dependencies.</span><span id="bfa5" class="oo ms iq ok b gy oz oq l or os">info Direct dependencies</span><span id="96bf" class="oo ms iq ok b gy oz oq l or os">└─ @nestjs/microservices@8.0.6</span><span id="1ff7" class="oo ms iq ok b gy oz oq l or os">info All dependencies</span><span id="647e" class="oo ms iq ok b gy oz oq l or os">├─ @nestjs/microservices@8.0.6</span><span id="53c7" class="oo ms iq ok b gy oz oq l or os">└─ json-socket@0.3.0</span><span id="c6c8" class="oo ms iq ok b gy oz oq l or os">✨  Done in 5.07s.</span><span id="be26" class="oo ms iq ok b gy oz oq l or os"><strong class="ok ir">➜  producer</strong> <strong class="ok ir">git:(main) ✗</strong></span></pre><p id="ce33" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">酷，我们至少要为我们的制作人做点什么！</p><p id="1933" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在，使用我们的app.module.ts，它是NestJS应用程序的主模块，我们可以像下面这样配置Kafka模块:</p><pre class="kg kh ki kj gt oj ok ol om aw on bi"><span id="971b" class="oo ms iq ok b gy op oq l or os">import { Module } from '@nestjs/common';<br/>import { AppController } from './app.controller';<br/>import { AppService } from './app.service';<br/>import {ClientsModule, Transport} from '@nestjs/microservices';<br/><br/>@Module({<br/>  imports: [<br/>    ClientsModule.<em class="lu">register</em>([<br/>      {<br/>        name: 'any_name_i_want',<br/>        transport: Transport.<em class="lu">KAFKA</em>,<br/>        options: {<br/>          client: {<br/>            clientId: 'any_client_id_i_want',<br/>            brokers: ['localhost:29092'],<br/>          },<br/>          consumer: {<br/>            groupId: 'an_unique_string_id',<br/>          },<br/>        },<br/>      },<br/>    ]),<br/>  ],<br/>  controllers: [AppController],<br/>  providers: [AppService],<br/>})<br/>export class AppModule {}</span></pre><p id="eef6" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">同样，为了便于在不同的环境中运行同一个项目，我避免但100%建议将任何硬代码配置字符串移动到. env文件中。除此之外，这里最重要的是:</p><pre class="kg kh ki kj gt oj ok ol om aw on bi"><span id="90d6" class="oo ms iq ok b gy op oq l or os">brokers: ['localhost:29092'],</span></pre><p id="1322" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这个端口29092和localhost是在我们的<strong class="kx ir"> docker-compose.yml </strong>中设置的。在实际场景中，您应该将这个URL更改为您的stage/production URL，并再次使用. env文件来设置它，否则您将会编写过多的代码。</p><p id="054f" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">让我们运行应用程序，看看在添加Kafka模块时是否有任何错误:</p><pre class="kg kh ki kj gt oj ok ol om aw on bi"><span id="6bf6" class="oo ms iq ok b gy op oq l or os">➜  producer git:(main) ✗ yarn start<br/>yarn run v1.22.10<br/>warning ../../../package.json: No license field<br/>$ nest start<br/>[Nest] 14895  - 09/15/2021, 10:09:16 PM     LOG [NestFactory] Starting Nest application...<br/>[Nest] 14895  - 09/15/2021, 10:09:16 PM     LOG [InstanceLoader] ClientsModule dependencies initialized +27ms<br/>[Nest] 14895  - 09/15/2021, 10:09:16 PM     LOG [InstanceLoader] AppModule dependencies initialized +0ms<br/>[Nest] 14895  - 09/15/2021, 10:09:16 PM     LOG [RoutesResolver] AppController {/}: +4ms<br/>[Nest] 14895  - 09/15/2021, 10:09:16 PM     LOG [RouterExplorer] Mapped {/, GET} route +2ms<br/>[Nest] 14895  - 09/15/2021, 10:09:16 PM     LOG [NestApplication] Nest application successfully started +1ms</span></pre><p id="09ca" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">似乎一切都好！使用ClientsModule，我们可以在控制器中注入一个Kafka客户端！让我们现在就开始吧:</p></div><div class="ab cl oc od hu oe" role="separator"><span class="of bw bk og oh oi"/><span class="of bw bk og oh oi"/><span class="of bw bk og oh"/></div><div class="ij ik il im in"><p id="7c49" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">要使用kafka客户端，请访问您的src/app.controller.ts。</p><p id="7170" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">它包含脚手架的以下内容:</p><pre class="kg kh ki kj gt oj ok ol om aw on bi"><span id="1634" class="oo ms iq ok b gy op oq l or os">import { Controller, <strong class="ok ir"><em class="lu">Get </em></strong>} from '@nestjs/common';<br/>import { AppService } from './app.service';<br/><br/>@Controller()<br/>export class AppController {<br/>  constructor(private readonly appService: AppService) {}<br/><br/>  @Get()<br/>  getHello(): string {<br/>    return this.appService.getHello();<br/>  }<br/>}</span></pre><p id="147c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在构造函数中，我们可以像下面这样简单地添加kafka客户端:</p><pre class="kg kh ki kj gt oj ok ol om aw on bi"><span id="0510" class="oo ms iq ok b gy op oq l or os">import { Controller, <strong class="ok ir"><em class="lu">Get</em></strong>, Inject } from '@nestjs/common';<br/>import { AppService } from './app.service';<br/>import { ClientKafka } from '@nestjs/microservices';<br/><br/>@Controller()<br/>export class AppController {<br/>  constructor(<br/>    private readonly appService: AppService,<br/>    @Inject('any_name_i_want') private readonly client: ClientKafka,<br/>  ) {}<br/><br/>  @Get()<br/>  getHello(): string {<br/>    return this.appService.getHello();<br/>  }<br/>}</span></pre><p id="c62c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这里唯一看起来奇怪的是“任何名字我想要”。这个变量应该与您在客户端模块上设置的相同，这已经是复制代码，也是将它放在. env上的另一个原因。</p></div><div class="ab cl oc od hu oe" role="separator"><span class="of bw bk og oh oi"/><span class="of bw bk og oh oi"/><span class="of bw bk og oh"/></div><div class="ij ik il im in"><p id="5522" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">酷，现在添加了一个名为“kafka-test”的随机“get”请求，你永远不能说它是一个REST端点:</p><pre class="kg kh ki kj gt oj ok ol om aw on bi"><span id="6652" class="oo ms iq ok b gy op oq l or os">import { Controller, <strong class="ok ir"><em class="lu">Get</em></strong>, Inject } from '@nestjs/common';<br/>import { AppService } from './app.service';<br/>import { ClientKafka } from '@nestjs/microservices';<br/><br/>@Controller()<br/>export class AppController {<br/>  constructor(<br/>    private readonly appService: AppService,<br/>    @Inject('any_name_i_want') private readonly client: ClientKafka,<br/>  ) {}<br/><br/>  @Get()<br/>  getHello(): string {<br/>    return this.appService.getHello();<br/>  }<br/><br/>  @Get('kafka-test')<br/>  testKafka(){<br/>    return this.client.emit('medium.rocks', {foo:'bar'})<br/>  }<br/>}</span></pre><p id="a6c3" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">当您点击get to localhost:3000/kafka-test时，该应用程序将尝试向我们之前创建的名为“medium.rocks”的主题发出一条JSON消息。我用Postman来测试，但是你可以像这样卷曲:</p><pre class="kg kh ki kj gt oj ok ol om aw on bi"><span id="7941" class="oo ms iq ok b gy op oq l or os">curl --location --request GET 'http://localhost:3000/kafka-test'</span></pre><p id="8e36" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">您将收到类似以下内容的邮件:</p><pre class="kg kh ki kj gt oj ok ol om aw on bi"><span id="b375" class="oo ms iq ok b gy op oq l or os">[</span><span id="07ba" class="oo ms iq ok b gy oz oq l or os">{</span><span id="3267" class="oo ms iq ok b gy oz oq l or os">"topicName": "medium.rocks",</span><span id="dbbb" class="oo ms iq ok b gy oz oq l or os">"partition": 0,</span><span id="b91b" class="oo ms iq ok b gy oz oq l or os">"errorCode": 0,</span><span id="0111" class="oo ms iq ok b gy oz oq l or os">"baseOffset": "2",</span><span id="8519" class="oo ms iq ok b gy oz oq l or os">"logAppendTime": "-1",</span><span id="e42f" class="oo ms iq ok b gy oz oq l or os">"logStartOffset": "0"</span><span id="8711" class="oo ms iq ok b gy oz oq l or os">}</span><span id="7c23" class="oo ms iq ok b gy oz oq l or os">]</span></pre><p id="196d" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这只是确认你发送了你想要的信息。</p><p id="e157" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">回到我们之前讨论过的kafka仪表板，您可以刷新浏览器并看到以下内容:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pa"><img src="../Images/49b4ecf79ba3adb7a86f39740466ea12.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*P0KaoZWU69Hg957X0ywHpA.png"/></div></div></figure><p id="25c6" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在你有了foo/bar内容和Kafka的另一个好处…消费者不需要实时阅读你的信息。我不会在这方面深入探讨，但是您可以配置一个消费者从一个特定的点或者只从“实时消息”中读取，这为您作为一个软件工程师创造了许多可能性。</p><p id="7ad2" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">对于初学者来说，我们已经和制作人结束了。现在我们去创建一个消费者，作为奖励，我想展示一种经典的“请求/响应”方法，当卡夫卡之间交流时，有时<strong class="kx ir">使用</strong>是有意义的。</p></div><div class="ab cl oc od hu oe" role="separator"><span class="of bw bk og oh oi"/><span class="of bw bk og oh oi"/><span class="of bw bk og oh"/></div><div class="ij ik il im in"><p id="012e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">为了创建一个消费者，我们将完全按照<strong class="kx ir">相同的</strong>NestJS搭建…所以回到我们的根文件夹:</p><pre class="kg kh ki kj gt oj ok ol om aw on bi"><span id="8dcb" class="oo ms iq ok b gy op oq l or os">nest new consumer</span></pre><p id="e5cc" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">作为生产者的回应:</p><pre class="kg kh ki kj gt oj ok ol om aw on bi"><span id="3b0b" class="oo ms iq ok b gy op oq l or os"><strong class="ok ir">➜  nestjs-kafka-tutorial</strong> <strong class="ok ir">git:(main) ✗</strong> nest new consumer</span><span id="9344" class="oo ms iq ok b gy oz oq l or os">⚡  We will scaffold your app in a few seconds..</span><span id="2205" class="oo ms iq ok b gy oz oq l or os">CREATE consumer/.eslintrc.js (631 bytes)</span><span id="4091" class="oo ms iq ok b gy oz oq l or os">CREATE consumer/.prettierrc (51 bytes)</span><span id="7f60" class="oo ms iq ok b gy oz oq l or os">CREATE consumer/README.md (3339 bytes)</span><span id="a0ce" class="oo ms iq ok b gy oz oq l or os">CREATE consumer/nest-cli.json (64 bytes)</span><span id="0c67" class="oo ms iq ok b gy oz oq l or os">CREATE consumer/package.json (1964 bytes)</span><span id="f1fe" class="oo ms iq ok b gy oz oq l or os">CREATE consumer/tsconfig.build.json (97 bytes)</span><span id="f9fb" class="oo ms iq ok b gy oz oq l or os">CREATE consumer/tsconfig.json (365 bytes)</span><span id="b181" class="oo ms iq ok b gy oz oq l or os">CREATE consumer/src/app.controller.spec.ts (617 bytes)</span><span id="2ee3" class="oo ms iq ok b gy oz oq l or os">CREATE consumer/src/app.controller.ts (274 bytes)</span><span id="1e92" class="oo ms iq ok b gy oz oq l or os">CREATE consumer/src/app.module.ts (249 bytes)</span><span id="cac2" class="oo ms iq ok b gy oz oq l or os">CREATE consumer/src/app.service.ts (142 bytes)</span><span id="f1a1" class="oo ms iq ok b gy oz oq l or os">CREATE consumer/src/main.ts (208 bytes)</span><span id="5c87" class="oo ms iq ok b gy oz oq l or os">CREATE consumer/test/app.e2e-spec.ts (630 bytes)</span><span id="832b" class="oo ms iq ok b gy oz oq l or os">CREATE consumer/test/jest-e2e.json (183 bytes)</span><span id="f21a" class="oo ms iq ok b gy oz oq l or os">? <strong class="ok ir">Which package manager would you ❤️  to use?</strong> yarn</span><span id="775f" class="oo ms iq ok b gy oz oq l or os">✔ Installation in progress... ☕</span><span id="fd7e" class="oo ms iq ok b gy oz oq l or os">🚀  Successfully created project consumer</span><span id="363e" class="oo ms iq ok b gy oz oq l or os">👉  Get started with the following commands:</span><span id="b144" class="oo ms iq ok b gy oz oq l or os">$ cd consumer</span><span id="c3c1" class="oo ms iq ok b gy oz oq l or os">$ yarn run start</span><span id="5e9d" class="oo ms iq ok b gy oz oq l or os">Thanks for installing Nest 🙏</span><span id="994e" class="oo ms iq ok b gy oz oq l or os">Please consider donating to our open collective</span><span id="6af7" class="oo ms iq ok b gy oz oq l or os">to help us maintain this package.</span><span id="d1e7" class="oo ms iq ok b gy oz oq l or os"><strong class="ok ir">🍷  Donate:</strong> https://opencollective.com/nest</span><span id="72ca" class="oo ms iq ok b gy oz oq l or os"><strong class="ok ir">➜  nestjs-kafka-tutorial</strong> <strong class="ok ir">git:(main) ✗</strong></span></pre><p id="c3e6" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在打开消费者文件夹并移除。饭桶和。gitignore <em class="lu">为了</em> <em class="lu">为了这篇文章:</em></p><pre class="kg kh ki kj gt oj ok ol om aw on bi"><span id="7135" class="oo ms iq ok b gy op oq l or os"><strong class="ok ir">➜  nestjs-kafka-tutorial</strong> <strong class="ok ir">git:(main) ✗</strong> cd consumer</span><span id="5287" class="oo ms iq ok b gy oz oq l or os"><strong class="ok ir">➜  consumer</strong> <strong class="ok ir">git:(master) ✗</strong> rm -rf .git .gitignore</span></pre><p id="5a53" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">从NestJS安装kafkajs和微服务模块:</p><pre class="kg kh ki kj gt oj ok ol om aw on bi"><span id="534e" class="oo ms iq ok b gy op oq l or os"><strong class="ok ir">➜  consumer</strong> <strong class="ok ir">git:(main) ✗</strong> yarn add @nestjs/microservices kafkajs</span><span id="e59d" class="oo ms iq ok b gy oz oq l or os"><strong class="ok ir">yarn add v1.22.10</strong></span><span id="a9d9" class="oo ms iq ok b gy oz oq l or os">warning ../../../package.json: No license field</span><span id="4382" class="oo ms iq ok b gy oz oq l or os">[1/4] 🔍  Resolving packages...</span><span id="60f5" class="oo ms iq ok b gy oz oq l or os">[2/4] 🚚  Fetching packages...</span><span id="ae24" class="oo ms iq ok b gy oz oq l or os">[3/4] 🔗  Linking dependencies...</span><span id="2148" class="oo ms iq ok b gy oz oq l or os">warning " &gt; ts-loader@9.2.5" has unmet peer dependency "webpack@^5.0.0".</span><span id="c918" class="oo ms iq ok b gy oz oq l or os">[4/4] 🔨  Building fresh packages...</span><span id="38b7" class="oo ms iq ok b gy oz oq l or os">success Saved lockfile.</span><span id="3147" class="oo ms iq ok b gy oz oq l or os">success Saved 3 new dependencies.</span><span id="7108" class="oo ms iq ok b gy oz oq l or os">info Direct dependencies</span><span id="7800" class="oo ms iq ok b gy oz oq l or os">├─ @nestjs/microservices@8.0.6</span><span id="8cd0" class="oo ms iq ok b gy oz oq l or os">└─ kafkajs@1.15.0</span><span id="8949" class="oo ms iq ok b gy oz oq l or os">info All dependencies</span><span id="8103" class="oo ms iq ok b gy oz oq l or os">├─ @nestjs/microservices@8.0.6</span><span id="62fa" class="oo ms iq ok b gy oz oq l or os">├─ json-socket@0.3.0</span><span id="c354" class="oo ms iq ok b gy oz oq l or os">└─ kafkajs@1.15.0</span><span id="03d2" class="oo ms iq ok b gy oz oq l or os">✨  Done in 6.53s.</span><span id="cf92" class="oo ms iq ok b gy oz oq l or os"><strong class="ok ir">➜  consumer</strong> <strong class="ok ir">git:(main) ✗</strong></span></pre><p id="9b7e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在，打开consumer/src/app.module.ts:</p><pre class="kg kh ki kj gt oj ok ol om aw on bi"><span id="8d89" class="oo ms iq ok b gy op oq l or os">import { Module } from '@nestjs/common';<br/>import { AppController } from './app.controller';<br/>import { AppService } from './app.service';<br/>import { ClientsModule, Transport } from '@nestjs/microservices';<br/><br/>@Module({<br/>  imports: [<br/>    ClientsModule.<em class="lu">register</em>([<br/>      {<br/>        name: 'any_name_i_want',<br/>        transport: Transport.<em class="lu">KAFKA</em>,<br/>        options: {<br/>          client: {<br/>            clientId: 'any_client_id_i_want',<br/>            brokers: ['localhost:29092'],<br/>          },<br/>          consumer: {<br/>            groupId: 'an_unique_string_id',<br/>          },<br/>        },<br/>      },<br/>    ]),<br/>  ],<br/>  controllers: [AppController],<br/>  providers: [AppService],<br/>})<br/>export class AppModule {}</span></pre><blockquote class="lr ls lt"><p id="cff1" class="kv kw lu kx b ky kz jr la lb lc ju ld lv lf lg lh lw lj lk ll lx ln lo lp lq ij bi translated">再次…这篇文章只是为了展示如何在Typescript中使用Kafka，用NestJS。请不要在你的项目中使用硬编码配置。请至少使用. env。</p></blockquote><p id="a907" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">一切看起来都一样，对吗？但是，对于消费者来说，我们需要更改<strong class="kx ir"> main.ts </strong>文件，允许我们消费消息。为此，我们将使用以下内容更新main.ts:</p><pre class="kg kh ki kj gt oj ok ol om aw on bi"><span id="6dbf" class="oo ms iq ok b gy op oq l or os">import { <strong class="ok ir"><em class="lu">NestFactory </em></strong>} from '@nestjs/core';<br/>import { AppModule } from './app.module';<br/>import {MicroserviceOptions, Transport} from '@nestjs/microservices';<br/><br/>async function bootstrap() {<br/>  const app = await <strong class="ok ir"><em class="lu">NestFactory</em></strong>.createMicroservice&lt;MicroserviceOptions&gt;(<br/>    AppModule,<br/>    {<br/>      transport: Transport.<em class="lu">KAFKA</em>,<br/>      options: {<br/>        client: {<br/>          brokers: ['localhost:29092'],<br/>        },<br/>      },<br/>    },<br/>  );<br/>  await app.listen();<br/>}<br/>bootstrap();</span></pre><blockquote class="lr ls lt"><p id="01c8" class="kv kw lu kx b ky kz jr la lb lc ju ld lv lf lg lh lw lj lk ll lx ln lo lp lq ij bi translated">我已经说了很多，但是经纪人可能会使用. env文件…这是你的功课</p></blockquote><p id="23da" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在，我们终于要配置消费者了…我们将重构脚手架，并聆听“medium.rocks”主题。要做到这一点，在我们的app.controller.ts中，让我们用以下内容进行重构:</p><pre class="kg kh ki kj gt oj ok ol om aw on bi"><span id="14e9" class="oo ms iq ok b gy op oq l or os">import {Controller} from '@nestjs/common';<br/>import {<br/>  <strong class="ok ir"><em class="lu">Ctx</em></strong>,<br/>  KafkaContext,<br/>  <strong class="ok ir"><em class="lu">MessagePattern</em></strong>,<br/>  Payload,<br/>} from '@nestjs/microservices';<br/><br/>@Controller()<br/>export class AppController {<br/>  constructor() {<br/>  }<br/><br/>  @MessagePattern('medium.rocks')<br/>  readMessage(@Payload() message: any, @Ctx() context: KafkaContext) {<br/>    const originalMessage = context.getMessage();<br/>    const response =<br/>      `Receiving a new message from topic: medium.rocks: ` +<br/>      <strong class="ok ir"><em class="lu">JSON</em></strong>.stringify(originalMessage.value);<br/>    <strong class="ok ir"><em class="lu">console</em></strong>.log(response);<br/>    return response;<br/>  }<br/>}</span></pre><p id="421f" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在我们有了一个名为<strong class="kx ir"> readMessage </strong>的函数，它会尝试不时地读取来自名为“medium.rocks”的主题的任何消息，如果发生了什么，它会记录在我们的控制台中。</p><p id="69e3" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在测试之前，我将在producer/src/app.controller.ts中添加一个日期，以便查看我们发送的消息的差异:</p><pre class="kg kh ki kj gt oj ok ol om aw on bi"><span id="a109" class="oo ms iq ok b gy op oq l or os">@Get('kafka-test')<br/>testKafka(){<br/>  return this.client.emit('medium.rocks', {foo:'bar', data: new <strong class="ok ir"><em class="lu">Date</em></strong>().toString()})<br/>}</span></pre><p id="02c3" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">请在继续之前重新启动您的生成器。</p><p id="2040" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">一旦生成器重新启动，在另一个选项卡中，请使用以下命令启动使用者:</p><pre class="kg kh ki kj gt oj ok ol om aw on bi"><span id="3ddd" class="oo ms iq ok b gy op oq l or os">yarn start</span></pre><p id="3cda" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">您将看到如下内容:</p><pre class="kg kh ki kj gt oj ok ol om aw on bi"><span id="033c" class="oo ms iq ok b gy op oq l or os">➜  consumer git:(main) ✗ yarn start<br/>yarn run v1.22.10<br/>warning ../../../package.json: No license field<br/>$ nest start<br/>[Nest] 16855  - 09/15/2021, 10:47:23 PM     LOG [NestFactory] Starting Nest application...<br/>[Nest] 16855  - 09/15/2021, 10:47:23 PM     LOG [InstanceLoader] ClientsModule dependencies initialized +25ms<br/>[Nest] 16855  - 09/15/2021, 10:47:23 PM     LOG [InstanceLoader] AppModule dependencies initialized +1ms<br/>[Nest] 16855  - 09/15/2021, 10:47:23 PM     LOG [ServerKafka] INFO [Consumer] Starting {"timestamp":"2021-09-15T20:47:23.274Z","logger":"kafkajs","groupId":"nestjs-group-server"}<br/>[Nest] 16855  - 09/15/2021, 10:47:26 PM     LOG [ServerKafka] INFO [ConsumerGroup] Consumer has joined the group {"timestamp":"2021-09-15T20:47:26.292Z","logger":"kafkajs","groupId":"nestjs-group-server","memberId":"nestjs-consumer-server-f20adf4c-dca8-4196-9a08-f33a88ae281f","leaderId":"nestjs-consumer-server-f20adf4c-dca8-4196-9a08-f33a88ae281f","isLeader":true,"memberAssignment":{"medium.rocks":[0]},"groupProtocol":"RoundRobinAssigner","duration":3017}<br/>[Nest] 16855  - 09/15/2021, 10:47:26 PM     LOG [NestMicroservice] Nest microservice successfully started +5ms</span></pre><p id="ec50" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在我们可以再次卷曲我们的生产者:</p><pre class="kg kh ki kj gt oj ok ol om aw on bi"><span id="c0ae" class="oo ms iq ok b gy op oq l or os">curl --location --request GET 'http://localhost:3000/kafka-test'</span></pre><p id="601e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">完成此操作后，在您的消费者选项卡中，您应该会看到如下内容:</p><pre class="kg kh ki kj gt oj ok ol om aw on bi"><span id="68f7" class="oo ms iq ok b gy op oq l or os">[Nest] 16855  - 09/15/2021, 10:47:26 PM     LOG [NestMicroservice] Nest microservice successfully started +5ms<br/>Receiving a new message from topic: medium.rocks: {"foo":"bar","data":"Wed Sep 15 2021 22:48:02 GMT+0200 (Central European Summer Time)"}</span></pre><p id="4498" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">就是这样。极其基础的场景用NestJS解决！您可以使用两个不同的应用程序从Kafka服务器生成和使用消息！</p><p id="7a5a" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">使用这种方法，您可以处理向特定主题发布消息和消费它们以处理收到的信息之间的大部分异步过程。</p><p id="6e98" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">当然，在微服务上还有一个全新的领域需要学习，还有如何配置Kafka的模式，如何命名主题，我们应该如何用模式、版本控制等等来处理消息……但是，通过这篇文章，至少你可以对正在发生的事情有一个最基本的了解。</p><p id="cf76" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在结束这篇庞大的初学者文章之前，我想为您实际需要接收已消费的Kafka消息的响应的特定情况添加一个概念证明。我们现在就开始吧！</p></div><div class="ab cl oc od hu oe" role="separator"><span class="of bw bk og oh oi"/><span class="of bw bk og oh oi"/><span class="of bw bk og oh"/></div><div class="ij ik il im in"><p id="28b2" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">为了尝试一种请求/响应方法，这种方法在一些场景中并不理想，但对于其他场景可能是有意义的，NestJS允许我们(在引擎盖下)接收来自消费者的响应。它基本上允许我们连接/断开同一个主题，我们正在发送一条消息，但以. reply结束。在我们的例子中，我们需要一个新的主题称为' medium.rocks.reply '。为此，我将在我们的UI工具中创建一个新主题:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pb"><img src="../Images/281354d5cad8413751ec3b827574b848.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mOgkYBRa0Z5y-aAFJzx-0w.png"/></div></div></figure><p id="7850" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这应该足以让NestJS处理请求/响应。</p><blockquote class="lr ls lt"><p id="f53d" class="kv kw lu kx b ky kz jr la lb lc ju ld lv lf lg lh lw lj lk ll lx ln lo lp lq ij bi translated">请注意，如果您没有任何关于自动创建主题的阻止程序，则可能不需要此过程，但在一些企业公司中，您可能需要在使用之前创建主题。在这篇文章中，我测试了创建和不创建两种方式，它们都有效，因为我们使用了docker compose，它不会<strong class="kx ir">阻止</strong>我们<strong class="kx ir">即时创建</strong>新主题。</p></blockquote><p id="5998" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在，在我们的生成器中，特别是在我们的控制器中，我们需要<strong class="kx ir">在收到响应之前发送</strong>一个事件，但是我们还需要配置一种接收它的方式，在NestJS中是的<strong class="kx ir">subscribe response。这个过程非常简单，应该是这样的:</strong></p><pre class="kg kh ki kj gt oj ok ol om aw on bi"><span id="d470" class="oo ms iq ok b gy op oq l or os">import {Controller, <strong class="ok ir"><em class="lu">Get</em></strong>, Inject, OnModuleDestroy, OnModuleInit} from '@nestjs/common';<br/>import { AppService } from './app.service';<br/>import { ClientKafka } from '@nestjs/microservices';<br/><br/>@Controller()<br/>export class AppController implements OnModuleInit, OnModuleDestroy{<br/>  constructor(<br/>    private readonly appService: AppService,<br/>    @Inject('any_name_i_want') private readonly client: ClientKafka,<br/>  ) {}<br/><br/>  async onModuleInit() {<br/>    ['medium.rocks'].forEach((key) =&gt; this.client.subscribeToResponseOf(`${key}`));<br/>    await this.client.connect();<br/>  }<br/><br/>  async onModuleDestroy() {<br/>    await this.client.close();<br/>  }<br/><br/>  @Get()<br/>  getHello(): string {<br/>    return this.appService.getHello();<br/>  }<br/><br/>  @Get('kafka-test')<br/>  testKafka(){<br/>    return this.client.emit('medium.rocks', {foo:'bar', data: new <strong class="ok ir"><em class="lu">Date</em></strong>().toString()})<br/>  }<br/><br/><br/>  @Get('kafka-test-with-response')<br/>  testKafkaWithResponse(){<br/>    return this.client.send('medium.rocks', {foo:'bar', data: new <strong class="ok ir"><em class="lu">Date</em></strong>().toString()})<br/>  }<br/><br/><br/>}</span></pre><p id="599a" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们只在<strong class="kx ir"> onModuleInit </strong>中添加了一个数组，因为在实际场景中，您的控制器可能会产生/监听多个主题。此外，NestJS将在试图订阅的主题中自动添加一个. reply。因此，在我们的例子中，它是<strong class="kx ir">中型。岩石。回复。</strong></p><p id="25c0" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">酷，那应该够了。让我们再次运行生产者，并点击卡夫卡-测试-回应:</p><pre class="kg kh ki kj gt oj ok ol om aw on bi"><span id="906c" class="oo ms iq ok b gy op oq l or os"><strong class="ok ir">➜  consumer</strong> <strong class="ok ir">git:(main) ✗</strong> curl --location --request GET 'http://localhost:3000/kafka-test-with-response'</span><span id="7d11" class="oo ms iq ok b gy oz oq l or os">Receiving a new message from topic: medium.rocks: {"foo":"bar","data":"Wed Sep 15 2021 23:11:13 GMT+0200 (Central European Summer Time)"}<strong class="ok ir">%</strong>                                                                              <strong class="ok ir">➜  consumer</strong> <strong class="ok ir">git:(main) ✗</strong></span></pre><p id="aa93" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">太棒了。我们既可以<strong class="kx ir">发出</strong>一条消息，也可以在特定的场景中等待响应！</p><p id="1599" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这两种方法应该可以让你面对现实生活中的大部分挑战！</p></div><div class="ab cl oc od hu oe" role="separator"><span class="of bw bk og oh oi"/><span class="of bw bk og oh oi"/><span class="of bw bk og oh"/></div><div class="ij ik il im in"><p id="93d7" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">Kafka、API、Typescript和软件工程太详细了，无法包含在一篇文章中。在本文中，我试图使用NestJS简化使用Typescript和Kafka进行编码的操作。尽管这篇文章是为Kafka的初学者写的，但是需要很多关于构建API的预备知识，知道Docker和Typescript。我真的希望这篇文章中的抽象能让你作为读者开始你的概念证明，并使用NestJS与Kafka一起玩。如果你想成为一名软件工程师，微服务是一个不可忽视的趋势。</p><p id="4ef4" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这篇文章比我预期的要大，我试图在这里避开几个话题。请随意提出我可以写得更详细并在新文章中分享的任何话题。</p><p id="3d91" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">像往常一样，我的POC可以在我的公共github项目<a class="ae ly" href="https://github.com/makinhs/nestjs-kafka-tutorial" rel="noopener ugc nofollow" target="_blank">这里</a>中找到。</p></div><div class="ab cl oc od hu oe" role="separator"><span class="of bw bk og oh oi"/><span class="of bw bk og oh oi"/><span class="of bw bk og oh"/></div><div class="ij ik il im in"><p id="9c8e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我真的很喜欢写和分享我认为可以贡献的知识。如果这篇文章对你有用，请喜欢和/或评论它，因为它让我明白它是否有用。当我把我的知识翻译成文章时，我也在学习，欢迎任何反馈！</p><p id="a3c3" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果你还是迷路了，特别是对于NestJS，请不要忘记获取我的NestJS初学者指南！</p><p id="148b" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">对于此处的RestAPI脚手架:</p><div class="lz ma gp gr mb mc"><a href="https://makinhs.medium.com/creating-a-rest-api-series-with-nestjs-part-01-scaffolding-and-basic-cli-usage-30ace19c5bb8" rel="noopener follow" target="_blank"><div class="md ab fo"><div class="me ab mf cl cj mg"><h2 class="bd ir gy z fp mh fr fs mi fu fw ip bi translated">使用NestJS创建REST API系列—第1部分—搭建和基本CLI用法</h2><div class="mj l"><h3 class="bd b gy z fp mh fr fs mi fu fw dk translated">欢迎回来！在这个迷你系列文章中，我将指导您如何使用NestJS框架构建REST API</h3></div><div class="mk l"><p class="bd b dl z fp mh fr fs mi fu fw dk translated">makinhs.medium.com</p></div></div><div class="ml l"><div class="pc l mn mo mp ml mq kp mc"/></div></div></a></div><p id="386f" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">对于带有NestJS和Typescript的GraphQL，请访问:</p><div class="lz ma gp gr mb mc"><a rel="noopener  ugc nofollow" target="_blank" href="/graphql-backend-in-nodejs-made-easy-with-nestjs-1489be18b994"><div class="md ab fo"><div class="me ab mf cl cj mg"><h2 class="bd ir gy z fp mh fr fs mi fu fw ip bi translated">使用NestJS简化Node.js中的GraphQL后端</h2><div class="mj l"><h3 class="bd b gy z fp mh fr fs mi fu fw dk translated">在本文中，我将向您展示如何以一种非常非常简单的方式开始一个GraphQL后端项目…使用NestJS！</h3></div><div class="mk l"><p class="bd b dl z fp mh fr fs mi fu fw dk translated">javascript.plainenglish.io</p></div></div><div class="ml l"><div class="mm l mn mo mp ml mq kp mc"/></div></div></a></div><p id="da27" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">感谢您的阅读，再见！</p><blockquote class="lr ls lt"><p id="b6bf" class="kv kw lu kx b ky kz jr la lb lc ju ld lv lf lg lh lw lj lk ll lx ln lo lp lq ij bi translated"><em class="iq">如果这类文章过于简单，而你又觉得自己准备了一次真正的冒险，特意在一个遥远的好报酬的基础上，请尝试加入</em><a class="ae ly" href="https://topt.al/KncQD8" rel="noopener ugc nofollow" target="_blank"><em class="iq">【Toptal】</em></a><em class="iq"/><a class="ae ly" href="https://topt.al/KncQD8" rel="noopener ugc nofollow" target="_blank"><em class="iq">链接</em></a><em class="iq"/><a class="ae ly" href="https://topt.al/KncQD8" rel="noopener ugc nofollow" target="_blank"><em class="iq">https://topt.al/KncQD8</em></a><em class="iq">。Toptal是一个伟大的自由职业者社区，我很高兴在那里见到你！</em></p></blockquote><p id="d9af" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><em class="lu">更多内容请看</em><a class="ae ly" href="http://plainenglish.io" rel="noopener ugc nofollow" target="_blank"><strong class="kx ir"><em class="lu">plain English . io</em></strong></a></p></div></div>    
</body>
</html>