<html>
<head>
<title>Apply Timeout to JavaScript Promises</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">对JavaScript承诺应用超时</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/apply-timeout-to-javascript-promises-ddb093e12f36?source=collection_archive---------15-----------------------#2021-06-10">https://javascript.plainenglish.io/apply-timeout-to-javascript-promises-ddb093e12f36?source=collection_archive---------15-----------------------#2021-06-10</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="a6e8" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">何时以及如何对JavaScript承诺应用超时</h2></div><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi kc"><img src="../Images/7230fb026b3c011e19969b610d23a5ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*22swJ-NUMC_UERGd.jpeg"/></div></div></figure><p id="37b3" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">JavaScript承诺没有任何时间与之相关联。我们可以使用一个<code class="fe lk ll lm ln b">.then()</code>函数，等待承诺被解决或拒绝。我们甚至可以等待它，如果异步任务在合理的时间内完成，这两种方法都可以。但是在任务可能需要很长时间的情况下，我们可能希望让用户知道。我们希望在这种情况下对JavaScript承诺应用超时。</p><p id="fe11" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">幸运的是，有一个<a class="ae lo" href="https://www.wisdomgeek.com/development/web-development/javascript/javascript-promises-combinators-race-all-allsettled-any/" rel="noopener ugc nofollow" target="_blank"> JavaScript Promise combinator函数</a>可以帮助我们做到这一点:</p><h1 id="c9cf" class="lp lq in bd lr ls lt lu lv lw lx ly lz jt ma ju mb jw mc jx md jz me ka mf mg bi translated">承诺.比赛</h1><p id="b768" class="pw-post-body-paragraph ko kp in kq b kr mh jo kt ku mi jr kw kx mj kz la lb mk ld le lf ml lh li lj ig bi translated">race接受一系列承诺，并等待第一个承诺完成。先解决或拒绝的承诺将被返回。</p><p id="4be2" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">例如:</p><pre class="kd ke kf kg gt mm ln mn mo aw mp bi"><span id="40b5" class="mq lq in ln b gy mr ms l mt mu">const promise1 = new Promise((res) =&gt; setTimeout(() =&gt; res("promise1"), 1000));<br/>const promise2 = new Promise((res, rej) =&gt; setTimeout(() =&gt; rej("promise2"), 500));</span><span id="1a5c" class="mq lq in ln b gy mv ms l mt mu">const result = await Promise.race([p1, p2]);<br/>// promise2</span></pre><p id="fa2d" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">不管它是被解决还是被拒绝，结果都将是promise 2，因为它首先完成。</p><p id="e81a" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">同样值得一提的是，函数的参数是承诺。它也可以使用异步函数。</p><pre class="kd ke kf kg gt mm ln mn mo aw mp bi"><span id="5f9a" class="mq lq in ln b gy mr ms l mt mu">const asyncFunction = async (time, name) =&gt; {<br/> await new Promise((res) =&gt; setTimeout(res, time));<br/> return name;<br/>}</span><span id="f0e4" class="mq lq in ln b gy mv ms l mt mu">const result = await Promise.race(<br/>  [asyncFunction(1000, "promise1"),<br/>  asyncFunction(500, "promise2")<br/>]);</span><span id="3e93" class="mq lq in ln b gy mv ms l mt mu">// promise2</span></pre><h1 id="a609" class="lp lq in bd lr ls lt lu lv lw lx ly lz jt ma ju mb jw mc jx md jz me ka mf mg bi translated">对JavaScript应用超时承诺</h1><p id="70eb" class="pw-post-body-paragraph ko kp in kq b kr mh jo kt ku mi jr kw kx mj kz la lb mk ld le lf ml lh li lj ig bi translated">利用上面的知识，我们可以通过使用Promise.race很容易地将timeout应用于JavaScript promises。</p><p id="0e57" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">我们将添加另一个承诺，在时间限制到达后拒绝。无论哪个承诺先完成，都将被归还。</p><pre class="kd ke kf kg gt mm ln mn mo aw mp bi"><span id="e919" class="mq lq in ln b gy mr ms l mt mu">const timeout = (promise, time) =&gt; {<br/>  return Promise.race(<br/>    [promise,<br/>    new Promise((res, rej) =&gt; setTimeout(rej, time))]<br/>  );<br/>}</span></pre><p id="c868" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">我们可以使用这个助手函数在任何需要的时候对JavaScript承诺应用超时:</p><pre class="kd ke kf kg gt mm ln mn mo aw mp bi"><span id="f544" class="mq lq in ln b gy mr ms l mt mu">// takes 100ms<br/>const promiseFunction = async () =&gt; {<br/> await new Promise((res) =&gt; setTimeout(res, 100));<br/> return "promise";<br/>}</span><span id="e3ae" class="mq lq in ln b gy mv ms l mt mu">const result = await timeout(promiseFunction(), 1000);<br/>// promise<br/>// because it finishes before the timeout of 1000 ms</span><span id="3f77" class="mq lq in ln b gy mv ms l mt mu">// timeouts in 100 ms<br/>await timeout(fn(), 50);<br/>// error</span></pre><p id="3fee" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">同样值得一提的是，承诺不会被终止，它会继续执行，而承诺的结果会被丢弃。</p><h1 id="b234" class="lp lq in bd lr ls lt lu lv lw lx ly lz jt ma ju mb jw mc jx md jz me ka mf mg bi translated">处理错误</h1><p id="feb7" class="pw-post-body-paragraph ko kp in kq b kr mh jo kt ku mi jr kw kx mj kz la lb mk ld le lf ml lh li lj ig bi translated">在上面的实现中，来自拒绝的错误和任何其他错误是不可区分的。因此，我们可以添加一个异常参数作为超时函数的输入，它将被用作拒绝值。然后，我们可以唯一地确定错误的原因，并相应地编写我们的处理逻辑。</p><p id="0c58" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">我们还将使用Promise.finally()为超时添加一个清除超时，以便对超时对象进行一些垃圾收集。</p><pre class="kd ke kf kg gt mm ln mn mo aw mp bi"><span id="78c9" class="mq lq in ln b gy mr ms l mt mu">const timeout = (promise, time, exceptionValue) =&gt; {<br/> let timer;<br/> return Promise.race([<br/>  promise,<br/>  new Promise((res, rej) =&gt;<br/>                 timer = setTimeout(rej, time, exceptionValue))<br/> ]).finally(() =&gt; clearTimeout(timer));<br/>}</span></pre><p id="7886" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">这就是我们为JavaScript承诺添加超时所需要做的一切。如果你有任何问题，欢迎在下面留言。</p></div><div class="ab cl mw mx hr my" role="separator"><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb nc"/><span class="mz bw bk na nb"/></div><div class="ig ih ii ij ik"><p id="cbe3" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated"><em class="nd">原载于2021年6月10日https://www.wisdomgeek.com</em><em class="nd">的</em> <a class="ae lo" href="https://www.wisdomgeek.com/development/web-development/javascript/apply-timeout-to-javascript-promises/" rel="noopener ugc nofollow" target="_blank"> <em class="nd">。</em></a></p><p id="8bf9" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated"><em class="nd">更多内容请看</em><a class="ae lo" href="http://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><strong class="kq io"><em class="nd">plain English . io</em></strong></a></p></div></div>    
</body>
</html>