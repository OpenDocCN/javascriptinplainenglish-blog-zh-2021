<html>
<head>
<title>OAuth2 in NestJS for Social Login (Google, Facebook, Twitter, etc)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用于社交登录(谷歌、脸书、推特等)的NestJS中的OAuth2</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/oauth2-in-nestjs-for-social-login-google-facebook-twitter-etc-8b405d570fd2?source=collection_archive---------0-----------------------#2021-06-17">https://javascript.plainenglish.io/oauth2-in-nestjs-for-social-login-google-facebook-twitter-etc-8b405d570fd2?source=collection_archive---------0-----------------------#2021-06-17</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="d62b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">关于NestJS的例子少得惊人。自2018年以来有一个<a class="ae ki" href="https://github.com/nestjs/docs.nestjs.com/issues/75" rel="noopener ugc nofollow" target="_blank">开放问题</a>要求它们，但回复(<a class="ae ki" href="https://github.com/nestjs/docs.nestjs.com/issues/75#issuecomment-436275866" rel="noopener ugc nofollow" target="_blank"> 1 </a>、<a class="ae ki" href="https://github.com/nestjs/docs.nestjs.com/issues/75#issuecomment-437791849" rel="noopener ugc nofollow" target="_blank"> 2 </a>)和其他地方的资源(<a class="ae ki" href="https://dev.to/imichaelowolabi/how-to-implement-login-with-google-in-nest-js-2aoa" rel="noopener ugc nofollow" target="_blank"> 1 </a>、<a class="ae ki" href="https://stackoverflow.com/questions/67237523/oauth2-flow-in-full-stack-nestjs-application" rel="noopener ugc nofollow" target="_blank"> 2 </a>)仅提供了部分/不完整的概述。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi kj"><img src="../Images/e6dd9e4aabd09f3d4d454f2d5d5b582f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G0RUcAMHvyQ_RZNX0_-N-Q.png"/></div></div></figure><p id="46d3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这里我将展示一个全栈认证流程，包括获取社交令牌后的认证请求，对于GraphQL也是可选的。您可以在<a class="ae ki" href="https://github.com/thisismydesign/nestjs-starter" rel="noopener ugc nofollow" target="_blank"> nestjs-starter repo </a>中查看一个工作示例。</p><p id="c3d8" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">解决方案概述:</p><ul class=""><li id="57d1" class="kv kw in jm b jn jo jr js jv kx jz ky kd kz kh la lb lc ld bi translated">1，使用<code class="fe le lf lg lh b">@nestjs/passport</code>和<code class="fe le lf lg lh b">passport-google-auth</code>实现Google auth(其他提供者很相似)。</li><li id="e800" class="kv kw in jm b jn li jr lj jv lk jz ll kd lm kh la lb lc ld bi translated">2、一旦重定向回应用程序，就颁发一个JWT令牌，这样应用程序就可以管理用户的会话。</li><li id="299a" class="kv kw in jm b jn li jr lj jv lk jz ll kd lm kh la lb lc ld bi translated">3、用JWT策略保护REST和GraphQL端点。</li></ul></div><div class="ab cl ln lo hr lp" role="separator"><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls"/></div><div class="ig ih ii ij ik"><p id="03a9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">第一步。此处的<a class="ae ki" href="https://dev.to/imichaelowolabi/how-to-implement-login-with-google-in-nest-js-2aoa" rel="noopener ugc nofollow" target="_blank">归功于Google Oauth策略的实施，并展示了如何通过截图在Google中创建Oauth应用程序。代码应该如下所示:</a></p><figure class="kk kl km kn gt ko"><div class="bz fp l di"><div class="lu lv l"/></div></figure><p id="4662" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">你现在可以使用<code class="fe le lf lg lh b">@UseGuards(GoogleOauthGuard)</code>。你会注意到，每个受保护的路线重定向到谷歌认证。我们接下来会解决这个问题。</p></div><div class="ab cl ln lo hr lp" role="separator"><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls"/></div><div class="ig ih ii ij ik"><p id="13e2" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">第二步。现在应用程序知道了用户，我们可以在应用程序中处理用户的会话。我们将颁发一个JWT令牌，并使用相应的保护措施来保护经过认证的路由。这在<a class="ae ki" href="https://docs.nestjs.com/security/authentication" rel="noopener ugc nofollow" target="_blank">正式文件</a>中有解释。</p><p id="3f39" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们需要在服务器和客户端之间传输这个令牌。一个安全易用的选择是通过一个SameSite HttpOnly Cookie。代码应该如下所示:</p><figure class="kk kl km kn gt ko"><div class="bz fp l di"><div class="lu lv l"/></div></figure><p id="2cda" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">修改OAuth控制器以颁发JWT令牌:</p><figure class="kk kl km kn gt ko"><div class="bz fp l di"><div class="lu lv l"/></div></figure></div><div class="ab cl ln lo hr lp" role="separator"><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls"/></div><div class="ig ih ii ij ik"><p id="1f20" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">第三步。我们现在可以使用<code class="fe le lf lg lh b">@UseGuards(JwtAuthGuard)</code>来保护经过认证的路由。<a class="ae ki" href="https://docs.nestjs.com/security/authentication#graphql" rel="noopener ugc nofollow" target="_blank">文档</a>中显示的图形QL开箱即用！</p></div><div class="ab cl ln lo hr lp" role="separator"><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls"/></div><div class="ig ih ii ij ik"><p id="7c96" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">最后，我们用NestJS实现了端到端的社会认证。你会在回购协议中发现更多很酷的功能(<a class="ae ki" href="https://github.com/thisismydesign/nestjs-starter" rel="noopener ugc nofollow" target="_blank">https://github.com/thisismydesign/nestjs-starter</a>)。我还写过一个结合Next.js和NestJS 、以及<a class="ae ki" href="https://csaba-apagyi.medium.com/automagically-typed-graphql-queries-and-results-with-apollo-3731bad989aa" rel="noopener">自动键入GraphQL查询和结果与Apollo </a>的<a class="ae ki" href="https://csaba-apagyi.medium.com/nestjs-react-next-js-in-one-mvc-repo-for-rapid-prototyping-faed42a194ca" rel="noopener"> MVC设置。</a></p><p id="b6a7" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><em class="lw">更多内容参见</em> <a class="ae ki" href="http://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <em class="lw">浅显易懂</em></a></p></div></div>    
</body>
</html>