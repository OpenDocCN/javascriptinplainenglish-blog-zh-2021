<html>
<head>
<title>Apollo Client Data Normalization and Storage</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">阿波罗客户端数据标准化和存储</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/apollo-client-data-normalization-and-storage-e03c75dd52b9?source=collection_archive---------11-----------------------#2021-01-09">https://javascript.plainenglish.io/apollo-client-data-normalization-and-storage-e03c75dd52b9?source=collection_archive---------11-----------------------#2021-01-09</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/2c88d57d3ddab449ae0db9f48d5a10e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*UPbAEJPLOQLCdXAD"/></div></div></figure><p id="71c6" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">Apollo client是一个强大的前端GraphQL库，允许使用GraphQL的应用程序查询自身，以及连接的GraphQL数据服务。它是一个客户端状态管理库，与GraphQL后端深度集成。</p><p id="e968" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在幕后，Apollo client接受您的GraphQL查询响应，并将其展平成一个键值存储系统。举以下例子:</p><pre class="kt ku kv kw gt kx ky kz la aw lb bi"><span id="f098" class="lc ld in ky b gy le lf l lg lh">// GraphQL Query and Type<br/>type Account { <br/>  id: ID!<br/>  userName: String!</span><span id="2b2e" class="lc ld in ky b gy li lf l lg lh">}</span><span id="c094" class="lc ld in ky b gy li lf l lg lh">query getAccount() {<br/>  account {<br/>    id<br/>    userName<br/>    __typename // not required, but for illustration<br/>  }  <br/>}</span></pre><p id="4b06" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">上面对类型Account上的值的查询将返回如下响应:</p><pre class="kt ku kv kw gt kx ky kz la aw lb bi"><span id="ebc1" class="lc ld in ky b gy le lf l lg lh">{<br/>  data: {<br/>    account: {<br/>      id: 1,<br/>      userName: 'user',<br/>      __typename: 'Account'<br/>    }<br/>  }<br/>}</span></pre><p id="ed8f" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">默认情况下，Apollo客户端会以下面的键-值方式将它存储在客户端:</p><pre class="kt ku kv kw gt kx ky kz la aw lb bi"><span id="f7a1" class="lc ld in ky b gy le lf l lg lh">{<br/>  'Account:1': { // this key is stored by Apollo client<br/>      id: 1,<br/>      userName: 'user',<br/>      __typename: 'Account'<br/>    }<br/>}</span></pre><p id="18b0" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">Apollo从响应中获取<strong class="jx io"> __typename </strong>和<strong class="jx io"> id </strong>字段，然后<a class="ae lj" href="https://www.apollographql.com/docs/react/caching/cache-configuration/#generating-unique-identifiers" rel="noopener ugc nofollow" target="_blank">将它们组合成键，</a>然后用它存储相关的值。</p></div><div class="ab cl lk ll hr lm" role="separator"><span class="ln bw bk lo lp lq"/><span class="ln bw bk lo lp lq"/><span class="ln bw bk lo lp"/></div><div class="ig ih ii ij ik"><p id="740b" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">问题</strong></p><p id="afe5" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">Apollo客户端不知道你的数据，也不知道你的类型之间的关系。对于更复杂的场景，Apollo可能会错误地存储您正在查询的数据，并导致您的应用程序显示重复的值。您的GraphQL服务器将按照您的预期返回数据，但是Apollo客户机将数据正常化——导致冲突。要解决这个问题，您需要在受影响的类型的TypePolicy上使用<a class="ae lj" href="https://www.apollographql.com/docs/react/caching/cache-configuration/#disabling-normalization" rel="noopener ugc nofollow" target="_blank">键字段</a>。</p><p id="f300" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">示例</strong></p><p id="639e" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">假设我们运行一个应用程序，跟踪不同公司的所有者权益。</p><pre class="kt ku kv kw gt kx ky kz la aw lb bi"><span id="d628" class="lc ld in ky b gy le lf l lg lh">type User {<br/>  id: ID!<br/>  name: String!  <br/>  email: String!<br/>}<br/>type Company {<br/>  id: ID!<br/>  name: String!<br/>  country: String!<br/>  owners: [Owner]!<br/>}</span><span id="bdb9" class="lc ld in ky b gy li lf l lg lh">type Owner implements User {<br/>  equity: Float!<br/>  company: Company!<br/>}</span><span id="13c0" class="lc ld in ky b gy li lf l lg lh">--- Example Query ---<br/>query getCompanies() {<br/>  companies {<br/>    id<br/>    name<br/>    owners {<br/>     id<br/>     name<br/>     equity <br/>    }<br/>  }<br/>}</span></pre><p id="7652" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">股权是基于每家公司的，没有什么可以阻止用户拥有多家公司的股份。因此，当我们从后端获取数据时，有可能会发生冲突，因为<em class="lr">所有者</em>类型与<em class="lr">用户</em>类型使用相同的id，Apollo客户端最终会在其扁平化的数据存储中生成重复的键。</p><figure class="kt ku kv kw gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi ls"><img src="../Images/d791a8b781e9c7cd6c312bba61b75e58.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*gB5SirOsnUHDEcMj"/></div></div></figure><p id="4e2a" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">就拿埃隆·马斯克来说吧，他在SpaceX和特斯拉都有股权。我们对上述示例查询的数据响应如下所示:</p><pre class="kt ku kv kw gt kx ky kz la aw lb bi"><span id="7466" class="lc ld in ky b gy le lf l lg lh">{<br/>  "data": {<br/>    "companies": [<br/>      {<br/>        "id": 1,<br/>        "name": "SpaceX",<br/>        "owners": [<br/>          {<br/>            "id": 1,<br/>            "name": "Elon Musk",<br/>            "equity": 0.95<br/>          }<br/>        ]<br/>      },<br/>      {<br/>        "id": 2,<br/>        "name": "Tesla",<br/>        "owners": [<br/>          {<br/>            "id": 1,<br/>            "name": "Elon Musk",<br/>            "equity": 0.93<br/>          }<br/>        ]<br/>      }<br/>    ]<br/>  }<br/>}</span></pre><p id="1750" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">当Apollo client收到这些数据时，它会试图保存Owner:1下Musk的所有权，并产生冲突。</p><pre class="kt ku kv kw gt kx ky kz la aw lb bi"><span id="dec6" class="lc ld in ky b gy le lf l lg lh">{<br/>  "Owner:1": {<br/>    "id": 1,<br/>    "name": "Elon Musk",<br/>    "equity": 0.95<br/>  }<br/>}</span><span id="0ef3" class="lc ld in ky b gy li lf l lg lh">---- Clashes With ----<br/>{<br/>  "Owner:1": {<br/>    "id": 1,<br/>    "name": "Elon Musk",<br/>    "equity": 0.93<br/>  }<br/>}</span></pre><p id="bf27" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在我们的客户端类型策略中为<strong class="jx io">所有者</strong>类型实现一个关键字段定义可以解决这个问题</p><pre class="kt ku kv kw gt kx ky kz la aw lb bi"><span id="24b1" class="lc ld in ky b gy le lf l lg lh">const Owner = {<br/>  keyFields: ['id', 'equity', 'name'] // Apollo Client will generate a new identifier, based on the fields you pass in.<br/>}</span><span id="67f0" class="lc ld in ky b gy li lf l lg lh">const typePolicies = {<br/>  Owner<br/>}<br/>export default typePolicies</span></pre><p id="40e2" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><a class="ae lj" href="https://www.apollographql.com/docs/react/caching/cache-configuration/#disabling-normalization" rel="noopener ugc nofollow" target="_blank">键字段可以是许多不同的东西</a>，你可以把它设置为<code class="fe lt lu lv ky b">false</code>，Apollo将获取整个值，将其字符串化，并把它作为键使用。您也可以使用一个字段数组，如上所示，或者使用一个<code class="fe lt lu lv ky b">KeyFieldsFunction</code>来生成您自己的数组。现在，我们的扁平数据结构将包含两个所有者数据集。</p><pre class="kt ku kv kw gt kx ky kz la aw lb bi"><span id="5909" class="lc ld in ky b gy le lf l lg lh">{<br/>  "Owner:1|equity:0.95|name:'Elon Musk'": {<br/>    "id": 1,<br/>    "name": "Elon Musk",<br/>    "equity": 0.95<br/>  },<br/>  "Owner:1|equity:0.93|name:'Elon Musk'": {<br/>    "id": 1,<br/>    "name": "Elon Musk",<br/>    "equity": 0.93<br/>  }<br/>}</span></pre><h2 id="0261" class="lc ld in bd lw lx ly dn lz ma mb dp mc kg md me mf kk mg mh mi ko mj mk ml mm bi translated">结论</h2><p id="ee3e" class="pw-post-body-paragraph jv jw in jx b jy mn ka kb kc mo ke kf kg mp ki kj kk mq km kn ko mr kq kr ks ig bi translated">感谢阅读！我希望这有助于解决一些人在为他们的前端应用程序实现Apollo客户端时遇到的问题。如果这篇文章有问题，请联系我，我可以解决它！</p><p id="ce22" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">—Pat<br/><a class="ae lj" href="https://twitter.com/PatZawa" rel="noopener ugc nofollow" target="_blank">@ Pat zawa</a><br/><a class="ae lj" href="http://www.patz.dev" rel="noopener ugc nofollow" target="_blank">patz . dev</a></p></div></div>    
</body>
</html>