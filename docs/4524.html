<html>
<head>
<title>Setting up Trusted HTTPS connection for Local Express Server and Angular Dev Server</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为本地Express服务器和Angular Dev服务器设置可信HTTPS连接</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/setting-up-a-free-trusted-https-connection-for-your-local-express-server-d6716ad2cf69?source=collection_archive---------6-----------------------#2021-09-09">https://javascript.plainenglish.io/setting-up-a-free-trusted-https-connection-for-your-local-express-server-d6716ad2cf69?source=collection_archive---------6-----------------------#2021-09-09</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="a627" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我最近试图使用脸书作为授权和资源服务器来实现OAuth2。解决浏览器不信任证书的问题有很多挑战。最后，为了克服这些错误，我想分享一下当客户端(我在前端使用Angular framework)连接到服务器时，如何做到没有任何“不安全连接”错误或证书问题。</p><h1 id="fbaa" class="ki kj in bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated"><strong class="ak"> 1。为Express服务器设置可信https连接</strong></h1><h2 id="005e" class="lg kj in bd kk lh li dn ko lj lk dp ks jv ll lm kw jz ln lo la kd lp lq le lr bi translated"><strong class="ak">第一步。</strong>安装OPENSSL以创建私钥和证书</h2><p id="2570" class="pw-post-body-paragraph jk jl in jm b jn ls jp jq jr lt jt ju jv lu jx jy jz lv kb kc kd lw kf kg kh ig bi translated">我安装了来自http://slproweb.com/products/Win32OpenSSL.html<a class="ae lx" href="http://slproweb.com/products/Win32OpenSSL.html" rel="noopener ugc nofollow" target="_blank">的Windows操作系统的OPENSSL MSI。安装起来非常简单快捷。</a></p><figure class="lz ma mb mc gt md gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi ly"><img src="../Images/aec07cac2d11c5ccb2790180e5eb6211.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EUd1N7GVqAGfjkLFtB5_NQ.png"/></div></div><figcaption class="mk ml gj gh gi mm mn bd b be z dk">Openssl installation</figcaption></figure><p id="faff" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">安装完成后，不要忘记将OPENSSL路径添加到系统环境变量中。因为我把它安装在这个路径:<strong class="jm io">C:\ Program Files \ OpenSSL-win 64，</strong>变量的路径将是<strong class="jm io">C:\ Program Files \ OpenSSL-win 64 \ bin</strong></p><figure class="lz ma mb mc gt md gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi mo"><img src="../Images/2cdb5c2a90e30a5257bc1a2c8b34c002.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7dqt_LBKhvUWbsELSlhgFw.png"/></div></div><figcaption class="mk ml gj gh gi mm mn bd b be z dk">Setting the environmental variable for openssl</figcaption></figure><p id="2481" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在，您可以在任何命令行上使用openssl命令了。</p><h2 id="fefa" class="lg kj in bd kk lh li dn ko lj lk dp ks jv ll lm kw jz ln lo la kd lp lq le lr bi translated"><strong class="ak">第二步。</strong>配置快递节点项目</h2><p id="3763" class="pw-post-body-paragraph jk jl in jm b jn ls jp jq jr lt jt ju jv lu jx jy jz lv kb kc kd lw kf kg kh ig bi translated">这是我的Express项目的样子:</p><figure class="lz ma mb mc gt md gh gi paragraph-image"><div class="gh gi mp"><img src="../Images/b9994adf709d86c0cc37113350e75861.png" data-original-src="https://miro.medium.com/v2/resize:fit:1068/format:webp/1*fJikMzZ8S5FvZ_7W9oh75g.png"/></div><figcaption class="mk ml gj gh gi mm mn bd b be z dk">Express project</figcaption></figure><p id="efb0" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在这里，我们所担心的是包含多个本地主机的bin目录。*文件和一个www文件。</p><p id="be79" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">在我们开始之前，一个重要的注意事项是，每当命令行要求下面的任何openssl命令的公共名称时，千万不要让它为空。将域名作为通用名称，即localhost。</strong></p><p id="ad31" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">这将防止以后出现无效的常用名错误。</strong></p><p id="3197" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io">记下您在创建私钥时输入的密码。我们将在设置https服务器时需要它。</strong></p><p id="bdce" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们开始吧！</p><p id="d1b9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">= &gt;确保您在项目的bin目录中，并点击下面的命令。这将创建一个RSA 1024位私钥(rootCA.key)和一个自签名的根CA证书(rootCA.crt)</p><pre class="lz ma mb mc gt mq mr ms mt aw mu bi"><span id="7aaa" class="lg kj in mr b gy mv mw l mx my"><strong class="mr io">openssl req -x509 -sha256 -days 1825 -newkey rsa:1024 -keyout rootCA.key -out rootCA.crt</strong></span></pre><p id="b3c9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">= &gt;接下来，我们用以下内容创建一个配置文件(localhost.ext ):</p><pre class="lz ma mb mc gt mq mr ms mt aw mu bi"><span id="46ca" class="lg kj in mr b gy mv mw l mx my">authorityKeyIdentifier=keyid,issuer<br/>basicConstraints=CA:FALSE<br/>subjectAltName = @alt_names<br/>[alt_names]<br/>DNS.1 = <strong class="mr io">localhost</strong></span></pre><p id="e3be" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这里非常重要的是DNS.1的值。确保它是域名，即localhost。</p><p id="7496" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">= &gt;如果我们想要我们的证书被签名，我们需要一个证书签名请求(CSR ),即localhost.csr</p><pre class="lz ma mb mc gt mq mr ms mt aw mu bi"><span id="64e3" class="lg kj in mr b gy mv mw l mx my"><strong class="mr io">openssl req -new -key rootCA.key -out localhost.csr</strong></span></pre><p id="bed7" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">= &gt;使用根CA证书(rootCA.crt)及其私钥(rootCA.key)对CSR (localhost.csr)进行签名:</p><pre class="lz ma mb mc gt mq mr ms mt aw mu bi"><span id="a7fa" class="lg kj in mr b gy mv mw l mx my"><strong class="mr io">openssl x509 -req -CA rootCA.crt -CAkey rootCA.key -in localhost.csr -out localhost.crt -days 365 -CAcreateserial -extfile localhost.ext</strong></span></pre><p id="8f00" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们现在终于生成了CA签名的证书:localhost.crt</p><p id="ec13" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">= &gt;在浏览器中安装rootCA.crt作为可信证书。</p><p id="dc5b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">单击rootCA.crt文件，打开如下所示的窗口。点击安装证书。</p><figure class="lz ma mb mc gt md gh gi paragraph-image"><div class="gh gi mz"><img src="../Images/ad2397dbea81a8a8a0b02293a8c613c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:944/format:webp/1*EJeH5iB31SZoldM95PKH1w.png"/></div><figcaption class="mk ml gj gh gi mm mn bd b be z dk">install certificate</figcaption></figure><figure class="lz ma mb mc gt md gh gi paragraph-image"><div class="gh gi na"><img src="../Images/f5a7d32b22533ce9a5d468f8f597ff70.png" data-original-src="https://miro.medium.com/v2/resize:fit:1016/format:webp/1*6WFw6nZz51FoXpUIe8MdzA.png"/></div><figcaption class="mk ml gj gh gi mm mn bd b be z dk">Certificate Import Wizard</figcaption></figure><figure class="lz ma mb mc gt md gh gi paragraph-image"><div class="gh gi nb"><img src="../Images/93a22892ac41199b99ac46d814f3d84c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1028/format:webp/1*C2cQzCST1_7YVpXJqggFyA.png"/></div><figcaption class="mk ml gj gh gi mm mn bd b be z dk">Certificate import completed</figcaption></figure><p id="d79d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这就完成了证书和密钥的创建。</p><p id="05f3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">接下来，让我们为express项目配置一个http和https服务器。</p><p id="4203" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> express-generator </strong> npm模块通过错误处理、视图和路线为您生成一个基本的express项目。你所需要做的就是修改它以适应你的需求。bin文件夹中的www文件已经有了创建http服务器的代码。</p><p id="f309" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在下面的代码中，我突出显示了为创建HTTPS服务器而在www文件中添加的行。</p><pre class="lz ma mb mc gt mq mr ms mt aw mu bi"><span id="cb6a" class="lg kj in mr b gy mv mw l mx my">var port = normalizePort(process.env.PORT || ‘3000’);<br/>app.set(‘port’, port); //http server runs on port 3000<br/><strong class="mr io">app.set(‘securePort’,port+443); //https server will run on 3443</strong></span><span id="b2db" class="lg kj in mr b gy nc mw l mx my">/**<br/>* Create HTTP server.<br/>*/<br/>var server = http.createServer(app);<br/>/**<br/>* Listen on provided port, on all network interfaces.<br/>*/</span><span id="2a62" class="lg kj in mr b gy nc mw l mx my"><strong class="mr io">//configure options for the https server</strong></span><span id="19a9" class="lg kj in mr b gy nc mw l mx my"><strong class="mr io">let options={<br/>key:fs.readFileSync(__dirname+’/rootCA.key’),<br/>cert:fs.readFileSync(__dirname+’/localhost.crt’),<br/>passphrase:"enter the passphrase that you gave while creating private key"<br/>}</strong></span><span id="8eee" class="lg kj in mr b gy nc mw l mx my"><strong class="mr io">//create https server<br/>let httpsServer=https.createServer(options,app);<br/>httpsServer.listen(app.get(‘securePort’),()=&gt;{<br/>console.log(`Server running on port ${app.get(‘securePort’)}`)<br/>});</strong></span><span id="536b" class="lg kj in mr b gy nc mw l mx my"><strong class="mr io">httpsServer.on(‘error’, onError);<br/>httpsServer.on(‘listening’, onListening);</strong></span><span id="543b" class="lg kj in mr b gy nc mw l mx my">server.listen(port);<br/>server.on(‘error’, onError);<br/>server.on(‘listening’, onListening);</span></pre><p id="8a8f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">https服务器将在<strong class="jm io">端口3443 </strong>上运行。以下选项非常重要。我们已经传递了私钥的路径和使用的证书，以及密码短语。</p><pre class="lz ma mb mc gt mq mr ms mt aw mu bi"><span id="a70a" class="lg kj in mr b gy mv mw l mx my"><strong class="mr io">let options={<br/>key:fs.readFileSync(__dirname+’/rootCA.key’),<br/>cert:fs.readFileSync(__dirname+’/localhost.crt’),<br/>passphrase:"enter the passphrase that you gave while creating private key"<br/>}</strong></span></pre><p id="e9af" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在浏览器中点击<a class="ae lx" href="https://localhost:3443" rel="noopener ugc nofollow" target="_blank"> https://localhost:3443 </a>。</p><figure class="lz ma mb mc gt md gh gi paragraph-image"><div class="gh gi nd"><img src="../Images/395c4f6ee84f8fb3d4a2d86b560b4c8a.png" data-original-src="https://miro.medium.com/v2/resize:fit:870/format:webp/1*Cz8p06DGIYE1ECpcEaz0gA.png"/></div><figcaption class="mk ml gj gh gi mm mn bd b be z dk">Secure local server</figcaption></figure><h1 id="d972" class="ki kj in bd kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld le lf bi translated"><strong class="ak"> 2。为Angular Dev服务器设置可信https连接</strong></h1><h2 id="fa93" class="lg kj in bd kk lh li dn ko lj lk dp ks jv ll lm kw jz ln lo la kd lp lq le lr bi translated">第一步。下载并安装XAMPP</h2><p id="c317" class="pw-post-body-paragraph jk jl in jm b jn ls jp jq jr lt jt ju jv lu jx jy jz lv kb kc kd lw kf kg kh ig bi translated">转到<a class="ae lx" href="https://www.apachefriends.org/download.html" rel="noopener ugc nofollow" target="_blank">https://www.apachefriends.org/download.html</a>安装XAMPP。几乎不需要几分钟。</p><p id="1c9a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">它应该创建一个文件夹结构如下安装后。</p><figure class="lz ma mb mc gt md gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi ne"><img src="../Images/91dd16744234f622c2e61ab3b2364168.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*L36izjdiylo7QVwR81cR6Q.png"/></div></div><figcaption class="mk ml gj gh gi mm mn bd b be z dk">XAMPP</figcaption></figure><h2 id="0ff6" class="lg kj in bd kk lh li dn ko lj lk dp ks jv ll lm kw jz ln lo la kd lp lq le lr bi translated">第二步。创建私钥和证书。</h2><p id="c595" class="pw-post-body-paragraph jk jl in jm b jn ls jp jq jr lt jt ju jv lu jx jy jz lv kb kc kd lw kf kg kh ig bi translated">导航到apache文件夹并创建一个名为<strong class="jm io"> cert </strong>的文件夹。在cert文件夹中，创建两个文件:<strong class="jm io"> cert.conf和make-cert.bat </strong></p><p id="00d3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">您可以从下面的链接中复制这两个文件的内容:</p><p id="bc4d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">用<strong class="jm io"> localhost替换下面文件中出现的所有{{DOMAIN}}。</strong></p><figure class="lz ma mb mc gt md"><div class="bz fp l di"><div class="nf ng l"/></div><figcaption class="mk ml gj gh gi mm mn bd b be z dk">cert.conf</figcaption></figure><figure class="lz ma mb mc gt md"><div class="bz fp l di"><div class="nf ng l"/></div><figcaption class="mk ml gj gh gi mm mn bd b be z dk">make-cert.bat</figcaption></figure><p id="1bcb" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">更新完这两个文件后，双击make-cert.bat打开如下窗口:</p><figure class="lz ma mb mc gt md gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi nh"><img src="../Images/6b76e71e6520dc8bd18ca6a499543ca4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*u5uHU-UK-reSNoFD.png"/></div></div></figure><p id="1872" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这将在apache/cert中的一个新的自动生成的文件夹localhost中创建私钥(server.key)和证书(server.crt)。</p><figure class="lz ma mb mc gt md gh gi paragraph-image"><div role="button" tabindex="0" class="me mf di mg bf mh"><div class="gh gi ni"><img src="../Images/04514e3b1491c651dbc8f60926529514.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lZ_2I6kdXinAldcxZEt7Yg.png"/></div></div></figure><h2 id="562c" class="lg kj in bd kk lh li dn ko lj lk dp ks jv ll lm kw jz ln lo la kd lp lq le lr bi translated"><strong class="ak">第三步。</strong>在浏览器中安装server.crt证书，并配置Angular应用程序以使用它。</h2><p id="d41e" class="pw-post-body-paragraph jk jl in jm b jn ls jp jq jr lt jt ju jv lu jx jy jz lv kb kc kd lw kf kg kh ig bi translated">双击server.crt进行安装。您可以按照我们为Express server安装证书的相同步骤进行操作。</p><p id="0a43" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">安装后，将server.key和server.crt复制到angular项目的根目录。您的项目应该看起来有点像这样。</p><figure class="lz ma mb mc gt md gh gi paragraph-image"><div class="gh gi nj"><img src="../Images/aa01318b431d4e5b0874f01d88e9fda0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1322/format:webp/1*MC1StkVSulmsXj-BhBeSJw.png"/></div><figcaption class="mk ml gj gh gi mm mn bd b be z dk">Angular Project</figcaption></figure><p id="234a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">转到应用程序中的angular.json文件，并更新serve部分，如下所示:</p><pre class="lz ma mb mc gt mq mr ms mt aw mu bi"><span id="e0df" class="lg kj in mr b gy mv mw l mx my">“serve”: {<br/>“builder”: “@angular-devkit/build-angular:dev-server”,<br/><strong class="mr io">“options”: {<br/>“browserTarget”: “conFusionAngular:build”,<br/>“sslKey”:”./server.key”,<br/>“sslCert”:”./server.crt”<br/>},</strong><br/>“configurations”: {<br/>“production”: {<br/>“browserTarget”: “conFusionAngular:build:production”<br/>}}},</span></pre><p id="8fd0" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">按如下方式更新package.json:</p><pre class="lz ma mb mc gt mq mr ms mt aw mu bi"><span id="0891" class="lg kj in mr b gy mv mw l mx my">“scripts”: {<br/>“ng”: “ng”,<br/><strong class="mr io">“start”: “ng serve — proxy-config proxy.conf.json — ssl”</strong>,<br/>“build”: “ng build”,<br/>“test”: “ng test”,<br/>“lint”: “ng lint”,<br/>“e2e”: “ng e2e”<br/>},</span></pre><p id="eaee" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在使用<strong class="jm io"> npm run start运行应用程序。</strong></p><p id="8d09" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在浏览器窗口中点击<a class="ae lx" href="https://localhost:4200" rel="noopener ugc nofollow" target="_blank"> https://localhost:4200 </a>。</p><figure class="lz ma mb mc gt md gh gi paragraph-image"><div class="gh gi nk"><img src="../Images/f31004903a10e7387f36115456ec2604.png" data-original-src="https://miro.medium.com/v2/resize:fit:994/format:webp/1*9Vn1Z0b6diukCMP2MIl6EA.png"/></div><figcaption class="mk ml gj gh gi mm mn bd b be z dk">Secure Angular Dev Server</figcaption></figure><p id="74f1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在你知道了。都设置好了！</p><p id="56f2" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><em class="nl">更多内容请看</em><a class="ae lx" href="http://plainenglish.io" rel="noopener ugc nofollow" target="_blank"><strong class="jm io"><em class="nl">plain English . io</em></strong></a></p></div></div>    
</body>
</html>