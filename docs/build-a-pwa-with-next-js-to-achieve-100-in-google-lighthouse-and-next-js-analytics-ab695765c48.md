# ç”¨ Next.js å»ºç«‹ä¸€ä¸ª PWAï¼Œåœ¨ Google Lighthouse å’Œ Next.js Analytics ä¸­å®ç° 100%

> åŸæ–‡ï¼š<https://javascript.plainenglish.io/build-a-pwa-with-next-js-to-achieve-100-in-google-lighthouse-and-next-js-analytics-ab695765c48?source=collection_archive---------2----------------------->

![](img/c043853fb5c105faaed10c4a2dd9d4f2.png)

## åœ¨ Google light house+next . js Analytics+Webpagetest.org ä¸­è·å¾—æœ€é«˜æ’å

æœ¬æ–‡æ¶µç›–äº†æˆ‘ä»¬å¦‚ä½•å°†æˆ‘ä»¬çš„ [*nextjs-100*](https://github.com/rockyliyanlok/nextjs-100) åº”ç”¨ç¨‹åºå‡çº§åˆ° Next.js 12 æ¡†æ¶ã€‚æˆ‘ä»¬è¿˜å°†ä¼˜åŒ– [*nextjs-100*](https://github.com/rockyliyanlok/nextjs-100) åœ¨ Google Lighthouse å’Œ Next.js Analytics ä¸­è¾¾åˆ° 100%ï¼Œåœ¨ Next.js Analytics ä¸­å…¨éƒ¨ä¸º A æ³¢æ®µã€‚

ä¸Šå‘¨ï¼Œ2021 å¹´ 10 æœˆ 26 æ—¥ï¼ŒVercel åœ¨å…¶å¹´åº¦ä¼šè®®ä¸Šå®£å¸ƒæ¨å‡º Next.js 12ï¼Œè¿™æ˜¯æœ‰å²ä»¥æ¥æœ€å¤§çš„ä¸€æ¬¡å‘å¸ƒã€‚æœ‰å‡ ä¸ªä»¤äººå…´å¥‹çš„æ–°åŠŸèƒ½ï¼Œå¦‚ Rust ç¼–è¯‘å™¨ã€ä¸­é—´ä»¶ã€React 18 æ”¯æŒã€æœ¬æœº es æ¨¡å—æ”¯æŒå’Œ React æœåŠ¡å™¨ç»„ä»¶ã€‚

# å‡çº§åˆ° Next.js 12

è¿™æ˜¯æˆ‘å»å¹´å‘å¸ƒçš„ä¸€ä¸ªæ•…äº‹ï¼Œç”¨ Next.js æ¡†æ¶åˆ›å»ºäº†ä¸€ä¸ª PWAï¼Œå®ç°äº† 100%çš„ Google Lighthouse è¯„åˆ†ã€‚

[](https://rockyli.medium.com/build-a-pwa-with-next-js-to-achieve-100-lighthouse-score-8bbb86598ed4) [## ç”¨ Next.js æ„å»º PWAï¼Œå®ç° 100% lighthouse è¯„åˆ†

### è¿™ç¯‡æ–‡ç« è®²è¿°äº†æˆ‘ä»¬å¦‚ä½•ç”¨ Next.js (React.js)æ„å»ºä¸€ä¸ªæ¸è¿›çš„ Web åº”ç”¨ç¨‹åºï¼Œå¹¶è·å¾— 100%çš„åˆ†æ•°â€¦

rockyli.medium.com](https://rockyli.medium.com/build-a-pwa-with-next-js-to-achieve-100-lighthouse-score-8bbb86598ed4) 

è®©æˆ‘ä»¬æŠŠ [*nextjs-100*](https://github.com/rockyliyanlok/nextjs-100) åº”ç”¨å‡çº§åˆ° Next.js 12ã€‚

```
# get clone [https://github.com/rockyliyanlok/nextjs-100.git](https://github.com/rockyliyanlok/nextjs-100.git)
# cd nextjs-100
# yarn add next@12.0.2 next-pwa@5.4.0 react@17.0.2 react-dom@17.0.2
```

# WebPageTest.org

![](img/f658892c57c60fec7887520e8d03f0d1.png)

**Figure 1** Test with WebPageTest.org

é™¤äº† Google Lighthouseï¼Œ[Webpagetest.org](https://webpagetest.org/)ä¹Ÿæ˜¯ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„å·¥å…·ï¼Œå®ƒæä¾›äº†ä¼˜åŒ–ä½ çš„ web åº”ç”¨æ€§èƒ½çš„é‡è¦ä¿¡æ¯ã€‚ä¾‹å¦‚ï¼Œç”¨[Webpagetest.org](https://webpagetest.org/)åˆ†æ [*nextjs-100*](https://github.com/rockyliyanlok/nextjs-100) ã€‚

![](img/fd0cfe3a6ac522b8db574d4948adb0e4.png)

**Figure 2** Performance result from WebPageTest.org

ä»æ€§èƒ½æµ‹è¯•ç»“æœæ¥çœ‹ï¼Œ [*nextjs-100*](https://github.com/rockyliyanlok/nextjs-100) åœ¨å®‰å…¨è¯„åˆ†ä¸Šå¾—äº†ä¸€ä¸ª Eã€‚å®åœ¨æ˜¯å¤ªå°´å°¬äº†ï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ª web åº”ç”¨å«åš Next.js 100%ã€‚æˆ‘ä»¬æœ€å¥½å¯ç”¨ HTTP å®‰å…¨å¤´æ¥æ”¹è¿›æµè§ˆå™¨å®‰å…¨ç­–ç•¥ã€‚è¿™é‡Œçš„æ˜¯æ¥è‡ª Next.js çš„å®˜æ–¹å®‰å…¨å¤´æŒ‡å—ã€‚

## x-å†…å®¹-ç±»å‹-é€‰é¡¹

å°†`X-Content-Type-Options`å“åº” HTTP å¤´è®¾ç½®ä¸º **nosniff** å¯é˜²æ­¢æµè§ˆå™¨åœ¨æœªæ˜¾å¼è®¾ç½® content type å¤´çš„æƒ…å†µä¸‹è¯•å›¾çŒœæµ‹å†…å®¹ç±»å‹ã€‚è¿™å¯ä»¥é˜²æ­¢å…è®¸ç”¨æˆ·ä¸Šä¼ å’Œå…±äº« XSS æ–‡ä»¶çš„ç½‘ç«™çˆ†ç‚¸ã€‚

## x æ¡†æ¶é€‰é¡¹

å°†`X-Frame-Options`å“åº” HTTP å¤´è®¾ç½®ä¸º **SAMEORIGIN** ä»¥é˜²æ­¢ç‚¹å‡»åŠ«æŒæ”»å‡»ã€‚è¯¥æ ‡é¢˜æŒ‡ç¤ºæ˜¯å¦å…è®¸è¯¥ç«™ç‚¹åœ¨ iframe ä¸­æ˜¾ç¤ºã€‚

## x-XSS-ä¿æŠ¤

å°†`X-XSS-Protection` HTTP å¤´è®¾ç½®ä¸º**1ï¼›æ¨¡å¼=å—**ã€‚å½“æ£€æµ‹åˆ°åå°„çš„ XSS æ”»å‡»æ—¶ï¼Œ`X-XSS-Protection`æ ‡é¢˜ä¼šé˜»æ­¢é¡µé¢åŠ è½½ã€‚

./next.config.js

## å†…å®¹å®‰å…¨æ”¿ç­–

è®¾ç½®`Content Security Policy`æœ‰ä¸¤ç§æ–¹æ³•ã€‚æˆ‘ä»¬å¯ä»¥ç”¨ header **< meta >** æ ‡ç­¾æˆ–è€…é€šè¿‡`Content-Security-Policy` HTTP header æ¥è®¾ç½®ç­–ç•¥ã€‚è¯¥ç­–ç•¥æ˜¯ä¸€ä¸ªæ£€æµ‹å’Œç¼“è§£ç‰¹å®šç±»å‹æ”»å‡»çš„å±‚ï¼ŒåŒ…æ‹¬è·¨ç«™ç‚¹è„šæœ¬(XSS)å’Œæ•°æ®æ³¨å…¥æ”»å‡»ã€‚

ä»[å†…å®¹å®‰å…¨ç­–ç•¥å‚è€ƒæŒ‡å—](https://content-security-policy.com/)æ¥çœ‹ï¼Œ`Content-Security-Policy`çš„èµ·ç‚¹åº”è¯¥æ˜¯**default-srcâ€˜noneâ€™ï¼›script-srcâ€œselfâ€ï¼›connect-srcâ€œselfâ€ï¼›img-srcâ€œselfâ€ï¼›style-srcâ€œselfâ€ï¼›base-uriâ€œselfâ€ï¼›å½¢å¼-è¡ŒåŠ¨'è‡ªæˆ‘'**ã€‚

ç„¶è€Œï¼Œå®ƒåœ¨éƒ¨ç½²åˆ° vercel.com çš„ Next.js åº”ç”¨ç¨‹åºä¸­å¹¶ä¸å®Œç¾ã€‚æˆ‘ä»¬éœ€è¦æ›´å¤šçš„å®šåˆ¶ã€‚

åœ¨ Next.js ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ•£åˆ—æ–¹æ³•ï¼Œç®€å•åœ°å¯¹å†…è”è„šæœ¬æºè¿›è¡Œæ•£åˆ—ï¼Œå¹¶å°†æ•£åˆ—æ–‡æœ¬æ”¾å…¥`script-src`ç­–ç•¥ä¸­ã€‚

./utils/csp.js

./pages/_document.js

æˆ‘ä»¬æƒ³æ”¹å˜çš„ CSP çš„å¦ä¸€éƒ¨åˆ†æ˜¯ç”¨äº Vercel åˆ†æã€‚
ä» Vercel Analytics çš„[æ–‡æ¡£ä¸­ï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨ Vercel Analyticsï¼Œæˆ‘ä»¬éœ€è¦åœ¨`connect-src`ç­–ç•¥ä¸­æ·»åŠ **vitals.vercel-insights.com**ã€‚](https://vercel.com/docs/concepts/analytics#content-security-policy)

## manifest.json çš„é¢„ç¼“å­˜é—®é¢˜

åœ¨ Vercel ä¸Šéƒ¨ç½²åº”ç”¨ç¨‹åºåï¼Œæˆ‘ä»¬åœ¨ console.log ä¸­å‘ç°äº†ä¸€ä¸ªé—®é¢˜ã€‚æœªæ•è·çš„é”™è¯¯æ¥è‡ª*ä¸è‰¯é¢„ç¼“å­˜å“åº”*ã€‚

![](img/dff0d2e932ce263fd7437045a6ab7592.png)

**Figure 3** Pre-caching problem with manifest.json

é€šè¿‡ä»¥ä¸‹æ›´æ”¹ï¼Œä½¿ç”¨ next-pwa æ’ä»¶ä¼˜åŒ–äº†é¢„ç¼“å­˜å’Œè¿è¡Œæ—¶ç¼“å­˜ï¼Œå¹¶åœ¨ next-pwa ä¸­æ’é™¤äº†*middleware-manifest . JSON*ï¼Œè¯¥é—®é¢˜å¾—ä»¥è§£å†³ã€‚

./pages/_document.js

ç°åœ¨ï¼Œ [*nextjs-100*](https://github.com/rockyliyanlok/nextjs-100) åœ¨[WebPageTest.org](https://webpagetest.org/)ä¸Šè·å¾— **A+** æ³¢æ®µå®‰å…¨åˆ†ã€‚

![](img/c28a4991ed6c4a20da4d046838992cec.png)

**Figure 4** Performance result after security headers optimization

## ä¸ºå‹ç¼©ä¼ è¾“ä¼˜åŒ– favicon.ico

webpagetest.org æµ‹è¯•æŠ¥å‘Šä¸­è¿˜æœ‰ä¸€ä¸ªç¯èŠ‚æˆ‘ä»¬å¾ˆæ„Ÿå…´è¶£ã€‚ [*nextjs-100*](https://github.com/rockyliyanlok/nextjs-100) åœ¨å‹ç¼©ä¼ è¾“ä¸­å¾—åˆ°äº†ä¸€ä¸ªæ³¢æ®µ Bã€‚åŸå› æ˜¯ **favicon.ico** å‹ç¼©å¾—ä¸å¤Ÿï¼Œæ— æ³•è·å¾—æœ€ä½³æ€§èƒ½ã€‚

![](img/6073bc3367e816494a2655247f73db23.png)

**Figure 5** Hint from WebPageTest.org to compress favicon.ico

ç›®å‰çš„ **favicon.ico** å¤§å°ä¸º 64x64ã€‚è®©æˆ‘ä»¬æŠŠå®ƒè°ƒæ•´åˆ° 32x32ï¼Œä½¿å®ƒå˜å°ã€‚æˆ‘ä»¬å¯ä»¥ä»[*favicomatic.com*](https://favicomatic.com/)ä¸­ç”Ÿæˆã€‚

ç°åœ¨ï¼Œæˆ‘ä»¬åœ¨[WebPageTest.org](https://webpagetest.org/)çš„ä¸šç»©æŠ¥å‘Šä¸­æœ‰äº†å…¨éƒ¨ **A** ã€‚

![](img/1b22239926d51cf1d395d8cd1ab97990.png)

**Figure 6** All band A in the WebPageTest.org performance report

# è°·æ­Œç¯å¡”

æ˜¯æ—¶å€™åœ¨è°·æ­Œç¯å¡”é‡Œè¿è¡Œä¸€ä¸ªæµ‹è¯•äº†ã€‚Lighthouse ä¸€ç›´æ˜¯æˆ‘ä»¬æœ€å–œæ¬¢çš„å®¡è®¡å·¥å…·ã€‚

![](img/efa3a7a4dde6bafa76cc735cabbaa7a5.png)

**Figure 7** 100% in the Google Lighthouse performance report

å¤ªå¥½äº†ï¼ [*nextjs-100*](https://github.com/rockyliyanlok/nextjs-100) ç”³è¯·å†æ¬¡è¾¾åˆ° 100%ï¼ŒPWA æ–¹é¢é€šè¿‡éªŒè¯ã€‚

# éŸ¦å°”å¡å°”åˆ†æå…¬å¸

Google Lighthouse æ˜¯ä¸€ä¸ªæœ¬åœ°æ€§èƒ½æµ‹è¯•ï¼Œæˆ‘ä»¬é€šå¸¸åœ¨æµè§ˆå™¨æ‰©å±•æˆ–èŠ‚ç‚¹ CLI ä¸­æ‰§è¡Œã€‚Webpagetest.org æ˜¯ä¸€ä¸ªæ¥è‡ªå…¨çƒçš„ç½‘ç«™é€Ÿåº¦æµ‹è¯•ï¼Œä½¿ç”¨çœŸæ­£çš„æµè§ˆå™¨ã€‚ç„¶è€Œï¼ŒVercel Analytics æä¾›äº†å¦ä¸€ä¸ªè§’åº¦ï¼Œé€šè¿‡å®é™…ç”¨æˆ·æ•°æ®çš„çœŸå®ä½“éªŒæ¥ç”Ÿæˆæ€§èƒ½åˆ†æ•°ã€‚

![](img/1f35b59ed1e2fe65d5ee10f485811285.png)

**Figure 8** Next.js Analytics collect data from real traffic to generate performance report

## åœ¨ Vercel ä¸Šå¯ç”¨åˆ†æ

å½“ Next.js åº”ç”¨ç¨‹åºéƒ¨ç½²åœ¨ Vercel ä¸Šæ—¶ï¼Œå¯ç”¨åˆ†æéå¸¸å®¹æ˜“ã€‚åˆ‡æ¢åˆ° vercel åº”ç”¨ç¨‹åºé¡µé¢ä¸­çš„*åˆ†æ*é€‰é¡¹å¡ã€‚å¯ç”¨åˆ†æåŠŸèƒ½åï¼Œå°†é‡æ–°éƒ¨ç½²åº”ç”¨ç¨‹åºã€‚

![](img/b6c4d49a41a75a9a9ae2d381d7b98e6c.png)

**Figure 9** Enable Next.js Analytics for particular application on Vercel

ç”±äº Next.js Analytics ä»å®é™…æµé‡ä¸­æ”¶é›†æ•°æ®ï¼Œå› æ­¤åœ¨å¯ç”¨è¯¥åŠŸèƒ½åï¼Œæ²¡æœ‰è¶³å¤Ÿçš„æ•°æ®æ¥ç”ŸæˆæŠ¥å‘Šã€‚é€šå¸¸æŠ¥å‘Šå°†åœ¨ 30 åˆ†é’Ÿå†…å‡†å¤‡å¥½ã€‚å¦‚æœåº”ç”¨ç¨‹åºæ²¡æœ‰å¯åŠ¨ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦æ‰‹åŠ¨ç‚¹å‡»åº”ç”¨ç¨‹åºæ¥åˆ›å»ºä¸€äº›æµé‡ã€‚

![](img/a9c9127ecff8f3870f6204509acc6c75.png)

**Figure 10** 100 score in the Next.js Analytics performance report

æ­å–œä½ ï¼ [*nextjs-100*](https://github.com/rockyliyanlok/nextjs-100) åº”ç”¨ç¨‹åºåœ¨ Next.js Analytics ä¸­è·å¾— 100%ã€‚Next.js Analytics ä¸­è¦è¯„ä¼°çš„æŒ‡æ ‡ä¸ Google Lighthouse ä¸­çš„æŒ‡æ ‡éå¸¸ç›¸ä¼¼ï¼ŒåŒ…æ‹¬`First Content Paint`ã€`Largest Content Paint`ã€`Content Layout Shift`å’Œ`First Input Delay`ã€‚

## å®šä»·

Vercel Analytics æ˜¯ä¸€é¡¹ä»˜è´¹æœåŠ¡ã€‚ç„¶è€Œï¼Œæœ‰ä¸€ä¸ªä¸šä½™çˆ±å¥½è€…çš„å…è´¹å±‚ã€‚é™åˆ¶æ˜¯æ¯å¤© 100 ä¸ªå…è´¹æ•°æ®ç‚¹ï¼Œè¿™å¯¹äºè¯„ä¼°æ¥è¯´å·²ç»è¶³å¤Ÿäº†ã€‚

# æ‘˜è¦

åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°† Next.js æ¡†æ¶å‡çº§åˆ°äº† Next.js 12ï¼Œå¹¶å¯¹å…¶è¿›è¡Œäº†ä¼˜åŒ–ï¼Œä½¿å…¶åœ¨ Google Lighthouse å’Œ Next.js Vercel ä¸­è·å¾—äº† 100%çš„åˆ†æ•°ï¼Œåœ¨[WebPageTest.org](https://webpagetest.org/)åˆ†æå·¥å…·ä¸­å‡ä¸º A çº§ã€‚

ä½ å¯ä»¥åœ¨è¿™é‡Œéšæ„å…‹éš†æˆ–æ´¾ç”Ÿåº“ã€‚

ç¼–ç å¿«ä¹ï¼ğŸ’»

*æ›´å¤šå†…å®¹å°½åœ¨*[***plain English . io***](http://plainenglish.io/)