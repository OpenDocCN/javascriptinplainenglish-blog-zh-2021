<html>
<head>
<title>How To Deploy an Angular App on Google Cloud</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Google Cloud上部署Angular App</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/your-guide-for-deploying-an-angular-app-on-google-cloud-aint-complete-f6d5998332fb?source=collection_archive---------2-----------------------#2021-02-14">https://javascript.plainenglish.io/your-guide-for-deploying-an-angular-app-on-google-cloud-aint-complete-f6d5998332fb?source=collection_archive---------2-----------------------#2021-02-14</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><h2 id="c780" class="il im in bd b dl io ip iq ir is it dk iu translated" aria-label="kicker paragraph">WEB开发</h2><div class=""/><div class=""><h2 id="2701" class="pw-subtitle-paragraph jt iw in bd b ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk dk translated">在谷歌云上部署静态角度通用App？选择合适的服务。丰富您的步骤，让部署更加轻松。</h2></div><h1 id="6464" class="kl km in bd kn ko kp kq kr ks kt ku kv kc kw kd kx kf ky kg kz ki la kj lb lc bi translated">符合帕累托定律:20%的努力→ 80%的结果</h1><p id="ce39" class="pw-post-body-paragraph ld le in lf b lg lh jx li lj lk ka ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated">在应用了部署指南的步骤后，我得到了80%的满意结果。为了获得20%的满意度，我必须付出80%的努力。我在云端遇到了帕累托定律！您的指南可能不完整。以下是你需要知道的。</p><figure class="ma mb mc md gt me gh gi paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="gh gi lz"><img src="../Images/28774a6f8f21f21145d7202d35ea08f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*qe35QBtpwuG5ndjL"/></div></div><figcaption class="ml mm gj gh gi mn mo bd b be z dk">Photo by <a class="ae mp" href="https://unsplash.com/@raimondklavins?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Raimond Klavins</a> on <a class="ae mp" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="3259" class="pw-post-body-paragraph ld le in lf b lg mq jx li lj mr ka ll lm ms lo lp lq mt ls lt lu mu lw lx ly ig bi translated">首先让我们看看我遇到了什么问题。稍后，我们将修复它。</p><h1 id="e668" class="kl km in bd kn ko kp kq kr ks kt ku kv kc kw kd kx kf ky kg kz ki la kj lb lc bi translated">➡️:如果你不懒，就不要使用应用引擎</h1><p id="789e" class="pw-post-body-paragraph ld le in lf b lg lh jx li lj lk ka ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated">在谷歌搜索中输入“在谷歌云上部署angular app”即可。你会注意到大多数文章描述了如何在应用引擎上部署Angular应用。这是在谷歌云平台上部署Angular app最常见的方式。</p><p id="19cb" class="pw-post-body-paragraph ld le in lf b lg mq jx li lj mr ka ll lm ms lo lp lq mt ls lt lu mu lw lx ly ig bi translated">是的，对于懒惰的人来说，这是一个完美的平台，你只需要部署，它会处理你不想考虑的事情。硬币的另一部分是你必须接受它是如何配置的。我的简单应用程序冷启动用了4秒多。我的不耐烦的用户走了，他点击离开。</p><p id="0cad" class="pw-post-body-paragraph ld le in lf b lg mq jx li lj mr ka ll lm ms lo lp lq mt ls lt lu mu lw lx ly ig bi translated">所以，我换了另一个在配置上给我更多自由的Google云服务:Google Cloud Run。</p><h1 id="8530" class="kl km in bd kn ko kp kq kr ks kt ku kv kc kw kd kx kf ky kg kz ki la kj lb lc bi translated">云运行中的➡️隐藏子域映射</h1><p id="ad6f" class="pw-post-body-paragraph ld le in lf b lg lh jx li lj lk ka ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated">一旦我在Cloud Run中部署了我的应用程序，它的运行速度比我在Application Engine中部署它时要快得多。所以，这是一个巨大的胜利！我可以将服务映射到我的域。好吧，快乐的日子！</p><p id="e25a" class="pw-post-body-paragraph ld le in lf b lg mq jx li lj mr ka ll lm ms lo lp lq mt ls lt lu mu lw lx ly ig bi translated">不完全是。我在“WWW”子域上得到一个404错误。尽管DNS服务器配置得很好。发生了什么事？要么是我的指南不完整，要么是我太笨了。不管是什么原因，它也可能发生在你身上。</p><h1 id="114c" class="kl km in bd kn ko kp kq kr ks kt ku kv kc kw kd kx kf ky kg kz ki la kj lb lc bi translated">非根页面上的➡️ 404错误</h1><p id="d9d5" class="pw-post-body-paragraph ld le in lf b lg lh jx li lj lk ka ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated">当我直接在浏览器中输入页面的URL时，我得到了404错误。只有网站的根页面可以直接打开，没有任何错误。不过，通过应用程序根页面的菜单导航到不同的页面进行得很顺利。你有同样的问题吗？您可能刚刚安装了标准指南中的标准映像，并相信它马上就能工作。</p><h1 id="302a" class="kl km in bd kn ko kp kq kr ks kt ku kv kc kw kd kx kf ky kg kz ki la kj lb lc bi translated">➡️谷歌云运行性能调整</h1><p id="c8e9" class="pw-post-body-paragraph ld le in lf b lg lh jx li lj lk ka ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated">我不得不深入到更高级的话题，来调整Google Cloud Run提供的应用程序的性能。我们马上就要开始了。同样，这是一些隐藏的东西，大多数标准指南都没有告诉你。</p></div><div class="ab cl mv mw hr mx" role="separator"><span class="my bw bk mz na nb"/><span class="my bw bk mz na nb"/><span class="my bw bk mz na"/></div><div class="ig ih ii ij ik"><h1 id="12af" class="kl km in bd kn ko nc kq kr ks nd ku kv kc ne kd kx kf nf kg kz ki ng kj lb lc bi translated">减少工作量</h1><p id="526c" class="pw-post-body-paragraph ld le in lf b lg lh jx li lj lk ka ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated">现在你知道我丢失的20%的结果是什么了，让我们来谈谈如何解决这个问题，这样<strong class="lf ix">你</strong>就有希望用更少的努力获得更多的满足感。</p><figure class="ma mb mc md gt me gh gi paragraph-image"><div class="gh gi nh"><img src="../Images/1b85b6bb2c56b572d65a4eed0549cef6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1334/format:webp/1*9wCgJb719_jo8g6PcfCADw.png"/></div><figcaption class="ml mm gj gh gi mn mo bd b be z dk">80% result with 20% effort — 20% result with 80% effort</figcaption></figure><blockquote class="ni nj nk"><p id="e01d" class="ld le nl lf b lg mq jx li lj mr ka ll nm ms lo lp nn mt ls lt no mu lw lx ly ig bi translated"><em class="in"> 1️⃣为你的静态应用选择合适的谷歌云服务</em></p><p id="b853" class="ld le nl lf b lg mq jx li lj mr ka ll nm ms lo lp nn mt ls lt no mu lw lx ly ig bi translated"><em class="in"> 2️⃣打造轻盈形象</em></p><p id="aa69" class="ld le nl lf b lg mq jx li lj mr ka ll nm ms lo lp nn mt ls lt no mu lw lx ly ig bi translated"><em class="in"> 3️⃣配置网络服务器以避免404错误</em></p><p id="63df" class="ld le nl lf b lg mq jx li lj mr ka ll nm ms lo lp nn mt ls lt no mu lw lx ly ig bi translated"><em class="in"> 4️⃣配置云运行以获得最佳性能</em></p><p id="1194" class="ld le nl lf b lg mq jx li lj mr ka ll nm ms lo lp nn mt ls lt no mu lw lx ly ig bi translated"><em class="in"> 5️⃣地图云正确运行到您的(子)域</em></p></blockquote><h1 id="3456" class="kl km in bd kn ko kp kq kr ks kt ku kv kc kw kd kx kf ky kg kz ki la kj lb lc bi translated">🌘 1.选择正确的谷歌云服务🌘</h1><p id="c125" class="pw-post-body-paragraph ld le in lf b lg lh jx li lj lk ka ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated">要在Google Cloud中部署您的应用，您基本上有以下选择:</p><ul class=""><li id="bcc5" class="np nq in lf b lg mq lj mr lm nr lq ns lu nt ly nu nv nw nx bi translated">应用引擎</li><li id="798c" class="np nq in lf b lg ny lj nz lm oa lq ob lu oc ly nu nv nw nx bi translated">计算引擎</li><li id="c591" class="np nq in lf b lg ny lj nz lm oa lq ob lu oc ly nu nv nw nx bi translated">库伯内特斯</li><li id="51cb" class="np nq in lf b lg ny lj nz lm oa lq ob lu oc ly nu nv nw nx bi translated">云函数</li><li id="e99e" class="np nq in lf b lg ny lj nz lm oa lq ob lu oc ly nu nv nw nx bi translated">云存储</li><li id="1d3f" class="np nq in lf b lg ny lj nz lm oa lq ob lu oc ly nu nv nw nx bi translated">云运行</li></ul><p id="0d3e" class="pw-post-body-paragraph ld le in lf b lg mq jx li lj mr ka ll lm ms lo lp lq mt ls lt lu mu lw lx ly ig bi translated">如果你是谷歌云的初学者，你不知道该使用哪种服务，那么你将花费大量精力来找出最适合你的服务。</p><p id="af97" class="pw-post-body-paragraph ld le in lf b lg mq jx li lj mr ka ll lm ms lo lp lq mt ls lt lu mu lw lx ly ig bi translated">对于简单的静态网站，我认为Google Cloud Run是最好的方式之一。对那些感兴趣的人来说，如果你在评论中询问，我可以激发这个声明。</p><h1 id="735c" class="kl km in bd kn ko kp kq kr ks kt ku kv kc kw kd kx kf ky kg kz ki la kj lb lc bi translated">🌗 2.产生一个轻量级的形象🌗</h1><p id="53e5" class="pw-post-body-paragraph ld le in lf b lg lh jx li lj lk ka ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated">一旦我们选择使用Google Cloud Run作为服务来为我们的应用程序提供服务，我们就需要制作一个Docker映像。所以这里我们也想做出一个好的选择。</p><p id="9193" class="pw-post-body-paragraph ld le in lf b lg mq jx li lj mr ka ll lm ms lo lp lq mt ls lt lu mu lw lx ly ig bi translated">如果您使用Node.js的官方Docker映像，这通常是Angular应用程序的方式，您必须携带大约677 MB的重映像。现在为了我们的目的，我们不需要这样丰富的图像。</p><p id="1114" class="pw-post-body-paragraph ld le in lf b lg mq jx li lj mr ka ll lm ms lo lp lq mt ls lt lu mu lw lx ly ig bi translated">我们将构建一个40倍小的Nginx图像，非常适合我们的静态角度应用。</p><h1 id="0d39" class="kl km in bd kn ko kp kq kr ks kt ku kv kc kw kd kx kf ky kg kz ki la kj lb lc bi translated">🌖 3.配置web服务器以避免404错误🌖</h1><p id="911b" class="pw-post-body-paragraph ld le in lf b lg lh jx li lj lk ka ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated">现在我们已经选择了正确的服务和轻量级映像，我们需要很好地配置映像。构建Nginx映像时得到的标准Nginx配置需要进行微调，以避免404错误。</p><h1 id="c9b0" class="kl km in bd kn ko kp kq kr ks kt ku kv kc kw kd kx kf ky kg kz ki la kj lb lc bi translated">🌕 4.配置云运行以获得最佳性能🌕</h1><p id="1ca5" class="pw-post-body-paragraph ld le in lf b lg lh jx li lj lk ka ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated">您将使用Cloud Run为您制作的图像提供服务。docker容器中的这张图片存储在Google Cloud的容器注册表中。出于性能原因，容器的托管位置非常重要。现在来看看第一条性能提示:将图像推送到您希望大多数用户所在的位置。</p><p id="c6b5" class="pw-post-body-paragraph ld le in lf b lg mq jx li lj mr ka ll lm ms lo lp lq mt ls lt lu mu lw lx ly ig bi translated">另一个性能考虑是优化Google Cloud Run中的高级容器设置。请特别注意自动缩放，以便至少有一个实例在运行。这导致更快的启动时间。</p><h1 id="67db" class="kl km in bd kn ko kp kq kr ks kt ku kv kc kw kd kx kf ky kg kz ki la kj lb lc bi translated">☀️ 5.正确映射到您的(子)域☀️</h1><p id="1a5e" class="pw-post-body-paragraph ld le in lf b lg lh jx li lj lk ka ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated">Google Cloud Run有一个很好的功能，可以将服务映射到你的域名。进行映射很容易，但是我很难将服务映射到我的WWW子域。在下面我的实践指南的最后一步6中，我们将会看到如何正确地绘制地图。</p><p id="ae94" class="pw-post-body-paragraph ld le in lf b lg mq jx li lj mr ka ll lm ms lo lp lq mt ls lt lu mu lw lx ly ig bi translated">嘣！💥。(努力受欢迎)。最后，还有你努力的最后捷径。</p></div><div class="ab cl mv mw hr mx" role="separator"><span class="my bw bk mz na nb"/><span class="my bw bk mz na nb"/><span class="my bw bk mz na"/></div><div class="ig ih ii ij ik"><h1 id="ccbd" class="kl km in bd kn ko nc kq kr ks nd ku kv kc ne kd kx kf nf kg kz ki ng kj lb lc bi translated">让我们开始吧。</h1><p id="5983" class="pw-post-body-paragraph ld le in lf b lg lh jx li lj lk ka ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated">所以现在你知道了在谷歌云平台上为你的静态角度网站提供服务时，你应该知道的5个主要细节，是时候让它发生了！我上面描述的所有细节都是在以下步骤中实现的。</p><h1 id="296a" class="kl km in bd kn ko kp kq kr ks kt ku kv kc kw kd kx kf ky kg kz ki la kj lb lc bi translated">先决条件</h1><p id="ecbc" class="pw-post-body-paragraph ld le in lf b lg lh jx li lj lk ka ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated">跑得快一个前提是你有腿。你还在吗，蜗牛？</p><figure class="ma mb mc md gt me gh gi paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="gh gi od"><img src="../Images/c28f92bf65c76698f9ba5b5aab1a9e7e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*oGrG97OTjZWHZc2S"/></div></div><figcaption class="ml mm gj gh gi mn mo bd b be z dk">Photo by <a class="ae mp" href="https://unsplash.com/@amir_v_ali?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">amirali mirhashemian</a> on <a class="ae mp" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="5849" class="pw-post-body-paragraph ld le in lf b lg mq jx li lj mr ka ll lm ms lo lp lq mt ls lt lu mu lw lx ly ig bi translated">以下是在Google Cloud Run中提供Angular应用程序并将其映射到您的域的一些先决条件。</p><ul class=""><li id="08a4" class="np nq in lf b lg mq lj mr lm nr lq ns lu nt ly nu nv nw nx bi translated">您有一个谷歌云帐户</li><li id="37a7" class="np nq in lf b lg ny lj nz lm oa lq ob lu oc ly nu nv nw nx bi translated">你在谷歌云中有一个项目，你可以在那里部署和运行你的应用程序</li><li id="502c" class="np nq in lf b lg ny lj nz lm oa lq ob lu oc ly nu nv nw nx bi translated">您已经在本地机器上安装了Docker</li><li id="9d58" class="np nq in lf b lg ny lj nz lm oa lq ob lu oc ly nu nv nw nx bi translated">你有一个SSR Angular应用程序，随时可以部署。</li><li id="338c" class="np nq in lf b lg ny lj nz lm oa lq ob lu oc ly nu nv nw nx bi translated">您已经在机器上安装了Google cloud SDK。</li><li id="a704" class="np nq in lf b lg ny lj nz lm oa lq ob lu oc ly nu nv nw nx bi translated">您要在其中运行应用程序的Google Cloud项目已被配置为活动项目。</li><li id="55aa" class="np nq in lf b lg ny lj nz lm oa lq ob lu oc ly nu nv nw nx bi translated">也许你需要一些耐心，才能把它做好！</li></ul><p id="f4c8" class="pw-post-body-paragraph ld le in lf b lg mq jx li lj mr ka ll lm ms lo lp lq mt ls lt lu mu lw lx ly ig bi translated">如果你不能完全满足所有这些要求，这些步骤可以根据你的情况进行一些小的修改。</p><h1 id="8b70" class="kl km in bd kn ko kp kq kr ks kt ku kv kc kw kd kx kf ky kg kz ki la kj lb lc bi translated">1️.配置NGINX修复404错误和更快的传输</h1><p id="6d36" class="pw-post-body-paragraph ld le in lf b lg lh jx li lj lk ka ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated">我们得到的alpine nginx的标准配置文件需要微调。我们将替换该文件。</p><blockquote class="ni nj nk"><p id="f3cd" class="ld le nl lf b lg mq jx li lj mr ka ll nm ms lo lp nn mt ls lt no mu lw lx ly ig bi translated">到我的库<a class="ae mp" href="https://github.com/gitpoel/docker-alpine-nxing" rel="noopener ugc nofollow" target="_blank"> GitHub </a>获取nginx配置文件"<em class="in"> default.conf </em>"并复制到你的Angular应用根目录下的新文件夹"<em class="in"> nginx/conf.d </em>"中。通过输入您的域(如果有)来调整文件的内容。</p></blockquote><p id="bd53" class="pw-post-body-paragraph ld le in lf b lg mq jx li lj mr ka ll lm ms lo lp lq mt ls lt lu mu lw lx ly ig bi translated">您的目录结构如下所示:</p><figure class="ma mb mc md gt me gh gi paragraph-image"><div class="gh gi oe"><img src="../Images/06a07a2b68105f648963fd2fc4b5b285.png" data-original-src="https://miro.medium.com/v2/resize:fit:418/format:webp/1*N8tx6k7QbN305fEf43MmDQ.png"/></div><figcaption class="ml mm gj gh gi mn mo bd b be z dk">Folder structure of the Angular project “Bloggyboots02”</figcaption></figure><p id="9e04" class="pw-post-body-paragraph ld le in lf b lg mq jx li lj mr ka ll lm ms lo lp lq mt ls lt lu mu lw lx ly ig bi">.</p><p id="87b3" class="pw-post-body-paragraph ld le in lf b lg mq jx li lj mr ka ll lm ms lo lp lq mt ls lt lu mu lw lx ly ig bi translated">如果您看一下文件内部，配置文件有一个服务器块。在这个块中，我们告诉Nginx他应该进行内部重定向，否则我们会遇到我上面讨论过的404问题。</p><p id="3488" class="pw-post-body-paragraph ld le in lf b lg mq jx li lj mr ka ll lm ms lo lp lq mt ls lt lu mu lw lx ly ig bi translated">此外，出于性能原因，我们使用GZIP。它在传输过程中减小了文件的大小。您还可以决定添加图像、CSS和JS文件的客户端缓存。如果这是您想要的，那么将这种代码添加到服务器块中:</p><pre class="ma mb mc md gt of og oh oi aw oj bi"><span id="7199" class="ok km in og b gy ol om l on oo">server {<br/>   # caching<br/>   location ~* \.(jpg|jpeg|png|gif|ico)$ {<br/>       expires 20d;<br/>    }<br/>    location ~* \.(css|js)$ {<br/>       expires 5d;<br/>    }<br/>}</span></pre><h1 id="e0fd" class="kl km in bd kn ko kp kq kr ks kt ku kv kc kw kd kx kf ky kg kz ki la kj lb lc bi translated">2️.创建覆盖标准配置的Docker文件</h1><p id="4d17" class="pw-post-body-paragraph ld le in lf b lg lh jx li lj lk ka ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated">在angular项目的根目录下，创建一个名为Dockerfile的文件，包含以下内容。它将创建一个小的简单的Docker Alpine Nginx图像，运行您的Angular Universal应用程序。</p><blockquote class="ni nj nk"><p id="2ffd" class="ld le nl lf b lg mq jx li lj mr ka ll nm ms lo lp nn mt ls lt no mu lw lx ly ig bi translated">到我的库<a class="ae mp" href="https://github.com/gitpoel/docker-alpine-nxing" rel="noopener ugc nofollow" target="_blank"> GitHub </a>获取docker文件，并将其复制到Angular应用程序的根目录。根据您的环境进行调整。发现下面我的言论！</p></blockquote><p id="282d" class="pw-post-body-paragraph ld le in lf b lg mq jx li lj mr ka ll lm ms lo lp lq mt ls lt lu mu lw lx ly ig bi translated">以下是docker文件的内容和一些重要的注释</p><pre class="ma mb mc md gt of og oh oi aw oj bi"><span id="d57f" class="ok km in og b gy ol om l on oo"><strong class="og ix"># STEP 1 building your app</strong></span><span id="cdde" class="ok km in og b gy op om l on oo">FROM node:alpine as <em class="nl">builder<br/></em>RUN apk update &amp;&amp; apk add --no-cache make git</span><span id="e69a" class="ok km in og b gy op om l on oo"><strong class="og ix"># a) Create app directory</strong><br/>WORKDIR /app</span><span id="85ad" class="ok km in og b gy op om l on oo"><strong class="og ix"># b) Create app/nginx directory and copy default.conf to it</strong><br/>WORKDIR /app/nginx<br/>COPY nginx/conf.d/default.conf /app/nginx/</span><span id="1f4d" class="ok km in og b gy op om l on oo"><strong class="og ix"># c) Install app dependencies</strong><br/>COPY package.json package-lock.json /app/<br/>RUN cd /app &amp;&amp; npm set progress=false &amp;&amp; npm install</span><span id="043c" class="ok km in og b gy op om l on oo"><strong class="og ix"># d) Copy project files into the docker image and build your app</strong><br/>COPY .  /app<br/>RUN cd /app &amp;&amp; npm run build:ssr</span><span id="4708" class="ok km in og b gy op om l on oo"><strong class="og ix"># STEP 2 build a small nginx image</strong></span><span id="20ef" class="ok km in og b gy op om l on oo">FROM nginx:alpine<br/><strong class="og ix"># a) Remove default nginx code</strong><br/>RUN rm -rf /usr/share/nginx/html/*</span><span id="e641" class="ok km in og b gy op om l on oo"><strong class="og ix"># b) From 'builder' copy your site to default nginx public folder</strong><br/>COPY --from=<em class="nl">builder </em>/app/dist/bloggybootsv02/browser /usr/share/nginx/html</span><span id="0b08" class="ok km in og b gy op om l on oo"><strong class="og ix"># c) copy your own default nginx configuration to the conf folder</strong><br/>RUN rm -rf /etc/nginx/conf.d/default.conf<br/>COPY --from=builder /app/nginx/conf.d/default.conf /etc/nginx/conf.d/default.conf</span><span id="ed71" class="ok km in og b gy op om l on oo">EXPOSE 80<br/>CMD ["nginx", "-g", "daemon off;"]</span></pre><p id="057e" class="pw-post-body-paragraph ld le in lf b lg mq jx li lj mr ka ll lm ms lo lp lq mt ls lt lu mu lw lx ly ig bi translated">几个<strong class="lf ix">重要</strong>备注:</p><ol class=""><li id="f766" class="np nq in lf b lg mq lj mr lm nr lq ns lu nt ly oq nv nw nx bi translated">在步骤1 b中，我们需要将默认配置文件复制到‘builder’环境中，这样我们就可以在以后将它从builder环境复制到nginx配置文件夹中。</li><li id="3d91" class="np nq in lf b lg ny lj nz lm oa lq ob lu oc ly oq nv nw nx bi translated">在步骤1 d，我们运行命令“<strong class="lf ix"> npm run build:ssr </strong>”。这意味着我们正在建立服务器端渲染的应用程序，这意味着我已经使用通用角度。如果这不起作用，你应该改变这一步，让它以你想要的方式构建你的应用。标准的建角方式是<code class="fe or os ot og b">ng build --prod</code>。<strong class="lf ix"> <em class="nl"> </em> </strong>你可以检查你的package.json中的NPM命令来构建你的应用程序。(不过，我建议查看Angular网站，看看Angular Universal为您提供了什么)</li><li id="cc26" class="np nq in lf b lg ny lj nz lm oa lq ob lu oc ly oq nv nw nx bi translated">在步骤2 b，我们使用<strong class="lf ix">端口80 </strong>来公开我们的应用程序。Google cloud使用默认端口8080，所以要注意，如果你像我一样，走8080以外的另一个端口，那么在运行Cloud Run的时候就要更改了。稍后，我们将看到如何在云运行中更改默认端口号。</li><li id="77c4" class="np nq in lf b lg ny lj nz lm oa lq ob lu oc ly oq nv nw nx bi translated">在步骤2 b中，您会注意到我们将/app/dist/bloggybootsv 02/browser作为我们的dist文件夹，以复制到nginx/HTML目录。当你创建docker文件时，你应该使用你自己的dist文件夹的路径。浏览器文件夹是在SSR构建过程中生成的；记得我之前的话:我用角通用。</li><li id="ba35" class="np nq in lf b lg ny lj nz lm oa lq ob lu oc ly oq nv nw nx bi translated">在步骤2c，我们替换了标准的nginx配置，以避免404错误并提高性能。</li></ol><h1 id="ebf2" class="kl km in bd kn ko kp kq kr ks kt ku kv kc kw kd kx kf ky kg kz ki la kj lb lc bi translated">3️.构建并标记Docker图像</h1><p id="13fa" class="pw-post-body-paragraph ld le in lf b lg lh jx li lj lk ka ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated">现在您的docker文件已经准备好了，调整下面显示的命令，使它适合您的环境。请进一步阅读如何针对您的案例运行它的说明。</p><blockquote class="ni nj nk"><p id="6a24" class="ld le nl lf b lg mq jx li lj mr ka ll nm ms lo lp nn mt ls lt no mu lw lx ly ig bi translated">运行下面的命令，但首先:根据您的环境进行调整！</p></blockquote><pre class="ma mb mc md gt of og oh oi aw oj bi"><span id="c4da" class="ok km in og b gy ol om l on oo">docker build -t app:0.1 .</span><span id="2e48" class="ok km in og b gy op om l on oo">docker tag app:0.1 eu.gcr.io/bloggyboots/app:0.1</span></pre><p id="e57d" class="pw-post-body-paragraph ld le in lf b lg mq jx li lj mr ka ll lm ms lo lp lq mt ls lt lu mu lw lx ly ig bi translated">运行Angular项目根目录中的命令。用<strong class="lf ix">第一个命令</strong>，<em class="nl"> docker build -t app:0.1。</em>”，我们构建图像并用名称“app:0.1”标记它(-t选项)。你可以选择任何名字。“0.1”表示应用程序的版本。</p><p id="d990" class="pw-post-body-paragraph ld le in lf b lg mq jx li lj mr ka ll lm ms lo lp lq mt ls lt lu mu lw lx ly ig bi translated">第二个命令<strong class="lf ix">、</strong>、<em class="nl">docker tag app:0.1 eu.gcr.io/bloggyboots/app:0.1</em>，需要一些解释，对于您的情况可能会有所不同。为了将图像推送到注册表，您需要决定您想要在哪个<strong class="lf ix">位置</strong>存储您的图像。谷歌是这样说的:</p><ul class=""><li id="f0f1" class="np nq in lf b lg mq lj mr lm nr lq ns lu nt ly nu nv nw nx bi translated"><code class="fe or os ot og b">gcr.io</code>在美国的数据中心托管图像，但该位置将来可能会改变</li><li id="5e87" class="np nq in lf b lg ny lj nz lm oa lq ob lu oc ly nu nv nw nx bi translated"><code class="fe or os ot og b">us.gcr.io</code>在美国的数据中心托管映像，与<code class="fe or os ot og b">gcr.io</code>托管的映像放在不同的存储桶中</li><li id="23c2" class="np nq in lf b lg ny lj nz lm oa lq ob lu oc ly nu nv nw nx bi translated"><code class="fe or os ot og b">eu.gcr.io</code>在欧盟主持图像</li><li id="28e5" class="np nq in lf b lg ny lj nz lm oa lq ob lu oc ly nu nv nw nx bi translated"><code class="fe or os ot og b">asia.gcr.io</code>在亚洲的数据中心托管图像</li></ul><p id="d13d" class="pw-post-body-paragraph ld le in lf b lg mq jx li lj mr ka ll lm ms lo lp lq mt ls lt lu mu lw lx ly ig bi translated">就我而言，我使用<code class="fe or os ot og b">eu.gcr.io </code>是因为我怀疑我的大多数用户会在欧洲使用这个应用。(在多区域中有多种部署方式，但这里让我们保持简单)</p><p id="55c3" class="pw-post-body-paragraph ld le in lf b lg mq jx li lj mr ka ll lm ms lo lp lq mt ls lt lu mu lw lx ly ig bi translated">命令中的“bloggyboots ”(这是我的项目名称)可以不使用，而是使用另一个名称。</p><p id="48d4" class="pw-post-body-paragraph ld le in lf b lg mq jx li lj mr ka ll lm ms lo lp lq mt ls lt lu mu lw lx ly ig bi translated"><strong class="lf ix">可选</strong>:在把你的应用程序推到云端之前测试一下:</p><pre class="ma mb mc md gt of og oh oi aw oj bi"><span id="f2b6" class="ok km in og b gy ol om l on oo">docker run -p 4000:80 --name my-app app:0.1</span></pre><h1 id="ef98" class="kl km in bd kn ko kp kq kr ks kt ku kv kc kw kd kx kf ky kg kz ki la kj lb lc bi translated">4️.将本地图像推送到google cloud container注册表，负责定位</h1><p id="08eb" class="pw-post-body-paragraph ld le in lf b lg lh jx li lj lk ka ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated">现在是时候将映像推送到云了。调整下面显示的命令，使其适合您的环境。请进一步阅读如何针对您的案例运行它的说明。</p><blockquote class="ni nj nk"><p id="d610" class="ld le nl lf b lg mq jx li lj mr ka ll nm ms lo lp nn mt ls lt no mu lw lx ly ig bi translated">运行下面的命令，但是首先:根据您的环境进行调整！</p></blockquote><pre class="ma mb mc md gt of og oh oi aw oj bi"><span id="b86f" class="ok km in og b gy ol om l on oo">docker push eu.gcr.io/bloggyboots/app:0.1</span></pre><p id="15c8" class="pw-post-body-paragraph ld le in lf b lg mq jx li lj mr ka ll lm ms lo lp lq mt ls lt lu mu lw lx ly ig bi translated">我使用<code class="fe or os ot og b">eu.gcr.io </code>将它推到欧洲的一个位置。请参阅上一段的解释，您应该选择哪个位置以及哪个命令附加到它。</p><p id="08df" class="pw-post-body-paragraph ld le in lf b lg mq jx li lj mr ka ll lm ms lo lp lq mt ls lt lu mu lw lx ly ig bi translated">另外，使用您在上一步中使用的注册表名称。我的是bloggyboots，我用“app:0.1”标记了这张图片。</p><p id="897f" class="pw-post-body-paragraph ld le in lf b lg mq jx li lj mr ka ll lm ms lo lp lq mt ls lt lu mu lw lx ly ig bi translated">执行完这个命令后，您应该可以在云中看到您的映像。转到谷歌云控制台，搜索容器注册表。打开应用程序文件夹，找到您的图像。您应该会看到类似这样的内容:</p><figure class="ma mb mc md gt me gh gi paragraph-image"><div class="gh gi ou"><img src="../Images/9fdec9db137dc53a42d50ac5c6699d90.png" data-original-src="https://miro.medium.com/v2/resize:fit:884/format:webp/1*yGG6TC-sXb2koQxoG5CKJw.png"/></div></figure><p id="6337" class="pw-post-body-paragraph ld le in lf b lg mq jx li lj mr ka ll lm ms lo lp lq mt ls lt lu mu lw lx ly ig bi translated">或者直接运行:</p><pre class="ma mb mc md gt of og oh oi aw oj bi"><span id="35e5" class="ok km in og b gy ol om l on oo">gcloud container images list --repository=eu.gcr.io/bloggyboots</span></pre><p id="b5ef" class="pw-post-body-paragraph ld le in lf b lg mq jx li lj mr ka ll lm ms lo lp lq mt ls lt lu mu lw lx ly ig bi translated">替换您选择的存储库名称的<code class="fe or os ot og b">eu.grc.io/bloggyboots</code>。</p><h1 id="419c" class="kl km in bd kn ko kp kq kr ks kt ku kv kc kw kd kx kf ky kg kz ki la kj lb lc bi translated">5.在Google Cloud Run中创建服务</h1><p id="3d22" class="pw-post-body-paragraph ld le in lf b lg lh jx li lj lk ka ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated">既然我们已经有了云中的映像，那么是时候使用Cloud Run来运行它了！</p><p id="63c0" class="pw-post-body-paragraph ld le in lf b lg mq jx li lj mr ka ll lm ms lo lp lq mt ls lt lu mu lw lx ly ig bi translated">打开Google Cloud，确保您位于您想要创建服务的项目中，并且您的图像存在于该项目中。</p><p id="9069" class="pw-post-body-paragraph ld le in lf b lg mq jx li lj mr ka ll lm ms lo lp lq mt ls lt lu mu lw lx ly ig bi translated">在谷歌云控制台中，搜索Cloud Run。当你在那里时，创建一个服务。</p><figure class="ma mb mc md gt me gh gi paragraph-image"><div class="gh gi ov"><img src="../Images/5e85af3ff1019636fac9b44430a6382a.png" data-original-src="https://miro.medium.com/v2/resize:fit:938/format:webp/1*I5E4ZUVMfa8qX1rj2MATNQ.png"/></div></figure><p id="831d" class="pw-post-body-paragraph ld le in lf b lg mq jx li lj mr ka ll lm ms lo lp lq mt ls lt lu mu lw lx ly ig bi translated">您需要选择想要部署的区域。<strong class="lf ix">最好让你的容器注册区域与你在Google Cloud Run </strong>中选择的区域同步。否则，您将支付网络费用，这可以通过这种方式避免。在谷歌云中查找关于该位置的更多信息。对我来说，我选择欧洲-西欧4(荷兰)。</p><figure class="ma mb mc md gt me gh gi paragraph-image"><div class="gh gi ow"><img src="../Images/bc717e79c0e2aaa89c952c10b36a8a6b.png" data-original-src="https://miro.medium.com/v2/resize:fit:864/format:webp/1*saso9qLCgDqgx4-sgFs6cw.png"/></div></figure><p id="2c2d" class="pw-post-body-paragraph ld le in lf b lg mq jx li lj mr ka ll lm ms lo lp lq mt ls lt lu mu lw lx ly ig bi translated">在创建服务的下一步中，您可以从已经推送到云中的容器注册表中选择您的映像(参见前面的段落)。</p><figure class="ma mb mc md gt me gh gi paragraph-image"><div class="gh gi ox"><img src="../Images/363c208be915bfb8aacf8af36627a8fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1076/format:webp/1*_umsPNojQIN6iB7MomcAXg.png"/></div></figure><p id="aae2" class="pw-post-body-paragraph ld le in lf b lg mq jx li lj mr ka ll lm ms lo lp lq mt ls lt lu mu lw lx ly ig bi translated">在高级设置中，容器端口必须等于您在Docker文件中配置的端口号，这一点很重要。我使用端口80。</p><figure class="ma mb mc md gt me gh gi paragraph-image"><div class="gh gi oy"><img src="../Images/687a5da285371ed37a92af283ee92335.png" data-original-src="https://miro.medium.com/v2/resize:fit:1042/format:webp/1*cD2I3DCFcdmf8UCBtQWxvA.png"/></div><figcaption class="ml mm gj gh gi mn mo bd b be z dk">Set the port number to the port number of your Docker config!</figcaption></figure><p id="6a21" class="pw-post-body-paragraph ld le in lf b lg mq jx li lj mr ka ll lm ms lo lp lq mt ls lt lu mu lw lx ly ig bi translated">您可以更改<strong class="lf ix">自动缩放</strong>。我希望至少有1个实例，这样当有人第一次访问我的网站时，我的网站会比默认的0个实例启动得更快。</p><p id="a673" class="pw-post-body-paragraph ld le in lf b lg mq jx li lj mr ka ll lm ms lo lp lq mt ls lt lu mu lw lx ly ig bi translated">最少运行1个实例会多花一点钱，但是当那个图像没有流量的时候，Google会收你更少的钱。我还将最大实例数从默认的1000更改为4。如果你有一个非常受欢迎的网站，你应该相应地改变这个最大值，这样你的用户就可以从运行更多图片的性能优势中获益。但是请记住:收益会伴随着额外的成本。</p><figure class="ma mb mc md gt me gh gi paragraph-image"><div class="gh gi oz"><img src="../Images/84669fd2770e911044c272d4f0da98c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:988/format:webp/1*KY67KdbW5RIOFmcy2dnUdg.png"/></div><figcaption class="ml mm gj gh gi mn mo bd b be z dk">Auto scale for better performance</figcaption></figure><p id="5259" class="pw-post-body-paragraph ld le in lf b lg mq jx li lj mr ka ll lm ms lo lp lq mt ls lt lu mu lw lx ly ig bi translated">设置服务的第三步是您希望服务被触发的方式。我们正在发布一个网站，所以我们选择“允许未经验证的调用”。</p><figure class="ma mb mc md gt me gh gi paragraph-image"><div class="gh gi pa"><img src="../Images/8c8d6a8ec1de95ea02b9bda37730d59a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1168/format:webp/1*KMkHAaivTx-c8h9XuUWfhQ.png"/></div></figure><p id="7724" class="pw-post-body-paragraph ld le in lf b lg mq jx li lj mr ka ll lm ms lo lp lq mt ls lt lu mu lw lx ly ig bi translated">当您创建了您的服务后，您就差不多完成了！Google为您的应用创建了一个URL。您可以通过单击您的服务名称来检查这一点。在页面的顶部，它显示了网址。</p><p id="325e" class="pw-post-body-paragraph ld le in lf b lg mq jx li lj mr ka ll lm ms lo lp lq mt ls lt lu mu lw lx ly ig bi translated">现在服务已经启动并运行了，是时候将您的服务映射到您自己的域了。</p><h1 id="03c7" class="kl km in bd kn ko kp kq kr ks kt ku kv kc kw kd kx kf ky kg kz ki la kj lb lc bi translated">6.正确地将服务映射到您的域</h1><p id="8600" class="pw-post-body-paragraph ld le in lf b lg lh jx li lj lk ka ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated">转到您的Google云控制台，确保您已经打开了包含您的服务的Cloud Run项目。转到Cloud Run，您应该会看到您的服务正在运行。</p><figure class="ma mb mc md gt me gh gi paragraph-image"><div class="gh gi pb"><img src="../Images/906705a456b3f21d52e2b0a89aa12417.png" data-original-src="https://miro.medium.com/v2/resize:fit:1368/format:webp/1*gAuEMd-jaDisQEsTx62mUw.png"/></div><figcaption class="ml mm gj gh gi mn mo bd b be z dk">Cloud Run with your service</figcaption></figure><p id="809a" class="pw-post-body-paragraph ld le in lf b lg mq jx li lj mr ka ll lm ms lo lp lq mt ls lt lu mu lw lx ly ig bi translated">点击菜单顶部的“管理自定义域”。</p><figure class="ma mb mc md gt me gh gi paragraph-image"><div class="gh gi pc"><img src="../Images/f00b87bd505640b2bd8102a1c2fc452c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1178/format:webp/1*Qa3ortkoJSlsTmsVrb8Xqg.png"/></div><figcaption class="ml mm gj gh gi mn mo bd b be z dk">map cloud run service to your domain</figcaption></figure><p id="e41c" class="pw-post-body-paragraph ld le in lf b lg mq jx li lj mr ka ll lm ms lo lp lq mt ls lt lu mu lw lx ly ig bi translated">点击“添加映射”。</p><figure class="ma mb mc md gt me gh gi paragraph-image"><div class="gh gi pd"><img src="../Images/54f49cf7c1fda70da337c0626bcaf0ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1114/format:webp/1*HMNlFL4u-N4HR_u1BbLU7A.png"/></div><figcaption class="ml mm gj gh gi mn mo bd b be z dk">map the service to your domain</figcaption></figure><p id="0be9" class="pw-post-body-paragraph ld le in lf b lg mq jx li lj mr ka ll lm ms lo lp lq mt ls lt lu mu lw lx ly ig bi translated">选择您的服务并将其映射到您的域。按下继续按钮，谷歌云生成DNS记录。您应该复制这些记录并将其粘贴到您的域主机中。对我来说，我用谷歌域名托管我的域名。对你来说，这可能是另一个注册，像godaddy.com或hostgator.com。</p><p id="7aff" class="pw-post-body-paragraph ld le in lf b lg mq jx li lj mr ka ll lm ms lo lp lq mt ls lt lu mu lw lx ly ig bi translated">要检查映射是否顺利，使用“<em class="nl"> dig </em>命令，例如:</p><pre class="ma mb mc md gt of og oh oi aw oj bi"><span id="7734" class="ok km in og b gy ol om l on oo">dig yourdomain.com</span></pre><p id="019b" class="pw-post-body-paragraph ld le in lf b lg mq jx li lj mr ka ll lm ms lo lp lq mt ls lt lu mu lw lx ly ig bi translated">现在您应该做的是，将服务映射到您的“WWW”子域:再次添加映射，并在第三个字段中输入“www.yourdomain.com”，该字段显示“指定子域”。</p><p id="dd8e" class="pw-post-body-paragraph ld le in lf b lg mq jx li lj mr ka ll lm ms lo lp lq mt ls lt lu mu lw lx ly ig bi translated">这将生成一个CNAME记录，该记录将被复制到您的域名注册机构的DNS记录中；就像你对A级唱片和AAA级唱片做的那样。</p><h1 id="27c7" class="kl km in bd kn ko kp kq kr ks kt ku kv kc kw kd kx kf ky kg kz ki la kj lb lc bi translated">结论</h1><p id="5b9a" class="pw-post-body-paragraph ld le in lf b lg lh jx li lj lk ka ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated">您已经部署了一个运行轻量级图像的容器，该容器带有一个静态的Angular Universal应用程序。容器在云上运行，你的站点被正确的映射到这个服务器上！你不会有404错误。性能得到优化。有关云运行的更多优化，您可以查看朱舒·王的文章“<a class="ae mp" href="https://medium.com/google-cloud/3-ways-to-optimize-cloud-run-response-times-4504ed0e6804" rel="noopener"> 3种优化云运行响应时间</a>”。</p><p id="7c7f" class="pw-post-body-paragraph ld le in lf b lg mq jx li lj mr ka ll lm ms lo lp lq mt ls lt lu mu lw lx ly ig bi translated">我的Angular应用程序在bloggyboots.com的<a class="ae mp" href="http://www.bloggyboots.com" rel="noopener ugc nofollow" target="_blank"/>运行，在我的一个页面上有谷歌的灯塔报告。对于Angular应用程序来说，结果相当不错。</p><figure class="ma mb mc md gt me gh gi paragraph-image"><div role="button" tabindex="0" class="mf mg di mh bf mi"><div class="gh gi pe"><img src="../Images/897eeef6c0e598ef6d8d1659e7a86a23.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mkVSRhWTyrDeb9-9hdWkDQ.png"/></div></div><figcaption class="ml mm gj gh gi mn mo bd b be z dk">Google Lighthouse Report of Bloggyboots.com</figcaption></figure><p id="da6c" class="pw-post-body-paragraph ld le in lf b lg mq jx li lj mr ka ll lm ms lo lp lq mt ls lt lu mu lw lx ly ig bi translated">如果你有任何问题，请在评论中提出。部署并享受！</p></div></div>    
</body>
</html>