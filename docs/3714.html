<html>
<head>
<title>How to Deploy a React App with Express and NGINX</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用Express和NGINX部署React App</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/how-to-deploy-a-react-app-with-expressjs-and-nginx-29abeef08c67?source=collection_archive---------1-----------------------#2021-07-26">https://javascript.plainenglish.io/how-to-deploy-a-react-app-with-expressjs-and-nginx-29abeef08c67?source=collection_archive---------1-----------------------#2021-07-26</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="b7f2" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在这篇博客文章中，我将向您解释如何使用ExpressJS作为后端服务来部署React应用程序。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/04457f4efe85804ad98b1bfeb6260132.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*MEypoeujOyxCSzJJ"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Photo by <a class="ae ky" href="https://unsplash.com/@synkevych?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Roman Synkevych</a> on <a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="aa33" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">Express将使用<code class="fe kz la lb lc b">express.static</code>中间件为React应用提供服务。我们将首先在根路径上部署服务，然后在子路径上部署，我们将在服务器端和客户端完成所有需要的更改。让我们开始吧。</p><p id="87f3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">感觉懒？你可以跟着Youtube上的教程走:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ld le l"/></div></figure><p id="12b3" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">repo:<a class="ae ky" href="https://github.com/enricop89/react-app-expressjs-nginx/tree/express-js-react-app" rel="noopener ugc nofollow" target="_blank">https://github . com/enrico 89/react-app-express js-nginx/tree/express-js-react-app</a></p><h1 id="0d3d" class="lf lg in bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">项目概述</h1><p id="27af" class="pw-post-body-paragraph jk jl in jm b jn md jp jq jr me jt ju jv mf jx jy jz mg kb kc kd mh kf kg kh ig bi translated">首先，让我们使用create-react-app样板文件创建一个React应用程序示例。命令<code class="fe kz la lb lc b">npx create-react-app my-app-nginx</code>将为此创建一个基本应用程序。</p><p id="11c7" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果你想看到应用程序运行，运行<code class="fe kz la lb lc b">npm start</code>。该应用程序将显示Create React应用程序样板的默认视图。</p><p id="8c86" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">下一步是安装<code class="fe kz la lb lc b">react-router-dom</code>，这样我们就可以在React应用上添加路线。我们将复制基本应用程序来展示路线是如何工作的:</p><pre class="kj kk kl km gt mi lc mj mk aw ml bi"><span id="72a2" class="mm lg in lc b gy mn mo l mp mq">import React from "react";<br/>import {<br/>  BrowserRouter as Router,<br/>  Switch,<br/>  Route,<br/>  Link<br/>} from "react-router-dom";</span><span id="367b" class="mm lg in lc b gy mr mo l mp mq">export default function App() {<br/>  return (<br/>    &lt;Router&gt;<br/>      &lt;div&gt;<br/>        &lt;nav&gt;<br/>          &lt;ul&gt;<br/>            &lt;li&gt;<br/>              &lt;Link to="/"&gt;Home&lt;/Link&gt;<br/>            &lt;/li&gt;<br/>            &lt;li&gt;<br/>              &lt;Link to="/about"&gt;About&lt;/Link&gt;<br/>            &lt;/li&gt;<br/>            &lt;li&gt;<br/>              &lt;Link to="/users"&gt;Users&lt;/Link&gt;<br/>            &lt;/li&gt;<br/>          &lt;/ul&gt;<br/>        &lt;/nav&gt;</span><span id="88e1" class="mm lg in lc b gy mr mo l mp mq">        {/* A &lt;Switch&gt; looks through its children &lt;Route&gt;s and<br/>            renders the first one that matches the current URL. */}<br/>        &lt;Switch&gt;<br/>          &lt;Route path="/about"&gt;<br/>            &lt;About /&gt;<br/>          &lt;/Route&gt;<br/>          &lt;Route path="/users"&gt;<br/>            &lt;Users /&gt;<br/>          &lt;/Route&gt;<br/>          &lt;Route path="/"&gt;<br/>            &lt;Home /&gt;<br/>          &lt;/Route&gt;<br/>        &lt;/Switch&gt;<br/>      &lt;/div&gt;<br/>    &lt;/Router&gt;<br/>  );<br/>}</span><span id="d522" class="mm lg in lc b gy mr mo l mp mq">function Home() {<br/>  return &lt;h2&gt;Home&lt;/h2&gt;;<br/>}</span><span id="a154" class="mm lg in lc b gy mr mo l mp mq">function About() {<br/>  return &lt;h2&gt;About&lt;/h2&gt;;<br/>}</span><span id="c9b8" class="mm lg in lc b gy mr mo l mp mq">function Users() {<br/>  return &lt;h2&gt;Users&lt;/h2&gt;;<br/>}</span></pre><p id="83f5" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">此时，我们可以导航到<code class="fe kz la lb lc b">/users</code>、<code class="fe kz la lb lc b">/about</code>和<code class="fe kz la lb lc b">/</code>回家路径。客户端的最后一步是运行<code class="fe kz la lb lc b">npm run build</code>，这样我们的静态应用程序就可以由ExpressJS提供服务了。</p><h2 id="b051" class="mm lg in bd lh ms mt dn ll mu mv dp lp jv mw mx lt jz my mz lx kd na nb mb nc bi translated">服务器端</h2><p id="419e" class="pw-post-body-paragraph jk jl in jm b jn md jp jq jr me jt ju jv mf jx jy jz mg kb kc kd mh kf kg kh ig bi translated">基本的服务器端实现如下:</p><pre class="kj kk kl km gt mi lc mj mk aw ml bi"><span id="3a17" class="mm lg in lc b gy mn mo l mp mq">const path = require('path');<br/>const cors = require('cors');<br/>const express = require('express');<br/>const app = express(); // create express app<br/>app.use(cors());<br/><br/>const bodyParser = require('body-parser');<br/>app.use(bodyParser.json());<br/><br/>// add middlewares<br/>const root = require('path').join(__dirname, 'build');<br/>app.use(express.static(root));<br/><br/>app.use('/*', (req, res) =&gt; {<br/>  res.sendFile(path.join(__dirname, 'build', 'index.html'));<br/>});<br/><br/>// start express server on port 5000<br/>app.listen(process.env.PORT || 5000, () =&gt; {<br/>  console.log('server started');<br/>});</span></pre><p id="8e24" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">需要注意的重要部分是:</p><ul class=""><li id="c6bd" class="nd ne in jm b jn jo jr js jv nf jz ng kd nh kh ni nj nk nl bi translated"><code class="fe kz la lb lc b">express.static(path.join(__dirname, 'build))</code>:我们告诉ExpressJS在<code class="fe kz la lb lc b">build</code>文件夹中查找静态文件。</li><li id="c2a7" class="nd ne in jm b jn nm jr nn jv no jz np kd nq kh ni nj nk nl bi translated">因为我们使用的是<code class="fe kz la lb lc b">react-router-dom</code>，所以我们需要配置ExpressJS来服务<code class="fe kz la lb lc b">index.html</code>，即使客户端正在请求子路径，比如<code class="fe kz la lb lc b">/home</code>或<code class="fe kz la lb lc b">/about</code>。这是因为当有一个新的页面加载给一个<code class="fe kz la lb lc b">/home</code>时，服务器会寻找文件<code class="fe kz la lb lc b">build/home</code>但没有找到。服务器需要配置为通过服务<code class="fe kz la lb lc b">index.html</code>来响应对<code class="fe kz la lb lc b">/home</code>的请求。解决方案是配置我们上面的Express服务器为任何未知路径提供<code class="fe kz la lb lc b">index.html</code>:</li></ul><pre class="kj kk kl km gt mi lc mj mk aw ml bi"><span id="7dfd" class="mm lg in lc b gy mn mo l mp mq">app.use('/*', (req, res) =&gt; {<br/>  res.sendFile(path.join(__dirname, 'build', 'index.html'));<br/>});</span></pre><h1 id="252e" class="lf lg in bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">在子路径上部署？</h1><p id="672f" class="pw-post-body-paragraph jk jl in jm b jn md jp jq jr me jt ju jv mf jx jy jz mg kb kc kd mh kf kg kh ig bi translated">没问题，🧘‍♀️</p><p id="eb6a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果您想在一个子路径上部署React应用程序，例如<code class="fe kz la lb lc b">mywebsite.com/app</code>，那么在服务器端和客户端都需要进行修改。在客户端，我会按照这个指南:<a class="ae ky" href="https://create-react-app.dev/docs/deployment/#building-for-relative-paths" rel="noopener ugc nofollow" target="_blank">https://create-react-app . dev/docs/deployment/# building-for-relative-paths</a>。</p><p id="fb6a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">客户端的变化有三个:</p><ol class=""><li id="2975" class="nd ne in jm b jn jo jr js jv nf jz ng kd nh kh nr nj nk nl bi translated">在package.json上添加<code class="fe kz la lb lc b">homepage</code>: Create React App生成一个构建，假设您的应用程序托管在服务器根。如果你不想指定一个子路径，你可以设置<code class="fe kz la lb lc b">homepage:"."</code>，这样所有的资产路径都是相对于<code class="fe kz la lb lc b">index.html</code>的</li><li id="5347" class="nd ne in jm b jn nm jr nn jv no jz np kd nq kh nr nj nk nl bi translated">更改<code class="fe kz la lb lc b">react-router-dom</code>的<code class="fe kz la lb lc b">basename</code>:base name是所有位置的基本URL。例如:</li></ol><pre class="kj kk kl km gt mi lc mj mk aw ml bi"><span id="6097" class="mm lg in lc b gy mn mo l mp mq">export default function App() {  <br/>  const basename = process.env.REACT_APP_BASENAME || null;  <br/>  return (<br/>   &lt;Router basename={basename}&gt; <br/>    .... <br/>   &lt;/Router&gt;<br/>}</span></pre><p id="b81a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">3.运行<code class="fe kz la lb lc b">npm run build</code>脚本时更改<code class="fe kz la lb lc b">PUBLIC_URL</code>。如果将文件放入公共文件夹，webpack将不会处理该文件。相反，<strong class="jm io">它将原封不动地复制到构建文件夹中</strong>。要引用public文件夹中的资产，您需要使用一个名为PUBLIC_URL的环境变量。因此，如果您在子文件夹中部署React应用程序，您必须设置PUBLIC_URL来反映特定的子文件夹。这样，<code class="fe kz la lb lc b">index.html</code>会以PUBLIC_URL路径为前缀向服务器请求文件。例:<a class="ae ky" href="https://github.com/enricop89/react-app-expressjs-nginx/blob/docker-express-js-react/.env.example" rel="noopener ugc nofollow" target="_blank">https://github . com/enrico 89/react-app-express js-nginx/blob/docker-express-js-react/. env . example</a></p><p id="ff40" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">一旦您完成了更改，记得再次运行<code class="fe kz la lb lc b">npm run build</code>以便更新包。</p><p id="8708" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">现在我们必须转移到服务器端，更改NGINX配置。我们需要将位置块更改为:</p><pre class="kj kk kl km gt mi lc mj mk aw ml bi"><span id="0254" class="mm lg in lc b gy mn mo l mp mq">server{<br/>  location /app/ {        <br/>    proxy_set_header Upgrade $http_upgrade;        <br/>    proxy_set_header Connection 'upgrade';<br/>    proxy_set_header Host $host;<br/>    proxy_set_header X-Real-IP $remote_addr;<br/>    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;<br/>    proxy_set_header X-Forwarded-Proto $scheme;        <br/>    proxy_pass   http://localhost:5000/;  <br/>  }<br/>}</span></pre><p id="a89f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果您愿意，您可以按照视频中的过程进行操作:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ld le l"/></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Deploy to Subpath</figcaption></figure><h1 id="e5ea" class="lf lg in bd lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc bi translated">结论</h1><p id="0859" class="pw-post-body-paragraph jk jl in jm b jn md jp jq jr me jt ju jv mf jx jy jz mg kb kc kd mh kf kg kh ig bi translated">在这篇博文中，我们看到了如何使用ExpressJS来托管一个静态的React应用程序。</p><p id="19eb" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">请在评论中告诉我你的想法。在推特<a class="ae ky" href="https://twitter.com/enricop89" rel="noopener ugc nofollow" target="_blank">和Youtube </a>上关注我，了解更多信息！</p></div><div class="ab cl ns nt hr nu" role="separator"><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx"/></div><div class="ig ih ii ij ik"><h2 id="967d" class="mm lg in bd lh ms mt dn ll mu mv dp lp jv mw mx lt jz my mz lx kd na nb mb nc bi translated">延伸阅读:</h2><div class="nz oa gp gr ob oc"><a href="https://bit.cloud/blog/deploying-a-composable-react-app-to-netlify-l7rlluzs" rel="noopener  ugc nofollow" target="_blank"><div class="od ab fo"><div class="oe ab of cl cj og"><h2 class="bd io gy z fp oh fr fs oi fu fw im bi translated">将可组合的React应用程序部署到Netlify</h2><div class="oj l"><h3 class="bd b gy z fp oh fr fs oi fu fw dk translated">在这篇博文中，我们将学习如何使用Bit来构建和部署一个可组合的React应用程序到Netlify。在位…</h3></div><div class="ok l"><p class="bd b dl z fp oh fr fs oi fu fw dk translated">比特云</p></div></div><div class="ol l"><div class="om l on oo op ol oq ks oc"/></div></div></a></div></div><div class="ab cl ns nt hr nu" role="separator"><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx"/></div><div class="ig ih ii ij ik"><p id="9880" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><em class="or">更多内容请看</em><a class="ae ky" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><strong class="jm io"><em class="or">plain English . io</em></strong></a><em class="or">。报名参加我们的</em> <a class="ae ky" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="jm io"> <em class="or">免费周报</em> </strong> </a> <em class="or">。关注我们关于</em><a class="ae ky" href="https://twitter.com/inPlainEngHQ" rel="noopener ugc nofollow" target="_blank"><strong class="jm io"><em class="or">Twitter</em></strong></a><a class="ae ky" href="https://www.linkedin.com/company/inplainenglish/" rel="noopener ugc nofollow" target="_blank"><strong class="jm io"><em class="or">LinkedIn</em></strong></a><em class="or"/><a class="ae ky" href="https://www.youtube.com/channel/UCtipWUghju290NWcn8jhyAw" rel="noopener ugc nofollow" target="_blank"><strong class="jm io"><em class="or">YouTube</em></strong></a><em class="or"/><a class="ae ky" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"><strong class="jm io"><em class="or">不和</em> </strong> </a> <em class="or">。对增长黑客感兴趣？检查</em> <a class="ae ky" href="https://circuit.ooo/" rel="noopener ugc nofollow" target="_blank"> <strong class="jm io"> <em class="or">电路</em> </strong> </a> <em class="or">。</em></p></div></div>    
</body>
</html>