<html>
<head>
<title>Why We Use Layered HTML Canvases At OpenScope</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为什么我们在OpenScope使用分层的HTML画布</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/why-we-use-layered-html-canvases-at-openscope-e10273974447?source=collection_archive---------13-----------------------#2021-11-22">https://javascript.plainenglish.io/why-we-use-layered-html-canvases-at-openscope-e10273974447?source=collection_archive---------13-----------------------#2021-11-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/5148a1edc4e3fe93177f78d2cd407d69.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dfcbfU7ViLNq7vk8G2vrlg.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">OpenScope Air Traffic Control Simulator</figcaption></figure><p id="1938" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">几年来，我一直是一个名为<a class="ae la" href="https://www.openscope.co/" rel="noopener ugc nofollow" target="_blank"> OpenScope </a>项目的积极维护者。OpenScope是一个基于浏览器的空中交通管制模拟器，由JavaScript、HTML canvas和JSON驱动。没有后端，全部在浏览器里完成。它也是开源的，任何人都可以<a class="ae la" href="https://github.com/openscope/openscope/blob/develop/CONTRIBUTING.md" rel="noopener ugc nofollow" target="_blank">为</a>做贡献，只要你遵循指南并且会说航空语。</p><h1 id="81cc" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">问题</h1><p id="086d" class="pw-post-body-paragraph kc kd iq ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated">当我第一次开始为这个项目做贡献的时候，在性能方面有一些问题。</p></div><div class="ab cl me mf hu mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="ij ik il im in"><p id="d629" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">在我继续之前，让我们先了解一些基础知识。</p><p id="cef3" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><strong class="ke ir">Canvas:</strong><a class="ae la" href="https://developer.mozilla.org/en-US/docs/Web/API/Canvas_API" rel="noopener ugc nofollow" target="_blank">Canvas API</a>提供了一种使用javascript和HTML <code class="fe ml mm mn mo b">canvas</code>元素绘制图形的方法。</p><p id="d810" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">制作动画:用动画技术给(电影、人物或图画)以运动的<em class="mp">外观</em>。</p><p id="6fb4" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">用代码制作动画就像画一本翻页书。</p><figure class="mq mr ms mt gt jr"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="23de" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">为了让事物看起来会移动，必须重画它们，只做微小的改变。这些微小变化的集合，随着时间的推移，形成了运动的<em class="mp">外观</em>。</p><p id="ac4e" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">这是相同的概念，只是用代码而不是笔和纸来完成。</p><p id="4d9c" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">这里需要注意的另一件事是，对于代码，在每一帧(页面)之间，我们必须做数学计算来精确地计算下一个绘图应该去哪里。</p><h2 id="3cec" class="mw lc iq bd ld mx my dn lh mz na dp ll kn nb nc lp kr nd ne lt kv nf ng lx nh bi translated"><strong class="ak">游戏循环:</strong></h2><blockquote class="ni"><p id="298c" class="nj nk iq bd nl nm nn no np nq nr kz dk translated"><strong class="ak">游戏循环</strong>是整个游戏程序的整体流程控制。这是一个循环，因为游戏不断重复做一系列动作，直到用户退出。游戏循环的每次迭代被称为一个<strong class="ak">帧</strong>。大多数实时游戏每秒更新几次:30和60是两个最常见的间隔。如果一个游戏以60 FPS ( <strong class="ak">帧每秒</strong>)运行，这意味着游戏循环每秒完成60次迭代。</p></blockquote><p id="35d1" class="pw-post-body-paragraph kc kd iq ke b kf ns kh ki kj nt kl km kn nu kp kq kr nv kt ku kv nw kx ky kz ij bi translated"><em class="mp"> —来源:</em><a class="ae la" href="https://www.informit.com/articles/article.aspx?p=2167437&amp;seqNum=2" rel="noopener ugc nofollow" target="_blank"><em class="mp">https://www.informit.com/articles/article.aspx?p=2167437&amp;seqNum = 2</em></a></p><h1 id="b6cd" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">OpenScope UI简介</h1><p id="1ce6" class="pw-post-body-paragraph kc kd iq ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated">运行任何种类的模拟器都需要动画。为了用代码制作动画，你需要有一个<a class="ae la" href="http://isaacsukin.com/news/2015/01/detailed-explanation-javascript-game-loops-and-timing" rel="noopener ugc nofollow" target="_blank"> <strong class="ke ir">游戏循环</strong> </a> <strong class="ke ir">。</strong>为了在使用javascript的浏览器上以一种高性能的方式做到这一点，你需要使用<code class="fe ml mm mn mo b"><a class="ae la" href="https://developer.mozilla.org/en-US/docs/Web/API/window/requestAnimationFrame" rel="noopener ugc nofollow" target="_blank">requestAnimationFrame</a></code>。</p><p id="8c74" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我们在HTML画布上画了很多东西:导航设备、地形、移动的飞机、文本、飞机路线、sid、星星、跑道等等。</p><figure class="mq mr ms mt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi nx"><img src="../Images/b3b1d614dcc89f6fff8cd81276f54924.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2UiCn6TKhY7OVYB0Hmkxyg.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">OpenScope view with all the visualizations on: Navaids, Runways, Airport, SIDs, STARs, and a selected aircraft route</figcaption></figure><p id="e900" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">如您所见，这里发生了很多事情。底部的菜单栏和右边的弹出按钮都是HTML元素，不是画布或动画循环的一部分。</p><h1 id="4cd3" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">性能问题</h1><p id="83f0" class="pw-post-body-paragraph kc kd iq ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated">我们不断收到动画不稳定的报告，或者电脑风扇在播放一会儿后发出比正常情况下更大的呼呼声。所以我们决定调查一下。</p><p id="d8da" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">没过多久，我们就发现我们在帧之间做了太多事情，并且“<em class="mp">丢帧”</em>。丢帧意味着从一帧到下一帧的计算，意味着我们没有足够的时间按时渲染下一帧。想象一下，从上面的活页本中随意抽出几页，这是一个掉页框。</p><p id="5075" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">一次浏览Chrome上的<code class="fe ml mm mn mo b">performance</code>标签，很明显我们丢失了大量的帧。</p><p id="2722" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">简单的原因是我们在帧之间做了太多。看着上面的图片，我相信你能明白为什么。该视图中的所有内容都需要在每帧之间重新绘制。</p></div><div class="ab cl me mf hu mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="ij ik il im in"><p id="240b" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">到目前为止，在我的职业生涯中，我只接触过两次canvas api。我以前从来没有机会深入研究画布问题，所以我很期待这次挑战。</p><p id="69f0" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">经过一些研究，我发现了两件事:</p><ul class=""><li id="b46e" class="ny nz iq ke b kf kg kj kk kn oa kr ob kv oc kz od oe of og bi translated"><code class="fe ml mm mn mo b">canvas</code>元素是一个HTML元素(duh ),可以通过CSS接收样式。像<code class="fe ml mm mn mo b">background-color</code>之类的东西。这在现在看来是显而易见的，但在当时却是一个小小的启示。</li><li id="7f77" class="ny nz iq ke b kf oh kj oi kn oj kr ok kv ol kz od oe of og bi translated"><code class="fe ml mm mn mo b">canvas</code>元素<em class="mp">可以</em>有透明背景。</li></ul><h1 id="e183" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">堆叠画布</h1><p id="1144" class="pw-post-body-paragraph kc kd iq ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated">对于这个下一个领悟，我不知道是在一篇文章里看到的，还是自己想出来的。我通常没这么聪明，所以假设我在某处读到过。</p><p id="449a" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">如果我们能够识别出那些经常改变的元素和那些不经常改变的元素，我们就可以更好地将它们分开，只在需要的时候重画。此外，如果我们可以做出这样的决定，我们可以在他们自己的HTML画布上绘制每个人。</p><p id="1b04" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我们可以堆叠HTML画布！</p><figure class="mq mr ms mt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi om"><img src="../Images/a17ecef2debc95a1da162a28c1496638.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*876yWGk1JlzpYqJ2uEltSA.png"/></div></div></figure><p id="b9cb" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">借用React <code class="fe ml mm mn mo b">shallowRender</code>和<code class="fe ml mm mn mo b">deepRender</code>中的两个术语来描述每个画布将做什么，我们开始对它进行编码。</p><p id="62c6" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">我们把可渲染的东西分成两组:</p><ul class=""><li id="39ce" class="ny nz iq ke b kf kg kj kk kn oa kr ob kv oc kz od oe of og bi translated">需要改变每一帧的东西</li><li id="f40a" class="ny nz iq ke b kf oh kj oi kn oj kr ok kv ol kz od oe of og bi translated">当视图改变时需要改变的东西(平移/缩放)。飞机路径、地形、导航设备、SIDS/STARS、空域等。</li></ul><p id="9fa0" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">这些昂贵的物品都属于<code class="fe ml mm mn mo b">deepRender</code>集团，这并不奇怪。只有在需要的时候才更新它们，这是一个巨大的突破，并真正在性能上产生了巨大的差异。</p><p id="77a5" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">你可以看到我们如何管理对多个HTML画布的绘制<a class="ae la" href="https://github.com/openscope/openscope/blob/develop/src/assets/scripts/client/canvas/CanvasController.js#L402" rel="noopener ugc nofollow" target="_blank">这里</a>在<a class="ae la" href="https://github.com/openscope/openscope/blob/develop/src/assets/scripts/client/canvas/CanvasController.js#L402" rel="noopener ugc nofollow" target="_blank"> CanvasController </a>中。</p><figure class="mq mr ms mt gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi on"><img src="../Images/0c07cbe0655483e0e608385805d054c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*iFGcJaKAlIDmCbwT"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae la" href="https://unsplash.com/@honeypoppet?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Sandie Clarke</a> on <a class="ae la" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="5496" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">结论</h1><p id="471f" class="pw-post-body-paragraph kc kd iq ke b kf lz kh ki kj ma kl km kn mb kp kq kr mc kt ku kv md kx ky kz ij bi translated">这个故事的寓意是:</p><ul class=""><li id="e79c" class="ny nz iq ke b kf kg kj kk kn oa kr ob kv oc kz od oe of og bi translated">HTML <code class="fe ml mm mn mo b">canvas</code>元素可以有一个透明的背景，并且可以相互堆叠</li><li id="4f98" class="ny nz iq ke b kf oh kj oi kn oj kr ok kv ol kz od oe of og bi translated">仅在需要时重新绘制昂贵的项目</li></ul><p id="66f0" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated">请在<a class="ae la" href="http://openscope.co" rel="noopener ugc nofollow" target="_blank"> OpenScope </a>查看这段代码，或者访问我们的<a class="ae la" href="https://github.com/openscope/openscope" rel="noopener ugc nofollow" target="_blank"> repo </a>。</p></div><div class="ab cl me mf hu mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="ij ik il im in"><h2 id="f4d3" class="mw lc iq bd ld mx my dn lh mz na dp ll kn nb nc lp kr nd ne lt kv nf ng lx nh bi translated">参考</h2><ul class=""><li id="1db2" class="ny nz iq ke b kf lz kj ma kn oo kr op kv oq kz od oe of og bi translated"><a class="ae la" href="https://www.openscope.co/" rel="noopener ugc nofollow" target="_blank">https://www.openscope.co/</a></li><li id="7c23" class="ny nz iq ke b kf oh kj oi kn oj kr ok kv ol kz od oe of og bi translated"><a class="ae la" href="https://github.com/openscope/openscope/blob/develop/CONTRIBUTING.md" rel="noopener ugc nofollow" target="_blank">https://github . com/open scope/open scope/blob/develop/contributing . MD</a></li><li id="7e9c" class="ny nz iq ke b kf oh kj oi kn oj kr ok kv ol kz od oe of og bi translated"><a class="ae la" href="https://developer.mozilla.org/en-US/docs/Web/API/Canvas_API" rel="noopener ugc nofollow" target="_blank">https://developer.mozilla.org/en-US/docs/Web/API/Canvas_API</a></li><li id="af18" class="ny nz iq ke b kf oh kj oi kn oj kr ok kv ol kz od oe of og bi translated">https://www.informit.com/articles/article.aspx?p=2167437&amp;seqNum = 2</li><li id="1dd9" class="ny nz iq ke b kf oh kj oi kn oj kr ok kv ol kz od oe of og bi translated"><a class="ae la" href="http://isaacsukin.com/news/2015/01/detailed-explanation-javascript-game-loops-and-timing" rel="noopener ugc nofollow" target="_blank">http://isaacsukin . com/news/2015/01/detailed-explain-JavaScript-game-loops-and-timing</a></li><li id="a400" class="ny nz iq ke b kf oh kj oi kn oj kr ok kv ol kz od oe of og bi translated"><a class="ae la" href="https://developer.mozilla.org/en-US/docs/Web/API/window/requestAnimationFrame" rel="noopener ugc nofollow" target="_blank">https://developer . Mozilla . org/en-US/docs/Web/API/window/request animation frame</a></li><li id="77b2" class="ny nz iq ke b kf oh kj oi kn oj kr ok kv ol kz od oe of og bi translated"><a class="ae la" href="https://github.com/openscope/openscope" rel="noopener ugc nofollow" target="_blank">https://github.com/openscope/openscope</a></li><li id="9ef7" class="ny nz iq ke b kf oh kj oi kn oj kr ok kv ol kz od oe of og bi translated"><a class="ae la" href="https://github.com/openscope/openscope/blob/develop/src/assets/scripts/client/canvas/CanvasController.js#L402" rel="noopener ugc nofollow" target="_blank">https://github . com/open scope/open scope/blob/develop/src/assets/scripts/client/canvas controller . js # L402</a></li></ul><p id="d292" class="pw-post-body-paragraph kc kd iq ke b kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz ij bi translated"><em class="mp">更多内容看</em> <a class="ae la" href="http://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <em class="mp">说白了。报名参加我们的</em> </a><a class="ae la" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <em class="mp">免费每周简讯</em> </a> <em class="mp">。在我们的</em> <a class="ae la" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"> <em class="mp">社区</em> </a> <em class="mp">获得独家写作机会和建议。</em></p></div></div>    
</body>
</html>