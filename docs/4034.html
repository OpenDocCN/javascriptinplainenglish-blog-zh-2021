<html>
<head>
<title>Tag Manager Services and Website Security: Using GTM with CSP</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">标签管理器服务和网站安全:使用GTM和CSP</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/tag-manager-services-and-website-security-using-gtm-with-csp-5749a610c600?source=collection_archive---------6-----------------------#2021-08-12">https://javascript.plainenglish.io/tag-manager-services-and-website-security-using-gtm-with-csp-5749a610c600?source=collection_archive---------6-----------------------#2021-08-12</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/0c899551c5a53e11259d84bc11fda6ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l18rV9HWeA79HyGhxSbsXw.jpeg"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Photo by <a class="ae jz" href="https://unsplash.com/@jaqbovsky?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Michał Jakubowski</a> on <a class="ae jz" href="https://unsplash.com/s/photos/security?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="e186" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">如果你想让你的网站免受<a class="ae jz" href="https://owasp.org/www-community/attacks/xss/" rel="noopener ugc nofollow" target="_blank">跨站脚本</a> (XSS)的攻击，一个主要的防御来源是<a class="ae jz" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP" rel="noopener ugc nofollow" target="_blank">内容安全政策</a>标题。然而，如果你使用标签管理器服务(TMS)，比如<a class="ae jz" href="https://support.google.com/tagmanager/answer/6102821?hl=en" rel="noopener ugc nofollow" target="_blank">谷歌标签管理器</a> (GTM)，你可能会遇到一些实现上的挑战。本文探讨了这些挑战，并提供了经过充分测试的解决方案。</p><h2 id="405b" class="ky kz in bd la lb lc dn ld le lf dp lg kl lh li lj kp lk ll lm kt ln lo lp lq bi translated">什么是GTM？</h2><p id="91be" class="pw-post-body-paragraph ka kb in kc b kd lr kf kg kh ls kj kk kl lt kn ko kp lu kr ks kt lv kv kw kx ig bi translated">Google Tag Manager是一个工具，它允许人们管理给定网站上的第三方脚本，而无需更改应用程序本身的代码。营销人员通常使用它来添加跟踪和广告脚本，并且可以由专业个人或组织来管理。</p><h2 id="a9f2" class="ky kz in bd la lb lc dn ld le lf dp lg kl lh li lj kp lk ll lm kt ln lo lp lq bi translated">CSP是什么？</h2><p id="e4ec" class="pw-post-body-paragraph ka kb in kc b kd lr kf kg kh ls kj kk kl lt kn ko kp lu kr ks kt lv kv kw kx ig bi translated"><a class="ae jz" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP" rel="noopener ugc nofollow" target="_blank">内容安全策略</a>是一个HTTP头，允许开发者将网站资源列入白名单，这样只有被批准的资源才能在给定的范围内加载和运行。它是对抗XSS的一个非常强大的工具，因为它可以通过允许您特别列入白名单的资源运行来防止潜在的恶意代码在您的站点上执行。<a class="ae jz" href="https://content-security-policy.com/examples/" rel="noopener ugc nofollow" target="_blank">参见这里的一些实现示例</a>。</p><p id="74d2" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">如果你的网站有一个有效的CSP，它将防止两个关键漏洞被利用:<em class="lw">不安全内联</em>和<em class="lw">不安全评估</em>。它们是这样工作的:</p><p id="b719" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io"> 1。不安全评估。</strong>默认情况下，CSP会阻止使用JavaScript的<em class="lw"> eval </em>方法，该方法可以执行字符串中的代码——这是一种常见的攻击方法。通过添加<em class="lw"> unsafe-eval </em>关键字<em class="lw">到y </em>我们的策略，它将允许eval的使用。</p><p id="45e3" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io"> 2。不安全-内嵌。</strong>同样默认情况下，CSP将阻止任何内联脚本的执行，除非这些脚本通过<em class="lw"> nonce </em>或<em class="lw"> hash </em>值被允许(见下文)。通过将<em class="lw"> unsafe-inline </em>关键字添加到您的策略中，它将允许任何内联脚本运行，不管它是如何添加的。</p><h1 id="8862" class="lx kz in bd la ly lz ma ld mb mc md lg me mf mg lj mh mi mj lm mk ml mm lp mn bi translated">GTM和标签管理服务的问题</h1><p id="5f29" class="pw-post-body-paragraph ka kb in kc b kd lr kf kg kh ls kj kk kl lt kn ko kp lu kr ks kt lv kv kw kx ig bi translated">通过将TMS添加到您的站点，您可能会创建一个后门，允许人们在没有通过质量检查的情况下将代码添加到您的站点，而质量检查可能是您的应用程序生命周期过程的一部分。这可能会产生一系列问题，从覆盖全局变量到站点性能下降和安全漏洞。</p><p id="69aa" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">关于<em class="lw">谁</em>应该拥有标签实现的争论已经超出了本文的范围，所以让我们假设所有的利益相关者都同意使用GTM，并且你有一个很好的变更管理流程，通过它添加的每个第三方脚本在上线之前都经过了评估。</p><h2 id="0974" class="ky kz in bd la lb lc dn ld le lf dp lg kl lh li lj kp lk ll lm kt ln lo lp lq bi translated">GTM和CSP的问题</h2><p id="a9d9" class="pw-post-body-paragraph ka kb in kc b kd lr kf kg kh ls kj kk kl lt kn ko kp lu kr ks kt lv kv kw kx ig bi translated">GTM本质上是在网站中编写新的脚本。一位评论员将GTM描述为“XSS即服务”，这既有趣又令人不安。与10年前相比，在我们生活的世界中，由于客户端脚本的数量，攻击面通常很大。这意味着我们的CSP需要尽可能强大。</p><p id="f2d6" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">允许任何内联脚本被动态注入到您的站点或者允许使用<code class="fe mo mp mq mr b">eval</code>的内容安全策略是非常脆弱的。</p><h1 id="4e52" class="lx kz in bd la ly lz ma ld mb mc md lg me mf mg lj mh mi mj lm mk ml mm lp mn bi translated">解决方案</h1><p id="78f7" class="pw-post-body-paragraph ka kb in kc b kd lr kf kg kh ls kj kk kl lt kn ko kp lu kr ks kt lv kv kw kx ig bi translated">为了配置一个有意义的CSP，使其不会阻塞GTM动态添加的资源，您需要执行以下操作:</p><h2 id="7fd9" class="ky kz in bd la lb lc dn ld le lf dp lg kl lh li lj kp lk ll lm kt ln lo lp lq bi translated">不安全评估</h2><p id="f3c9" class="pw-post-body-paragraph ka kb in kc b kd lr kf kg kh ls kj kk kl lt kn ko kp lu kr ks kt lv kv kw kx ig bi translated">解决方案的第一部分集中在<code class="fe mo mp mq mr b">eval</code>的使用上。GTM中的定制脚本经常在运行时使用<code class="fe mo mp mq mr b">eval</code>来评估字符串，所以你的CSP需要通过<code class="fe mo mp mq mr b">unsafe-eval</code>来允许这一点，如前所述这会削弱你的策略，所以我们需要一种方法来避免这种情况。幸运的是，GTM发布了<em class="lw">定制模板</em>，它允许您构建定制脚本，同时避免运行时字符串求值。这是通过让GTM在编译时而不是运行时构建模板来实现的。</p><figure class="mt mu mv mw gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi ms"><img src="../Images/971405436e0fed4da82fe79ae8e048b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*M95zF2BUvXA4drtQb-uPzg.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">GTM Custom Templates</figcaption></figure><figure class="mt mu mv mw gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mx"><img src="../Images/0fd5ed9e47ac272844539f9d1df24188.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*imFhbqBl5uQzH9UtvXla_g.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">The GTM Custom Template Editor allows you to create and test a template prior to release</figcaption></figure><p id="391e" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">请记住，自定义模板使用的JavaScript沙盒版本<a class="ae jz" href="https://protect-eu.mimecast.com/s/z0zpC7ppxuAQ6xnT8Id_d" rel="noopener ugc nofollow" target="_blank">仅限于某些API</a>，可以在这里找到<a class="ae jz" href="https://protect-eu.mimecast.com/s/cZXdC8MMyu6zMZBC1aokC" rel="noopener ugc nofollow" target="_blank"/>。其中一些API使用document对象，这意味着一些定制JavaScript变量的功能不能使用定制模板来复制。</p><p id="521c" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">自定义模板中应用了许多抑制，以避免破坏自定义模板使用的沙盒环境。也就是说，越来越多的API正在这个沙盒环境中逐渐变得可用。</p><figure class="mt mu mv mw gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi my"><img src="../Images/38328b8138d249737d46e3ec6ee58e72.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*e425xweLGt92mPUuim71aA.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">There are a whole host of templates available in the community gallery, covering an ever increasing range of tools, technologies and platforms.</figcaption></figure><h2 id="d58f" class="ky kz in bd la lb lc dn ld le lf dp lg kl lh li lj kp lk ll lm kt ln lo lp lq bi translated">不安全-内嵌</h2><p id="a4e7" class="pw-post-body-paragraph ka kb in kc b kd lr kf kg kh ls kj kk kl lt kn ko kp lu kr ks kt lv kv kw kx ig bi translated">我前面提到过，可以使用一个<em class="lw"> nonce </em>或<em class="lw"> hash </em>值将内联脚本列入白名单。哈希值更容易实现，但更难维护——如果内联脚本发生任何变化，哈希值将无效，您必须生成一个新的哈希值。由于nonce更加灵活，并且可以传递给动态添加的脚本，我将重点关注该解决方案，然而，这里有一个关于哈希实现的简短的<a class="ae jz" href="https://content-security-policy.com/hash/" rel="noopener ugc nofollow" target="_blank">指南</a>。</p><p id="376e" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">Nonce表示一个使用过一次的数字。如果您以前没有实现这一点，那么您需要配置您的服务器，以便在每次页面加载时生成一个唯一的字符串。有很多关于如何做到这一点的资料，但这里有一些有用的链接:</p><ul class=""><li id="bbab" class="mz na in kc b kd ke kh ki kl nb kp nc kt nd kx ne nf ng nh bi translated"><a class="ae jz" href="https://scotthelme.co.uk/csp-nonce-support-in-nginx/" rel="noopener ugc nofollow" target="_blank"> Nginx </a></li><li id="7e24" class="mz na in kc b kd ni kh nj kl nk kp nl kt nm kx ne nf ng nh bi translated"><a class="ae jz" href="https://www.freshleafmedia.co.uk/blog/apache-csp-nonce-inject-static-site" rel="noopener ugc nofollow" target="_blank">阿帕奇</a></li><li id="dbcf" class="mz na in kc b kd ni kh nj kl nk kp nl kt nm kx ne nf ng nh bi translated"><a class="ae jz" href="https://github.com/andrewlock/NetEscapades.AspNetCore.SecurityHeaders" rel="noopener ugc nofollow" target="_blank">。网络</a></li></ul><p id="b6a5" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">一旦工作正常，确保nonce值被添加到您的内联脚本中</p><p id="5d86" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><code class="fe mo mp mq mr b">&lt;script nonce="&lt;base64-value&gt;<em class="lw">"</em>&gt;</code></p><p id="45e6" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">其中<em class="lw"> &lt; base64-value &gt; </em>是您的服务器在CSP白名单中生成并输出的值，如下所示</p><pre class="mt mu mv mw gt nn mr no np aw nq bi"><span id="6adc" class="ky kz in mr b gy nr ns l nt nu">Content-Security-Policy: script-src <!-- -->nonce-&lt;base64-value&gt;</span></pre><p id="0dd0" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">接下来，你需要使用“nonce-aware”GTM脚本，如Google here<a class="ae jz" href="https://developers.google.com/tag-manager/web/csp" rel="noopener ugc nofollow" target="_blank">https://developers.google.com/tag-manager/web/csp</a>所述。这将确保标准脚本接收nonce值，并因此被列入您的CSP的白名单。</p><p id="1aef" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">测试您的CSP(使用<em class="lw">只报告</em>模式，如果您不希望它阻塞您的测试环境中的任何东西)，然后将GTM加载的资源使用的任何主机列入白名单。</p><p id="533e" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">如果您的GTM配置使用定制的HTML标签，您仍然会有问题，因为它不会将<code class="fe mo mp mq mr b">nonce</code>传播给它们。为此，您必须首先配置您的GTM脚本标签:</p><ol class=""><li id="f715" class="mz na in kc b kd ke kh ki kl nb kp nc kt nd kx nv nf ng nh bi translated">与您的任何内联脚本一样，添加<code class="fe mo mp mq mr b">nonce</code>属性和值，以便将其列入白名单</li><li id="b43b" class="mz na in kc b kd ni kh nj kl nk kp nl kt nm kx nv nf ng nh bi translated">向GTM脚本标签添加一个ID，供其引用。</li><li id="061c" class="mz na in kc b kd ni kh nj kl nk kp nl kt nm kx nv nf ng nh bi translated">另外，添加一个数据属性来存储生成的随机数，例如<code class="fe mo mp mq mr b">data-nonce="<em class="lw">your nonce value here</em>"</code>。GTM将使用它来读取服务器输出的nonce值。在一些浏览器中，比如Chrome，GTM不可能直接从<code class="fe mo mp mq mr b">nonce</code>属性中读取，因为它被屏蔽了。</li></ol><p id="5952" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">您的内联GTM脚本标记现在应该如下所示:</p><p id="6319" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><code class="fe mo mp mq mr b">&lt;script nonce=”<em class="lw">your nonce here</em>” id=”your chosen ID here” data-nonce=”<em class="lw">your nonce here</em>”&gt;</code></p><p id="9f70" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">然后通过其门户配置GTM</p><ol class=""><li id="c6ca" class="mz na in kc b kd ke kh ki kl nb kp nc kt nd kx nv nf ng nh bi translated">创建一个捕获随机数的新变量。使用<em class="lw"> DOM元素类型</em>，选择<code class="fe mo mp mq mr b">data-nonce</code>属性</li><li id="eb50" class="mz na in kc b kd ni kh nj kl nk kp nl kt nm kx nv nf ng nh bi translated">更新每个自定义HTML脚本的脚本标记，以引用nonce属性并存储上述变量的nonce值。</li><li id="d5d9" class="mz na in kc b kd ni kh nj kl nk kp nl kt nm kx nv nf ng nh bi translated">设置每个自定义的HTML标签来支持<code class="fe mo mp mq mr b">document.write</code></li><li id="b664" class="mz na in kc b kd ni kh nj kl nk kp nl kt nm kx nv nf ng nh bi translated">如果在脚本中创建脚本，则创建一个单独的<code class="fe mo mp mq mr b">nonce</code>属性，并按照上述变量存储nonce值</li></ol><p id="6520" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">然后测试您的应用程序，确保CSP没有阻塞任何GTM加载的脚本。如果您没有为GTM设置不同的环境，我建议您这样做。</p><h1 id="c7b4" class="lx kz in bd la ly lz ma ld mb mc md lg me mf mg lj mh mi mj lm mk ml mm lp mn bi translated">结论</h1><p id="5e73" class="pw-post-body-paragraph ka kb in kc b kd lr kf kg kh ls kj kk kl lt kn ko kp lu kr ks kt lv kv kw kx ig bi translated">现在应该很清楚为什么GTM和CSP默认情况下合不来，以及你可以做些什么来让它们很好地合作。</p><p id="86ae" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">虽然上面列出的解决方案应该在大多数情况下都有效，但可能值得考虑在标准软件开发过程中管理标签，以便降低未经测试的第三方脚本带来的问题风险。</p><p id="ff84" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><em class="lw">感谢</em><a class="ae jz" href="https://www.rocketmill.co.uk/" rel="noopener ugc nofollow" target="_blank"><em class="lw">rocket mill</em></a><em class="lw">的Neil Barnes，他对本文进行了同行评审，贡献了GTM内容，并与我合作开发了一个工作解决方案。</em></p><p id="1f63" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><em class="lw">更多内容请看</em><a class="ae jz" href="http://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><em class="lw">plain English . io</em></a></p></div></div>    
</body>
</html>