<html>
<head>
<title>A simpler way to use IndexedDB</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用IndexedDB的更简单方法</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/a-simpler-way-to-use-indexeddb-6113761b3181?source=collection_archive---------7-----------------------#2021-01-10">https://javascript.plainenglish.io/a-simpler-way-to-use-indexeddb-6113761b3181?source=collection_archive---------7-----------------------#2021-01-10</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="1a28" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated"><em class="kc">客户端的NoSQL数据库比localStorage强大很多？好好好！</em></h2></div><p id="d1ce" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">IndexedDB是一个位于浏览器中的事务数据库，是一个异步的、基于键值的对象存储，只要有用户许可和空闲空间，就没有严格的数据存储限制。听起来很糟糕，对吧？</p><p id="256e" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">好了，这里是我真正喜欢<code class="fe kz la lb lc b">indexedDB</code>的一些地方:</p><ul class=""><li id="67e2" class="ld le in kf b kg kh kj kk km lf kq lg ku lh ky li lj lk ll bi translated">它是一个事务数据库，这意味着您可以在一个事务中包装多个相关操作，如果任何操作失败，所有其他更改都将恢复到以前的状态，就好像该事务从未发生过一样。这确保了数据的可靠性。</li><li id="51aa" class="ld le in kf b kg lm kj ln km lo kq lp ku lq ky li lj lk ll bi translated"><code class="fe kz la lb lc b">indexedDB</code>设计用于处理大量非结构化数据，包括文件/blob。</li><li id="719e" class="ld le in kf b kg lm kj ln km lo kq lp ku lq ky li lj lk ll bi translated">它是异步的，意味着在与数据库交互时不会阻塞宏任务，如果有大量的数据交互，这是非常方便的。</li><li id="71f5" class="ld le in kf b kg lm kj ln km lo kq lp ku lq ky li lj lk ll bi translated">可以对对象存储进行索引，这有助于基于特定的关键字来分离数据，从而有助于更快地获取数据。</li></ul></div><div class="ab cl lr ls hr lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ig ih ii ij ik"><p id="e899" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">在最高级别，我们可以创建一个数据库，它由带有键-值对的objectStores组成，其中每个值都是一个表示单个记录的独立对象。</p><p id="ff81" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">我们可以进一步使用记录中的键来索引数据，这些数据可以是唯一的或重复的。</p><p id="94b3" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">这是同样的一个形象化的例子:</p><figure class="lz ma mb mc gt md gh gi paragraph-image"><div class="gh gi ly"><img src="../Images/63040553310500a2214c5252a80cd535.png" data-original-src="https://miro.medium.com/v2/resize:fit:1368/format:webp/1*CnKZbzaiqCJqt6apdra1HQ.png"/></div></figure><p id="57ec" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">虽然<code class="fe kz la lb lc b">indexedDB</code>听起来很有趣，但当谈到与它互动时，有很多事情要考虑，这个过程真的很复杂。</p><p id="bb19" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">我将尝试提及我在使用indexedDB时面临的一些挑战:</p><p id="bf1b" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated"><strong class="kf io">回调:</strong></p><p id="fa15" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">在<code class="fe kz la lb lc b">indexedDB</code>中发出的请求具有类似于<em class="mg"> onsuccess </em>、<em class="mg"> onerror </em>的事件，需要将回调附加到这些事件上以进行进一步的操作。</p><p id="e1c4" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">如果有相关的操作要做，这很容易导致我们进入回调地狱。</p><p id="cd56" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated"><strong class="kf io">模式版本化:</strong></p><p id="6616" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated"><code class="fe kz la lb lc b">indexedDB</code>维护数据库的版本，并且维护版本号以确保每当发布新的应用版本时数据库都被更新。</p><p id="64ee" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">在这种方法中，您必须保存版本历史，当<code class="fe kz la lb lc b">indexedDB</code>打开时，您必须检查本地版本并将其与当前版本进行比较，以获得更新之间的所有细节，从而将本地版本正确更新到当前版本。</p><p id="644f" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">当版本更新时，<code class="fe kz la lb lc b">upgradeneeded</code>事件被触发，只有在这个事件的回调中，我们才能创建任何<code class="fe kz la lb lc b">objectStore</code>或<code class="fe kz la lb lc b">index</code>。</p><p id="0a94" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">所以每次你需要创建一个<code class="fe kz la lb lc b">objectStore</code>或者<code class="fe kz la lb lc b">index</code>的时候，你都要创建一个新的版本。</p><p id="8d56" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">下面的代码是我们通常打开一个<code class="fe kz la lb lc b">indexedDB</code>数据库的方式:</p><figure class="lz ma mb mc gt md"><div class="bz fp l di"><div class="mh mi l"/></div></figure></div><div class="ab cl lr ls hr lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ig ih ii ij ik"><p id="8de4" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">为了将这些令人头疼的事情外包出去，并使这个过程更顺利一些，我为此创建了一个库:</p><div class="mj mk gp gr ml mm"><a href="https://www.npmjs.com/package/simplestore-indexeddb" rel="noopener  ugc nofollow" target="_blank"><div class="mn ab fo"><div class="mo ab mp cl cj mq"><h2 class="bd io gy z fp mr fr fs ms fu fw im bi translated">simplestore-indexeddb</h2><div class="mt l"><h3 class="bd b gy z fp mr fr fs ms fu fw dk translated">indexedDB的包装。这个项目的目的是使与indexedDB的互动尽可能顺利与最少的努力…</h3></div><div class="mu l"><p class="bd b dl z fp mr fr fs ms fu fw dk translated">www.npmjs.com</p></div></div><div class="mv l"><div class="mw l mx my mz mv na me mm"/></div></div></a></div><p id="ea94" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">因此，如果我必须执行与上面<code class="fe kz la lb lc b">SimpleStore</code>中所写的相同的过程，它会是这样的:</p><figure class="lz ma mb mc gt md"><div class="bz fp l di"><div class="mh mi l"/></div></figure><p id="54de" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">这里要做的就是将模式传递给<code class="fe kz la lb lc b">addStores</code> <em class="mg"> </em>方法，它将负责版本控制并返回<code class="fe kz la lb lc b">SimpleStore</code>的实例。</p><p id="cfbe" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">因为<code class="fe kz la lb lc b">SimpleStore</code>是一个可命名对象，所以你可以附加一个<code class="fe kz la lb lc b">then</code>方法或者使用<code class="fe kz la lb lc b"><em class="mg">await</em></code> <em class="mg"> </em>语法来等待数据库更新。</p><p id="583b" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">现在，关于事务，让我向您展示我们如何将数据添加到存储中，然后再获取数据:</p><p id="fd31" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated"><strong class="kf io">索引数据库方式:</strong></p><figure class="lz ma mb mc gt md"><div class="bz fp l di"><div class="mh mi l"/></div></figure><p id="ef9a" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated"><strong class="kf io">简单商店方式:</strong></p><figure class="lz ma mb mc gt md"><div class="bz fp l di"><div class="mh mi l"/></div></figure><p id="049c" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">我在这里主要关心的是有效地执行事务，为了做到这一点，宏队列中的所有操作都包装在一个事务中，基本上是在最后自动提交。</p><p id="f99f" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">然而，如果您想将某些操作包装在一个事务中，您可以在最后使用<code class="fe kz la lb lc b">commit</code>方法来确保事务立即执行:</p><pre class="lz ma mb mc gt nb lc nc nd aw ne bi"><span id="639e" class="nf ng in lc b gy nh ni l nj nk">mystore.store("books")<br/>       .add({name:"Thinking fast and slow"})<br/>       .delete({name:"You don't know JS"})<br/>       .commit()<br/>       .then(()=&gt;{console.log("data added.")})</span></pre><p id="9abb" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">下面是一个<code class="fe kz la lb lc b">SimpleStore</code>的例子:</p><figure class="lz ma mb mc gt md"><div class="bz fp l di"><div class="nl mi l"/></div></figure><p id="143f" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">你在表中添加的任何数据都将保留在浏览器内存中，不会在刷新时消失。所以一定要删除任何秘密的；)</p><p id="58b7" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">如果你想玩这个包，这里有一个cdn链接:</p><p id="76cf" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated"><a class="ae nm" href="https://cdn.jsdelivr.net/npm/simplestore-indexeddb@1.1.3/dist/simplestore.min.js" rel="noopener ugc nofollow" target="_blank">https://cdn . jsdelivr . net/NPM/simplestore-indexed db @ 1 . 2 . 1/dist/simplestore . min . js</a></p><p id="341c" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">要引用文档:</p><div class="mj mk gp gr ml mm"><a href="https://www.npmjs.com/package/simplestore-indexeddb" rel="noopener  ugc nofollow" target="_blank"><div class="mn ab fo"><div class="mo ab mp cl cj mq"><h2 class="bd io gy z fp mr fr fs ms fu fw im bi translated">simplestore-indexeddb</h2><div class="mt l"><h3 class="bd b gy z fp mr fr fs ms fu fw dk translated">indexedDB的包装。这个项目的目的是使与indexedDB的互动尽可能顺利与最少的努力…</h3></div><div class="mu l"><p class="bd b dl z fp mr fr fs ms fu fw dk translated">www.npmjs.com</p></div></div><div class="mv l"><div class="mw l mx my mz mv na me mm"/></div></div></a></div><p id="fd9e" class="pw-post-body-paragraph kd ke in kf b kg kh jo ki kj kk jr kl km kn ko kp kq kr ks kt ku kv kw kx ky ig bi translated">谢谢你的阅读，希望你喜欢！</p></div></div>    
</body>
</html>