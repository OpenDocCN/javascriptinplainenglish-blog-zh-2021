# 软件弹性:从意外中康复的 7 个必备因素

> 原文：<https://javascript.plainenglish.io/software-resilience-723934d8b4c1?source=collection_archive---------11----------------------->

## 软件弹性是任何可伸缩、高性能和容错软件的必备品质。

![](img/10ed675c2b1ce9c8790445bce17ea01c.png)

Image from [Pixabay](https://pixabay.com/photos/resilient-resilience-strong-4899506/)

软件从意外事件中恢复的能力就是软件弹性。这意味着软件工程师必须预测意外事件，并对其做出解释。创建这种容错的解决方案可以在代码中，也可以在基础设施层。

分布式系统会失败，一个有弹性的软件系统不会试图避免失败，而是期待失败并优雅地应对。

在本帖中，我们将探讨一些你需要注意的方面，以获得软件弹性。

# 什么是软件弹性？

卡耐基梅隆大学软件工程学院[博客](https://insights.sei.cmu.edu/sei_blog/2019/11/system-resilience-what-exactly-is-it.html)指出:

*“基本上，如果一个系统在逆境中继续执行其使命(即，如果它提供所需的能力，尽管过度的压力可能导致中断)，它就是有弹性的。具有弹性很重要，因为无论一个系统设计得多好，现实迟早会破坏这个系统。”*

如果一个软件系统在意外事件发生时能够部分正常运行，这就是软件弹性。在基础设施层面，有网飞设计的臭名昭著的[混沌猴子](https://netflix.github.io/chaosmonkey/)。混沌猴进入您的生产环境，随机开始杀死实例。这是对你的软件弹性的压力测试。

软件的弹性也受到爆炸半径的影响。如果变更在它所能覆盖的范围内是低风险的，那么就更容易继续进行变更。如果爆炸半径很大，你可能也需要考虑其他事情。

# 弹性软件因素

有多个因素是软件弹性等式的一部分。以下是我在十多年的软件工程生涯中的一些经历。

*下面提到的例子将与电子商务有关，因为我已经在时尚电子商务领域工作了近 9 年。*

让我们开始吧。

## 逐步推广/部署

逐步展示或部署是一种以部分形式发布的能力。它可能是金丝雀部署或蓝绿色部署，或者只是一个功能标志，甚至是滚动部署。你可以通过丰富多彩的方式阅读更多关于这些[部署技术](https://opensource.com/article/17/5/colorful-deployments)的内容。

这里的重点是，即使这是一项手动任务，对弹性软件来说也非常重要。想象一下，您正在为一个电子商务网站改变支付网关。如果您大赚一笔，100%的交易都是从前的支付网关 A 转移到新的支付网关 B，您将陷入困境。

*但是，如果您可以尝试 1%的客户，持续 1 周，通过新的网关集成消除任何错误，这将会有很大帮助，爆炸半径仅为交易量的 1%。*

慢慢地，一周又一周，你可以充满信心地从 1 到 5，然后到 10，最后到 100。部署时进行[健康检查](https://microservices.io/patterns/observability/health-check-api.html)也是同样的逻辑。如果运行状况检查失败，部署将自动回滚。根据您使用的服务，您甚至可以逐步推广，这意味着该特定版本仅获得 2%的流量。[逐渐推出的](https://cloud.google.com/run/docs/rollouts-rollbacks-traffic-migration)是由基础设施层上的[谷歌云运行](https://geshan.com.np/blog/2019/11/why-use-google-cloud-run-5-compelling-reasons/)等服务支持的，而不是代码层。

弹性软件的另一个重要考虑是[部署不是版本](https://geshan.com.np/blog/2018/10/deployment-is-not-release/)。

## 重试以获得软件恢复能力

如果您调用另一个系统，您总是需要预料到它们可能会失败。因此，在这种情况下，重试机制会有所帮助。例如，您正在调用产品审查服务来创建新产品审查。

*如果未能创建审核，您可以再次尝试 1 或 2 次以获得成功响应。*

下面是一个非常简单的卷曲示例:

这里的旋度总是会重试 3 次，因为它会返回一个 500 的错误。下面的卷曲将只运行一次，因为第一次尝试时它将回到 200:

重试是使软件更有弹性的一种简单但有效的方法。

## 超时设定

外部系统可能很慢，并且您无法控制它们的响应时间。这反过来会让您开发的系统变慢。一旦我们与“受欢迎的”快递服务整合。不幸的是，他们创建装运的响应时间是以秒而不是以毫秒为单位。

*我们通过优化超时和尽可能异步推进任务来解决这个问题。这确实有助于保持软件的弹性。*

这使得做质量检查的人和把物品放在箱子里运送给顾客的人畅通无阻。当箱子从质量控制站运送到包装站时，将创建装运，并且可以打印装运标签。尽管箱子从 QC 到包装站需要几秒钟的时间，但这对我们来说已经足够了。如果一些运输失败，有一个简单的重试选项，可以根据需要呼叫快递员。

这个故事的寓意是，总是添加相关的超时和快速失败。根据需要分发，以便在需要时重试使用。暂停非常重要。

## 撤退

回退是一个非常简单的概念。如果主要的东西不工作，使用备份。在 web 系统的情况下，主要的事情可能是来自 API 的响应。因此，如果您的 API 调用失败，甚至在一些重试之后，您可以回退到响应的本地副本。

另一个关于纯代码的例子可能很简单:

在上面的代码片段中，它查找`fees.shipping`,如果不可用，它返回到值 10.00。我们可以对一个 API 调用实现同样的事情，如果我们没有从 API 调用中得到想要的结果，它将优雅地降级到使用缺省值。

*回落似乎非常明显，但我有时会看到它们被遗忘或忽略。*

这可能会给高流量系统带来问题。

## 幂等运算支持软件弹性

一个[堆栈溢出](https://stackoverflow.com/a/1077421/112849)的答案很好地总结了这一点:

*在计算中，幂等运算是指如果使用相同的输入参数多次调用，则不会产生额外效果的运算。*

在现实生活中，它就像公共汽车上停止按钮。站牌亮了以后你按一次或者 100 次，都是一样的结果，指示公交司机在下一站停车。例如，API 中的 GET 操作是幂等的。这在设计弹性系统时很重要，让我用一个例子来解释。

您正在设计一个 API 来将邮件标记为已读。

*不管调用多少次 API 来将该单个消息标记为已读，第一个都会将其从未读设置为已读，所有其他的都不会改变状态。*

这是一个很容易理解的幂等性的例子。当使您的系统具有弹性时，您可以安全地忽略第二个和后面的请求来保护您的资源。

## 数据库事务

理解[数据库事务](https://www.tutorialspoint.com/dbms/dbms_transaction.htm)最简单的方法就是`all or nothing`。如果您有 3 个步骤来完成一项任务，并且在步骤 2 中出现问题，它将回滚整个操作。

*一个典型的例子是两个银行账户之间的资金转移，要么全部完成，要么什么都没发生。*

不应该出现从账户 A 扣款却没有加到账户 b 的情况，数据库交易对于数据一致非常重要。

通过很好地使用[隔离级别](https://www.geeksforgeeks.org/transaction-isolation-levels-dbms/)，我们可以使用数据库事务来应对竞争情况。例如，cron 将更新 20 条记录，如果这些行与另一个系统(如 ERP)成功同步，名为`synced`的标志将被设置为 true。可以通过以下步骤来避免另一个 cron 同时执行相同的任务:

1.  为底层任务做好准备，例如将这些行与企业资源规划(ERP)软件同步
2.  启动数据库事务
3.  `SELECT ... FOR UPDATE`隔离级别为“已提交读取”,会话超时比平时长
4.  将行与 ERP 同步
5.  使用更新查询将选定行的同步标志设置为 1
6.  提交事务
7.  如果有任何问题，回滚整个事务

因此，在上述情况下，如果步骤 4 失败，事务将回滚。当使用 select for update 锁定行时，另一个 cron 将无法读取它，因为它被锁定进行更新，并且使用隔离级别 read committed 完成。

通过停止两次同步相同的行，这有助于创建容错和弹性软件。如果在第一个 cron 运行的同时，另一个 cron 甚至是错误地运行了，它将等待这些行被新的 SELECT … FOR UPDATE 查询读取。

## 限速

到目前为止，您肯定已经发现，为了让软件更具弹性，它需要优化使用资源。这一限速因素正在防止我们的资源被滥用。例如， [Twitter API](https://developer.twitter.com/en/docs/twitter-api/v1/tweets/timelines/) 速率限制调用。我们以 Twitter API 上的`/statuses/user_timeline`为例，上面写着“900 个请求/15 分钟窗口(user-auth)”和“10 万个请求/24 小时窗口(应用级)”。因此，如果作为一个消费者，你打了 900 多个电话来获取用户的状态，将会有一个状态代码为 429 的响应。

当您开发 API 时，即使它们被其他内部服务使用，也必须遵循相同的原则。让我们假设，如果其他内部服务之一有一个错误配置的无限循环，当它开始疯狂地攻击您的服务时，您的服务将会停止运行。

如果你有一个很好的速率限制，其他服务会很早发现错误，他们可以更快地解决问题。

在您这一端，您的服务不会吞噬资源，并且通过更快地失败来保持正常。

# 其他需要考虑的事情

为了更好的软件弹性，还有许多其他的事情要考虑。数据库读写隔离是一个很好的实践。其中有一个主要用于写入的主数据库和多个读取副本。

*在这种情况下，大部分读取操作在读取副本之间进行负载平衡，主节点执行写入操作。*

主服务器与读取副本的同步可能会有“几秒钟”的延迟，但这是您应该愿意为它提供的弹性付出的代价。

另一个重要的软件弹性[模式](https://docs.microsoft.com/en-us/azure/architecture/patterns/category/resiliency)是断路器模式。

*类似于你家的电路断路器，如果你的软件系统多次无法连接到另一个软件系统，它就会切断电路，使其打开。它会定期检查另一个系统是否恢复。*

当另一个系统恢复时，电路再次闭合。微软博客对[断路器](https://docs.microsoft.com/en-us/azure/architecture/patterns/circuit-breaker)模式有很棒的解释。

弹性软件系统会自动伸缩。它们根据负载增加资源。这一点也与[软件可伸缩性](https://geshan.com.np/blog/2020/12/software-scalability/)有关，一般来说，软件可伸缩性和弹性是齐头并进的。自动缩放系统依赖于[健康检查](https://docs.microsoft.com/en-us/azure/architecture/patterns/health-endpoint-monitoring)。

*对于具有负载弹性的系统，它们应该能够在负载较高时增加资源，并在流量减少时降低资源。*

这保持了软件的弹性和最优的成本。

# 结论

弹性和自我修复软件对于高正常运行时间非常重要。

*即使在逆境中，软件的功能性能也会下降，这是弹性软件的标志。*

软件弹性是通过经常询问如果失败会发生什么来实现的，特别是在与外部服务如数据库或外部 API 通信时。我希望这能帮助你构建更有弹性的软件。如果你还有其他方面要分享，请别忘了评论。

*最初发表于*[*【https://geshan.com.np】*](https://geshan.com.np/blog/2020/12/software-resilience/)*。*