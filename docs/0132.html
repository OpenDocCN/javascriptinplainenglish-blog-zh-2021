<html>
<head>
<title>File uploads with DigitalOcean Spaces</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用数字海洋空间上传文件</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/file-uploads-with-digitalocean-spaces-1d35742f1b5c?source=collection_archive---------2-----------------------#2021-01-08">https://javascript.plainenglish.io/file-uploads-with-digitalocean-spaces-1d35742f1b5c?source=collection_archive---------2-----------------------#2021-01-08</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/40bc46f8e6da6cf7a5216bd37bef906a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ISfkm-O_JxbGLXhTFX99gw.png"/></div></div></figure><p id="71bb" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在本教程中，我们将学习如何设置文件上传到数字海洋空间。</p><p id="2b75" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我们将使用Node.js作为服务器，React作为前端。不浪费任何时间，让我们开始吧。</p><h1 id="126a" class="kt ku in bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">安装软件包</h1><ul class=""><li id="f649" class="lr ls in jx b jy lt kc lu kg lv kk lw ko lx ks ly lz ma mb bi translated">DigitalOcean spaces使用AWS，因此我们将使用<code class="fe mc md me mf b">aws-sdk</code>包上传文件，使用<code class="fe mc md me mf b">formidable-serverless</code>包在服务器上检索发送的文件。使用下面的命令添加包。</li></ul><pre class="mg mh mi mj gt mk mf ml mm aw mn bi"><span id="7384" class="mo ku in mf b gy mp mq l mr ms">npm install --save <!-- -->aws-sdk formidable-serverless</span><span id="4fbf" class="mo ku in mf b gy mt mq l mr ms">// OR</span><span id="b197" class="mo ku in mf b gy mt mq l mr ms">yarn add <!-- -->aws-sdk formidable-serverless</span></pre><h1 id="35e3" class="kt ku in bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">配置AWS</h1><ul class=""><li id="bd44" class="lr ls in jx b jy lt kc lu kg lv kk lw ko lx ks ly lz ma mb bi translated">要使用Spaces API，您需要<a class="ae mu" href="https://www.digitalocean.com/docs/spaces/how-to/manage-access/#access-keys" rel="noopener ugc nofollow" target="_blank">从<a class="ae mu" href="https://cloud.digitalocean.com/settings/api/tokens" rel="noopener ugc nofollow" target="_blank"> API页面</a>为您的空间创建一个访问密钥和秘密密钥</a>。</li><li id="fb9c" class="lr ls in jx b jy mv kc mw kg mx kk my ko mz ks ly lz ma mb bi translated">通过配置访问密钥、密钥和端点设置，将AWS包配置为与S3 API一起使用。端点值应该是<code class="fe mc md me mf b">${REGION}.digitaloceanspaces.com</code>，其中<code class="fe mc md me mf b">${REGION}</code>是您的空间所在的数字海洋数据中心区域(例如<code class="fe mc md me mf b">nyc3</code>)。</li></ul><pre class="mg mh mi mj gt mk mf ml mm aw mn bi"><span id="52c9" class="mo ku in mf b gy mp mq l mr ms">import aws <em class="na">from</em> "aws-sdk";</span><span id="b1b0" class="mo ku in mf b gy mt mq l mr ms">const s3 = new aws.S3({<br/>  endpoint: "<!-- -->nyc3<!-- -->.digitaloceanspaces.com",<br/>  accessKeyId: process.env.SPACES_ACCESS_KEY,<br/>  secretAccessKey: process.env.SPACES_SECRET_KEY,<br/>});</span></pre><h1 id="5a17" class="kt ku in bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">前端添加上传按钮</h1><ul class=""><li id="c224" class="lr ls in jx b jy lt kc lu kg lv kk lw ko lx ks ly lz ma mb bi translated">为了简单起见，我会直接将选择的文件传递给服务器，而不需要确认它，但是您可以将它存储到状态，然后单击提交按钮传递给服务器。</li></ul><pre class="mg mh mi mj gt mk mf ml mm aw mn bi"><span id="d202" class="mo ku in mf b gy mp mq l mr ms">&lt;input<br/>  type="file"<br/>  {/* Specify this if you want user to only upload specific file types */}<br/>  accept={fileTypes}<br/>  onChange={async (e) =&gt; {<br/>    <em class="na">if</em> (e.target.files.length &gt; 0) {<br/>      // Update UI to show file is uploading<br/>      const file = e.target.files[0];<br/>      <br/>      // Create FormData and pass picked file with other necessary details<br/>      const formData = new FormData();<br/>      formData.append("file", file);<br/>      formData.append("id", userId);</span><span id="bfd5" class="mo ku in mf b gy mt mq l mr ms"><em class="na">      try</em> {<br/>        const uploadFileRes = <em class="na">await</em> fetch("/api/uploadFile", {<br/>          method: "POST",<br/>          body: formData,<br/>        });</span><span id="26c5" class="mo ku in mf b gy mt mq l mr ms">        const uploadFileData = <em class="na">await</em> uploadFileRes.json();<br/>        // Retrieve url and show it to user?<br/>        // Update UI to show file has been uploaded<br/>      } <em class="na">catch</em> (e) {<br/>        console.log(e);<br/>        // Update UI to show file upload failed<br/>      }<br/>    }<br/>  }}<br/>/&gt;</span></pre><h1 id="667a" class="kt ku in bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">检索文件并上传到服务器上的数字海洋</h1><ul class=""><li id="7896" class="lr ls in jx b jy lt kc lu kg lv kk lw ko lx ks ly lz ma mb bi translated">在服务器上，我们将使用<code class="fe mc md me mf b">formidable-serverless</code>包从<code class="fe mc md me mf b">request</code>对象中检索文件和其他细节。使用S3 <code class="fe mc md me mf b">upload</code>方法将文件上传到数字海洋空间。</li></ul><pre class="mg mh mi mj gt mk mf ml mm aw mn bi"><span id="5686" class="mo ku in mf b gy mp mq l mr ms">import formidable <em class="na">from</em> "formidable-serverless";</span><span id="50bb" class="mo ku in mf b gy mt mq l mr ms">const form = new formidable.IncomingForm();<br/>form.uploadDir = "./";<br/>form.keepExtensions = true;</span><span id="480b" class="mo ku in mf b gy mt mq l mr ms">form.parse(req, async (err, fields, files) =&gt; {<br/>  <em class="na">if</em> (err || !fields.id) <em class="na">return</em> res.status(500);</span><span id="9a88" class="mo ku in mf b gy mt mq l mr ms">  // Read file<br/>  const file = fs.readFileSync(files.file.path);<br/>  <br/>  s3.upload({<br/>    Bucket: "bucket-name", // Add bucket name here<br/>    ACL: "public-read", // Specify whether anyone with link can access the file<br/>    Key: `${fields.id}/${files.file.name}`, // Specify folder and file name<br/>    Body: file,<br/>  }, {<br/>    partSize: 10 * 1024 * 1024,<em class="na"><br/>    </em>queueSize: 10,<br/>  }).send((err, data) =&gt; {<br/>    <em class="na">if</em> (err) <em class="na">return</em> res.status(500);</span><span id="eb5f" class="mo ku in mf b gy mt mq l mr ms">    // Unlink file<br/>    fs.unlinkSync(files.file.path);</span><span id="02db" class="mo ku in mf b gy mt mq l mr ms"><em class="na">    // </em>Return file url or other necessary details<em class="na"><br/>    return</em> res.send({<br/>      url: data.Location<br/>    });<br/>  });<br/>});</span></pre><ul class=""><li id="9dda" class="lr ls in jx b jy jz kc kd kg nb kk nc ko nd ks ly lz ma mb bi translated">把所有的放在一起</li></ul><pre class="mg mh mi mj gt mk mf ml mm aw mn bi"><span id="ffc9" class="mo ku in mf b gy mp mq l mr ms">import aws <em class="na">from</em> "aws-sdk";<br/>import formidable <em class="na">from</em> "formidable-serverless";</span><span id="5678" class="mo ku in mf b gy mt mq l mr ms">const s3 = new aws.S3({<br/>  endpoint: "<!-- -->nyc3<!-- -->.digitaloceanspaces.com",<br/>  accessKeyId: process.env.SPACES_ACCESS_KEY,<br/>  secretAccessKey: process.env.SPACES_SECRET_KEY,<br/>});</span><span id="bd19" class="mo ku in mf b gy mt mq l mr ms">const form = new formidable.IncomingForm();<br/>form.uploadDir = "./";<br/>form.keepExtensions = true;</span><span id="1b6f" class="mo ku in mf b gy mt mq l mr ms">form.parse(req, async (err, fields, files) =&gt; {<br/>  <em class="na">if</em> (err || !fields.id) <em class="na">return</em> res.status(500);</span><span id="6371" class="mo ku in mf b gy mt mq l mr ms">  // Read file<br/>  const file = fs.readFileSync(files.file.path);<br/>  <br/>  s3.upload({<br/>    Bucket: "bucket-name", // Add bucket name here<br/>    ACL: "public-read", // Specify whether anyone with link can access the file<br/>    Key: `${fields.id}/${files.file.name}`, // Specify folder and file name<br/>    Body: file,<br/>  }, {<br/>    partSize: 10 * 1024 * 1024,<em class="na"><br/>    </em>queueSize: 10,<br/>  }).send((err, data) =&gt; {<br/>    <em class="na">if</em> (err) <em class="na">return</em> res.status(500);</span><span id="d193" class="mo ku in mf b gy mt mq l mr ms">    // Unlink file<br/>    fs.unlinkSync(files.file.path);</span><span id="8c61" class="mo ku in mf b gy mt mq l mr ms"><em class="na">    // </em>Return file url or other necessary details<em class="na"><br/>    return</em> res.send({<br/>      url: data.Location<br/>    });<br/>  });<br/>});</span></pre></div><div class="ab cl ne nf hr ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="ig ih ii ij ik"><p id="e9f7" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">本教程到此为止。希望对你有帮助。在<a class="ae mu" href="https://www.instagram.com/imchetanyadav/" rel="noopener ugc nofollow" target="_blank"> Instagram </a>和<a class="ae mu" href="https://twitter.com/im_chetanyadav/" rel="noopener ugc nofollow" target="_blank"> Twitter </a>上关注我，获取更多信息。</p></div></div>    
</body>
</html>