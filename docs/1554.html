<html>
<head>
<title>How to make a “Hello World” Application with http2 and Express</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用http2和Express制作一个“Hello World”应用程序</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/serving-hello-world-with-http2-and-express-js-4dd0ffe76860?source=collection_archive---------1-----------------------#2021-04-03">https://javascript.plainenglish.io/serving-hello-world-with-http2-and-express-js-4dd0ffe76860?source=collection_archive---------1-----------------------#2021-04-03</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="7805" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">通过使用<a class="ae ki" href="https://www.npmjs.com/package/http2-express-bridge" rel="noopener ugc nofollow" target="_blank"><strong class="jm io">http 2-Express-bridge</strong></a><strong class="jm io"/>包装器<strong class="jm io">，最终可以让Express与Node.js' http2一起工作。</strong></p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi kj"><img src="../Images/e99ac89051f8976326442275b2d99fb9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*hEUnmjS_fRPAah4O"/></div></div><figcaption class="kv kw gj gh gi kx ky bd b be z dk">Photo by <a class="ae ki" href="https://unsplash.com/@nubelsondev?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Nubelson Fernandes</a> on <a class="ae ki" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="1448" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">几个月前，在万维网上搜索时，我偶然发现了术语<strong class="jm io"> HTTP/2 </strong>。作为一名好奇的web开发人员，我从来没有听说过这个术语——我觉得我应该知道——我很快暂停了对我试图解决的bug修复的搜索，并决定进入这个兔子洞。</p><p id="2d88" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">对于外行来说，<strong class="jm io"> HTTP/2 </strong>是对<strong class="jm io"> HTTP/1.1 </strong>协议的一个重大修订。<strong class="jm io"> HTTP/2 </strong>规范于2015年夏天首次发布。从那以后，大多数主流浏览器都实现了它。<strong class="jm io"> HTTP/2 </strong>比它的前身有很多主要的优势，无论是请求/响应复用、头压缩、服务器推送等等。甚至有<strong class="jm io"> HTTP/3 </strong>的草案正在测试中。你可以在这里阅读更多关于<strong class="jm io">的内容HTTP/2 </strong> <a class="ae ki" href="https://developers.google.com/web/fundamentals/performance/http2" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="1287" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在感到兴奋的同时，也为没有早点发现而感到沮丧，我决定尝试一下。作为一名JavaScript开发人员，我决定用Express在Node.js中创建一个服务器实例。在搜索了StackOverflow之后，这是我整理的代码。</p><pre class="kk kl km kn gt kz la lb lc aw ld bi"><span id="1b09" class="le lf in la b gy lg lh l li lj">const express = require('express')<br/>const http2 = require('http2')<br/>const { readFileSync } = require('fs')</span><span id="3436" class="le lf in la b gy lk lh l li lj">const app = express()<br/><br/>app.get('/express', (req, res) =&gt; {<br/>  res.send('Hello World');<br/>})</span><span id="89c2" class="le lf in la b gy lk lh l li lj">const options = {<br/>  key: readFileSync('&lt;Certificate Key&gt;'),<br/>  cert: readFileSync('&lt;Certificate file&gt;'),<br/>  allowHTTP1: true<br/>}</span><span id="c7ad" class="le lf in la b gy lk lh l li lj">const server = http2.createSecureServer(options, app)<br/>server.listen(3000)</span></pre><p id="88c2" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">需要一个安全的服务器，因为没有TLS加密，没有浏览器支持<strong class="jm io"> HTTP/2 </strong>。</p><p id="b486" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">上面的代码看起来很合理，我完全相信代码会工作。但是，当您尝试访问该路径时，迎接您的是:</p><pre class="kk kl km kn gt kz la lb lc aw ld bi"><span id="d4d2" class="le lf in la b gy lg lh l li lj">_http_incoming.js:113<br/>  if (this.socket.readable)<br/>                  ^</span><span id="6529" class="le lf in la b gy lk lh l li lj">TypeError: Cannot read property 'readable' of undefined<br/>    at IncomingMessage._read (_http_incoming.js:113:19)<br/>    at IncomingMessage.Readable.read (internal/streams/readable.js:481:10)<br/>    at resume_ (internal/streams/readable.js:968:12)<br/>    at processTicksAndRejections (internal/process/task_queues.js:80:21)<br/>[nodemon] app crashed - waiting for file changes before starting...</span></pre></div><div class="ab cl ll lm hr ln" role="separator"><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq"/></div><div class="ig ih ii ij ik"><h2 id="c177" class="le lf in bd ls lt lu dn lv lw lx dp ly jv lz ma mb jz mc md me kd mf mg mh mi bi translated">为什么会这样？</h2><p id="b4af" class="pw-post-body-paragraph jk jl in jm b jn mj jp jq jr mk jt ju jv ml jx jy jz mm kb kc kd mn kf kg kh ig bi translated">在内部，Express有一个核心中间件，在每个请求期间都会被调用。这个中间件用定制的请求/响应对象类型替换从服务器接收的请求/响应对象类型。默认情况下，自定义请求/响应对象继承自<code class="fe mo mp mq la b">http</code> <strong class="jm io"> </strong>模块。从<code class="fe mo mp mq la b">http2</code> <strong class="jm io"> </strong>模块得知与服务器不兼容。</p><p id="93b7" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">要解决这个问题，必须改变中间件，以确保适当的请求/响应对象类型被路由到适当的模块。</p><p id="346b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">Express已经为这个修复工作了很长时间，但是ETA仍然没有明确的定义。同时，我以npm包的形式创建了一个补丁，<a class="ae ki" href="https://www.npmjs.com/package/http2-express-bridge" rel="noopener ugc nofollow" target="_blank"><strong class="jm io">http 2-express-bridge</strong></a>。</p><pre class="kk kl km kn gt kz la lb lc aw ld bi"><span id="7d6b" class="le lf in la b gy lg lh l li lj">npm install http2-express-bridge</span></pre><p id="c94d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">代码用法类似于第一个代码片段中的服务器代码。</p><pre class="kk kl km kn gt kz la lb lc aw ld bi"><span id="2fc7" class="le lf in la b gy lg lh l li lj">const express = require('express')<br/><strong class="la io">const http2Express = require('http2-express-bridge')<br/></strong>const http2 = require('http2')<br/>const { readFileSync } = require('fs')</span><span id="f371" class="le lf in la b gy lk lh l li lj">// only change required<br/><strong class="la io">const app = http2Express(express)<br/></strong><br/>app.get('/express', (req, res) =&gt; {<br/>  res.send('Hello World');<br/>})</span><span id="3679" class="le lf in la b gy lk lh l li lj">const options = {<br/>  key: readFileSync('&lt;Certificate Key&gt;'),<br/>  cert: readFileSync('&lt;Certificate file&gt;'),<br/>  allowHTTP1: true<br/>}</span><span id="ec85" class="le lf in la b gy lk lh l li lj">const server = http2.createSecureServer(options, app)<br/>server.listen(3000)</span></pre><p id="344f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">就这样，代码工作了。通过选项中的<code class="fe mo mp mq la b">allowHTTP1</code>标志，当客户端不支持<strong class="jm io"> HTTP/2 </strong>时，它会还原为<strong class="jm io"> HTTP/1.1 </strong>。</p><p id="cffe" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">你可以在这里查看<a class="ae ki" href="https://github.com/rahulramesha/http2-express-bridge" rel="noopener ugc nofollow" target="_blank">包的代码。如上面的代码所示，这个包与CommonJS一起工作。它也适用于ES模块和TypeScript。</a></p><p id="4156" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">快乐复用！</p></div><div class="ab cl ll lm hr ln" role="separator"><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq lr"/><span class="lo bw bk lp lq"/></div><div class="ig ih ii ij ik"><blockquote class="mr ms mt"><p id="25eb" class="jk jl mu jm b jn jo jp jq jr js jt ju mv jw jx jy mw ka kb kc mx ke kf kg kh ig bi translated"><strong class="jm io"> PS: </strong>这是故事的前半部分。另一个关注<strong class="jm io">服务器推送</strong>的部分将在不久的将来发布。</p></blockquote><p id="5acd" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><em class="mu">更多内容请看</em><a class="ae ki" href="http://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><em class="mu">plain English . io</em></a></p></div></div>    
</body>
</html>