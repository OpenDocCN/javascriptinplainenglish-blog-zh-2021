<html>
<head>
<title>Upload Files from Multiple Fields using Multer</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Multer从多个字段上传文件</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/upload-files-from-multiple-fields-using-multer-ee9a28d0f57c?source=collection_archive---------0-----------------------#2021-08-03">https://javascript.plainenglish.io/upload-files-from-multiple-fields-using-multer-ee9a28d0f57c?source=collection_archive---------0-----------------------#2021-08-03</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/264007521e7084292caaca0549a61af8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*x_Hc4PMfMA2xWg7f"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Photo by <a class="ae jz" href="https://unsplash.com/@jstrippa?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">James Harrison</a> on <a class="ae jz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="b9e6" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">所以有一天，我开始了一个小项目，作为对everything React和Node.js的复习。这个想法是制作某种网络应用程序来免费获得有声读物。为此，我知道我需要将有声读物上传到服务器，以便人们下载。简单吧？至少我知道我的项目在原始水平上会是什么样子，以及我希望它具有的功能。</p><p id="9f40" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">当我开始制作上传有声读物的页面时——对于管理员，也就是我，我面临着一个挑战:从多个领域上传文件并保存在服务器中，然后将需要保存的内容发送到数据库。使用multer上传单个文件非常简单，文档也非常好。</p><p id="b181" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">以下是我所做的，我想我会与你们分享，这样下次像我这样的人开始建造一些东西时，他们可以立即找到他们需要的帮助。</p><p id="52fc" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">如果您想实现从多个字段上传文件，您可以简单地使用下面的代码。</p><p id="076e" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">第一步:安装依赖关系</strong></p><pre class="ky kz la lb gt lc ld le lf aw lg bi"><span id="5b93" class="lh li in ld b gy lj lk l ll lm">npm install multer --save</span></pre><p id="ea86" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">步骤2:通过需要这些模块来导入express和multer。你可以在你的入口点文件中包含(<code class="fe ln lo lp ld b">server.js</code>或<code class="fe ln lo lp ld b">index.js</code>)或者创建一个单独的<code class="fe ln lo lp ld b">multer-config.js</code>。我采取了第二种方法。</p><p id="2dbf" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><code class="fe ln lo lp ld b">const multer = require("multer")</code></p><p id="391b" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">步骤3:为了使用multer，必须首先配置它。它以一个对象作为选项，包含<code class="fe ln lo lp ld b">storage</code>和<code class="fe ln lo lp ld b">fileFilter</code>。</p><p id="b1bd" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io"> 3.1定义存储</strong></p><pre class="ky kz la lb gt lc ld le lf aw lg bi"><span id="6325" class="lh li in ld b gy lj lk l ll lm">const storageEngine = multer.diskStorage({</span><span id="beb4" class="lh li in ld b gy lq lk l ll lm">destination: (req, file, cb) =&gt; { cb(null, “YourStorageFolder”) },</span><span id="13ef" class="lh li in ld b gy lq lk l ll lm">filename: (req, file, cb) =&gt; { cb(null, file.originalname) }, })</span></pre><figure class="ky kz la lb gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi lr"><img src="../Images/b01a00e608099958ffb1fd89a22cf6c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*j1OiQ48rhT1ebN1C9mpUZA.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Defining the storage option — destination and filename to be used when saving the uploaded file</figcaption></figure><p id="d8b6" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">3.2定义fileFilter(如果你需要，但我认为你会):我只允许音频(. mp3，. m4a)，图像(。png，。jpg，。jpeg)和。压缩文件。因此，会检查所有的MIME类型。</p><pre class="ky kz la lb gt lc ld le lf aw lg bi"><span id="3d69" class="lh li in ld b gy lj lk l ll lm">const audiobookFilter = (req, file, cb) =&gt; {</span><span id="05e8" class="lh li in ld b gy lq lk l ll lm">if ( file.mimetype == "audio/mp4a-latm" || file.mimetype == "audio/mpeg" || file.mimetype == "application/zip" || file.mimetype == "image/png" || file.mimetype == "image/jpeg" || file.mimetype == "image/jpg") {</span><span id="7c87" class="lh li in ld b gy lq lk l ll lm">cb(null, true) } else { cb(null, false)}</span><span id="78fc" class="lh li in ld b gy lq lk l ll lm">}</span></pre><figure class="ky kz la lb gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi lr"><img src="../Images/0ce99fc91f2ad150f1d8e5f2ae9005eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LhGqFRySF6hhFTa1hNAbXA.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Defining fileFilter option — which files to upload, based on MIME type of the file.</figcaption></figure><p id="4739" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">第4步:最后，创建一个multer中间件！</strong></p><p id="42b9" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我将中间件命名为<code class="fe ln lo lp ld b">uploadHandler</code>,这样我就知道它的确切用途了。你可以用任何你想要的名字。通过上面定义的存储和fileFilter，我们的中间件就可以用在我们想要的任何路径上了。只有一件事我在这里错过了，这将是我的路线直接照顾。这使得中间件更加灵活，可以用来处理不同的上传场景。</p><pre class="ky kz la lb gt lc ld le lf aw lg bi"><span id="b83e" class="lh li in ld b gy lj lk l ll lm">exports.uploadHandler = multer({ storage: audiobookStorage, fileFilter: audiobookFilter })</span></pre><figure class="ky kz la lb gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi lr"><img src="../Images/33230cccf7aff47143bdca7a770839f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Puc8ZLolhucTCHSN2jJoMg.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Exporting the middleware</figcaption></figure><p id="52bd" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><strong class="kc io">第五步:现在就用！</strong></p><p id="6068" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">当要处理来自单个字段的单个文件、来自单个字段的多个文件以及来自不同字段的单个/多个文件时，该部分会有所不同。对于单个文件/单个字段上传，我们使用</p><p id="98d6" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><code class="fe ln lo lp ld b">.single(“field-name-of-type-file”)</code></p><p id="75c0" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">但在这里，我们需要接受不同领域、不同数量的文件。因此我们使用，</p><p id="1da9" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><code class="fe ln lo lp ld b">.field([{fieldName: String, maxCount: Int},])</code></p><p id="7c86" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">并传递一个对象数组，该数组包含字段名和可以使用该字段作为参数上传的文件数。</p><pre class="ky kz la lb gt lc ld le lf aw lg bi"><span id="763c" class="lh li in ld b gy lj lk l ll lm">const { audiobookUploadHandler } = require("../Utils/multer-config")</span><span id="049a" class="lh li in ld b gy lq lk l ll lm">router.post("/upload", audiobookUploadHandler.fields([<br/>{ name: "audiobook", maxCount: 1 },<br/>{ name: "cover", maxCount: 1 },]), UploadController.postUpload)</span></pre><figure class="ky kz la lb gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi lr"><img src="../Images/ae35b3bfe54a4d53d4f5d4e9c8bd386f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8dzksMzJb7hhCQUhwIW5VA.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Using the middleware in the upload route with .fields( ) to allow files from the specified fields to be uploaded.</figcaption></figure><p id="1380" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">就这样，一切都结束了。现在，如果您的UI中有两个file类型的输入字段，您可以通过每个字段上传一个文件，并相应地处理<code class="fe ln lo lp ld b">req.files</code>。此外，如果一个字段应该是<code class="fe ln lo lp ld b">multi-select</code>类型，只需将maxCount值更改为所需的数字，就可以了。</p><p id="944e" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">希望这对你有帮助。谢谢你检查这个。我很感激。</p><p id="d6c5" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">无论你在做什么，我都祝你一切顺利。干杯！</p><p id="5a21" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><em class="ls">更多内容看</em> <a class="ae jz" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kc io"> <em class="ls">说白了。报名参加我们的</em> <a class="ae jz" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kc io"> <em class="ls">免费周报</em> </strong> </a> <em class="ls">。关注我们关于</em><a class="ae jz" href="https://twitter.com/inPlainEngHQ" rel="noopener ugc nofollow" target="_blank"><strong class="kc io"><em class="ls">Twitter</em></strong></a><em class="ls">和</em><a class="ae jz" href="https://www.linkedin.com/company/inplainenglish/" rel="noopener ugc nofollow" target="_blank"><strong class="kc io"><em class="ls">LinkedIn</em></strong></a><em class="ls">。加入我们的</em> <a class="ae jz" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"> <strong class="kc io"> <em class="ls">社区</em> </strong> </a> <em class="ls">。</em></strong></a></p></div></div>    
</body>
</html>