<html>
<head>
<title>Asynchronous JavaScript: The Restaurant Analogy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">异步JavaScript:餐馆类比</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/asynchronous-javascript-the-restaurant-analogy-55c38d0517e0?source=collection_archive---------4-----------------------#2021-12-02">https://javascript.plainenglish.io/asynchronous-javascript-the-restaurant-analogy-55c38d0517e0?source=collection_archive---------4-----------------------#2021-12-02</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/e2d26b302c5fc9c035ff12648834b9eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5_XNuJjxdJUgr5bQ_fyAnA.png"/></div></div></figure><p id="bb70" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">本文面向刚开始学习JavaScript并试图理解JavaScript运行时工作原理的初学者。这对有经验的专业人士来说也是一个很好的复习。</p><p id="01d6" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这是我使用<strong class="jx io">餐厅类比</strong>来过度简化JavaScript的异步本质的一次尝试。如果我有任何错误，请随时在评论中纠正我。</p><h1 id="4ffc" class="kt ku in bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated"><strong class="ak">需要异步执行</strong></h1><p id="6eff" class="pw-post-body-paragraph jv jw in jx b jy lr ka kb kc ls ke kf kg lt ki kj kk lu km kn ko lv kq kr ks ig bi translated">JavaScript是一种同步的单线程编程语言。它的代码是在单线程中使用单个调用堆栈顺序执行的。但是不可能按顺序完成所有操作。</p><p id="5687" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">假设我们希望在顺序运行期间等待生成一些数据或输入。由于JavaScript是单线程的，让代码等待某个操作可能会导致整个应用程序冻结。通过从主线程卸载这些耗时的操作，可以避免这种情况。<strong class="jx io"> JavaScript运行时环境</strong> (Browsers/NodeJS)提供了一组处理此类操作的外部API。</p><figure class="lx ly lz ma gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi lw"><img src="../Images/964ba33a9d1b6d58ef6e0cb0d9a2e2f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1tg1-yOFeIzXHzh5ZOS7XQ.png"/></div></div></figure><p id="0d98" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">上图展示了JavaScript运行时环境的基本架构。它包括以下几个部分:</p><ul class=""><li id="bb3b" class="mb mc in jx b jy jz kc kd kg md kk me ko mf ks mg mh mi mj bi translated"><a class="ae mk" href="https://en.wikipedia.org/wiki/JavaScript_engine" rel="noopener ugc nofollow" target="_blank"> JavaScript引擎</a> ⚙️</li><li id="6f6b" class="mb mc in jx b jy ml kc mm kg mn kk mo ko mp ks mg mh mi mj bi translated"><a class="ae mk" href="https://developer.mozilla.org/en-US/docs/Web/API" rel="noopener ugc nofollow" target="_blank">Web API</a>🔴🔴🔴</li><li id="b88e" class="mb mc in jx b jy ml kc mm kg mn kk mo ko mp ks mg mh mi mj bi translated">任务队列<code class="fe mq mr ms mt b">🟦🔣🔠🔢🔡🔤</code></li><li id="84ce" class="mb mc in jx b jy ml kc mm kg mn kk mo ko mp ks mg mh mi mj bi translated"><a class="ae mk" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/EventLoop" rel="noopener ugc nofollow" target="_blank">事件循环</a>🔄</li></ul><p id="8fc6" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">所有这些元素构成了异步JavaScript的基本构件。</p></div><div class="ab cl mu mv hr mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="ig ih ii ij ik"><h1 id="7770" class="kt ku in bd kv kw nb ky kz la nc lc ld le nd lg lh li ne lk ll lm nf lo lp lq bi translated"><strong class="ak">如果网络浏览器是一家餐馆</strong></h1><figure class="lx ly lz ma gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/2da587f28652b6ea5c2af1c09f21fe1d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*p4okYjP7ctBU-M1uEEsiQA.png"/></div></div><figcaption class="ng nh gj gh gi ni nj bd b be z dk">* the waiter is part of the JS Runtime even though shown outside</figcaption></figure><p id="3cda" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">把网络浏览器想象成一家<strong class="jx io">餐馆</strong>。它包括一个餐厅和一个厨房。</p><p id="270f" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">餐厅</strong>是顾客进来点餐的地方。这类似于用户加载一个<strong class="jx io">网页</strong>并执行一些操作，比如从服务器获取数据。</p><p id="ff00" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">T21厨房是所有魔法发生的地方。这类似于由不同组件组成的<strong class="jx io"> JavaScript运行时环境</strong>，每个组件执行一个单独的任务。</p><p id="b7d8" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">下面列出了这些组件。</p><blockquote class="nk nl nm"><p id="28da" class="jv jw nn jx b jy jz ka kb kc kd ke kf no kh ki kj np kl km kn nq kp kq kr ks ig bi translated"><em class="in">🤵</em> <strong class="jx io"> <em class="in">服务员(JavaScript引擎)</em> </strong>:服务员执行的任务是跑来跑去接单提交到厨房，上菜，摆桌子。服务员也是厨房的一部分，尽管在图中他被显示在外面。这类似于运行代码的<strong class="jx io"> JavaScript引擎</strong>。</p><p id="a89e" class="jv jw nn jx b jy jz ka kb kc kd ke kf no kh ki kj np kl km kn nq kp kq kr ks ig bi translated"><em class="in">👨‍🍳</em> <strong class="jx io"> <em class="in">厨师(Web API)</em></strong>:厨师从服务员手中接过订单，准备好物品，放在送餐台上。这类似于<strong class="jx io">Web API</strong>执行用户请求的任务，并将结果推送到任务队列。</p><p id="d671" class="jv jw nn jx b jy jz ka kb kc kd ke kf no kh ki kj np kl km kn nq kp kq kr ks ig bi translated"><em class="in">👨‍💼</em> <strong class="jx io"> <em class="in">外卖经理(事件循环)</em> </strong>:他的工作是管理外卖柜台。他重复执行两项主要任务。</p><p id="1982" class="jv jw nn jx b jy jz ka kb kc kd ke kf no kh ki kj np kl km kn nq kp kq kr ks ig bi translated">1.检查送货台上是否有物品。</p><p id="6087" class="jv jw nn jx b jy jz ka kb kc kd ke kf no kh ki kj np kl km kn nq kp kq kr ks ig bi translated">2.查看服务员是否有空，有空就打电话给他。</p><p id="c7cd" class="jv jw nn jx b jy jz ka kb kc kd ke kf no kh ki kj np kl km kn nq kp kq kr ks ig bi translated">这类似于<strong class="jx io">事件循环</strong>，其工作是:</p><p id="c388" class="jv jw nn jx b jy jz ka kb kc kd ke kf no kh ki kj np kl km kn nq kp kq kr ks ig bi translated">1.检查任务队列中是否有项目</p><p id="3625" class="jv jw nn jx b jy jz ka kb kc kd ke kf no kh ki kj np kl km kn nq kp kq kr ks ig bi translated">2.检查JavaScript引擎中调用堆栈的状态，如果队列为空，则从队列中推送项目。</p><p id="b1fe" class="jv jw nn jx b jy jz ka kb kc kd ke kf no kh ki kj np kl km kn nq kp kq kr ks ig bi translated"><em class="in">🍽️ </em> <strong class="jx io"> <em class="in">送餐台(任务队列)</em> </strong>:这是厨师们放置准备好的菜肴的桌子，以便外卖经理在有空的时候把它传给服务员。这类似于JavaScript运行时中的<strong class="jx io">任务队列</strong>。</p></blockquote></div><div class="ab cl mu mv hr mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="ig ih ii ij ik"><h2 id="c332" class="nr ku in bd kv ns nt dn kz nu nv dp ld kg nw nx lh kk ny nz ll ko oa ob lp oc bi translated"><strong class="ak">下订单</strong></h2><p id="3f55" class="pw-post-body-paragraph jv jw in jx b jy lr ka kb kc ls ke kf kg lt ki kj kk lu km kn ko lv kq kr ks ig bi translated">客户的每一个订单都可以等同于一个API调用。当顾客点菜时，服务员🤵记下并将其传递给各自的<strong class="jx io">厨师</strong>👨‍🍳在厨房。</p><p id="b9fa" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">如果餐厅正在同步工作<strong class="jx io"/>，<strong class="jx io">服务员</strong>🤵会在厨房里等着，直到订单完成，这样就可以送到顾客手中。</p><p id="9f64" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这是一个问题😑。在准备食物的过程中，餐厅将暂停营业🚫。不会接受新的订单，不会提供食物，也不会安排餐桌。</p><p id="b177" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">如果餐厅以异步方式运行，这是可以避免的。</p><p id="e015" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">服务员</strong>🤵现在把订单交给厨房，继续他的工作，而<strong class="jx io">厨师</strong>👨‍🍳准备菜。一旦菜做好了，<strong class="jx io">厨师</strong>👨‍🍳将其放在<strong class="jx io">交付台</strong>上🍽️.现在<strong class="jx io">外卖经理</strong>👨‍💼接手并让<strong class="jx io">服务员</strong>🤵知道特定的<strong class="jx io"> <em class="nn">订单准备好了</em> </strong>。<strong class="jx io">服务员</strong>🤵然后可以接受订单并将其提供给客户。</p><p id="897a" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">结果，<strong class="jx io">服务员</strong>🤵因此，在准备食物时，餐厅操作<strong class="jx io">不会被阻止</strong>。</p></div><div class="ab cl mu mv hr mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="ig ih ii ij ik"><h2 id="d41d" class="nr ku in bd kv ns nt dn kz nu nv dp ld kg nw nx lh kk ny nz ll ko oa ob lp oc bi translated">复试</h2><p id="0c07" class="pw-post-body-paragraph jv jw in jx b jy lr ka kb kc ls ke kf kg lt ki kj kk lu km kn ko lv kq kr ks ig bi translated">JavaScript使用<strong class="jx io">回调</strong>来处理这样的操作📞。当订单被传递到厨房时，我们也传递一个<strong class="jx io">回调</strong>📞<strong class="jx io"> </strong>随遇而安。这个回调持有一个<strong class="jx io">音符</strong>📝话说<code class="fe mq mr ms mt b"><strong class="jx io">'Serve order to table X'</strong></code>。当订单准备好了，厨师👨‍🍳将准备好的菜肴连同<strong class="jx io">回拨</strong> <strong class="jx io">票据</strong>一起放置📝在<strong class="jx io">交付台上</strong>🍽️.<strong class="jx io">外卖经理</strong>👨‍💼然后打了一个<strong class="jx io">电话</strong>📞对着<strong class="jx io">服务员</strong>🤵对于那个特别的订单。<strong class="jx io">服务员</strong>🤵接收物品，阅读<strong class="jx io">备注</strong>📝并供应<strong class="jx io">工作台X </strong>上的物品。</p></div><div class="ab cl mu mv hr mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="ig ih ii ij ik"><h2 id="4f72" class="nr ku in bd kv ns nt dn kz nu nv dp ld kg nw nx lh kk ny nz ll ko oa ob lp oc bi translated"><strong class="ak">通过代码</strong>表示餐厅功能</h2><p id="2785" class="pw-post-body-paragraph jv jw in jx b jy lr ka kb kc ls ke kf kg lt ki kj kk lu km kn ko lv kq kr ks ig bi translated">以下功能负责完成每个订单。</p><blockquote class="nk nl nm"><p id="4f57" class="jv jw nn jx b jy jz ka kb kc kd ke kf no kh ki kj np kl km kn nq kp kq kr ks ig bi translated"><strong class="jx io"> <em class="in"> prepareItem(itemName，callback) </em> </strong>:该函数取一个<strong class="jx io"><em class="in">itemName</em></strong><em class="in">🍔</em>和<strong class="jx io">回调</strong>和<em class="in">📞</em>作为参数。使用<strong class="jx io">设置超时</strong>和<em class="in">模拟准备物品⏰</em>在指定的<strong class="jx io">超时</strong> <em class="in">后触发的API⏳</em>(准备时间)。使用<strong class="jx io"> <em class="in">项目名称</em> </strong>选择准备时间，并根据准备时间设置超时。一旦<strong class="jx io">超时</strong>T61】⏰触发，它调用传入的回调函数。</p></blockquote><pre class="lx ly lz ma gt od mt oe of aw og bi"><span id="1533" class="nr ku in mt b gy oh oi l oj ok">function prepareItem(itemName, callback){<br/>    Let preparationTime = 0;<br/>    switch(itemName){<br/>        case "coffee☕": preparationTime = 4000; break;<br/>        case "soda🥤": preparationTime = 2000; break;<br/>        case "frenchFries🍟": preparationTime = 5000; break;<br/>        case "hamburger🍔": preparationTime = 3000; break;<br/>        case "sandwich🥪": preparationTime = 6000; break;<br/>        default: preparationTime = 1000;<br/>    }<br/>    setTimeout(()=&gt;{<br/>        console.log(itemName + 'Prepared');<br/>        callback();<br/>    },preparationTime);<br/>}</span><span id="b886" class="nr ku in mt b gy ol oi l oj ok">function serveOrder(){<br/>    console.log('Order Served');<br/>}</span></pre><blockquote class="nk nl nm"><p id="45b3" class="jv jw nn jx b jy jz ka kb kc kd ke kf no kh ki kj np kl km kn nq kp kq kr ks ig bi translated"><strong class="jx io"><em class="in">serveOrder()</em>:</strong>该功能在<strong class="jx io">控制台</strong> <em class="in">上打印<code class="fe mq mr ms mt b"><strong class="jx io">'Order Served'</strong></code>💻</em>。一旦订单中的项目准备完毕，就应该调用它。</p></blockquote><pre class="lx ly lz ma gt od mt oe of aw og bi"><span id="38a9" class="nr ku in mt b gy oh oi l oj ok">function serveOrder(){<br/>    console.log('Order Served');<br/>}</span></pre><p id="3d14" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io"> prepareItem() </strong>函数现在可以通过传递<code class="fe mq mr ms mt b"><strong class="jx io">"coffee</strong>☕"</code>作为<strong class="jx io"> itemName </strong>和<strong class="jx io"> serveOrder() </strong>方法作为<strong class="jx io">回调来调用(注意</strong>📝<strong class="jx io"> ) </strong></p><pre class="lx ly lz ma gt od mt oe of aw og bi"><span id="ee3b" class="nr ku in mt b gy oh oi l oj ok">prepareItem("coffee☕", serveOrder);</span></pre><p id="97cc" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这个函数调用可以包装在一个<strong class="jx io"> submitOrder() </strong>函数中，以实现更好的模块化。</p><pre class="lx ly lz ma gt od mt oe of aw og bi"><span id="5da8" class="nr ku in mt b gy oh oi l oj ok">function submitOrder(){<br/>    prepareItem("coffee☕", serveOrder);<br/>}<br/>submitOrder();</span></pre><p id="105c" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这很好，但还不够🤨。如果客户的订单包含<strong class="jx io">三个相关项目，该怎么办？</strong></p><pre class="lx ly lz ma gt od mt oe of aw og bi"><span id="b76b" class="nr ku in mt b gy oh oi l oj ok"><strong class="mt io">["hamburger</strong>🍔<strong class="mt io">", "frenchFries</strong>🍟<strong class="mt io">", "soda</strong>🥤<strong class="mt io">"]</strong></span></pre><p id="4d27" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这三项中的任何一项，如果分开上，都是没有用的。需要一起上。这导致了一个新的问题🙄。</p><p id="30e1" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">如果<strong class="jx io">服务员</strong>🤵将所有三个项目的订单放在一起，<strong class="jx io"> submitOrder() </strong>函数如下所示:</p><pre class="lx ly lz ma gt od mt oe of aw og bi"><span id="1b83" class="nr ku in mt b gy oh oi l oj ok">function submitOrder(){<br/>    prepareItem(<strong class="mt io">"</strong>hamburger🍔<strong class="mt io">"</strong>, serveOrder);<br/>    prepareItem(<!-- -->"frenchFries🍟"<!-- -->, serveOrder);<br/>    prepareItem(<!-- -->"soda🥤"<!-- -->, serveOrder);<br/>}<br/>submitOrder();</span></pre><p id="615a" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这不会产生预期的结果😕因为这些项目可能会无序到达。</p><h2 id="f2eb" class="nr ku in bd kv ns nt dn kz nu nv dp ld kg nw nx lh kk ny nz ll ko oa ob lp oc bi translated">嵌套回调</h2><p id="c97b" class="pw-post-body-paragraph jv jw in jx b jy lr ka kb kc ls ke kf kg lt ki kj kk lu km kn ko lv kq kr ks ig bi translated">如果使用<strong class="jx io">嵌套回调</strong> <code class="fe mq mr ms mt b">📞📞📞</code>可以解决这个问题。</p><p id="c296" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">服务员</strong>🤵将<code class="fe mq mr ms mt b"><strong class="jx io">"hamburger</strong>🍔<strong class="jx io">"</strong></code>的订单提交给相应的<strong class="jx io">厨师</strong>👨‍🍳并且传递一个<strong class="jx io">回调</strong>连同它具有下面的<strong class="jx io">音符</strong>📝</p><pre class="lx ly lz ma gt od mt oe of aw og bi"><span id="aa8a" class="nr ku in mt b gy oh oi l oj ok"><strong class="mt io">* Submit Order for "</strong><strong class="mt io">frenchFries</strong>🍟<strong class="mt io">"</strong><br/><strong class="mt io">* Submit Order for </strong><strong class="mt io">"soda</strong>🥤<strong class="mt io">"</strong><br/><strong class="mt io">* Serve items to table X</strong></span></pre><p id="16ee" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">一旦订单完成，厨师就会👨‍🍳将其放置在<strong class="jx io">传送台上</strong>🍽️和外卖经理👨‍💼发出一个<strong class="jx io">呼叫</strong>📞对了<strong class="jx io">服务员</strong>🤵像往常一样。</p><p id="7e64" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">服务员</strong>🤵移除<strong class="jx io">注释</strong>📝在顶部，阅读它并按照提示提交<code class="fe mq mr ms mt b">"<strong class="jx io">frenchFries</strong>🍟"</code>的订单。<code class="fe mq mr ms mt b"><strong class="jx io">"hamburger</strong>🍔<strong class="jx io">"</strong></code>不会立即交付。<code class="fe mq mr ms mt b">"<strong class="jx io">frenchFries</strong>🍟"</code>的订单与剩余的<strong class="jx io">回拨</strong> <strong class="jx io">票据</strong>一起下单📝。</p><pre class="lx ly lz ma gt od mt oe of aw og bi"><span id="56c6" class="nr ku in mt b gy oh oi l oj ok"><strong class="mt io">* Submit Order for </strong><strong class="mt io">"soda</strong>🥤<strong class="mt io">"</strong><br/><strong class="mt io">* Serve items to table X</strong></span></pre><p id="af90" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">一旦第二个订单完成，商品到达<strong class="jx io">交付台</strong>🍽️ <strong class="jx io"> </strong>和服务员<strong class="jx io"/>🤵<strong class="jx io">是叫</strong>吗📞又来了。现在，这位<strong class="jx io">侍者</strong>🤵删除<strong class="jx io">注释</strong>📝在顶部，阅读并提交订单<code class="fe mq mr ms mt b"><strong class="jx io">"soda</strong>🥤<strong class="jx io">"</strong></code>。<code class="fe mq mr ms mt b"><strong class="jx io">"hamburger</strong>🍔<strong class="jx io">" </strong></code>和<code class="fe mq mr ms mt b">"<strong class="jx io">frenchFries</strong>🍟"</code>尚未交付。该订单与最后一次<strong class="jx io">回拨</strong> <strong class="jx io">通知</strong>一起发出📝。</p><pre class="lx ly lz ma gt od mt oe of aw og bi"><span id="2389" class="nr ku in mt b gy oh oi l oj ok"><strong class="mt io">* Serve items to table X</strong></span></pre><p id="b553" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">订单完成后，商品到达<strong class="jx io">交付台</strong>🍽️和那个<strong class="jx io">服务员</strong>🤵<strong class="jx io">是叫</strong>吗📞再一次。现在，<strong class="jx io">回调</strong> <strong class="jx io">注意</strong>📝说要上菜。因此，他将<strong class="jx io">桌子X </strong>上的所有项目一起端上桌。</p></div><div class="ab cl mu mv hr mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="ig ih ii ij ik"><p id="e171" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">使用<strong class="jx io">嵌套回调</strong>的<strong class="jx io"> submitOrder() </strong>函数如下。</p><pre class="lx ly lz ma gt od mt oe of aw og bi"><span id="723e" class="nr ku in mt b gy oh oi l oj ok">function submitOrder(){<br/>    prepareItem(<strong class="mt io">"</strong>hamburger🍔<strong class="mt io">"</strong>, ()=&gt;{<br/>        prepareItem(<!-- -->"frenchFries🍟"<!-- -->, ()=&gt;{<br/>            prepareItem(<!-- -->"soda🥤"<!-- -->, serveOrder);<br/>        });<br/>    });<br/>}<br/>submitOrder();</span></pre><figure class="lx ly lz ma gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi om"><img src="../Images/372abaf435cbe7088bdc7e8279241b0c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lcCQLMx5QvZeacvAAtT6_g.png"/></div></div></figure><p id="ca22" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">上面的序列图显示了三个不同项目的订单之间的时间安排。</p></div><div class="ab cl mu mv hr mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="ig ih ii ij ik"><p id="f595" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这三个项目的订单本身是相当压倒性的，对不对？😅如果我们有更多的东西。本例中的<strong class="jx io"> submitOrder() </strong>函数可能看起来有点像这样😵。</p><pre class="lx ly lz ma gt od mt oe of aw og bi"><span id="6ae8" class="nr ku in mt b gy oh oi l oj ok">function submitOrder(){<br/>    prepareItem("coffee☕", ()=&gt; {<br/>        prepareItem("soda🥤", ()=&gt; {<br/>            prepareItem("frenchFries🍟", ()=&gt; {<br/>                prepareItem("hamburger🍔", ()=&gt; {<br/>                    prepareItem("sandwitch🥪", serveOrder);<br/>                });<br/>            });<br/>        });<br/>    });<br/>}<br/>submitOrder();</span></pre><p id="85f9" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这种代码的可读性在每次嵌套后都会降低，并且变得难以维护。这种代码通常被称为<strong class="jx io">‘回调地狱’</strong>👹。</p><h1 id="9741" class="kt ku in bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated"><strong class="ak">承诺</strong></h1><p id="4468" class="pw-post-body-paragraph jv jw in jx b jy lr ka kb kc ls ke kf kg lt ki kj kk lu km kn ko lv kq kr ks ig bi translated">ES6版JavaScript推出<a class="ae mk" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise" rel="noopener ugc nofollow" target="_blank"> <strong class="jx io">承诺</strong> </a>🤝来处理这样的问题。一个<strong class="jx io">承诺</strong>是一个<strong class="jx io">对象</strong>，代表一个异步操作的<strong class="jx io">最终完成或失败</strong>。</p><p id="fe90" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">一边用<strong class="jx io">许诺</strong>，一边用<strong class="jx io">招待</strong>🤵得到一个<strong class="jx io">承诺</strong>🤝<strong class="jx io"> </strong>下单时回退。在这种情况下，没有回叫通知被传递到厨房。<strong class="jx io">服务员</strong>🤵然后附上一张<strong class="jx io">的字条</strong>📝也就是说，<strong class="jx io"> <em class="nn">承诺解决后需要做什么</em> </strong>，到<strong class="jx io">承诺</strong>🤝一直藏在心里。在我们的示例中，附加的注释将是:</p><pre class="lx ly lz ma gt od mt oe of aw og bi"><span id="601d" class="nr ku in mt b gy oh oi l oj ok"><strong class="mt io">* Serve item to table X</strong></span></pre><p id="fc09" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">当订单准备好了，厨师<strong class="jx io">👨‍🍳将其放置在<strong class="jx io">交付台</strong>🍽️连同<code class="fe mq mr ms mt b"><strong class="jx io">'Promise Resolved </strong>✅'</code>消息。</strong></p><p id="421a" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io">外卖经理</strong>👨‍💼然后把订单交给<strong class="jx io">服务员</strong>🤵。然后他找到匹配的<strong class="jx io">承诺</strong>🤝从他那套<strong class="jx io">的承诺</strong>中，读出了附在后面的<strong class="jx io">注释</strong>📝并供应<strong class="jx io">工作台X </strong>上的物品。</p></div><div class="ab cl mu mv hr mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="ig ih ii ij ik"><h2 id="ce3a" class="nr ku in bd kv ns nt dn kz nu nv dp ld kg nw nx lh kk ny nz ll ko oa ob lp oc bi translated"><strong class="ak">承诺代码实现</strong></h2><p id="6262" class="pw-post-body-paragraph jv jw in jx b jy lr ka kb kc ls ke kf kg lt ki kj kk lu km kn ko lv kq kr ks ig bi translated">我们可以重写<strong class="jx io"> prepareItem() </strong>函数来返回一个<strong class="jx io">承诺</strong>🤝如下。</p><pre class="lx ly lz ma gt od mt oe of aw og bi"><span id="c5e1" class="nr ku in mt b gy oh oi l oj ok">function prepareItem(item){<br/>    let preparationTime = 0;<br/>    switch(item){<br/>        case "coffee☕": preparationTime = 4000; break;<br/>        case "soda🥤": preparationTime = 2000; break;<br/>        case "frenchFries🍟": preparationTime = 5000; break;<br/>        case "hamburger🍔": preparationTime = 3000; break;<br/>        case "sandwich🥪": preparationTime = 6000; break;<br/>        default: preparationTime = 1000;<br/>    }<br/>    return new <strong class="mt io">Promise</strong>((resolve, reject) =&gt; {<br/>        setTimeout(()=&gt;{<br/>            console.log(item + 'Prepared');<br/>            resolve();<br/>        },preparationTime);<br/>    });<br/>}</span></pre><p id="0a2d" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">该函数不再将一个<strong class="jx io">回调</strong>函数作为参数，而是返回一个新的<strong class="jx io">承诺对象</strong>。该承诺采用一个匿名函数，让<strong class="jx io">解决</strong> ✅和<strong class="jx io">拒绝</strong> ❌作为参数。如果操作<strong class="jx io"> <em class="nn">成功</em> </strong>或者有<strong class="jx io"> <em class="nn">错误</em> </strong>我们可以调用<strong class="jx io"> resolve() </strong>而不是调用回调函数。</p><p id="8e10" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">使用上面的<strong class="jx io"> prepareItem() </strong>实现，单个项目的<strong class="jx io"> submitOrder() </strong>函数可以编写如下。</p><pre class="lx ly lz ma gt od mt oe of aw og bi"><span id="9b9a" class="nr ku in mt b gy oh oi l oj ok">function submitOrder(){<br/>    let res = prepareItem("coffee☕");<br/>    res.then(serveOrder);<br/>}<br/>submitOrder();</span></pre><figure class="lx ly lz ma gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi on"><img src="../Images/156a1ac41cd9d8f37f71546fafc8fb25.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JL4iJVS5mLz9B4j1roMeOA.png"/></div></div><figcaption class="ng nh gj gh gi ni nj bd b be z dk">Callbacks vs Promises</figcaption></figure><h2 id="8dfa" class="nr ku in bd kv ns nt dn kz nu nv dp ld kg nw nx lh kk ny nz ll ko oa ob lp oc bi translated"><strong class="ak">承诺链接:</strong></h2><p id="4ac6" class="pw-post-body-paragraph jv jw in jx b jy lr ka kb kc ls ke kf kg lt ki kj kk lu km kn ko lv kq kr ks ig bi translated"><strong class="jx io">承诺链接</strong> <code class="fe mq mr ms mt b">🤝🔗🤝🔗🤝</code> <strong class="jx io"> </strong>是解决嵌套回调导致的回调地狱情况。</p><p id="e3ff" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">promise响应上的'<strong class="jx io"> then() </strong>'调用将函数作为参数。这个回调函数可能返回另一个<strong class="jx io">承诺</strong>🤝。这个新<strong class="jx io">承诺的回应</strong>🤝可以通过<a class="ae mk" href="https://www.tutorialspoint.com/what-is-function-chaining-in-javascript" rel="noopener ugc nofollow" target="_blank">链接</a> ⛓' <strong class="jx io">然后()</strong>调用来访问。</p><p id="39e5" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">使用承诺序列的<strong class="jx io"> submitOrder() </strong>函数可以是这样的:</p><pre class="lx ly lz ma gt od mt oe of aw og bi"><span id="ed77" class="nr ku in mt b gy oh oi l oj ok">function submitOrder() {<br/>    let res1 = prepareItem("hamburger🍔");<br/>    let res2 = res1.then(() =&gt; {<br/>        return prepareItem("frenchFries🍟");<br/>    });<br/>    let res3 = res2.then(() =&gt; {<br/>        return prepareItem("soda🥤"); <br/>    });<br/>    res3.then(serveOrder);<br/>}<br/>submitOrder();</span></pre><p id="2884" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这可以通过删除<strong class="jx io">回车</strong>关键字进一步简化，如下所示:</p><pre class="lx ly lz ma gt od mt oe of aw og bi"><span id="3920" class="nr ku in mt b gy oh oi l oj ok">function submitOrder() {<br/>    let res1 = prepareItem("hamburger🍔");<br/>    let res2 = res1.then(() =&gt; prepareItem("frenchFries🍟"));<br/>    let res3 = res2.then(() =&gt; prepareItem("soda🥤"));<br/>    res3.then(serveOrder);<br/>}<br/>submitOrder();</span></pre><p id="b4f8" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">对单独响应变量的赋值可以通过<strong class="jx io">链接</strong>⛓'<strong class="jx io">then()【t48]'调用来移除，如下所示:</strong></p><pre class="lx ly lz ma gt od mt oe of aw og bi"><span id="3dfe" class="nr ku in mt b gy oh oi l oj ok">function submitOrder() {<br/>    prepareItem("hamburger🍔")<br/>        .then(() =&gt; prepareItem("frenchFries🍟"))<br/>        .then(() =&gt; prepareItem("soda🥤"))<br/>        .then(serveOrder);<br/>}<br/>submitOrder();</span></pre><p id="21e4" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这看起来比使用嵌套回调更加清晰易读。</p><figure class="lx ly lz ma gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi om"><img src="../Images/bc60013badc4fee11b94cdae3fbd0ad1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Hv8XPM1Es3tAwOdnigwBUw.png"/></div></div><figcaption class="ng nh gj gh gi ni nj bd b be z dk">Sequence diagram for Promise chaining</figcaption></figure><p id="8549" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">当订单中有更多项目时，<strong class="jx io"> submitOrder() </strong>函数可能如下所示:</p><pre class="lx ly lz ma gt od mt oe of aw og bi"><span id="c9b7" class="nr ku in mt b gy oh oi l oj ok">function submitOrder(){<br/>    prepareItem("coffee☕")<br/>        .then(() =&gt; prepareItem("soda🥤"))<br/>        .then(() =&gt; prepareItem("frenchFries🍟"))<br/>        .then(() =&gt; prepareItem("hamburger🍔"))<br/>        .then(() =&gt; prepareItem("sandwich🥪"))<br/>        .then(serveOrder);<br/>}<br/>submitOrder();</span></pre><h1 id="ca46" class="kt ku in bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated"><strong class="ak">异步/等待</strong></h1><p id="245b" class="pw-post-body-paragraph jv jw in jx b jy lr ka kb kc ls ke kf kg lt ki kj kk lu km kn ko lv kq kr ks ig bi translated">JavaScript在2017年加入了<a class="ae mk" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/async_function" rel="noopener ugc nofollow" target="_blank"> <strong class="jx io"> async/await </strong> </a>语法。这基本上就是<strong class="jx io">句法糖</strong>🍚对于<strong class="jx io">的承诺</strong>🤝这使得异步代码看起来更有顺序<strong class="jx io"/>和<strong class="jx io"> </strong>使得代码更容易阅读。</p><p id="ed8d" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><strong class="jx io"> submitOrder() </strong>函数可以使用下面的<strong class="jx io"> async/await </strong>语法编写:</p><pre class="lx ly lz ma gt od mt oe of aw og bi"><span id="ee95" class="nr ku in mt b gy oh oi l oj ok">async function submitOrder(){<br/>    await prepareItem("coffee☕");<br/>    await prepareItem("soda🥤");<br/>    await prepareItem("frenchFries🍟");<br/>    await prepareItem("hamburger🍔");<br/>    await prepareItem("sandwich🥪");<br/>    completeOrder();<br/>}<br/>submitOrder();</span></pre><p id="a6f3" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">需要将<strong class="jx io">等待</strong>调用包装在一个<strong class="jx io">异步</strong>函数中。所以，<strong class="jx io"> submitOrder() </strong>函数现在被标记为<strong class="jx io"> async </strong>。这可以像任何其他函数一样调用。</p><p id="0702" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">代码现在看起来更加清晰易读。它看起来是连续的，但实际上是对承诺的抽象。</p><h1 id="9732" class="kt ku in bd kv kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated"><strong class="ak">结论</strong></h1><p id="43fa" class="pw-post-body-paragraph jv jw in jx b jy lr ka kb kc ls ke kf kg lt ki kj kk lu km kn ko lv kq kr ks ig bi translated">总结一下，我们看了如何在一家<strong class="jx io">餐馆</strong>的工作中建模JavaScript的<strong class="jx io">异步</strong>行为🤵👨‍🍳👨‍💼🍽️.然后，我们以餐馆代码为例，研究了JavaScript用来建模这种异步行为的不同方法。</p><p id="22a6" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我们用餐馆的例子来说明基于<strong class="jx io">回访</strong>的方法和基于<strong class="jx io">承诺</strong>的方法之间的区别。我们还提到了如何将基于承诺的代码转换成<strong class="jx io"> async/await </strong>语法。</p><p id="5f3f" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><em class="nn">更多内容请看</em> <a class="ae mk" href="http://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="jx io"> <em class="nn">说白了就是</em> </strong> </a> <em class="nn">。报名参加我们的</em> <a class="ae mk" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="jx io"> <em class="nn">免费周报在这里</em> </strong> </a> <strong class="jx io"> <em class="nn">。</em> </strong></p></div></div>    
</body>
</html>