<html>
<head>
<title>How to Implement the STOMP Protocol using RabbitMQ with Ballerina</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用RabbitMQ和Ballerina实现STOMP协议</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/how-to-implement-the-stomp-protocol-using-rabbitmq-with-ballerina-170d10f81359?source=collection_archive---------10-----------------------#2021-06-15">https://javascript.plainenglish.io/how-to-implement-the-stomp-protocol-using-rabbitmq-with-ballerina-170d10f81359?source=collection_archive---------10-----------------------#2021-06-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="128c" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">JavaScript中的连接和实现</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/68075fc9d61f769f19288d66a70b0f57.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*5p24VGAJDkwWX401.jpg"/></div></div></figure><p id="1c18" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">今天，我将用JavaScript和芭蕾舞语言来写STOMP的实现。</p><blockquote class="ln lo lp"><p id="cbb1" class="kr ks lq kt b ku kv jr kw kx ky ju kz lr lb lc ld ls lf lg lh lt lj lk ll lm ij bi translated">STOMP 是一种可互操作的协议，设计用于通过中介服务器在客户端之间传递异步消息。</p></blockquote><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi lu"><img src="../Images/5b47f3794134ced2b0d3cbbe667aad73.png" data-original-src="https://miro.medium.com/v2/resize:fit:1134/format:webp/1*sfHlX5nhl8T_S0K2DG6vPw.png"/></div></figure><h1 id="17c3" class="lv lw iq bd lx ly lz ma mb mc md me mf jw mg jx mh jz mi ka mj kc mk kd ml mm bi translated">方案</h1><p id="2c39" class="pw-post-body-paragraph kr ks iq kt b ku mn jr kw kx mo ju kz la mp lc ld le mq lg lh li mr lk ll lm ij bi translated">随着企业世界中数字营销的出现，组织需要能够在官方网站上发布公司更新和新闻。无需手动更新每个媒体频道，组织可以将消息发布到订阅者正在收听的队列或主题中。每个订阅者都有一个连接到任何媒体的服务，并将发布的消息发布到队列/主题。让我们看看芭蕾舞演员如何轻松实现这一点。</p><h1 id="867b" class="lv lw iq bd lx ly lz ma mb mc md me mf jw mg jx mh jz mi ka mj kc mk kd ml mm bi translated">怎么做？</h1><h1 id="259b" class="lv lw iq bd lx ly lz ma mb mc md me mf jw mg jx mh jz mi ka mj kc mk kd ml mm bi translated">设置环境</h1><ol class=""><li id="3d52" class="ms mt iq kt b ku mn kx mo la mu le mv li mw lm mx my mz na bi translated">首先，去<a class="ae nb" href="http://ballerinalang.org/" rel="noopener ugc nofollow" target="_blank">芭蕾舞郎</a>网站下载最新的芭蕾舞演员分布。</li></ol><p id="3619" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kt ir">注:</strong>此场景在芭蕾舞演员0.990.2版本上测试</p><p id="656d" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">2.按照以下说明下载并安装RabbitMQ broker:</p><p id="cab9" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><a class="ae nb" href="https://www.rabbitmq.com/download.html" rel="noopener ugc nofollow" target="_blank">https://www.rabbitmq.com/download.html</a></p><p id="0c5d" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">3.配置RabbitMQ代理的STOMP插件，以便启用与STOMP相关的消息事务。</p><p id="2f14" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><a class="ae nb" href="https://www.rabbitmq.com/stomp.html" rel="noopener ugc nofollow" target="_blank">https://www.rabbitmq.com/stomp.html</a></p><p id="b2cb" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">还有关于如何为兔子启用跺脚插件的视频教程q:<a class="ae nb" href="https://www.youtube.com/watch?v=LEjOmn8dfDg" rel="noopener ugc nofollow" target="_blank">https://www.youtube.com/watch?v=LEjOmn8dfDg</a></p><p id="14e1" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">4.使用终端命令(Linux)启动RabbitMQ代理:</p><pre class="kg kh ki kj gt nc nd ne nf aw ng bi"><span id="cdb8" class="nh lw iq nd b gy ni nj l nk nl">// To start the broker<br/>invoke-rc.d rabbitmq-server start</span><span id="4397" class="nh lw iq nd b gy nm nj l nk nl">// To get the status of the broker<br/>invoke-rc.d rabbitmq-server status</span><span id="4977" class="nh lw iq nd b gy nm nj l nk nl">// To stop the broker<br/>invoke-rc.d rabbitmq-server stop</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nn"><img src="../Images/d57df1bfe8a40067652d5e97389b1601.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*43zVjN2PqyeQY4OfOKp6hw.png"/></div></div><figcaption class="no np gj gh gi nq nr bd b be z dk">RabbitMQ Broker’s status on terminal once started</figcaption></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ns"><img src="../Images/aa18d0f4488e3ec8283ff7f876093b23.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oNCAe935C7zezBba9eXKww.png"/></div></div></figure><h1 id="721e" class="lv lw iq bd lx ly lz ma mb mc md me mf jw mg jx mh jz mi ka mj kc mk kd ml mm bi translated">连接建立</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nt"><img src="../Images/8c754027a36a239927857e93b6463c33.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*MGaTrawLWXydVJMR"/></div></div></figure><p id="0fb1" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">通过发送<strong class="kt ir"> CONNECT </strong>帧建立TCP套接字连接，连接到消息代理。</p><pre class="kg kh ki kj gt nc nd ne nf aw ng bi"><span id="b1e7" class="nh lw iq nd b gy ni nj l nk nl">CONNECT<br/>accept-<strong class="nd ir">version</strong>:1.0<strong class="nd ir">,</strong>1.1<strong class="nd ir">,</strong>2.0<br/>login:guest<br/>passcode:guest<br/>host:/</span><span id="2bc5" class="nh lw iq nd b gy nm nj l nk nl">^@</span><span id="e2d3" class="nh lw iq nd b gy nm nj l nk nl">--------------------------------------------------------------------</span><span id="2a4c" class="nh lw iq nd b gy nm nj l nk nl"><strong class="nd ir">string </strong>connect = <br/><strong class="nd ir">"CONNECT" </strong>+ <strong class="nd ir">"\n" </strong>+ <br/><strong class="nd ir">"accept-version:" </strong>+ acceptVersions + <strong class="nd ir">"\n" </strong>+<br/><strong class="nd ir">"login:" </strong>+ logins + <strong class="nd ir">"\n" </strong>+ <br/><strong class="nd ir">"passcode:" </strong>+ passcodes + <strong class="nd ir">"\n" </strong>+<br/><strong class="nd ir">"host:" </strong>+ vhosts + <strong class="nd ir">"\n" <br/></strong>+ <strong class="nd ir">"\n" </strong>+<br/>self.endOfFrame<strong class="nd ir">;</strong></span></pre><p id="8420" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">作为返回消息，broker将回复一个连接的回执。</p><pre class="kg kh ki kj gt nc nd ne nf aw ng bi"><span id="5f7b" class="nh lw iq nd b gy ni nj l nk nl"><strong class="nd ir">CONNECTED</strong><br/>server:RabbitMQ/3.6.15<br/>session:session--CMKQ6EeCxX5gawh8A6qdQ<br/>heart-beat:0,0<br/>version:1.1</span></pre><h1 id="6e00" class="lv lw iq bd lx ly lz ma mb mc md me mf jw mg jx mh jz mi ka mj kc mk kd ml mm bi translated">我们开始吧，</h1><h1 id="e468" class="lv lw iq bd lx ly lz ma mb mc md me mf jw mg jx mh jz mi ka mj kc mk kd ml mm bi translated">将消息发布到队列/主题/交换</h1><blockquote class="ln lo lp"><p id="b981" class="kr ks lq kt b ku kv jr kw kx ky ju kz lr lb lc ld ls lf lg lh lt lj lk ll lm ij bi translated"><strong class="kt ir"> <em class="iq">工作目录结构:</em> </strong></p></blockquote><p id="5d90" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">/根文件夹<br/>├──my . stomp<br/>│└──sender . bal<br/>├──publisher . bal</p><p id="a0d0" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kt ir"> Publisher.bal </strong></p><p id="64ec" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">开始时，消息发布者将通过发送<strong class="kt ir"> CONNECT </strong>帧建立TCP套接字连接来连接到消息代理，并将生成消息并通过事务块内的<strong class="kt ir"> SEND </strong>帧将其发送到消息代理。</p><pre class="kg kh ki kj gt nc nd ne nf aw ng bi"><span id="6ebe" class="nh lw iq nd b gy ni nj l nk nl"><strong class="nd ir">import </strong>my.stomp<strong class="nd ir">;<br/>import </strong>ballerina/log<strong class="nd ir">;<br/>import </strong>ballerina/io<strong class="nd ir">;<br/>import </strong>ballerina/socket<strong class="nd ir">;<br/>import </strong>ballerina/transactions<strong class="nd ir">;</strong></span><span id="5959" class="nh lw iq nd b gy nm nj l nk nl">// This initializes a STOMP connection with the STOMP broker.<br/>stomp:Sender stompSender = <strong class="nd ir">new</strong>({<br/>        host: <strong class="nd ir">"localhost",<br/>        </strong>port: 61613<strong class="nd ir">,<br/>        </strong>login: <strong class="nd ir">"guest",<br/>        </strong>passcode: <strong class="nd ir">"guest",<br/>        </strong>vhost: <strong class="nd ir">"/",<br/>        </strong>acceptVersion: <strong class="nd ir">"1.1"<br/>    </strong>})<strong class="nd ir">;</strong></span><span id="0139" class="nh lw iq nd b gy nm nj l nk nl"><strong class="nd ir">public function </strong>main() {<br/>    // Message is published within the transaction block.<br/>    // Each message sent should be received from other end else    <br/>    // rollback to retry the message along with transaction Id.<br/>    <strong class="nd ir">transaction </strong>{<br/>        // This sends the Ballerina message to the stomp broker.<br/>        <strong class="nd ir">string </strong>message = <strong class="nd ir">"Hello World From Ballerina";<br/>        string </strong>destination = <strong class="nd ir">"/queue/test";<br/>        var </strong>broadcast = stompSender<strong class="nd ir">-&gt;</strong>send(message<strong class="nd ir">,</strong>destination);</span><span id="9d1c" class="nh lw iq nd b gy nm nj l nk nl">    }<br/>}</span></pre><p id="cf92" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kt ir"> Publisher.out </strong></p><pre class="kg kh ki kj gt nc nd ne nf aw ng bi"><span id="873f" class="nh lw iq nd b gy ni nj l nk nl"># To run the client, navigate to the directory that contains the<br/># `.bal` file and use the `ballerina run --experimental` command.<strong class="nd ir"><br/>$ ballerina run --experimental publisher.bal</strong></span><span id="4da3" class="nh lw iq nd b gy nm nj l nk nl"><strong class="nd ir">[ballerina/http]</strong> started HTTP/WS endpoint 172.17.0.1:38163<br/>Starting up the Ballerina Stomp Service</span><span id="0326" class="nh lw iq nd b gy nm nj l nk nl">Successfully connected to stomp broker<br/>Connect to: 61613<br/>CONNECTED<br/>server:RabbitMQ/3.6.15<br/>session:session-ayVnDSHIzcO5_iTmH9tafA<br/>heart-beat:0,0<br/>version:1.1</span><span id="9985" class="nh lw iq nd b gy nm nj l nk nl"><strong class="nd ir"># transaction has started</strong><br/>Begin has been made with transaction: b632dfdb-e182-44bd-a2f7-66652129183c<br/>2019-02-21 11:01:33,882 INFO  [ballerina/transactions] - Created transaction: 7feaf167-de8e-446a-a71f-5982f82af488<br/>Message: Hello World From Ballerina is sent successfully<br/>RECEIPT<br/>receipt-id:abee3b5e-a3b6-4ae9-aeb2-fa127c840aaf</span><span id="fe9c" class="nh lw iq nd b gy nm nj l nk nl"><strong class="nd ir"># disconnecting from the broker port</strong><br/>Disconnected from stomp broker successfully<br/>Leave from: 61613<br/>2019-02-21 11:01:38,960 INFO  [ballerina/transactions] - Running 2-phase commit for transaction: 7feaf167-de8e-446a-a71f-5982f82af488:$anon$.$1<br/>RECEIPT<br/>receipt-id:abee3b5e-a3b6-4ae9-aeb2-fa127c840aaf</span></pre><p id="d369" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kt ir"> Sender.bal(对象)</strong></p><pre class="kg kh ki kj gt nc nd ne nf aw ng bi"><span id="c049" class="nh lw iq nd b gy ni nj l nk nl"><strong class="nd ir">import </strong>ballerina/socket<strong class="nd ir">;<br/>import </strong>ballerina/io<strong class="nd ir">;<br/>import </strong>ballerina/log<strong class="nd ir">;<br/>import </strong>ballerina/runtime<strong class="nd ir">;<br/>import </strong>ballerina/system<strong class="nd ir">;</strong></span><span id="275e" class="nh lw iq nd b gy nm nj l nk nl"><em class="lq"># Configurations related to a STOMP connection<br/>#<br/># </em>+ host - <em class="lq">STOMP provider url.<br/># </em>+ port - <em class="lq">STOMP port.<br/># </em>+ config - <em class="lq">Config.<br/># </em>+ login - <em class="lq">STOMP user login.<br/># </em>+ passcode - <em class="lq">STOMP passcode.<br/># </em>+ vhost - <em class="lq">default stomp vhost.<br/># </em>+ acceptVersion - <em class="lq">1.1.<br/># </em>+ socketClient - <em class="lq">socketConnection.<br/># </em>+ endOfFrame - <em class="lq">null octet.</em></span><span id="8689" class="nh lw iq nd b gy nm nj l nk nl"><strong class="nd ir">public type </strong>Sender <strong class="nd ir">client object </strong>{</span><span id="dd52" class="nh lw iq nd b gy nm nj l nk nl">    <strong class="nd ir">public string </strong>host = <strong class="nd ir">"";<br/>    public int </strong>port = 0<strong class="nd ir">;<br/>    public string </strong>login = <strong class="nd ir">"";<br/>    public string </strong>passcode = <strong class="nd ir">"";<br/>    public string </strong>vhost = <strong class="nd ir">"";<br/>    public string </strong>acceptVersion = <strong class="nd ir">"";<br/>    private </strong>socket:Client socketClient<strong class="nd ir">;</strong></span><span id="4efd" class="nh lw iq nd b gy nm nj l nk nl"><strong class="nd ir">    </strong>// End of frame used a null octet (^@ = \u0000).<br/>    <strong class="nd ir">public string </strong>endOfFrame = <strong class="nd ir">"\u0000";</strong></span><span id="de4e" class="nh lw iq nd b gy nm nj l nk nl"><strong class="nd ir">    public </strong>ConnectionConfiguration config = {<br/>        host:host<strong class="nd ir">,<br/>        </strong>port:port<strong class="nd ir">,<br/>        </strong>login:login<strong class="nd ir">,<br/>        </strong>passcode:passcode<strong class="nd ir">,<br/>        </strong>vhost:vhost<strong class="nd ir">,<br/>        </strong>acceptVersion:acceptVersion<br/>    }<strong class="nd ir">;</strong></span><span id="ae01" class="nh lw iq nd b gy nm nj l nk nl"><strong class="nd ir">    public function __init</strong>(ConnectionConfiguration stompConfig) {<br/>        <strong class="nd ir">self</strong>.config = stompConfig<strong class="nd ir">;<br/>        self</strong>.host = stompConfig.host<strong class="nd ir">;<br/>        self</strong>.port = stompConfig.port<strong class="nd ir">;<br/>        self</strong>.login = stompConfig.login<strong class="nd ir">;<br/>        self</strong>.passcode = stompConfig.passcode<strong class="nd ir">;<br/>        self</strong>.vhost = stompConfig.vhost<strong class="nd ir">;<br/>        self</strong>.acceptVersion = stompConfig.acceptVersion<strong class="nd ir">;<br/>        self</strong>.socketClient = <strong class="nd ir">new</strong>({<br/>                host: <strong class="nd ir">self</strong>.host<strong class="nd ir">,<br/>                </strong>port: <strong class="nd ir">self</strong>.port<strong class="nd ir">,<br/>                </strong>callbackService: ClientService<br/>            })<strong class="nd ir">;<br/>        self-&gt;</strong>connect(stompConfig.host<strong class="nd ir">, </strong>stompConfig.port<strong class="nd ir">, </strong>stompConfig.login<strong class="nd ir">,<br/>            </strong>stompConfig.passcode<strong class="nd ir">,<br/>            </strong>stompConfig.vhost<strong class="nd ir">,<br/>            </strong>stompConfig.acceptVersion) <strong class="nd ir">;<br/>    </strong>}</span><span id="07b9" class="nh lw iq nd b gy nm nj l nk nl">    <strong class="nd ir">public remote function </strong>connect(<strong class="nd ir">string </strong>hosts<strong class="nd ir">,int </strong>ports<strong class="nd ir">,string </strong>logins<strong class="nd ir">, string </strong>passcodes<strong class="nd ir">, string </strong>vhosts<strong class="nd ir">, string </strong>acceptVersions)<strong class="nd ir">;</strong></span><span id="5298" class="nh lw iq nd b gy nm nj l nk nl"><strong class="nd ir">    public remote function </strong>begin()<strong class="nd ir">;</strong></span><span id="4441" class="nh lw iq nd b gy nm nj l nk nl"><strong class="nd ir">    public remote function </strong>send(<strong class="nd ir">string </strong>messages<strong class="nd ir">, string </strong>destinations)<strong class="nd ir">;</strong></span><span id="bf00" class="nh lw iq nd b gy nm nj l nk nl"><strong class="nd ir">    public remote function </strong>disconnect()<strong class="nd ir">;<br/></strong>}<strong class="nd ir">;</strong></span><span id="b1fa" class="nh lw iq nd b gy nm nj l nk nl"><strong class="nd ir">public type </strong>ConnectionConfiguration <strong class="nd ir">record </strong>{<br/>    <strong class="nd ir">string </strong>host<strong class="nd ir">;<br/>    int </strong>port<strong class="nd ir">;<br/>    string </strong>login<strong class="nd ir">;<br/>    string </strong>passcode<strong class="nd ir">;<br/>    string </strong>vhost<strong class="nd ir">;<br/>    string </strong>acceptVersion<strong class="nd ir">;<br/></strong>}<strong class="nd ir">;</strong></span><span id="c210" class="nh lw iq nd b gy nm nj l nk nl"><strong class="nd ir">remote function </strong>Sender.connect(<strong class="nd ir">string </strong>hosts<strong class="nd ir">, int </strong>ports<strong class="nd ir">, string </strong>logins<strong class="nd ir">, string </strong>passcodes<strong class="nd ir">, string </strong>vhosts<strong class="nd ir">, string </strong>acceptVersions) {<br/>    socket:Client socketClient = self.socketClient<strong class="nd ir">;<br/>    </strong>io:println(<strong class="nd ir">"Starting up the Ballerina Stomp Service\n"</strong>)<strong class="nd ir">;</strong></span><span id="e51f" class="nh lw iq nd b gy nm nj l nk nl"><strong class="nd ir">    </strong>// CONNECT frame to get connected.<br/>    <strong class="nd ir">string </strong>connect = <strong class="nd ir">"CONNECT" </strong>+ <strong class="nd ir">"\n" </strong>+ <strong class="nd ir">"accept-version:" </strong>+ acceptVersions + <strong class="nd ir">"\n" </strong>+ <strong class="nd ir">"login:" </strong>+ logins + <strong class="nd ir">"\n" </strong>+ <strong class="nd ir">"passcode:" </strong>+ passcodes +<br/>        <strong class="nd ir">"\n" </strong>+ <strong class="nd ir">"host:" </strong>+ vhosts + <strong class="nd ir">"\n" </strong>+ <strong class="nd ir">"\n" </strong>+ self.endOfFrame<strong class="nd ir">;</strong></span><span id="f581" class="nh lw iq nd b gy nm nj l nk nl"><strong class="nd ir">    byte</strong>[] payloadByte = connect.toByteArray(<strong class="nd ir">"UTF-8"</strong>)<strong class="nd ir">;<br/>    </strong>// Send desired content to the server using the write function.<br/>    <strong class="nd ir">var </strong>writeResult = socketClient<strong class="nd ir">-&gt;</strong>write(payloadByte)<strong class="nd ir">;<br/>    if </strong>(writeResult <strong class="nd ir">is error</strong>) {<br/>        io:println(<strong class="nd ir">"Unable to write the connect frame", </strong>writeResult)<strong class="nd ir">;<br/>    </strong>}<br/>    io:println(<strong class="nd ir">"Successfully connected to stomp broker"</strong>)<strong class="nd ir">;</strong></span><span id="7710" class="nh lw iq nd b gy nm nj l nk nl"><strong class="nd ir">    </strong>// Make the publisher wait until it sends the message to the destination.<br/>    runtime:sleep(5000)<strong class="nd ir">;</strong></span><span id="ffa2" class="nh lw iq nd b gy nm nj l nk nl"><strong class="nd ir">    var </strong>startBegin = self<strong class="nd ir">-&gt;</strong>begin()<strong class="nd ir">;<br/></strong>}</span><span id="db46" class="nh lw iq nd b gy nm nj l nk nl"><strong class="nd ir">remote function </strong>Sender.begin(){<br/>    socket:Client socketClient = self.socketClient<strong class="nd ir">;</strong></span><span id="1c1e" class="nh lw iq nd b gy nm nj l nk nl"><strong class="nd ir">    </strong>// Generating unique id for message reciept.<br/>    <strong class="nd ir">string </strong>transactionId = system:uuid()<strong class="nd ir">;</strong></span><span id="c3f2" class="nh lw iq nd b gy nm nj l nk nl"><strong class="nd ir">    string </strong>begin = <strong class="nd ir">"BEGIN" </strong>+ <strong class="nd ir">"\n" </strong>+ <strong class="nd ir">"transaction:" </strong>+ transactionId + <strong class="nd ir">"\n" </strong>+ <strong class="nd ir">"\n" </strong>+ self.endOfFrame<strong class="nd ir">;</strong></span><span id="6f5f" class="nh lw iq nd b gy nm nj l nk nl"><strong class="nd ir">    byte</strong>[] payloadByte = begin.toByteArray(<strong class="nd ir">"UTF-8"</strong>)<strong class="nd ir">;<br/>    </strong>// Send desired content to the server using the write function.<br/>    <strong class="nd ir">var </strong>writeResult = socketClient<strong class="nd ir">-&gt;</strong>write(payloadByte)<strong class="nd ir">;<br/>    if </strong>(writeResult <strong class="nd ir">is error</strong>) {<br/>        io:println(<strong class="nd ir">"Unable to write the connect frame", </strong>writeResult)<strong class="nd ir">;<br/>    </strong>}<br/>    io:println(<strong class="nd ir">" Begin has been made with transaction: ", </strong>transactionId)<strong class="nd ir">;<br/></strong>}</span><span id="83f2" class="nh lw iq nd b gy nm nj l nk nl"><strong class="nd ir">remote function </strong>Sender.send(<strong class="nd ir">string </strong>messages<strong class="nd ir">, string </strong>destinations){<br/>    socket:Client socketClient = self.socketClient<strong class="nd ir">;</strong></span><span id="f54a" class="nh lw iq nd b gy nm nj l nk nl"><strong class="nd ir">    </strong>// Generating unique id for message reciept.<br/>    <strong class="nd ir">string </strong>messageId = system:uuid()<strong class="nd ir">;</strong></span><span id="0a98" class="nh lw iq nd b gy nm nj l nk nl"><strong class="nd ir">    </strong>// SEND frame to send message.<br/>    <strong class="nd ir">string </strong>send = <strong class="nd ir">"SEND" </strong>+ <strong class="nd ir">"\n" </strong>+ <strong class="nd ir">"destination:" </strong>+ destinations + <strong class="nd ir">"\n" </strong>+ <strong class="nd ir">"receipt:" </strong>+ messageId + <strong class="nd ir">"\n" </strong>+ <strong class="nd ir">"\n" </strong>+<br/>        messages + <strong class="nd ir">"\n" </strong>+ <strong class="nd ir">"\n" </strong>+ self.endOfFrame<strong class="nd ir">;</strong></span><span id="1348" class="nh lw iq nd b gy nm nj l nk nl"><strong class="nd ir">    byte</strong>[] payloadByte = send.toByteArray(<strong class="nd ir">"UTF-8"</strong>)<strong class="nd ir">;<br/>    </strong>// Send desired content to the server using the write function.<br/>    <strong class="nd ir">var </strong>writeResult = socketClient<strong class="nd ir">-&gt;</strong>write(payloadByte)<strong class="nd ir">;<br/>    if </strong>(writeResult <strong class="nd ir">is error</strong>) {<br/>        io:println(<strong class="nd ir">"Unable to write the connect frame", </strong>writeResult)<strong class="nd ir">;<br/>    </strong>}<br/>    io:println(<strong class="nd ir">"Message: ", </strong>messages <strong class="nd ir">," is sent successfully"</strong>)<strong class="nd ir">;</strong></span><span id="4ac2" class="nh lw iq nd b gy nm nj l nk nl"><strong class="nd ir">    </strong>// Make the publisher wait until it sends the message to the destination.<br/>    runtime:sleep(5000)<strong class="nd ir">;</strong></span><span id="7225" class="nh lw iq nd b gy nm nj l nk nl"><strong class="nd ir">    var </strong>disconnection =  self<strong class="nd ir">-&gt;</strong>disconnect()<strong class="nd ir">;<br/></strong>}</span><span id="c917" class="nh lw iq nd b gy nm nj l nk nl"><strong class="nd ir">remote function </strong>Sender.disconnect() {<br/>    socket:Client socketClient = self.socketClient<strong class="nd ir">;</strong></span><span id="16d4" class="nh lw iq nd b gy nm nj l nk nl"><strong class="nd ir">    </strong>// DISCONNECT frame to disconnect.<br/>    <strong class="nd ir">string </strong>disconnect = <strong class="nd ir">"DISCONNECT" </strong>+ <strong class="nd ir">"\n" </strong>+ <strong class="nd ir">"\n" </strong>+ self.endOfFrame<strong class="nd ir">;</strong></span><span id="25d3" class="nh lw iq nd b gy nm nj l nk nl"><strong class="nd ir">    byte</strong>[] payloadByte = disconnect.toByteArray(<strong class="nd ir">"UTF-8"</strong>)<strong class="nd ir">;<br/>    </strong>// Send desired content to the server using the write function.<br/>    <strong class="nd ir">var </strong>writeResult = socketClient<strong class="nd ir">-&gt;</strong>write(payloadByte)<strong class="nd ir">;<br/>    if </strong>(writeResult <strong class="nd ir">is error</strong>) {<br/>        io:println(<strong class="nd ir">"Unable to write the connect frame", </strong>writeResult)<strong class="nd ir">;<br/>    </strong>}<br/>    io:println(<strong class="nd ir">"Disconnected from stomp broker successfully"</strong>)<strong class="nd ir">;<br/></strong>}</span><span id="9055" class="nh lw iq nd b gy nm nj l nk nl">// Callback service for the TCP client. The service needs to have four predefined resources.<br/><strong class="nd ir">service </strong>ClientService = <strong class="nd ir">service </strong>{</span><span id="ceeb" class="nh lw iq nd b gy nm nj l nk nl">    // This is invoked once the client connects to the TCP server.<br/>    <strong class="nd ir">resource function </strong>onConnect(socket:Caller caller) {<br/>        io:println(<strong class="nd ir">"Connect to: ", </strong>caller.remotePort)<strong class="nd ir">;<br/>    </strong>}</span><span id="88bd" class="nh lw iq nd b gy nm nj l nk nl">    // This is invoked when the server sends any content.<br/>    <strong class="nd ir">resource function </strong>onReadReady(socket:Caller caller<strong class="nd ir">, byte</strong>[] content) {<br/>        io:ReadableByteChannel byteChannel = io:createReadableChannel(content)<strong class="nd ir">;<br/>        </strong>io:ReadableCharacterChannel characterChannel =<br/>        <strong class="nd ir">new </strong>io:ReadableCharacterChannel(byteChannel<strong class="nd ir">, "UTF-8"</strong>)<strong class="nd ir">;<br/>        var </strong>str = characterChannel.read(300)<strong class="nd ir">;<br/>        if </strong>(str <strong class="nd ir">is string</strong>) {<br/>            io:println(<strong class="nd ir">untaint </strong>str)<strong class="nd ir">;<br/>        </strong>} <strong class="nd ir">else </strong>{<br/>            io:println(str)<strong class="nd ir">;<br/>        </strong>}<br/>    }</span><span id="45cf" class="nh lw iq nd b gy nm nj l nk nl">    // This is invoked once the connection is closed.<br/>    <strong class="nd ir">resource function </strong>onClose(socket:Caller caller) {<br/>        io:println(<strong class="nd ir">"Leave from: ", </strong>caller.remotePort)<strong class="nd ir">;<br/>    </strong>}</span><span id="76f7" class="nh lw iq nd b gy nm nj l nk nl">    // This resource is invoked for the error situation<br/>    // if it happens during the `onConnect`, `onReadReady`, and `onClose` functions.<br/>    <strong class="nd ir">resource function </strong>onError(socket:Caller caller<strong class="nd ir">, error </strong>err) {<br/>        io:println(err)<strong class="nd ir">;<br/>    </strong>}<br/>}<strong class="nd ir">;</strong></span></pre><h1 id="1ec6" class="lv lw iq bd lx ly lz ma mb mc md me mf jw mg jx mh jz mi ka mj kc mk kd ml mm bi translated">从队列/主题/交换中订阅消息</h1><blockquote class="ln lo lp"><p id="3fc5" class="kr ks lq kt b ku kv jr kw kx ky ju kz lr lb lc ld ls lf lg lh lt lj lk ll lm ij bi translated"><strong class="kt ir"> <em class="iq">工作目录结构:</em> </strong></p></blockquote><p id="e22c" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">/根文件夹<br/>├──my . stomp subscriber<br/>│└──receiver . bal<br/>├──subscriber . bal</p><p id="ec31" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kt ir">用户余额</strong></p><p id="68ae" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">消息订阅者将通过发送<strong class="kt ir">连接</strong>帧建立TCP套接字连接来连接到消息代理，并将通过在事务块内发送<strong class="kt ir">订阅</strong>帧来开始订阅特定目的地上的消息。</p><pre class="kg kh ki kj gt nc nd ne nf aw ng bi"><span id="d38d" class="nh lw iq nd b gy ni nj l nk nl"><strong class="nd ir">import </strong>my.stompSubscriber<strong class="nd ir">;<br/>import </strong>ballerina/log<strong class="nd ir">;<br/>import </strong>ballerina/io<strong class="nd ir">;<br/>import </strong>ballerina/socket<strong class="nd ir">;<br/>import </strong>ballerina/system<strong class="nd ir">;<br/></strong>//import ballerina/transactions;</span><span id="2971" class="nh lw iq nd b gy nm nj l nk nl">// This initializes a STOMP connection with the STOMP broker.<br/>stompSubscriber:Receiver stompReceiver = <strong class="nd ir">new</strong>({<br/>        host: <strong class="nd ir">"localhost",<br/>        </strong>port: 61613<strong class="nd ir">,<br/>        </strong>login: <strong class="nd ir">"guest",<br/>        </strong>passcode: <strong class="nd ir">"guest",<br/>        </strong>vhost: <strong class="nd ir">"/",<br/>        </strong>acceptVersion: <strong class="nd ir">"1.1"<br/>    </strong>})<strong class="nd ir">;</strong></span><span id="a804" class="nh lw iq nd b gy nm nj l nk nl"><strong class="nd ir">public function </strong>main() {<br/>    // Message is subscribed within the transaction block.<br/>    // Each message received should be received from other end else <br/>    // rollback to retry the subscription along with transaction Id.<br/>    <strong class="nd ir">transaction </strong>{<br/>        // This sends the Ballerina message to the stomp broker.<br/>        <strong class="nd ir">string </strong>destination = <strong class="nd ir">"/queue/test";<br/>        string </strong>subscribeId = system:uuid()<strong class="nd ir">;<br/>        string </strong>ack = <strong class="nd ir">"client";<br/>        var </strong>receive = stompReceiver<strong class="nd ir">-&gt;</strong>subscribe(destination<strong class="nd ir">,    </strong>subscribeId<strong class="nd ir">, </strong>ack);<strong class="nd ir"><br/>    </strong>}<br/>}</span></pre><p id="7893" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kt ir"> Receiver.bal (Object) </strong></p><pre class="kg kh ki kj gt nc nd ne nf aw ng bi"><span id="705d" class="nh lw iq nd b gy ni nj l nk nl"><strong class="nd ir">import </strong>ballerina/socket<strong class="nd ir">;<br/>import </strong>ballerina/io<strong class="nd ir">;<br/>import </strong>ballerina/log<strong class="nd ir">;<br/>import </strong>ballerina/runtime<strong class="nd ir">;<br/>import </strong>ballerina/system<strong class="nd ir">;</strong></span><span id="c78a" class="nh lw iq nd b gy nm nj l nk nl"><em class="lq"># Configurations related to a STOMP connection<br/>#<br/># </em>+ host - <em class="lq">STOMP provider url.<br/># </em>+ port - <em class="lq">STOMP port.<br/># </em>+ config - <em class="lq">Config.<br/># </em>+ login - <em class="lq">STOMP user login.<br/># </em>+ passcode - <em class="lq">STOMP passcode.<br/># </em>+ vhost - <em class="lq">default stomp vhost.<br/># </em>+ acceptVersion - <em class="lq">1.1.<br/># </em>+ socketClient - <em class="lq">socketConnection.<br/># </em>+ endOfFrame - <em class="lq">null octet.</em></span><span id="b157" class="nh lw iq nd b gy nm nj l nk nl"><strong class="nd ir">public type </strong>Receiver <strong class="nd ir">client object </strong>{</span><span id="8df1" class="nh lw iq nd b gy nm nj l nk nl">    <strong class="nd ir">public string </strong>host = <strong class="nd ir">"";<br/>    public int </strong>port = 0<strong class="nd ir">;<br/>    public string </strong>login = <strong class="nd ir">"";<br/>    public string </strong>passcode = <strong class="nd ir">"";<br/>    public string </strong>vhost = <strong class="nd ir">"";<br/>    public string </strong>acceptVersion = <strong class="nd ir">"";<br/>    private </strong>socket:Client socketClient<strong class="nd ir">;</strong></span><span id="937f" class="nh lw iq nd b gy nm nj l nk nl"><strong class="nd ir">    </strong>// End of frame used a null octet (^@ = \u0000).<br/>    <strong class="nd ir">public string </strong>endOfFrame = <strong class="nd ir">"\u0000";</strong></span><span id="090d" class="nh lw iq nd b gy nm nj l nk nl"><strong class="nd ir">    public </strong>ConnectionConfiguration config = {<br/>        host:host<strong class="nd ir">,<br/>        </strong>port:port<strong class="nd ir">,<br/>        </strong>login:login<strong class="nd ir">,<br/>        </strong>passcode:passcode<strong class="nd ir">,<br/>        </strong>vhost:vhost<strong class="nd ir">,<br/>        </strong>acceptVersion:acceptVersion<br/>    }<strong class="nd ir">;</strong></span><span id="df22" class="nh lw iq nd b gy nm nj l nk nl"><strong class="nd ir">    public function __init</strong>(ConnectionConfiguration stompConfig) {<br/>        <strong class="nd ir">self</strong>.config = stompConfig<strong class="nd ir">;<br/>        </strong>//self-&gt;send(stompConfig.message,stompConfig.destination);<br/>        <strong class="nd ir">self</strong>.host = stompConfig.host<strong class="nd ir">;<br/>        self</strong>.port = stompConfig.port<strong class="nd ir">;<br/>        self</strong>.login = stompConfig.login<strong class="nd ir">;<br/>        self</strong>.passcode = stompConfig.passcode<strong class="nd ir">;<br/>        self</strong>.vhost = stompConfig.vhost<strong class="nd ir">;<br/>        self</strong>.acceptVersion = stompConfig.acceptVersion<strong class="nd ir">;<br/>        self</strong>.socketClient = <strong class="nd ir">new</strong>({<br/>                host: <strong class="nd ir">self</strong>.host<strong class="nd ir">,<br/>                </strong>port: <strong class="nd ir">self</strong>.port<strong class="nd ir">,<br/>                </strong>callbackService: ClientService<br/>            })<strong class="nd ir">;<br/>        self-&gt;</strong>connect(stompConfig.host<strong class="nd ir">, </strong>stompConfig.port<strong class="nd ir">, </strong>stompConfig.login<strong class="nd ir">,<br/>            </strong>stompConfig.passcode<strong class="nd ir">,<br/>            </strong>stompConfig.vhost<strong class="nd ir">,<br/>            </strong>stompConfig.acceptVersion) <strong class="nd ir">;<br/>    </strong>}</span><span id="732b" class="nh lw iq nd b gy nm nj l nk nl">    <strong class="nd ir">public remote function </strong>connect(<strong class="nd ir">string </strong>hosts<strong class="nd ir">,int </strong>ports<strong class="nd ir">,string </strong>logins<strong class="nd ir">, string </strong>passcodes<strong class="nd ir">, string </strong>vhosts<strong class="nd ir">, string </strong>acceptVersions)<strong class="nd ir">;</strong></span><span id="8413" class="nh lw iq nd b gy nm nj l nk nl"><strong class="nd ir">    public remote function </strong>begin()<strong class="nd ir">;</strong></span><span id="45fa" class="nh lw iq nd b gy nm nj l nk nl"><strong class="nd ir">    public remote function </strong>subscribe(<strong class="nd ir">string </strong>destinations<strong class="nd ir">, string </strong>subscribeId<strong class="nd ir">, string </strong>ack)<strong class="nd ir">;</strong></span><span id="c37c" class="nh lw iq nd b gy nm nj l nk nl"><strong class="nd ir">    public remote function </strong>disconnect()<strong class="nd ir">;<br/></strong>}<strong class="nd ir">;</strong></span><span id="34f1" class="nh lw iq nd b gy nm nj l nk nl"><strong class="nd ir">public type </strong>ConnectionConfiguration <strong class="nd ir">record </strong>{<br/>    <strong class="nd ir">string </strong>host<strong class="nd ir">;<br/>    int </strong>port<strong class="nd ir">;<br/>    string </strong>login<strong class="nd ir">;<br/>    string </strong>passcode<strong class="nd ir">;<br/>    string </strong>vhost<strong class="nd ir">;<br/>    string </strong>acceptVersion<strong class="nd ir">;<br/></strong>}<strong class="nd ir">;</strong></span><span id="c4cb" class="nh lw iq nd b gy nm nj l nk nl"><strong class="nd ir">remote function </strong>Receiver.connect(<strong class="nd ir">string </strong>hosts<strong class="nd ir">, int </strong>ports<strong class="nd ir">, string </strong>logins<strong class="nd ir">, string </strong>passcodes<strong class="nd ir">, string </strong>vhosts<strong class="nd ir">, string </strong>acceptVersions) {<br/>    socket:Client socketClient = self.socketClient<strong class="nd ir">;<br/>    </strong>io:println(<strong class="nd ir">"Starting up the Ballerina Stomp Service\n"</strong>)<strong class="nd ir">;</strong></span><span id="6018" class="nh lw iq nd b gy nm nj l nk nl"><strong class="nd ir">    </strong>// CONNECT frame to get connected.<br/>    <strong class="nd ir">string </strong>connect = <strong class="nd ir">"CONNECT" </strong>+ <strong class="nd ir">"\n" </strong>+ <strong class="nd ir">"accept-version:" </strong>+ acceptVersions + <strong class="nd ir">"\n" </strong>+ <strong class="nd ir">"login:" </strong>+ logins + <strong class="nd ir">"\n" </strong>+ <strong class="nd ir">"passcode:" </strong>+ passcodes +<br/>        <strong class="nd ir">"\n" </strong>+ <strong class="nd ir">"host:" </strong>+ vhosts + <strong class="nd ir">"\n" </strong>+ <strong class="nd ir">"\n" </strong>+ self.endOfFrame<strong class="nd ir">;</strong></span><span id="f12b" class="nh lw iq nd b gy nm nj l nk nl"><strong class="nd ir">    byte</strong>[] payloadByte = connect.toByteArray(<strong class="nd ir">"UTF-8"</strong>)<strong class="nd ir">;<br/>    </strong>// Send desired content to the server using the write function.<br/>    <strong class="nd ir">var </strong>writeResult = socketClient<strong class="nd ir">-&gt;</strong>write(payloadByte)<strong class="nd ir">;<br/>    if </strong>(writeResult <strong class="nd ir">is error</strong>) {<br/>        io:println(<strong class="nd ir">"Unable to write the connect frame", </strong>writeResult)<strong class="nd ir">;<br/>    </strong>}<br/>    io:println(<strong class="nd ir">"Successfully connected to stomp broker"</strong>)<strong class="nd ir">;</strong></span><span id="1444" class="nh lw iq nd b gy nm nj l nk nl"><strong class="nd ir">    </strong>// Make the publisher wait until it sends the message to the destination.<br/>    runtime:sleep(5000)<strong class="nd ir">;</strong></span><span id="f951" class="nh lw iq nd b gy nm nj l nk nl"><strong class="nd ir">    var </strong>startBegin = self<strong class="nd ir">-&gt;</strong>begin()<strong class="nd ir">;<br/></strong>}</span><span id="5757" class="nh lw iq nd b gy nm nj l nk nl"><strong class="nd ir">remote function </strong>Receiver.begin(){<br/>    socket:Client socketClient = self.socketClient<strong class="nd ir">;</strong></span><span id="5127" class="nh lw iq nd b gy nm nj l nk nl"><strong class="nd ir">    </strong>// Generating unique id for message reciept.<br/>    <strong class="nd ir">string </strong>transactionId = system:uuid()<strong class="nd ir">;</strong></span><span id="08e6" class="nh lw iq nd b gy nm nj l nk nl"><strong class="nd ir">    string </strong>begin = <strong class="nd ir">"BEGIN" </strong>+ <strong class="nd ir">"\n" </strong>+ <strong class="nd ir">"transaction:" </strong>+ transactionId + <strong class="nd ir">"\n" </strong>+ <strong class="nd ir">"\n" </strong>+ self.endOfFrame<strong class="nd ir">;</strong></span><span id="e5e1" class="nh lw iq nd b gy nm nj l nk nl"><strong class="nd ir">    byte</strong>[] payloadByte = begin.toByteArray(<strong class="nd ir">"UTF-8"</strong>)<strong class="nd ir">;<br/>    </strong>// Send desired content to the server using the write function.<br/>    <strong class="nd ir">var </strong>writeResult = socketClient<strong class="nd ir">-&gt;</strong>write(payloadByte)<strong class="nd ir">;<br/>    if </strong>(writeResult <strong class="nd ir">is error</strong>) {<br/>        io:println(<strong class="nd ir">"Unable to write the connect frame", </strong>writeResult)<strong class="nd ir">;<br/>    </strong>}<br/>    io:println(<strong class="nd ir">" Begin has been made with transaction: ", </strong>transactionId)<strong class="nd ir">;<br/></strong>}</span><span id="b183" class="nh lw iq nd b gy nm nj l nk nl"><strong class="nd ir">remote function </strong>Receiver.subscribe(<strong class="nd ir">string </strong>destinations<strong class="nd ir">, string </strong>subscribeId<strong class="nd ir">, string </strong>ack){<br/>    socket:Client socketClient = self.socketClient<strong class="nd ir">;</strong></span><span id="42db" class="nh lw iq nd b gy nm nj l nk nl"><strong class="nd ir">    </strong>//subscribe + "\n" + "destination:"+ destination + "\n" + "id:01\n" + "ack:client\n" + "\n" + END_OF_FRAME;<br/>    // SUBSCRIBE frame to receive messages.<br/>    <strong class="nd ir">string </strong>subscribe = <strong class="nd ir">"SUBSCRIBE" </strong>+ <strong class="nd ir">"\n" </strong>+ <strong class="nd ir">"destination:" </strong>+ destinations + <strong class="nd ir">"\n" </strong>+ <strong class="nd ir">"id:"</strong>+ subscribeId + <strong class="nd ir">"ack:"</strong>+ ack + <strong class="nd ir">"\n" </strong>+ <strong class="nd ir">"\n" </strong>+ self.endOfFrame<strong class="nd ir">;</strong></span><span id="f808" class="nh lw iq nd b gy nm nj l nk nl"><strong class="nd ir">    byte</strong>[] payloadByte = subscribe.toByteArray(<strong class="nd ir">"UTF-8"</strong>)<strong class="nd ir">;<br/>    </strong>// Send desired content to the server using the write function.<br/>    <strong class="nd ir">var </strong>writeResult = socketClient<strong class="nd ir">-&gt;</strong>write(payloadByte)<strong class="nd ir">;<br/>    if </strong>(writeResult <strong class="nd ir">is error</strong>) {<br/>        io:println(<strong class="nd ir">"Unable to write the connect frame", </strong>writeResult)<strong class="nd ir">;<br/>    </strong>}<br/>    io:println(<strong class="nd ir">"Subscribed to ", </strong>destinations ,<strong class="nd ir">" with subscriptionId: ",</strong> subscribeId)<strong class="nd ir">;</strong></span><span id="4b65" class="nh lw iq nd b gy nm nj l nk nl"><strong class="nd ir">    </strong>// Make the publisher wait until it sends the message to the destination.<br/>    runtime:sleep(5000)<strong class="nd ir">;</strong></span><span id="ea9f" class="nh lw iq nd b gy nm nj l nk nl"><strong class="nd ir">    var </strong>disconnection =  self<strong class="nd ir">-&gt;</strong>disconnect()<strong class="nd ir">;<br/></strong>}</span><span id="c6b3" class="nh lw iq nd b gy nm nj l nk nl"><strong class="nd ir">remote function </strong>Receiver.disconnect() {<br/>    socket:Client socketClient = self.socketClient<strong class="nd ir">;</strong></span><span id="09e0" class="nh lw iq nd b gy nm nj l nk nl"><strong class="nd ir">    </strong>// DISCONNECT frame to disconnect.<br/>    <strong class="nd ir">string </strong>disconnect = <strong class="nd ir">"DISCONNECT" </strong>+ <strong class="nd ir">"\n" </strong>+ <strong class="nd ir">"\n" </strong>+ self.endOfFrame<strong class="nd ir">;</strong></span><span id="7a8d" class="nh lw iq nd b gy nm nj l nk nl"><strong class="nd ir">    byte</strong>[] payloadByte = disconnect.toByteArray(<strong class="nd ir">"UTF-8"</strong>)<strong class="nd ir">;<br/>    </strong>// Send desired content to the server using the write function.<br/>    <strong class="nd ir">var </strong>writeResult = socketClient<strong class="nd ir">-&gt;</strong>write(payloadByte)<strong class="nd ir">;<br/>    if </strong>(writeResult <strong class="nd ir">is error</strong>) {<br/>        io:println(<strong class="nd ir">"Unable to write the connect frame", </strong>writeResult)<strong class="nd ir">;<br/>    </strong>}<br/>    io:println(<strong class="nd ir">"Disconnected from stomp broker successfully"</strong>)<strong class="nd ir">;<br/></strong>}</span><span id="3c0b" class="nh lw iq nd b gy nm nj l nk nl">// Callback service for the TCP client. The service needs to have four predefined resources.<br/><strong class="nd ir">service </strong>ClientService = <strong class="nd ir">service </strong>{</span><span id="a7f9" class="nh lw iq nd b gy nm nj l nk nl">    // This is invoked once the client connects to the TCP server.<br/>    <strong class="nd ir">resource function </strong>onConnect(socket:Caller caller) {<br/>        io:println(<strong class="nd ir">"Connect to: ", </strong>caller.remotePort)<strong class="nd ir">;<br/>    </strong>}</span><span id="3ef8" class="nh lw iq nd b gy nm nj l nk nl">    // This is invoked when the server sends any content.<br/>    <strong class="nd ir">resource function </strong>onReadReady(socket:Caller caller<strong class="nd ir">, byte</strong>[] content) {<br/>        io:ReadableByteChannel byteChannel = io:createReadableChannel(content)<strong class="nd ir">;<br/>        </strong>io:ReadableCharacterChannel characterChannel =<br/>        <strong class="nd ir">new </strong>io:ReadableCharacterChannel(byteChannel<strong class="nd ir">, "UTF-8"</strong>)<strong class="nd ir">;<br/>        var </strong>str = characterChannel.read(300)<strong class="nd ir">;<br/>        if </strong>(str <strong class="nd ir">is string</strong>) {<br/>            io:println(<strong class="nd ir">untaint </strong>str)<strong class="nd ir">;<br/>        </strong>} <strong class="nd ir">else </strong>{<br/>            io:println(str)<strong class="nd ir">;<br/>        </strong>}<br/>    }</span><span id="d300" class="nh lw iq nd b gy nm nj l nk nl">    // This is invoked once the connection is closed.<br/>    <strong class="nd ir">resource function </strong>onClose(socket:Caller caller) {<br/>        io:println(<strong class="nd ir">"Leave from: ", </strong>caller.remotePort)<strong class="nd ir">;<br/>    </strong>}</span><span id="0ee9" class="nh lw iq nd b gy nm nj l nk nl">    // This resource is invoked for the error situation<br/>    // if it happens during the `onConnect`, `onReadReady`, and `onClose` functions.<br/>    <strong class="nd ir">resource function </strong>onError(socket:Caller caller<strong class="nd ir">, error </strong>err) {<br/>        io:println(err)<strong class="nd ir">;<br/>    </strong>}<br/>}<strong class="nd ir">;</strong></span></pre><p id="fc8d" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kt ir">消息发布演示&amp;订阅</strong></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nn"><img src="../Images/89f6e0b808a0b7ec6bcf40ac086c183b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tFU7Crla9rXaYGTmP2oG8w.png"/></div></div><figcaption class="no np gj gh gi nq nr bd b be z dk">Demonstration of STOMP Publisher &amp; Subscriber in linux</figcaption></figure><ol class=""><li id="bbe6" class="ms mt iq kt b ku kv kx ky la nu le nv li nw lm mx my mz na bi translated">运行<strong class="kt ir"><em class="lq">subscriber . bal</em></strong></li></ol><pre class="kg kh ki kj gt nc nd ne nf aw ng bi"><span id="e8aa" class="nh lw iq nd b gy ni nj l nk nl">ballerina run --experimental subscriber.bal</span></pre><p id="77b5" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">2.然后运行<strong class="kt ir"><em class="lq">publisher . bal</em></strong></p><pre class="kg kh ki kj gt nc nd ne nf aw ng bi"><span id="232a" class="nh lw iq nd b gy ni nj l nk nl">ballerina run --experimental publisher.bal</span></pre><p id="c747" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">3.通过转到，监视RabbitMQ管理控制台中传递的连接和消息</p><pre class="kg kh ki kj gt nc nd ne nf aw ng bi"><span id="4fa0" class="nh lw iq nd b gy ni nj l nk nl"><a class="ae nb" href="http://localhost:15672" rel="noopener ugc nofollow" target="_blank">http://localhost:15672</a></span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nn"><img src="../Images/ce6fc4f125c5bf5f7d167b3e91d8ba54.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ouy-Fs4_-YxqIYfSoPJIVA.png"/></div></div><figcaption class="no np gj gh gi nq nr bd b be z dk">Demonstration of RabbitMQ Management console</figcaption></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nx"><img src="../Images/f870ac1e4c799fe2b2557a9bee003394.png" data-original-src="https://miro.medium.com/v2/resize:fit:530/format:webp/1*yifXK2w13rXl5hqOaqL4eQ.png"/></div><figcaption class="no np gj gh gi nq nr bd b be z dk">Shows STOMP connections made using TCP sockets</figcaption></figure><h1 id="2843" class="lv lw iq bd lx ly lz ma mb mc md me mf jw mg jx mh jz mi ka mj kc mk kd ml mm bi translated">摘要</h1><p id="0767" class="pw-post-body-paragraph kr ks iq kt b ku mn jr kw kx mo ju kz la mp lc ld le mq lg lh li mr lk ll lm ij bi translated">感谢您一步一步地完成这些步骤，我希望您成功地制定了一个完全用芭蕾舞者语言编写的可行的跺脚协议。让我们在我的下一篇博客中相遇，敬请期待。</p><p id="ce50" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><em class="lq">更多内容请看</em><a class="ae nb" href="http://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><em class="lq">plain English . io</em></a></p></div></div>    
</body>
</html>