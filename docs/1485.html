<html>
<head>
<title>From Zero to WebHero [3] — Detail Page</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从零到网络英雄[3] —详细页面</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/from-zero-to-webhero-3-detail-page-f755c2904a85?source=collection_archive---------18-----------------------#2021-03-29">https://javascript.plainenglish.io/from-zero-to-webhero-3-detail-page-f755c2904a85?source=collection_archive---------18-----------------------#2021-03-29</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="2378" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">今天，我们将开发游戏详情页面，这将显示如何回溯兼容一个游戏，它将允许用户分享他们的游戏体验。</h2></div><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi kc"><img src="../Images/ae37082b0660b9b99ef317359cbe4749.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*sMd_dHbjIswEr13_"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Photo by <a class="ae ks" href="https://unsplash.com/@gabrielrana?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Gabriel Tovar</a> on <a class="ae ks" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="2404" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">上周我们开发了游戏列表，包括后台和前台，将根据用户的查询显示所有游戏。如果你想看，我会等你。</p><p id="183a" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">本周，我们将开发游戏详情页面。该页面将显示用户对某个游戏的回溯兼容性的投票和评论，如果游戏没有被锁定，它将允许这些用户分享他们的体验。</p><p id="5083" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">如果想直接跳到代码，可以在这里找到<a class="ae ks" href="https://github.com/omirobarcelo/retro-ps5/blob/part3" rel="noopener ugc nofollow" target="_blank">。</a></p><h1 id="55ab" class="lp lq in bd lr ls lt lu lv lw lx ly lz jt ma ju mb jw mc jx md jz me ka mf mg bi translated">游戏详情页面</h1><p id="9349" class="pw-post-body-paragraph kt ku in kv b kw mh jo ky kz mi jr lb lc mj le lf lg mk li lj lk ml lm ln lo ig bi translated">为了创建后端路由，我们遵循与列表相同的过程:我们用路由的名称创建一个文件，在本例中，<code class="fe mm mn mo mp b">/game</code>中的<code class="fe mm mn mo mp b">[id].json.ts</code>。<code class="fe mm mn mo mp b">[id]</code>将被动态替换为游戏id。<code class="fe mm mn mo mp b">.json</code>很重要，因为没有它，Sapper将无法区分前端<code class="fe mm mn mo mp b">/game/[id].svelte</code>路线和后端<code class="fe mm mn mo mp b">/game/[id].ts</code>路线。有了‘route’集合，我们声明GET函数并测试它。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="mq mr l"/></div></figure><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi ms"><img src="../Images/821ca5d0f615ce29b6f1c930eb39637a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4raBdCYaZHOcM-sJPbQX3Q.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Response from GET</figcaption></figure><p id="4628" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">因为我们是在TypeScript世界中，所以我们为我们的后端响应定义了一个类型。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="mq mr l"/></div></figure><p id="0244" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">在游戏详情页面中，Sapper允许我们添加一个脚本来预取路线数据，从而加速页面的加载和渲染。这个脚本返回模板使用的数据。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="mq mr l"/></div></figure><p id="b9e2" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">为了激活预取，我们需要将<code class="fe mm mn mo mp b">rel=prefetch</code>添加到指向我们路线的链接中。在我们的场景中，这将告诉Sapper在用户悬停在游戏卡上时执行预取脚本。</p><pre class="kd ke kf kg gt mt mp mu mv aw mw bi"><span id="4ffa" class="mx lq in mp b gy my mz l na nb">&lt;a rel="prefetch" href="game/{game._id}"&gt;<br/>  &lt;div class="card"&gt;<br/>    ...<br/>  &lt;/div&gt;<br/>&lt;/a&gt;</span></pre><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi nc"><img src="../Images/5dbdcf5cda655d8443e0a7ce768c7899.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*K3vOMt7CJPudQfPMkNMAOw.gif"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Prefetching in action</figcaption></figure><p id="e9eb" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">对于游戏详情页，我们有更多的空间展示用户投票的结果；饼图将是他们的一个很好的代表。我的渲染图是一个SVG饼图，来自于这篇文章。</p><p id="5f4d" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">下一步是显示游戏的评论。对于每条评论，我们将显示其发布日期。当格式化日期时，我们遇到一个错误:<code class="fe mm mn mo mp b">comment.date</code>不是一个日期对象。</p><p id="a944" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">原来fetch的<code class="fe mm mn mo mp b">res.json</code>没有将日期字符串解析成日期对象。<code class="fe mm mn mo mp b">JSON.parse</code>接受一个reviver函数，一个将JSON字符串解析成JavaScript对象的函数，但不接受<code class="fe mm mn mo mp b">res.json</code>，并且我们不能在<code class="fe mm mn mo mp b">res.json</code>之后执行<code class="fe mm mn mo mp b">JSON.parse</code>，因为我们不能解析对象。有一个解决方法:使用<code class="fe mm mn mo mp b">res.text</code>，然后使用<code class="fe mm mn mo mp b">JSON.parse</code>和reviver函数来解析日期字符串。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="mq mr l"/></div></figure><p id="435a" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">可以在<a class="ae ks" href="https://mariusschulz.com/blog/deserializing-json-strings-as-javascript-date-objects" rel="noopener ugc nofollow" target="_blank">这里</a>和<a class="ae ks" href="https://stackoverflow.com/questions/58463173/how-to-use-reviver-function-with-fetch-response-json" rel="noopener ugc nofollow" target="_blank">这里</a>找到该解决方案的有用资源。</p><p id="f7fd" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">但是一个流行的游戏可能有很多评论，所以我们需要为它们实现某种分页。我们将使用Svelte的反应声明来决定显示评论列表的哪一部分。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="mq mr l"/></div></figure><p id="ef6c" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">投票区将包括两个按钮，正面或负面评价，一个可选评论的文本区，和一个发送按钮。如果游戏被锁定，这个区域将被隐藏。在选择投票类型之前,“发送”按钮将保持禁用状态。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="mq mr l"/></div></figure><h1 id="c93f" class="lp lq in bd lr ls lt lu lv lw lx ly lz jt ma ju mb jw mc jx md jz me ka mf mg bi translated">投票和评论</h1><p id="ab21" class="pw-post-body-paragraph kt ku in kv b kw mh jo ky kz mi jr lb lc mj le lf lg mk li lj lk ml lm ln lo ig bi translated">视图集和投票区实现后，下一步是创建更新游戏的后端路径，并用更新后的数据重新呈现视图。</p><p id="0b5a" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">我们可以使用与获取游戏细节相同的更新路径<code class="fe mm mn mo mp b">/game/[id].json</code>，所以我们只需要在<code class="fe mm mn mo mp b">[id].json.ts</code>中定义一个<code class="fe mm mn mo mp b">put</code>或<code class="fe mm mn mo mp b">patch</code>函数。</p><p id="c7ca" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">Mongoose提供了执行原子更新的<code class="fe mm mn mo mp b">findOneAndUpdate</code>。为了能够使用这个函数，我们需要用<code class="fe mm mn mo mp b">useFindAndModify: false</code>更新我们的数据库连接。</p><pre class="kd ke kf kg gt mt mp mu mv aw mw bi"><span id="253d" class="mx lq in mp b gy my mz l na nb">const connectDb = (db: string) =&gt; {<br/>  return connect(db, { useNewUrlParser: true, useUnifiedTopology: true, useFindAndModify: false });<br/>};</span></pre><p id="0669" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">随着连接的更新，我们实现了一个<code class="fe mm mn mo mp b">patch</code>函数，在这个函数中，我们更新了投票计数，并在发送评论时添加评论。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="mq mr l"/></div></figure><p id="dff3" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">对于客户端，我们也需要用reviver解析补丁的响应。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="mq mr l"/></div></figure><p id="7c04" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">此外，我们需要将所有的评论、投票文本和饼图数据更改为反应性陈述，以便它们相应地更新。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi nd"><img src="../Images/a515713aa2bd1c98abbcbd9b5bb348ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*FD74_xwdClDs9emoXrSrlQ.gif"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Game Detail page showcase</figcaption></figure></div><div class="ab cl ne nf hr ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="ig ih ii ij ik"><p id="5f3d" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">我们又一次到达了终点。下次我们将创建联系页面。现在，用户有能力与我们的网站互动，他们可能有一些问题或想法。</p><p id="58c7" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">你可以在<a class="ae ks" href="https://github.com/omirobarcelo/retro-ps5/blob/part3" rel="noopener ugc nofollow" target="_blank">https://github.com/omirobarcelo/retro-ps5/blob/part3</a>中看到到目前为止的所有代码。</p><p id="930f" class="pw-post-body-paragraph kt ku in kv b kw kx jo ky kz la jr lb lc ld le lf lg lh li lj lk ll lm ln lo ig bi translated">谢谢你陪我走过这段旅程！我希望你喜欢他的系列，下周<a class="ae ks" rel="noopener ugc nofollow" target="_blank" href="/lets-build-a-svelte-app-a4050db53e79">见</a>！</p><h1 id="fce3" class="lp lq in bd lr ls lt lu lv lw lx ly lz jt ma ju mb jw mc jx md jz me ka mf mg bi translated">参考</h1><div class="nl nm gp gr nn no"><a href="https://medium.com/hackernoon/a-simple-pie-chart-in-svg-dbdd653b6936" rel="noopener follow" target="_blank"><div class="np ab fo"><div class="nq ab nr cl cj ns"><h2 class="bd io gy z fp nt fr fs nu fu fw im bi translated">SVG中的简单饼图</h2><div class="nv l"><h3 class="bd b gy z fp nt fr fs nu fu fw dk translated">学习三角学三重奏——sin cos和tan——是我reverso愿望清单的第一项(我希望……</h3></div><div class="nw l"><p class="bd b dl z fp nt fr fs nu fu fw dk translated">medium.com</p></div></div><div class="nx l"><div class="ny l nz oa ob nx oc km no"/></div></div></a></div><div class="nl nm gp gr nn no"><a href="https://mariusschulz.com/blog/deserializing-json-strings-as-javascript-date-objects" rel="noopener  ugc nofollow" target="_blank"><div class="np ab fo"><div class="nq ab nr cl cj ns"><h2 class="bd io gy z fp nt fr fs nu fu fw im bi translated">将JSON字符串反序列化为JavaScript日期对象</h2><div class="nv l"><h3 class="bd b gy z fp nt fr fs nu fu fw dk translated">使用自定义约定，JSON.parse()函数可以将JSON datetime字符串转换成正确的JavaScript日期…</h3></div><div class="nw l"><p class="bd b dl z fp nt fr fs nu fu fw dk translated">mariusschulz.com</p></div></div><div class="nx l"><div class="od l nz oa ob nx oc km no"/></div></div></a></div><div class="nl nm gp gr nn no"><a href="https://stackoverflow.com/questions/58463173/how-to-use-reviver-function-with-fetch-response-json" rel="noopener  ugc nofollow" target="_blank"><div class="np ab fo"><div class="nq ab nr cl cj ns"><h2 class="bd io gy z fp nt fr fs nu fu fw im bi translated">如何通过fetch.response.json()使用reviver函数</h2><div class="nv l"><h3 class="bd b gy z fp nt fr fs nu fu fw dk translated">感谢贡献一个堆栈溢出的答案！请务必回答问题。提供详细信息并分享…</h3></div><div class="nw l"><p class="bd b dl z fp nt fr fs nu fu fw dk translated">stackoverflow.com</p></div></div><div class="nx l"><div class="oe l nz oa ob nx oc km no"/></div></div></a></div></div></div>    
</body>
</html>