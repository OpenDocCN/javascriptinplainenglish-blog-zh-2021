<html>
<head>
<title>Storybook Snapshot Testing</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">故事书快照测试</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/storybook-snapshot-testing-3e2b7abeffea?source=collection_archive---------3-----------------------#2021-01-12">https://javascript.plainenglish.io/storybook-snapshot-testing-3e2b7abeffea?source=collection_archive---------3-----------------------#2021-01-12</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="23ba" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">用故事书故事进行自动笑话快照测试</h2></div><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi kc"><img src="../Images/61b740b4a145efe2ac6ae645b2ccccb0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*-4pZpr1gyHwywMjl"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Photo by <a class="ae ks" href="https://unsplash.com/@chrismckflurry?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Christina Hernández</a> on <a class="ae ks" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="fffa" class="kt ku in bd kv kw kx ky kz la lb lc ld jt le ju lf jw lg jx lh jz li ka lj lk bi translated">我的旅程</h1><p id="38d9" class="pw-post-body-paragraph ll lm in ln b lo lp jo lq lr ls jr lt lu lv lw lx ly lz ma mb mc md me mf mg ig bi translated">随着组件库的成熟，我开始关注测试。因为这些组件是我的应用程序的可视化构建模块，所以我想使用Jest的快照来确保没有意外的视觉变化。在我开始编写测试后不久，我意识到有一种<br/>似曾相识的感觉——我已经用Storybook编写了一堆类似的东西！</p><p id="64f7" class="pw-post-body-paragraph ll lm in ln b lo mh jo lq lr mi jr lt lu mj lw lx ly mk ma mb mc ml me mf mg ig bi translated">在Storybook中，<a class="ae ks" href="https://medium.com/javascript-in-plain-english/storybook-is-your-new-ui-component-explorer-22e9e69b9d0f" rel="noopener">我通过为每个组件道具创建故事来演示我的组件的功能和特性</a>，这样用户可以直观地看到不同的变化并与之交互。用不同的道具渲染组件正是我在测试中所做的！既然我已经通过Storybook完成了展示组件库功能的所有工作，我可以利用它进行快照测试吗？</p><h1 id="b9c0" class="kt ku in bd kv kw kx ky kz la lb lc ld jt le ju lf jw lg jx lh jz li ka lj lk bi translated">故事镜头</h1><p id="16e6" class="pw-post-body-paragraph ll lm in ln b lo lp jo lq lr ls jr lt lu lv lw lx ly lz ma mb mc md me mf mg ig bi translated">Storybook的Storyshot插件就是这样做的:它将现有的Storybook故事重新用于Jest快照测试。它获取这些故事，并自动为每个故事创建快照。</p><h1 id="cb57" class="kt ku in bd kv kw kx ky kz la lb lc ld jt le ju lf jw lg jx lh jz li ka lj lk bi translated">设置</h1><p id="afcf" class="pw-post-body-paragraph ll lm in ln b lo lp jo lq lr ls jr lt lu lv lw lx ly lz ma mb mc md me mf mg ig bi translated">设置非常简单。简单地创建一个测试文件，可以通过Jest获得并运行Storyshots插件。</p><pre class="kd ke kf kg gt mm mn mo mp aw mq bi"><span id="a55b" class="mr ku in mn b gy ms mt l mu mv">// Storybook.test.js</span><span id="38b8" class="mr ku in mn b gy mw mt l mu mv">import initStoryshots from '<a class="ae ks" href="http://twitter.com/storybook/addon-storyshots" rel="noopener ugc nofollow" target="_blank">@storybook/addon-storyshots</a>';</span><span id="633c" class="mr ku in mn b gy mw mt l mu mv">initStoryshots();</span></pre><h1 id="7fbc" class="kt ku in bd kv kw kx ky kz la lb lc ld jt le ju lf jw lg jx lh jz li ka lj lk bi translated">测试</h1><p id="3238" class="pw-post-body-paragraph ll lm in ln b lo lp jo lq lr ls jr lt lu lv lw lx ly lz ma mb mc md me mf mg ig bi translated">配置完成后，Storyshot测试的行为将与其他快照测试完全相同。运行<code class="fe mx my mz mn b">jest</code>将运行测试套件。如果快照文件尚不存在，Jest将创建它们。如果有，Jest会将Storyshot快照与保存的快照进行比较，如果有任何不匹配，就会出错。运行<code class="fe mx my mz mn b">jest --update-snapshot</code>将重新生成保存的快照以解决任何错误。</p><h1 id="8dbd" class="kt ku in bd kv kw kx ky kz la lb lc ld jt le ju lf jw lg jx lh jz li ka lj lk bi translated">MDX</h1><p id="35ce" class="pw-post-body-paragraph ll lm in ln b lo lp jo lq lr ls jr lt lu lv lw lx ly lz ma mb mc md me mf mg ig bi translated">Storybook支持降价(MDX)故事，如下所示。</p><pre class="kd ke kf kg gt mm mn mo mp aw mq bi"><span id="5fc9" class="mr ku in mn b gy ms mt l mu mv">// stories/Button.stories.mdx</span><span id="4e2d" class="mr ku in mn b gy mw mt l mu mv">import { Meta, Story } from "<a class="ae ks" href="http://twitter.com/storybook/addon-docs" rel="noopener ugc nofollow" target="_blank">@storybook/addon-docs</a>/blocks";<br/>import { Button } from "./Button";</span><span id="c27d" class="mr ku in mn b gy mw mt l mu mv">&lt;Meta title="Example/Button MDX" component={Button} /&gt;</span><span id="a343" class="mr ku in mn b gy mw mt l mu mv"># Button<br/>## This is a demo of a Button markdown documentation page.</span><span id="ed1b" class="mr ku in mn b gy mw mt l mu mv">- This is a primary button:</span><span id="a405" class="mr ku in mn b gy mw mt l mu mv">&lt;Story name="Primary"&gt;<br/>  &lt;Button label="Button" primary /&gt;<br/>&lt;/Story&gt;</span></pre><p id="8afc" class="pw-post-body-paragraph ll lm in ln b lo mh jo lq lr mi jr lt lu mj lw lx ly mk ma mb mc ml me mf mg ig bi translated">Storyshots也支持这类故事的快照测试。但是要做到这一点，Jest需要能够理解和解析markdown语法。支持降价故事的<a class="ae ks" href="https://www.npmjs.com/package/@storybook/addon-docs" rel="noopener ugc nofollow" target="_blank">故事书文档插件</a>提供了<code class="fe mx my mz mn b">jest-transform-mdx</code>来完成这个任务。</p><pre class="kd ke kf kg gt mm mn mo mp aw mq bi"><span id="4419" class="mr ku in mn b gy ms mt l mu mv">// jest.config.js or "jest" field in package.json</span><span id="d709" class="mr ku in mn b gy mw mt l mu mv">{<br/>  "transform": {<br/>    "^.+\\.mdx?$": "@storybook/addon-docs/jest-transform-mdx",<br/>  }<br/>}</span></pre><p id="5e99" class="pw-post-body-paragraph ll lm in ln b lo mh jo lq lr mi jr lt lu mj lw lx ly mk ma mb mc ml me mf mg ig bi translated">现在，Storyshots可以遍历所有的降价文件，并为所有的<code class="fe mx my mz mn b">Story</code>区块生成快照。</p><h1 id="697a" class="kt ku in bd kv kw kx ky kz la lb lc ld jt le ju lf jw lg jx lh jz li ka lj lk bi translated">必需的功能道具</h1><p id="a3cb" class="pw-post-body-paragraph ll lm in ln b lo lp jo lq lr ls jr lt lu lv lw lx ly lz ma mb mc md me mf mg ig bi translated">Storybook的一个常见配置是为所有匹配<code class="fe mx my mz mn b">^on[A-Z].*</code>正则表达式的道具自动注入一个<a class="ae ks" href="https://www.npmjs.com/package/@storybook/addon-actions" rel="noopener ugc nofollow" target="_blank"> Storybook动作记录器</a>函数。这个函数将记录对Storybook actions选项卡的每次调用，这样用户就可以了解它是何时以及如何被触发的。</p><pre class="kd ke kf kg gt mm mn mo mp aw mq bi"><span id="6d68" class="mr ku in mn b gy ms mt l mu mv">// .storybook/preview.js</span><span id="50ef" class="mr ku in mn b gy mw mt l mu mv">export const parameters = {<br/>  actions: { argTypesRegex: "^on[A-Z].*" },<br/>}</span></pre><p id="6145" class="pw-post-body-paragraph ll lm in ln b lo mh jo lq lr mi jr lt lu mj lw lx ly mk ma mb mc ml me mf mg ig bi translated">不幸的是，这种注射不会发生在故事镜头中。这不是可选功能道具的问题，而是必需功能道具的问题(通过<code class="fe mx my mz mn b">PropTypes.func.isRequired</code>)。测试将失败，因为PropType检查失败。</p><p id="370d" class="pw-post-body-paragraph ll lm in ln b lo mh jo lq lr mi jr lt lu mj lw lx ly mk ma mb mc ml me mf mg ig bi translated">为了解决这个问题，我们必须更新故事来手动添加值。</p><pre class="kd ke kf kg gt mm mn mo mp aw mq bi"><span id="28f1" class="mr ku in mn b gy ms mt l mu mv">// stories/Header.stories.js</span><span id="27da" class="mr ku in mn b gy mw mt l mu mv">export default {<br/>  title: 'Example/Header',<br/>  component: Header,<br/>  args: {<br/>    ...(process.env.NODE_ENV === 'test'<br/>      ? {<br/>          onLogin: () =&gt; {},<br/>          onLogout: () =&gt; {},<br/>          onCreateAccount: () =&gt; {},<br/>        }<br/>      : {}),<br/>  },<br/>};</span></pre><p id="92df" class="pw-post-body-paragraph ll lm in ln b lo mh jo lq lr mi jr lt lu mj lw lx ly mk ma mb mc ml me mf mg ig bi translated">通过检查<code class="fe mx my mz mn b">process.env.NODE_ENV</code>，我们可以有条件地添加值，只有当故事在测试中运行时，快照测试才能在测试环境中成功，动作记录器才能在故事书用户界面中工作。</p><h1 id="ca3d" class="kt ku in bd kv kw kx ky kz la lb lc ld jt le ju lf jw lg jx lh jz li ka lj lk bi translated">React门户</h1><p id="964a" class="pw-post-body-paragraph ll lm in ln b lo lp jo lq lr ls jr lt lu lv lw lx ly lz ma mb mc md me mf mg ig bi translated">如果您的任何组件使用React Portals，您将需要模拟<code class="fe mx my mz mn b">createPortal</code>函数来从本质上禁用门户效应。Storyshots对根div ( <code class="fe mx my mz mn b">&lt;div id=”root”&gt;…&lt;/div&gt;</code>)下的内容进行快照。如果您将内容导入到此之外的某个地方(如<code class="fe mx my mz mn b">document.body</code>)，Storyshot将无法找到它，并且您的快照将会不完整。这段代码将模仿<code class="fe mx my mz mn b">createPortal</code>函数不执行门户效果，直接返回节点。</p><pre class="kd ke kf kg gt mm mn mo mp aw mq bi"><span id="04ff" class="mr ku in mn b gy ms mt l mu mv">// Storybook.test.js</span><span id="2d87" class="mr ku in mn b gy mw mt l mu mv">jest.mock('react-dom', () =&gt; {<br/>  const original = jest.requireActual('react-dom');<br/>  return {<br/>    ...original,<br/>    createPortal: node =&gt; node,<br/>  };<br/>});</span><span id="29b5" class="mr ku in mn b gy mw mt l mu mv">initStoryshots();</span></pre><h1 id="015c" class="kt ku in bd kv kw kx ky kz la lb lc ld jt le ju lf jw lg jx lh jz li ka lj lk bi translated">禁用/启用</h1><p id="1d2a" class="pw-post-body-paragraph ll lm in ln b lo lp jo lq lr ls jr lt lu lv lw lx ly lz ma mb mc md me mf mg ig bi translated">遗憾的是，Storyshot不能用于所有组件。例如，模式和工具提示组件只有在一些用户交互之后才可见。对这些组件的故事进行快照测试会得到交互元素(比如按钮)的快照，而不是模态和工具提示组件的快照，因此，这是一个没有意义的测试。为了防止这些，可以通过<code class="fe mx my mz mn b">parameters.storyshots.disable</code>在每个组件或故事的基础上禁用或启用故事镜头。</p><pre class="kd ke kf kg gt mm mn mo mp aw mq bi"><span id="0acd" class="mr ku in mn b gy ms mt l mu mv">// stories/Page.stories.js</span><span id="9926" class="mr ku in mn b gy mw mt l mu mv">export default {<br/>  title: 'Example/Page',<br/>  component: Page,<br/>  parameters: {<br/>    storyshots: { disable: true },<br/>  },<br/>};</span><span id="1c4f" class="mr ku in mn b gy mw mt l mu mv">const Template = args =&gt; &lt;Page {...args} /&gt;;</span><span id="b85a" class="mr ku in mn b gy mw mt l mu mv">export const LoggedIn = Template.bind({});<br/>LoggedIn.args = {<br/>  user: {},<br/>};</span><span id="4d96" class="mr ku in mn b gy mw mt l mu mv">export const LoggedOut = Template.bind({});<br/>LoggedOut.parameters = {<br/>  storyshots: { disable: false },<br/>};</span></pre><p id="2a3d" class="pw-post-body-paragraph ll lm in ln b lo mh jo lq lr mi jr lt lu mj lw lx ly mk ma mb mc ml me mf mg ig bi translated">请注意，即使对组件禁用了Storyshots，您仍然可以为单个组件故事重新启用它。</p><h1 id="6638" class="kt ku in bd kv kw kx ky kz la lb lc ld jt le ju lf jw lg jx lh jz li ka lj lk bi translated">其他配置选项</h1><p id="4bfd" class="pw-post-body-paragraph ll lm in ln b lo lp jo lq lr ls jr lt lu lv lw lx ly lz ma mb mc md me mf mg ig bi translated"><code class="fe mx my mz mn b">initStoryshots</code>功能还可以采用额外的配置选项来定制Storyshot体验。以下是一些常见的配置:</p><p id="75bb" class="pw-post-body-paragraph ll lm in ln b lo mh jo lq lr mi jr lt lu mj lw lx ly mk ma mb mc ml me mf mg ig bi translated"><strong class="ln io"> snapshotSerializer </strong>允许您传递自定义序列化程序的数组。如果因为JS框架(如样式化组件或情感)中的CSS而需要使用自定义序列化器，这是很有用的。</p><pre class="kd ke kf kg gt mm mn mo mp aw mq bi"><span id="dc1d" class="mr ku in mn b gy ms mt l mu mv">import initStoryshots from '<a class="ae ks" href="http://twitter.com/storybook/addon-storyshots" rel="noopener ugc nofollow" target="_blank">@storybook/addon-storyshots</a>';<br/>import { styleSheetSerializer } from 'jest-styled-components/serializer';</span><span id="c3ad" class="mr ku in mn b gy mw mt l mu mv">initStoryshots({<br/>  snapshotSerializers: [styleSheetSerializer],<br/>});</span></pre><p id="9c23" class="pw-post-body-paragraph ll lm in ln b lo mh jo lq lr mi jr lt lu mj lw lx ly mk ma mb mc ml me mf mg ig bi translated"><strong class="ln io">测试</strong>允许你为每个故事运行一个定制的测试功能。虽然对典型配置不是特别有用，但它可以与Storyshot的<code class="fe mx my mz mn b">multiSnapshotWithOptions</code>一起使用，为每个组件生成单独的快照文件，而不是为所有组件生成一个巨大的文件。</p><pre class="kd ke kf kg gt mm mn mo mp aw mq bi"><span id="f15e" class="mr ku in mn b gy ms mt l mu mv">import initStoryshots, { multiSnapshotWithOptions } from '<a class="ae ks" href="http://twitter.com/storybook/addon-storyshots" rel="noopener ugc nofollow" target="_blank">@storybook/addon-storyshots</a>';</span><span id="cc68" class="mr ku in mn b gy mw mt l mu mv">initStoryshots({<br/>  test: multiSnapshotWithOptions(),<br/>});</span></pre><p id="0b7b" class="pw-post-body-paragraph ll lm in ln b lo mh jo lq lr mi jr lt lu mj lw lx ly mk ma mb mc ml me mf mg ig bi translated"><strong class="ln io"> stories2snapsConverter </strong>允许你定制快照和故事的文件名和位置。例如:</p><pre class="kd ke kf kg gt mm mn mo mp aw mq bi"><span id="be05" class="mr ku in mn b gy ms mt l mu mv">import initStoryshots, { Stories2SnapsConverter } from '<a class="ae ks" href="http://twitter.com/storybook/addon-storyshots" rel="noopener ugc nofollow" target="_blank">@storybook/addon-storyshots</a>';</span><span id="b209" class="mr ku in mn b gy mw mt l mu mv">initStoryshots({<br/>  stories2snapsConverter: new Stories2SnapsConverter({<br/>    snapshotsDirName: '__snapshots__',<br/>    snapshotExtension: '.js.snap',<br/>    storiesExtensions: ['.js', '.mdx'],<br/>  }),<br/>});</span></pre><p id="58be" class="pw-post-body-paragraph ll lm in ln b lo mh jo lq lr mi jr lt lu mj lw lx ly mk ma mb mc ml me mf mg ig bi translated">有关配置选项的完整列表，请参见<a class="ae ks" href="https://www.npmjs.com/package/@storybook/addon-storyshots#options" rel="noopener ugc nofollow" target="_blank"> Storyshot文档</a>。</p></div><div class="ab cl na nb hr nc" role="separator"><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf"/></div><div class="ig ih ii ij ik"><h1 id="31db" class="kt ku in bd kv kw nh ky kz la ni lc ld jt nj ju lf jw nk jx lh jz nl ka lj lk bi translated">最后的想法</h1><p id="5a55" class="pw-post-body-paragraph ll lm in ln b lo lp jo lq lr ls jr lt lu lv lw lx ly lz ma mb mc md me mf mg ig bi translated">Storyshots利用您所做的所有工作来创建您的故事书，并提供自动视觉测试。我的组件库有超过50个组件故事，每个组件故事有多达12个故事。总之，我在5分钟内生成了300多个测试。就这样，我的组件库得到了全面的测试。</p></div><div class="ab cl na nb hr nc" role="separator"><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf"/></div><div class="ig ih ii ij ik"><h1 id="d052" class="kt ku in bd kv kw nh ky kz la ni lc ld jt nj ju lf jw nk jx lh jz nl ka lj lk bi translated">资源</h1><ul class=""><li id="5b00" class="nm nn in ln b lo lp lr ls lu no ly np mc nq mg nr ns nt nu bi translated"><a class="ae ks" href="https://storybook.js.org/" rel="noopener ugc nofollow" target="_blank">官方故事书文档</a></li><li id="b1ea" class="nm nn in ln b lo nv lr nw lu nx ly ny mc nz mg nr ns nt nu bi translated"><a class="ae ks" href="https://www.npmjs.com/package/@storybook/addon-storyshots" rel="noopener ugc nofollow" target="_blank">官方故事书Storyshot附加文档</a></li><li id="e717" class="nm nn in ln b lo nv lr nw lu nx ly ny mc nz mg nr ns nt nu bi translated"><a class="ae ks" href="https://medium.com/javascript-in-plain-english/storybook-is-your-new-ui-component-explorer-22e9e69b9d0f" rel="noopener">故事书设置指南</a></li><li id="d55d" class="nm nn in ln b lo nv lr nw lu nx ly ny mc nz mg nr ns nt nu bi translated"><a class="ae ks" href="https://github.com/mjchang/medium/tree/master/storybook-storyshot" rel="noopener ugc nofollow" target="_blank">本文Github回购</a></li></ul></div></div>    
</body>
</html>