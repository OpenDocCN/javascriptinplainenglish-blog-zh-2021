<html>
<head>
<title>How to use REST API with Apollo Client and GraphQL on a React/Next.js app</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在React/Next.js应用程序上将REST API与Apollo客户端和GraphQL结合使用</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/how-to-use-rest-api-with-apollo-client-and-graphql-on-a-react-nextjs-app-7d23cc8625f3?source=collection_archive---------1-----------------------#2021-03-20">https://javascript.plainenglish.io/how-to-use-rest-api-with-apollo-client-and-graphql-on-a-react-nextjs-app-7d23cc8625f3?source=collection_archive---------1-----------------------#2021-03-20</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/8d2d0009f033fb10a0a7b2cc2347bf93.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*s4GwaAl1utzSnQRRPZpWmQ.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Photo by designveloper.com</figcaption></figure><p id="5653" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">Apollo Client是一个类似Redux的状态管理库，它允许您在客户端编写GraphQL查询。如果您正在使用GraphQL服务器构建应用程序，Apollo Client是最合适的状态管理库之一，因为它有一个惊人的缓存机制。</p><p id="4140" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">在本教程中，我将从OMDb Rest API获取数据，通过用Apollo Client实现它来获取电影，以演示Rest API如何与GraphQL并行使用。</p></div><div class="ab cl kx ky hr kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ig ih ii ij ik"><h1 id="7d4a" class="le lf in bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">入门指南</h1><h2 id="2ead" class="mc lf in bd lg md me dn lk mf mg dp lo kk mh mi ls ko mj mk lw ks ml mm ma mn bi translated"><strong class="ak">创建Next.js应用</strong></h2><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="f740" class="mc lf in mt b gy mx my l mz na">npx create-next-app &lt;YOUR-APP-NAME&gt;</span></pre><p id="a810" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">在React的情况下，使用create-react-app。</p><h2 id="6ef2" class="mc lf in bd lg md me dn lk mf mg dp lo kk mh mi ls ko mj mk lw ks ml mm ma mn bi translated"><strong class="ak">安装阿波罗客户端和任何</strong> <code class="fe nb nc nd mt b"><strong class="ak">peerDependencies</strong></code></h2><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="acbf" class="mc lf in mt b gy mx my l mz na">npm i @apollo/client apollo-link-rest graphql qs graphql-anywhere</span></pre><h2 id="0c16" class="mc lf in bd lg md me dn lk mf mg dp lo kk mh mi ls ko mj mk lw ks ml mm ma mn bi translated"><strong class="ak">创建HTTP链接</strong></h2><p id="b9ee" class="pw-post-body-paragraph jz ka in kb b kc ne ke kf kg nf ki kj kk ng km kn ko nh kq kr ks ni ku kv kw ig bi translated">这是您已经存在的GraphQL端点。</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="b362" class="mc lf in mt b gy mx my l mz na">import { HTTPLink } from "apollo-link";<br/><br/>const httpLink = <strong class="mt io">new HttpLink</strong>({<br/>  <strong class="mt io">uri</strong>: 'https://server.myapp.com/graphql',<br/>  <em class="nj">// other link options...</em><br/>});</span></pre><h2 id="d1ed" class="mc lf in bd lg md me dn lk mf mg dp lo kk mh mi ls ko mj mk lw ks ml mm ma mn bi translated"><strong class="ak">创建休息链接</strong></h2><p id="6587" class="pw-post-body-paragraph jz ka in kb b kc ne ke kf kg nf ki kj kk ng km kn ko nh kq kr ks ni ku kv kw ig bi translated">在我们的例子中，它是一个获取电影的OMDB API。</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="be9c" class="mc lf in mt b gy mx my l mz na">import { RestLink } from ‘apollo-link-rest’;</span><span id="3400" class="mc lf in mt b gy nk my l mz na">const restLink = <strong class="mt io">new RestLink</strong>({<br/>  <strong class="mt io">uri</strong>: “https://www.omdbapi.com/", <br/>   <em class="nj">// other link options...</em><br/>});</span></pre><h2 id="df71" class="mc lf in bd lg md me dn lk mf mg dp lo kk mh mi ls ko mj mk lw ks ml mm ma mn bi translated">设置我们的阿波罗客户端</h2><p id="74b9" class="pw-post-body-paragraph jz ka in kb b kc ne ke kf kg nf ki kj kk ng km kn ko nh kq kr ks ni ku kv kw ig bi translated">现在我们已经配置了Rest和HTTP链接，我们可以在Apollo客户机中设置它们了。</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="1a3a" class="mc lf in mt b gy mx my l mz na">import { ApolloClient, InMemoryCache, ApolloLink } from ‘@apollo/client’;</span><span id="c82f" class="mc lf in mt b gy nk my l mz na">const client = <strong class="mt io">new ApolloClient</strong>({</span><span id="0b9d" class="mc lf in mt b gy nk my l mz na">  <strong class="mt io">link</strong>: ApolloLink.split(operation =&gt;</span><span id="bc47" class="mc lf in mt b gy nk my l mz na">    operation.getContext().clientName === "rest",<br/>    <br/>    <em class="nj">// The string "rest" and "clientName" can be anything you want</em></span><span id="53de" class="mc lf in mt b gy nk my l mz na">    restLink, <em class="nj">// Apollo will send to this if clientName is "rest"</em><br/>    <br/>    httpLink<strong class="mt io"> </strong><em class="nj">// Otherwise will send to this</em><br/>  ),</span><span id="9ec5" class="mc lf in mt b gy nk my l mz na">   <strong class="mt io">cache:</strong> new InMemoryCache()</span><span id="f842" class="mc lf in mt b gy nk my l mz na">  <em class="nj">// other options...</em><br/>});</span></pre><h2 id="d194" class="mc lf in bd lg md me dn lk mf mg dp lo kk mh mi ls ko mj mk lw ks ml mm ma mn bi translated"><strong class="ak">编写我们的GraphQL查询</strong></h2><p id="13bf" class="pw-post-body-paragraph jz ka in kb b kc ne ke kf kg nf ki kj kk ng km kn ko nh kq kr ks ni ku kv kw ig bi translated">注意，有两个OMDb端点。第一个用于获取单部电影的数据，第二个用于获取电影列表。</p><ol class=""><li id="77ae" class="nl nm in kb b kc kd kg kh kk nn ko no ks np kw nq nr ns nt bi translated">https://www.omdbapi.com/?i=tt0371746&amp;API key =</li><li id="7992" class="nl nm in kb b kc nv kg nw kk nx ko ny ks nz kw nq nr ns nt bi translated">http://www.omdbapi.com/?s=iron&amp;API key =</li></ol><p id="a1ba" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><strong class="kb io">注意:<a class="ae nu" href="http://www.omdbapi.com/apikey.aspx" rel="noopener ugc nofollow" target="_blank">https://www.omdbapi.com/apikey.aspx</a>你可以生成你的API密匙</strong></p><p id="7718" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">我们必须知道，Apollo客户端基于<code class="fe nb nc nd mt b"><strong class="kb io">typenames</strong></code> <strong class="kb io"> </strong>对缓存数据进行规范化，因此我们必须执行<em class="nj">类型名修补</em>。</p><p id="af97" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">我们可以在编写<code class="fe nb nc nd mt b"><strong class="kb io">gql</strong></code>查询时直接执行类型名修补。但是对于包含子字段的字段，建议直接在Apollo客户机中添加typename，稍后我将对此进行说明。</p><p id="2b11" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><strong class="kb io">根据电影ID获取单个电影结果</strong></p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="9f3b" class="mc lf in mt b gy mx my l mz na">import { gql } from '@apollo/client';<br/></span><span id="8d57" class="mc lf in mt b gy nk my l mz na">export const getMovieQuery = gql`</span><span id="7af6" class="mc lf in mt b gy nk my l mz na">  query($imdbID: String!) {</span><span id="ae85" class="mc lf in mt b gy nk my l mz na">    movie(imdbID: $imdbID)</span><span id="20c7" class="mc lf in mt b gy nk my l mz na">    <strong class="mt io">@rest</strong>(<strong class="mt io">type</strong>: "<strong class="mt io">Movie</strong>", path: "?i={<strong class="mt io">args.imdbID</strong>}&amp;apikey=&lt;<em class="nj">YOUR_API</em>&gt;") {</span><span id="b71b" class="mc lf in mt b gy nk my l mz na">      Error</span><span id="e7ee" class="mc lf in mt b gy nk my l mz na">      imdbID</span><span id="8811" class="mc lf in mt b gy nk my l mz na">      imdbRating</span><span id="19f1" class="mc lf in mt b gy nk my l mz na">      Title</span><span id="8f32" class="mc lf in mt b gy nk my l mz na">      Year</span><span id="80a7" class="mc lf in mt b gy nk my l mz na">      Runtime</span><span id="5260" class="mc lf in mt b gy nk my l mz na">      Genre</span><span id="fa4b" class="mc lf in mt b gy nk my l mz na">      Director</span><span id="0329" class="mc lf in mt b gy nk my l mz na">      Country</span><span id="f387" class="mc lf in mt b gy nk my l mz na">      Plot</span><span id="f767" class="mc lf in mt b gy nk my l mz na">      Poster</span><span id="2423" class="mc lf in mt b gy nk my l mz na">    }</span><span id="b61b" class="mc lf in mt b gy nk my l mz na">  }</span><span id="a17f" class="mc lf in mt b gy nk my l mz na">`;</span></pre><p id="3d94" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">这里，<code class="fe nb nc nd mt b"><strong class="kb io">Movie</strong></code>是作为类型名分配的<strong class="kb io"> </strong>。<code class="fe nb nc nd mt b"><strong class="kb io">imdbID</strong></code> <strong class="kb io"> </strong>用作变量自变量，这样它的值可以通过<code class="fe nb nc nd mt b"><strong class="kb io">useQuery</strong></code> <strong class="kb io"> </strong>钩子传递。</p><p id="1c25" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><strong class="kb io">通过搜索参数和页码获取电影结果</strong></p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="f756" class="mc lf in mt b gy mx my l mz na">import { gql } from '@apollo/client';<br/></span><span id="d2f3" class="mc lf in mt b gy nk my l mz na">export const getMoviesQuery = gql`</span><span id="a0e0" class="mc lf in mt b gy nk my l mz na">  query($search: String!, $page: Int!) {</span><span id="0b5e" class="mc lf in mt b gy nk my l mz na">    movies(search: $search, page: $page)</span><span id="7242" class="mc lf in mt b gy nk my l mz na">    <strong class="mt io">@rest</strong>(<strong class="mt io">type: "Movies"</strong>, path: "?s={<strong class="mt io">args.search</strong>}&amp;apikey=&lt;<em class="nj">YOUR_API</em>&gt;&amp;page={<strong class="mt io">args.page</strong>}") {</span><span id="fe59" class="mc lf in mt b gy nk my l mz na">      Error</span><span id="41bf" class="mc lf in mt b gy nk my l mz na">      totalResults</span><span id="1552" class="mc lf in mt b gy nk my l mz na">      Search {</span><span id="7b27" class="mc lf in mt b gy nk my l mz na">        Title</span><span id="6f33" class="mc lf in mt b gy nk my l mz na">        Year</span><span id="eec4" class="mc lf in mt b gy nk my l mz na">        imdbID</span><span id="2f05" class="mc lf in mt b gy nk my l mz na">        Poster</span><span id="fd6e" class="mc lf in mt b gy nk my l mz na">      }</span><span id="33bf" class="mc lf in mt b gy nk my l mz na">    }</span><span id="72c3" class="mc lf in mt b gy nk my l mz na">  }</span><span id="9f69" class="mc lf in mt b gy nk my l mz na">`;</span></pre><p id="9fcb" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">这里，<code class="fe nb nc nd mt b"><strong class="kb io">Movies</strong></code>是作为类型名分配的<strong class="kb io"> </strong>。<code class="fe nb nc nd mt b"><strong class="kb io">search</strong></code><strong class="kb io"/><strong class="kb io"/><code class="fe nb nc nd mt b"><strong class="kb io">page</strong></code><strong class="kb io"/>被<strong class="kb io"> </strong>用作变量自变量，这样它们的值就可以通过<code class="fe nb nc nd mt b"><strong class="kb io">useQuery</strong></code> <strong class="kb io"> </strong>钩子传递。</p><p id="84b3" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">请注意，<code class="fe nb nc nd mt b"><strong class="kb io">Search</strong></code> <strong class="kb io"> </strong>字段包含子字段，因此我们必须为这个字段附加一个typename。我们可以使用<code class="fe nb nc nd mt b">@type(name: "Movie")</code>指令直接将typename附加到查询本身的<code class="fe nb nc nd mt b"><strong class="kb io">Search</strong></code> <strong class="kb io"> </strong>字段，但是建议改为修改Rest链接。</p><h2 id="0d08" class="mc lf in bd lg md me dn lk mf mg dp lo kk mh mi ls ko mj mk lw ks ml mm ma mn bi translated"><strong class="ak">修改我们的休息链接</strong></h2><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="d5a6" class="mc lf in mt b gy mx my l mz na"><em class="nj">// ... same as previous</em></span><span id="29fe" class="mc lf in mt b gy nk my l mz na">const restLink = new RestLink({</span><span id="c726" class="mc lf in mt b gy nk my l mz na">  uri: "https://www.omdbapi.com/",</span><span id="10c2" class="mc lf in mt b gy nk my l mz na">  <em class="nj">// Extra code to be added:</em></span><span id="f938" class="mc lf in mt b gy nk my l mz na">  <strong class="mt io">typePatcher</strong>: {</span><span id="6463" class="mc lf in mt b gy nk my l mz na">    <strong class="mt io">Movies</strong>: data =&gt; {</span><span id="346c" class="mc lf in mt b gy nk my l mz na">      if (data.Search != null) {</span><span id="68be" class="mc lf in mt b gy nk my l mz na">        data.Search = <br/>          data.Search.map(search =&gt; ({ <br/>            __typename: "Movie", ...search              <br/>         }));<br/>     }</span><span id="d65d" class="mc lf in mt b gy nk my l mz na">     return data;<br/>   }<br/> }<br/>});</span></pre><p id="7ec3" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><strong class="kb io">注:</strong> <code class="fe nb nc nd mt b"><strong class="kb io">Movies</strong></code> <strong class="kb io"> </strong>是我们查询取的数据的类型名。因此请记住，该名称应与<code class="fe nb nc nd mt b"><strong class="kb io">gql</strong></code>中使用的名称相同</p><h2 id="9d47" class="mc lf in bd lg md me dn lk mf mg dp lo kk mh mi ls ko mj mk lw ks ml mm ma mn bi translated">使用useQuery钩子在我们的UI中获取数据</h2><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="e938" class="mc lf in mt b gy mx my l mz na">import { useQuery } from ‘@apollo/client’;</span><span id="a1e9" class="mc lf in mt b gy nk my l mz na"><em class="nj">// ...React/NextJS function</em></span><span id="42b6" class="mc lf in mt b gy nk my l mz na">const {loading, error, data} = <strong class="mt io">useQuery</strong>(getMoviesQuery, {</span><span id="ae1b" class="mc lf in mt b gy nk my l mz na">  variables: { search, page: 1 },<br/>  <strong class="mt io">context: { clientName: 'rest' }</strong></span><span id="ab14" class="mc lf in mt b gy nk my l mz na">});</span><span id="5548" class="mc lf in mt b gy nk my l mz na">if(loading) return 'Loading...';</span><span id="24a1" class="mc lf in mt b gy nk my l mz na">if(error) return 'No results found';</span><span id="f7ee" class="mc lf in mt b gy nk my l mz na">console.log(data.movies);</span></pre><p id="32a0" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">同样的，</p><pre class="mo mp mq mr gt ms mt mu mv aw mw bi"><span id="4b24" class="mc lf in mt b gy mx my l mz na">import { useQuery } from ‘@apollo/client’;</span><span id="8407" class="mc lf in mt b gy nk my l mz na"><em class="nj">// ...React/NextJS function</em></span><span id="9fba" class="mc lf in mt b gy nk my l mz na">const {loading, error, data} = <strong class="mt io">useQuery</strong>(getMovieQuery, {</span><span id="1477" class="mc lf in mt b gy nk my l mz na">  variables: { imdbID: id },<br/>  <strong class="mt io">context: { clientName: 'rest' }</strong></span><span id="d010" class="mc lf in mt b gy nk my l mz na">});</span><span id="e5f8" class="mc lf in mt b gy nk my l mz na">if(loading) return 'Loading...';</span><span id="0604" class="mc lf in mt b gy nk my l mz na">if(error) return 'No results found';</span><span id="0b6b" class="mc lf in mt b gy nk my l mz na">console.log(data.movie);</span></pre><p id="dca0" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">请注意，我们可以像平常一样使用GraphQL端点，即没有任何<code class="fe nb nc nd mt b"><strong class="kb io">context</strong></code> <strong class="kb io"> </strong>对象。</p><p id="0663" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><strong class="kb io"> <em class="nj">就是这样。我们都完了！</em> </strong></p></div><div class="ab cl kx ky hr kz" role="separator"><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc ld"/><span class="la bw bk lb lc"/></div><div class="ig ih ii ij ik"><h1 id="0fdc" class="le lf in bd lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb bi translated">结论</h1><p id="0181" class="pw-post-body-paragraph jz ka in kb b kc ne ke kf kg nf ki kj kk ng km kn ko nh kq kr ks ni ku kv kw ig bi translated">我们知道GraphQL为我们的客户机-服务器应用程序提供了一种令人惊奇的方法，但这并不意味着它阻止我们使用已经存在的REST APIs。REST和GraphQL应该总是并行存在。</p><h1 id="d608" class="le lf in bd lg lh oa lj lk ll ob ln lo lp oc lr ls lt od lv lw lx oe lz ma mb bi translated">参考</h1><div class="of og gp gr oh oi"><a href="https://www.apollographql.com/docs/react/api/link/apollo-link-rest/" rel="noopener  ugc nofollow" target="_blank"><div class="oj ab fo"><div class="ok ab ol cl cj om"><h2 class="bd io gy z fp on fr fs oo fu fw im bi translated">休息链接</h2><div class="op l"><h3 class="bd b gy z fp on fr fs oo fu fw dk translated">从GraphQL客户端调用REST APIs为更多人带来了GraphQL的好处，无论是:您是在前端…</h3></div><div class="oq l"><p class="bd b dl z fp on fr fs oo fu fw dk translated">www.apollographql.com</p></div></div><div class="or l"><div class="os l ot ou ov or ow jt oi"/></div></div></a></div><div class="of og gp gr oh oi"><a href="https://www.jamalx31.com/tech-posts/using-apollo-with-multiple-graphql-endpoints" rel="noopener  ugc nofollow" target="_blank"><div class="oj ab fo"><div class="ok ab ol cl cj om"><h2 class="bd io gy z fp on fr fs oo fu fw im bi translated">在多个Graphql端点上使用Apollo</h2><div class="op l"><h3 class="bd b gy z fp on fr fs oo fu fw dk translated">如果您正在使用Graphql，您可能已经面临这个问题，您有自己的Graphql服务器，还需要…</h3></div><div class="oq l"><p class="bd b dl z fp on fr fs oo fu fw dk translated">www.jamalx31.com</p></div></div><div class="or l"><div class="ox l ot ou ov or ow jt oi"/></div></div></a></div><p id="181f" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><em class="nj">更多内容请看</em><a class="ae nu" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><strong class="kb io"><em class="nj">plain English . io</em></strong></a></p></div></div>    
</body>
</html>