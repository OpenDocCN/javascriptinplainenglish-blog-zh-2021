<html>
<head>
<title>Advanced React: How to Build User Idle Component using Hooks</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">高级React:如何使用钩子构建用户空闲组件</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/advanced-react-how-to-build-user-idle-component-using-hooks-81f8ef6fdefc?source=collection_archive---------2-----------------------#2021-11-09">https://javascript.plainenglish.io/advanced-react-how-to-build-user-idle-component-using-hooks-81f8ef6fdefc?source=collection_archive---------2-----------------------#2021-11-09</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/2900cb54005246b2316e933bc1b123e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*uei3q4JlJEk4fZhX"/></div></div><figcaption class="iz ja gj gh gi jb jc bd b be z dk">Photo by <a class="ae jd" href="https://unsplash.com/@goumbik?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Lukas Blazek</a> on <a class="ae jd" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><div class=""/><p id="9dae" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在一个网站上，你可能想观察用户的参与程度。如果用户没有与您的网站互动，您可能还想从网站上<strong class="kf jh">注销</strong>用户。构建/实现一个空闲组件可能是棘手而复杂的。有像<a class="ae jd" href="https://www.npmjs.com/package/react-idle-timer" rel="noopener ugc nofollow" target="_blank">反应-空闲-定时器</a>这样的模块可以使用。然而，本文的目的是理解React的高级概念，并从头开始构建它。</p><p id="4a84" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><strong class="kf jh">要求:</strong>闲置组件必须具备以下特性</p><ol class=""><li id="f4e2" class="lb lc jg kf b kg kh kk kl ko ld ks le kw lf la lg lh li lj bi translated"><strong class="kf jh">模态/弹出:</strong>需要一个模态弹出来向与网站交互的用户显示消息</li><li id="6e03" class="lb lc jg kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated"><strong class="kf jh">定时器:</strong>定时器可以是一个作业/服务/功能，当用户空闲一段给定时间时，它触发一个事件来打开一个模态。</li><li id="60cf" class="lb lc jg kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated"><strong class="kf jh">运动跟踪器/中断:</strong>您还想让事件监听器监听用户运动并重置计时器。</li><li id="843d" class="lb lc jg kf b kg lk kk ll ko lm ks ln kw lo la lg lh li lj bi translated"><strong class="kf jh">倒计时:</strong>您可能还想在模式弹出菜单上显示倒计时数字。</li></ol><figure class="lq lr ls lt gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi lp"><img src="../Images/f1f52ef313103f906b71fa9ac572f97b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HyNN5FnFN0mWgoqFGyRICA.png"/></div></div></figure><h2 id="e29b" class="lu lv jg bd lw lx ly dn lz ma mb dp mc ko md me mf ks mg mh mi kw mj mk ml mm bi translated">构建起始项目</h2><p id="1138" class="pw-post-body-paragraph kd ke jg kf b kg mn ki kj kk mo km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">对于这个演示，我将使用TypeScript。JavaScript版本将会很简单，并在文章末尾给出。</p><pre class="lq lr ls lt gt ms mt mu mv aw mw bi"><span id="8954" class="lu lv jg mt b gy mx my l mz na"># Create a react.js starter project with typescript template</span><span id="359f" class="lu lv jg mt b gy nb my l mz na">npx create-react-app idle-timer --template=typescript</span></pre><h2 id="b8fb" class="lu lv jg bd lw lx ly dn lz ma mb dp mc ko md me mf ks mg mh mi kw mj mk ml mm bi translated">构建简单的模型弹出窗口</h2><p id="f2d9" class="pw-post-body-paragraph kd ke jg kf b kg mn ki kj kk mo km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">你可以从头开始设计一个弹出窗口。然而，对于这个演示，我将使用一个简单的CSS UI库<a class="ae jd" href="https://bulma.io/" rel="noopener ugc nofollow" target="_blank"> bulma.io </a>。<em class="nc">布尔玛是一个简单的CSS库，它没有任何其他的JS/CSS依赖。</em></p><p id="8445" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">首先，你需要在<strong class="kf jh"> App.css </strong>中导入CSS模块</p><pre class="lq lr ls lt gt ms mt mu mv aw mw bi"><span id="f567" class="lu lv jg mt b gy mx my l mz na">/* App.css */</span><span id="6fb7" class="lu lv jg mt b gy nb my l mz na">@import "https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css";</span><span id="cd96" class="lu lv jg mt b gy nb my l mz na">.ccontainer {<br/>  font-family: sans-serif;<br/>  text-align: center;<br/>  margin: 10px 20px;<br/>}</span></pre><p id="10b8" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一旦你导入了<strong class="kf jh"> bulma.min.css，</strong>现在你可以使用基本的<strong class="kf jh"> HTML (JSX) </strong>创建一个定制的模态弹出窗口。</p><pre class="lq lr ls lt gt ms mt mu mv aw mw bi"><span id="02ae" class="lu lv jg mt b gy mx my l mz na">// IdlePopup.tsx</span><span id="7538" class="lu lv jg mt b gy nb my l mz na">interface IIdlePopup {}</span><span id="b33d" class="lu lv jg mt b gy nb my l mz na">const IdlePopup = ({}: IIdlePopup) =&gt; {<br/>  return (<br/>    &lt;div className={"modal"}&gt;<br/>      &lt;div className="modal-background"&gt;&lt;/div&gt;<br/>      &lt;div className="modal-card"&gt;<br/>        &lt;header className="modal-card-head"&gt;<br/>          &lt;p className="modal-card-title"&gt;Logout&lt;/p&gt;<br/>          &lt;button className="delete" aria-label="close"&gt;&lt;/button&gt;<br/>        &lt;/header&gt;<br/>        &lt;section className="modal-card-body"&gt;<br/>          &lt;h4 className="subtitle is-4"&gt;<br/>            You are about to logout in 5sec, Do you want to continue?<br/>          &lt;/h4&gt;<br/>        &lt;/section&gt;<br/>        &lt;footer className="modal-card-foot"&gt;<br/>          &lt;button className="button"&gt;Cancel&lt;/button&gt;<br/>          &lt;button className="button is-danger"&gt;Logout&lt;/button&gt;<br/>        &lt;/footer&gt;<br/>      &lt;/div&gt;<br/>    &lt;/div&gt;<br/>  );<br/>};<br/>export default IdlePopup;</span></pre><p id="80b9" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们导入应用程序组件。</p><pre class="lq lr ls lt gt ms mt mu mv aw mw bi"><span id="ae89" class="lu lv jg mt b gy mx my l mz na">## App.tsx</span><span id="0d59" class="lu lv jg mt b gy nb my l mz na">import "./App.css";<br/>import IdlePopup from "./IdlePopup";<br/>function App() {<br/>  return (<br/>    &lt;div className="ccontainer"&gt;<br/>      &lt;p className="title is-3 is-spaced"&gt;Time&lt;/p&gt;<br/>      &lt;p className="subtitle is-5"&gt;&lt;/p&gt;<br/>      &lt;button className="button is-success"&gt;Toggle&lt;/button&gt;<br/>      &lt;IdlePopup /&gt;<br/>    &lt;/div&gt;<br/>  );<br/>}</span><span id="05ee" class="lu lv jg mt b gy nb my l mz na">export default App;</span></pre><p id="b38d" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果你注意到模态是不可见的。为此，我们需要在<strong class="kf jh"> IdleComponent </strong>中添加一个<strong class="kf jh"> show </strong> prop。我们还需要一个onClose回调函数。每当用户按下<strong class="kf jh">注销</strong>或<strong class="kf jh">取消</strong>时，我们必须通知应用程序。</p><pre class="lq lr ls lt gt ms mt mu mv aw mw bi"><span id="8c94" class="lu lv jg mt b gy mx my l mz na">/// IdlePopup.tsx</span><span id="0a55" class="lu lv jg mt b gy nb my l mz na">interface IIdlePopup {<br/>  <strong class="mt jh">show?: boolean;<br/>  onClose: (isLogout: boolean) =&gt; void;</strong><br/>}</span><span id="5fe4" class="lu lv jg mt b gy nb my l mz na">const IdlePopup = ({ <strong class="mt jh">show, onClose</strong> }: IIdlePopup) =&gt; {<br/>  return (<br/>    &lt;div className=<strong class="mt jh">{`modal ${show ? "is-active" : ""}`}</strong>&gt;<br/>      &lt;!-- Rest of the code--/&gt;<br/>          &lt;button<br/>            className="delete"<br/>            aria-label="close"<br/>            <strong class="mt jh">onClick={() =&gt; onClose(false)}</strong><br/>          &gt;&lt;/button&gt;<br/>        &lt;/header&gt;<br/>        &lt;!-- Rest of the code--/&gt;<br/>        &lt;footer className="modal-card-foot"&gt;<br/>          &lt;button className="button" <strong class="mt jh">onClick={() =&gt; onClose(false)}</strong>&gt;<br/>            Cancel<br/>          &lt;/button&gt;<br/>          &lt;button className="button is-danger" <strong class="mt jh">onClick={() =&gt; onClose(true)}</strong>&gt;<br/>            Logout<br/>          &lt;/button&gt;<br/>        &lt;/footer&gt;<br/>      &lt;/div&gt;<br/>    &lt;/div&gt;<br/>  );<br/>};<br/>export default IdlePopup;</span></pre><p id="b89e" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们更新<strong class="kf jh"> App.tsx </strong></p><pre class="lq lr ls lt gt ms mt mu mv aw mw bi"><span id="2837" class="lu lv jg mt b gy mx my l mz na">/// App.tsx</span><span id="33fa" class="lu lv jg mt b gy nb my l mz na">import { useState } from "react";<br/>import "./App.css";<br/>import IdlePopup from "./IdlePopup";</span><span id="a792" class="lu lv jg mt b gy nb my l mz na">function App() {<br/>  <strong class="mt jh">const [open, setOpen] = useState(false);</strong></span><span id="e6d7" class="lu lv jg mt b gy nb my l mz na">return (<br/>    &lt;div className="ccontainer"&gt;<br/>      &lt;p className="title is-3 is-spaced"&gt;Time&lt;/p&gt;<br/>      &lt;p className="subtitle is-5"&gt;&lt;/p&gt;<br/>      &lt;button className="button is-success" <strong class="mt jh">onClick={() =&gt; setOpen(!open)}</strong>&gt;<br/>        Toggle<br/>      &lt;/button&gt;<br/>      &lt;IdlePopup<br/>        <strong class="mt jh">show={open}<br/>        onClose={(isLogout) =&gt; {<br/>          setOpen(false);<br/>          if (isLogout) {<br/>            alert("Logout");<br/>          } else {<br/>            alert("Reset timer..");<br/>          }<br/>        }}</strong><br/>      /&gt;<br/>    &lt;/div&gt;<br/>  );<br/>}</span><span id="ca8f" class="lu lv jg mt b gy nb my l mz na">export default App;</span></pre><p id="6096" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">既然我们的模态弹出窗口已经准备好了。让我们实现定时器逻辑。</p><h2 id="9618" class="lu lv jg bd lw lx ly dn lz ma mb dp mc ko md me mf ks mg mh mi kw mj mk ml mm bi translated"><strong class="ak">定时器</strong></h2><p id="de49" class="pw-post-body-paragraph kd ke jg kf b kg mn ki kj kk mo km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">一段时间的逻辑很简单。你需要在每次挂载时创建一个<strong class="kf jh"> useEffect </strong>你必须绑定一个setTimeout函数。当超时发生时，模式弹出窗口将会打开。根据用户操作，您可以注销或重置计时器。你可以使用一个<strong class="kf jh"> useRef </strong>定时器id来解决这个重置定时器的问题。然而，我将使用一些其他的方法。对于这个问题，我们可以用一个状态变量。给定的<strong class="kf jh">使用效果</strong>观察变量。每当手表变量发生变化时。<strong class="kf jh"> useEffect </strong>将重新触发并创建setTimeout事件。</p><pre class="lq lr ls lt gt ms mt mu mv aw mw bi"><span id="4eb0" class="lu lv jg mt b gy mx my l mz na">/// App.tsx</span><span id="6696" class="lu lv jg mt b gy nb my l mz na">import { useEffect, useState } from "react";<br/>import "./App.css";<br/>import IdlePopup from "./IdlePopup";</span><span id="b620" class="lu lv jg mt b gy nb my l mz na">export enum TIMEOUTS {<br/>  IDLE_TIMEOUT = 60 * 1000, // 60sec<br/>  LOGOUT_POPUP = 10 * 1000,<br/>  ONE_SEC = 1000,<br/>}</span><span id="af3e" class="lu lv jg mt b gy nb my l mz na">function App() {<br/>  const [open, setOpen] = useState(false);<br/>  <strong class="mt jh">const [reset, setReset] = useState(Date.now());</strong></span><span id="0380" class="lu lv jg mt b gy nb my l mz na"><strong class="mt jh">useEffect(() =&gt; {<br/>    const id = setTimeout(() =&gt; {<br/>      setOpen(true);<br/>    }, TIMEOUTS.IDLE_TIMEOUT);</strong></span><span id="408f" class="lu lv jg mt b gy nb my l mz na"><strong class="mt jh">    return clearTimeout.bind(null, id);<br/>  }, [reset]);</strong></span><span id="c01d" class="lu lv jg mt b gy nb my l mz na">  return (<br/>    &lt;div className="ccontainer"&gt;<br/>     &lt;!-- Rest of the code--/&gt;<br/>      &lt;IdlePopup<br/>        show={open}<br/>        onClose={(isLogout) =&gt; {<br/>          setOpen(false);<br/>          if (isLogout) {<br/>            alert("Logout");<br/>          } else {<br/>            <strong class="mt jh">setReset(Date.now());</strong><br/>          }<br/>        }}<br/>      /&gt;<br/>    &lt;/div&gt;<br/>  );<br/>}</span><span id="a654" class="lu lv jg mt b gy nb my l mz na">export default App;</span></pre><h2 id="5254" class="lu lv jg bd lw lx ly dn lz ma mb dp mc ko md me mf ks mg mh mi kw mj mk ml mm bi translated"><strong class="ak">用户中断</strong></h2><p id="3403" class="pw-post-body-paragraph kd ke jg kf b kg mn ki kj kk mo km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">您还想在用户中断时重置定时器。用户中断可以是点击、鼠标移动或API调用。为简单起见，我将使用DOM事件，如单击和鼠标悬停。</p><pre class="lq lr ls lt gt ms mt mu mv aw mw bi"><span id="0e12" class="lu lv jg mt b gy mx my l mz na">/// App.tsx</span><span id="8317" class="lu lv jg mt b gy nb my l mz na">import { useCallback, useEffect, useState } from "react";</span><span id="6913" class="lu lv jg mt b gy nb my l mz na">const domEvents = ["click", "scroll", "keypress"];<br/>function App() {<br/>  const [open, setOpen] = useState(false);<br/>  const [reset, setReset] = useState(Date.now());</span><span id="d46e" class="lu lv jg mt b gy nb my l mz na"><strong class="mt jh">const resetFn = useCallback(() =&gt; setReset(Date.now()), []);</strong></span><span id="34f7" class="lu lv jg mt b gy nb my l mz na"><strong class="mt jh">useEffect(() =&gt; {<br/>    domEvents.forEach((event) =&gt; document.addEventListener(event, resetFn));<br/>    return () =&gt; {<br/>      domEvents.forEach((event) =&gt;<br/>        document.removeEventListener(event, resetFn)<br/>      );<br/>    };<br/>  }, [resetFn]);</strong><br/>  <br/>  return (<br/>    &lt;div className="ccontainer"&gt;<br/>      &lt;!-- Rest of the code--/&gt;<br/>    &lt;/div&gt;<br/>  );<br/>}</span><span id="a04f" class="lu lv jg mt b gy nb my l mz na">export default App;</span></pre><h2 id="6a5f" class="lu lv jg bd lw lx ly dn lz ma mb dp mc ko md me mf ks mg mh mi kw mj mk ml mm bi translated">倒计时[可选]</h2><p id="5ca1" class="pw-post-body-paragraph kd ke jg kf b kg mn ki kj kk mo km kn ko mp kq kr ks mq ku kv kw mr ky kz la ij bi translated">倒计时在其他功能中也很棘手。最大的挑战是根据时间同时显示倒计时和触发onClose。下面给出的代码有点粗糙。你可以根据你的需要来清理。</p><pre class="lq lr ls lt gt ms mt mu mv aw mw bi"><span id="d1d5" class="lu lv jg mt b gy mx my l mz na">/// IdlePopup.tsx</span><span id="d922" class="lu lv jg mt b gy nb my l mz na">import { useEffect, useRef, useState } from "react";<br/>import { TIMEOUTS } from "./App";</span><span id="0e77" class="lu lv jg mt b gy nb my l mz na">// &lt;!-- Rest of the code--/&gt;</span><span id="e543" class="lu lv jg mt b gy nb my l mz na">const IdlePopup = ({ show, onClose }: IIdlePopup) =&gt; {</span><span id="e833" class="lu lv jg mt b gy nb my l mz na">  <strong class="mt jh">const [time, setTime] = useState(TIMEOUTS.LOGOUT_POPUP / TIMEOUTS.ONE_SEC);<br/>  const mounted = useRef(0);</strong></span><span id="9527" class="lu lv jg mt b gy nb my l mz na"><strong class="mt jh">useEffect(() =&gt; {<br/>    if (show) {<br/>      if (time &lt;= 1) {<br/>        mounted.current &amp;&amp; window.clearTimeout(mounted.current);<br/>        onClose(true);<br/>        return;<br/>      }<br/>      mounted.current = window.setTimeout(<br/>        () =&gt; setTime(time - 1),<br/>        TIMEOUTS.ONE_SEC<br/>      );<br/>    } else {<br/>      setTime(TIMEOUTS.LOGOUT_POPUP / TIMEOUTS.ONE_SEC);<br/>    }<br/>    return () =&gt; {<br/>      mounted.current &amp;&amp; window.clearTimeout(mounted.current);<br/>    };<br/>  }, [show, time]);</strong></span><span id="c8c5" class="lu lv jg mt b gy nb my l mz na">return (<br/>    &lt;div className={`modal ${show ? "is-active" : ""}`}&gt;<br/>      &lt;div className="modal-background"&gt;&lt;/div&gt;<br/>      &lt;div className="modal-card"&gt;<br/>        &lt;!-- Rest of the code--/&gt;<br/>        &lt;section className="modal-card-body"&gt;<br/>          &lt;h4 className="subtitle is-4"&gt;<br/>            You are about to logout in <strong class="mt jh">{time}</strong>, Do you want to continue?<br/>          &lt;/h4&gt;<br/>        &lt;/section&gt;<br/>        &lt;!-- Rest of the code--/&gt;<br/>      &lt;/div&gt;<br/>    &lt;/div&gt;<br/>  );<br/>};<br/>export default IdlePopup;</span></pre><p id="dda3" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">完整的工作解决方案可以在CodeSandbox上找到。JavaScript版本可以参考App2.js和IdlePopup2.js。</p><figure class="lq lr ls lt gt is"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="822f" class="pw-post-body-paragraph kd ke jg kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="nc">更多内容请看</em><a class="ae jd" href="http://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><strong class="kf jh"><em class="nc">plain English . io</em></strong></a></p></div></div>    
</body>
</html>