<html>
<head>
<title>Creating a REST API with NestJS — Part 04 — Quick Adding a Dockerfile with Reduced Image Size</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用NestJS创建REST API第4部分——快速添加一个缩减了图像大小的Dockerfile文件</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/create-reduced-docker-images-in-your-nestjs-application-b25ab32a840d?source=collection_archive---------7-----------------------#2021-05-02">https://javascript.plainenglish.io/create-reduced-docker-images-in-your-nestjs-application-b25ab32a840d?source=collection_archive---------7-----------------------#2021-05-02</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><p id="4bf3" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在本文中，我们将扩展当前的NestJS项目，快速添加一个Dockerfile的实际工作示例，作为容器运行。</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi kl"><img src="../Images/5de610aac12ea33dd58751c9858c7326.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*hHWW7iG7xW2ratEa.jpeg"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk">NestJS / Part 05</figcaption></figure><p id="4a84" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">本文将主要关注一个常见的NestJS问题:如果不做一些处理，基本图像可能会变得非常大。我们将专注于为我们的NestJS REST应用程序创建一个缩小的图像大小！</p><p id="0d37" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果您只对Dockerfile部分感兴趣，只需跳过快速介绍，继续前进。</p><p id="1c88" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">如果你不知道我的文章系列，你可以从第<strong class="jp ir">篇第</strong>篇<a class="ae lb" href="https://makinhs.medium.com/creating-a-rest-api-series-with-nestjs-part-01-scaffolding-and-basic-cli-usage-30ace19c5bb8" rel="noopener">这里</a>开始。</p><p id="4a99" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们正在使用NestJS构建一个REST API，但是在我使用NestJS(但是使用GraphQL)的前几周，我在几个项目中遇到了一个共同的问题:Dockerfile。如果你知道使用docker的基本知识，你可以去Google看看如何构建docker映像，对于大多数简单的后端搭建或类似的东西，你可以找到一些超级相似的东西:</p><pre class="km kn ko kp gt lc ld le lf aw lg bi"><span id="c81c" class="lh li iq ld b gy lj lk l ll lm">FROM node:14.15.0-alpine3.10<br/><br/>USER 2000<br/>RUN mkdir -p /home/node/app/node_modules &amp;&amp; chown -R 2000:2000 /home/node/app<br/><br/>WORKDIR /home/node/app<br/>COPY --chown=2000:2000 . /home/node/app</span><span id="7cd5" class="lh li iq ld b gy ln lk l ll lm">RUN yarn install</span><span id="ff2f" class="lh li iq ld b gy ln lk l ll lm">RUN yarn build<br/><br/>EXPOSE 3000<br/><br/>ENTRYPOINT ["node"]<br/>CMD ["/home/node/app/dist/main.js"]</span></pre><p id="5845" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">太棒了，效果很好。你可以做一个快速的谷歌来理解为什么我们要设置一个用户而不是使用一个根用户(你应该这样做)。</p><p id="278b" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这里隐藏的问题是，如果您在一个NestJS项目中运行它，最终的映像(只有一个基本的Rest API和Express，甚至没有GraphQL模块)将超过900MB！</p><p id="006c" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">要自己看到这一点，拿我以前的<a class="ae lb" href="https://makinhs.medium.com/creating-a-rest-api-with-nestjs-part-03-services-postgresql-and-typeorm-81ccc2640006" rel="noopener">文章</a>中的这个<a class="ae lb" href="https://github.com/makinhs/nestjs-api-tutorial/tree/003" rel="noopener ugc nofollow" target="_blank">样本</a>库。在你的计算机中有了代码之后，在根目录下添加一个名为<strong class="jp ir"> Dockerfile </strong>的文件，并粘贴上面的代码。然后不要忘记<strong class="jp ir">添加一个. dockerignore文件，并在那里添加node_modules/现在，您可以开始运行了:</strong></p><pre class="km kn ko kp gt lc ld le lf aw lg bi"><span id="528f" class="lh li iq ld b gy lj lk l ll lm">docker build -t nestjs-api .</span></pre><p id="a7ba" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">这将创建您的构建，然后您可以使用(我使用的是Mac)检查图像的大小:</p><pre class="km kn ko kp gt lc ld le lf aw lg bi"><span id="2de9" class="lh li iq ld b gy lj lk l ll lm">docker images | grep nestjs-api</span></pre><p id="d4dc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在我写这篇文章的时候，你会发现它的大小大约是927MB。对于Node.js来说，project this<strong class="jp ir">太大</strong>。最重要的但不仅仅是:</p><figure class="km kn ko kp gt kq gh gi paragraph-image"><div role="button" tabindex="0" class="kr ks di kt bf ku"><div class="gh gi lo"><img src="../Images/83d8e0467487ecd584a2c83da5340363.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*mWr3OFWTpGZPcuMV.png"/></div></div><figcaption class="kx ky gj gh gi kz la bd b be z dk">From another <a class="ae lb" href="https://medium.com/front-end-weekly/journey-to-the-center-of-node-modules-372bff7193b6" rel="noopener">article</a></figcaption></figure><p id="9c10" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">那怎么解决呢？第一件事是始终检查你实际使用的图像。我通常使用阿尔卑斯山图片，你可以在<a class="ae lb" href="https://hub.docker.com/_/node" rel="noopener ugc nofollow" target="_blank"> docker </a>中找到node alpine官方图片。在本文中，我使用的是<strong class="jp ir">节点:14.15.0-alpine3.10 </strong>，因为版本16刚刚发布，一些安全模块可能无法使用它(针对您自己的场景进行测试)。但即使使用它，我们仍然有这个大小的问题。</p><p id="b8a6" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用前不要忘记扫描图像:</p><pre class="km kn ko kp gt lc ld le lf aw lg bi"><span id="d22d" class="lh li iq ld b gy lj lk l ll lm">docker scan node:14.15.0-alpine3.10</span></pre><p id="10cf" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">只需将<strong class="jp ir">节点:14 . 15 . 0-输卵管3.10 </strong>更改为您正在使用的图像，并保持愉快。</p><p id="f2d8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">下一步是用<a class="ae lb" href="https://github.com/tj/node-prune" rel="noopener ugc nofollow" target="_blank">节点删除</a>来删除您的文件，不要忘记锁定您的纱线文件，并从已安装/更新的<strong class="jp ir"> apk </strong>中删除缓存。</p><pre class="km kn ko kp gt lc ld le lf aw lg bi"><span id="e51a" class="lh li iq ld b gy lj lk l ll lm">FROM node:14.15.0-alpine3.10<br/><br/>RUN apk update &amp;&amp; apk add yarn curl bash make &amp;&amp; rm -rf /var/cache/apk/*<br/><br/>RUN curl -sfL https://install.goreleaser.com/github.com/tj/node-prune.sh | bash -s -- -b /usr/local/bin<br/><br/>USER 1000<br/>RUN mkdir -p /home/node/app/node_modules &amp;&amp; chown -R 1000:1000 /home/node/app<br/><br/>WORKDIR /home/node/app<br/><br/>RUN yarn --frozen-lockfile</span><span id="0683" class="lh li iq ld b gy ln lk l ll lm">COPY . .</span><span id="81b1" class="lh li iq ld b gy ln lk l ll lm">RUN yarn install</span><span id="8942" class="lh li iq ld b gy ln lk l ll lm">RUN yarn build<br/><br/>RUN npm prune --production<br/><br/>RUN /usr/local/bin/node-prune<br/><br/>EXPOSE 3000<br/><br/>ENTRYPOINT ["node"]<br/>CMD ["/home/node/app/dist/main.js"]</span></pre><p id="aa78" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">使用更新的Dockerfile将安装一些必要的模块来添加节点。经过新的构建后，您可以看到图像大小现在减小到~411MB。</p><pre class="km kn ko kp gt lc ld le lf aw lg bi"><span id="ce8a" class="lh li iq ld b gy lj lk l ll lm">docker images | grep nestjs-api<br/>nestjs-api     ... 411MB</span></pre><p id="d8fc" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">进步很大，对吧？在受到这篇<a class="ae lb" href="https://medium.com/trendyol-tech/how-we-reduce-node-docker-image-size-in-3-steps-ff2762b51d5a" rel="noopener">好文章</a>的启发后，让我们把它分成两张图片，一张用来构建我们需要的东西，另一张用来复制实际需要的东西。</p><pre class="km kn ko kp gt lc ld le lf aw lg bi"><span id="238f" class="lh li iq ld b gy lj lk l ll lm">FROM node:14.16.1-alpine3.10 AS <em class="lp">BUILD_IMAGE<br/><br/></em>RUN apk update &amp;&amp; apk add yarn curl bash make &amp;&amp; rm -rf /var/cache/apk/*<br/><br/>RUN curl -sfL https://install.goreleaser.com/github.com/tj/node-prune.sh | bash -s -- -b /usr/local/bin<br/><br/>WORKDIR /usr/src/app<br/><br/># install dependencies<br/>RUN yarn --frozen-lockfile<br/><br/>COPY . .</span><span id="5492" class="lh li iq ld b gy ln lk l ll lm">RUN yarn install</span><span id="8ae4" class="lh li iq ld b gy ln lk l ll lm">RUN yarn build<br/><br/>RUN npm prune --production<br/><br/>RUN /usr/local/bin/node-prune<br/><br/>FROM node:14.16.1-alpine3.10<br/><br/>USER 1000<br/>RUN mkdir -p /home/node/app/<br/>RUN mkdir -p /home/node/app/node_modules<br/>RUN mkdir -p /home/node/app/dist<br/><br/>RUN chown -R 1000:1000 /home/node/app<br/>RUN chown -R 1000:1000 /home/node/app/node_modules<br/>RUN chown -R 1000:1000 /home/node/app/dist<br/><br/>WORKDIR /home/node/app<br/><br/>COPY --from=<em class="lp">BUILD_IMAGE </em>/usr/src/app/dist /home/node/app/dist<br/>COPY --from=<em class="lp">BUILD_IMAGE </em>/usr/src/app/node_modules /home/node/app/node_modules<br/><br/>EXPOSE 3000<br/>ENTRYPOINT ["node"]<br/>CMD ["/home/node/app/dist/main.js"]</span></pre><p id="437d" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">运行此更新的docker后，您可以再次检查图像大小，您会发现这令人难以置信:</p><pre class="km kn ko kp gt lc ld le lf aw lg bi"><span id="76f1" class="lh li iq ld b gy lj lk l ll lm">docker images | grep nestjs-api<br/>nestjs-api       ... 162MB</span></pre><p id="9b59" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">162MB相对于~900MB。那是一个超级缩小的图像！</p><p id="f7df" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">我们现在可以使用最新的node 16 alpine:</p><pre class="km kn ko kp gt lc ld le lf aw lg bi"><span id="b03e" class="lh li iq ld b gy lj lk l ll lm">FROM node:16-alpine3.11 AS <em class="lp">BUILD_IMAGE<br/><br/></em>RUN apk update &amp;&amp; apk add yarn curl bash make &amp;&amp; rm -rf /var/cache/apk/*<br/><br/>RUN curl -sfL https://install.goreleaser.com/github.com/tj/node-prune.sh | bash -s -- -b /usr/local/bin<br/><br/>WORKDIR /usr/src/app<br/><br/># install dependencies<br/>RUN yarn --frozen-lockfile<br/><br/>COPY . .<br/><br/>RUN yarn install<br/>RUN yarn build<br/><br/>RUN npm prune --production<br/><br/>RUN /usr/local/bin/node-prune<br/><br/>FROM node:16-alpine3.11<br/><br/>USER 1000<br/>RUN mkdir -p /home/node/app/<br/>RUN mkdir -p /home/node/app/node_modules<br/>RUN mkdir -p /home/node/app/dist<br/><br/>RUN chown -R 1000:1000 /home/node/app<br/>RUN chown -R 1000:1000 /home/node/app/node_modules<br/>RUN chown -R 1000:1000 /home/node/app/dist<br/><br/>WORKDIR /home/node/app<br/><br/>COPY --from=<em class="lp">BUILD_IMAGE </em>/usr/src/app/dist /home/node/app/dist<br/>COPY --from=<em class="lp">BUILD_IMAGE </em>/usr/src/app/node_modules /home/node/app/node_modules<br/><br/>EXPOSE 3000<br/>ENTRYPOINT ["node"]<br/>CMD ["/home/node/app/dist/main.js"]</span></pre><p id="96cb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">最终结果将为~156MB。</p></div><div class="ab cl lq lr hu ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="ij ik il im in"><p id="d190" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">另外一件要记住的事情是使用<a class="ae lb" href="https://brianchristner.io/what-is-docker-buildkit/" rel="noopener ugc nofollow" target="_blank"> docker build kit </a>来提高性能。要使用它，只需运行以下命令:</p><pre class="km kn ko kp gt lc ld le lf aw lg bi"><span id="a920" class="lh li iq ld b gy lj lk l ll lm">time DOCKER_BUILDKIT=1 docker build -t nestjs-api .</span></pre></div><div class="ab cl lq lr hu ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="ij ik il im in"><p id="5ed8" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated">在本文中，我分享了一些关于如何减少NestJS映像构建的技巧。这可能不是最终的解决方案，但它确实会在构建后减小您的图像大小。最后几点想法:</p><ul class=""><li id="26b8" class="lx ly iq jp b jq jr ju jv jy lz kc ma kg mb kk mc md me mf bi translated">每个项目都有其特定的需求。确保满足您的所有需求，而不仅仅是将文件复制并粘贴到其他任何地方。</li><li id="c3a9" class="lx ly iq jp b jq mg ju mh jy mi kc mj kg mk kk mc md me mf bi translated">务必使用<strong class="jp ir"> docker扫描扫描您的图像。</strong></li><li id="377c" class="lx ly iq jp b jq mg ju mh jy mi kc mj kg mk kk mc md me mf bi translated">不要忘记查看node-alpine版本中的更新，或者您可能喜欢使用的另一个常用图像。</li><li id="a71a" class="lx ly iq jp b jq mg ju mh jy mi kc mj kg mk kk mc md me mf bi translated">如果你在你的NestJS项目中使用GraphQL，图像大小将会增加到100MB左右，这是由于它自身的要求(虽然应该不是问题)。</li><li id="3d16" class="lx ly iq jp b jq mg ju mh jy mi kc mj kg mk kk mc md me mf bi translated">您可以在这里找到一个工作的源样本<a class="ae lb" href="https://github.com/makinhs/nestjs-api-tutorial/tree/003-docker" rel="noopener ugc nofollow" target="_blank">..</a></li><li id="cbd1" class="lx ly iq jp b jq mg ju mh jy mi kc mj kg mk kk mc md me mf bi translated">特别感谢<a class="ae lb" href="https://medium.com/@scokmen" rel="noopener"><strong class="jp ir">Soner kmen</strong></a><strong class="jp ir"/>他的文章极大地鼓舞了我。</li></ul><p id="ebfb" class="pw-post-body-paragraph jn jo iq jp b jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk ij bi translated"><em class="lp">更多内容参见</em> <a class="ae lb" href="http://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <em class="lp">简明英语. io </em> </a></p></div></div>    
</body>
</html>