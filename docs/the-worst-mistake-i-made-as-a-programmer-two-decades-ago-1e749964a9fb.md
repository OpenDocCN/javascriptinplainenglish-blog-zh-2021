# 二十年前，作为一名程序员，我犯的最严重的错误

> 原文：<https://javascript.plainenglish.io/the-worst-mistake-i-made-as-a-programmer-two-decades-ago-1e749964a9fb?source=collection_archive---------18----------------------->

## 当我们找到问题的根源时，我正处于困境中。

![](img/eb092f87e1e2133097ace5304fc23088.png)

Photo by [Ben White](https://unsplash.com/@benwhitephotography?utm_source=medium&utm_medium=referral) on [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral)

先说编程问题，然后我会设定 bug 出现并产生严重后果的特定场景。

首先，关于并发编程的一些信息。在同一个程序中并行执行几个过程通常是有用的，甚至是必要的。

通常，这些被称为活动的治疗并不是完全独立的。通常，在执行不同的活动时，必须遵守一定的时间限制。其他活动共享某些信息也很常见。

随着这些信息的不断发展，必须并行写入和读取。这就产生了数据一致性的问题。的确，如果两个活动并行修改相同的数据，那么数据的最终值会是多少？

即使单个活动改变了数据的值，并且一个或多个活动读取了该数据，如果所述数据是复合的，也就是说，如果它包括几个子数据(如果您愿意，也可以是几个子值)，则可能会出现一致性问题。

实际上，假设修改数据的活动在读取数据的同时开始改变子值。在这种情况下，该活动将具有不一致的数据，因为只有它的一部分子值将被改变，修改操作不是原子的。

这听起来很复杂吗？嗯，实际上，是的。并发编程是强大的，通常是良好性能的必要条件，但它是一件棘手的事情——坦白地说，做起来很有趣，但那是另一个话题。

使用各种工具来适当地管理活动的调度和对共享数据的访问，例如信号量和互斥体。在不涉及太多技术细节的情况下，我们可以粗略地说，必须拥有一个互斥体来访问数据。

因此，必须访问数据的活动将请求获得互斥体。一旦获得这个互斥体，就不会有其他活动访问该数据。因此，一方面，数据修改将是原子性的，另一方面，读取将不会受到并发写入的干扰。

## 好了，现在是窃听器。

作为移植一个相对较大的软件(大约一百万行代码，包括注释)的一部分，我必须使用共享数据修改一个过程。这些数据受到互斥体的保护。问题是，由于计划的压力，我看过程有点太快，没有看到它使用了互斥。

在我看来，代码(不是我的)是 C 语言的，而且相对复杂(通过宏处理互斥体，不酷)。我所做的修改确实获取了互斥体(从另一段代码中复制并粘贴),但没有释放它。

因此，所有其他活动都无法再访问这些数据。因此，它们被阻塞了——这是一个基本错误，通常应该在测试过程中发现。

测试这个系统并不容易。计划的压力很大，这个 bug 没有被注意到，特别是因为系统必须负载很重才会出现 bug；在低负载或正常负载下，错误不会出现。

## 现在的语境。

客户是一家出版社。当时它是我们公司最大的客户之一。他们的业务是出售信息。它在世界上几乎每个发达国家都有办事处或至少有记者。

问题中的系统是一个编辑系统，一种机构的 IT 骨干。他接收记者起草的新闻报道，并负责在全世界分发、处理、存档等工作。

移植是在 2001 年进行的，历时几个月。实际上是从 2001 年 6 月到 7 月左右开始的。有关的修改是在 2001 年 8 月底进行的。

我不知道你是否记得，但是大约在 2001 年 9 月，在美国发生了一些事情，引起了很多人的兴趣。我说的当然是 911 袭击。显然，新闻机构都很紧张，法新社和其他媒体一样。该机构发布的新闻数量突然以地狱般的速度增长……直到错误被触发并阻塞了编辑系统，因为没有任何活动可以访问这些宝贵的数据！

这场灾难的辉煌。该机构不得不通过其他系统来制作新闻稿，但在重组之前浪费了宝贵的时间。听说法新社的 CEO 给编辑系统的控制室打电话，想知道这是哪里。这都是我的错，没有仔细看看这个程序是如何工作的。我可以告诉你，当我们找到问题的根源时，我是在我的小鞋里。

*更多内容看* [***说白了. io***](http://plainenglish.io/) ***。*** *报名参加我们的* [***免费每周简讯点击这里***](http://newsletter.plainenglish.io/) ***。***