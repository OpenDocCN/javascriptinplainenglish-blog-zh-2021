<html>
<head>
<title>Sign-in with Apple in an Angular Web App</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Angular Web应用程序中登录Apple</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/sign-in-with-apple-in-angular-web-app-630a9791e291?source=collection_archive---------1-----------------------#2021-05-09">https://javascript.plainenglish.io/sign-in-with-apple-in-angular-web-app-630a9791e291?source=collection_archive---------1-----------------------#2021-05-09</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/eb8827a4355145b699a4c9c3658ea82b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RSEkwdGDFBsms1BPsdjYIg.jpeg"/></div></div></figure><blockquote class="jv jw jx"><p id="7d89" class="jy jz ka kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">如今，大多数网络应用都有社交登录功能。对于最终用户来说，这是一种更方便的向系统进行安全认证的方式。它将把你的网站定义为具有用户友好的和比普通授权更好的。</p></blockquote><p id="a427" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">众所周知，最流行的社交认证是登录谷歌和脸书。而现在，苹果也跳进了这个栈桶，做一个超级酷的第三方授权提供商。</p><p id="0b3f" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">在这篇文章中，我们将介绍使用Angular/React/Node或任何JavaScript框架登录苹果的集成。</p><p id="f6c9" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">听起来很棒，对吧？让我们开始… </p></div><div class="ab cl la lb hr lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="ig ih ii ij ik"><h1 id="45c0" class="lh li in bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">登录Apple的基本流程是:</h1><ol class=""><li id="d462" class="mf mg in kb b kc mh kg mi kx mj ky mk kz ml kw mm mn mo mp bi translated"><a class="ae mq" href="https://appleid.apple.com/signinwithapple/button" rel="noopener ugc nofollow" target="_blank">点击“登录苹果”按钮</a></li><li id="998c" class="mf mg in kb b kc mr kg ms kx mt ky mu kz mv kw mm mn mo mp bi translated">您的应用程序的当前父选项卡将在新的子选项卡中打开Apple的登录页面，浏览器URL中的一些元数据将作为查询参数。</li><li id="792d" class="mf mg in kb b kc mr kg ms kx mt ky mu kz mv kw mm mn mo mp bi translated">用户在使用Apple凭证后验证身份，并被重定向回URL，这是我们导航的父选项卡。</li><li id="5d9b" class="mf mg in kb b kc mr kg ms kx mt ky mu kz mv kw mm mn mo mp bi translated">Apple将发送一个“FORM_POST”请求，其中包含苹果开发者帐户配置中指定的重定向url的数据。</li><li id="378f" class="mf mg in kb b kc mr kg ms kx mt ky mu kz mv kw mm mn mo mp bi translated">用户完成并验证其网站的注册流程。现在，您可以将下一个请求应用到授权用户的流程中。</li></ol><blockquote class="jv jw jx"><p id="e682" class="jy jz ka kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated"><strong class="kb io">在此，我附上上述步骤的简单流程图说明:</strong></p></blockquote><figure class="mx my mz na gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mw"><img src="../Images/7fd60c571f11a0d8f75a9d470c891adb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8S7jg88a881H_oOQk7PWsA.jpeg"/></div></div><figcaption class="nb nc gj gh gi nd ne bd b be z dk">Basic Diagram of Sign In With Apple</figcaption></figure></div><div class="ab cl la lb hr lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="ig ih ii ij ik"><blockquote class="jv jw jx"><p id="839d" class="jy jz ka kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">在深入研究代码结构之前，首先我们需要在Apple developer帐户上配置我们的应用程序，从那里，我们将获得构建URL所需的元数据。</p></blockquote><p id="db71" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated"><strong class="kb io">来自苹果开发者账户的必需元数据:</strong></p><ol class=""><li id="9053" class="mf mg in kb b kc kd kg kh kx nf ky ng kz nh kw mm mn mo mp bi translated"><strong class="kb io">客户端ID: </strong>我们将从服务ID配置中获取它作为标识符值。示例:“com.myapp.bundle.backend”</li><li id="396c" class="mf mg in kb b kc mr kg ms kx mt ky mu kz mv kw mm mn mo mp bi translated"><strong class="kb io">重定向URL: </strong>这是我们将在Web身份验证配置设置→网站URL→返回/重定向URL中添加的URL。例如:https://www.abc.com/api/auth-apple-signin</li></ol><h1 id="06d8" class="lh li in bd lj lk ni lm ln lo nj lq lr ls nk lu lv lw nl ly lz ma nm mc md me bi translated"><strong class="ak">获取元数据需要执行的步骤:</strong></h1><ul class=""><li id="a12f" class="mf mg in kb b kc mh kg mi kx mj ky mk kz ml kw nn mn mo mp bi translated">首先，<a class="ae mq" href="https://www.google.co.in/url?sa=t&amp;rct=j&amp;q=&amp;esrc=s&amp;source=web&amp;cd=&amp;cad=rja&amp;uact=8&amp;ved=2ahUKEwigkYn26LzwAhXFX3wKHcgUA3EQFjAAegQIAxAE&amp;url=https%3A%2F%2Fdeveloper.apple.com%2F&amp;usg=AOvVaw1qN8yLk7zDjnuzW8OlcbLm" rel="noopener ugc nofollow" target="_blank">登录苹果开发者账户</a>，点击证书、标识符和个人资料。</li><li id="81a3" class="mf mg in kb b kc mr kg ms kx mt ky mu kz mv kw nn mn mo mp bi translated">从边栏中，选择标识符，然后单击蓝色加号图标。</li><li id="4a19" class="mf mg in kb b kc mr kg ms kx mt ky mu kz mv kw nn mn mo mp bi translated">在第一步中选择<strong class="kb io">应用id</strong>。</li><li id="750b" class="mf mg in kb b kc mr kg ms kx mt ky mu kz mv kw nn mn mo mp bi translated">选择platform作为“iOS”，在description中输入一些描述性的词语，然后选择Bundle ID:“Explicit”并输入值，如下例所示。“com . myapp . bundle”→用您的app_name替换myapp文本。</li><li id="f36b" class="mf mg in kb b kc mr kg ms kx mt ky mu kz mv kw nn mn mo mp bi translated">现在向下滚动，选中“登录苹果”旁边的框。</li><li id="5b21" class="mf mg in kb b kc mr kg ms kx mt ky mu kz mv kw nn mn mo mp bi translated">确认并转到配置下一步，即<strong class="kb io">服务id。</strong></li><li id="c0ae" class="mf mg in kb b kc mr kg ms kx mt ky mu kz mv kw nn mn mo mp bi translated">输入描述，并在“标识符”字段中输入“com.myapp.bundle.backend ”,同时选中“使用Apple登录”复选框，然后单击“配置”。</li><li id="96ee" class="mf mg in kb b kc mr kg ms kx mt ky mu kz mv kw nn mn mo mp bi translated">现在，您进入了Web身份验证配置屏幕，您必须从主要应用ID中选择您的应用(确保您选择的是以您的应用名称开头的应用)。</li><li id="8aaf" class="mf mg in kb b kc mr kg ms kx mt ky mu kz mv kw nn mn mo mp bi translated">在您将向苹果服务器发送请求的网站URL中输入域/子域(您可以添加多个URL；不要添加本地主机或IP地址，因为这是不允许的，例如:https://www.abc.com/)。</li><li id="ecee" class="mf mg in kb b kc mr kg ms kx mt ky mu kz mv kw nn mn mo mp bi translated">输入重定向网址，苹果将在认证用户后发送回响应。例如:https://www.abc.com/api/auth-apple-signin</li></ul></div><div class="ab cl la lb hr lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="ig ih ii ij ik"><blockquote class="jv jw jx"><p id="b6a7" class="jy jz ka kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">我们已经完成了配置并获得了所需的元数据，现在让我们深入研究代码。</p></blockquote><ul class=""><li id="a76c" class="mf mg in kb b kc kd kg kh kx nf ky ng kz nh kw nn mn mo mp bi translated">在第一步中，我们需要构建由Apple提供的URL，并对其进行重定向，以便用户可以在那里输入Apple凭据:</li><li id="dc75" class="mf mg in kb b kc mr kg ms kx mt ky mu kz mv kw nn mn mo mp bi translated">网址:【https://appleid.apple.com/auth/authorize T2】/QUERY _ PARAMS</li><li id="23e8" class="mf mg in kb b kc mr kg ms kx mt ky mu kz mv kw nn mn mo mp bi translated">我们需要附加一些元数据作为查询参数，这样苹果服务器就可以从这些数据中验证我们的请求。</li></ul><pre class="mx my mz na gt no np nq nr aw ns bi"><span id="9fd1" class="nt li in np b gy nu nv l nw nx">Meta Data :</span><span id="80f9" class="nt li in np b gy ny nv l nw nx">client_id -&gt; com.myapp.bundle.backend</span><span id="5b8e" class="nt li in np b gy ny nv l nw nx">redirect_uri -&gt; <a class="ae mq" href="https://www.abc.com/api/auth-apple-signin" rel="noopener ugc nofollow" target="_blank">https://www.abc.com/api/auth-apple-signin<br/></a><br/>response_type -&gt; Type of response we want from apple<br/><br/>scope -&gt; Required user’s data back after authenticate with apple<br/><br/>response_mode -&gt; form_post ( Type format of response )</span></pre><ul class=""><li id="9e4b" class="mf mg in kb b kc kd kg kh kx nf ky ng kz nh kw nn mn mo mp bi translated"><a class="ae mq" href="https://developer.apple.com/documentation/sign_in_with_apple/sign_in_with_apple_js/incorporating_sign_in_with_apple_into_other_platforms#3332113" rel="noopener ugc nofollow" target="_blank">点击此处阅读更多查询参数</a>。</li><li id="9cf7" class="mf mg in kb b kc mr kg ms kx mt ky mu kz mv kw nn mn mo mp bi translated"><a class="ae mq" href="https://developer.apple.com/documentation/sign_in_with_apple/sign_in_with_apple_js/incorporating_sign_in_with_apple_into_other_platforms" rel="noopener ugc nofollow" target="_blank">点击这里阅读更多关于苹果文档</a>中描述的登录过程。</li></ul><figure class="mx my mz na gt jo"><div class="bz fp l di"><div class="nz oa l"/></div><figcaption class="nb nc gj gh gi nd ne bd b be z dk">JavaScript Code</figcaption></figure><blockquote class="jv jw jx"><p id="9f05" class="jy jz ka kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">苹果会将数据发送回redirect_uri，并在后端处理。因此，问题是我们如何将这些数据传递给Angular，以便我们的应用程序可以进行下一步操作？为了解决这个问题，我们需要应用一些自定义的东西。</p></blockquote><ul class=""><li id="6dc5" class="mf mg in kb b kc kd kg kh kx nf ky ng kz nh kw nn mn mo mp bi translated"><a class="ae mq" href="https://developer.mozilla.org/en-US/docs/Web/API/Window/open" rel="noopener ugc nofollow" target="_blank"><strong class="kb io">window . open(' URL ')</strong></a><strong class="kb io">:</strong>此方法用于从当前父标签页打开一个新的子标签页。</li><li id="9b9a" class="mf mg in kb b kc mr kg ms kx mt ky mu kz mv kw nn mn mo mp bi translated"><a class="ae mq" href="https://developer.mozilla.org/en-US/docs/Web/API/EventTarget/addEventListener" rel="noopener ugc nofollow" target="_blank"><strong class="kb io">window . addevent listener(' message ')</strong></a><strong class="kb io">:</strong>该方法将激活父选项卡中等待数据的监听器，因此当我们在redirect_uri中从Apple获取数据时，在此之后，该数据将作为API的响应作为消息事件发送回该监听器。</li><li id="d084" class="mf mg in kb b kc mr kg ms kx mt ky mu kz mv kw nn mn mo mp bi translated"><strong class="kb io">jwthelper . decodetoken(event . data . id _ token):</strong>解码此令牌将提供用户的数据，包括电子邮件、订阅、过期时间。</li><li id="a1e3" class="mf mg in kb b kc mr kg ms kx mt ky mu kz mv kw nn mn mo mp bi translated">电子邮件可以显示/隐藏，因为苹果为用户提供了隐私选项。因此，为了验证用户的身份，我们使用<strong class="kb io"> sub </strong>的值，因为它是恒定的和唯一的。</li></ul><h2 id="48eb" class="nt li in bd lj ob oc dn ln od oe dp lr kx of og lv ky oh oi lz kz oj ok md ol bi translated"><strong class="ak">谨记:</strong></h2><ol class=""><li id="9c72" class="mf mg in kb b kc mh kg mi kx mj ky mk kz ml kw mm mn mo mp bi translated">当用户第一次仅以数据形式登录时，Apple将发送用户的名字和姓氏。因此，我们需要检查这个对象→ event.data.user</li><li id="d1fc" class="mf mg in kb b kc mr kg ms kx mt ky mu kz mv kw mm mn mo mp bi translated">从'<a class="ae mq" href="http://twitter.com/auth0/angular-jwt" rel="noopener ugc nofollow" target="_blank"> @auth0/angular-jwt </a>导入{ JwtHelperService }→使用此jwt帮助器解码令牌并从中获取值。</li></ol><blockquote class="jv jw jx"><p id="1f1f" class="jy jz ka kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">现在，让我们创建一个API路由来处理来自苹果的请求。</p></blockquote><figure class="mx my mz na gt jo"><div class="bz fp l di"><div class="nz oa l"/></div><figcaption class="nb nc gj gh gi nd ne bd b be z dk">Node API Code</figcaption></figure><ul class=""><li id="b4f8" class="mf mg in kb b kc kd kg kh kx nf ky ng kz nh kw nn mn mo mp bi translated">API路由将与我们在redirect_uri值中提供的相同。</li><li id="b690" class="mf mg in kb b kc mr kg ms kx mt ky mu kz mv kw nn mn mo mp bi translated">目前，用户在Apple登录的子选项卡上，我们的父选项卡正在等待/监听事件以获取数据。</li><li id="815d" class="mf mg in kb b kc mr kg ms kx mt ky mu kz mv kw nn mn mo mp bi translated">我们需要将响应作为脚本标记和<a class="ae mq" href="https://developer.mozilla.org/en-US/docs/Web/API/Window/opener" rel="noopener ugc nofollow" target="_blank"> <strong class="kb io"> window.opener </strong> </a>方法进行传递，检查子选项卡是否打开，然后使用<a class="ae mq" href="https://developer.mozilla.org/en-US/docs/Web/API/Window/close" rel="noopener ugc nofollow" target="_blank"><strong class="kb io">window . close</strong></a><strong class="kb io"/>方法关闭它，并导航回父选项卡，为监听事件提供数据。</li><li id="f1b3" class="mf mg in kb b kc mr kg ms kx mt ky mu kz mv kw nn mn mo mp bi translated"><a class="ae mq" href="https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage" rel="noopener ugc nofollow" target="_blank"><strong class="kb io">【window . opener . postmessage(data，parent _ URL)</strong></a><strong class="kb io">:</strong>该方法触发web-app上的‘message’事件并提供数据。</li><li id="c970" class="mf mg in kb b kc mr kg ms kx mt ky mu kz mv kw nn mn mo mp bi translated">API将在req.body中获取数据，因为我们已经将查询参数response_mode: form_post传递给了Apple。</li></ul><p id="e6e6" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">在事件中成功检索数据后，您可以根据请求应用下一个操作。</p><p id="8d9e" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">如果你觉得这个教程对于将苹果登录整合到Angular应用中很有用，请留下一些掌声来支持它。</p><p id="bb48" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated"><em class="ka">吃&gt;睡&gt;码&gt;重复</em></p><p id="ab54" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">谢谢大家！</p><p id="94f2" class="pw-post-body-paragraph jy jz in kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated"><em class="ka">更多内容请看</em><a class="ae mq" href="http://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><em class="ka">plain English . io</em></a></p></div></div>    
</body>
</html>