# 5 ä½¿ç”¨æ•ˆæœæ— é™å¾ªç¯æ¨¡å¼

> åŸæ–‡ï¼š<https://javascript.plainenglish.io/5-useeffect-infinite-loop-patterns-2dc9d45a253f?source=collection_archive---------0----------------------->

![](img/acd767c9a35c399550321175d9e6775d.png)

ä¸€èˆ¬æ¥è¯´ï¼Œæ— é™å¾ªç¯è¢«è®¤ä¸ºæ˜¯ä¸å¥½çš„åšæ³•ã€‚ä½†æ˜¯åœ¨[ä¸€äº›è¾¹ç¼˜æƒ…å†µä¸‹](https://stackoverflow.com/questions/224204/why-use-infinite-loops)ï¼Œä½ æ²¡æœ‰ä»»ä½•é€‰æ‹©ï¼Œåªèƒ½é€‰æ‹©ä¸€ä¸ªæ— é™å¾ªç¯ã€‚äº†è§£ React çš„æ— é™å¾ªç¯æ¨¡å¼å¾ˆæœ‰å¥½å¤„ã€‚

![](img/c034c68ae9aa1647137d9a067847f622.png)

å½“æ— é™å¾ªç¯ä¸åœåœ°è¿è¡Œæ—¶ï¼Œæœ€ç»ˆæµè§ˆå™¨ä¼šç»ˆæ­¢ä»£ç è¿è¡Œçš„æ ‡ç­¾ã€‚æ‰€ä»¥ä¸è¦åœ¨æ²¡æœ‰ä»»ä½•æ–­ç‚¹çš„æƒ…å†µä¸‹ä½¿ç”¨`Infinite Loop`ã€‚

# ä½¿ç”¨æ•ˆæœ

useEffect é’©å­å…è®¸æˆ‘ä»¬åœ¨ä¸€ä¸ªç»„ä»¶ä¸­æ‰§è¡Œå‰¯ä½œç”¨ã€‚å½“é’©å­è¢«å¼•å…¥ react 16 æ—¶ï¼Œ`useEffect`é’©å­æ¯”ä»»ä½•å…¶å®ƒé’©å­è·å¾—æ›´å¤§çš„ç‰µå¼•åŠ›ã€‚å› ä¸ºå®ƒæä¾›äº†`componentDidMount`ã€`componentDidUpdate`å’Œ`componentWillUnmount`ç”Ÿå‘½å‘¨æœŸæ–¹æ³•çš„ç»„åˆåŠŸèƒ½ã€‚

![](img/c45281f00a2adb58767bd3e6cb1e9398.png)

useEffect é’©å­è§¦å‘å›è°ƒå‡½æ•°ï¼Œä»…å½“ä¾èµ–å…³ç³»è¢«æ”¹å˜æ—¶ã€‚å¹¶ä¸”å®ƒä½¿ç”¨`shallow`æ¯”è¾ƒæ¥æ¯”è¾ƒé’©å­çš„å€¼ã€‚

ä½ å¯ä»¥æŠŠå®ƒå½“ä½œä¸€å—èƒ½é‡çŸ³ï¼Œè¿™æ˜¯ä¸€å—éå¸¸å¼ºå¤§çš„çŸ³å¤´ï¼Œå¦‚æœä½ å¤„ç†ä¸å½“ï¼Œå®ƒä¼šæ¯äº†ä½ ã€‚

![](img/50f7482bb5143364798fc16496451194.png)

## æ²¡æœ‰ä¾èµ–æ€§

æ²¡æœ‰ä¾èµ–å…³ç³»çš„ useEffect é€šå¸¸è¢«è®¤ä¸ºæ˜¯ä¸€ç§ä¸å¥½çš„åšæ³•ï¼Œæ‰€ä»¥è¦å°½é‡é¿å…ã€‚

è€ƒè™‘ä¸‹é¢çš„ä»£ç ï¼Œå®ƒå°†æ°¸è¿œè°ƒç”¨ APIã€‚

## å‘ç”Ÿä»€ä¹ˆäº‹äº†ï¼Ÿ

å¦‚æœ useEffect ä»…åœ¨ä¾èµ–å…³ç³»æ”¹å˜æ—¶è§¦å‘å›è°ƒï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬åœ¨è¿™é‡Œä»¥æ— é™å¾ªç¯ç»“æŸã€‚

ä½ éœ€è¦è€ƒè™‘ React çš„å¦ä¸€ä¸ªé‡è¦çš„**å’’è¯­ï¼Œé‚£å°±æ˜¯â€œå½“çŠ¶æ€æˆ–é“å…·æ”¹å˜æ—¶ï¼Œç»„ä»¶å°†é‡æ–°æ¸²æŸ“â€ã€‚**

åœ¨è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨`setData`è®¾ç½®çŠ¶æ€å€¼ï¼Œå¦‚æœç½‘ç»œè°ƒç”¨æˆåŠŸï¼Œå®ƒå°†è§¦å‘ç»„ä»¶é‡æ–°å‘ˆç°ã€‚ç”±äº useEffect æ²¡æœ‰å¯æ¯”è¾ƒçš„å€¼ï¼Œæ‰€ä»¥å®ƒå°†è°ƒç”¨å›è°ƒã€‚

å¹¶ä¸” Fetch å°†å†æ¬¡è§¦å‘`setData`å’Œ`setData`å°†è§¦å‘ç»„ä»¶é‡æ–°æ¸²æŸ“ç­‰ç­‰ã€‚

![](img/b2fb9dd331c4dba10e7740304300ec10.png)

## å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜ï¼Ÿ

æˆ‘ä»¬éœ€è¦å°†ä¾èµ–é¡¹æŒ‡å®šä¸ºç©ºæ•°ç»„ã€‚

æ ¹æ®å®˜æ–¹æ–‡ä»¶ï¼Œ[çœç•¥ä¾èµ–å…³ç³»](https://reactjs.org/docs/hooks-faq.html#is-it-safe-to-omit-functions-from-the-list-of-dependencies)æ˜¯**ä¸å®‰å…¨çš„**

# ä½œä¸ºä¾èµ–é¡¹è¿è¡Œ

useEffect ä½¿ç”¨æµ…å±‚å¯¹è±¡æ¯”è¾ƒæ¥ç¡®å®šæ•°æ®æ˜¯å¦è¢«æ›´æ”¹ã€‚ç”±äºå¥‡æ€ªçš„ JavaScript æ¡ä»¶ç³»ç»ŸğŸ˜ˆã€‚

è®©æˆ‘ä»¬è€ƒè™‘ä¸‹é¢çš„ä»£ç 

å‡½æ•°`getData`ä½œä¸ºä¾èµ–é¡¹ä¼ é€’ã€‚

å½“ä½ è¿è¡Œè¿™æ®µä»£ç æ—¶ï¼Œå®ƒä¼šæŠ›å‡º`Maximum update depth exceeded`ï¼Œè¿™æ„å‘³ç€è¿™æ®µä»£ç æœ‰ä¸€ä¸ªæ— é™å¾ªç¯ã€‚

![](img/c0f408a54460027e6619acee5725c396.png)

## å‘ç”Ÿä»€ä¹ˆäº‹äº†ï¼Ÿ

å› ä¸º useEffect ä½¿ç”¨æµ…å±‚æ¯”è¾ƒæ¥æ¯”è¾ƒå€¼ã€‚å‡½æ•°çš„æµ…å±‚æ¯”è¾ƒå°†æ€»æ˜¯ç»™å‡ºå‡å€¼ã€‚

## æ€ä¹ˆä¿®ï¼Ÿ

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨å¦ä¸€ä¸ªåä¸º`useCallback`çš„æ— é™çŸ³ã€‚

![](img/d3591cdd6232a77e941d60f931a3be6b.png)

`useCallback`è¿”å›ä¸€ä¸ª[å†…å­˜åŒ–çš„](https://en.wikipedia.org/wiki/Memoization)ç‰ˆæœ¬çš„å›è°ƒï¼Œå®ƒåªåœ¨ä¾èµ–å…³ç³»æ”¹å˜æ—¶æ‰ä¼šæ”¹å˜ã€‚

# ä½œä¸ºä¾èµ–é¡¹çš„æ•°ç»„

æ­£å¦‚ä½ å¯èƒ½çŸ¥é“çš„ï¼Œä¸¤ä¸ªçš„æµ…å±‚æ¯”è¾ƒæ€»æ˜¯å‡çš„ï¼Œæ‰€ä»¥ä½œä¸ºæ•°ç»„ä¼ é€’ä¾èµ–å…³ç³»ä¹Ÿä¼šå¯¼è‡´`Infinite Loop`

è®©æˆ‘ä»¬è€ƒè™‘ä¸‹é¢çš„ä»£ç 

è¿™é‡Œï¼Œæ•°ç»„`dep`ä½œä¸º useEffect çš„ä¾èµ–é¡¹ä¼ é€’ã€‚

å½“æ‚¨è¿è¡Œæ­¤ä»£ç æ—¶ï¼Œæµè§ˆå™¨æ§åˆ¶å°å°†å¼•å‘æ­¤é”™è¯¯ã€‚

## å‘ç”Ÿä»€ä¹ˆäº‹äº†ï¼Ÿ

ä¸¤ä¸ªæ•°ç»„çš„æµ…æ¯”è¾ƒæ€»æ˜¯å‡çš„ï¼Œæ‰€ä»¥`useEffect`æ€»ä¼šè§¦å‘å›è°ƒã€‚

![](img/700bd78d3234917da185072060fb5ab3.png)

## æ€ä¹ˆä¿®ï¼Ÿ

å› ä¸º`useCallback`è¿”å›æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œæˆ‘ä»¬ä¸èƒ½ä½¿ç”¨å®ƒã€‚

æ‰€ä»¥ï¼Œä½ çŒœæ€ä¹ˆç€ï¼Ÿ

æˆ‘ä»¬éœ€è¦ä½¿ç”¨å¦ä¸€ä¸ªåä¸º`useRef`çš„é’©å­

![](img/50163c6283f6ec4d0bee98c679bb7deb.png)

`useRef`è¿”å›ä¸€ä¸ªå¯å˜å¯¹è±¡ï¼Œå…¶ä¸­`.current`å…·æœ‰åˆå§‹å€¼ã€‚

# ä½œä¸ºä¾èµ–é¡¹çš„å¯¹è±¡

ä½ å¯èƒ½ä¼šçŒœæµ‹ä¸¤ä¸ªå¯¹è±¡çš„æµ…å±‚æ¯”è¾ƒæ€»æ˜¯å‡çš„ï¼Œæ‰€ä»¥`useEffect`å°†æ€»æ˜¯è§¦å‘å›è°ƒã€‚

è®©æˆ‘ä»¬è€ƒè™‘è¿™ä¸ªä»£ç 

`data`ä½œä¸º useEffect çš„ä¾èµ–é¡¹ä¼ é€’

å½“æ‚¨è¿è¡Œè¿™æ®µä»£ç æ—¶ï¼Œæ‚¨çš„æµè§ˆå™¨æ§åˆ¶å°å°†ä¼šæŠ›å‡ºä¸€ä¸ªæ— é™å¾ªç¯é”™è¯¯ã€‚

## è¿™é‡Œå‘ç”Ÿäº†ä»€ä¹ˆäº‹ï¼Ÿ

å¯¹è±¡çš„æµ…å±‚æ¯”è¾ƒæ€»æ˜¯ä¸ºå‡ï¼Œæ‰€ä»¥å®ƒå°†è§¦å‘ useEffect çš„å›è°ƒã€‚

![](img/19466240506232368ed31c4f62374e94.png)

## æ€ä¹ˆä¿®ï¼Ÿ

å¦‚æœæˆ‘ä»¬è®°ä½äº†ä¾èµ–å…³ç³»ï¼Œæˆ‘ä»¬å°±æ‰“ç ´äº†æ— é™å¾ªç¯ã€‚é‚£ä¹ˆ**æ€ä¹ˆåšå‘¢ï¼Ÿ**

æ˜¯çš„ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨å¦ä¸€ä¸ªåä¸º`useMemo`çš„æ— é™å®çŸ³

![](img/84bbed59b9f951f15545ad08fb34729e.png)

`useMemo`ä»…å½“ä¾èµ–å…³ç³»å‘ç”Ÿå˜åŒ–æ—¶ï¼Œæ‰ä¼šé‡æ–°è®¡ç®—è®°å¿†å€¼ã€‚

# é”™è¯¯çš„ä¾èµ–æ€§

é”™è¯¯çš„ä¾èµ–ä¸`React`æ— å…³ï¼Œç”šè‡³ä¸`javascript`æ— å…³ã€‚å½“ä½¿ç”¨äº†é”™è¯¯çš„ä¾èµ–é¡¹æ—¶ï¼Œæˆ‘ä»¬å¿…é¡»æ‰¿æ‹…è´£ä»»ã€‚

è®©æˆ‘ä»¬è€ƒè™‘ä¸€ä¸‹ä»£ç 

æˆ‘å¸Œæœ›æ²¡æœ‰å¿…è¦è§£é‡Šè¿™ä¸ªé—®é¢˜æ¨¡å¼åŠå…¶ä¿®å¤ã€‚å¦‚æœä½ æƒ³è¦è§£é‡Šå’Œä¿®æ­£ï¼Œè¯·åœ¨è¯„è®ºä¸­å‘Šè¯‰æˆ‘ã€‚

> **æ³¨æ„:**æœ‰å¾ˆå¤šæ–¹æ³•å¯ä»¥é¿å… React ç»„ä»¶å†…éƒ¨çš„æ— é™å¾ªç¯ï¼Œæˆ‘åªæåˆ°äº†å‡ ç§æ–¹æ³•ã€‚

æ€»æ˜¯ä½¿ç”¨[eslint-plugin-react-hooks](https://www.npmjs.com/package/eslint-plugin-react-hooks#installation)æˆ– create-react-appï¼Œå®ƒå°†å¸®åŠ©ä½ åœ¨è¿™äº›é—®é¢˜è¿›å…¥ç”Ÿäº§æœåŠ¡å™¨ä¹‹å‰å‘ç°å®ƒä»¬ã€‚

ä¸€å®¶å…¬å¸ç”±äºæ— é™å¾ªç¯ï¼Œä¸€å‘¨å†…æŸå¤±äº† 72kã€‚

[](https://blog.tomilkieway.com/72k-1/) [## æˆ‘ä»¬èŠ±äº† 72K ç¾å…ƒæµ‹è¯• Firebase + Cloud Runï¼Œå‡ ä¹ç ´äº§[ç¬¬ 1 éƒ¨åˆ†]

### è¿™æ˜¯ä¸€ä¸ªæ•…äº‹ï¼Œè®²è¿°äº†æˆ‘ä»¬åœ¨æ¨å‡ºç¬¬ä¸€æ¬¾äº§å“ä¹‹å‰æ˜¯å¦‚ä½•æ¥è¿‘å€’é—­çš„ï¼Œæˆ‘ä»¬æ˜¯å¦‚ä½•ç”Ÿå­˜ä¸‹æ¥çš„ï¼Œä»¥åŠâ€¦

blog.tomilkieway.com](https://blog.tomilkieway.com/72k-1/) 

æ‰€ä»¥è¦ä¸€ç›´ç‰¹åˆ«ç…§é¡¾æˆ‘ä»¬çš„åŠ›é‡çŸ³(`useEffect`)ã€‚

![](img/bbc3dbae1793d43c51fa458a64bffb02.png)

[https://www.nerdyviews.com/2019/06/infinity-gauntlet-keychain.html](https://www.nerdyviews.com/2019/06/infinity-gauntlet-keychain.html)

å¦å¤–ï¼Œè¯·çœ‹çœ‹æˆ‘æœ€è¿‘å†™çš„å…³äº React çš„æ–‡ç« ã€‚

1.  [è°ƒç”¨ API æ—¶ç”¨ Query ä»£æ›¿ Fetchã€‘](/usequery-instead-of-fetch-while-calling-an-api-ef12964457c5)
2.  [ä¸ºä»€ä¹ˆåœ¨è°ƒç”¨ API æ—¶åº”è¯¥ä½¿ç”¨ useSWR è€Œä¸æ˜¯ Use state](/why-you-should-use-useswr-instead-of-usestate-when-calling-apis-8b6de5dc18fc)
3.  [åœ¨ React åº”ç”¨ä¸­ä½¿ç”¨ Axios çš„è¯¦ç»†æŒ‡å—](/a-detailed-guide-to-using-axios-in-your-react-app-7396f79fb4c2)

*æ›´å¤šå†…å®¹è¯·çœ‹*[***plain English . io***](http://plainenglish.io/)