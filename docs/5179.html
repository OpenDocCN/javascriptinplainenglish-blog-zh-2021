<html>
<head>
<title>Angular: Handle HTTP Errors using Interceptors</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Angular:使用拦截器处理HTTP错误</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/angular-handle-http-errors-using-interceptors-5cc483103740?source=collection_archive---------0-----------------------#2021-10-21">https://javascript.plainenglish.io/angular-handle-http-errors-using-interceptors-5cc483103740?source=collection_archive---------0-----------------------#2021-10-21</a></blockquote><div><div class="fc ic id ie if ig"/><div class="ih ii ij ik il"><div class=""/><p id="3002" class="pw-post-body-paragraph jl jm io jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ih bi translated">发出HTTP请求时，Angular中的HTTP错误很常见。在不影响用户体验的情况下处理这些错误是一个很好的实践。在本文中，我们将讨论处理这种情况的三种方法。</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj kj"><img src="../Images/feac48b09e45e5e1e3338b11926188e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CHC9t8JuHIfJJFjDqinnig.jpeg"/></div></div></figure><p id="13ce" class="pw-post-body-paragraph jl jm io jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ih bi translated">首先，让我们了解一下拦截器</p><h1 id="8852" class="kv kw io bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated"><strong class="ak">拦截器是什么？</strong></h1><p id="0c64" class="pw-post-body-paragraph jl jm io jn b jo lt jq jr js lu ju jv jw lv jy jz ka lw kc kd ke lx kg kh ki ih bi translated">拦截器是我们可以实现的一种独特的角度服务。拦截器允许我们使用HttpClient拦截传入或传出的HTTP请求。通过拦截HTTP请求，我们可以修改或更改请求的值。</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div class="gi gj ly"><img src="../Images/d203b9e5f2703d2a94c03595fd91fd53.png" data-original-src="https://miro.medium.com/v2/resize:fit:1002/format:webp/1*VMjczYmzNYInU6ZJBDfWaQ.png"/></div></figure><h1 id="1dc3" class="kv kw io bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated"><strong class="ak">什么是错误拦截器？</strong></h1><p id="6f85" class="pw-post-body-paragraph jl jm io jn b jo lt jq jr js lu ju jv jw lv jy jz ka lw kc kd ke lx kg kh ki ih bi translated">错误拦截器是一种特殊类型的拦截器，用于处理发出HTTP请求时出现的错误。当请求由于任何原因失败时，错误可能来自客户端(浏览器)，也可能来自服务器端。</p><p id="9a14" class="pw-post-body-paragraph jl jm io jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ih bi translated">让我们看看实际中的错误拦截器。</p><h1 id="5125" class="kv kw io bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated"><strong class="ak">项目设置。</strong></h1><p id="9650" class="pw-post-body-paragraph jl jm io jn b jo lt jq jr js lu ju jv jw lv jy jz ka lw kc kd ke lx kg kh ki ih bi translated">首先，让我们使用<em class="lz">ng new&lt;project-name&gt;</em>命令创建一个新项目(我将该项目命名为<em class="lz"> http-interceptor </em>)。</p><p id="d8c1" class="pw-post-body-paragraph jl jm io jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ih bi translated">成功创建项目后，让我们创建所需的组件和服务。运行以下命令:</p><ol class=""><li id="29d7" class="ma mb io jn b jo jp js jt jw mc ka md ke me ki mf mg mh mi bi translated"><strong class="jn ip"><em class="lz">ng g c components/demo-component</em></strong>(创建一个名为demo的新组件)</li><li id="aeb7" class="ma mb io jn b jo mj js mk jw ml ka mm ke mn ki mf mg mh mi bi translated"><strong class="jn ip"> <em class="lz"> ng g s服务/api </em> </strong> <em class="lz"> </em>(创建一个api服务)</li><li id="ea6a" class="ma mb io jn b jo mj js mk jw ml ka mm ke mn ki mf mg mh mi bi translated"><strong class="jn ip"> <em class="lz"> ng g拦截器/错误捕捉拦截器</em> </strong> <em class="lz"> </em>(创建一个错误捕捉拦截器)</li></ol><p id="34c1" class="pw-post-body-paragraph jl jm io jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ih bi translated">运行以上命令后，您应该会得到这样的项目结构。</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div class="gi gj mo"><img src="../Images/6cd107ad6321a0d261eac52ea2d793f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:666/format:webp/1*nAPKt7XOMMa_bwWTjH9T7Q.png"/></div></figure><p id="bfe8" class="pw-post-body-paragraph jl jm io jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ih bi translated">清理<em class="lz"> app.component.hrml </em>并添加<strong class="jn ip"><em class="lz">&lt;app-demo-component&gt;&lt;/app-demo-component&gt;</em></strong><em class="lz"/>标签。</p><p id="6ec8" class="pw-post-body-paragraph jl jm io jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ih bi translated">在<em class="lz">demo-component.component.html</em>中添加这段代码。</p><pre class="kk kl km kn gu mp mq mr ms aw mt bi"><span id="3457" class="mu kw io mq b gz mv mw l mx my">&lt;button (click)="getData()"&gt;Get Data&lt;/button&gt;<br/><br/>&lt;div <em class="lz">*ngIf</em>="data"&gt;{{data}}&lt;/div&gt;</span></pre><p id="821c" class="pw-post-body-paragraph jl jm io jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ih bi translated">够简单吧！这里没什么特别的事情发生。在开始有趣的部分之前，让我们创建一个发送HTTP请求的函数。</p><pre class="kk kl km kn gu mp mq mr ms aw mt bi"><span id="5140" class="mu kw io mq b gz mv mw l mx my">// demo-component.component.ts</span><span id="e817" class="mu kw io mq b gz mz mw l mx my">import {<strong class="mq ip"><em class="lz">Component</em></strong>, OnInit} from '@angular/core';<br/>import {ApiService} from "../../services/api.service";<br/><br/>@Component({<br/>    selector: 'app-demo-component',<br/>    templateUrl: './demo-component.component.html',<br/>    styleUrls: ['./demo-component.component.scss']<br/>})<br/>export class DemoComponentComponent implements OnInit {<br/><br/>    data = ""<br/><br/>    constructor(private apiService: ApiService) {<br/>    }<br/><br/>    ngOnInit(): void {<br/>    }<br/><br/>    getData() {<br/>        this.apiService.getData().subscribe(res =&gt; {<br/>            this.data = <strong class="mq ip"><em class="lz">JSON</em></strong>.stringify(res)<br/>        })<br/>    }<br/>}</span><span id="2493" class="mu kw io mq b gz mz mw l mx my">// api.service.ts</span><span id="5525" class="mu kw io mq b gz mz mw l mx my">import {<strong class="mq ip"><em class="lz">Injectable</em></strong>} from '@angular/core';<br/>import {HttpClient} from "@angular/common/http";<br/>import {Observable} from "rxjs";<br/><br/>@Injectable({<br/>    providedIn: 'root'<br/>})<br/>export class ApiService {<br/>    url = 'https://jsonplaceholder.typicode.com/todos/10';<br/><br/><br/>    constructor(private http: HttpClient) {<br/>    }<br/><br/>    getData(): Observable&lt;any&gt; {<br/>        return this.http.get(this.url);<br/>    }<br/>}</span></pre><p id="588a" class="pw-post-body-paragraph jl jm io jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ih bi translated">此时，这是一个典型的HTTP请求。现在，让我们从有趣的部分开始。</p><h1 id="d3b0" class="kv kw io bd kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls bi translated"><strong class="ak">使用HTTP拦截器</strong></h1><p id="3d6b" class="pw-post-body-paragraph jl jm io jn b jo lt jq jr js lu ju jv jw lv jy jz ka lw kc kd ke lx kg kh ki ih bi translated">现在，让我们深入有趣的部分。首先，我们来看看<em class="lz">error-catching . interceptor . ts</em>文件，</p><pre class="kk kl km kn gu mp mq mr ms aw mt bi"><span id="415b" class="mu kw io mq b gz mv mw l mx my">import {<strong class="mq ip"><em class="lz">Injectable</em></strong>} from '@angular/core';<br/>import {HttpEvent, HttpHandler, HttpInterceptor, HttpRequest} from '@angular/common/http';<br/>import {Observable} from 'rxjs';<br/><br/>@Injectable()<br/>export class ErrorCatchingInterceptor implements HttpInterceptor {<br/><br/>    constructor() {<br/>    }<br/><br/>    intercept(request: HttpRequest&lt;unknown&gt;, next: HttpHandler): Observable&lt;HttpEvent&lt;unknown&gt;&gt; {<br/>        return next.handle(request);<br/>    }<br/>}</span></pre><p id="4a68" class="pw-post-body-paragraph jl jm io jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ih bi translated">注意，它实现了<em class="lz"> HttpInterceptor </em>接口，这迫使我们实现<em class="lz"> intercept </em>函数，该函数识别并处理给定的HTTP请求。</p><p id="6969" class="pw-post-body-paragraph jl jm io jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ih bi translated">截距函数参数呢？</p><ul class=""><li id="aaf5" class="ma mb io jn b jo jp js jt jw mc ka md ke me ki na mg mh mi bi translated"><em class="lz"> req </em> —要处理的传出请求对象。</li><li id="711b" class="ma mb io jn b jo mj js mk jw ml ka mm ke mn ki na mg mh mi bi translated"><em class="lz">下一个</em> —链中的下一个拦截器，如果链中没有拦截器，则为后端。</li><li id="a567" class="ma mb io jn b jo mj js mk jw ml ka mm ke mn ki na mg mh mi bi translated">返回:事件流的可观察值。</li></ul><p id="9f0a" class="pw-post-body-paragraph jl jm io jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ih bi translated">现在让我们添加我们的触摸。</p><p id="9e90" class="pw-post-body-paragraph jl jm io jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ih bi translated">看看下一段代码。</p><pre class="kk kl km kn gu mp mq mr ms aw mt bi"><span id="6f62" class="mu kw io mq b gz mv mw l mx my">import {<strong class="mq ip"><em class="lz">Injectable</em></strong>} from '@angular/core';<br/>import {HttpErrorResponse, HttpEvent, HttpHandler, HttpInterceptor, HttpRequest} from '@angular/common/http';<br/>import {Observable, throwError} from 'rxjs';<br/>import {catchError} from "rxjs/operators";<br/><br/>@Injectable()<br/>export class ErrorCatchingInterceptor implements HttpInterceptor {<br/><br/>    constructor() {<br/>    }<br/><br/>    intercept(request: HttpRequest&lt;unknown&gt;, next: HttpHandler): Observable&lt;HttpEvent&lt;unknown&gt;&gt; {<br/>        return next.handle(request)<br/>            .pipe(<br/>                catchError((error: HttpErrorResponse) =&gt; {<br/>                    let errorMsg = '';<br/>                    if (error.error instanceof <strong class="mq ip"><em class="lz">ErrorEvent</em></strong>) {<br/>                        <strong class="mq ip"><em class="lz">console</em></strong>.log('This is client side error');<br/>                        errorMsg = `Error: ${error.error.message}`;<br/>                    } else {<br/>                        <strong class="mq ip"><em class="lz">console</em></strong>.log('This is server side error');<br/>                        errorMsg = `Error Code: ${error.status},  Message: ${error.message}`;<br/>                    }<br/>                    <strong class="mq ip"><em class="lz">console</em></strong>.log(errorMsg);<br/>                    return throwError(errorMsg);<br/>                })<br/>            )<br/>    }<br/>}</span></pre><p id="4a25" class="pw-post-body-paragraph jl jm io jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ih bi translated">这里发生了什么事？我会解释的。</p><p id="950c" class="pw-post-body-paragraph jl jm io jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ih bi translated">在rxjs的<em class="lz"> pipe() </em>操作符中，我们捕捉任何错误并检查其来源(无论是来自客户端还是服务器端)。然后我们通过rxjs的<em class="lz"> throwError() </em>操作符返回错误。</p><p id="2a14" class="pw-post-body-paragraph jl jm io jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ih bi translated">现在，让我们在项目中使用拦截器文件。我们将把它添加到<em class="lz"> app.module.ts. </em>中的<em class="lz">提供者</em>数组中</p><pre class="kk kl km kn gu mp mq mr ms aw mt bi"><span id="bf7d" class="mu kw io mq b gz mv mw l mx my">@NgModule({<br/>    ...<br/>    providers: [<br/>        {<br/>            provide: <strong class="mq ip"><em class="lz">HTTP_INTERCEPTORS</em></strong>,<br/>            useClass: ErrorCatchingInterceptor,<br/>            multi: true<br/>        }<br/>    ],<br/>    ...<br/>})<br/>export class AppModule {<br/>}</span></pre><p id="21a8" class="pw-post-body-paragraph jl jm io jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ih bi translated">让我们确保一切都按预期运行。</p><p id="b833" class="pw-post-body-paragraph jl jm io jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ih bi translated">预期的行为是什么？预期的行为是每个请求/响应都应该通过拦截器。</p><p id="b525" class="pw-post-body-paragraph jl jm io jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ih bi translated">为了演示起见，我们将修改<em class="lz">error-catching . interceptor . ts</em>文件，并添加两个<em class="lz"> console.log()。</em></p><pre class="kk kl km kn gu mp mq mr ms aw mt bi"><span id="aeb9" class="mu kw io mq b gz mv mw l mx my">import {<strong class="mq ip"><em class="lz">Injectable</em></strong>} from '@angular/core';<br/>import {HttpErrorResponse, HttpEvent, HttpHandler, HttpInterceptor, HttpRequest} from '@angular/common/http';<br/>import {Observable, throwError} from 'rxjs';<br/>import {catchError, map} from "rxjs/operators";<br/><br/>@Injectable()<br/>export class ErrorCatchingInterceptor implements HttpInterceptor {<br/><br/>    constructor() {<br/>    }<br/><br/>    intercept(request: HttpRequest&lt;unknown&gt;, next: HttpHandler): Observable&lt;HttpEvent&lt;unknown&gt;&gt; {<br/>        <strong class="mq ip"><em class="lz">console</em></strong>.log("Passed through the interceptor in request");<br/><br/>        return next.handle(request)<br/>            .pipe(<br/>                map(res =&gt; {<br/>                    <strong class="mq ip"><em class="lz">console</em></strong>.log("Passed through the interceptor in response");<br/>                    return res<br/>                }),<br/>                catchError((error: HttpErrorResponse) =&gt; {<br/>                    let errorMsg = '';<br/>                    if (error.error instanceof <strong class="mq ip"><em class="lz">ErrorEvent</em></strong>) {<br/>                        <strong class="mq ip"><em class="lz">console</em></strong>.log('This is client side error');<br/>                        errorMsg = `Error: ${error.error.message}`;<br/>                    } else {<br/>                        <strong class="mq ip"><em class="lz">console</em></strong>.log('This is server side error');<br/>                        errorMsg = `Error Code: ${error.status},  Message: ${error.message}`;<br/>                    }<br/>                    <strong class="mq ip"><em class="lz">console</em></strong>.log(errorMsg);<br/>                    return throwError(errorMsg);<br/>                })<br/>            )<br/>    }<br/>}</span></pre><p id="979f" class="pw-post-body-paragraph jl jm io jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ih bi translated">您应该会看到以下输出。</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div class="gi gj nb"><img src="../Images/7765d8c8e0eb28d917b6bb00097434f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1132/format:webp/1*gq4-jix6BR1u7YZXWTCyRA.png"/></div></figure><p id="4ede" class="pw-post-body-paragraph jl jm io jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ih bi translated">现在，让我们中断URL以使请求失败。</p><pre class="kk kl km kn gu mp mq mr ms aw mt bi"><span id="1270" class="mu kw io mq b gz mv mw l mx my">url = 'https://jsonplaceholder.typicode.com/tod';</span></pre><p id="82c2" class="pw-post-body-paragraph jl jm io jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ih bi translated">现在，在使用一个断开的URL运行代码后，您应该会看到下面的输出。</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div class="gi gj nc"><img src="../Images/2007539621112ac928e1116d754424d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1150/format:webp/1*kKCPEjxONgX2ec0kSj6ypQ.png"/></div></figure></div><div class="ab cl nd ne hs nf" role="separator"><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni"/></div><div class="ih ii ij ik il"><blockquote class="nk nl nm"><p id="0aa7" class="jl jm lz jn b jo jp jq jr js jt ju jv nn jx jy jz no kb kc kd np kf kg kh ki ih bi translated">亲爱的读者:</p><p id="bfeb" class="jl jm lz jn b jo jp jq jr js jt ju jv nn jx jy jz no kb kc kd np kf kg kh ki ih bi translated">谢谢你的时间。如果你分享你的想法，我会很高兴。</p></blockquote><blockquote class="nq"><p id="f62f" class="nr ns io bd nt nu nv nw nx ny nz ki dk translated">编码快乐！❤</p></blockquote><h2 id="da29" class="mu kw io bd kx oa ob dn lb oc od dp lf jw oe of lj ka og oh ln ke oi oj lr ok bi translated">进一步阅读</h2><div class="ol om gq gs on oo"><a rel="noopener  ugc nofollow" target="_blank" href="/code-documentation-is-broken-but-i-think-swimm-may-have-fixed-it-daaa7547d834"><div class="op ab fp"><div class="oq ab or cl cj os"><h2 class="bd ip gz z fq ot fs ft ou fv fx in bi translated">代码文档被破坏了——但是我认为Swimm可能已经修复了它</h2><div class="ov l"><h3 class="bd b gz z fq ot fs ft ou fv fx dk translated">传统的文档管理系统让软件开发人员失望了，是时候来点新的了。游泳吗…</h3></div><div class="ow l"><p class="bd b dl z fq ot fs ft ou fv fx dk translated">javascript.plainenglish.io</p></div></div><div class="ox l"><div class="oy l oz pa pb ox pc kt oo"/></div></div></a></div><div class="ol om gq gs on oo"><a href="https://plainenglish.io/blog/create-an-employee-satisfaction-survey-using-angular-and-store-results-in-a-mongodb-collection" rel="noopener  ugc nofollow" target="_blank"><div class="op ab fp"><div class="oq ab or cl cj os"><h2 class="bd ip gz z fq ot fs ft ou fv fx in bi translated">使用Angular创建员工满意度调查，并将结果存储在MongoDB集合中</h2><div class="ov l"><h3 class="bd b gz z fq ot fs ft ou fv fx dk translated">一步一步的教程来建立一个员工满意度调查使用Angular和SurveyJS，一个免费的，开源的…</h3></div><div class="ow l"><p class="bd b dl z fq ot fs ft ou fv fx dk translated">简明英语. io</p></div></div><div class="ox l"><div class="pd l oz pa pb ox pc kt oo"/></div></div></a></div><p id="fb01" class="pw-post-body-paragraph jl jm io jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ih bi translated"><em class="lz">更多内容看</em> <a class="ae pe" href="https://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="jn ip"> <em class="lz">说白了。报名参加我们的</em> <a class="ae pe" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="jn ip"> <em class="lz">免费周报</em> </strong> </a> <em class="lz">。关注我们关于</em><a class="ae pe" href="https://twitter.com/inPlainEngHQ" rel="noopener ugc nofollow" target="_blank"><strong class="jn ip"><em class="lz">Twitter</em></strong></a>，<a class="ae pe" href="https://www.linkedin.com/company/inplainenglish/" rel="noopener ugc nofollow" target="_blank"><strong class="jn ip"><em class="lz">LinkedIn</em></strong></a><em class="lz">，</em><a class="ae pe" href="https://www.youtube.com/channel/UCtipWUghju290NWcn8jhyAw" rel="noopener ugc nofollow" target="_blank"><strong class="jn ip"><em class="lz">YouTube</em></strong></a><em class="lz">，以及</em> <a class="ae pe" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"> <strong class="jn ip"> <em class="lz">不和</em> </strong> </a> <strong class="jn ip"> <em class="lz">。</em> </strong></strong></a></p><p id="5399" class="pw-post-body-paragraph jl jm io jn b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki ih bi translated"><strong class="jn ip"> <em class="lz">有兴趣规模化你的软件创业</em> </strong> <em class="lz">？检查</em> <a class="ae pe" href="https://circuit.ooo/?utm=publication-post-cta" rel="noopener ugc nofollow" target="_blank"> <strong class="jn ip"> <em class="lz">电路</em> </strong> </a> <em class="lz">。</em></p></div></div>    
</body>
</html>