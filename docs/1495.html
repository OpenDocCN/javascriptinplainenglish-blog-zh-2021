<html>
<head>
<title>Gatsby TypeScript Docker Env Vars Alternative</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Gatsby类型脚本Docker环境变量替代</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/gatsby-typescript-docker-env-vars-alternative-fc7e322bc9e?source=collection_archive---------10-----------------------#2021-03-30">https://javascript.plainenglish.io/gatsby-typescript-docker-env-vars-alternative-fc7e322bc9e?source=collection_archive---------10-----------------------#2021-03-30</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="5c28" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">让TypeScript Gatsby在Docker运行时使用环境变量</h2></div><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi kc"><img src="../Images/3ddc12912c5c29e21b2d2b45647a5818.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*r8O7GCljXfxiycleQ5CdUA.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Getting TypeScript GatsbyJS To Work With Environment Variables At Docker Run Time</figcaption></figure><h1 id="3b80" class="ks kt in bd ku kv kw kx ky kz la lb lc jt ld ju le jw lf jx lg jz lh ka li lj bi translated">这是什么？</h1><p id="8100" class="pw-post-body-paragraph lk ll in lm b ln lo jo lp lq lr jr ls lt lu lv lw lx ly lz ma mb mc md me mf ig bi translated">如果你还没有看过正规的GatsbyJS版本的问题和解决方案，我推荐你去看看原文。</p><div class="mg mh gp gr mi mj"><a href="https://codingwithmanny.medium.com/gatsby-docker-env-vars-alternative-e81802281999" rel="noopener follow" target="_blank"><div class="mk ab fo"><div class="ml ab mm cl cj mn"><h2 class="bd io gy z fp mo fr fs mp fu fw im bi translated">Gatsby Docker环境变量替代</h2><div class="mq l"><h3 class="bd b gy z fp mo fr fs mp fu fw dk translated">让GatsbyJS在Docker运行时使用环境变量</h3></div><div class="mr l"><p class="bd b dl z fp mo fr fs mp fu fw dk translated">codingwithmanny.medium.com</p></div></div><div class="ms l"><div class="mt l mu mv mw ms mx km mj"/></div></div></a></div><p id="50ef" class="pw-post-body-paragraph lk ll in lm b ln my jo lp lq mz jr ls lt na lv lw lx nb lz ma mb nc md me mf ig bi translated">本文将特别关注设置相同的环境，但是具有<strong class="lm io"> TypeScript </strong>支持。</p></div><div class="ab cl nd ne hr nf" role="separator"><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni"/></div><div class="ig ih ii ij ik"><h1 id="44e7" class="ks kt in bd ku kv nk kx ky kz nl lb lc jt nm ju le jw nn jx lg jz no ka li lj bi translated">设置我们的TypeScript项目</h1><p id="022e" class="pw-post-body-paragraph lk ll in lm b ln lo jo lp lq lr jr ls lt lu lv lw lx ly lz ma mb mc md me mf ig bi translated">使用Gatsby CLI，我们将创建一个新项目。</p><pre class="kd ke kf kg gt np nq nr ns aw nt bi"><span id="1b38" class="nu kt in nq b gy nv nw l nx ny">gatsby new gatsby-ts-env-vars;<br/>cd gatsby-ts-env-vars;<br/>yarn develop;</span></pre><p id="2fb5" class="pw-post-body-paragraph lk ll in lm b ln my jo lp lq mz jr ls lt na lv lw lx nb lz ma mb nc md me mf ig bi translated">一旦我们的项目设置好了，让我们添加必要的依赖项。</p><pre class="kd ke kf kg gt np nq nr ns aw nt bi"><span id="ce6b" class="nu kt in nq b gy nv nw l nx ny">yarn add typescript gatsby-plugin-typescript;<br/>yarn add -D <a class="ae nz" href="http://twitter.com/types/react-helmet" rel="noopener ugc nofollow" target="_blank">@types/react-helmet</a>;</span></pre><p id="15f5" class="pw-post-body-paragraph lk ll in lm b ln my jo lp lq mz jr ls lt na lv lw lx nb lz ma mb nc md me mf ig bi translated">现在我们将配置Gatsby来支持TypeScript。</p><p id="0393" class="pw-post-body-paragraph lk ll in lm b ln my jo lp lq mz jr ls lt na lv lw lx nb lz ma mb nc md me mf ig bi translated"><strong class="lm io">文件:</strong>T0】</p><pre class="kd ke kf kg gt np nq nr ns aw nt bi"><span id="5f91" class="nu kt in nq b gy nv nw l nx ny">module.exports = {<br/>  siteMetadata: {<br/>    title: `Gatsby Default Starter`,<br/>    description: `Kick off your next, great Gatsby project with this default starter. This barebones starter ships with the main Gatsby configuration files you might need.`,<br/>    author: `<a class="ae nz" href="http://twitter.com/gatsbyjs" rel="noopener ugc nofollow" target="_blank">@gatsbyjs</a>`,<br/>  },<br/>  plugins: [<br/><strong class="nq io">    `gatsby-plugin-typescript`,<br/></strong>// ... rest of code</span></pre><p id="9889" class="pw-post-body-paragraph lk ll in lm b ln my jo lp lq mz jr ls lt na lv lw lx nb lz ma mb nc md me mf ig bi translated">现在我们已经安装了TypeScript，让我们运行一个初始init来生成<code class="fe oa ob oc nq b">tsconfig.json</code>文件。</p><pre class="kd ke kf kg gt np nq nr ns aw nt bi"><span id="945f" class="nu kt in nq b gy nv nw l nx ny">./node_modules/.bin/tsc --init</span></pre><p id="c6c5" class="pw-post-body-paragraph lk ll in lm b ln my jo lp lq mz jr ls lt na lv lw lx nb lz ma mb nc md me mf ig bi translated">我们需要对<code class="fe oa ob oc nq b">tsconfig.json</code>文件做一个调整。</p><pre class="kd ke kf kg gt np nq nr ns aw nt bi"><span id="3683" class="nu kt in nq b gy nv nw l nx ny">// "checkJs": true,<br/><strong class="nq io">"jsx": "preserve",</strong><br/>// "declaration": true,</span></pre><p id="9ee1" class="pw-post-body-paragraph lk ll in lm b ln my jo lp lq mz jr ls lt na lv lw lx nb lz ma mb nc md me mf ig bi translated">接下来，我们将所有文件更改为<code class="fe oa ob oc nq b">tsx</code>文件。</p><pre class="kd ke kf kg gt np nq nr ns aw nt bi"><span id="3963" class="nu kt in nq b gy nv nw l nx ny">/src/components/header.tsx<br/>/src/components/layout.tsx<br/>/src/components/seo.tsx<br/>/src/pages/404.tsx<br/>/src/pages/index.tsx<br/>/src/pages/page-2.tsx</span></pre><p id="1ec5" class="pw-post-body-paragraph lk ll in lm b ln my jo lp lq mz jr ls lt na lv lw lx nb lz ma mb nc md me mf ig bi translated">以及我们需要添加和调整的所有类型。</p><p id="a852" class="pw-post-body-paragraph lk ll in lm b ln my jo lp lq mz jr ls lt na lv lw lx nb lz ma mb nc md me mf ig bi translated"><strong class="lm io">文件:</strong> <code class="fe oa ob oc nq b">src/components/header.tsx</code></p><pre class="kd ke kf kg gt np nq nr ns aw nt bi"><span id="fd06" class="nu kt in nq b gy nv nw l nx ny">import * as React from "react"<br/>import PropTypes from "prop-types"<br/>import { Link } from "gatsby"</span><span id="e43d" class="nu kt in nq b gy od nw l nx ny">const Header = ({ siteTitle }<strong class="nq io">: { siteTitle: string }) =&gt; (</strong></span></pre><p id="d8c5" class="pw-post-body-paragraph lk ll in lm b ln my jo lp lq mz jr ls lt na lv lw lx nb lz ma mb nc md me mf ig bi translated"><strong class="lm io">文件:</strong>T5】</p><pre class="kd ke kf kg gt np nq nr ns aw nt bi"><span id="1ff8" class="nu kt in nq b gy nv nw l nx ny">/**<br/> * Layout component that queries for data<br/> * with Gatsby's useStaticQuery component<br/> *<br/> * See: <a class="ae nz" href="https://www.gatsbyjs.com/docs/use-static-query/" rel="noopener ugc nofollow" target="_blank">https://www.gatsbyjs.com/docs/use-static-query/</a><br/> */</span><span id="9490" class="nu kt in nq b gy od nw l nx ny">import * as React from "react"<br/>import PropTypes from "prop-types"<br/>import { useStaticQuery, graphql } from "gatsby"</span><span id="7535" class="nu kt in nq b gy od nw l nx ny">import Header from "./header"<br/>import "./layout.css"</span><span id="f77f" class="nu kt in nq b gy od nw l nx ny">const Layout = ({ children }<strong class="nq io">: { children?: React.ReactNode}</strong>) =&gt; {</span></pre><p id="991f" class="pw-post-body-paragraph lk ll in lm b ln my jo lp lq mz jr ls lt na lv lw lx nb lz ma mb nc md me mf ig bi translated"><strong class="lm io">文件:</strong>文件:<code class="fe oa ob oc nq b">src/components/seo.tsx</code></p><pre class="kd ke kf kg gt np nq nr ns aw nt bi"><span id="5c45" class="nu kt in nq b gy nv nw l nx ny">import * as React from "react"<br/>import PropTypes from "prop-types"<br/>import { Helmet } from "react-helmet"<br/>import { useStaticQuery, graphql } from "gatsby"</span><span id="3d99" class="nu kt in nq b gy od nw l nx ny"><strong class="nq io">interface SEOTypes {<br/>  description?: string;<br/>  lang?: string;<br/>  meta?: [{<br/>    name: string; <br/>    content: any; <br/>    property?: undefined;<br/>  }],<br/>  title?: string;<br/>}</strong></span><span id="5982" class="nu kt in nq b gy od nw l nx ny">function SEO({ description, lang, meta, title }<strong class="nq io">: SEOTypes</strong>) {<br/> <br/>// ...</span><span id="a6dd" class="nu kt in nq b gy od nw l nx ny">return (<br/>    &lt;Helmet<br/>      htmlAttributes={{<br/>        lang,<br/>      }}<br/>      title={title}<br/><strong class="nq io">      titleTemplate={defaultTitle ? `%s | ${defaultTitle}` : ''}</strong><br/>      meta={[<br/>        {<br/>          name: `description`,<br/>          content: metaDescription,<br/>        },<br/>        {<br/>          property: `og:title`,<br/>          content: title,<br/>        },<br/>        {<br/>          property: `og:description`,<br/>          content: metaDescription,<br/>        },<br/>        {<br/>          property: `og:type`,<br/>          content: `website`,<br/>        },<br/>        {<br/>          name: `twitter:card`,<br/>          content: `summary`,<br/>        },<br/>        {<br/>          name: `twitter:creator`,<br/>          content: site.siteMetadata?.author || ``,<br/>        },<br/>        {<br/>          name: `twitter:title`,<br/>          content: title,<br/>        },<br/>        {<br/>          name: `twitter:description`,<br/>          content: metaDescription,<br/>        },<br/>      ].concat(<strong class="nq io">meta || []</strong>)}</span></pre><p id="1414" class="pw-post-body-paragraph lk ll in lm b ln my jo lp lq mz jr ls lt na lv lw lx nb lz ma mb nc md me mf ig bi translated"><strong class="lm io">文件:</strong>T7】</p><pre class="kd ke kf kg gt np nq nr ns aw nt bi"><span id="ed13" class="nu kt in nq b gy nv nw l nx ny">// Lowercase<br/><strong class="nq io">      formats={["auto", "webp", "avif"]}</strong></span></pre><p id="5676" class="pw-post-body-paragraph lk ll in lm b ln my jo lp lq mz jr ls lt na lv lw lx nb lz ma mb nc md me mf ig bi translated">如果一切正常，我们应该能够执行<code class="fe oa ob oc nq b">yarn develop</code>并看到以下内容:</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi oe"><img src="../Images/a66b2a7011292f2befac1a04af2bc399.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JDHXhdzrEk7vpG_fdYs1tQ.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Our local development environment working with TypeScript</figcaption></figure></div><div class="ab cl nd ne hr nf" role="separator"><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni"/></div><div class="ig ih ii ij ik"><h1 id="1e35" class="ks kt in bd ku kv nk kx ky kz nl lb lc jt nm ju le jw nn jx lg jz no ka li lj bi translated">创建我们的基础项目</h1><p id="d2d8" class="pw-post-body-paragraph lk ll in lm b ln lo jo lp lq lr jr ls lt lu lv lw lx ly lz ma mb mc md me mf ig bi translated">现在我们已经有了TypeScript设置，让我们创建项目所需的基本文件，使事情类似于这个Gatsby环境变量文章的<a class="ae nz" href="https://codingwithmanny.medium.com/gatsby-docker-env-vars-alternative-e81802281999" rel="noopener">非类型脚本版本。</a></p><p id="3980" class="pw-post-body-paragraph lk ll in lm b ln my jo lp lq mz jr ls lt na lv lw lx nb lz ma mb nc md me mf ig bi translated">创建我们的环境变量文件:</p><pre class="kd ke kf kg gt np nq nr ns aw nt bi"><span id="d44d" class="nu kt in nq b gy nv nw l nx ny">mkdir static;<br/>echo 'window.GATSBY_API_URL="<a class="ae nz" href="https://jsonplaceholder.typicode.com" rel="noopener ugc nofollow" target="_blank">https://jsonplaceholder.typicode.com</a>"' &gt; static/env.js;</span></pre><p id="6f5f" class="pw-post-body-paragraph lk ll in lm b ln my jo lp lq mz jr ls lt na lv lw lx nb lz ma mb nc md me mf ig bi translated">瞒着g it</p><p id="cbea" class="pw-post-body-paragraph lk ll in lm b ln my jo lp lq mz jr ls lt na lv lw lx nb lz ma mb nc md me mf ig bi translated"><strong class="lm io">文件:</strong>T9】</p><pre class="kd ke kf kg gt np nq nr ns aw nt bi"><span id="4db5" class="nu kt in nq b gy nv nw l nx ny"># dotenv environment variable files<br/>.env*<br/>static/env.js</span></pre><p id="ebc3" class="pw-post-body-paragraph lk ll in lm b ln my jo lp lq mz jr ls lt na lv lw lx nb lz ma mb nc md me mf ig bi translated"><strong class="lm io">文件:</strong>T10】</p><pre class="kd ke kf kg gt np nq nr ns aw nt bi"><span id="1698" class="nu kt in nq b gy nv nw l nx ny">import * as React from "react"</span><span id="530c" class="nu kt in nq b gy od nw l nx ny">import Layout from "../components/layout"<br/>import SEO from "../components/seo"</span><span id="e1c5" class="nu kt in nq b gy od nw l nx ny">const IndexPage = () =&gt; {<br/><strong class="nq io">  const [todos, setTodos] = React.useState&lt;[{<br/>  title?: string}] | undefined&gt;()</strong></span><span id="6da8" class="nu kt in nq b gy od nw l nx ny"><strong class="nq io">  React.useEffect(() =&gt; {<br/>    fetch(`${window.GATSBY_API_URL}/todos`)<br/>      .then(response =&gt; response.json())<br/>      .then(json =&gt; setTodos(json))<br/>  }, [])</strong></span><span id="7965" class="nu kt in nq b gy od nw l nx ny">   return (<br/>    &lt;Layout&gt;<br/>      &lt;SEO title="Home" /&gt;<br/><strong class="nq io">      &lt;h1&gt;Todos&lt;/h1&gt;<br/>      {todos &amp;&amp; todos.length &gt; 0 &amp;&amp; (<br/>        &lt;ul&gt;<br/>          {todos.map((todo, key) =&gt; (<br/>            &lt;li key={`todo-${key}`}&gt;{todo?.title}&lt;/li&gt;<br/>          ))}<br/>        &lt;/ul&gt;<br/>      )}</strong><br/>    &lt;/Layout&gt;<br/>  )<br/>}</span><span id="86d1" class="nu kt in nq b gy od nw l nx ny">export default IndexPage</span></pre><p id="78a0" class="pw-post-body-paragraph lk ll in lm b ln my jo lp lq mz jr ls lt na lv lw lx nb lz ma mb nc md me mf ig bi translated">增加对自定义<code class="fe oa ob oc nq b">window</code>类型的支持。</p><pre class="kd ke kf kg gt np nq nr ns aw nt bi"><span id="dd41" class="nu kt in nq b gy nv nw l nx ny">mkdir src/types;<br/>touch src/types/window.d.ts;</span></pre><p id="498f" class="pw-post-body-paragraph lk ll in lm b ln my jo lp lq mz jr ls lt na lv lw lx nb lz ma mb nc md me mf ig bi translated"><strong class="lm io">文件:</strong>T12】</p><pre class="kd ke kf kg gt np nq nr ns aw nt bi"><span id="c264" class="nu kt in nq b gy nv nw l nx ny"><strong class="nq io">interface Window {<br/>  GATSBY_API_URL: string;<br/>}</strong></span></pre><p id="6d55" class="pw-post-body-paragraph lk ll in lm b ln my jo lp lq mz jr ls lt na lv lw lx nb lz ma mb nc md me mf ig bi translated">复制添加我们的<code class="fe oa ob oc nq b">env.js</code>文件所需的<code class="fe oa ob oc nq b">html.js</code>文件。</p><pre class="kd ke kf kg gt np nq nr ns aw nt bi"><span id="f564" class="nu kt in nq b gy nv nw l nx ny">cp .cache/default-html.js src/html.js</span></pre><p id="3082" class="pw-post-body-paragraph lk ll in lm b ln my jo lp lq mz jr ls lt na lv lw lx nb lz ma mb nc md me mf ig bi translated"><strong class="lm io">文件:</strong>T15】</p><pre class="kd ke kf kg gt np nq nr ns aw nt bi"><span id="130c" class="nu kt in nq b gy nv nw l nx ny">import React from "react"<br/>import PropTypes from "prop-types"</span><span id="971e" class="nu kt in nq b gy od nw l nx ny">export default function HTML(props) {<br/>  return (<br/>    &lt;html {...props.htmlAttributes}&gt;<br/>      &lt;head&gt;<br/>        &lt;meta charSet="utf-8" /&gt;<br/>        &lt;meta httpEquiv="x-ua-compatible" content="ie=edge" /&gt;<br/>        &lt;meta<br/>          name="viewport"<br/>          content="width=device-width, initial-scale=1, shrink-to-fit=no"<br/>        /&gt;<br/><strong class="nq io">        &lt;script src="/env.js"&gt;&lt;/script&gt;</strong></span></pre><p id="8857" class="pw-post-body-paragraph lk ll in lm b ln my jo lp lq mz jr ls lt na lv lw lx nb lz ma mb nc md me mf ig bi translated">如果我们运行<code class="fe oa ob oc nq b">yarn develop</code>，我们现在可以看到事情正在进行。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi oe"><img src="../Images/c127c84482b0b9459e9b93050c08f076.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LwYdXlIyf-gF6dOSosm-7w.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Application working with our env.js file</figcaption></figure></div><div class="ab cl nd ne hr nf" role="separator"><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni"/></div><div class="ig ih ii ij ik"><h1 id="3155" class="ks kt in bd ku kv nk kx ky kz nl lb lc jt nm ju le jw nn jx lg jz no ka li lj bi translated">Docker构建解决方案</h1><p id="9a96" class="pw-post-body-paragraph lk ll in lm b ln lo jo lp lq lr jr ls lt lu lv lw lx ly lz ma mb mc md me mf ig bi translated">下一步是用docker和所需的配置文件进行设置。</p><h2 id="1355" class="nu kt in bd ku of og dn ky oh oi dp lc lt oj ok le lx ol om lg mb on oo li op bi translated">问题回顾</h2><p id="e171" class="pw-post-body-paragraph lk ll in lm b ln lo jo lp lq lr jr ls lt lu lv lw lx ly lz ma mb mc md me mf ig bi translated">在上一篇文章中，我们检查了通过docker传递环境变量(最初设置Gatsby的方式)是不可行的，因为当我们运行Docker映像时，在Gatsby构建完成之前它不会工作。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi oe"><img src="../Images/b0575a7e16cf3a9171bae39ff32c12f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*f5JETvbzqqK2395FWGJ6vA.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Gatsby Docker still building</figcaption></figure><h2 id="e790" class="nu kt in bd ku of og dn ky oh oi dp lc lt oj ok le lx ol om lg mb on oo li op bi translated">解决办法</h2><p id="c80e" class="pw-post-body-paragraph lk ll in lm b ln lo jo lp lq lr jr ls lt lu lv lw lx ly lz ma mb mc md me mf ig bi translated">我们将修改/添加3个文件。</p><pre class="kd ke kf kg gt np nq nr ns aw nt bi"><span id="be1c" class="nu kt in nq b gy nv nw l nx ny">mkdir docker;<br/>touch docker/entrypoint.sh;<br/>touch .dockerignore;<br/>touch Dockerfile;</span></pre><p id="5284" class="pw-post-body-paragraph lk ll in lm b ln my jo lp lq mz jr ls lt na lv lw lx nb lz ma mb nc md me mf ig bi translated"><strong class="lm io">文件:</strong>T0】</p><pre class="kd ke kf kg gt np nq nr ns aw nt bi"><span id="59e8" class="nu kt in nq b gy nv nw l nx ny"># SET DEFAULT ENV IF NOT SET<br/>export GATSBY_API_URL="${GATSBY_API_URL:=unknown}";</span><span id="29da" class="nu kt in nq b gy od nw l nx ny"># CHECK IF FILES IS NOT CREATED, ELSE CREATE<br/>cd /usr/share/nginx/html;</span><span id="2fe9" class="nu kt in nq b gy od nw l nx ny">if [ ! -f env.js ];<br/>then<br/>    echo "window.GATSBY_API_URL='$GATSBY_API_URL';" &gt; env.js<br/>fi;</span><span id="c13a" class="nu kt in nq b gy od nw l nx ny">#̶ ̶B̶U̶I̶L̶D̶ ̶P̶R̶O̶J̶E̶C̶T̶<br/>y̶a̶r̶n̶ ̶b̶u̶i̶l̶d̶;̶</span><span id="5b65" class="nu kt in nq b gy od nw l nx ny"># KEEP NGINX DAEMON RUNNING<br/>nginx -g 'daemon off;'; nginx -s reload;</span></pre><p id="2444" class="pw-post-body-paragraph lk ll in lm b ln my jo lp lq mz jr ls lt na lv lw lx nb lz ma mb nc md me mf ig bi translated"><strong class="lm io">2021年7月9日更新:</strong></p><p id="adc3" class="pw-post-body-paragraph lk ll in lm b ln my jo lp lq mz jr ls lt na lv lw lx nb lz ma mb nc md me mf ig bi translated">感谢<a class="oq or ep" href="https://medium.com/u/91dfd1332931?source=post_page-----fc7e322bc9e--------------------------------" rel="noopener" target="_blank">埃塞基耶尔·冈萨雷斯·里亚尔</a>注意到<code class="fe oa ob oc nq b">yarn build</code>不应该在这个文件中，并且在运行映像时会给出一个错误。这是因为在下面的<code class="fe oa ob oc nq b">Dockerfile</code>中，我将该过程分为两步，构建和服务构建，其中不包含也不会识别第二步中<code class="fe oa ob oc nq b">entrypoint.sh</code>中的<code class="fe oa ob oc nq b">yarn build</code>。</p><pre class="kd ke kf kg gt np nq nr ns aw nt bi"><span id="cd7d" class="nu kt in nq b gy nv nw l nx ny">/usr/local/bin/entrypoint.sh: line 13: yarn: not found</span></pre><p id="be2a" class="pw-post-body-paragraph lk ll in lm b ln my jo lp lq mz jr ls lt na lv lw lx nb lz ma mb nc md me mf ig bi translated">文章现在继续。</p><p id="c8f2" class="pw-post-body-paragraph lk ll in lm b ln my jo lp lq mz jr ls lt na lv lw lx nb lz ma mb nc md me mf ig bi translated"><strong class="lm io">文件:</strong>T5】</p><pre class="kd ke kf kg gt np nq nr ns aw nt bi"><span id="0148" class="nu kt in nq b gy nv nw l nx ny">node_modules/<br/>*/node_modules/<br/>.git<br/>public<br/>.cache<br/>package-lock.json<br/>.env<br/>static/env.js</span></pre><p id="9c52" class="pw-post-body-paragraph lk ll in lm b ln my jo lp lq mz jr ls lt na lv lw lx nb lz ma mb nc md me mf ig bi translated"><strong class="lm io">文件:</strong>T6】</p><pre class="kd ke kf kg gt np nq nr ns aw nt bi"><span id="f44e" class="nu kt in nq b gy nv nw l nx ny"># BUILD PROCESS<br/>FROM node:12.18.4-alpine as build-stage</span><span id="0edc" class="nu kt in nq b gy od nw l nx ny">RUN apk update; \<br/>    apk add libpng-dev; \<br/>    apk add autoconf; \<br/>    apk add automake; \<br/>    apk add make; \<br/>    apk add g++; \<br/>    apk add libtool; \<br/>    apk add nasm;</span><span id="176e" class="nu kt in nq b gy od nw l nx ny">WORKDIR /usr/src/app</span><span id="9fbe" class="nu kt in nq b gy od nw l nx ny">COPY package.json yarn.lock /usr/src/app/</span><span id="513a" class="nu kt in nq b gy od nw l nx ny">RUN yarn install --non-interactive --frozen-lockfile</span><span id="6b2f" class="nu kt in nq b gy od nw l nx ny">COPY . ./</span><span id="b9ef" class="nu kt in nq b gy od nw l nx ny">RUN yarn run build --verbose</span><span id="ce17" class="nu kt in nq b gy od nw l nx ny"># BUILT APP<br/>FROM nginx:1.15.4-alpine</span><span id="0ad2" class="nu kt in nq b gy od nw l nx ny">WORKDIR /usr/share/nginx/html</span><span id="81fa" class="nu kt in nq b gy od nw l nx ny">COPY --from=build-stage /usr/src/app/public /usr/share/nginx/html</span><span id="4c21" class="nu kt in nq b gy od nw l nx ny">COPY $PWD/docker/entrypoint.sh /usr/local/bin</span><span id="48c0" class="nu kt in nq b gy od nw l nx ny">RUN chmod +x /usr/local/bin/entrypoint.sh</span><span id="c8d2" class="nu kt in nq b gy od nw l nx ny">ENTRYPOINT ["/bin/sh", "/usr/local/bin/entrypoint.sh"]</span><span id="0dba" class="nu kt in nq b gy od nw l nx ny">EXPOSE 80</span><span id="5df4" class="nu kt in nq b gy od nw l nx ny">CMD ["/bin/sh", "-c", "exec nginx -g 'daemon off;';"]</span></pre><p id="5643" class="pw-post-body-paragraph lk ll in lm b ln my jo lp lq mz jr ls lt na lv lw lx nb lz ma mb nc md me mf ig bi translated">配置完成后，我们将构建它。</p><pre class="kd ke kf kg gt np nq nr ns aw nt bi"><span id="d8d7" class="nu kt in nq b gy nv nw l nx ny">docker build . -t gatsby-building-ts</span></pre><p id="38cf" class="pw-post-body-paragraph lk ll in lm b ln my jo lp lq mz jr ls lt na lv lw lx nb lz ma mb nc md me mf ig bi translated">然后，当我们传递环境变量并运行图像时:</p><pre class="kd ke kf kg gt np nq nr ns aw nt bi"><span id="ae9e" class="nu kt in nq b gy nv nw l nx ny">docker run -it -d -p 8000:80 -e GATSBY_API_URL=<a class="ae nz" href="https://jsonplaceholder.typicode.com" rel="noopener ugc nofollow" target="_blank">https://jsonplaceholder.typicode.com</a> --name gatsby gatsby-building-ts;</span></pre><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi oe"><img src="../Images/c232658e6dec2c6426009d83036d7cfd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LWSBuV0l0gEyFANZ6uxcYw.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Docker environment variables being passed at run time</figcaption></figure></div><div class="ab cl nd ne hr nf" role="separator"><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni"/></div><div class="ig ih ii ij ik"><p id="79ee" class="pw-post-body-paragraph lk ll in lm b ln my jo lp lq mz jr ls lt na lv lw lx nb lz ma mb nc md me mf ig bi translated"><strong class="lm io">项目资源库:</strong>如果您有兴趣查看代码，您可以在这里获得所有内容。</p><div class="mg mh gp gr mi mj"><a href="https://github.com/codingwithmanny/gatsby-env-vars/tree/main" rel="noopener  ugc nofollow" target="_blank"><div class="mk ab fo"><div class="ml ab mm cl cj mn"><h2 class="bd io gy z fp mo fr fs mp fu fw im bi translated">coding with Manny/Gatsby-env-vars</h2><div class="mq l"><h3 class="bd b gy z fp mo fr fs mp fu fw dk translated">在GitHub上创建一个帐户，为codingwithmanny/Gatsby-env-vars的开发做出贡献。</h3></div><div class="mr l"><p class="bd b dl z fp mo fr fs mp fu fw dk translated">github.com</p></div></div><div class="ms l"><div class="os l mu mv mw ms mx km mj"/></div></div></a></div></div><div class="ab cl nd ne hr nf" role="separator"><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni"/></div><div class="ig ih ii ij ik"><h1 id="b4c3" class="ks kt in bd ku kv nk kx ky kz nl lb lc jt nm ju le jw nn jx lg jz no ka li lj bi translated">最后</h1><p id="09f9" class="pw-post-body-paragraph lk ll in lm b ln lo jo lp lq lr jr ls lt lu lv lw lx ly lz ma mb mc md me mf ig bi translated">下一步将是制作一个更真实的例子/实现，让它与<strong class="lm io"> <em class="ot"> Auth0 </em> </strong>一起工作。我应该很快就会写这篇文章了。</p><p id="2a81" class="pw-post-body-paragraph lk ll in lm b ln my jo lp lq mz jr ls lt na lv lw lx nb lz ma mb nc md me mf ig bi translated">如果你从中获得了价值，请在twitter上分享🐦或者其他社交媒体平台。再次感谢您的阅读。🙏</p><p id="fa9a" class="pw-post-body-paragraph lk ll in lm b ln my jo lp lq mz jr ls lt na lv lw lx nb lz ma mb nc md me mf ig bi translated">也请在推特上关注我:<a class="ae nz" href="http://twitter.com/codingwithmanny" rel="noopener ugc nofollow" target="_blank"> @codingwithmanny </a>和insta gram at<a class="ae nz" href="https://instagram.com/codingwithmanny" rel="noopener ugc nofollow" target="_blank">@ codingwithmanny</a>。</p><p id="eb38" class="pw-post-body-paragraph lk ll in lm b ln my jo lp lq mz jr ls lt na lv lw lx nb lz ma mb nc md me mf ig bi translated"><strong class="lm io">延伸阅读:</strong></p><div class="mg mh gp gr mi mj"><a href="https://codingwithmanny.medium.com/gatsby-docker-env-vars-alternative-e81802281999" rel="noopener follow" target="_blank"><div class="mk ab fo"><div class="ml ab mm cl cj mn"><h2 class="bd io gy z fp mo fr fs mp fu fw im bi translated">Gatsby Docker环境变量替代</h2><div class="mq l"><h3 class="bd b gy z fp mo fr fs mp fu fw dk translated">让GatsbyJS在Docker运行时使用环境变量</h3></div><div class="mr l"><p class="bd b dl z fp mo fr fs mp fu fw dk translated">codingwithmanny.medium.com</p></div></div><div class="ms l"><div class="mt l mu mv mw ms mx km mj"/></div></div></a></div><div class="mg mh gp gr mi mj"><a href="https://codingwithmanny.medium.com/nodejs-typescript-docker-deployment-process-with-aws-ebs-14796cd78392" rel="noopener follow" target="_blank"><div class="mk ab fo"><div class="ml ab mm cl cj mn"><h2 class="bd io gy z fp mo fr fs mp fu fw im bi translated">使用AWS EBS的NodeJS类型脚本Docker部署流程</h2><div class="mq l"><h3 class="bd b gy z fp mo fr fs mp fu fw dk translated">如何打包NodeJS TypeScript应用程序，将Docker映像构建并部署到AWS Elastic Beanstalk</h3></div><div class="mr l"><p class="bd b dl z fp mo fr fs mp fu fw dk translated">codingwithmanny.medium.com</p></div></div><div class="ms l"><div class="ou l mu mv mw ms mx km mj"/></div></div></a></div><div class="mg mh gp gr mi mj"><a href="https://codingwithmanny.medium.com/automating-nodejs-ts-deployments-with-codepipeline-to-elastic-beanstalk-79664321ab91" rel="noopener follow" target="_blank"><div class="mk ab fo"><div class="ml ab mm cl cj mn"><h2 class="bd io gy z fp mo fr fs mp fu fw im bi translated">通过到Elastic Beanstalk的代码管道自动化节点TS部署</h2><div class="mq l"><h3 class="bd b gy z fp mo fr fs mp fu fw dk translated">使用AWS CodePipeline到Elastic Beanstalk Docker设置连续部署</h3></div><div class="mr l"><p class="bd b dl z fp mo fr fs mp fu fw dk translated">codingwithmanny.medium.com</p></div></div><div class="ms l"><div class="ov l mu mv mw ms mx km mj"/></div></div></a></div></div></div>    
</body>
</html>