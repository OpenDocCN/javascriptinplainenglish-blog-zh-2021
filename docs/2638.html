<html>
<head>
<title>How to Let Users Download JavaScript Array Data as a CSV on Client-Side?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何让用户在客户端下载JavaScript数组数据为CSV？</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/how-to-let-users-download-javascript-array-data-as-a-csv-on-client-side-2373c04c2a6?source=collection_archive---------7-----------------------#2021-05-31">https://javascript.plainenglish.io/how-to-let-users-download-javascript-array-data-as-a-csv-on-client-side-2373c04c2a6?source=collection_archive---------7-----------------------#2021-05-31</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/d84c87c51b0c193b0bb82411e64dda6c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*yVe3eGsj8zzA8MdK"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@erik_karits?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Erik Karits</a> on <a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="1d8d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">有时，我们可能希望让用户下载一个嵌套数组，其中的数据是一个CSV文本文件。</p><p id="1e83" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，我们将研究如何让用户在客户端以CSV格式下载JavaScript数组的数据。</p><h1 id="bdd5" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">使用window.open方法</h1><p id="23c7" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以使用<code class="fe me mf mg mh b">window.open</code>方法打开一个URL编码的字符串，让用户下载到他们的计算机上。</p><p id="d7ab" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="e136" class="mq lc iq mh b gy mr ms l mt mu">const rows = [<br/>  ["name1", "new york", "abc"],<br/>  ["name2", "san francisco", "def"]<br/>];</span><span id="cc83" class="mq lc iq mh b gy mv ms l mt mu">let csvContent = "data:text/csv;charset=utf-8,";</span><span id="f3ec" class="mq lc iq mh b gy mv ms l mt mu">for (const rowArray of rows) {<br/>  const row = rowArray.join(",");<br/>  csvContent += `${row}\r\n`;<br/>}<br/>const encodedUri = encodeURI(csvContent);<br/>window.open(encodedUri);</span></pre><p id="74a6" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们有<code class="fe me mf mg mh b">rows</code>嵌套数组，我们想把它转换成CSV字符串，让用户下载。</p><p id="9456" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了进行转换，我们首先定义了指定MIME类型和字符集的<code class="fe me mf mg mh b">csvContent</code>字符串的开头。</p><p id="74ca" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们循环遍历<code class="fe me mf mg mh b">rows</code>条目，连接每一行的条目，并用换行符将它们添加到<code class="fe me mf mg mh b">csvContent</code>字符串中。</p><p id="09ea" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们用<code class="fe me mf mg mh b">csvContent</code>字符串调用<code class="fe me mf mg mh b">encodeURI</code>，将其编码成URL编码的字符串。</p><p id="d046" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">最后，我们可以用<code class="fe me mf mg mh b">window.open</code>下载字符串作为文件。</p><p id="c86c" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们也可以用<code class="fe me mf mg mh b">map</code>方法缩短for-of:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="55e4" class="mq lc iq mh b gy mr ms l mt mu">const rows = [<br/>  ["name1", "new york", "abc"],<br/>  ["name2", "san francisco", "def"]<br/>];</span><span id="e431" class="mq lc iq mh b gy mv ms l mt mu">const csvContent = `data:text/csv;charset=utf-8,${rows<br/>  .map((e) =&gt; e.join(","))<br/>  .join("\n")}`;</span><span id="45d1" class="mq lc iq mh b gy mv ms l mt mu">const encodedUri = encodeURI(csvContent);<br/>window.open(encodedUri);</span></pre><p id="c0ea" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们只需调用<code class="fe me mf mg mh b">rows</code>上的<code class="fe me mf mg mh b">map</code>，用<code class="fe me mf mg mh b">join</code>将每一行映射到一个逗号分隔的字符串。</p><p id="8063" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们在映射的字符串上调用<code class="fe me mf mg mh b">join</code>。</p><p id="6497" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">以这种方式下载文件不允许我们设置文件名。</p><p id="a9d9" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为了让我们设置文件名，我们可以创建一个不可见的链接，并以编程方式单击它。</p><p id="86fb" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">为此，我们呼吁:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="b055" class="mq lc iq mh b gy mr ms l mt mu">const rows = [<br/>  ["name1", "new york", "abc"],<br/>  ["name2", "san francisco", "def"]<br/>];<br/>const csvContent = `data:text/csv;charset=utf-8,${rows<br/>  .map((e) =&gt; e.join(","))<br/>  .join("\n")}`;<br/>const encodedUri = encodeURI(csvContent);<br/>const link = document.createElement("a");<br/>link.setAttribute("href", encodedUri);<br/>link.setAttribute("download", "data.csv");<br/>document.body.appendChild(link);<br/>link.click()</span></pre><p id="db5d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们调用<code class="fe me mf mg mh b">createElement</code>来创建一个<code class="fe me mf mg mh b">a</code>元素。</p><p id="f488" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们将<code class="fe me mf mg mh b">href</code>设置为<code class="fe me mf mg mh b">encodedUri</code>。</p><p id="0185" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们将<code class="fe me mf mg mh b">download</code>属性设置为带有<code class="fe me mf mg mh b">setAttribute</code>的文件名。</p><p id="de7a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">接下来，我们用<code class="fe me mf mg mh b">link</code>调用<code class="fe me mf mg mh b">appendChild</code>将其附加到主体上。</p><p id="960d" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们点击它上面的<code class="fe me mf mg mh b">click</code>，开始下载。</p><h1 id="85e9" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">将数据保存为Blob</h1><p id="66ce" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以通过重写上面的例子将数据保存为blob。</p><p id="146a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，我们可以写:</p><pre class="mi mj mk ml gt mm mh mn mo aw mp bi"><span id="9f04" class="mq lc iq mh b gy mr ms l mt mu">const rows = [<br/>  ["name1", "new york", "abc"],<br/>  ["name2", "san francisco", "def"]<br/>];<br/>const csvContent = rows<br/>  .map((e) =&gt; e.join(","))<br/>  .join("\n");<br/>const blob = new Blob([csvContent], {<br/>  type: 'text/csv;charset=utf-8;'<br/>});<br/>const url = URL.createObjectURL(blob);<br/>const link = document.createElement("a");<br/>link.setAttribute("href", url);<br/>link.setAttribute("download", "data.csv");<br/>document.body.appendChild(link);<br/>link.click()<br/>URL.revokeObjectURL(link.href)</span></pre><p id="5bba" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们有只包含CSV字符串内容的<code class="fe me mf mg mh b">csvContent</code>字符串。</p><p id="1b62" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们用<code class="fe me mf mg mh b">Blob</code>构造函数创建一个blob。</p><p id="f9f4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在它的第二个参数中，我们将<code class="fe me mf mg mh b">type</code>设置为blob的数据类型。</p><p id="7f28" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">接下来，我们调用<code class="fe me mf mg mh b">URL.createObjectURL</code>来创建一个可以下载的编码URL。</p><p id="44eb" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们用和以前一样的方法创建链接元素，但是用从<code class="fe me mf mg mh b">URL.createObjectURL</code>创建的<code class="fe me mf mg mh b">url</code>代替。</p><p id="1908" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">此外，下载完成后，我们必须调用<code class="fe me mf mg mh b">URL.revokeObjectURL</code>来释放资源。</p><h1 id="f281" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">结论</h1><p id="2160" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">我们可以让从客户端的嵌套数组生成CSV，并让用户下载一些JavaScript代码。</p><p id="4c44" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="mw">更多内容尽在</em><a class="ae kc" href="http://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><em class="mw">plain English . io</em></a></p></div></div>    
</body>
</html>