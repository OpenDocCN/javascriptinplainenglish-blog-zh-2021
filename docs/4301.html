<html>
<head>
<title>Weakmap in JavaScript</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">JavaScript中的Weakmap</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/weakmap-in-javascript-d575b14f872b?source=collection_archive---------14-----------------------#2021-08-26">https://javascript.plainenglish.io/weakmap-in-javascript-d575b14f872b?source=collection_archive---------14-----------------------#2021-08-26</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><figure class="im in gp gr io ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi il"><img src="../Images/ea3fe0d9dcf6dd9775f623d4a355a074.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*-WIX3Q-ss8qeR3Qn.jpg"/></div></div></figure><div class=""/><div class=""><h2 id="b695" class="pw-subtitle-paragraph jv ix iy bd b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km dk translated">理解弱引用和强引用的区别，记住我们的垃圾收集器！</h2></div><pre class="kn ko kp kq gt kr ks kt ku aw kv bi"><span id="817a" class="kw kx iy ks b gy ky kz l la lb">let obj = { name: ‘toto’ }</span><span id="f3ec" class="kw kx iy ks b gy lc kz l la lb">// The object { name: ‘toto’ } can be accessed<br/>// since obj has the reference to it</span><span id="1cc1" class="kw kx iy ks b gy lc kz l la lb">// overwrite the reference<br/>obj = null</span><span id="5538" class="kw kx iy ks b gy lc kz l la lb">// the object will be removed from the memory<br/>// since we have lost all reference on it</span></pre><p id="a7d5" class="pw-post-body-paragraph ld le iy lf b lg lh jz li lj lk kc ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated">另一个例子，</p><pre class="kn ko kp kq gt kr ks kt ku aw kv bi"><span id="839b" class="kw kx iy ks b gy ky kz l la lb">let obj = { name: ‘toto’ }<br/>let arr = [ obj ]</span><span id="3950" class="kw kx iy ks b gy lc kz l la lb">obj = null</span></pre><p id="8d22" class="pw-post-body-paragraph ld le iy lf b lg lh jz li lj lk kc ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated">在本例中，对象`{ name: 'toto' } '不会被删除，因为数组保留了对它的引用！</p><h2 id="e2d4" class="kw kx iy bd lz ma mb dn mc md me dp mf lm mg mh mi lq mj mk ml lu mm mn mo mp bi translated">强引用和弱引用的区别是什么？</h2><p id="f3b6" class="pw-post-body-paragraph ld le iy lf b lg mq jz li lj mr kc ll lm ms lo lp lq mt ls lt lu mu lw lx ly ig bi translated">事实上，JavaScript中的大多数变量都保留了对一个对象的强引用。例如，上面的数组保存了一个对对象<strong class="lf iz"> ({ name: 'toto' }) </strong>的<strong class="lf iz">强</strong>引用。</p><p id="dee1" class="pw-post-body-paragraph ld le iy lf b lg lh jz li lj lk kc ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated">如果任何变量保持一个对该对象的<strong class="lf iz">强引用</strong>，该对象将不会被垃圾收集器移除。但是如果只有变量保持对对象的弱引用，它将被垃圾收集器删除。</p><p id="1458" class="pw-post-body-paragraph ld le iy lf b lg lh jz li lj lk kc ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated">一些变量类型对一个对象有一个弱引用，这就是Weakmap的情况。</p><h2 id="fb53" class="kw kx iy bd lz ma mb dn mc md me dp mf lm mg mh mi lq mj mk ml lu mm mn mo mp bi translated">Weakmap</h2><p id="01b7" class="pw-post-body-paragraph ld le iy lf b lg mq jz li lj mr kc ll lm ms lo lp lq mt ls lt lu mu lw lx ly ig bi translated">weakmap是一个额外的数据存储，它可以允许我们从外部扩展一个对象(第三方库)或密封对象，而不需要推断垃圾收集器！或者聪明地创建一个缓存功能！</p><p id="3f05" class="pw-post-body-paragraph ld le iy lf b lg lh jz li lj lk kc ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated">别慌，我会解释给你看这是什么意思！在我们比较map和weakmap之前。</p><h2 id="cf35" class="kw kx iy bd lz ma mb dn mc md me dp mf lm mg mh mi lq mj mk ml lu mm mn mo mp bi translated">地图对地图</h2><p id="d270" class="pw-post-body-paragraph ld le iy lf b lg mq jz li lj mr kc ll lm ms lo lp lq mt ls lt lu mu lw lx ly ig bi translated">使用map，对象占用内存，可能不会被垃圾收集。映射有一个对对象的强引用。</p><pre class="kn ko kp kq gt kr ks kt ku aw kv bi"><span id="3c50" class="kw kx iy ks b gy ky kz l la lb">let obj = { name: ‘toto’ }<br/>let mapObj = new Map()<br/>mapObj.set(obj, ‘any value’)</span><span id="1e48" class="kw kx iy ks b gy lc kz l la lb">obj = null<br/>mapObj.size() // 1</span></pre><p id="9f24" class="pw-post-body-paragraph ld le iy lf b lg lh jz li lj lk kc ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated">Weakmap完全不同，它不阻止关键对象的垃圾收集。</p><p id="ab49" class="pw-post-body-paragraph ld le iy lf b lg lh jz li lj lk kc ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated">第一条规则: weakmap只接受“object as key ”;<strong class="lf iz">其次</strong>，它只保留对对象的弱引用。</p><pre class="kn ko kp kq gt kr ks kt ku aw kv bi"><span id="96e0" class="kw kx iy ks b gy ky kz l la lb">let obj = { name: ‘toto’ }<br/>let weakmapObj = new WeakMap()<br/>weakmapObj.set(obj, ‘any value’)</span><span id="1063" class="kw kx iy ks b gy lc kz l la lb">obj = null<br/>weakmapObj .size() // 0</span></pre><p id="ee21" class="pw-post-body-paragraph ld le iy lf b lg lh jz li lj lk kc ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated">该对象被垃圾收集器移除，因为weakmap只有一个对对象*{ name: 'toto' }*的<strong class="lf iz">弱引用</strong>，并且该对象不再有强引用(只有变量obj保留了对它的引用)。</p><h2 id="dfd8" class="kw kx iy bd lz ma mb dn mc md me dp mf lm mg mh mi lq mj mk ml lu mm mn mo mp bi translated">什么时候用这个？</h2><p id="f69e" class="pw-post-body-paragraph ld le iy lf b lg mq jz li lj mr kc ll lm ms lo lp lq mt ls lt lu mu lw lx ly ig bi translated">如你所见，Weakmap很强(没错，是个玩笑)但不是每次都能用。只能在少数情况下使用。</p><p id="505f" class="pw-post-body-paragraph ld le iy lf b lg lh jz li lj lk kc ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated"><strong class="lf iz">缓存功能</strong></p><pre class="kn ko kp kq gt kr ks kt ku aw kv bi"><span id="45ac" class="kw kx iy ks b gy ky kz l la lb">const cache = new WeakMap()</span><span id="3209" class="kw kx iy ks b gy lc kz l la lb">const process = function (obj) { <br/> // If the input is not already cached <br/> if (!cache.has(obj)) { <br/> // Imagine a function that need a lot of memory/ressource <br/> // We don’t want to re-execute bigOperation function<br/> // if the input is the same ! <br/> const result = bigOperation(obj) <br/> // So we execute the function one time and<br/> // we store the result in cache ! <br/> cache.set(obj, result) <br/> } <br/> return cache.get(obj) <br/>}</span><span id="b10a" class="kw kx iy ks b gy lc kz l la lb">let obj = { /* any object */ } <br/>// first time we don’t have this input as cache, so we will put into <br/>const firstResult = process(obj) <br/>// second time we don’t need to execute the big function, <br/>// just need to exctract the result in cache <br/>const secondeResult = process(obj) <br/>// the original object will be removed from weakmap ! <br/>obj = null <br/></span></pre><p id="5b0d" class="pw-post-body-paragraph ld le iy lf b lg lh jz li lj lk kc ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated">有了地图，这个缓存函数应该把obj保存在内存中。它会导致内存泄漏！</p><p id="ed04" class="pw-post-body-paragraph ld le iy lf b lg lh jz li lj lk kc ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated">当我们保存一个对未使用对象的引用时，就会产生内存泄漏，所以如果你不再使用任何对象，就删除对它的任何变量引用！</p><p id="1b76" class="pw-post-body-paragraph ld le iy lf b lg lh jz li lj lk kc ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated">⚠️我们不能用<em class="mv">。keys() /。values() /。因为我们不知道垃圾收集器什么时候会删除对象！</em></p><p id="eed6" class="pw-post-body-paragraph ld le iy lf b lg lh jz li lj lk kc ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated"><strong class="lf iz">最后一个例子</strong></p><p id="35f5" class="pw-post-body-paragraph ld le iy lf b lg lh jz li lj lk kc ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated">无内存泄漏的动态访问计数器</p><pre class="kn ko kp kq gt kr ks kt ku aw kv bi"><span id="a052" class="kw kx iy ks b gy ky kz l la lb">// Counter of visits<br/>let visitsCountMap = new WeakMap()</span><span id="5118" class="kw kx iy ks b gy lc kz l la lb">// increase the visits count<br/>function countUser(user) {<br/> const count = visitsCountMap.get(user) || 0<br/> visitsCountMap.set(user, count + 1)<br/>}</span><span id="491f" class="kw kx iy ks b gy lc kz l la lb">let toto = { name: “toto” }</span><span id="4a5d" class="kw kx iy ks b gy lc kz l la lb">countUser(toto) // count his visits</span><span id="f3ac" class="kw kx iy ks b gy lc kz l la lb">// later toto leaves us<br/>toto = null<br/></span></pre><p id="663f" class="pw-post-body-paragraph ld le iy lf b lg lh jz li lj lk kc ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated"><em class="mv">注:本文灵感来自</em><a class="ae mw" href="https://javascript.info/weakmap-weakset*" rel="noopener ugc nofollow" target="_blank"><em class="mv">https://javascript.info/weakmap-weakset</em></a></p></div><div class="ab cl mx my hr mz" role="separator"><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc"/></div><div class="ig ih ii ij ik"><p id="e45d" class="pw-post-body-paragraph ld le iy lf b lg lh jz li lj lk kc ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated">希望你喜欢这篇读物！</p><p id="fcd9" class="pw-post-body-paragraph ld le iy lf b lg lh jz li lj lk kc ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated">🎁如果你在<a class="ae mw" href="https://twitter.com/code__oz" rel="noopener ugc nofollow" target="_blank">推特</a>上关注我并给我打电话，你可以免费得到我的新书<strong class="lf iz">被低估的javascript技能，改变现状</strong>😁</p><p id="b86a" class="pw-post-body-paragraph ld le iy lf b lg lh jz li lj lk kc ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated">或者得到它<a class="ae mw" href="https://codeoz.gumroad.com/l/RXLYp" rel="noopener ugc nofollow" target="_blank">这里</a></p><p id="012d" class="pw-post-body-paragraph ld le iy lf b lg lh jz li lj lk kc ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated">🎁<a class="ae mw" href="https://www.getrevue.co/profile/code__oz" rel="noopener ugc nofollow" target="_blank">我的简讯</a></p><p id="e764" class="pw-post-body-paragraph ld le iy lf b lg lh jz li lj lk kc ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated">☕️你可以<a class="ae mw" href="https://www.buymeacoffee.com/CodeoZ" rel="noopener ugc nofollow" target="_blank">支持我的作品</a>🙏</p><p id="f563" class="pw-post-body-paragraph ld le iy lf b lg lh jz li lj lk kc ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated">🏃‍♂️，你可以跟着我👇</p><p id="6e07" class="pw-post-body-paragraph ld le iy lf b lg lh jz li lj lk kc ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated">🕊 <a class="ae mw" href="https://twitter.com/code__oz" rel="noopener ugc nofollow" target="_blank">推特</a></p><p id="aaed" class="pw-post-body-paragraph ld le iy lf b lg lh jz li lj lk kc ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated">👨‍💻<a class="ae mw" href="https://github.com/Code-Oz" rel="noopener ugc nofollow" target="_blank"> Github </a></p><p id="977d" class="pw-post-body-paragraph ld le iy lf b lg lh jz li lj lk kc ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated">你可以标记🔖这篇文章！</p><p id="9ce6" class="pw-post-body-paragraph ld le iy lf b lg lh jz li lj lk kc ll lm ln lo lp lq lr ls lt lu lv lw lx ly ig bi translated"><em class="mv">更多内容看</em> <a class="ae mw" href="http://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="lf iz"> <em class="mv">说白了. io </em> </strong> </a></p></div></div>    
</body>
</html>