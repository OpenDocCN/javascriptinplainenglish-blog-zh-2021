<html>
<head>
<title>Create a WhatsApp Clone with Next.js: Fetch Chat</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Next.js: Fetch Chat创建WhatsApp克隆</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/create-whatsapp-clone-with-next-js-part-23-fetch-chat-db71d826a76f?source=collection_archive---------10-----------------------#2021-11-14">https://javascript.plainenglish.io/create-whatsapp-clone-with-next-js-part-23-fetch-chat-db71d826a76f?source=collection_archive---------10-----------------------#2021-11-14</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="15a3" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">第23部分:使用Firestore onSnapshot获取聊天记录</h2></div><p id="3cf1" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在本文中，我们开始使用onSnapshot实时获取聊天记录。相比只是抓取用户，聊天变化更频繁；它们会在创建聊天或有人发送消息后发生变化。</p><figure class="lb lc ld le gt lf"><div class="bz fp l di"><div class="lg lh l"/></div></figure><p id="0c39" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">加入获取<a class="ae li" href="https://www.youtube.com/channel/UCu4-4FnutvSHVo9WHvq80Ww/join" rel="noopener ugc nofollow" target="_blank">源代码</a></p><p id="42f4" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">进入Sidebar.js，从firestore导入<code class="fe lj lk ll lm b">onSnapshot</code>。</p><pre class="lb lc ld le gt ln lm lo lp aw lq bi"><span id="e813" class="lr ls iq lm b gy lt lu l lv lw">import { collection, getDocs, onSnapshot, query, where } from "@firebase/firestore";</span></pre><p id="cbdc" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">创建状态聊天</p><pre class="lb lc ld le gt ln lm lo lp aw lq bi"><span id="2d2c" class="lr ls iq lm b gy lt lu l lv lw">const [chats, setChats] = useState([])</span></pre><p id="2774" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们使用useEffect，查询包含该当前用户的聊天记录。每次有变化时，我们用doc.data()和文档id设置聊天。</p><pre class="lb lc ld le gt ln lm lo lp aw lq bi"><span id="29df" class="lr ls iq lm b gy lt lu l lv lw">useEffect(() =&gt; {</span><span id="e376" class="lr ls iq lm b gy lx lu l lv lw">const chatsRef = collection(db, "chats")</span><span id="f7a4" class="lr ls iq lm b gy lx lu l lv lw">const q = query(chatsRef, where("users", "array-contains", currentUser.uid));</span><span id="27bd" class="lr ls iq lm b gy lx lu l lv lw">const unsubscribe = onSnapshot(q, (querySnapshot) =&gt; {</span><span id="5df5" class="lr ls iq lm b gy lx lu l lv lw">setChats(querySnapshot.docs.map(doc =&gt; ({ ...doc.data(), id: doc.id })))</span><span id="ea02" class="lr ls iq lm b gy lx lu l lv lw">})</span><span id="d439" class="lr ls iq lm b gy lx lu l lv lw">return unsubscribe</span><span id="73c4" class="lr ls iq lm b gy lx lu l lv lw">}, [])</span></pre><h2 id="c7bf" class="lr ls iq bd ly lz ma dn mb mc md dp me ko mf mg mh ks mi mj mk kw ml mm mn mo bi translated">渲染聊天</h2><p id="3d7e" class="pw-post-body-paragraph kf kg iq kh b ki mp jr kk kl mq ju kn ko mr kq kr ks ms ku kv kw mt ky kz la ij bi translated">我们已经设置了聊天。现在是渲染的时候了，但是聊天组件有更多的细节需要我们稍后添加。因此，我们只呈现一个简单的<div>，它显示文档id，用于表明我们成功地获得了聊天。</div></p><pre class="lb lc ld le gt ln lm lo lp aw lq bi"><span id="a142" class="lr ls iq lm b gy lt lu l lv lw">{chats.map(chat =&gt; &lt;div key={chat.id}&gt;{chat.id}&lt;/div&gt;)}</span></pre><figure class="lb lc ld le gt lf gh gi paragraph-image"><div role="button" tabindex="0" class="mv mw di mx bf my"><div class="gh gi mu"><img src="../Images/ba777c6f4640fb88ae9e3993184172f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_oRkYqQXqWiA6i3EKoq6lQ.png"/></div></div><figcaption class="nb nc gj gh gi nd ne bd b be z dk">chat id show on the sidebar</figcaption></figure><h1 id="bbe9" class="nf ls iq bd ly ng nh ni mb nj nk nl me jw nm jx mh jz nn ka mk kc no kd mn np bi translated">关注我们:<a class="ae li" href="https://www.youtube.com/channel/UCu4-4FnutvSHVo9WHvq80Ww?sub_confirmation=1" rel="noopener ugc nofollow" target="_blank"> YouTube </a>，<a class="ae li" href="https://ckmobile.medium.com/" rel="noopener"> Medium </a>，<a class="ae li" href="https://www.udemy.com/user/cyruschan2/" rel="noopener ugc nofollow" target="_blank"> Udemy </a>，<a class="ae li" href="https://www.linkedin.com/company/ckmobi/" rel="noopener ugc nofollow" target="_blank"> Linkedin </a>，<a class="ae li" href="https://twitter.com/ckmobilejavasc1" rel="noopener ugc nofollow" target="_blank"> Twitter </a>，<a class="ae li" href="https://www.instagram.com/ckmobile8050" rel="noopener ugc nofollow" target="_blank"> Instagram </a>，<a class="ae li" href="https://app.gumroad.com/ckmobile" rel="noopener ugc nofollow" target="_blank"> Gumroad </a></h1><p id="2be8" class="pw-post-body-paragraph kf kg iq kh b ki mp jr kk kl mq ju kn ko mr kq kr ks ms ku kv kw mt ky kz la ij bi translated"><em class="nq">更多内容看</em> <a class="ae li" href="http://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kh ir"> <em class="nq">说白了。报名参加我们的</em> <a class="ae li" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kh ir"> <em class="nq">免费周报在这里</em> </strong> </a> <em class="nq">。</em></strong></a></p></div></div>    
</body>
</html>