<html>
<head>
<title>Learn Basic Scraping with Puppeteer</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用木偶师学习基本刮削</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/learn-basic-scraping-with-puppeteer-50af3077e16e?source=collection_archive---------14-----------------------#2021-12-28">https://javascript.plainenglish.io/learn-basic-scraping-with-puppeteer-50af3077e16e?source=collection_archive---------14-----------------------#2021-12-28</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><figure class="im in gp gr io ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi il"><img src="../Images/1759c1c4d6d731468e81937a806b369e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Z43Gzoxhuc49z89EU6dPlA.jpeg"/></div></div></figure><div class=""/><div class=""><h2 id="bd1d" class="pw-subtitle-paragraph jv ix iy bd b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km dk translated">通过下载迷因模板</h2></div><blockquote class="kn ko kp"><p id="051d" class="kq kr ks kt b ku kv jz kw kx ky kc kz la lb lc ld le lf lg lh li lj lk ll lm ig bi translated">⚠️我们将创建一个脚本来从<a class="ae ln" href="https://imgflip.com/" rel="noopener ugc nofollow" target="_blank"> imgflip </a>下载meme模板。在使用来自他们的内容之前，请仔细阅读他们的<a class="ae ln" href="https://imgflip.com/terms" rel="noopener ugc nofollow" target="_blank">条款</a>。⚠️</p></blockquote><h1 id="7598" class="lo lp iy bd lq lr ls lt lu lv lw lx ly ke lz kf ma kh mb ki mc kk md kl me mf bi translated">介绍</h1><p id="74f3" class="pw-post-body-paragraph kq kr iy kt b ku mg jz kw kx mh kc kz mi mj lc ld mk ml lg lh mm mn lk ll lm ig bi translated">不久前，我想和一些朋友做一个迷因比赛，所以我上网搜索了一个迷因模板包来下载。令我<em class="ks">非常惊讶的是</em>，我发现了很少的结果，我非常自信我会获得大量的材料，相反，我只发现了一些包，我真的不满意…所以我决定看看网络抓取来下载其中一些。</p><p id="c620" class="pw-post-body-paragraph kq kr iy kt b ku kv jz kw kx ky kc kz mi lb lc ld mk lf lg lh mm lj lk ll lm ig bi translated"><em class="ks">很有可能实际上有很多材料，但是经过一些令人失望的研究后，这个想法出现在我的脑海中，于是我停止了搜索</em></p><p id="9d7a" class="pw-post-body-paragraph kq kr iy kt b ku kv jz kw kx ky kc kz mi lb lc ld mk lf lg lh mm lj lk ll lm ig bi translated">今天我想写下我做的一个小脚本来尝试基本的刮擦并解释它。我将使用<a class="ae ln" href="https://pptr.dev/" rel="noopener ugc nofollow" target="_blank">木偶师</a>，但是这些概念也与其他库相关(如果您使用不同的库，这可能只是语法问题)。</p><p id="59b0" class="pw-post-body-paragraph kq kr iy kt b ku kv jz kw kx ky kc kz mi lb lc ld mk lf lg lh mm lj lk ll lm ig bi translated">我是一个<a class="ae ln" href="https://en.wikipedia.org/wiki/Learning-by-doing" rel="noopener ugc nofollow" target="_blank">边做边学</a>的人，因此，为了学习基本的抓取，我决定创建一个脚本，从伟大的imgflip网站下载meme模板(我无意伤害他们，这是一个我经常使用的网站，如果你需要<a class="ae ln" href="https://imgflip.com/memegenerator" rel="noopener ugc nofollow" target="_blank">创建meme</a>，我强烈推荐使用它)。</p><p id="79fa" class="pw-post-body-paragraph kq kr iy kt b ku kv jz kw kx ky kc kz mi lb lc ld mk lf lg lh mm lj lk ll lm ig bi translated"><em class="ks">这个脚本中的代码利用了一些‘现代’JavaScript特性，比如async/await。我不会在本文中涉及语言细节。</em></p><h2 id="d431" class="mo lp iy bd lq mp mq dn lu mr ms dp ly mi mt mu ma mk mv mw mc mm mx my me mz bi translated">什么是刮痧</h2><p id="23dc" class="pw-post-body-paragraph kq kr iy kt b ku mg jz kw kx mh kc kz mi mj lc ld mk ml lg lh mm mn lk ll lm ig bi translated">在网络生态系统中,<code class="fe na nb nc nd b">scraping</code>指的是一种技术，在这种技术中(通常)自动化过程从网站获取并复制一些数据。在我们的例子中，我们想要创建一个脚本来打开<a class="ae ln" href="https://imgflip.com/memetemplates" rel="noopener ugc nofollow" target="_blank">img lip meme模板页面</a>，下载页面上的每个模板，导航到下一个页面，下载页面上的每个模板，导航到下一个页面，等等...</p><h2 id="2bec" class="mo lp iy bd lq mp mq dn lu mr ms dp ly mi mt mu ma mk mv mw mc mm mx my me mz bi translated">什么是木偶师</h2><p id="4e0f" class="pw-post-body-paragraph kq kr iy kt b ku mg jz kw kx mh kc kz mi mj lc ld mk ml lg lh mm mn lk ll lm ig bi translated">Puppeteer是一个库，可以让你通过一些高级API控制Chrome(浏览器)。如果你想读更多，没有比它的知识库更好的来源了。我发现它非常直观且易于使用，所以我认为它非常适合我的用例。</p><h1 id="20dd" class="lo lp iy bd lq lr ls lt lu lv lw lx ly ke lz kf ma kh mb ki mc kk md kl me mf bi translated">密码</h1><p id="dd1e" class="pw-post-body-paragraph kq kr iy kt b ku mg jz kw kx mh kc kz mi mj lc ld mk ml lg lh mm mn lk ll lm ig bi translated">要使用puppeteer，您要么需要创建一个npm项目并将其作为一个依赖项安装，要么您可以全局安装它并在您想要的地方使用它。</p><p id="e034" class="pw-post-body-paragraph kq kr iy kt b ku kv jz kw kx ky kc kz mi lb lc ld mk lf lg lh mm lj lk ll lm ig bi translated">a)建立国家预防机制项目</p><figure class="nf ng nh ni gt ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi ne"><img src="../Images/62ba8a130b3a78d1b08c2c43720322d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OrL-3a745WeLUtqa1pRKTw.png"/></div></div><figcaption class="nj nk gj gh gi nl nm bd b be z dk">code to create an npm project with puppeteer</figcaption></figure><p id="7f5d" class="pw-post-body-paragraph kq kr iy kt b ku kv jz kw kx ky kc kz mi lb lc ld mk lf lg lh mm lj lk ll lm ig bi translated">b)在全球范围内安装，并在您需要的地方使用</p><figure class="nf ng nh ni gt ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi ne"><img src="../Images/1978683ad7309e94a04c209760e297ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PxuxfODki0SgYcToZhPLDg.png"/></div></div><figcaption class="nj nk gj gh gi nl nm bd b be z dk">code to install puppeteer globally</figcaption></figure><p id="33f8" class="pw-post-body-paragraph kq kr iy kt b ku kv jz kw kx ky kc kz mi lb lc ld mk lf lg lh mm lj lk ll lm ig bi translated">现在我们已经准备好写下一些代码，因为这个小项目不需要任何其他的依赖。</p><p id="b4e0" class="pw-post-body-paragraph kq kr iy kt b ku kv jz kw kx ky kc kz mi lb lc ld mk lf lg lh mm lj lk ll lm ig bi translated">在你的项目中创建一个JavaScript文件，用你最喜欢的编辑器/IDE打开它(如果你还没有的话，我建议你使用VSCode)</p><figure class="nf ng nh ni gt ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi ne"><img src="../Images/0767054b5e6693efe20eca043d3a44e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*R7HRw0npZv5Lbt1RvtX76Q.png"/></div></div><figcaption class="nj nk gj gh gi nl nm bd b be z dk">code to create an index.js file</figcaption></figure><p id="54aa" class="pw-post-body-paragraph kq kr iy kt b ku kv jz kw kx ky kc kz mi lb lc ld mk lf lg lh mm lj lk ll lm ig bi translated">现在让我们写一些代码:</p><p id="dc07" class="pw-post-body-paragraph kq kr iy kt b ku kv jz kw kx ky kc kz mi lb lc ld mk lf lg lh mm lj lk ll lm ig bi translated">首先，我们导入依赖项</p><figure class="nf ng nh ni gt ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi ne"><img src="../Images/6176a742d31914d82d1e8a0d39bc4f79.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zEsCGTqfp2R6274KObL5Sg.png"/></div></div><figcaption class="nj nk gj gh gi nl nm bd b be z dk">code to import dependencies</figcaption></figure><p id="6841" class="pw-post-body-paragraph kq kr iy kt b ku kv jz kw kx ky kc kz mi lb lc ld mk lf lg lh mm lj lk ll lm ig bi translated">出于显而易见的原因，我们导入了puppeteer和fs，因为我们需要访问文件系统来保存图像。</p><p id="de7e" class="pw-post-body-paragraph kq kr iy kt b ku kv jz kw kx ky kc kz mi lb lc ld mk lf lg lh mm lj lk ll lm ig bi translated">还要创建一个文件夹，我们将在其中存储下载的图像，我将调用<code class="fe na nb nc nd b">memes.</code></p><p id="2ace" class="pw-post-body-paragraph kq kr iy kt b ku kv jz kw kx ky kc kz mi lb lc ld mk lf lg lh mm lj lk ll lm ig bi translated">我们要做的下一件事可能是最重要的，也是最无聊的:获取我们在网站中导航和获取图像所需的所有选择器。我们需要选择器用于:</p><ul class=""><li id="b582" class="nn no iy kt b ku kv kx ky mi np mk nq mm nr lm ns nt nu nv bi translated">导航到下一页</li><li id="4622" class="nn no iy kt b ku nw kx nx mi ny mk nz mm oa lm ns nt nu nv bi translated">检测我们何时在最后一页</li><li id="0050" class="nn no iy kt b ku nw kx nx mi ny mk nz mm oa lm ns nt nu nv bi translated">获得迷因图像</li><li id="65dc" class="nn no iy kt b ku nw kx nx mi ny mk nz mm oa lm ns nt nu nv bi translated">获取迷因标题(我们将用它来命名图片)</li></ul><p id="c5ac" class="pw-post-body-paragraph kq kr iy kt b ku kv jz kw kx ky kc kz mi lb lc ld mk lf lg lh mm lj lk ll lm ig bi translated">为此，我用chrome开发工具检查了页面，我将省去这一部分，直接向您展示代码</p><figure class="nf ng nh ni gt ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi ne"><img src="../Images/bce1b963ad848170e8a5572285accbe5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ch9MDp3iF0tUQauoEvSTvQ.png"/></div></div><figcaption class="nj nk gj gh gi nl nm bd b be z dk">code to setup constants</figcaption></figure><p id="0ac6" class="pw-post-body-paragraph kq kr iy kt b ku kv jz kw kx ky kc kz mi lb lc ld mk lf lg lh mm lj lk ll lm ig bi translated">现在让我们编写代码来设置木偶师并处理页面之间的导航</p><figure class="nf ng nh ni gt ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi ne"><img src="../Images/d5f288499f5af961633530a90634cc72.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZpJ1kreWj4Yg1mHPLxcTtQ.png"/></div></div><figcaption class="nj nk gj gh gi nl nm bd b be z dk">code of the main function</figcaption></figure><p id="f545" class="pw-post-body-paragraph kq kr iy kt b ku kv jz kw kx ky kc kz mi lb lc ld mk lf lg lh mm lj lk ll lm ig bi translated">评论应该是不言自明的，基本上，我们设置了木偶师，打开imgflip模板页面，当我们还有“下一页”时，下载我们在当前页面找到的所有模因。最后关闭浏览器。</p><p id="4d42" class="pw-post-body-paragraph kq kr iy kt b ku kv jz kw kx ky kc kz mi lb lc ld mk lf lg lh mm lj lk ll lm ig bi translated">让我们看看如何在一个页面上下载所有的迷因</p><figure class="nf ng nh ni gt ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi ne"><img src="../Images/48d3caf78d5f96e7a0d64cf63cfa3c11.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gym2iCxVd2OtM_SVlayOcg.png"/></div></div><figcaption class="nj nk gj gh gi nl nm bd b be z dk">code to handle the list of meme</figcaption></figure><p id="9071" class="pw-post-body-paragraph kq kr iy kt b ku kv jz kw kx ky kc kz mi lb lc ld mk lf lg lh mm lj lk ll lm ig bi translated">所以这有点复杂。首先，我们定义一个函数让脚本等待。正如评论中写的那样，那是为了避免对imgflip提出太多要求。然后，在函数中，我们使用getMemeList函数检索迷因列表，我们将很快实现该函数，对于每个迷因，我们打开与图像相关的页面(迷因的图像URL)，等待1秒钟(因为我们很好)，然后我们检查响应的标题。</p><blockquote class="kn ko kp"><p id="0e47" class="kq kr ks kt b ku kv jz kw kx ky kc kz la lb lc ld le lf lg lh li lj lk ll lm ig bi translated">Puppeteer允许您检查页面请求的不同部分，我们可以使用headers方法访问标头，或者通过调用buffer方法查看响应。在<a class="ae ln" href="https://pptr.dev/#?product=Puppeteer&amp;version=v13.0.1&amp;show=api-class-httpresponse" rel="noopener ugc nofollow" target="_blank">文档页面</a>查看更多信息。</p></blockquote><p id="4ca6" class="pw-post-body-paragraph kq kr iy kt b ku kv jz kw kx ky kc kz mi lb lc ld mk lf lg lh mm lj lk ll lm ig bi translated">响应的头将包含content-type属性，并且它应该以某种方式与一个图像相关(我们打开了meme图像的URL)，但是通过这样做，我发现一些图像(全尺寸，我们稍后将讨论这一点)在任何地方都找不到(或者更有可能的是，我在错误的地方寻找它们)，而是返回一个XML错误页面。这就是为什么它在那里，如果我们有一个XML响应，图像不在那里，所以我们忽略它。如果没有，我们调用“下载图像”函数来处理下载。在我们通过调用“page.goBack”返回到上一页之后。</p><figure class="nf ng nh ni gt ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi ne"><img src="../Images/9b56e076e6bcc235f6c61fd22e2a1e12.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*U3oRAT1EV-viXXqAD02oDw.png"/></div></div><figcaption class="nj nk gj gh gi nl nm bd b be z dk">code to download the image from the response</figcaption></figure><p id="6cd8" class="pw-post-body-paragraph kq kr iy kt b ku kv jz kw kx ky kc kz mi lb lc ld mk lf lg lh mm lj lk ll lm ig bi translated">这很简单，我们通过调用<code class="fe na nb nc nd b">buffer</code>方法获得响应体，然后将它写在文件系统上，没什么特别的。</p><p id="8ac2" class="pw-post-body-paragraph kq kr iy kt b ku kv jz kw kx ky kc kz mi lb lc ld mk lf lg lh mm lj lk ll lm ig bi translated">我们只需要实现检索页面上所有模因的功能。</p><figure class="nf ng nh ni gt ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi ob"><img src="../Images/034e3ea2f4f2b4012da3739978da13a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_k_Ov_sC7aq_oPg-Mbul0w.png"/></div></div><figcaption class="nj nk gj gh gi nl nm bd b be z dk">code to get the list of memes in the page</figcaption></figure><p id="fb40" class="pw-post-body-paragraph kq kr iy kt b ku kv jz kw kx ky kc kz mi lb lc ld mk lf lg lh mm lj lk ll lm ig bi translated">让我们试着更好地理解这个:</p><p id="0040" class="pw-post-body-paragraph kq kr iy kt b ku kv jz kw kx ky kc kz mi lb lc ld mk lf lg lh mm lj lk ll lm ig bi translated">我们声明了一些我们在这个函数中需要的新的选择器。在函数中，首先我们运行'<a class="ae ln" href="https://pptr.dev/#?product=Puppeteer&amp;version=v13.0.1&amp;show=api-pageevaluatepagefunction-args" rel="noopener ugc nofollow" target="_blank"> page.evaluate </a>'。这是一个由puppeteer提供的API，它允许您在页面上下文中运行一个函数，这意味着我们提供的回调不是由Puppeteer在node.js环境中运行的，而是由puppeteer为我们操纵的浏览器执行的。这是获取网页内部信息的唯一方法。为了传递我们在外面定义的选择器，我们需要将它们作为参数添加，它们将作为我们定义的回调的参数注入，所以在我们的例子中<code class="fe na nb nc nd b">MEME_BOX_SELECTOR</code>将变成<code class="fe na nb nc nd b">boxSelector</code>(见这篇<a class="ae ln" href="https://medium.com/@mariorodriguezan/puppeteer-pass-variable-in-evaluate-6eeba76b4153" rel="noopener">小文章</a>)。</p><p id="63d4" class="pw-post-body-paragraph kq kr iy kt b ku kv jz kw kx ky kc kz mi lb lc ld mk lf lg lh mm lj lk ll lm ig bi translated">函数内部的代码非常简单，我们在DOM中查询指定类的所有元素，并为每个元素获取标题(我将所有空格替换为下划线，并将其转换为小写)和来自“href”的imageId，让我们深入了解一下:</p><p id="0f8a" class="pw-post-body-paragraph kq kr iy kt b ku kv jz kw kx ky kc kz mi lb lc ld mk lf lg lh mm lj lk ll lm ig bi translated">Imgflip似乎有一个服务来提供裁剪成不同大小的图像(这是一个给用户最好的体验和减少服务负载的常用方法)，如果我们检查页面中某个图像的URL，我们会得到类似于<code class="fe na nb nc nd b">https://i.imgflip.com/4/1ur9b0.jpg</code>、<a class="ae ln" href="http://i.imgflip.com" rel="noopener ugc nofollow" target="_blank">、</a>是域名、4是裁剪(如果你尝试<code class="fe na nb nc nd b"><a class="ae ln" href="http://i.imgflip.com/2/1ur9b0.jpg" rel="noopener ugc nofollow" target="_blank">https://i.imgflip.com/2/1ur9b0.jpg</a></code>也可以，但它会返回一个不同的图像，一个更小的图像)和<code class="fe na nb nc nd b">1ur9b0</code>的信息，我想这是meme的id。</p><p id="cbf9" class="pw-post-body-paragraph kq kr iy kt b ku kv jz kw kx ky kc kz mi lb lc ld mk lf lg lh mm lj lk ll lm ig bi translated">我们获取Id，并将imageUrl设置为<code class="fe na nb nc nd b">https://i.imgflip.com/&lt;imageId&gt;"</code>(不设置裁剪是，<strong class="kt iz">我想是</strong>，要求全尺寸图像。</p><p id="1c4a" class="pw-post-body-paragraph kq kr iy kt b ku kv jz kw kx ky kc kz mi lb lc ld mk lf lg lh mm lj lk ll lm ig bi translated">然后，我们返回这些对象的列表，其中包含imageUrl、id和经过清理的标题。</p><h1 id="c7d7" class="lo lp iy bd lq lr ls lt lu lv lw lx ly ke lz kf ma kh mb ki mc kk md kl me mf bi translated">结论</h1><p id="8b57" class="pw-post-body-paragraph kq kr iy kt b ku mg jz kw kx mh kc kz mi mj lc ld mk ml lg lh mm mn lk ll lm ig bi translated">请注意，这只是一个脚本，我已经创建了一些基本的刮，它不是什么“生产就绪”或任何你应该依赖的东西。有很多事情可以改进，但我可以用这个下载所有的模因模板(并通过这样做来学习新的东西)和我的朋友们一起玩。</p><p id="35ab" class="pw-post-body-paragraph kq kr iy kt b ku kv jz kw kx ky kc kz mi lb lc ld mk lf lg lh mm lj lk ll lm ig bi translated">你可以在<a class="ae ln" href="https://gist.github.com/albertodeago/cd200a937ac04143f082d53d0639f4b0#file-index-js" rel="noopener ugc nofollow" target="_blank">这个要点</a>中找到整个脚本</p><p id="57a6" class="pw-post-body-paragraph kq kr iy kt b ku kv jz kw kx ky kc kz mi lb lc ld mk lf lg lh mm lj lk ll lm ig bi translated"><em class="ks">更多内容看</em> <a class="ae ln" href="http://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <em class="ks">说白了。报名参加我们的</em> </a><a class="ae ln" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <em class="ks">免费每周简讯</em> </a> <em class="ks">。在我们的</em> <a class="ae ln" href="https://discord.gg/GtDtUAvyhW" rel="noopener ugc nofollow" target="_blank"> <em class="ks">社区</em> </a> <em class="ks">获得独家写作机会和建议。</em></p></div></div>    
</body>
</html>