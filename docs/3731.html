<html>
<head>
<title>Mocking an API request with Mock Service Worker and TypeScript</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用模拟服务工作者和类型脚本模拟API请求</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/mocking-an-api-request-with-mock-service-worker-and-typescript-3a92fee48e11?source=collection_archive---------18-----------------------#2021-07-26">https://javascript.plainenglish.io/mocking-an-api-request-with-mock-service-worker-and-typescript-3a92fee48e11?source=collection_archive---------18-----------------------#2021-07-26</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><figure class="im in gp gr io ip gh gi paragraph-image"><div role="button" tabindex="0" class="iq ir di is bf it"><div class="gh gi il"><img src="../Images/95bc91d4dc0c5b4f8b0f0b340147eb04.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*LKxM3VEHTn4peSwa.png"/></div></div></figure><div class=""/><blockquote class="jv jw jx"><p id="8b46" class="jy jz ka kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">测试软件对于构建应用程序的开发周期至关重要。一个强大的测试套件给开发人员一种自由感，可以根据需要组织和重构代码库，而不用担心不知不觉地破坏了某些东西。</p></blockquote><p id="1b19" class="pw-post-body-paragraph jy jz iy kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">我使用<a class="ae la" href="https://github.com/CodyBontecou/blogflow.io/" rel="noopener ugc nofollow" target="_blank"> Blogflow.io </a>作为学习TypeScript的手段，同时构建一个工具来帮助在整个网络上自动发布博客帖子。</p><p id="345b" class="pw-post-body-paragraph jy jz iy kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">该应用程序的很大一部分需要集成第三方API来与诸如Medium、Hashnode、Reddit等服务进行通信。</p><p id="0889" class="pw-post-body-paragraph jy jz iy kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">很难测试第三方API。我们不想每次运行测试套件时都碰到它们的端点。相反，我们选择模拟响应，假设给定特定的输入，API将输出特定的响应。</p><p id="8c68" class="pw-post-body-paragraph jy jz iy kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated"><a class="ae la" href="https://mswjs.io/" rel="noopener ugc nofollow" target="_blank">模拟服务工作者(MSW) </a>提供了一种简单的方法来拦截这些API调用，这样我们的测试就不会触及第三方端点，也不会与实时数据交互。</p><h2 id="a660" class="lb lc iy bd ld le lf dn lg lh li dp lj kx lk ll lm ky ln lo lp kz lq lr ls lt bi translated">设置和安装</h2><p id="53b7" class="pw-post-body-paragraph jy jz iy kb b kc lu ke kf kg lv ki kj kx lw km kn ky lx kq kr kz ly ku kv kw ig bi translated">我本打算带你去设置MSW，但是他们提供了如此清晰的文档，我认为除了把你和他们联系起来之外，做任何事情都是不公平的。</p><p id="c409" class="pw-post-body-paragraph jy jz iy kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">如果你想看看我是如何在我的项目中与dotenv和TypeScript这样的包一起设置它的，欢迎你来查看我的<a class="ae la" href="https://github.com/CodyBontecou/blogflow.io" rel="noopener ugc nofollow" target="_blank"> repo </a>。</p><h2 id="f9ee" class="lb lc iy bd ld le lf dn lg lh li dp lj kx lk ll lm ky ln lo lp kz lq lr ls lt bi translated">模拟媒体的API</h2><p id="8744" class="pw-post-body-paragraph jy jz iy kb b kc lu ke kf kg lv ki kj kx lw km kn ky lx kq kr kz ly ku kv kw ig bi translated">下面的所有内容都假设您遵循了<a class="ae la" href="#installation" rel="noopener ugc nofollow">设置和安装</a>或者对MSW有所了解。</p><p id="5394" class="pw-post-body-paragraph jy jz iy kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">为了模仿Medium的创建Post请求，我在这里检查了他们的API<a class="ae la" href="https://github.com/Medium/medium-api-docs#32-publications" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="6560" class="pw-post-body-paragraph jy jz iy kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">他们提供了一个示例响应:</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="6b2c" class="lb lc iy me b gy mi mj l mk ml">HTTP/1.1 201 OK<br/>Content-Type: application/json; charset=utf-8<br/><br/>{<br/>  "data": {<br/>    "id": "e6f36a",<br/>    "title": "Liverpool FC",<br/>    "authorId": "5303d74c64f66366f00cb9b2a94f3251bf5",<br/>    "tags": ["football", "sport", "Liverpool"],<br/>    "url": "https://medium.com/@majelbstoat/liverpool-fc-e6f36a",<br/>    "canonicalUrl": "http://jamietalbot.com/posts/liverpool-fc",<br/>    "publishStatus": "public",<br/>    "publishedAt": 1442286338435,<br/>    "license": "all-rights-reserved",<br/>    "licenseUrl": "https://medium.com/policy/9db0094a1e0f"<br/>  }</span></pre><p id="b9bf" class="pw-post-body-paragraph jy jz iy kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">用MSW嘲讽这一点很简单。这几乎是一种复制粘贴:</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="9ee2" class="lb lc iy me b gy mi mj l mk ml">//  src/mocks/handlers.ts<br/><br/>import { rest } from 'msw'<br/><br/>export const handlers = [<br/>1. rest.post('https://api.medium.com/*', (req, res, ctx) =&gt; {<br/>    return res(<br/>2.    ctx.status(201),<br/>3.    ctx.json({<br/>        data: {<br/>          id: 'e6f36a',<br/>          title: 'Liverpool FC',<br/>          authorId: '5303d74c64f66366f00cb9b2a94f3251bf5',<br/>          tags: ['football', 'sport', 'Liverpool'],<br/>          url: 'https://medium.com/@majelbstoat/liverpool-fc-e6f36a',<br/>          canonicalUrl: 'http://jamietalbot.com/posts/liverpool-fc',<br/>          publishStatus: 'public',<br/>          publishedAt: 1442286338435,<br/>          license: 'all-rights-reserved',<br/>          licenseUrl: 'https://medium.com/policy/9db0094a1e0f',<br/>        },<br/>      })<br/>    )<br/>  }),<br/>]</span></pre><ol class=""><li id="6592" class="mm mn iy kb b kc kd kg kh kx mo ky mp kz mq kw mr ms mt mu bi translated">我设置这个处理程序来拦截对任何以<code class="fe mv mw mx me b"><a class="ae la" href="https://api.medium.com/*." rel="noopener">https://api.medium.com/*</a></code> <a class="ae la" href="https://api.medium.com/*." rel="noopener">开头的URL的POST请求。</a></li><li id="3a2c" class="mm mn iy kb b kc my kg mz kx na ky nb kz nc kw mr ms mt mu bi translated"><code class="fe mv mw mx me b">*</code>代表一个通配符，意思是每当我的应用程序试图向一个以https://api.medium.com/,开头的URL发送POST请求时，它都会拦截它并在3返回提供的响应。</li><li id="0e01" class="mm mn iy kb b kc my kg mz kx na ky nb kz nc kw mr ms mt mu bi translated">我们正在设置想要测试的HTTP响应状态代码。</li><li id="9975" class="mm mn iy kb b kc my kg mz kx na ky nb kz nc kw mr ms mt mu bi translated">这是我们定义希望从POST请求返回的JSON响应的地方。</li></ol><h2 id="d98c" class="lb lc iy bd ld le lf dn lg lh li dp lj kx lk ll lm ky ln lo lp kz lq lr ls lt bi translated">边缘案例</h2><p id="09f6" class="pw-post-body-paragraph jy jz iy kb b kc lu ke kf kg lv ki kj kx lw km kn ky lx kq kr kz ly ku kv kw ig bi translated">某些软件包需要额外的配置。这些主要是<a class="ae la" href="https://jestjs.io/" rel="noopener ugc nofollow" target="_blank">笑话</a>问题，而不是MSW，但是我在设置这个的时候遇到了它们。我决定记录下来，以防其他人像我一样遇到这些问题。</p><h2 id="ec37" class="lb lc iy bd ld le lf dn lg lh li dp lj kx lk ll lm ky ln lo lp kz lq lr ls lt bi translated"><a class="ae la" href="https://github.com/motdotla/dotenv" rel="noopener ugc nofollow" target="_blank">宠爱</a></h2><p id="cb6d" class="pw-post-body-paragraph jy jz iy kb b kc lu ke kf kg lv ki kj kx lw km kn ky lx kq kr kz ly ku kv kw ig bi translated">在<code class="fe mv mw mx me b">jest.config.ts</code>文件中，确保您有以下内容:</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="c1d8" class="lb lc iy me b gy mi mj l mk ml">// jest.config.ts<br/>module.exports = {<br/>  setupFiles: ['dotenv/config'],<br/>}</span></pre><h2 id="1f1b" class="lb lc iy bd ld le lf dn lg lh li dp lj kx lk ll lm ky ln lo lp kz lq lr ls lt bi translated"><strong class="ak">设置测试文件</strong></h2><p id="c90b" class="pw-post-body-paragraph jy jz iy kb b kc lu ke kf kg lv ki kj kx lw km kn ky lx kq kr kz ly ku kv kw ig bi translated">您需要设置您的jest测试来侦听、重置和关闭MSW服务器。</p><p id="ee66" class="pw-post-body-paragraph jy jz iy kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">如果您使用Create React App，您可能已经有了一个名为“src/setupTests.js”的文件。</p><p id="1319" class="pw-post-body-paragraph jy jz iy kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">否则，您需要自己创建一个设置文件。</p><p id="3909" class="pw-post-body-paragraph jy jz iy kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">然后，添加以下代码:</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="a082" class="lb lc iy me b gy mi mj l mk ml">// src/setupTests.js</span><span id="63bd" class="lb lc iy me b gy nd mj l mk ml">import { server } from ‘./mocks/server.js’</span><span id="9a5f" class="lb lc iy me b gy nd mj l mk ml">// Establish API mocking before all tests.</span><span id="05d2" class="lb lc iy me b gy nd mj l mk ml">beforeAll(() =&gt; server.listen())</span><span id="b728" class="lb lc iy me b gy nd mj l mk ml">// Reset any request handlers that we may add during the tests,</span><span id="bc67" class="lb lc iy me b gy nd mj l mk ml">// so they don’t affect other tests.</span><span id="3400" class="lb lc iy me b gy nd mj l mk ml">afterEach(() =&gt; server.resetHandlers())</span><span id="aadd" class="lb lc iy me b gy nd mj l mk ml">// Clean up after the tests are finished.</span><span id="a7ae" class="lb lc iy me b gy nd mj l mk ml">afterAll(() =&gt; server.close())</span></pre><p id="bc54" class="pw-post-body-paragraph jy jz iy kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">这将设置您的Jest测试环境，以便在Jest生命周期的不同阶段启动MSW服务器、重置它并关闭它。</p><p id="60c8" class="pw-post-body-paragraph jy jz iy kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">然后，您需要在“jest.config.ts”文件中添加一行:</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="e630" class="lb lc iy me b gy mi mj l mk ml">// jest.config.ts<br/>module.exports = {<br/>    setupFilesAfterEnv: [‘&lt;rootDir&gt;/src/setupTests.ts’],<br/>}</span></pre><p id="1976" class="pw-post-body-paragraph jy jz iy kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">错误:ENOENT:没有这样的文件或目录，打开“文件”</p><p id="88d6" class="pw-post-body-paragraph jy jz iy kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">我正在Blogflow阅读降价文件。在编写测试之前，我使用了如下相对路径:</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="7329" class="lb lc iy me b gy mi mj l mk ml">const data = matter(readFile('./file.md'))</span></pre><p id="c723" class="pw-post-body-paragraph jy jz iy kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">我的测试不喜欢这样，并抛出了错误<code class="fe mv mw mx me b">Error: ENOENT: no such file or directory, open "file"</code></p><p id="b0c6" class="pw-post-body-paragraph jy jz iy kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated"><a class="ae la" href="https://stackoverflow.com/a/59179782/6642089" rel="noopener ugc nofollow" target="_blank">这个</a> Stackoverflow的帖子解释了我需要使用<code class="fe mv mw mx me b">_dirname</code>。这段代码现在看起来像下面的代码片段。现在我的测试和代码如预期运行。</p><pre class="lz ma mb mc gt md me mf mg aw mh bi"><span id="41d0" class="lb lc iy me b gy mi mj l mk ml">const data = matter(readFile(__dirname + '/file.md'))</span></pre><h2 id="718f" class="lb lc iy bd ld le lf dn lg lh li dp lj kx lk ll lm ky ln lo lp kz lq lr ls lt bi translated">结论</h2><p id="3c83" class="pw-post-body-paragraph jy jz iy kb b kc lu ke kf kg lv ki kj kx lw km kn ky lx kq kr kz ly ku kv kw ig bi translated">对我来说，这都是相当新的，但是我相信这种测试是有价值的。</p><p id="0dcc" class="pw-post-body-paragraph jy jz iy kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">一个直接的例子是模拟加载到组件中的响应。很难通过实时数据了解每个州。模拟某些会改变组件呈现方式的HTTP状态代码和响应对象要容易得多。</p></div><div class="ab cl ne nf hr ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="ig ih ii ij ik"><p id="c8e8" class="pw-post-body-paragraph jy jz iy kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated">我希望本文能有所帮助。如果您在推特上有任何问题、评论或建议请告诉我<a class="ae la" href="https://twitter.com/CodyBontecou" rel="noopener ugc nofollow" target="_blank"> @codybontecou </a></p><p id="95ba" class="pw-post-body-paragraph jy jz iy kb b kc kd ke kf kg kh ki kj kx kl km kn ky kp kq kr kz kt ku kv kw ig bi translated"><em class="ka">多内容于</em> <a class="ae la" href="http://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kb iz"> <em class="ka">普通英语中</em> </strong> </a> <strong class="kb iz"> <em class="ka">。</em> </strong> <em class="ka">报名参加我们的</em> <a class="ae la" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="kb iz"> <em class="ka">免费周报在这里</em> </strong> </a> <strong class="kb iz"> <em class="ka">。</em> </strong></p></div></div>    
</body>
</html>