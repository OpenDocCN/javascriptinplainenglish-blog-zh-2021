<html>
<head>
<title>Create Angular Web Application Authentication with Auth0</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Auth0创建角度Web应用程序身份验证</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/create-angular-web-application-authentication-with-auth0-e09e15a06a09?source=collection_archive---------5-----------------------#2021-05-21">https://javascript.plainenglish.io/create-angular-web-application-authentication-with-auth0-e09e15a06a09?source=collection_archive---------5-----------------------#2021-05-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="6207" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用Auth0的角度用户身份验证指南</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/bba3913d3cbb567fc64eaf8e911f7382.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*GSM8yUSFabTMuUHNc9BI-A.gif"/></div></div></figure><h2 id="9952" class="kr ks iq bd kt ku kv dn kw kx ky dp kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">了解如何使用观察器和HTTP拦截器向Angular添加用户身份验证</h2><p id="92b3" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv la lw lx ly le lz ma mb li mc md me mf ij bi translated">本指南的重点是帮助开发人员了解如何通过实现用户身份验证来保护Angular应用程序。您将增强Angular starter应用程序，以练习以下安全概念:</p><ul class=""><li id="c03a" class="mg mh iq lp b lq mi lt mj la mk le ml li mm mf mn mo mp mq bi translated">添加用户登录和注销。</li><li id="40f3" class="mg mh iq lp b lq mr lt ms la mt le mu li mv mf mn mo mp mq bi translated">检索用户配置文件信息。</li><li id="7cf4" class="mg mh iq lp b lq mr lt ms la mt le mu li mv mf mn mo mp mq bi translated">保护应用程序路由。</li><li id="3676" class="mg mh iq lp b lq mr lt ms la mt le mu li mv mf mn mo mp mq bi translated">调用具有受保护端点的API。</li></ul><p id="f1f4" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">本教程使用<a class="ae mz" href="https://github.com/auth0/auth0-angular" rel="noopener ugc nofollow" target="_blank"> Auth0 Angular SDK </a>来保护Angular应用程序。SDK抽象了许多身份验证实现细节，以帮助您使用惯用的Angular方法遵循安全最佳实践，同时编写更少的代码。您不需要成为<a class="ae mz" href="https://auth0.com/docs/protocols/protocol-oauth2" rel="noopener ugc nofollow" target="_blank"> OAuth 2.0 </a>或<a class="ae mz" href="https://auth0.com/docs/protocols/openid-connect-protocol" rel="noopener ugc nofollow" target="_blank"> OpenID Connect </a>的专家，就能了解如何保护您的web应用程序堆栈。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi na"><img src="../Images/9a990d3745d9ffd93050e8f374a15075.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*u7QZEd-eHzbcfOOw.png"/></div></div></figure><h1 id="ccfc" class="nb ks iq bd kt nc nd ne kw nf ng nh kz jw ni jx ld jz nj ka lh kc nk kd ll nl bi translated">获取初学者应用程序</h1><blockquote class="nm nn no"><p id="01bc" class="ln lo np lp b lq mi jr ls lt mj ju lv nq mw lx ly nr mx ma mb ns my md me mf ij bi translated"><em class="iq">如果你想在关注构建步骤的同时浏览内容，寻找🛠️️表情符号。</em></p></blockquote><p id="b6ac" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">Angular已经使用<a class="ae mz" href="https://cli.angular.io/" rel="noopener ugc nofollow" target="_blank"> Angular CLI </a>创建了一个初学者项目，通过动手实践帮助您学习Angular安全概念。启动项目使用自定义的<a class="ae mz" href="https://getbootstrap.com/" rel="noopener ugc nofollow" target="_blank">引导</a>主题来设置应用程序的样式和布局，这样您就可以专注于构建和布线角度组件。</p><p id="ee83" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">因此，🛠在其<code class="fe nt nu nv nw b">starter</code>分支上克隆<code class="fe nt nu nv nw b">auth0-angular-sample</code>存储库以开始:</p><pre class="kg kh ki kj gt nx nw ny nz aw oa bi"><span id="702a" class="kr ks iq nw b gy ob oc l od oe">git clone -b starter git@github.com:auth0-blog/auth0-angular-sample.git</span></pre><p id="4011" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">🛠一旦你克隆了回购，使<code class="fe nt nu nv nw b">auth0-angular-sample</code>成为你当前的目录:</p><pre class="kg kh ki kj gt nx nw ny nz aw oa bi"><span id="281c" class="kr ks iq nw b gy ob oc l od oe">cd auth0-angular-sample</span></pre><p id="6c89" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">🛠着手安装角向项目依赖:</p><pre class="kg kh ki kj gt nx nw ny nz aw oa bi"><span id="44f5" class="kr ks iq nw b gy ob oc l od oe">npm install</span></pre><p id="19c5" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">🛠最后，运行了角度应用程序:</p><pre class="kg kh ki kj gt nx nw ny nz aw oa bi"><span id="a4e5" class="kr ks iq nw b gy ob oc l od oe">npm start</span></pre><h1 id="8b74" class="nb ks iq bd kt nc nd ne kw nf ng nh kz jw ni jx ld jz nj ka lh kc nk kd ll nl bi translated">将Angular与Auth0连接</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/caa47f31b8c7c2a372a5e6a6a065329b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*MqIhpRMY0XehxtgpXhL4yw.gif"/></div></div></figure><p id="10aa" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">为什么要使用Auth0而不是从头开始构建您自己的用户身份验证？</p><p id="ebbf" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">在过去，聪明的人警告说，“你不应该卷你自己的密码”。如今，明智的人建议<a class="ae mz" href="https://auth0.com/resources/webinars/build-or-buy-a-customer-identity-platform" rel="noopener ugc nofollow" target="_blank">“您不需要构建自己的身份验证”</a>。</p><p id="1a83" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">从头开始构建一个全面的身份验证和授权系统非常复杂。Auth0是一个<a class="ae mz" href="https://auth0.com/blog/what-is-idaas/" rel="noopener ugc nofollow" target="_blank">身份即服务(IDaaS) </a>平台，它允许您集中所有应用程序的用户身份验证和API授权，以降低复杂性。</p><p id="bf0c" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">Auth0提供开箱即用的强大安全功能。可定制的登录页面、社交登录、<a class="ae mz" href="https://auth0.com/learn/get-started-with-mfa/" rel="noopener ugc nofollow" target="_blank">、多因素身份认证(MFA) </a>和高级用户管理让您能够在创纪录的时间内上线。也许最重要的功能是<a class="ae mz" href="https://auth0.com/resources/videos/anomaly-detection-video" rel="noopener ugc nofollow" target="_blank">异常检测</a>，它可以帮助你对抗凭证攻击。</p><blockquote class="nm nn no"><p id="067b" class="ln lo np lp b lq mi jr ls lt mj ju lv nq mw lx ly nr mx ma mb ns my md me mf ij bi translated"><em class="iq">在Auth0，凭据填充攻击平均占使用我们平台的所有登录尝试的近一半。阅读更多关于这种关键攻击载体的详细信息:</em> <a class="ae mz" href="https://auth0.com/resources/whitepapers/credential-stuffing-attacks" rel="noopener ugc nofollow" target="_blank"> <em class="iq">凭据填充攻击:它们是什么以及如何打击它们</em> </a> <em class="iq">。</em></p></blockquote><p id="54ca" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">Auth0是如何工作的？</p><ul class=""><li id="71bc" class="mg mh iq lp b lq mi lt mj la mk le ml li mm mf mn mo mp mq bi translated">首先将Auth0与Angular应用程序集成在一起。</li><li id="c884" class="mg mh iq lp b lq mr lt ms la mt le mu li mv mf mn mo mp mq bi translated">当您的用户需要登录时，您的Angular应用程序触发一个身份验证事件，它通过将用户重定向到一个可定制的Auth0登录页面来处理该事件。</li><li id="1a97" class="mg mh iq lp b lq mr lt ms la mt le mu li mv mf mn mo mp mq bi translated">一旦您的用户成功登录，Auth0会将他们重定向回您的Angular应用程序，返回带有他们的身份验证和用户信息的令牌。</li><li id="4de3" class="mg mh iq lp b lq mr lt ms la mt le mu li mv mf mn mo mp mq bi translated">此外，您可以用Auth0 保护您的API，这样您就可以使用访问令牌从您的Angular应用程序向您的受保护API端点发出请求。</li></ul><p id="7c01" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">入门有多容易？</p><p id="ca80" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">非常容易！只需遵循以下步骤:</p><h1 id="1b00" class="nb ks iq bd kt nc nd ne kw nf ng nh kz jw ni jx ld jz nj ka lh kc nk kd ll nl bi translated">配置Auth0应用程序</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/e3c95aa2c36b10b4cd86992b61680398.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*MsnyiYDeQFL75UvTZFOURA.gif"/></div></div></figure><p id="285e" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">🛠如果你还没有，<a class="ae mz" href="https://auth0.com/signup" rel="noopener ugc nofollow" target="_blank">注册一个免费的Auth0帐户</a>，它可以为你提供:</p><ul class=""><li id="5044" class="mg mh iq lp b lq mi lt mj la mk le ml li mm mf mn mo mp mq bi translated">7000个<a class="ae mz" href="https://auth0.com/pricing/" rel="noopener ugc nofollow" target="_blank">免费活跃用户和无限登录</a>。</li><li id="f1e6" class="mg mh iq lp b lq mr lt ms la mt le mu li mv mf mn mo mp mq bi translated">一个集中的、现成的网页登录页面, iOS&amp;Android。</li><li id="3e1f" class="mg mh iq lp b lq mr lt ms la mt le mu li mv mf mn mo mp mq bi translated">多达2个<a class="ae mz" href="https://auth0.com/docs/connections/identity-providers-social" rel="noopener ugc nofollow" target="_blank">社交身份提供商</a>如谷歌和脸书登录。</li><li id="03dc" class="mg mh iq lp b lq mr lt ms la mt le mu li mv mf mn mo mp mq bi translated">无限制的<a class="ae mz" href="https://auth0.com/docs/rules/current" rel="noopener ugc nofollow" target="_blank">无服务器规则</a>来定制和扩展Auth0的功能。</li></ul><p id="b594" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">在注册过程中，您创建了一个名为<a class="ae mz" href="https://auth0.com/docs/getting-started/the-basics#account-and-tenants" rel="noopener ugc nofollow" target="_blank"> Auth0租户</a>的东西，Auth0使用这个容器来隔离存储您的身份服务配置和您的用户。其他Auth0客户无法窥视或访问您的租户。</p><p id="81d5" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">🛠一旦你登录，Auth0会带你到<a class="ae mz" href="https://manage.auth0.com/" rel="noopener ugc nofollow" target="_blank">仪表盘</a>，在那里你可以管理和配置你的身份服务。在左侧边栏菜单中，点击<a class="ae mz" href="https://manage.auth0.com/#/applications" rel="noopener ugc nofollow" target="_blank">“应用”</a>。</p><p id="08cf" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">🛠然后，点击“创建应用程序”按钮。模式打开时会显示一个表单，为应用程序提供一个名称并选择其类型。</p><ul class=""><li id="e7f8" class="mg mh iq lp b lq mi lt mj la mk le ml li mm mf mn mo mp mq bi translated">名称:</li></ul><pre class="kg kh ki kj gt nx nw ny nz aw oa bi"><span id="0a13" class="kr ks iq nw b gy ob oc l od oe">Auth0 Angular Sample</span></pre><ul class=""><li id="1ac5" class="mg mh iq lp b lq mi lt mj la mk le ml li mm mf mn mo mp mq bi translated">应用程序类型:</li></ul><pre class="kg kh ki kj gt nx nw ny nz aw oa bi"><span id="0322" class="kr ks iq nw b gy ob oc l od oe">Single Page Web Applications</span></pre><p id="ce46" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">🛠点击“创建”按钮完成该过程。您的Auth0应用程序页面将加载。</p><p id="abc2" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">在下一步中，您将学习如何使用该页面中的配置数据来帮助Angular和Auth0进行通信——先不要关闭它。</p><p id="6cdf" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">Auth0租户和Auth0应用是什么关系？</p><h1 id="23d6" class="nb ks iq bd kt nc nd ne kw nf ng nh kz jw ni jx ld jz nj ka lh kc nk kd ll nl bi translated">在Angular和Auth0之间建立沟通桥梁</h1><p id="c59f" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv la lw lx ly le lz ma mb li mc md me mf ij bi translated">当您使用Auth0时，没有必要构建登录表单。Auth0提供了一个<a class="ae mz" href="https://auth0.com/docs/hosted-pages/login" rel="noopener ugc nofollow" target="_blank">通用登录</a>页面来减少添加和管理认证的开销。</p><p id="72b1" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">需要强调的是，Auth0提供的表单(Auth0通用登录)降低了用户名和密码枚举的风险。Auth0通用登录正确实现认证错误消息<a class="ae mz" href="https://cheatsheetseries.owasp.org/cheatsheets/Authentication_Cheat_Sheet.html#authentication-and-error-messages" rel="noopener ugc nofollow" target="_blank">遵循OWASP(开放Web应用安全项目)</a>的建议:说足够帮助正在登录的用户但不要说太多帮助试图闯入的攻击者。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi of"><img src="../Images/c38459060567a6f8fc1de4b43d73b95f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*KpPguJovw8EaFnLF.png"/></div></div></figure><p id="a4da" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated"><a class="ae mz" href="https://auth0.com/docs/hosted-pages/login#how-does-universal-login-work" rel="noopener ugc nofollow" target="_blank">通用登录如何工作</a>？</p><p id="0910" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">每当用户触发身份验证请求时，您的Angular应用程序都会将用户重定向到Auth0。Auth0将向他们展示通用登录页面。一旦他们登录，Auth0会将他们重定向到您的应用程序。为了安全地进行重定向，您必须在Auth0应用程序设置中指定在Auth0对用户进行身份验证后，auth 0可以将用户重定向到的URL。</p><p id="67d0" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">观看关于Auth0通用登录如何工作的视频。</p><p id="2849" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">🛠同样，点击你的Auth0应用程序页面的“设置”选项卡，并填写以下值:</p><p id="d4c9" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">🛠允许的回拨URL</p><pre class="kg kh ki kj gt nx nw ny nz aw oa bi"><span id="0d09" class="kr ks iq nw b gy ob oc l od oe"><a class="ae mz" href="http://localhost:4040" rel="noopener ugc nofollow" target="_blank">http://localhost:4040</a></span></pre><p id="bd8a" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">在您的用户成功登录后，Auth0只能将他们重定向到您在此列出的任何URL。</p><p id="06c2" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">🛠允许的注销URL</p><pre class="kg kh ki kj gt nx nw ny nz aw oa bi"><span id="eff3" class="kr ks iq nw b gy ob oc l od oe"><a class="ae mz" href="http://localhost:4040" rel="noopener ugc nofollow" target="_blank">http://localhost:4040</a></span></pre><p id="0247" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">在您的用户注销后，Auth0只能将他们重定向到您在此列出的任何URL。</p><p id="cbe0" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">🛠允许网络起源</p><pre class="kg kh ki kj gt nx nw ny nz aw oa bi"><span id="b49d" class="kr ks iq nw b gy ob oc l od oe"><a class="ae mz" href="http://localhost:4040" rel="noopener ugc nofollow" target="_blank">http://localhost:4040</a></span></pre><p id="03aa" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">使用Auth0 Angular SDK，您的Angular应用程序将向Auth0 URL发出请求，以处理身份验证请求。因此，您需要添加您的Angular应用程序<a class="ae mz" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Origin" rel="noopener ugc nofollow" target="_blank">源URL </a>，以避免<a class="ae mz" href="https://auth0.com/blog/cors-tutorial-a-guide-to-cross-origin-resource-sharing/" rel="noopener ugc nofollow" target="_blank">跨源资源共享(CORS) </a>问题。</p><p id="e564" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">🛠向下滚动并点击“保存更改”按钮。</p><p id="4ea7" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">🛠:先不要关闭这一页，因为在下一节中你会需要它的一些信息。</p><h1 id="e8c0" class="nb ks iq bd kt nc nd ne kw nf ng nh kz jw ni jx ld jz nj ka lh kc nk kd ll nl bi translated">将Auth0配置变量添加到Angular</h1><p id="cd17" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv la lw lx ly le lz ma mb li mc md me mf ij bi translated">在Auth0应用程序设置页面中，您需要Auth0域和客户端ID值，以允许您的Angular应用程序使用您刚刚创建的通信桥:</p><p id="1a21" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">什么是Auth0域和Auth0客户端ID？</p><p id="4cdd" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">🛠打开Angular starter项目<code class="fe nt nu nv nw b">auth0-angular-sample</code>，在项目目录下创建一个<code class="fe nt nu nv nw b">auth_config.json</code>文件:</p><ul class=""><li id="9893" class="mg mh iq lp b lq mi lt mj la mk le ml li mm mf mn mo mp mq bi translated">macOS/Linux:</li></ul><pre class="kg kh ki kj gt nx nw ny nz aw oa bi"><span id="601f" class="kr ks iq nw b gy ob oc l od oe">touch auth_config.json</span></pre><ul class=""><li id="5c0c" class="mg mh iq lp b lq mi lt mj la mk le ml li mm mf mn mo mp mq bi translated">Windows Powershell:</li></ul><pre class="kg kh ki kj gt nx nw ny nz aw oa bi"><span id="3bc3" class="kr ks iq nw b gy ob oc l od oe">ni auth_config.json</span></pre><p id="b579" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">🛠填充<code class="fe nt nu nv nw b">auth_config.json</code>如下:</p><pre class="kg kh ki kj gt nx nw ny nz aw oa bi"><span id="3808" class="kr ks iq nw b gy ob oc l od oe">{<br/>  "domain": "YOUR_AUTH0_DOMAIN",<br/>  "clientId": "YOUR_AUTH0_CLIENT_ID"<br/>}</span></pre><p id="b151" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">🛠<code class="fe nt nu nv nw b">domain</code>的值是来自“设置”的“域”值。</p><p id="7edc" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">🛠<code class="fe nt nu nv nw b">clientId</code>的值是来自“设置”的“客户端ID”值。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi og"><img src="../Images/274700f7a70b8d5dc32b952c5c1c2fb7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ENt87viREPdLKxtU.png"/></div></div></figure><p id="f7ea" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">这些变量让您的Angular应用程序将自己标识为授权方，以便与Auth0身份验证服务器交互来执行身份验证过程。您正在将Angular应用程序映射到Auth0应用程序。</p><p id="afdb" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">为了在您的角度应用中使用这些变量，您将利用角度<code class="fe nt nu nv nw b">environment</code>模块。</p><p id="10b7" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">🛠将<code class="fe nt nu nv nw b">src/environments/environment.ts</code>的内容替换为以下内容:</p><pre class="kg kh ki kj gt nx nw ny nz aw oa bi"><span id="2237" class="kr ks iq nw b gy ob oc l od oe">// src/environments/environment.ts</span><span id="e974" class="kr ks iq nw b gy oh oc l od oe">import { domain, clientId } from '../../auth_config.json';</span><span id="9af4" class="kr ks iq nw b gy oh oc l od oe">export const environment = {<br/>  production: false,<br/>  auth: {<br/>    domain,<br/>    clientId,<br/>    redirectUri: window.location.origin,<br/>  },<br/>};</span></pre><p id="b153" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">如何在Angular模块中导入JSON文件？starter项目有一个<code class="fe nt nu nv nw b">tsconfig.base.json</code>文件，它将<code class="fe nt nu nv nw b">resolveJsonModule</code>设置为<code class="fe nt nu nv nw b">true</code>，这允许您从<code class="fe nt nu nv nw b">.json</code>文件中导入和提取类型。</p><h1 id="cf62" class="nb ks iq bd kt nc nd ne kw nf ng nh kz jw ni jx ld jz nj ka lh kc nk kd ll nl bi translated">Auth0和角度连接集</h1><p id="e8fb" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv la lw lx ly le lz ma mb li mc md me mf ij bi translated">您已经完成了您的Angular应用程序可以使用的身份验证服务的设置。剩下的工作就是在本教程中通过添加安全组件和特性来继续构建starter项目。</p><p id="55c4" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">请随意深入阅读<a class="ae mz" href="https://auth0.com/docs/getting-started" rel="noopener ugc nofollow" target="_blank"> Auth0文档</a>，了解更多关于Auth0如何帮助您节省实现和管理身份的时间。</p><h1 id="b489" class="nb ks iq bd kt nc nd ne kw nf ng nh kz jw ni jx ld jz nj ka lh kc nk kd ll nl bi translated">设置Auth0 Angular SDK</h1><p id="cafc" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv la lw lx ly le lz ma mb li mc md me mf ij bi translated">🛠你需要按照这些步骤将Auth0 Angular SDK与你的Angular应用程序集成。</p><h1 id="1ee4" class="nb ks iq bd kt nc nd ne kw nf ng nh kz jw ni jx ld jz nj ka lh kc nk kd ll nl bi translated">安装Auth0 Angular SDK</h1><p id="2d8a" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv la lw lx ly le lz ma mb li mc md me mf ij bi translated">🛠执行以下命令:</p><pre class="kg kh ki kj gt nx nw ny nz aw oa bi"><span id="7c91" class="kr ks iq nw b gy ob oc l od oe">ng add @auth0/auth0-angular</span></pre><p id="3a61" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">Auth0 Angular SDK公开了几个方法、变量和类型，帮助您将Auth0与Angular应用程序结合起来，包括一个身份验证模块和服务。</p><h1 id="a8c2" class="nb ks iq bd kt nc nd ne kw nf ng nh kz jw ni jx ld jz nj ka lh kc nk kd ll nl bi translated">注册并配置身份验证模块</h1><p id="79ff" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv la lw lx ly le lz ma mb li mc md me mf ij bi translated">SDK导出一个模块，其中包含执行用户身份验证所需的组件和服务。将该模块导入到<code class="fe nt nu nv nw b">AppModule</code>中，通过<a class="ae mz" href="https://angular.io/guide/dependency-injection" rel="noopener ugc nofollow" target="_blank"> Angular的依赖注入框架</a>进行访问。</p><p id="3280" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">🛠导入<code class="fe nt nu nv nw b">src/app/app.module.ts</code>中<code class="fe nt nu nv nw b">@NgModule</code>定义正上方的<code class="fe nt nu nv nw b">AuthModule</code>和<code class="fe nt nu nv nw b">environment</code>如下:</p><pre class="kg kh ki kj gt nx nw ny nz aw oa bi"><span id="3e33" class="kr ks iq nw b gy ob oc l od oe">// src/app/app.module.ts</span><span id="5982" class="kr ks iq nw b gy oh oc l od oe">// Other imports...</span><span id="333c" class="kr ks iq nw b gy oh oc l od oe">import { AuthModule } from '@auth0/auth0-angular';<br/>import { environment as env } from '../environments/environment';</span><span id="061f" class="kr ks iq nw b gy oh oc l od oe">@NgModule({...})<br/>export class AppModule {}</span></pre><p id="486c" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">🛠然后，将<code class="fe nt nu nv nw b">AuthModule</code>添加到<code class="fe nt nu nv nw b">AppModule</code>导入并初始化它:</p><pre class="kg kh ki kj gt nx nw ny nz aw oa bi"><span id="a114" class="kr ks iq nw b gy ob oc l od oe">// src/app/app.module.ts</span><span id="ca3c" class="kr ks iq nw b gy oh oc l od oe">// All imports...</span><span id="e659" class="kr ks iq nw b gy oh oc l od oe">@NgModule({<br/>  declarations: [...],<br/>  imports: [<br/>    BrowserModule,<br/>    AppRoutingModule,<br/>    HttpClientModule,<br/>    FontAwesomeModule,<br/>    // 👇 add and initialize AuthModule<br/>    AuthModule.forRoot({<br/>      ...env.auth,<br/>    }),<br/>  ],<br/>  bootstrap: [...],<br/>})<br/>export class AppModule {}</span></pre><p id="dec5" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">您使用<code class="fe nt nu nv nw b"><a class="ae mz" href="https://angular.io/guide/singleton-services#the-forroot-pattern" rel="noopener ugc nofollow" target="_blank">forRoot()</a></code> <a class="ae mz" href="https://angular.io/guide/singleton-services#the-forroot-pattern" rel="noopener ugc nofollow" target="_blank">模式</a>来配置<code class="fe nt nu nv nw b">AuthModule</code>，它接受一个具有<code class="fe nt nu nv nw b">domain</code>和<code class="fe nt nu nv nw b">clientId</code>属性的对象。您通过展开<code class="fe nt nu nv nw b">env.auth</code>对象来创建配置对象。</p><p id="9836" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">用户身份验证是一种机制，用于监控谁在访问您的应用程序并控制他们可以做什么。例如，您可以阻止尚未登录的用户访问您的应用程序的某些部分。在这种情况下，Auth0可以充当您的<em class="np">应用程序保镖</em>。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oi"><img src="../Images/8aa90f1cd2629645db6293a7589ea873.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*kosayv1bpJi47oJC"/></div></div><figcaption class="oj ok gj gh gi ol om bd b be z dk">Photo by <a class="ae mz" href="https://unsplash.com/@liskozac?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Zachary Lisko</a> on <a class="ae mz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><blockquote class="nm nn no"><p id="148a" class="ln lo np lp b lq mi jr ls lt mj ju lv nq mw lx ly nr mx ma mb ns my md me mf ij bi translated"><em class="iq">保镖</em> <a class="ae mz" href="https://www.lexico.com/en/definition/bouncer" rel="noopener ugc nofollow" target="_blank"> <em class="iq">保镖</em> </a> <em class="iq">是受雇于夜总会或类似机构的人，他们的任务是阻止闹事者进入或把他们驱逐出去。棱角分明的保安和夜店保安没有太大区别。</em></p></blockquote><p id="0ee3" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">如果用户想从您的应用程序输入一个受保护的路由，Auth0会阻止他们，并要求他们出示凭据。如果Auth0可以验证他们是谁以及他们应该进入那里，Auth0就会让他们进入。否则，Auth0会将它们带回公共应用程序路径。</p><p id="6382" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">现在，重要的是重申身份验证过程不会发生在您的应用程序层中。您的Angular应用程序会将您的用户重定向到<a class="ae mz" href="https://auth0.com/docs/universal-login" rel="noopener ugc nofollow" target="_blank"> Auth0通用登录</a>页面，在这里Auth0会询问凭证，并将用户重定向回您的应用程序，并显示认证过程的结果。</p><p id="98ac" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">Auth0 Angular SDK已全部设置完毕。您已经准备好创建组件来实现下一节中的身份验证流。</p><h1 id="0859" class="nb ks iq bd kt nc nd ne kw nf ng nh kz jw ni jx ld jz nj ka lh kc nk kd ll nl bi translated">添加用户验证</h1><p id="f835" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv la lw lx ly le lz ma mb li mc md me mf ij bi translated">Auth0 Angular SDK为您提供了在Angular组件中触发身份验证事件的方法:登录、注销和注册。</p><h1 id="378c" class="nb ks iq bd kt nc nd ne kw nf ng nh kz jw ni jx ld jz nj ka lh kc nk kd ll nl bi translated">创建登录按钮</h1><p id="9cfb" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv la lw lx ly le lz ma mb li mc md me mf ij bi translated">🛠使用Angular CLI在<code class="fe nt nu nv nw b">src/components/</code>目录下创建一个<code class="fe nt nu nv nw b">LoginButtonComponent</code>:</p><pre class="kg kh ki kj gt nx nw ny nz aw oa bi"><span id="864a" class="kr ks iq nw b gy ob oc l od oe">ng generate component components/login-button --inlineStyle --skipTests</span></pre><p id="9f23" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">🛠将<code class="fe nt nu nv nw b">login-button.component.ts</code>文件填充到<code class="fe nt nu nv nw b">src/app/components/login-button/</code>目录中，如下所示:</p><pre class="kg kh ki kj gt nx nw ny nz aw oa bi"><span id="dda4" class="kr ks iq nw b gy ob oc l od oe">// src/app/components/login-button/login-button.component.ts</span><span id="3b21" class="kr ks iq nw b gy oh oc l od oe">import { Component, OnInit } from '@angular/core';<br/>import { AuthService } from '@auth0/auth0-angular';</span><span id="7b1e" class="kr ks iq nw b gy oh oc l od oe">@Component({<br/>  selector: 'app-login-button',<br/>  templateUrl: './login-button.component.html',<br/>  styles: [],<br/>})<br/>export class LoginButtonComponent implements OnInit {<br/>  constructor(public auth: AuthService) {}</span><span id="5f7f" class="kr ks iq nw b gy oh oc l od oe">ngOnInit(): void {}</span><span id="59bf" class="kr ks iq nw b gy oh oc l od oe">loginWithRedirect(): void {<br/>    this.auth.loginWithRedirect();<br/>  }<br/>}</span></pre><p id="d832" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">🛠接下来，像这样填充<code class="fe nt nu nv nw b">src/app/components/login-button/</code>目录中的<code class="fe nt nu nv nw b">login-button.component.html</code>模板文件:</p><pre class="kg kh ki kj gt nx nw ny nz aw oa bi"><span id="18ff" class="kr ks iq nw b gy ob oc l od oe">&lt;!-- src/app/components/login-button/login-button.component.html --&gt;</span><span id="4d1a" class="kr ks iq nw b gy oh oc l od oe">&lt;button class="btn btn-primary btn-block" (click)="loginWithRedirect()"&gt;<br/>  Log in<br/>&lt;/button&gt;</span></pre><p id="79c2" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">在<code class="fe nt nu nv nw b">LoginButtonComponent</code>定义中，<code class="fe nt nu nv nw b"><a class="ae mz" href="https://auth0.github.io/auth0-angular/classes/authservice.html#loginwithredirect" rel="noopener ugc nofollow" target="_blank">auth.loginWithRedirect()</a></code>是由<code class="fe nt nu nv nw b">AuthService</code>公开的方法。该方法提示用户进行身份验证并确认同意，这意味着授权您的Angular应用程序代表用户访问某些数据。在您当前的上下文中，这意味着您的Angular应用程序将用户重定向到Auth0通用登录页面来执行身份验证过程。在接下来的部分中，您将看到这一点。</p><p id="fab7" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">您可以通过将一个配置对象作为参数传递给<code class="fe nt nu nv nw b">loginWithRedirect()</code>来定制登录体验。例如，您可以向<code class="fe nt nu nv nw b">loginWithRedirect()</code>传递选项，将用户重定向到一个Auth0通用登录页面，该页面为注册Angular应用程序而优化。有关这些选项的更多详情，请参见<code class="fe nt nu nv nw b"><a class="ae mz" href="https://auth0.github.io/auth0-login/interfaces/redirectloginoptions.html" rel="noopener ugc nofollow" target="_blank">RedirectLoginOptions</a></code>。</p><h1 id="2278" class="nb ks iq bd kt nc nd ne kw nf ng nh kz jw ni jx ld jz nj ka lh kc nk kd ll nl bi translated">创建注册按钮</h1><p id="5618" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv la lw lx ly le lz ma mb li mc md me mf ij bi translated">通过在<code class="fe nt nu nv nw b">auth.loginWithRedirect()</code>的配置对象中添加<code class="fe nt nu nv nw b">screen_hint</code>属性，可以让用户<a class="ae mz" href="https://auth0.com/docs/universal-login/new#signup" rel="noopener ugc nofollow" target="_blank">直接登陆注册页面</a>而不是登录页面:</p><pre class="kg kh ki kj gt nx nw ny nz aw oa bi"><span id="4dd6" class="kr ks iq nw b gy ob oc l od oe">{<br/>  screen_hint: "signup",<br/>}</span></pre><p id="ec1b" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">🛠使用Angular CLI在<code class="fe nt nu nv nw b">src/components/</code>目录下创建一个<code class="fe nt nu nv nw b">SignupButtonComponent</code>:</p><pre class="kg kh ki kj gt nx nw ny nz aw oa bi"><span id="d6b0" class="kr ks iq nw b gy ob oc l od oe">ng generate component components/signup-button --inlineStyle --skipTests</span></pre><p id="5a42" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">🛠将<code class="fe nt nu nv nw b">signup-button.component.ts</code>文件填充到<code class="fe nt nu nv nw b">src/app/components/signup-button/</code>中，如下所示:</p><pre class="kg kh ki kj gt nx nw ny nz aw oa bi"><span id="6eb5" class="kr ks iq nw b gy ob oc l od oe">// src/app/components/signup-button/signup-button.component.ts</span><span id="af44" class="kr ks iq nw b gy oh oc l od oe">import { Component, OnInit } from '@angular/core';</span><span id="40a1" class="kr ks iq nw b gy oh oc l od oe">import { AuthService } from '@auth0/auth0-angular';</span><span id="86f2" class="kr ks iq nw b gy oh oc l od oe">@Component({<br/>  selector: 'app-signup-button',<br/>  templateUrl: './signup-button.component.html',<br/>})<br/>export class SignupButtonComponent implements OnInit {<br/>  constructor(public auth: AuthService) {}</span><span id="7417" class="kr ks iq nw b gy oh oc l od oe">ngOnInit(): void {}</span><span id="2b52" class="kr ks iq nw b gy oh oc l od oe">loginWithRedirect(): void {<br/>    this.auth.loginWithRedirect({ screen_hint: 'signup' });<br/>  }<br/>}</span></pre><p id="39c6" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">🛠在<code class="fe nt nu nv nw b">src/app/components/signup-button/</code>中填充<code class="fe nt nu nv nw b">signup-button.component.html</code>模板文件，如下所示:</p><pre class="kg kh ki kj gt nx nw ny nz aw oa bi"><span id="88a9" class="kr ks iq nw b gy ob oc l od oe">&lt;button class="btn btn-primary btn-block" (click)="loginWithRedirect()"&gt;<br/>  Sign Up<br/>&lt;/button&gt;</span></pre><p id="bce0" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">注册功能要求您在租户中启用<a class="ae mz" href="https://auth0.com/docs/universal-login/new" rel="noopener ugc nofollow" target="_blank"> Auth0新通用登录体验</a>。</p><p id="7477" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">🛠打开Auth0仪表板的<a class="ae mz" href="https://manage.auth0.com/#/login_settings" rel="noopener ugc nofollow" target="_blank">通用登录部分</a>，选择“体验”子部分下的“新建”选项。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi on"><img src="../Images/5c95c966e78a498abbd1d3c9c8b781a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*On8WHeRT0HrjiMrG.png"/></div></div></figure><p id="cbb9" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">🛠向下滚动并点击“保存更改”按钮。</p><p id="f4b3" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">一旦您将这些组件集成到您的Angular应用程序中，并看到它们的运行，那么<code class="fe nt nu nv nw b">LoginButtonComponent</code>和<code class="fe nt nu nv nw b">SignupButtonComponent</code>用户体验之间的差异将会更加明显。您将在接下来的部分中做到这一点。</p><h1 id="cd92" class="nb ks iq bd kt nc nd ne kw nf ng nh kz jw ni jx ld jz nj ka lh kc nk kd ll nl bi translated">创建注销按钮</h1><p id="b0eb" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv la lw lx ly le lz ma mb li mc md me mf ij bi translated">🛠在<code class="fe nt nu nv nw b">src/components/</code>目录下创建一个<code class="fe nt nu nv nw b">LogoutButtonComponent</code>如下:</p><pre class="kg kh ki kj gt nx nw ny nz aw oa bi"><span id="f41f" class="kr ks iq nw b gy ob oc l od oe">ng generate component components/logout-button --inlineStyle --skipTests</span></pre><p id="5700" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">🛠用以下代码填充<code class="fe nt nu nv nw b">src/app/components/logout-button/</code>中的<code class="fe nt nu nv nw b">logout-button.component.ts</code>文件:</p><pre class="kg kh ki kj gt nx nw ny nz aw oa bi"><span id="392c" class="kr ks iq nw b gy ob oc l od oe">// src/app/components/logout-button/logout-button.component.ts</span><span id="d616" class="kr ks iq nw b gy oh oc l od oe">import { Component, Inject, OnInit } from '@angular/core';<br/>import { AuthService } from '@auth0/auth0-angular';<br/>import { DOCUMENT } from '@angular/common';</span><span id="bfa8" class="kr ks iq nw b gy oh oc l od oe">@Component({<br/>  selector: 'app-logout-button',<br/>  templateUrl: './logout-button.component.html',<br/>  styles: [],<br/>})<br/>export class LogoutButtonComponent implements OnInit {<br/>  constructor(<br/>    public auth: AuthService,<br/>    @Inject(DOCUMENT) private doc: Document<br/>  ) {}</span><span id="19e3" class="kr ks iq nw b gy oh oc l od oe">ngOnInit(): void {}</span><span id="86af" class="kr ks iq nw b gy oh oc l od oe">logout(): void {<br/>    this.auth.logout({ returnTo: this.doc.location.origin });<br/>  }<br/>}</span></pre><p id="9743" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">您正在定义一个触发注销事件的<code class="fe nt nu nv nw b">logout()</code>方法。您向它传递一个可选的配置对象，告诉Auth0在注销用户后将他们带到哪里。</p><p id="bec2" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">🛠接下来，在<code class="fe nt nu nv nw b">src/app/components/logout-button/</code>目录中填充<code class="fe nt nu nv nw b">logout-button.component.html</code>模板文件，如下所示:</p><pre class="kg kh ki kj gt nx nw ny nz aw oa bi"><span id="5b0d" class="kr ks iq nw b gy ob oc l od oe">&lt;!--src/app/components/logout-button/logout-button.component.html--&gt;</span><span id="c846" class="kr ks iq nw b gy oh oc l od oe">&lt;button class="btn btn-danger btn-block" (click)="logout()"&gt;<br/>  Log out<br/>&lt;/button&gt;</span></pre><p id="f32a" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">由<code class="fe nt nu nv nw b">AuthService</code>公开的<code class="fe nt nu nv nw b">auth.logout()</code>方法清除应用程序会话，并重定向到Auth0 <code class="fe nt nu nv nw b">/v2/logout</code>端点以清除Auth0会话。与登录方法一样，您可以向<code class="fe nt nu nv nw b">logout()</code>传递一个配置对象来定义<code class="fe nt nu nv nw b">/v2/logout</code>调用的参数。这个过程对用户来说是相当不可见的。更多详情见<code class="fe nt nu nv nw b"><a class="ae mz" href="https://auth0.github.io/auth0-spa-js/interfaces/logoutoptions.html" rel="noopener ugc nofollow" target="_blank">LogoutOptions</a></code>。</p><p id="1e67" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">这里，您将<code class="fe nt nu nv nw b">returnTo</code>属性添加到配置对象中，以指定用户注销后Auth0应该重定向到的URL。现在，您正在本地工作，您的Auth0应用程序的“允许的注销URL”指向<code class="fe nt nu nv nw b"><a class="ae mz" href="http://localhost:4040." rel="noopener ugc nofollow" target="_blank">http://localhost:4040</a></code> <a class="ae mz" href="http://localhost:4040." rel="noopener ugc nofollow" target="_blank">。</a></p><p id="cc3a" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">然而，如果您要将您的Angular应用程序部署到生产中，您需要将生产注销URL添加到“允许的注销URL”列表中，并确保Auth0将您的用户重定向到该生产URL，而不是<code class="fe nt nu nv nw b">localhost</code>。将<code class="fe nt nu nv nw b">returnTo</code>设置为<code class="fe nt nu nv nw b">this.doc.location.origin</code>将会做到这一点。</p><p id="253d" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">角度组件不能直接访问<code class="fe nt nu nv nw b">document</code>对象。但是，您可以将<code class="fe nt nu nv nw b">@Inject</code>常量作为<code class="fe nt nu nv nw b">AuthenticationButtonComponent</code>的依赖项。<code class="fe nt nu nv nw b">this.doc</code>与浏览器中的<a class="ae mz" href="https://developer.mozilla.org/en-US/docs/Web/API/Document" rel="noopener ugc nofollow" target="_blank"> DOM文档</a>相同。<code class="fe nt nu nv nw b">this.doc.location</code>返回一个<code class="fe nt nu nv nw b"><a class="ae mz" href="https://developer.mozilla.org/en-US/docs/Web/API/Location" rel="noopener ugc nofollow" target="_blank">Location</a></code>对象，其<code class="fe nt nu nv nw b"><a class="ae mz" href="https://developer.mozilla.org/en-US/docs/Web/API/Location/origin" rel="noopener ugc nofollow" target="_blank">origin</a></code>属性是应用程序的来源。</p><h1 id="0c16" class="nb ks iq bd kt nc nd ne kw nf ng nh kz jw ni jx ld jz nj ka lh kc nk kd ll nl bi translated">集成登录和注销按钮</h1><p id="55bb" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv la lw lx ly le lz ma mb li mc md me mf ij bi translated">让我们将<code class="fe nt nu nv nw b">LoginButtonComponent</code>和<code class="fe nt nu nv nw b">LogoutButtonComponent</code>封装在一个组件中，该组件具有根据用户的身份验证状态决定呈现哪个按钮的逻辑。</p><p id="f334" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">🛠在<code class="fe nt nu nv nw b">src/app/components/</code>目录下创建一个<code class="fe nt nu nv nw b">AuthenticationButtonComponent</code>:</p><pre class="kg kh ki kj gt nx nw ny nz aw oa bi"><span id="6cf1" class="kr ks iq nw b gy ob oc l od oe">ng g c components/authentication-button --inlineStyle --skipTests</span></pre><blockquote class="nm nn no"><p id="5228" class="ln lo np lp b lq mi jr ls lt mj ju lv nq mw lx ly nr mx ma mb ns my md me mf ij bi translated"><em class="iq">您正在使用简写</em> <code class="fe nt nu nv nw b"><em class="iq">g</em></code> <em class="iq"> ( </em> <code class="fe nt nu nv nw b"><em class="iq">generate</em></code> <em class="iq">)和</em> <code class="fe nt nu nv nw b"><em class="iq">c</em></code> <em class="iq"> ( </em> <code class="fe nt nu nv nw b"><em class="iq">component</em></code> <em class="iq">)来使命令更短。</em></p></blockquote><p id="1249" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">🛠将<code class="fe nt nu nv nw b">authentication-button.component.ts</code>文件填充到<code class="fe nt nu nv nw b">src/app/components/authentication-button/</code>目录中，如下所示:</p><pre class="kg kh ki kj gt nx nw ny nz aw oa bi"><span id="8067" class="kr ks iq nw b gy ob oc l od oe">// src/app/components/authentication-button/authentication-button.component.ts</span><span id="71b5" class="kr ks iq nw b gy oh oc l od oe">import { Component, OnInit } from '@angular/core';<br/>import { AuthService } from '@auth0/auth0-angular';</span><span id="80c6" class="kr ks iq nw b gy oh oc l od oe">@Component({<br/>  selector: 'app-authentication-button',<br/>  templateUrl: './authentication-button.component.html',<br/>  styles: [],<br/>})<br/>export class AuthenticationButtonComponent implements OnInit {<br/>  constructor(public auth: AuthService) {}</span><span id="80fa" class="kr ks iq nw b gy oh oc l od oe">ngOnInit(): void {}<br/>}</span></pre><p id="233c" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">🛠将<code class="fe nt nu nv nw b">authentication-button.component.html</code>文件填充到<code class="fe nt nu nv nw b">src/app/components/authentication-button/</code>目录中，如下所示:</p><pre class="kg kh ki kj gt nx nw ny nz aw oa bi"><span id="d379" class="kr ks iq nw b gy ob oc l od oe">&lt;!--<br/>src/app/components/authentication-button/<br/>  authentication-button.component.html<br/>--&gt;</span><span id="0414" class="kr ks iq nw b gy oh oc l od oe">&lt;app-login-button *ngIf="(auth.isAuthenticated$ | async) === false"&gt;<br/>&lt;/app-login-button&gt;</span><span id="f122" class="kr ks iq nw b gy oh oc l od oe">&lt;app-logout-button *ngIf="auth.isAuthenticated$ | async"&gt;<br/>&lt;/app-logout-button&gt;</span></pre><p id="f90f" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">让我们从理解模板中发生的事情开始。<code class="fe nt nu nv nw b">auth.isAuthenticated$</code>是由<code class="fe nt nu nv nw b">AuthService</code>公开的一个<code class="fe nt nu nv nw b">Observable</code>，发出一个布尔值。当Auth0已经认证了用户时，它的值是<code class="fe nt nu nv nw b">true</code>,当没有认证时，它的值是<code class="fe nt nu nv nw b">false</code>。</p><p id="f230" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">值得注意的是，在引擎盖下，<code class="fe nt nu nv nw b">auth.isAuthenticated$</code>仅在Auth0 Angular SDK完成加载后才开始发送值。当<code class="fe nt nu nv nw b">AuthService.isLoading$</code>发出<code class="fe nt nu nv nw b">false</code>时，则<code class="fe nt nu nv nw b">auth.isAuthenticated$</code>发出其值。这种操作管道有助于防止与用户的认证状态相关的误报。这也会导致<code class="fe nt nu nv nw b">AuthenticationButtonComponent</code>的渲染有一点延迟，但是你很快就会修复这个问题。</p><p id="825c" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">使用这个<code class="fe nt nu nv nw b">AuthenticationButtonComponent</code>组件包装器有一些好处:</p><p id="85dc" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">您可以构建灵活的接口。<code class="fe nt nu nv nw b">AuthenticationButtonComponent</code>用作“登录/注销”开关，您可以将它放在任何需要开关功能的地方。然而，当你需要它们的独立功能时，你仍然有单独的<code class="fe nt nu nv nw b">LoginButtonComponent</code>和<code class="fe nt nu nv nw b">LogoutButtonComponent</code>。例如，您可能在页面上有一个只有经过身份验证的用户才能看到的注销按钮。</p><p id="f2d4" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">您可以构建可扩展的接口。您可以轻松地将<code class="fe nt nu nv nw b">LoginButtonComponent</code>与<code class="fe nt nu nv nw b">AuthenticationButtonComponent</code>中的<code class="fe nt nu nv nw b">SignupButtonComponent</code>互换，创建一个“注册/注销”开关。如果你愿意，你也可以把“注册/退出”开关包在一个<code class="fe nt nu nv nw b">NewAuthenticationButtonComponent</code>里。</p><p id="612b" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">您可以构建声明性接口。例如，使用AuthenticationButton，您可以向<code class="fe nt nu nv nw b">NavBarComponent</code>添加登录和注销功能，而无需考虑身份验证开关如何工作的实现细节。</p><p id="b660" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">考虑到这一点，🛠在<code class="fe nt nu nv nw b">src/components/</code>目录下创建了一个<code class="fe nt nu nv nw b">AuthNavComponent</code>:</p><pre class="kg kh ki kj gt nx nw ny nz aw oa bi"><span id="0520" class="kr ks iq nw b gy ob oc l od oe">ng g c components/auth-nav --inlineStyle --skipTests</span></pre><p id="3476" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">🛠将<code class="fe nt nu nv nw b">auth-nav.component.html</code>文件填充到<code class="fe nt nu nv nw b">src/app/components/auth-nav/</code>目录中，如下所示:</p><pre class="kg kh ki kj gt nx nw ny nz aw oa bi"><span id="4d39" class="kr ks iq nw b gy ob oc l od oe">&lt;!--src/app/components/auth-nav/auth-nav.component.html--&gt;</span><span id="31ef" class="kr ks iq nw b gy oh oc l od oe">&lt;div class="navbar-nav ml-auto"&gt;<br/>  &lt;app-authentication-button&gt;&lt;/app-authentication-button&gt;<br/>&lt;/div&gt;</span></pre><p id="55f5" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">🛠最后，打开<code class="fe nt nu nv nw b">src/app/components/nav-bar/</code>目录下的<code class="fe nt nu nv nw b">nav-bar.component.html</code>模板文件，更新如下:</p><pre class="kg kh ki kj gt nx nw ny nz aw oa bi"><span id="b6c8" class="kr ks iq nw b gy ob oc l od oe">&lt;!--src/app/components/nav-bar/nav-bar.component.html--&gt;</span><span id="1194" class="kr ks iq nw b gy oh oc l od oe">&lt;div class="nav-container mb-3"&gt;<br/>  &lt;nav class="navbar navbar-expand-md navbar-light bg-light"&gt;<br/>    &lt;div class="container"&gt;<br/>      &lt;div class="navbar-brand logo"&gt;&lt;/div&gt;<br/>      &lt;app-main-nav&gt;&lt;/app-main-nav&gt;<br/>      &lt;app-auth-nav&gt;&lt;/app-auth-nav&gt;<br/>    &lt;/div&gt;<br/>  &lt;/nav&gt;<br/>&lt;/div&gt;</span></pre><p id="8319" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">通过拥有不同类型的导航子组件，您可以根据需要扩展每个导航栏，而无需重新打开和修改<code class="fe nt nu nv nw b">MainNavComponent</code>。</p><p id="2a0c" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">🛠继续并尝试登录。您的Angular应用程序将您重定向到Auth0通用登录页面。您可以使用一个表单，通过用户名和密码或像Google这样的社交身份提供商登录。请注意，这个登录页面还为您提供了注册选项。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi na"><img src="../Images/6f369842f92e8de6ebd6cec38256fa8e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ont9o4IGNl8zJL9S.png"/></div></div></figure><p id="f305" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">实验:使用<code class="fe nt nu nv nw b">SignupButtonComponent</code></p><blockquote class="nm nn no"><p id="9f9b" class="ln lo np lp b lq mi jr ls lt mj ju lv nq mw lx ly nr mx ma mb ns my md me mf ij bi translated"><em class="iq">您可以</em> <a class="ae mz" href="https://auth0.com/docs/universal-login/customization-new" rel="noopener ugc nofollow" target="_blank"> <em class="iq">自定义新通用登录页面的外观</em> </a> <em class="iq">。您还可以使用</em> <a class="ae mz" href="https://auth0.com/docs/universal-login/text-customization" rel="noopener ugc nofollow" target="_blank"> <em class="iq">文本定制API </em> </a> <em class="iq">覆盖新体验中的任何文本。</em></p></blockquote><p id="e559" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">请注意，当您完成登录，Auth0将您重定向到Angular应用程序时，用户界面会出现一个闪烁的空白屏幕。</p><p id="a382" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">用户界面闪烁是因为你的Angular应用正在加载它的服务。在加载时，Angular不知道Auth0是否已经验证了用户。在Auth0 Angular SDK加载后，您的应用将知道用户身份验证状态。</p><p id="ee7d" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">🛠为了修复UI闪烁，使用由<code class="fe nt nu nv nw b">AuthService</code>公开的<code class="fe nt nu nv nw b">auth.isLoading$</code>可观察对象，一旦Angular SDK完成加载，它就会发出一个布尔值来呈现<code class="fe nt nu nv nw b">AppComponent</code>。</p><p id="306c" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">🛠打开<code class="fe nt nu nv nw b">src/app/app.component.ts</code>，更新如下:</p><pre class="kg kh ki kj gt nx nw ny nz aw oa bi"><span id="7f29" class="kr ks iq nw b gy ob oc l od oe">// src/app/app.component.ts</span><span id="50d2" class="kr ks iq nw b gy oh oc l od oe">import { Component } from '@angular/core';</span><span id="c53e" class="kr ks iq nw b gy oh oc l od oe">import { AuthService } from '@auth0/auth0-angular';</span><span id="07b3" class="kr ks iq nw b gy oh oc l od oe">@Component({<br/>  selector: 'app-root',<br/>  templateUrl: './app.component.html',<br/>})<br/>export class AppComponent {<br/>  constructor(public auth: AuthService) {}<br/>}</span></pre><p id="9de2" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">🛠打开<code class="fe nt nu nv nw b">src/app/app.component.html</code>，更新是这样的:</p><pre class="kg kh ki kj gt nx nw ny nz aw oa bi"><span id="7776" class="kr ks iq nw b gy ob oc l od oe">&lt;!--src/app/app.component.html--&gt;</span><span id="eb8c" class="kr ks iq nw b gy oh oc l od oe">&lt;div id="app" class="d-flex flex-column h-100"&gt;<br/>  &lt;div class="container" *ngIf="auth.isLoading$ | async; else loaded"&gt;<br/>    &lt;app-loading&gt;&lt;/app-loading&gt;<br/>  &lt;/div&gt;</span><span id="916c" class="kr ks iq nw b gy oh oc l od oe">&lt;ng-template #loaded&gt;<br/>    &lt;app-nav-bar&gt;&lt;/app-nav-bar&gt;</span><span id="93b2" class="kr ks iq nw b gy oh oc l od oe">&lt;div class="container flex-grow-1"&gt;<br/>      &lt;div class="mt-5"&gt;<br/>        &lt;router-outlet&gt;&lt;/router-outlet&gt;<br/>      &lt;/div&gt;<br/>    &lt;/div&gt;</span><span id="2924" class="kr ks iq nw b gy oh oc l od oe">&lt;app-footer&gt;&lt;/app-footer&gt;<br/>  &lt;/ng-template&gt;<br/>&lt;/div&gt;</span></pre><p id="063b" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">当SDK加载时，<code class="fe nt nu nv nw b">LoadingComponent</code>渲染，有一个很酷的动画。</p><h1 id="4ac4" class="nb ks iq bd kt nc nd ne kw nf ng nh kz jw ni jx ld jz nj ka lh kc nk kd ll nl bi translated">正在检索用户信息</h1><p id="e4b0" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv la lw lx ly le lz ma mb li mc md me mf ij bi translated">用户成功登录后，Auth0会向您的Angular应用程序发送一个ID令牌。Auth0等认证系统使用<a class="ae mz" href="https://auth0.com/learn/token-based-authentication-made-easy/" rel="noopener ugc nofollow" target="_blank">基于令牌的认证</a>中的<a class="ae mz" href="https://auth0.com/docs/tokens/concepts/id-tokens" rel="noopener ugc nofollow" target="_blank"> ID令牌</a>来缓存用户配置文件信息，并将其提供给客户端应用程序。ID标记的缓存有助于提高Angular应用程序的性能和响应能力。</p><p id="73f2" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">您可以使用来自ID令牌的数据来个性化您的Angular应用程序的用户界面。Auth0 Angular SDK对ID令牌进行解码，并通过<code class="fe nt nu nv nw b">AuthService</code>暴露的<code class="fe nt nu nv nw b">auth.user$</code>可观察对象发出其数据。一些ID标记信息包括登录用户的姓名、昵称、图片和电子邮件。</p><p id="71dd" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">如何使用ID标记为用户创建配置文件页面？</p><p id="d7b8" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">🛠在<code class="fe nt nu nv nw b">src/app/pages/profile/profile.component.ts</code>中更新<code class="fe nt nu nv nw b">ProfileComponent</code>如下:</p><pre class="kg kh ki kj gt nx nw ny nz aw oa bi"><span id="86ef" class="kr ks iq nw b gy ob oc l od oe">// src/app/pages/profile/profile.component.ts</span><span id="8af2" class="kr ks iq nw b gy oh oc l od oe">import { Component, OnInit } from '@angular/core';<br/>import { AuthService } from '@auth0/auth0-angular';</span><span id="a819" class="kr ks iq nw b gy oh oc l od oe">@Component({<br/>  selector: 'app-profile',<br/>  templateUrl: './profile.component.html',<br/>})<br/>export class ProfileComponent implements OnInit {<br/>  profileJson: string = null;</span><span id="76c5" class="kr ks iq nw b gy oh oc l od oe">constructor(public auth: AuthService) {}</span><span id="9b98" class="kr ks iq nw b gy oh oc l od oe">ngOnInit(): void {<br/>    this.auth.user$.subscribe(<br/>      (profile) =&gt; (this.profileJson = JSON.stringify(profile, null, 2))<br/>    );<br/>  }<br/>}</span></pre><p id="d9d6" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">🛠更新<code class="fe nt nu nv nw b">src/app/pages/profile/profile.component.html</code>中<code class="fe nt nu nv nw b">ProfileComponent</code>的模板如下:</p><pre class="kg kh ki kj gt nx nw ny nz aw oa bi"><span id="2446" class="kr ks iq nw b gy ob oc l od oe">&lt;!--src/app/pages/profile/profile.component.html--&gt;</span><span id="96b4" class="kr ks iq nw b gy oh oc l od oe">&lt;div *ngIf="auth.user$ | async as user"&gt;<br/>  &lt;div class="row align-items-center profile-header"&gt;<br/>    &lt;div class="col-md-2 mb-3"&gt;<br/>      &lt;img<br/>        [src]="user.picture"<br/>        alt="User's profile picture"<br/>        class="rounded-circle img-fluid profile-picture"<br/>      /&gt;<br/>    &lt;/div&gt;<br/>    &lt;div class="col-md text-center text-md-left"&gt;<br/>      &lt;h2&gt;{{ user.name }}&lt;/h2&gt;<br/>      &lt;p class="lead text-muted"&gt;{{ user.email }}&lt;/p&gt;<br/>    &lt;/div&gt;<br/>  &lt;/div&gt;</span><span id="476a" class="kr ks iq nw b gy oh oc l od oe">&lt;div class="row" *ngIf="profileJson"&gt;<br/>    &lt;pre class="col-12 text-light bg-dark p-4"&gt;{{ profileJson }}&lt;/pre&gt;<br/>  &lt;/div&gt;<br/>&lt;/div&gt;</span></pre><p id="1662" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">在<code class="fe nt nu nv nw b">ProfileComponent</code>组件中发生了什么？</p><p id="ae06" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated"><code class="fe nt nu nv nw b">ngOnInit()</code>是初始化角度分量数据的最佳位置。因此，您订阅了<code class="fe nt nu nv nw b">ProfileComponent</code>中的<code class="fe nt nu nv nw b">this.auth.user$</code>可观察值。一旦<code class="fe nt nu nv nw b">this.auth.user$</code>发出用户配置文件对象，您使用<code class="fe nt nu nv nw b">JSON.stringify</code>格式化该对象并将其分配给<code class="fe nt nu nv nw b">this.profileJson</code>。接下来，您使用<code class="fe nt nu nv nw b"><a class="ae mz" href="https://angular.io/api/common/NgIf" rel="noopener ugc nofollow" target="_blank">*ngIf</a></code> <a class="ae mz" href="https://angular.io/api/common/NgIf" rel="noopener ugc nofollow" target="_blank">指令</a>来基于<code class="fe nt nu nv nw b">profileJson</code>的值呈现带有用户概要JSON对象的代码框。</p><p id="4a0a" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated"><code class="fe nt nu nv nw b">ProfileComponent</code>呈现您认为受保护的用户信息。另外，如果没有登录用户，<code class="fe nt nu nv nw b">user</code>属性是<code class="fe nt nu nv nw b">null</code>。所以不管怎样，这个组件应该只在Auth0对用户进行了身份验证的情况下才呈现。</p><p id="552e" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">因此，您应该保护呈现该组件的路径，<code class="fe nt nu nv nw b"><a class="ae mz" href="http://localhost:4040/profile" rel="noopener ugc nofollow" target="_blank">http://localhost:4040/profile</a></code>。在下一节中，您将学习如何做到这一点。</p><h1 id="4e94" class="nb ks iq bd kt nc nd ne kw nf ng nh kz jw ni jx ld jz nj ka lh kc nk kd ll nl bi translated">保护路线</h1><p id="23e2" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv la lw lx ly le lz ma mb li mc md me mf ij bi translated">在本指南的所有章节中，由于<a class="ae mz" href="https://angular.io/guide/router" rel="noopener ugc nofollow" target="_blank">角状刳刨机</a>的坚固性，这一节是最容易实现的。Auth0 Angular SDK公开了一个可以用来保护路线的<code class="fe nt nu nv nw b"><a class="ae mz" href="https://auth0.github.io/auth0-angular/classes/authguard.html" rel="noopener ugc nofollow" target="_blank">AuthGuard</a></code>。</p><p id="f6fd" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">🛠打开<code class="fe nt nu nv nw b">src/app/app-routing.module.ts</code>，更新如下:</p><pre class="kg kh ki kj gt nx nw ny nz aw oa bi"><span id="cc44" class="kr ks iq nw b gy ob oc l od oe">// src/app/app-routing.module.ts</span><span id="9102" class="kr ks iq nw b gy oh oc l od oe">import { NgModule } from '@angular/core';<br/>import { Routes, RouterModule } from '@angular/router';<br/>import { HomeComponent } from 'src/app/pages/home/home.component';<br/>import { ProfileComponent } from 'src/app/pages/profile/profile.component';<br/>import { ExternalApiComponent } from 'src/app/pages/external-api/external-api.component';</span><span id="1613" class="kr ks iq nw b gy oh oc l od oe">import { AuthGuard } from '@auth0/auth0-angular';</span><span id="22c8" class="kr ks iq nw b gy oh oc l od oe">const routes: Routes = [<br/>  {<br/>    path: '',<br/>    component: HomeComponent,<br/>    pathMatch: 'full',<br/>  },<br/>  {<br/>    path: 'profile',<br/>    component: ProfileComponent,<br/>    canActivate: [AuthGuard],<br/>  },<br/>  {<br/>    path: 'external-api',<br/>    component: ExternalApiComponent,<br/>    canActivate: [AuthGuard],<br/>  },<br/>];</span><span id="f390" class="kr ks iq nw b gy oh oc l od oe">@NgModule({<br/>  imports: [RouterModule.forRoot(routes)],<br/>  exports: [RouterModule],<br/>})<br/>export class AppRoutingModule {}</span></pre><p id="f5fb" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">要求用户登录来访问路由很简单:只需在路由定义中包含<code class="fe nt nu nv nw b">canActivate</code>属性并添加<code class="fe nt nu nv nw b">AuthGuard</code>作为它的值。当没有登录的用户访问该路线时，您的Angular应用程序会将他们重定向到登录页面。用户登录后，Auth0会将用户重定向到您的Angular应用程序，<code class="fe nt nu nv nw b">AuthService</code>会将用户带到他们登录前想要访问的页面。</p><p id="b068" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">🛠:您现在可以测试这两条路径，<code class="fe nt nu nv nw b">/profile</code>和<code class="fe nt nu nv nw b">/external-api</code>，要求用户在访问它们之前进行身份验证。注销并尝试访问<a class="ae mz" href="http://localhost:4040/profile" rel="noopener ugc nofollow" target="_blank">配置文件</a>或<a class="ae mz" href="http://localhost:4040/external-api" rel="noopener ugc nofollow" target="_blank">外部API </a>选项卡。如果成功的话，Angular会重定向你使用Auth0登录。</p><p id="ae91" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">客户端防护提高了Angular应用程序的用户体验，而不是它的安全性。</p><h1 id="71bb" class="nb ks iq bd kt nc nd ne kw nf ng nh kz jw ni jx ld jz nj ka lh kc nk kd ll nl bi translated">调用API</h1><p id="1b15" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv la lw lx ly le lz ma mb li mc md me mf ij bi translated">本节主要向您展示如何在Angular应用程序中获取访问令牌，以及如何使用它进行安全的API调用。</p><p id="ea4e" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">当您使用Auth0时，您将身份验证过程委托给一个集中式服务。Auth0为您提供了从Angular应用程序中登录和注销用户的功能。但是，您的应用程序可能需要从安全的API访问资源。</p><p id="5aff" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">你也可以用Auth0 保护一个API。Auth0提供<a class="ae mz" href="https://auth0.com/docs/quickstart/backend" rel="noopener ugc nofollow" target="_blank">多个Auth0 API快速入门</a>来帮助你将Auth0与你的后端平台集成。</p><p id="9df6" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">当您使用Auth0 <em class="np">来保护您的API </em>时，您将授权过程委托给一个集中式服务，该服务确保只有经过批准的应用程序才能访问受保护的资源。您的Angular应用程序对用户进行身份验证，然后<a class="ae mz" href="https://auth0.com/docs/tokens/concepts/access-tokens" rel="noopener ugc nofollow" target="_blank">从Auth0 </a>接收一个访问令牌。</p><p id="f43e" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">然后，应用程序可以将该访问令牌作为凭证传递给API。反过来，您的API可以使用Auth0库来验证它从调用应用程序接收到的访问令牌，并发出包含所需数据的响应。</p><p id="bf9a" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">您将使用为您准备的demo Express API，而不是创建一个演示API来测试客户机-服务器连接。</p><h1 id="9465" class="nb ks iq bd kt nc nd ne kw nf ng nh kz jw ni jx ld jz nj ka lh kc nk kd ll nl bi translated">获取演示Express API</h1><p id="a788" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv la lw lx ly le lz ma mb li mc md me mf ij bi translated">🛠打开一个新的终端窗口，在你系统的某个地方克隆<code class="fe nt nu nv nw b">auth0-express-sample</code>回购。确保在Angular项目目录之外克隆它。</p><pre class="kg kh ki kj gt nx nw ny nz aw oa bi"><span id="1803" class="kr ks iq nw b gy ob oc l od oe">git clone git@github.com:auth0-blog/auth0-express-js-sample.git</span></pre><p id="2204" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">🛠:一旦你克隆了这个repo，把<code class="fe nt nu nv nw b">auth0-express-js-sample</code>目录作为你当前的目录:</p><pre class="kg kh ki kj gt nx nw ny nz aw oa bi"><span id="029f" class="kr ks iq nw b gy ob oc l od oe">cd auth0-express-js-sample</span></pre><p id="b453" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">🛠安装Node.js项目依赖关系:</p><pre class="kg kh ki kj gt nx nw ny nz aw oa bi"><span id="d80a" class="kr ks iq nw b gy ob oc l od oe">npm install</span></pre><h1 id="6ee8" class="nb ks iq bd kt nc nd ne kw nf ng nh kz jw ni jx ld jz nj ka lh kc nk kd ll nl bi translated">用Auth0连接Express API</h1><h2 id="4ae4" class="kr ks iq bd kt ku kv dn kw kx ky dp kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">在Express和Auth0之间建立沟通桥梁</h2><p id="76e5" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv la lw lx ly le lz ma mb li mc md me mf ij bi translated">这个过程类似于你如何用Auth0连接Angular。</p><p id="87dc" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">🛠转到Auth0仪表板中的API部分，点击“创建API”按钮。</p><p id="c21e" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">🛠接着以Auth0显示的形式:</p><ul class=""><li id="09ff" class="mg mh iq lp b lq mi lt mj la mk le ml li mm mf mn mo mp mq bi translated">为您的API添加一个名称:</li></ul><pre class="kg kh ki kj gt nx nw ny nz aw oa bi"><span id="0c85" class="kr ks iq nw b gy ob oc l od oe">Auth0 Express Sample</span></pre><ul class=""><li id="003c" class="mg mh iq lp b lq mi lt mj la mk le ml li mm mf mn mo mp mq bi translated">设置其标识符值:</li></ul><pre class="kg kh ki kj gt nx nw ny nz aw oa bi"><span id="e797" class="kr ks iq nw b gy ob oc l od oe"><a class="ae mz" href="https://express.sample" rel="noopener ugc nofollow" target="_blank">https://express.sample</a></span></pre><ul class=""><li id="0423" class="mg mh iq lp b lq mi lt mj la mk le ml li mm mf mn mo mp mq bi translated">将签名算法保留为<code class="fe nt nu nv nw b">RS256</code>,因为从安全角度来看，这是最好的选择。</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oo"><img src="../Images/b98590fc1d2d0dbd02180535ea29b0a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Vk2LrIynXF_TxBM9.png"/></div></div></figure><p id="ad69" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">标识符是帮助Auth0区分不同API的唯一字符串。我建议使用URL来创建可预见的唯一标识符；但是，Auth0从不调用这些URL。</p><p id="9a22" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">🛠把这些值准备好，点击“创建”按钮。</p><h2 id="1284" class="kr ks iq bd kt ku kv dn kw kx ky dp kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">添加Auth0配置变量来表示</h2><p id="f083" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv la lw lx ly le lz ma mb li mc md me mf ij bi translated">🛠:现在，点击你的Auth0 API页面的“快速启动”标签。本页介绍如何设置不同的API。从“代码”框中，选择“Node.js”。保持此页打开，因为接下来您将使用这些值。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi og"><img src="../Images/6aeb6a09c3aa14a7151655f550db6fc7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*kuZTS_RejGOS4P25.png"/></div></div></figure><p id="3073" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">🛠在<code class="fe nt nu nv nw b">auth0-express-sample</code>目录下为API服务器创建一个<code class="fe nt nu nv nw b">.env</code>文件:</p><pre class="kg kh ki kj gt nx nw ny nz aw oa bi"><span id="4c33" class="kr ks iq nw b gy ob oc l od oe">touch .env</span></pre><p id="da35" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">🛠如下填充这个<code class="fe nt nu nv nw b">auth0-express-sample/.env</code>文件:</p><pre class="kg kh ki kj gt nx nw ny nz aw oa bi"><span id="de78" class="kr ks iq nw b gy ob oc l od oe">SERVER_PORT=6060<br/>CLIENT_ORIGIN_URL=http://localhost:4040<br/>AUTH0_AUDIENCE=<br/>AUTH0_ISSUER_URL=</span></pre><p id="e0ad" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">🛠从Auth0 API“快速入门”页面返回到“Node.js”代码片段。找到<code class="fe nt nu nv nw b">jwtCheck</code>的定义:</p><pre class="kg kh ki kj gt nx nw ny nz aw oa bi"><span id="0d47" class="kr ks iq nw b gy ob oc l od oe">var jwtCheck = jwt({<br/>  secret: jwks.expressJwtSecret({<br/>    cache: true,<br/>    rateLimit: true,<br/>    jwksRequestsPerMinute: 5,<br/>    jwksUri: "https://&lt;TENANT-NAME&gt;.auth0.com/.well-known/jwks.json",<br/>  }),<br/>  audience: "https://express.sample", // 👈 AUTH0_AUDIENCE value<br/>  issuer: "https://&lt;TENANT-NAME&gt;.auth0.com/", // 👈 AUTH0_ISSUER_URL value<br/>  algorithms: ["RS256"],<br/>});</span></pre><p id="be0e" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">🛠查看<code class="fe nt nu nv nw b">jwt</code>函数作为参数的对象，并使用以下属性来完成<code class="fe nt nu nv nw b">.env</code>文件的值:</p><p id="c38d" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">🛠<code class="fe nt nu nv nw b">AUTH0_AUDIENCE</code>的值就是其<code class="fe nt nu nv nw b">audience</code>属性的值。</p><p id="67f2" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">🛠<code class="fe nt nu nv nw b">AUTH0_ISSUER</code>的值就是它的<code class="fe nt nu nv nw b">issuer</code>属性的值。</p><blockquote class="nm nn no"><p id="cd7d" class="ln lo np lp b lq mi jr ls lt mj ju lv nq mw lx ly nr mx ma mb ns my md me mf ij bi translated"><em class="iq">不包括引号，只包括字符串值。</em></p></blockquote><p id="a55f" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">设置了<code class="fe nt nu nv nw b">.env</code>配置值的🛠，通过发出以下命令运行API服务器:</p><pre class="kg kh ki kj gt nx nw ny nz aw oa bi"><span id="3a41" class="kr ks iq nw b gy ob oc l od oe">npm start</span></pre><h1 id="cba2" class="nb ks iq bd kt nc nd ne kw nf ng nh kz jw ni jx ld jz nj ka lh kc nk kd ll nl bi translated">配置Angular以连接Express API</h1><p id="103a" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv la lw lx ly le lz ma mb li mc md me mf ij bi translated">🛠回到存储你的Angular应用程序的<code class="fe nt nu nv nw b">auth0-angular-sample</code>项目目录。</p><p id="9222" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">🛠找到<code class="fe nt nu nv nw b">auth_config.json</code>文件，并向其中添加一个受众和一个服务器URL值:</p><pre class="kg kh ki kj gt nx nw ny nz aw oa bi"><span id="ff83" class="kr ks iq nw b gy ob oc l od oe">{<br/>  "domain": "YOUR_AUTH0_DOMAIN",<br/>  "clientId": "YOUR_AUTH0_CLIENT_ID",<br/>  "audience": "https://express.sample",<br/>  "serverUrl": "http://localhost:6060"<br/>}</span></pre><p id="f233" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">🛠<code class="fe nt nu nv nw b">audience</code>的值与<code class="fe nt nu nv nw b">auth0-express-sample/.env</code>中的<code class="fe nt nu nv nw b">AUTH0_AUDIENCE</code>相同。</p><p id="e9d8" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">🛠找到<code class="fe nt nu nv nw b">src/environments/environment.ts</code>文件并更新如下:</p><pre class="kg kh ki kj gt nx nw ny nz aw oa bi"><span id="24ed" class="kr ks iq nw b gy ob oc l od oe">// src/environments/environment.ts</span><span id="92c4" class="kr ks iq nw b gy oh oc l od oe">import { domain, clientId, audience, serverUrl } from '../../auth_config.json';</span><span id="5aa9" class="kr ks iq nw b gy oh oc l od oe">export const environment = {<br/>  production: false,<br/>  auth: {<br/>    domain,<br/>    clientId,<br/>    redirectUri: window.location.origin,<br/>    audience,<br/>  },<br/>  dev: {<br/>    serverUrl,<br/>  },<br/>};</span></pre><p id="a807" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">当Angular应用程序调用目标API来访问受保护的资源时，它需要传递一个访问令牌。</p><p id="26ce" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">Auth0 Angular SDK提供了一个<code class="fe nt nu nv nw b">HttpInjector</code>，当使用内置Angular <code class="fe nt nu nv nw b">HttpClient</code>模块时，它会自动将访问令牌附加到传出的请求上。但是，您必须将注入器配置为知道它需要向哪些请求附加访问令牌。</p><p id="d4da" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">🛠从导入<code class="fe nt nu nv nw b">HTTP_INTERCEPTORS</code>令牌和<code class="fe nt nu nv nw b">src/app/app.module.ts</code>文件中<code class="fe nt nu nv nw b">@NgModule</code>定义正上方的<code class="fe nt nu nv nw b">AuthHttpInterceptor</code>开始:</p><pre class="kg kh ki kj gt nx nw ny nz aw oa bi"><span id="b483" class="kr ks iq nw b gy ob oc l od oe">// src/app/app.module.ts</span><span id="144a" class="kr ks iq nw b gy oh oc l od oe">// Other imports...</span><span id="41fd" class="kr ks iq nw b gy oh oc l od oe">import { HTTP_INTERCEPTORS } from '@angular/common/http';<br/>import { AuthHttpInterceptor } from '@auth0/auth0-angular';</span><span id="66d5" class="kr ks iq nw b gy oh oc l od oe">@NgModule({...})<br/>export class AppModule {}</span></pre><p id="dc14" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">你正在从<code class="fe nt nu nv nw b">@auth0/auth0-angular</code>进口<code class="fe nt nu nv nw b">AuthHttpInterceptor</code>，同时从<code class="fe nt nu nv nw b">@angular/common/http</code>进口<code class="fe nt nu nv nw b">HTTP_INTERCEPTORS</code>。<code class="fe nt nu nv nw b"><a class="ae mz" href="https://angular.io/api/common/http/HTTP_INTERCEPTORS" rel="noopener ugc nofollow" target="_blank">HTTP_INTERCEPTORS</a></code>是一个多提供者令牌，表示已注册的<code class="fe nt nu nv nw b">HttpInterceptor</code>对象的数组。</p><p id="b6d2" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">🛠接下来，将<code class="fe nt nu nv nw b">providers</code>属性添加到<code class="fe nt nu nv nw b">AppModule</code>的配置对象中，如下所示，以将<code class="fe nt nu nv nw b">AuthHttpInterceptor</code>注入器注册为提供者:</p><pre class="kg kh ki kj gt nx nw ny nz aw oa bi"><span id="0a56" class="kr ks iq nw b gy ob oc l od oe">// src/app/app.module.ts</span><span id="ca9a" class="kr ks iq nw b gy oh oc l od oe">// All imports...</span><span id="4ca4" class="kr ks iq nw b gy oh oc l od oe">@NgModule({<br/>  declarations: [...],<br/>  imports: [...],<br/>  providers: [<br/>    {<br/>      provide: HTTP_INTERCEPTORS,<br/>      useClass: AuthHttpInterceptor,<br/>      multi: true,<br/>    },<br/>  ],<br/>  bootstrap: [AppComponent],<br/>})<br/>export class AppModule {}</span></pre><p id="7444" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">这就完成了连接<code class="fe nt nu nv nw b">AuthHttpInterceptor</code>与您的角度应用请求周期所需的接线。</p><p id="7db9" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">现在，您需要通过进一步配置<code class="fe nt nu nv nw b">AuthModule.forRoot()</code>来告诉SDK哪些请求要附加访问令牌。基于这个配置，Angular会将您使用<code class="fe nt nu nv nw b">HttpClient</code>发出的任何请求的URL与允许的URL列表进行匹配。</p><p id="b2fa" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">如果匹配，Angular会在请求的授权头中附加一个访问令牌。您可以使用字符串或正则表达式进行URL匹配。现在，您将允许Angular将一个访问令牌附加到它向<code class="fe nt nu nv nw b"><a class="ae mz" href="http://localhost:6060/api/messages/protected-message." rel="noopener ugc nofollow" target="_blank">http://localhost:6060/api/messages/protected-message</a></code> <a class="ae mz" href="http://localhost:6060/api/messages/protected-message." rel="noopener ugc nofollow" target="_blank">发出的请求上。</a></p><p id="447d" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">🛠更新<code class="fe nt nu nv nw b">AppModule</code>的模块<code class="fe nt nu nv nw b">imports</code>中的<code class="fe nt nu nv nw b">AuthModule</code>的配置，如下所示:</p><pre class="kg kh ki kj gt nx nw ny nz aw oa bi"><span id="f584" class="kr ks iq nw b gy ob oc l od oe">// src/app/app.module.ts</span><span id="c215" class="kr ks iq nw b gy oh oc l od oe">// All imports...</span><span id="6653" class="kr ks iq nw b gy oh oc l od oe">@NgModule({<br/>  declarations: [...],<br/>  imports: [<br/>    BrowserModule,<br/>    AppRoutingModule,<br/>    HttpClientModule,<br/>    FontAwesomeModule,<br/>    // 👇 update AuthModule<br/>    AuthModule.forRoot({<br/>      ...env.auth,<br/>      httpInterceptor: {<br/>        allowedList: [`${env.dev.serverUrl}/api/messages/protected-message`],<br/>      },<br/>    }),<br/>  ],<br/>  providers: [...],<br/>  bootstrap: [...],<br/>})<br/>export class AppModule {}</span></pre><p id="8aab" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">假设您使用<code class="fe nt nu nv nw b">HttpClient</code>进行HTTP调用，但是在<code class="fe nt nu nv nw b">AuthHttpInterceptor</code>中没有与该URL匹配的URL。在这种情况下，Angular绕过拦截器，在没有在<code class="fe nt nu nv nw b">Authorization</code>头中附加令牌的情况下进行调用。</p><blockquote class="nm nn no"><p id="48b6" class="ln lo np lp b lq mi jr ls lt mj ju lv nq mw lx ly nr mx ma mb ns my md me mf ij bi translated"><em class="iq">注意:在授权头中明确哪些API请求需要一个访问令牌，可以防止令牌被附加到发给非预期接收者的请求上，这是一个严重的安全问题。然后，这些接收者可以使用该令牌调用API，就好像它是您的应用程序一样。</em></p></blockquote><p id="08e1" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">最后，使用<code class="fe nt nu nv nw b">HttpClient</code>进行API调用，因为<code class="fe nt nu nv nw b">HttpClientModule</code>已经被导入到starter项目中。</p><p id="7626" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">🛠更新<code class="fe nt nu nv nw b">src/app/pages/external-api/external-api.component.ts</code>如下:</p><pre class="kg kh ki kj gt nx nw ny nz aw oa bi"><span id="63e5" class="kr ks iq nw b gy ob oc l od oe">// src/app/pages/external-api/external-api.component.ts</span><span id="67bc" class="kr ks iq nw b gy oh oc l od oe">import { Component, OnInit } from '@angular/core';<br/>import { HttpClient } from '@angular/common/http';</span><span id="59bc" class="kr ks iq nw b gy oh oc l od oe">import { environment as env } from '../../../environments/environment';</span><span id="8123" class="kr ks iq nw b gy oh oc l od oe">interface Message {<br/>  message: string;<br/>}</span><span id="eb90" class="kr ks iq nw b gy oh oc l od oe">@Component({<br/>  selector: 'app-external-api',<br/>  templateUrl: './external-api.component.html',<br/>})<br/>export class ExternalApiComponent implements OnInit {<br/>  message: string = null;</span><span id="01f6" class="kr ks iq nw b gy oh oc l od oe">constructor(private http: HttpClient) {}</span><span id="fa1e" class="kr ks iq nw b gy oh oc l od oe">ngOnInit(): void {}</span><span id="e312" class="kr ks iq nw b gy oh oc l od oe">callApi(): void {<br/>    this.http<br/>      .get(`${env.dev.serverUrl}/api/messages/public-message`)<br/>      .subscribe((result: Message) =&gt; {<br/>        this.message = result.message;<br/>      });<br/>  }</span><span id="0f35" class="kr ks iq nw b gy oh oc l od oe">callSecureApi(): void {<br/>    this.http<br/>      .get(`${env.dev.serverUrl}/api/messages/protected-message`)<br/>      .subscribe((result: Message) =&gt; {<br/>        this.message = result.message;<br/>      });<br/>  }<br/>}</span></pre><p id="9bba" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">⚠️检查你使用<code class="fe nt nu nv nw b">HttpClient</code>调用的URL是否与你在<code class="fe nt nu nv nw b">httpInterceptor</code>配置中得到的规则相匹配。注意尾随斜线。</p><p id="4a43" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">🛠更新<code class="fe nt nu nv nw b">src/app/pages/external-api/external-api.component.html</code>如下:</p><pre class="kg kh ki kj gt nx nw ny nz aw oa bi"><span id="dda8" class="kr ks iq nw b gy ob oc l od oe">&lt;!--src/app/pages/external-api/external-api.component.html--&gt;</span><span id="990f" class="kr ks iq nw b gy oh oc l od oe">&lt;div&gt;<br/>  &lt;h1&gt;External API&lt;/h1&gt;<br/>  &lt;p&gt;<br/>    Use these buttons to call an external API. The protected API call has an<br/>    access token in its authorization header. The API server will validate the<br/>    access token using the Auth0 Audience value.<br/>  &lt;/p&gt;<br/>  &lt;div<br/>    class="btn-group mt-5"<br/>    role="group"<br/>    aria-label="External API Requests Examples"<br/>  &gt;<br/>    &lt;button (click)="callApi()" type="button" class="btn btn-primary"&gt;<br/>      Get Public Message<br/>    &lt;/button&gt;<br/>    &lt;button (click)="callSecureApi()" type="button" class="btn btn-primary"&gt;<br/>      Get Protected Message<br/>    &lt;/button&gt;<br/>  &lt;/div&gt;</span><span id="24e1" class="kr ks iq nw b gy oh oc l od oe">&lt;div *ngIf="message" class="mt-5"&gt;<br/>    &lt;h6 class="muted"&gt;Result&lt;/h6&gt;<br/>    &lt;div class="container-fluid"&gt;<br/>      &lt;div class="row"&gt;<br/>        &lt;code class="col-12 text-light bg-dark p-4"&gt;<br/>          {{ message }}<br/>        &lt;/code&gt;<br/>      &lt;/div&gt;<br/>    &lt;/div&gt;<br/>  &lt;/div&gt;<br/>&lt;/div&gt;</span></pre><p id="eeea" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">在<code class="fe nt nu nv nw b">ExternalApi</code>组件中现在发生了什么？</p><p id="d3f0" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">添加一个执行公共API请求的<code class="fe nt nu nv nw b">callApi()</code>方法和一个执行安全API请求的<code class="fe nt nu nv nw b">callSecureApi()</code>方法。每个方法的实现看起来都是一样的。然而，在引擎盖下，Angular在<code class="fe nt nu nv nw b">AuthHttpInterceptor</code>的<code class="fe nt nu nv nw b">allowedList</code>中找到了<code class="fe nt nu nv nw b">${env.dev.apiUrl}/api/messages/protected-message</code>的对手。</p><p id="d36c" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">然后，Angular使用Auth0 SDK从Auth0获取访问令牌，并将该访问令牌作为承载凭证附加到请求的授权头中。</p><p id="5031" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">然后将成功请求的结果分配给<code class="fe nt nu nv nw b">this.message</code>，使用代码框在用户界面中呈现。</p><p id="1bf8" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">为什么客户端和服务器应用程序的Auth0受众值相同？</p><p id="fe07" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">Auth0使用<code class="fe nt nu nv nw b">audience</code>属性的值来确定用户授权您的Angular应用程序访问哪个资源服务器(API)。</p><p id="9f4b" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">您的Angular应用程序可以在API上执行的操作取决于您的访问令牌包含的<a class="ae mz" href="https://auth0.com/docs/scopes/current" rel="noopener ugc nofollow" target="_blank">范围</a>。您可以在<code class="fe nt nu nv nw b">httpInterceptor.allowedList</code>条目的<code class="fe nt nu nv nw b"><a class="ae mz" href="https://auth0.github.io/auth0-angular/interfaces/httpinterceptorrouteconfig.html#tokenoptions" rel="noopener ugc nofollow" target="_blank">tokenOptions</a></code>中定义作用域的值。</p><p id="ee24" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">还记得你第一次用Auth0登录时看到的屏幕，询问你是否允许访问你的个人资料信息吗？您的Angular应用程序将请求用户授权访问所请求的范围，用户将批准或拒绝该请求。该屏幕被称为同意对话框。你可能以前在使用GitHub、谷歌或脸书登录或与第三方分享你的电子邮件联系人时见过这种情况。</p><p id="9e33" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">当您没有将一个<code class="fe nt nu nv nw b">scope</code>属性传递给<code class="fe nt nu nv nw b">tokenOptions</code>时，Angular SDK默认为<a class="ae mz" href="https://openid.net/specs/openid-connect-basic-1_0.html#Scopes" rel="noopener ugc nofollow" target="_blank"> OpenID连接范围</a> : <code class="fe nt nu nv nw b">openid profile email</code>。</p><ul class=""><li id="7fd1" class="mg mh iq lp b lq mi lt mj la mk le ml li mm mf mn mo mp mq bi translated"><code class="fe nt nu nv nw b">openid</code>:这个作用域通知Auth0授权服务器，客户端正在发出<a class="ae mz" href="https://auth0.com/docs/protocols/oidc" rel="noopener ugc nofollow" target="_blank"> OpenID Connect (OIDC) </a>请求来验证用户的身份。OpenID Connect是一种身份验证协议。</li><li id="be30" class="mg mh iq lp b lq mr lt ms la mt le mu li mv mf mn mo mp mq bi translated"><code class="fe nt nu nv nw b">profile</code>:该范围值请求访问用户的默认配置文件信息，如<code class="fe nt nu nv nw b">name</code>、<code class="fe nt nu nv nw b">nickname</code>和<code class="fe nt nu nv nw b">picture</code>。</li><li id="691d" class="mg mh iq lp b lq mr lt ms la mt le mu li mv mf mn mo mp mq bi translated"><code class="fe nt nu nv nw b">email</code>:该范围值请求访问<code class="fe nt nu nv nw b">email</code>和<code class="fe nt nu nv nw b">email_verified</code>信息。</li></ul><p id="02d9" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">OpenID连接范围的细节放在ID标记中。</p><p id="aa11" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">对于您的API，您将定义自定义的<a class="ae mz" href="https://auth0.com/docs/scopes/current/api-scopes" rel="noopener ugc nofollow" target="_blank"> API作用域</a>来实现访问控制，并且您将在您的客户端应用程序对该API的调用中识别它们。Auth0将API作用域作为 <code class="fe nt nu nv nw b"><a class="ae mz" href="https://auth0.com/docs/tokens/guides/validate-access-tokens#custom-api-access-tokens" rel="noopener ugc nofollow" target="_blank">scope</a></code> <a class="ae mz" href="https://auth0.com/docs/tokens/guides/validate-access-tokens#custom-api-access-tokens" rel="noopener ugc nofollow" target="_blank">声明</a>包含在<a class="ae mz" href="https://auth0.com/docs/tokens/guides/validate-access-tokens#custom-api-access-tokens" rel="noopener ugc nofollow" target="_blank">访问令牌中。</a></p><p id="f41e" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">您之前的登录请求不包含受众参数。因此，Angular SDK没有在内存中存储访问令牌。</p><p id="0818" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">您不应该在<code class="fe nt nu nv nw b"><a class="ae mz" href="https://developer.mozilla.org/en-US/docs/Web/API/Window/localStorage" rel="noopener ugc nofollow" target="_blank">localStorage</a></code>中存储令牌。为什么？</p><p id="4808" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">🛠注销并重新登录，以从Auth0获取包含受众信息的新访问令牌。</p><p id="6e4b" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">🛠访问<code class="fe nt nu nv nw b"><a class="ae mz" href="http://localhost:4040/external-api" rel="noopener ugc nofollow" target="_blank">http://localhost:4040/external-api</a></code>并点击外部API页面上的任意按钮来测试响应。</p><p id="562d" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">获取公共消息:</p><pre class="kg kh ki kj gt nx nw ny nz aw oa bi"><span id="02e7" class="kr ks iq nw b gy ob oc l od oe">The API doesn't require an access token to share this message.</span></pre><p id="5c72" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">获取受保护的邮件:</p><pre class="kg kh ki kj gt nx nw ny nz aw oa bi"><span id="beba" class="kr ks iq nw b gy ob oc l od oe">The API successfully validated your access token.</span></pre><h1 id="52e5" class="nb ks iq bd kt nc nd ne kw nf ng nh kz jw ni jx ld jz nj ka lh kc nk kd ll nl bi translated">摘要</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/5aad988f983215c7b963b14380ca530f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*s2zsRSGXzxVmU0mWQSXfHg.gif"/></div></div></figure><p id="06ca" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">您已经在Angular中实现了用户身份验证，以识别您的用户，获取用户配置文件信息，并控制您的用户可以访问的内容。您还了解了如何在受Auth0保护的堆栈的客户机和服务器之间进行安全的API调用。</p><p id="2d5c" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">本教程涵盖了React应用程序最常见的身份验证用例:简单的登录和注销。然而，Auth0是一个可扩展的灵活平台，可以帮助您实现更多。如果您有一个更复杂的用例，请查看<a class="ae mz" href="https://auth0.com/docs/architecture-scenarios" rel="noopener ugc nofollow" target="_blank"> Auth0架构场景</a>以了解在与客户合作实现Auth0时发现的典型架构场景的更多信息。</p><p id="60d8" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated">请在下面的评论中告诉我你是如何喜欢这个教程的。感谢你阅读这篇文章，请继续关注。再见！</p><p id="26a6" class="pw-post-body-paragraph ln lo iq lp b lq mi jr ls lt mj ju lv la mw lx ly le mx ma mb li my md me mf ij bi translated"><em class="np">更多内容尽在</em><a class="ae mz" href="http://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><em class="np">plain English . io</em></a></p></div></div>    
</body>
</html>