<html>
<head>
<title>I Switched From Apollo To Urql (And It Was Worth It)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我从Apollo换到了Urql(这是值得的)</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/how-i-switched-from-apollo-to-urql-in-my-next-js-site-and-why-it-was-worth-it-9c7394ec150d?source=collection_archive---------2-----------------------#2021-06-10">https://javascript.plainenglish.io/how-i-switched-from-apollo-to-urql-in-my-next-js-site-and-why-it-was-worth-it-9c7394ec150d?source=collection_archive---------2-----------------------#2021-06-10</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/d9880f0c2323638421fa71e598a9d8c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*OuNqCoFoVt7qy4pA.png"/></div></div></figure><p id="e1e0" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在本文中，我们将研究Urql作为Apollo的替代品。我们将看看用Urql替换Apollo的实际情况，以及它对我的(Next.js)项目的影响。</p><p id="229e" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">如果您阅读了这篇文章，我将假设您要么已经实现了一个GraphQL客户端，并且对其他选项感兴趣，要么正在考虑实现一个GraphQL客户端。这就是为什么我假设您知道GraphQL是什么以及它是做什么的。</p><p id="4469" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">一些其他有用的信息，在这个项目中，我在前端使用Next.js和SSG(静态站点生成)，在后端使用Express和GraphQL和MongoDB数据库。我正在做的并且充满热情的项目是<a class="ae kt" href="https://www.winkt.io" rel="noopener ugc nofollow" target="_blank"> winkt.io </a>(我们爱墨水)，一个扩展对纹身艺术欣赏的平台</p><h1 id="b494" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">转换到Urql(如何实现)</h1><p id="c134" class="pw-post-body-paragraph jv jw in jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated">该项目中当前的Apollo实现基于next.js中的<a class="ae kt" href="https://github.com/vercel/next.js/tree/canary/examples/with-apollo" rel="noopener ugc nofollow" target="_blank"> with-apollo示例</a>。我们可以用新的urqlClient替换它:</p><figure class="ly lz ma mb gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi lx"><img src="../Images/fd857290946fae01f05de5bd918c4886.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LhXBiwddQjh57t78bEnSDQ.png"/></div></div><figcaption class="mc md gj gh gi me mf bd b be z dk">urqlClient.js</figcaption></figure><p id="e4bd" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">要使用Urql，我们需要创建一个客户端。Urql中的createClient函数首先接收我们正在连接的url。其次，我们设置交换条件。如果我们不定义交换，Urql将默认交换设置为<code class="fe mg mh mi mj b">exchanges: [dedupExchange, cacheExchange, fetchExchange]</code>。</p><blockquote class="mk ml mm"><p id="8063" class="jv jw mn jx b jy jz ka kb kc kd ke kf mo kh ki kj mp kl km kn mq kp kq kr ks ig bi translated">重复数据删除交换—负责重复数据删除操作。<br/> <em class="in"> cacheExchange — </em>负责缓存基于唯一查询+变量的GraphQL API响应(文档缓存)。<br/> <em class="in"> fetchExchange — </em>使用fetch发送GraphQL请求，默认支持取消。</p></blockquote><p id="3292" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在我们的urqlClient中，我们定义了要添加的交换<em class="mn"> ssrCache </em>。交换的顺序很重要，最重要的是fetchExchange需要最后进行，因为它是异步的。</p><p id="f231" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">ssrCache将允许我们收集所有的结果，因为它们在服务器端被获取并发送到客户端。在客户端，我们可以使用结果来避免重新提取数据。</p><p id="b911" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">现在我们已经创建了我们的urqlClient，我们可以将我们的应用程序包装在urql的provider中。我们可以通过覆盖N <a class="ae kt" href="https://nextjs.org/docs/advanced-features/custom-app" rel="noopener ugc nofollow" target="_blank"> ext.js _app </a>组件来实现这一点。在这里，我们还可以使用来自服务器的数据来恢复客户端。目前在pageProps中我们的urqlState中没有任何内容，但我们将很快对此进行更改。我们来看看我们的_app.js:</p><figure class="ly lz ma mb gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi lx"><img src="../Images/04bef461c1f7ee766d537dacc658291e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CiAFyxCbLvfDlaYY6nXEew.png"/></div></div><figcaption class="mc md gj gh gi me mf bd b be z dk">pages/_app.js</figcaption></figure><h2 id="77ab" class="mr kv in bd kw ms mt dn la mu mv dp le kg mw mx li kk my mz lm ko na nb lq nc bi translated"><strong class="ak">更新组件</strong></h2><p id="df40" class="pw-post-body-paragraph jv jw in jx b jy ls ka kb kc lt ke kf kg lu ki kj kk lv km kn ko lw kq kr ks ig bi translated">让我们看一下查询GraphQL数据的组件需要做的更改。在这个例子中，我使用<em class="mn"> getStaticProps </em>来利用SSG，如果您想利用SSR，您可以将<em class="mn"> getStaticProps </em>替换为<em class="mn"> getServerSideProps </em>。</p><p id="b888" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">在下面，您会发现一个查询数据的组件的精简版本，第一个示例使用Apollo，第二个示例使用Urql。您可以查看Urql版本中的注释以了解更多信息。</p><figure class="ly lz ma mb gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi lx"><img src="../Images/a10435457a8b29615e471069787d461a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*myQaL7rQsuqkylfmIitKWw.png"/></div></div><figcaption class="mc md gj gh gi me mf bd b be z dk">Component that queries with Apollo</figcaption></figure><figure class="ly lz ma mb gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi lx"><img src="../Images/18d981d56cfd9faa0e03bdab168caef6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9ms0mW_fvlwZHg0pAI9TXA.png"/></div></div><figcaption class="mc md gj gh gi me mf bd b be z dk">Component that queries with Urql</figcaption></figure><p id="73a1" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">我们还将使用一个示例组件来查看突变的差异。同样，您会在Urql版本的注释中找到一些细节。</p><figure class="ly lz ma mb gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi lx"><img src="../Images/065027449db62ff47606bdeeea267766.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*i75MuV8WaKk3aBwQ1cZ0Rw.png"/></div></div><figcaption class="mc md gj gh gi me mf bd b be z dk">Component that performs a mutation with Apollo</figcaption></figure><figure class="ly lz ma mb gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi lx"><img src="../Images/cebf48cbcc237e4393d8b20a9e384364.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*o13mMx7yc_Zt4HGzjjc3JA.png"/></div></div><figcaption class="mc md gj gh gi me mf bd b be z dk">Component that performs a mutation with Urql</figcaption></figure><p id="5a64" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">最后，如果您有一个显示GraphQL错误的组件，您需要替换“[GraphQL]”而不是“GraphQL错误:”。就这样，我们现在成功地实现了Urql。</p><h1 id="cd18" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated">结果</h1><figure class="ly lz ma mb gt jo gh gi paragraph-image"><div class="gh gi nd"><img src="../Images/8cc8d1b1d07fb61983aeb30bde72ffb8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1308/format:webp/1*uv-ONaf97ux3U0-ylnbgWg.png"/></div><figcaption class="mc md gj gh gi me mf bd b be z dk">First Load JS shared by all from 132kb to 95kb.</figcaption></figure><figure class="ly lz ma mb gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi ne"><img src="../Images/9be88b58e292d31edec5de4499701ea2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NPc6VWlTzirmjRKJ15KKXA.jpeg"/></div></div><figcaption class="mc md gj gh gi me mf bd b be z dk">From 2.1s to 626ms in GraphQL calls on the product page</figcaption></figure><p id="daac" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">以及Google PageSpeed评分的提升。移动设备得分从41分上升到65分，桌面设备从65分上升到95分。</p><h1 id="d4e3" class="ku kv in bd kw kx ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr bi translated"><strong class="ak">期末笔记</strong></h1><ul class=""><li id="abce" class="nf ng in jx b jy ls kc lt kg nh kk ni ko nj ks nk nl nm nn bi translated">我在几乎所有页面中都使用GraphQL数据，因此将整个应用程序包装在Urql提供程序中是有意义的。如果您的情况不是这样，那么您可以为Urql使用一个HOC。</li><li id="346e" class="nf ng in jx b jy no kc np kg nq kk nr ko ns ks nk nl nm nn bi translated">Urql中的默认缓存策略是文档缓存，您也可以使用规范化缓存来防止不必要的调用，并告诉Urql在发生突变后需要进行哪些更新。</li></ul><figure class="ly lz ma mb gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nt"><img src="../Images/ccfe7ada48d853f8df9f40a73069b891.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9b8sTXIx78Q_bhKEL00F2g.jpeg"/></div></div></figure><p id="1197" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated">这是我的第一篇技术博客，我希望你喜欢，如果你对我有任何反馈，请在评论中告诉我。</p><p id="eede" class="pw-post-body-paragraph jv jw in jx b jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks ig bi translated"><em class="mn">更多内容请看</em><a class="ae kt" href="http://plainenglish.io" rel="noopener ugc nofollow" target="_blank"><strong class="jx io"><em class="mn">plain English . io</em></strong></a></p></div></div>    
</body>
</html>