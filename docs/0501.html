<html>
<head>
<title>Google Authentication with Express and PassportJS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Express和PassportJS的Google身份验证</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/google-authentication-with-express-and-passportjs-a09a51373580?source=collection_archive---------9-----------------------#2021-01-30">https://javascript.plainenglish.io/google-authentication-with-express-and-passportjs-a09a51373580?source=collection_archive---------9-----------------------#2021-01-30</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="b912" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">建立一个登录页面，并使用Express和Passport通过谷歌认证用户。</h2></div><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi kc"><img src="../Images/b5c30eb9ac58da3fbe6178f3af648712.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*c3Hx2zRvsS7SA0cdX7HfFA.jpeg"/></div></div></figure><p id="ee7a" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">创建一个账户(或者登录)从来都不是用户<em class="lk">想要</em>花时间去做的事情，他们只是想开始点击你的新的酷炫应用。抛开对谷歌的任何个人感受，拥有一个“登录谷歌”或“注册谷歌”确实可以消除认证过程中的一些摩擦。</p><p id="b5d3" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">当我们使用Google APIs让用户登录时，流程如下所示:</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi ll"><img src="../Images/90ba422e7f52f6d77a3ca61b9ea654f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2b45zCF2VuHAHxORPt_h1w.jpeg"/></div></div></figure><ol class=""><li id="85cb" class="lm ln in kq b kr ks ku kv kx lo lb lp lf lq lj lr ls lt lu bi translated">服务器发送<code class="fe lv lw lx ly b">/login</code>页面</li><li id="6157" class="lm ln in kq b kr lz ku ma kx mb lb mc lf md lj lr ls lt lu bi translated">用户点击“使用谷歌登录”</li><li id="a1f5" class="lm ln in kq b kr lz ku ma kx mb lb mc lf md lj lr ls lt lu bi translated">服务器发送谷歌登录页面</li><li id="8703" class="lm ln in kq b kr lz ku ma kx mb lb mc lf md lj lr ls lt lu bi translated">用户使用Google登录</li><li id="33a2" class="lm ln in kq b kr lz ku ma kx mb lb mc lf md lj lr ls lt lu bi translated">Google API将用户的详细信息发送给服务器</li><li id="f661" class="lm ln in kq b kr lz ku ma kx mb lb mc lf md lj lr ls lt lu bi translated">服务器让用户登录并重定向到应用程序路径(或将他们发送回登录页面)</li><li id="15ba" class="lm ln in kq b kr lz ku ma kx mb lb mc lf md lj lr ls lt lu bi translated">服务器向用户发送应用页面</li></ol><p id="bec1" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">为了完成这个IRL，我们将使用<strong class="kq io"> Express </strong>来设置我们的服务器和非常<em class="lk"> </em> basic(比如，<em class="lk">非常</em> basic)客户端，以及用于服务器认证的<strong class="kq io"> PassportJS </strong>。我们的“客户”将由两个简单得荒谬的页面来表示，我们稍后会看到:<code class="fe lv lw lx ly b">/</code>和<code class="fe lv lw lx ly b">/login</code>。为了简洁起见，我们也将对数据库进行硬编码。</p><h1 id="63e8" class="me mf in bd mg mh mi mj mk ml mm mn mo jt mp ju mq jw mr jx ms jz mt ka mu mv bi translated">Google API设置</h1><p id="c259" class="pw-post-body-paragraph ko kp in kq b kr mw jo kt ku mx jr kw kx my kz la lb mz ld le lf na lh li lj ig bi translated">首先，我们必须在谷歌上设置我们的应用程序。前往您的<a class="ae nb" href="https://console.developers.google.com" rel="noopener ugc nofollow" target="_blank"> Google开发者控制台</a>，然后通过左上角的下拉菜单创建一个新的<strong class="kq io">项目</strong>:</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi nc"><img src="../Images/5be4afb88a363deec666d8313ea2e6c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*r4gjh24CBafRD-sHaXvMBg.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk">Select dropdown to change or create a new project.</figcaption></figure><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi nc"><img src="../Images/cc17233aefd6547adbd85caeb556aa7c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pvhSc1LI7fvLlDUapX-pVQ.png"/></div></div><figcaption class="nd ne gj gh gi nf ng bd b be z dk">Select “New Project”</figcaption></figure><p id="e9b5" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">一旦您创建了新项目(或者选择了一个现有项目)，您就可以通过单击<strong class="kq io"> Credentials </strong>来生成您的凭证。</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi nh"><img src="../Images/80d192203c00b39227b6a8bb245f4fce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rTwTigbWikV5vGCVJKxhWg.png"/></div></div></figure><p id="f480" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">心理！在你继续下一步之前，谷歌希望你配置你的“同意屏幕”。同意屏幕是用户点击你的“用谷歌登录”按钮后看到的。这里有一个在Dropbox.com<a class="ae nb" href="https://www.dropbox.com/" rel="noopener ugc nofollow" target="_blank">点击“注册谷歌”后显示的同意屏幕的例子:</a></p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi ni"><img src="../Images/d379979b5ed4bd218b4e86dc80ef0844.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IEhW7yT5oH0e9sLw5IpJHg.png"/></div></div></figure><p id="063f" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">实际上，在配置您的同意屏幕时，有数量惊人的障碍需要跳过。你必须提供像申请主页，隐私政策页，条款和条件页等东西。你现在可以捏造这些，但是当实际配置你的应用程序时，你会想要/需要把它们指向真正的页面。</p><p id="44de" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">对于“范围”，确保检查<code class="fe lv lw lx ly b">…/auth/userinfo.email</code>的非敏感范围，因为我们至少需要它。如果你需要像名和姓这样的信息，你也可以查一下<code class="fe lv lw lx ly b">…/auth/userinfo.profile</code>。</p><p id="add3" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">配置好同意屏幕后，<em class="lk">现在</em>您应该可以转到“<strong class="kq io">凭据”、“T25”，然后是“创建凭据”，然后是“OAuth客户端ID”</strong></p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi nj"><img src="../Images/ded2c29595c22874fae0a83f8bd1e1e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kYIX_tA5DwlRWKade21EBw.png"/></div></div></figure><p id="75cd" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">选择“Web应用程序”并为您的应用程序命名。最后，让我们添加“授权的JavaScript源”和“授权的重定向URIs”前者是授权的<em class="lk">客户端</em>起源，这告诉Google预期登录请求来自哪里，后者告诉Google成功登录后将用户信息发送到哪里。</p><p id="3935" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated"><strong class="kq io">授权的JavaScript起源</strong></p><ul class=""><li id="c39f" class="lm ln in kq b kr ks ku kv kx lo lb lp lf lq lj nk ls lt lu bi translated">这是谷歌可以预期的请求来源。</li></ul><p id="29bf" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated"><strong class="kq io">授权重定向URIs </strong></p><ul class=""><li id="8948" class="lm ln in kq b kr ks ku kv kx lo lb lp lf lq lj nk ls lt lu bi translated"><code class="fe lv lw lx ly b">http://localhost:8080/auth/google/callback</code> —这是Google在成功登录后发送给用户信息的URI。</li></ul><blockquote class="nl nm nn"><p id="c380" class="ko kp lk kq b kr ks jo kt ku kv jr kw no ky kz la np lc ld le nq lg lh li lj ig bi translated">将<code class="fe lv lw lx ly b">localhost</code>添加到您授权的JavaScript源或重定向中并不理想，所以您需要确保在投入生产时移除它们或者用真实的东西替换它们，例如<code class="fe lv lw lx ly b">https://mycoolapp.io</code>和<code class="fe lv lw lx ly b">https://mycoolapp.io/auth/google/callback</code>。</p></blockquote><h1 id="7ee7" class="me mf in bd mg mh mi mj mk ml mm mn mo jt mp ju mq jw mr jx ms jz mt ka mu mv bi translated">计算机网络服务器</h1><p id="c177" class="pw-post-body-paragraph ko kp in kq b kr mw jo kt ku mx jr kw kx my kz la lb mz ld le lf na lh li lj ig bi translated">我们将使用<code class="fe lv lw lx ly b">express</code>作为我们的服务器，所以让我们把它和其他一些好东西一起安装:</p><pre class="kd ke kf kg gt nr ly ns nt aw nu bi"><span id="0340" class="nv mf in ly b gy nw nx l ny nz">yarn add express express-session dotenv morgan passport passport-google-oauth20</span></pre><p id="7e8c" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">安装完成后，使用以下信息在我们的应用程序根目录下创建一个<code class="fe lv lw lx ly b">.env</code>文件:</p><pre class="kd ke kf kg gt nr ly ns nt aw nu bi"><span id="c08d" class="nv mf in ly b gy nw nx l ny nz">PORT=8080</span><span id="cd4b" class="nv mf in ly b gy oa nx l ny nz">GOOGLE_CLIENT_ID=YOUR_CLIENT_ID</span><span id="62e5" class="nv mf in ly b gy oa nx l ny nz">GOOGLE_CLIENT_SECRET=YOUR_CLIENT_SECRET</span><span id="a5d7" class="nv mf in ly b gy oa nx l ny nz">SESSION_SECRET=SOME_STRING_THATS_IDEALLY_NOT_EASY_TO_GUESS</span></pre><p id="d01d" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">文件是我们放置环境变量和敏感令牌和/或秘密的地方。话虽如此，也要确保将其添加到您的<code class="fe lv lw lx ly b">.gitignore</code>文件中——我们肯定<em class="lk">不想</em>提交<code class="fe lv lw lx ly b">.env</code>文件！然后从Google开发者控制台用您各自的客户端<code class="fe lv lw lx ly b">id</code>和<code class="fe lv lw lx ly b">secret</code>填充它。此外，继续为您的会话秘密添加一个随机散列。</p><p id="0edd" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">酷酷酷。接下来，我们将创建设置服务器和处理请求的<code class="fe lv lw lx ly b">server.js</code>文件。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="ob oc l"/></div></figure><p id="010d" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">对于我们的<code class="fe lv lw lx ly b">server.js</code>文件，首先我们需要带有便利的<code class="fe lv lw lx ly b">dotenv</code>包的<code class="fe lv lw lx ly b">.env</code>文件，这使得<code class="fe lv lw lx ly b">.env</code>中的环境变量可以通过<code class="fe lv lw lx ly b">process.env</code>访问，例如<code class="fe lv lw lx ly b">process.env.PORT</code>。接下来我们<code class="fe lv lw lx ly b">require</code>所有的express server essentials，以及来自PassportJS的<code class="fe lv lw lx ly b">passport</code>。</p><p id="0e17" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">至于实际的螺母和螺栓，我们使用<code class="fe lv lw lx ly b">express</code>来创建我们的应用程序:</p><pre class="kd ke kf kg gt nr ly ns nt aw nu bi"><span id="288e" class="nv mf in ly b gy nw nx l ny nz">const app = express();</span></pre><p id="4a63" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">在初始化我们的<code class="fe lv lw lx ly b">app</code>之后，我们为<code class="fe lv lw lx ly b">passport</code>运行一些基本的设置，我把它移到了它自己的独立模块<code class="fe lv lw lx ly b">./passport/setup.js</code>中。这一点会更有意义，所以我们现在跳过解释。</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="ob oc l"/></div></figure><p id="3fec" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">然后我们设置我们的<code class="fe lv lw lx ly b">bodyParser</code>和<code class="fe lv lw lx ly b">logger</code>，这两个都是一个express应用程序所必需的。</p><p id="e05b" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">接下来，我们为我们的应用程序设置基本会话，在成功登录后，允许用户在对服务器的后续请求中保持登录。</p><p id="c681" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">之后，我们在<code class="fe lv lw lx ly b">passport.initialize</code>上调用<code class="fe lv lw lx ly b">app.use</code>以及<code class="fe lv lw lx ly b">passport.session</code>。前者初始化<code class="fe lv lw lx ly b">passport</code>，后者是使用我们之前在<code class="fe lv lw lx ly b">passport/setup.js</code>中定义的<code class="fe lv lw lx ly b">passport.serializeUser</code>和<code class="fe lv lw lx ly b">passport.deserializeUser</code>的中间件。</p><p id="4b2c" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">跳回到<code class="fe lv lw lx ly b">passport/setup.js</code>，<code class="fe lv lw lx ly b">serializeUser</code>获取我们的用户对象的<code class="fe lv lw lx ly b">id</code>属性，并将其存储在会话中以备后用。另一方面，<code class="fe lv lw lx ly b">deserializeUser</code>从会话中提供<code class="fe lv lw lx ly b">id</code>，然后使用它在数据库中查找用户的数据。一旦我们有了用户对象，我们就将它设置为<code class="fe lv lw lx ly b">req</code>对象的<code class="fe lv lw lx ly b">user</code>属性。这允许我们通过路径中的<code class="fe lv lw lx ly b">req.user</code>访问<code class="fe lv lw lx ly b">user</code>对象！</p><p id="a0f7" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">接下来我们实际上注册了Google passport“策略”，我也把它放到了<code class="fe lv lw lx ly b">./passport/strategies.js</code>的一个独立模块中:</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="ob oc l"/></div></figure><p id="2178" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">PassportJS <code class="fe lv lw lx ly b">GoogleStrategy</code>接受您的<code class="fe lv lw lx ly b">clientID</code>、<code class="fe lv lw lx ly b">clientSecret</code>和<code class="fe lv lw lx ly b">callbackURL</code>(与我们在Google开发者控制台中定义的授权重定向URI完全相同)。它使用这些凭证向Google API确认请求是合法的。</p><p id="d9e7" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">最后，为了给我们的<code class="fe lv lw lx ly b">server</code>打上一个漂亮的蝴蝶结，我们定义了一些<code class="fe lv lw lx ly b">GET</code>路线。</p><p id="33d0" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated"><code class="fe lv lw lx ly b">GET auth/google</code>—当用户点击“使用Google登录”按钮时，该路径用于处理来自客户端的请求。然后它调用<code class="fe lv lw lx ly b">passport.authenticate</code>，将用户发送到同意和登录屏幕。我们也传入我们想要的<code class="fe lv lw lx ly b">scopes</code>。</p><p id="a2fd" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated"><code class="fe lv lw lx ly b">GET auth/google/callback</code> —如果用户成功登录Google，Google API会向该路由发送一个<code class="fe lv lw lx ly b">GET</code>请求，记得我们也在Google控制台上将其添加到“授权重定向URIs”列表中。此时调用<code class="fe lv lw lx ly b">./passport/strategies.js</code>中为<code class="fe lv lw lx ly b">GoogleStrategy</code>定义的回调函数，参数为<code class="fe lv lw lx ly b">accessToken</code>、<code class="fe lv lw lx ly b">refreshToken</code>、<code class="fe lv lw lx ly b">data</code>和<code class="fe lv lw lx ly b">done</code>。</p><p id="79f3" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">在登录流程的这一点上，我们检查数据库中是否存在该用户。一件事——我们没有数据库🤔。我们不是建立一个合适的数据库，而是模拟一个，就像这样:</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="ob oc l"/></div></figure><p id="6a35" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">如你所见，它非常复杂。回头看看<code class="fe lv lw lx ly b">strategies.js</code>，我们从Google API收到的<code class="fe lv lw lx ly b">data</code>对象包含所有用户感兴趣的内容，嗯，我们在<code class="fe lv lw lx ly b">scopes</code>中请求的内容，比如<code class="fe lv lw lx ly b">name</code>、<code class="fe lv lw lx ly b">email</code>等。您可能想要仔细检查数据模式，但是在编写本文时，<code class="fe lv lw lx ly b">_json</code>属性包含我们正在寻找的<code class="fe lv lw lx ly b">email</code>属性。使用我们超级复杂的数据库数组，我们运行一个<code class="fe lv lw lx ly b">find</code>来寻找具有匹配<code class="fe lv lw lx ly b">email</code>属性的用户。确保您更新了上面的模拟数据库，以便其中一个用户拥有您的Google电子邮件。我们找到具有匹配<code class="fe lv lw lx ly b">email</code>的用户，并调用<code class="fe lv lw lx ly b">done</code>，它将<code class="fe lv lw lx ly b">string | Error</code>作为错误处理的第一个参数，将<code class="fe lv lw lx ly b">user</code>对象作为第二个参数。</p><blockquote class="nl nm nn"><p id="092b" class="ko kp lk kq b kr ks jo kt ku kv jr kw no ky kz la np lc ld le nq lg lh li lj ig bi translated">这是您使用您选择的数据库进行真正的数据库查找的地方。我一般使用<code class="fe lv lw lx ly b">MongoDB</code>，但是当然你可以在这里选择你自己的冒险(除了硬编码你的用户……不要那样做)。</p></blockquote><p id="f68d" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">当我们登录我们的用户并调用<code class="fe lv lw lx ly b">done(null, user)</code>时，<code class="fe lv lw lx ly b">passport.serializeUser</code>被调用，我们将用户的<code class="fe lv lw lx ly b">id</code>存储在会话中。每一个随后进来的请求现在也将通过<code class="fe lv lw lx ly b">passport.deserializeUser</code>，这将把<code class="fe lv lw lx ly b">user</code>添加到<code class="fe lv lw lx ly b">req</code>对象中。</p><p id="cb1d" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">最后，如果我们已经成功登录，我们的<code class="fe lv lw lx ly b">GET auth/google/callback</code>中的回调函数被调用，然后我们重定向到我们的应用页面(<code class="fe lv lw lx ly b">/</code>)。</p><p id="3505" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated"><code class="fe lv lw lx ly b">GET /</code>——这是我们的索引路线，我们在这里发送“应用程序页面”，只有登录的用户才能使用(这不是什么应用程序……但你明白了)。我们检查<code class="fe lv lw lx ly b">req</code>对象是否包含<code class="fe lv lw lx ly b">user</code>属性。如果是，用户已经登录，否则我们从<code class="fe lv lw lx ly b">redirect</code>到<code class="fe lv lw lx ly b">/login</code>。最后，我们向客户发送了一条可爱的问候信息和一个注销按钮。</p><p id="52e4" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated"><code class="fe lv lw lx ly b">GET /login</code>——这是我们的登录页面——同样，不是很大的页面。无论如何，用谷歌按钮点击我们的登录向<code class="fe lv lw lx ly b">auth/google</code>发送一个<code class="fe lv lw lx ly b">GET</code>请求，这启动了我们的整个登录流程。与我们的<code class="fe lv lw lx ly b">/</code>路线类似，我们检查<code class="fe lv lw lx ly b">user</code>属性是否存在，如果存在，则用户登录，我们<code class="fe lv lw lx ly b">redirect</code>到<code class="fe lv lw lx ly b">/</code>(即“应用”)。如果没有，我们会再次显示登录页面。</p><p id="4247" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated"><code class="fe lv lw lx ly b">GET /logout</code>——调用该路由时，我们调用<code class="fe lv lw lx ly b">req.logout</code>，它是由<code class="fe lv lw lx ly b">passport</code>添加到req对象中的。这将删除用户的会话并将其注销。然后我们<code class="fe lv lw lx ly b">redirect</code>回到<code class="fe lv lw lx ly b">/login</code>页。</p><p id="f0c6" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">就这样！我们应该准备好摇滚了。启动您的服务器:</p><pre class="kd ke kf kg gt nr ly ns nt aw nu bi"><span id="1c90" class="nv mf in ly b gy nw nx l ny nz">node server</span></pre><p id="dab5" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">如果一切顺利，你应该可以登录谷歌了，哈哈！</p><h2 id="2dc2" class="nv mf in bd mg od oe dn mk of og dp mo kx oh oi mq lb oj ok ms lf ol om mu on bi translated">其他登录方式</h2><p id="37ef" class="pw-post-body-paragraph ko kp in kq b kr mw jo kt ku mx jr kw kx my kz la lb mz ld le lf na lh li lj ig bi translated">只允许你的用户使用谷歌登录并不是最好的体验。您可能想要实现一个普通的基于密码的登录，以及其他潜在的“使用[some_service]登录”。要添加基于密码的登录，您可以再次通过<code class="fe lv lw lx ly b">passport</code><code class="fe lv lw lx ly b"><a class="ae nb" href="http://www.passportjs.org/packages/passport-local/" rel="noopener ugc nofollow" target="_blank">passport-local</a></code>使用，并以类似于我们的<code class="fe lv lw lx ly b">GoogleStrategy</code>的方式注册另一个策略。</p><h1 id="fffb" class="me mf in bd mg mh mi mj mk ml mm mn mo jt mp ju mq jw mr jx ms jz mt ka mu mv bi translated">摘要</h1><p id="5423" class="pw-post-body-paragraph ko kp in kq b kr mw jo kt ku mx jr kw kx my kz la lb mz ld le lf na lh li lj ig bi translated">这是如何使用<code class="fe lv lw lx ly b">node</code>设置服务器和使用<code class="fe lv lw lx ly b">passport</code>处理谷歌认证的简单介绍。现在，您必须决定您的数据库以及应用程序的实际前端框架。</p><p id="6b84" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">感谢您的阅读，并一如既往地——希望您学到了一些东西！</p><p id="a70b" class="pw-post-body-paragraph ko kp in kq b kr ks jo kt ku kv jr kw kx ky kz la lb lc ld le lf lg lh li lj ig bi translated">这是我们新登陆谷歌应用的Github报告🚀</p><ul class=""><li id="bf1c" class="lm ln in kq b kr ks ku kv kx lo lb lp lf lq lj nk ls lt lu bi translated"><a class="ae nb" href="https://github.com/tmarshall07/google-auth-login" rel="noopener ugc nofollow" target="_blank"><strong class="kq io"/>https://github.com/tmarshall07/google-auth-login</a></li></ul><h1 id="08f5" class="me mf in bd mg mh mi mj mk ml mm mn mo jt mp ju mq jw mr jx ms jz mt ka mu mv bi translated">资源</h1><ul class=""><li id="0e6e" class="lm ln in kq b kr mw ku mx kx oo lb op lf oq lj nk ls lt lu bi translated">【https://console.developers.google.com/ T4】</li><li id="d99d" class="lm ln in kq b kr lz ku ma kx mb lb mc lf md lj nk ls lt lu bi translated"><a class="ae nb" href="http://www.passportjs.org/docs/google/" rel="noopener ugc nofollow" target="_blank">http://www.passportjs.org/docs/google/</a></li><li id="2109" class="lm ln in kq b kr lz ku ma kx mb lb mc lf md lj nk ls lt lu bi translated"><a class="ae nb" href="http://expressjs.com/" rel="noopener ugc nofollow" target="_blank">http://expressjs.com/</a></li><li id="3d47" class="lm ln in kq b kr lz ku ma kx mb lb mc lf md lj nk ls lt lu bi translated"><a class="ae nb" href="https://github.com/tmarshall07/google-auth-login" rel="noopener ugc nofollow" target="_blank">https://github.com/tmarshall07/google-auth-login</a></li></ul></div></div>    
</body>
</html>