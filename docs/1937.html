<html>
<head>
<title>Secure an Angular Single-Page Application with Keycloak</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Keycloak保护一个有角度的单页应用程序</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/secure-an-angular-single-page-application-with-keycloak-cdbe5026881e?source=collection_archive---------0-----------------------#2021-04-23">https://javascript.plainenglish.io/secure-an-angular-single-page-application-with-keycloak-cdbe5026881e?source=collection_archive---------0-----------------------#2021-04-23</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/c7d30820d27f5440f4db76c0727a9f4b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*N4hmB_qA6QIL0PT84_8qbg.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Keycloak Integration in Web(Angular) Application — Module Design</figcaption></figure><h2 id="e15d" class="jz ka in bd kb kc kd dn ke kf kg dp kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated"><strong class="ak">简介</strong></h2><p id="a697" class="pw-post-body-paragraph kv kw in kx b ky kz la lb lc ld le lf ki lg lh li km lj lk ll kq lm ln lo lp ig bi translated">当您想要开发一个企业应用程序或者您有许多客户端(web-js、移动平台)并且想要动态地创建和管理它们时，Keycloak非常有用。</p><p id="5de7" class="pw-post-body-paragraph kv kw in kx b ky lq la lb lc lr le lf ki ls lh li km lt lk ll kq lu ln lo lp ig bi translated">此外，当您与第三方系统(谷歌、脸书、推特等)进行大量集成时，key loak非常有用，因为key loak有现成的系统。或者如果/当您需要与某个SAML或LDAP提供程序集成时。</p><p id="b108" class="pw-post-body-paragraph kv kw in kx b ky lq la lb lc lr le lf ki ls lh li km lt lk ll kq lu ln lo lp ig bi translated">如果您需要一些身份和用户管理平台，并且您有复杂的用户访问流程，您可以使用Keycloak。</p><p id="6c8c" class="pw-post-body-paragraph kv kw in kx b ky lq la lb lc lr le lf ki ls lh li km lt lk ll kq lu ln lo lp ig bi translated">最后，如果您需要单点登录功能，您也可以考虑使用Keycloak。一旦登录到Keycloak，用户就不必再次登录来访问不同的应用程序。</p><h2 id="485c" class="jz ka in bd kb kc kd dn ke kf kg dp kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated"><strong class="ak">钥匙卡服务器安装</strong></h2><p id="d19d" class="pw-post-body-paragraph kv kw in kx b ky kz la lb lc ld le lf ki lg lh li km lj lk ll kq lm ln lo lp ig bi translated">安装Keycloak就像下载并解压一样简单。你可以在Linux或Windows上安装服务器。服务器下载ZIP文件包含运行Keycloak服务器的脚本和二进制文件，更多详细信息请查看<a class="ae lv" href="https://www.keycloak.org/docs/latest/getting_started/index.html" rel="noopener ugc nofollow" target="_blank">入门指南</a>。</p><ol class=""><li id="d863" class="lw lx in kx b ky lq lc lr ki ly km lz kq ma lp mb mc md me bi translated"><a class="ae lv" href="https://www.keycloak.org/getting-started/getting-started-kube" rel="noopener ugc nofollow" target="_blank">Kubernetes上的key floak</a></li><li id="3351" class="lw lx in kx b ky mf lc mg ki mh km mi kq mj lp mb mc md me bi translated"><a class="ae lv" href="https://www.keycloak.org/getting-started/getting-started-docker" rel="noopener ugc nofollow" target="_blank">码头工人须知</a></li></ol><figure class="ml mm mn mo gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mk"><img src="../Images/69e0df09ec7f991dc73d88fa9fcb03de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RfG8iXvGaEgcd02wKXYCqw.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk"><a class="ae lv" href="https://www.keycloak.org/downloads" rel="noopener ugc nofollow" target="_blank">https://www.keycloak.org/downloads</a></figcaption></figure></div><div class="ab cl mp mq hr mr" role="separator"><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu"/></div><div class="ig ih ii ij ik"><h2 id="9c05" class="jz ka in bd kb kc kd dn ke kf kg dp kh ki kj kk kl km kn ko kp kq kr ks kt ku bi translated">角度应用中的集成键帽</h2><p id="7c3c" class="pw-post-body-paragraph kv kw in kx b ky kz la lb lc ld le lf ki lg lh li km lj lk ll kq lm ln lo lp ig bi translated"><strong class="kx io">第1步</strong> — <strong class="kx io">创建新的角度项目</strong></p><p id="62c6" class="pw-post-body-paragraph kv kw in kx b ky lq la lb lc lr le lf ki ls lh li km lt lk ll kq lu ln lo lp ig bi translated">您可以使用Angular CLI创建一个新项目，或者克隆我为了理解集成而创建的现有<a class="ae lv" href="https://github.com/santoshshinde2012/ng-keycloak.git" rel="noopener ugc nofollow" target="_blank">ng-key floak</a>存储库。</p><div class="mw mx gp gr my mz"><a href="https://github.com/santoshshinde2012/ng-keycloak" rel="noopener  ugc nofollow" target="_blank"><div class="na ab fo"><div class="nb ab nc cl cj nd"><h2 class="bd io gy z fp ne fr fs nf fu fw im bi translated">santoshshinde 2012/ng-key floak</h2><div class="ng l"><h3 class="bd b gy z fp ne fr fs nf fu fw dk translated">该项目是使用Angular CLI版本11.2.8生成的。为开发服务器运行ng服务。导航到…</h3></div><div class="nh l"><p class="bd b dl z fp ne fr fs nf fu fw dk translated">github.com</p></div></div><div class="ni l"><div class="nj l nk nl nm ni nn jt mz"/></div></div></a></div><pre class="ml mm mn mo gt no np nq nr aw ns bi"><span id="9d3b" class="jz ka in np b gy nt nu l nv nw">ng new ng-keycloak <strong class="np io">OR</strong></span><span id="e872" class="jz ka in np b gy nx nu l nv nw">git clone https://github.com/santoshshinde2012/ng-keycloak.git</span></pre><figure class="ml mm mn mo gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi ny"><img src="../Images/fe4a26eaaff25cfa080d75fe03b903a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tlCdLjOyQCB0Y1BB66ws4g.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Create a new Angular Application</figcaption></figure><p id="73e0" class="pw-post-body-paragraph kv kw in kx b ky lq la lb lc lr le lf ki ls lh li km lt lk ll kq lu ln lo lp ig bi translated"><strong class="kx io">第2步</strong> — <strong class="kx io">安装所需的依赖项</strong></p><p id="88a1" class="pw-post-body-paragraph kv kw in kx b ky lq la lb lc lr le lf ki ls lh li km lt lk ll kq lu ln lo lp ig bi translated"><strong class="kx io">客户端适配器</strong>:key loak客户端适配器是一些库，它们使得使用key loak保护应用程序和服务变得非常容易。我们称它们为适配器而不是库，因为它们提供了与底层平台和框架的紧密集成。这使得我们的适配器易于使用，并且它们需要的样板代码比库通常需要的要少。</p><p id="c606" class="pw-post-body-paragraph kv kw in kx b ky lq la lb lc lr le lf ki ls lh li km lt lk ll kq lu ln lo lp ig bi translated">Keycloak附带一个客户端JavaScript库<a class="ae lv" href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_javascript_adapter" rel="noopener ugc nofollow" target="_blank"/>，可以用来保护HTML5/JavaScript应用程序的安全。JavaScript适配器内置了对Cordova应用程序的支持。</p><pre class="ml mm mn mo gt no np nq nr aw ns bi"><span id="0a7c" class="jz ka in np b gy nt nu l nv nw">npm install --save keycloak-angular keycloak-js</span></pre><figure class="ml mm mn mo gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nz"><img src="../Images/2b23af6ae9393cd5db166edd4b1d4593.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KljY3IzAcLMPRUp99rLgnw.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk"><strong class="bd oa">Install the required dependency</strong></figcaption></figure><p id="b88a" class="pw-post-body-paragraph kv kw in kx b ky lq la lb lc lr le lf ki ls lh li km lt lk ll kq lu ln lo lp ig bi translated"><strong class="kx io">步骤3 —创建基于环境的键盘锁配置</strong></p><p id="ae8e" class="pw-post-body-paragraph kv kw in kx b ky lq la lb lc lr le lf ki ls lh li km lt lk ll kq lu ln lo lp ig bi translated">我们将在<code class="fe ob oc od np b">environments</code> <em class="oe"> </em>文件夹中创建<code class="fe ob oc od np b">keycloak.config.ts</code> <em class="oe"> </em>文件，以便从环境中获取配置。</p><figure class="ml mm mn mo gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi of"><img src="../Images/b355fc5885c77ba579d1674b0922d271.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OPG5Knzz-56sCjoXab5WtA.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk"><strong class="bd oa">Create Environment based keycloak configuration</strong></figcaption></figure><p id="1f34" class="pw-post-body-paragraph kv kw in kx b ky lq la lb lc lr le lf ki ls lh li km lt lk ll kq lu ln lo lp ig bi translated"><strong class="kx io">第四步——创建授权模块来处理钥匙锁相关的东西</strong></p><pre class="ml mm mn mo gt no np nq nr aw ns bi"><span id="e96f" class="jz ka in np b gy nt nu l nv nw">ng generate module auth</span></pre><figure class="ml mm mn mo gt jo gh gi paragraph-image"><div class="gh gi og"><img src="../Images/0cb91965b597cfafc34cce3b68fbf701.png" data-original-src="https://miro.medium.com/v2/resize:fit:1132/format:webp/1*TBKop8BztOSwVmWLJi3Now.png"/></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk"><strong class="bd oa">Create Auth Module to Handle Keycloak Related Stuff</strong></figcaption></figure><p id="0d97" class="pw-post-body-paragraph kv kw in kx b ky lq la lb lc lr le lf ki ls lh li km lt lk ll kq lu ln lo lp ig bi translated"><strong class="kx io">第五步——键盘锁初始化</strong></p><p id="f431" class="pw-post-body-paragraph kv kw in kx b ky lq la lb lc lr le lf ki ls lh li km lt lk ll kq lu ln lo lp ig bi translated">在Auth，module中创建文件<code class="fe ob oc od np b">keycloak-initializer.ts </code>来处理Keycloak的初始化。</p><figure class="ml mm mn mo gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi oh"><img src="../Images/6e78bf092ea347b862026078bdad061a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*E32qJ4QrLjXBu5m3ZbZ3OA.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk"><strong class="bd oa">keycloak Initialization</strong></figcaption></figure><p id="7ecd" class="pw-post-body-paragraph kv kw in kx b ky lq la lb lc lr le lf ki ls lh li km lt lk ll kq lu ln lo lp ig bi translated"><strong class="kx io">步骤6 —在认证模块中创建认证服务，处理认证事务</strong></p><p id="7dcd" class="pw-post-body-paragraph kv kw in kx b ky lq la lb lc lr le lf ki ls lh li km lt lk ll kq lu ln lo lp ig bi translated">Auth Service将处理与keycloak服务方法的身份验证和实现相关的所有操作。</p><pre class="ml mm mn mo gt no np nq nr aw ns bi"><span id="451f" class="jz ka in np b gy nt nu l nv nw">ng generate service auth/service/Auth</span></pre><figure class="ml mm mn mo gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi oi"><img src="../Images/7cda552d837d5e1625faabab6e02d2d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5pxB1VU8JZs_wxiRLCuf7A.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk"><strong class="bd oa">Keycloak Auth Service</strong></figcaption></figure><p id="36d8" class="pw-post-body-paragraph kv kw in kx b ky lq la lb lc lr le lf ki ls lh li km lt lk ll kq lu ln lo lp ig bi translated"><strong class="kx io">第7步—创建授权保护</strong></p><p id="11c6" class="pw-post-body-paragraph kv kw in kx b ky lq la lb lc lr le lf ki ls lh li km lt lk ll kq lu ln lo lp ig bi translated">Angular的route guards是可以告诉路由器是否应该允许导航到所请求的路由的接口。他们通过寻找一个<code class="fe ob oc od np b">true</code>或<code class="fe ob oc od np b">false</code>从一个实现给定guard接口的类返回的值来做出这个决定。</p><p id="7cac" class="pw-post-body-paragraph kv kw in kx b ky lq la lb lc lr le lf ki ls lh li km lt lk ll kq lu ln lo lp ig bi translated">我们必须在扩展了<code class="fe ob oc od np b">KeycloakAuthGuard</code>的<code class="fe ob oc od np b">AuthModule</code>中创建<code class="fe ob oc od np b">AuthGuard</code>。提供了一个通用的<code class="fe ob oc od np b">AuthGuard</code>、<code class="fe ob oc od np b">KeycloakAuthGuard</code>来帮助您保护应用程序中的认证路由。该防护为您提供了查看用户是否登录的信息以及属于该用户的角色列表。在您的实现中，您只需要实现所需的逻辑来保护您的路由。</p><figure class="ml mm mn mo gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi oj"><img src="../Images/18513b7ee6c73606e82850c2b897a4c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*n6GLIxX-eu7KRlw-4oZZVA.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Keycloak Auth Guard</figcaption></figure><p id="491b" class="pw-post-body-paragraph kv kw in kx b ky lq la lb lc lr le lf ki ls lh li km lt lk ll kq lu ln lo lp ig bi translated"><strong class="kx io">步骤8—导入KeycloakAngularModule并在AuthModule中注册提供者KeyloackService</strong></p><p id="4f0a" class="pw-post-body-paragraph kv kw in kx b ky lq la lb lc lr le lf ki ls lh li km lt lk ll kq lu ln lo lp ig bi translated">为了确保Keycloak在你的应用程序启动时被初始化，你必须添加一个<code class="fe ob oc od np b">APP_INITIALIZER</code>提供者到你的<code class="fe ob oc od np b">AppModule</code>中。这个提供者将调用下面显示的工厂函数<code class="fe ob oc od np b">initializer</code>,它将设置Keycloak服务，以便可以在您的应用程序中使用它。</p><figure class="ml mm mn mo gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi ok"><img src="../Images/e7547eedd8d6b93026de00dbab95923e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7UQCO33ju2Xbk1t1aYB_mQ.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk"><strong class="bd oa">Import KeycloakAngularModule and Register Provider KeyloackService in AuthModule</strong></figcaption></figure><p id="94e0" class="pw-post-body-paragraph kv kw in kx b ky lq la lb lc lr le lf ki ls lh li km lt lk ll kq lu ln lo lp ig bi translated"><strong class="kx io">步骤9 —在主应用模块</strong>中导入授权模块</p><figure class="ml mm mn mo gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi ol"><img src="../Images/e862022ecf0f6ab86a08fdf4b4e132e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3IgoQ5EAs9YWggoc3YuP9g.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk"><strong class="bd oa">Import AuthModule in main AppModule</strong></figcaption></figure><p id="742f" class="pw-post-body-paragraph kv kw in kx b ky lq la lb lc lr le lf ki ls lh li km lt lk ll kq lu ln lo lp ig bi translated"><strong class="kx io">步骤10 —路由模块配置</strong></p><p id="a3a2" class="pw-post-body-paragraph kv kw in kx b ky lq la lb lc lr le lf ki ls lh li km lt lk ll kq lu ln lo lp ig bi translated">我们将创建一个具有自己路由模块的三模块。</p><ol class=""><li id="05ad" class="lw lx in kx b ky lq lc lr ki ly km lz kq ma lp mb mc md me bi translated">着陆舱</li><li id="dd13" class="lw lx in kx b ky mf lc mg ki mh km mi kq mj lp mb mc md me bi translated">管理模块</li><li id="9070" class="lw lx in kx b ky mf lc mg ki mh km mi kq mj lp mb mc md me bi translated">用户模块</li></ol><figure class="ml mm mn mo gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/c7d30820d27f5440f4db76c0727a9f4b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*N4hmB_qA6QIL0PT84_8qbg.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Keycloak Integration in Web(Angular) Application — Module Design</figcaption></figure></div><div class="ab cl mp mq hr mr" role="separator"><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu"/></div><div class="ig ih ii ij ik"><ol class=""><li id="a1e8" class="lw lx in kx b ky lq lc lr ki ly km lz kq ma lp mb mc md me bi translated">创建着陆模块</li></ol><pre class="ml mm mn mo gt no np nq nr aw ns bi"><span id="704b" class="jz ka in np b gy nt nu l nv nw">ng generate module landing</span></pre><p id="d53a" class="pw-post-body-paragraph kv kw in kx b ky lq la lb lc lr le lf ki ls lh li km lt lk ll kq lu ln lo lp ig bi translated">2.用一些基本路线创建一个着陆路线模块</p><pre class="ml mm mn mo gt no np nq nr aw ns bi"><span id="9f81" class="jz ka in np b gy nt nu l nv nw">ng generate module landing/landing-routing --flat --module=landing</span></pre><p id="a9b9" class="pw-post-body-paragraph kv kw in kx b ky lq la lb lc lr le lf ki ls lh li km lt lk ll kq lu ln lo lp ig bi translated">3.创建着陆架组件</p><pre class="ml mm mn mo gt no np nq nr aw ns bi"><span id="412c" class="jz ka in np b gy nt nu l nv nw">ng generate component landing/home</span></pre><p id="2b36" class="pw-post-body-paragraph kv kw in kx b ky lq la lb lc lr le lf ki ls lh li km lt lk ll kq lu ln lo lp ig bi translated">请按照上述三个步骤创建另一个模块，如用户和管理员。</p><p id="e4f7" class="pw-post-body-paragraph kv kw in kx b ky lq la lb lc lr le lf ki ls lh li km lt lk ll kq lu ln lo lp ig bi translated">我们必须对您想要限制访问的路由使用AuthGuard，在数据属性中为每个路由分配所需的角色，角色参数作为数组。</p><figure class="ml mm mn mo gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi om"><img src="../Images/9767219a0b8f2dcd85c6bbd9e0965b94.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2zRZI_dZsneaTTd_ju1QMQ.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk"><strong class="bd oa">Routing Module Configuration</strong></figcaption></figure><p id="f11d" class="pw-post-body-paragraph kv kw in kx b ky lq la lb lc lr le lf ki ls lh li km lt lk ll kq lu ln lo lp ig bi translated"><strong class="kx io">步骤11 —运行应用程序</strong></p><pre class="ml mm mn mo gt no np nq nr aw ns bi"><span id="52a1" class="jz ka in np b gy nt nu l nv nw">npm start / ng serve</span></pre></div><div class="ab cl mp mq hr mr" role="separator"><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu"/></div><div class="ig ih ii ij ik"><p id="dede" class="pw-post-body-paragraph kv kw in kx b ky lq la lb lc lr le lf ki ls lh li km lt lk ll kq lu ln lo lp ig bi translated"><strong class="kx io">参考文献</strong></p><figure class="ml mm mn mo gt jo"><div class="bz fp l di"><div class="on oo l"/></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Easily secure your Front and back applications with KeyCloak</figcaption></figure></div><div class="ab cl mp mq hr mr" role="separator"><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu"/></div><div class="ig ih ii ij ik"><figure class="ml mm mn mo gt jo"><div class="bz fp l di"><div class="on oo l"/></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Introduction to OAuth 2.0 and OpenID Connect</figcaption></figure><p id="6858" class="pw-post-body-paragraph kv kw in kx b ky lq la lb lc lr le lf ki ls lh li km lt lk ll kq lu ln lo lp ig bi translated"><em class="oe">更多内容尽在</em><a class="ae lv" href="http://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><strong class="kx io"><em class="oe">plain English . io</em></strong></a></p></div></div>    
</body>
</html>