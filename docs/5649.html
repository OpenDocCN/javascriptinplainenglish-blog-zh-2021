<html>
<head>
<title>Test SQL With Node.js and Jest</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Node.js和Jest测试SQL</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/test-sql-with-node-js-and-jest-dde4a76213d4?source=collection_archive---------4-----------------------#2021-11-26">https://javascript.plainenglish.io/test-sql-with-node-js-and-jest-dde4a76213d4?source=collection_archive---------4-----------------------#2021-11-26</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="eda4" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">您会喜欢在您的代码库中重构这个庞大的SQL</h2></div><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi kc"><img src="../Images/2e2d255c3d2292a693dc258eb435af5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G2BZYHaYRbhUNF5jv_3Agw.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">This is how you test SQL with Jest</figcaption></figure><p id="66df" class="pw-post-body-paragraph ks kt in ku b kv kw jo kx ky kz jr la lb lc ld le lf lg lh li lj lk ll lm ln ig bi translated">假设我们想用Jest测试一个SQL查询:</p><pre class="kd ke kf kg gt lo lp lq lr aw ls bi"><span id="b5bb" class="lt lu in lp b gy lv lw l lx ly">SELECT TOP 1 MasterRetailPrice<br/>FROM UpcCollisionReport<br/>ORDER BY MasterRetailPrice DESC</span></pre><p id="41f0" class="pw-post-body-paragraph ks kt in ku b kv kw jo kx ky kz jr la lb lc ld le lf lg lh li lj lk ll lm ln ig bi translated">如果您只是运行查询，结果将是不可预测的。MasterRetailPrice表可能已经有1_000_000条记录，并且每天都在增长。</p><p id="0444" class="pw-post-body-paragraph ks kt in ku b kv kw jo kx ky kz jr la lb lc ld le lf lg lh li lj lk ll lm ln ig bi translated">我们可以在运行查询之前截断表并插入可预测的数据。这将修复第一个问题，但是，我们将创建另一个问题:我们所有的1_000_000记录将丢失。</p><p id="c875" class="pw-post-body-paragraph ks kt in ku b kv kw jo kx ky kz jr la lb lc ld le lf lg lh li lj lk ll lm ln ig bi translated">这里的解决方案很简单:</p><ul class=""><li id="ba3c" class="lz ma in ku b kv kw ky kz lb mb lf mc lj md ln me mf mg mh bi translated">我们将测试包装到一个事务中</li><li id="a28b" class="lz ma in ku b kv mi ky mj lb mk lf ml lj mm ln me mf mg mh bi translated">截断并将初始状态插入到表中</li><li id="3dd0" class="lz ma in ku b kv mi ky mj lb mk lf ml lj mm ln me mf mg mh bi translated">运行查询并返回结果</li><li id="0722" class="lz ma in ku b kv mi ky mj lb mk lf ml lj mm ln me mf mg mh bi translated">回滚事务</li></ul><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="mn mo l"/></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">This is how you test SQL with Jest</figcaption></figure><h1 id="9c63" class="mp lu in bd mq mr ms mt mu mv mw mx my jt mz ju na jw nb jx nc jz nd ka ne nf bi translated">结论</h1><p id="1439" class="pw-post-body-paragraph ks kt in ku b kv ng jo kx ky nh jr la lb ni ld le lf nj lh li lj nk ll lm ln ig bi translated">要用Jest测试SQL，您需要:事务→初始化状态→运行查询→回滚→检查结果。</p><p id="5465" class="pw-post-body-paragraph ks kt in ku b kv kw jo kx ky kz jr la lb lc ld le lf lg lh li lj lk ll lm ln ig bi translated">如果你在重构期间运行这个测试，你将会确信你没有打破任何旧的业务规则。如果您为每个部署自动运行这个测试，您将确保数据库仍然有正确的表、字段、约束等。</p><p id="8b81" class="pw-post-body-paragraph ks kt in ku b kv kw jo kx ky kz jr la lb lc ld le lf lg lh li lj lk ll lm ln ig bi translated">我希望你喜欢这篇文章，你今天会觉得更有灵感。再见。</p></div><div class="ab cl nl nm hr nn" role="separator"><span class="no bw bk np nq nr"/><span class="no bw bk np nq nr"/><span class="no bw bk np nq"/></div><div class="ig ih ii ij ik"><p id="623c" class="pw-post-body-paragraph ks kt in ku b kv kw jo kx ky kz jr la lb lc ld le lf lg lh li lj lk ll lm ln ig bi translated"><em class="ns">更多内容看</em> <a class="ae nt" href="http://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <em class="ns">说白了. io </em> </a> <em class="ns">。在这里注册我们的</em> <a class="ae nt" href="http://newsletter.plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <em class="ns">免费周报</em> </a> <em class="ns">。</em></p></div></div>    
</body>
</html>