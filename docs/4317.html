<html>
<head>
<title>How to Authenticate and Authorize an Account with OAuth 2.0 from Google Sheets</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用Google Sheets的OAuth 2.0认证和授权一个帐户</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/how-to-authenticate-and-authorize-an-account-with-oauth-2-0-from-google-sheets-8815b85f5fd9?source=collection_archive---------14-----------------------#2021-08-27">https://javascript.plainenglish.io/how-to-authenticate-and-authorize-an-account-with-oauth-2-0-from-google-sheets-8815b85f5fd9?source=collection_archive---------14-----------------------#2021-08-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/8d462af3e2eb0ca8751950dea9cc4374.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*n2OKOjh7fkH12tA4"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Photo by <a class="ae kc" href="https://unsplash.com/@matthewhenry?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Matthew Henry</a> on <a class="ae kc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="6cf4" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><a class="ae kc" href="https://www.google.com/sheets/about/" rel="noopener ugc nofollow" target="_blank"> Google Sheets </a>本身是一个巨大的工具，但是结合<a class="ae kc" href="https://developers.google.com/apps-script" rel="noopener ugc nofollow" target="_blank"> Google Apps脚本</a>，它可以通过最少的前期开发成为一个强大的托管数据库。但是数据库的好坏取决于它们与服务和应用程序集成的能力。手动导出和导入数据不可扩展，并且非常耗时。将Google Sheets与外部组件轻松集成的能力带来了无限的可能性，我将向您展示如何使用Constant Contact APIs实现这一点。</p><p id="cf08" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><a class="ae kc" href="https://www.constantcontact.com/" rel="noopener ugc nofollow" target="_blank"> Constant Contact </a>是一家在线营销公司，帮助您的企业轻松管理营销活动。它最有用和最受欢迎的服务之一是允许你管理你的联系人数据库的电子邮件活动。对于没有大量开发资源的小企业来说，使用Google Sheets是一个有吸引力的低成本解决方案，可以保存您的联系人、营销材料和所有其他相关信息。</p><p id="b0a7" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在我们深入研究从Google Sheets中认证和授权您的固定联系人帐户的技术细节之前，我们需要讨论OAuth。</p><h1 id="6b74" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">OAuth</h1><p id="109b" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">OAuth，即开放授权，是授权安全访问的领先开放标准。许多大公司使用该标准允许用户让第三方应用程序访问他们的信息，而实际上不必给第三方他们的密码。对于任何平台或生态系统来说，拥有一种安全的授权访问方式都是至关重要的。</p><p id="77cc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">OAuth很复杂。在高层次上，OAuth描述了一种用户授权第三方应用程序API访问的标准化方法。让我们来看看OAuth 1.0的工作流程:</p><figure class="mf mg mh mi gt jr gh gi paragraph-image"><div class="gh gi me"><img src="../Images/c3d2232961a2470c471e13acac3c550c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1368/format:webp/1*NeGMEXPpy-tlf8b6MXA4yg.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">A flow diagram for OAuth 1.0 (<a class="ae kc" href="https://docs.spring.io/spring-social/docs/1.1.0.RELEASE/reference/htmlsingle/#section_oauth2ServiceProviders" rel="noopener ugc nofollow" target="_blank">Source</a>)</figcaption></figure><p id="e47b" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">正如你在上面看到的，首先用户需要通过提供一个<code class="fe mj mk ml mm b">key</code>和<code class="fe mj mk ml mm b">secret</code>来请求一个<code class="fe mj mk ml mm b">Request Token</code>。然后用户被重定向以验证他们自己。之后，用户可以请求一个<code class="fe mj mk ml mm b">Access Token</code>，它将在后续的授权数据请求中使用。</p><p id="4c59" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">OAuth的架构师希望通过引入OAuth 2.0来改进这个工作流。他们是否成功实现了他们的目标<a class="ae kc" href="https://web.archive.org/web/20120731155632/http://hueniverse.com/2012/07/oauth-2-0-and-the-road-to-hell/" rel="noopener ugc nofollow" target="_blank">是有争议的</a>，然而，它在整个技术领域扩散，开发者需要理解它。让我们看一下更新流程图:</p><figure class="mf mg mh mi gt jr gh gi paragraph-image"><div class="gh gi mn"><img src="../Images/eb7effa47d15fa810e4e3d0a6fae3371.png" data-original-src="https://miro.medium.com/v2/resize:fit:1374/format:webp/1*U8R42kcFozXdacvK00pOZA.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">A flow diagram for OAuth 2.0 (<a class="ae kc" href="https://docs.spring.io/spring-social/docs/1.1.0.RELEASE/reference/htmlsingle/#section_oauth2ServiceProviders" rel="noopener ugc nofollow" target="_blank">Source</a>)</figcaption></figure><p id="748a" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">OAuth 2.0的工作流程与OAuth 1.0非常相似，但是正如你在上面看到的，它稍微简化了一些。随着<code class="fe mj mk ml mm b">Request Token</code>工作流的移除，OAuth 2.0减少了所谓的“OAuth舞蹈”中所需的一些网络调用。</p><p id="a5bc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，我们已经对OAuth及其特点有了很高层次的理解，让我们深入了解一下集成。</p><h1 id="5b85" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">恒定接触积分</h1><p id="75a5" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">要在一个固定联系账户上执行任何CRUD操作，你需要验证和授权你的应用程序(即Google Apps脚本)。Constant Contact的V3 API文档相当不错。他们有有用的<a class="ae kc" href="https://v3.developer.constantcontact.com/api_guide/auth_overview.html" rel="noopener ugc nofollow" target="_blank">一步一步的指导</a>和<a class="ae kc" href="https://v3.developer.constantcontact.com/api_reference/index.html" rel="noopener ugc nofollow" target="_blank">令人印象深刻的API参考</a>，允许你在浏览器中查看示例请求和测试实际的API。</p><p id="e047" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在“持续联系”中设置您的应用程序设置后，您会注意到您需要选择一个授权工作流。他们提供了一个三条腿的“服务器流”和一个两条腿的“客户端流”，我选择了服务器流，因为它支持刷新令牌。</p><p id="5de5" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后，我开始沿着<a class="ae kc" href="https://v3.developer.constantcontact.com/api_guide/server_flow.html" rel="noopener ugc nofollow" target="_blank">服务器流程路径</a>运行，并开始创建通用的请求函数，这些函数包装了Google App Script的<a class="ae kc" href="https://developers.google.com/apps-script/reference/url-fetch/url-fetch-app?hl=en" rel="noopener ugc nofollow" target="_blank">urlfettchapp类</a>，但后来我意识到，在Google App Script中进行身份验证很可能是一项常见的任务，有人可能已经开源了这项任务。果不其然，GitHub上<a class="ae kc" href="https://github.com/googleworkspace" rel="noopener ugc nofollow" target="_blank"> googleworkspace </a>的优秀人员创建了一个<a class="ae kc" href="https://github.com/googleworkspace/apps-script-oauth2" rel="noopener ugc nofollow" target="_blank"> OAuth 2.0实用程序类</a>，可用于此目的。它包装在我之前提到的相同UrlFetchApp类之上，<a class="ae kc" href="https://github.com/googleworkspace/apps-script-oauth2/blob/eebdf7884b019dac5160f6554059bf9537fda1cd/src/Service.js#L382-L414" rel="noopener ugc nofollow" target="_blank">方便地为您提取和处理授权代码</a>，而<a class="ae kc" href="https://github.com/googleworkspace/apps-script-oauth2/blob/eebdf7884b019dac5160f6554059bf9537fda1cd/src/Service.js#L615-L628" rel="noopener ugc nofollow" target="_blank">将授权令牌</a>保存在您选择的属性存储中。</p><p id="2974" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一旦我检查了OAuth 2.0实用程序类并通读了文档，构建身份验证和授权就变得轻而易举了。让我们来看看一些代码。</p><p id="dd20" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">首先，让我们使用上面讨论的OAuth 2.0实用程序类来设置我们的OAuth 2.0服务:</p><figure class="mf mg mh mi gt jr"><div class="bz fp l di"><div class="mo mp l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Sample JavaScript code to instantiate the OAuth 2.0 service.</figcaption></figure><p id="168e" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们上面使用的OAuth 2.0实用程序类被设计成链式的(即每个方法返回<code class="fe mj mk ml mm b">this</code>)。让我们看看这里调用的每个方法:</p><ol class=""><li id="26de" class="mq mr iq kf b kg kh kk kl ko ms ks mt kw mu la mv mw mx my bi translated"><code class="fe mj mk ml mm b">createService</code> <br/>这是整个操作的总切入点。这个方法创建了私有<code class="fe mj mk ml mm b">Service_</code>类的一个新实例。</li><li id="e328" class="mq mr iq kf b kg mz kk na ko nb ks nc kw nd la mv mw mx my bi translated"><code class="fe mj mk ml mm b">setAuthorizationBaseUrl</code> <br/>设置认证和授权过程第一阶段的URL。</li><li id="702c" class="mq mr iq kf b kg mz kk na ko nb ks nc kw nd la mv mw mx my bi translated"><code class="fe mj mk ml mm b">setTokenUrl</code> <br/>这个方法为获取认证令牌的请求设置URL。</li><li id="98a4" class="mq mr iq kf b kg mz kk na ko nb ks nc kw nd la mv mw mx my bi translated"><code class="fe mj mk ml mm b">setClientId</code> <br/>这里，我们使用这个方法将我们的API键添加到我们的初始请求中(即第一段)。此密钥应由您尝试鉴定的第三方服务提供。</li><li id="cf51" class="mq mr iq kf b kg mz kk na ko nb ks nc kw nd la mv mw mx my bi translated"><code class="fe mj mk ml mm b">setClientSecret</code> <br/>类似于<code class="fe mj mk ml mm b">setClientId</code>，我们使用这个方法为第一段设置我们的API秘密。此值也将由您尝试鉴定的第三方服务提供。</li><li id="105a" class="mq mr iq kf b kg mz kk na ko nb ks nc kw nd la mv mw mx my bi translated"><code class="fe mj mk ml mm b">setCallbackFunction</code> <br/>设置OAuth过程完成后应调用的函数名称。这个方法的参数是一个<code class="fe mj mk ml mm b">String</code>，而不是对函数的引用。</li><li id="2c2d" class="mq mr iq kf b kg mz kk na ko nb ks nc kw nd la mv mw mx my bi translated"><code class="fe mj mk ml mm b">setPropertyStore</code> <br/>该方法设置授权令牌将被持久化的属性存储。我强烈推荐使用上面显示的原生Google Apps脚本<code class="fe mj mk ml mm b">PropertiesService</code>，因为它已经符合了<code class="fe mj mk ml mm b">setPropertyStore</code>所期望的界面。</li><li id="07b1" class="mq mr iq kf b kg mz kk na ko nb ks nc kw nd la mv mw mx my bi translated">在OAuth的授权步骤中，你需要描述你需要被授权的范围。这个方法的参数是作用域名称<code class="fe mj mk ml mm b">String</code> s的<code class="fe mj mk ml mm b">Array</code>。</li><li id="2b8f" class="mq mr iq kf b kg mz kk na ko nb ks nc kw nd la mv mw mx my bi translated"><code class="fe mj mk ml mm b">setParam</code> <br/>该方法是一个通用方法，用于添加OAuth过程中可能需要的任何附加参数。在我上面的例子中，持续接触要求你描述<code class="fe mj mk ml mm b">response_type</code>。你可以根据你的需要连接任意多个<code class="fe mj mk ml mm b">setParam</code>电话。</li></ol><p id="2623" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，让我们看看授权的UI部分。OAuth 2.0要求将用户导航到授权实体，以便正确地进行身份验证和授权。有几种方法可以提示用户导航，我选择使用<a class="ae kc" href="https://developers.google.com/apps-script/reference/base/ui?hl=en#showsidebaruserinterface" rel="noopener ugc nofollow" target="_blank">侧边栏</a>，类似于OAuth 2.0实用程序类创建者在他们的<a class="ae kc" href="https://github.com/googleworkspace/apps-script-oauth2/blob/master/README.md#2-direct-the-user-to-the-authorization-url" rel="noopener ugc nofollow" target="_blank"> README.md示例</a>中描述的那样。让我们看看这是什么样子:</p><figure class="mf mg mh mi gt jr"><div class="bz fp l di"><div class="mo mp l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Sample JavaScript code to show a sidebar in Google Sheets with an authorization link.</figcaption></figure><p id="4dc1" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这个函数只是呈现一个包含不同内容的侧边栏。如果用户尚未通过身份验证和授权，侧边栏将呈现一些带有可点击链接的说明性文本，该链接将用户重定向到持续联系身份验证。侧栏看起来像这样:</p><figure class="mf mg mh mi gt jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi ne"><img src="../Images/7fe9a9888a71287b72223ca914d3654a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SvO5BpeKmWq9jARbncIF3Q.png"/></div></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Sample sidebar output of an unauthorized user.</figcaption></figure><p id="0e40" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">在用户被重定向到授权页面并正确登录进行身份验证后，用户将会看到类似如下的页面:</p><figure class="mf mg mh mi gt jr gh gi paragraph-image"><div class="gh gi nf"><img src="../Images/adea527441c319e78c63c3eab6e3f8ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:666/format:webp/1*FFwip_EWW8R0GA-3uQTaUQ.png"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Sample post-OAuth flow HTML rendering.</figcaption></figure><p id="b3dc" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这是因为我们传递给OAuth服务实例化的回调函数(即<code class="fe mj mk ml mm b">setCallbackFunction(‘authCallback’)</code>)根据授权状态有条件地呈现HTML输出。你可以在这里看到:</p><figure class="mf mg mh mi gt jr"><div class="bz fp l di"><div class="mo mp l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Sample JavaScript code to conditionally render HTML output based on authorization status.</figcaption></figure><p id="4c06" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，我们可以简单地从OAuth服务实例中调用<code class="fe mj mk ml mm b">getAccessToken</code>方法，并在请求头中传递它。下面的例子展示了一个我测试过的函数，它通过Google Apps脚本创建了一个新的“列表”。</p><figure class="mf mg mh mi gt jr"><div class="bz fp l di"><div class="mo mp l"/></div><figcaption class="jy jz gj gh gi ka kb bd b be z dk">Sample JavaScript code to create a Constant Contact list from within Google Apps Script.</figcaption></figure><h1 id="ea14" class="lb lc iq bd ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly bi translated">结论</h1><p id="51a6" class="pw-post-body-paragraph kd ke iq kf b kg lz ki kj kk ma km kn ko mb kq kr ks mc ku kv kw md ky kz la ij bi translated">就是这样！现在，您已经了解了如何在Google Apps脚本中正确地进行身份验证和授权，一切尽在您的掌握之中。只需很少的开发和基本上为零的环境配置，您就可以利用来自Google Sheets的数据，并以编程方式与外部服务和数据进行交互。</p><p id="63a2" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这对我们来说是一个游戏改变者，但是请在评论中让我知道你能够利用这个教程的创造性方法！</p></div><div class="ab cl ng nh hu ni" role="separator"><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl"/></div><div class="ij ik il im in"><p id="9117" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="nn">原载于</em><a class="ae kc" href="https://codingbootcampguides.com/" rel="noopener ugc nofollow" target="_blank"><strong class="kf ir"><em class="nn"/></strong></a><em class="nn">。</em></p><p id="83cb" class="pw-post-body-paragraph kd ke iq kf b kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="nn">更多内容请看</em><a class="ae kc" href="http://plainenglish.io" rel="noopener ugc nofollow" target="_blank"><strong class="kf ir"><em class="nn">plain English . io</em></strong></a></p></div></div>    
</body>
</html>