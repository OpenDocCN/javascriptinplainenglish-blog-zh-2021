<html>
<head>
<title>Centralized Error Handler for Nested and Simple Form Groups in Angular</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Angular中嵌套和简单表单组的集中式错误处理程序</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/centralized-error-handler-for-nested-and-simple-form-groups-in-angular-aea6ec6b5c7a?source=collection_archive---------3-----------------------#2021-10-11">https://javascript.plainenglish.io/centralized-error-handler-for-nested-and-simple-form-groups-in-angular-aea6ec6b5c7a?source=collection_archive---------3-----------------------#2021-10-11</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="ccbd" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在Angular中实现集中式错误处理程序有几种方法。每个开发人员都有他/她自己的创造性的方法来做到这一点:)</p><p id="d328" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果你对为每个表单控件创建一个公共错误组件更感兴趣，你可以看看下面的故事。表单控件下显示的表单控件错误(如果有)。</p><div class="ki kj gp gr kk kl"><a href="https://link.medium.com/eKkFU7pa7kb" rel="noopener follow" target="_blank"><div class="km ab fo"><div class="kn ab ko cl cj kp"><h2 class="bd io gy z fp kq fr fs kr fu fw im bi translated">为验证错误创建可重复使用的显示，并以角度形式滚动到第一个错误</h2><div class="ks l"><h3 class="bd b gy z fp kq fr fs kr fu fw dk translated">表单验证对于任何类型的表单模板或反应式表单都是必须的。我们真的不想写10-15行HTML…</h3></div><div class="kt l"><p class="bd b dl z fp kq fr fs kr fu fw dk translated">link.medium.com</p></div></div><div class="ku l"><div class="kv l kw kx ky ku kz la kl"/></div></div></a></div><p id="8708" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这些是我们的目标:</p><ol class=""><li id="7842" class="lb lc in jm b jn jo jr js jv ld jz le kd lf kh lg lh li lj bi translated">在<strong class="jm io"> AppComponent </strong>中我们有3个表单/部分。表单中可能有也可能没有嵌套的表单组。</li><li id="2c5d" class="lb lc in jm b jn lk jr ll jv lm jz ln kd lo kh lg lh li lj bi translated">所有3个部分都有一个提交按钮。在提交时，我们在所有3个部分产生一个错误列表，并显示在一个公共错误显示组件<strong class="jm io">GeneralFormValidatorComponent。</strong></li><li id="a047" class="lb lc in jm b jn lk jr ll jv lm jz ln kd lo kh lg lh li lj bi translated">您也可以通过单击错误旁边的“转到部分”链接导航到有错误的表单。</li></ol><h2 id="1f5b" class="lp lq in bd lr ls lt dn lu lv lw dp lx jv ly lz ma jz mb mc md kd me mf mg mh bi translated">AppComponent类:</h2><p id="65a7" class="pw-post-body-paragraph jk jl in jm b jn mi jp jq jr mj jt ju jv mk jx jy jz ml kb kc kd mm kf kg kh ig bi translated">有三种形式/部分:<strong class="jm io">个人信息形式、教育信息形式和展示信息形式</strong>。需要最后两个表单只是为了演示当单击错误旁边的“Go to Section”链接时，控件如何移动到适当的部分。</p><p id="9bcb" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">personalInfoForm 是一个包含简单表单控件的表单组:名字、姓氏、出生日期、电子邮件、联系人和一个嵌套的表单组:地址，其中包含一些表单控件。</p><p id="7d82" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> eduInfoForm </strong>是一个包含2个简单表单控件<strong class="jm io"> fieldA </strong>和<strong class="jm io"> fieldB </strong>的表单组。</p><p id="0fc0" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> expInfoForm </strong>是一个包含两个表单控件<strong class="jm io"> fieldC </strong>和<strong class="jm io"> fieldD </strong>的表单组。</p><figure class="mn mo mp mq gt mr"><div class="bz fp l di"><div class="ms mt l"/></div></figure><figure class="mn mo mp mq gt mr gh gi paragraph-image"><div role="button" tabindex="0" class="mv mw di mx bf my"><div class="gh gi mu"><img src="../Images/f73269d1632d2466427a5baef58e8e7a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*M0koMbs5PkBaxTC05IXMfw.png"/></div></div><figcaption class="na nb gj gh gi nc nd bd b be z dk">Personal Info Form</figcaption></figure><figure class="mn mo mp mq gt mr gh gi paragraph-image"><div role="button" tabindex="0" class="mv mw di mx bf my"><div class="gh gi ne"><img src="../Images/2cb47d9164251d2572700bb46ba9a0c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ty_uRW73UxAqjeUZ5wyVRQ.png"/></div></div><figcaption class="na nb gj gh gi nc nd bd b be z dk">Education and Experience Form</figcaption></figure><p id="8429" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">3个表单中的每个表单控件都用一个自定义的验证器方法进行验证。所有的验证方法都是从<strong class="jm io"> validator.ts </strong>文件中导出的。在这些验证器方法中没有任何东西是硬编码的。这确保了它们可以被需要类似验证的表单控件重用。</p><p id="0b44" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这些方法要么返回一个包含两个属性的对象:<strong class="jm io">错误</strong>和<strong class="jm io">消息，要么</strong>返回<strong class="jm io">空值</strong>。<strong class="jm io">错误</strong>属性始终保持值true，而<strong class="jm io">消息</strong>属性包含FormControl的适当场景错误消息。</p><figure class="mn mo mp mq gt mr"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="ede1" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">单击Submit按钮，我们将检查哪些表单是无效的，并只将无效表单的详细信息和表单的id推入数组<strong class="jm io">allformerrodetails</strong>。这个数组的每个元素包含一个具有两种属性的对象:<strong class="jm io"> form和formId </strong>。属性表单包含整个表单组的详细信息，formId包含硬编码的表单Id。</p><p id="2bad" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们将在后面看到为什么表单的ID也被传递。</p><pre class="mn mo mp mq gt nf ng nh ni aw nj bi"><span id="5265" class="lp lq in ng b gy nk nl l nm nn"><strong class="ng io">submit()</strong> {<br/>this.allFormErrorDetails = [];<br/>let formErrorDetails = [];<br/>if(this.personalInfoForm.invalid){<br/><strong class="ng io">formErrorDetails.push({form:this.personalInfoForm,formId:”personalInfo”});</strong><br/>}</span><span id="c433" class="lp lq in ng b gy no nl l nm nn">if(this.eduInfoForm.invalid){<br/><strong class="ng io">formErrorDetails.push({form:this.eduInfoForm,formId:”eduInfo”});</strong><br/>}</span><span id="64a8" class="lp lq in ng b gy no nl l nm nn">if(this.expInfoForm){<br/><strong class="ng io">formErrorDetails.push({form:this.expInfoForm,formId:”expInfo”});</strong><br/>}<br/><strong class="ng io">this.allFormErrorDetails = formErrorDetails</strong>;<br/>}</span></pre><p id="7fa9" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> AppComponent </strong>模板可以很长。我来总结一下。</p><ol class=""><li id="0bab" class="lb lc in jm b jn jo jr js jv ld jz le kd lf kh lg lh li lj bi translated">我们添加了通用错误组件<strong class="jm io">GeneralFormValidatorComponent</strong>，它接受@ Input()<strong class="jm io">allformerrodetails</strong>，并将<strong class="jm io">allformerrodetails属性</strong>作为值<strong class="jm io">。</strong>如前所述<strong class="jm io">allformerrodetails</strong>是一个数组，包含所有无效表单组及其表单id的列表。</li></ol><pre class="mn mo mp mq gt nf ng nh ni aw nj bi"><span id="6322" class="lp lq in ng b gy nk nl l nm nn">&lt;app-general-form-validator <strong class="ng io">[allFormErrorDetails]=”allFormErrorDetails”</strong> &gt;&lt;/app-general-form-validator&gt;</span></pre><p id="7948" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">2.接下来，我们添加了3个表单。请注意下表中id的位置。下面的Id与我们在<strong class="jm io">allformerrodetails</strong>数组中的<strong class="jm io"> formId </strong>属性中使用的id相同。</p><p id="cb58" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我已经省略了不必要的标签，并以汇总格式突出显示了下面每个表单的<strong class="jm io"> formId </strong>。</p><pre class="mn mo mp mq gt nf ng nh ni aw nj bi"><span id="05b5" class="lp lq in ng b gy nk nl l nm nn">&lt;div class=”card-body collapse show” <strong class="ng io">id=”personalInfo”</strong>&gt;<br/>&lt;p class=”card-text”&gt;Fill in your personal info.&lt;/p&gt;<br/>&lt;form <strong class="ng io">[formGroup]=”personalInfoForm”</strong>&gt;<br/>&lt;!-- form elements will come here - -&gt;<br/>&lt;/form&gt;<br/>&lt;/div&gt;</span><span id="1cc1" class="lp lq in ng b gy no nl l nm nn">&lt;div class="card-body collapse show" <strong class="ng io">id="eduInfo"</strong>&gt;<br/>&lt;p class="card-text"&gt;Fill in your education details&lt;/p&gt;<br/>&lt;form <strong class="ng io">[formGroup]="eduInfoForm"</strong>&gt;<br/>&lt;!-- form elements will come here - -&gt;<br/>&lt;/form&gt;<br/>&lt;/div&gt;</span><span id="5ef9" class="lp lq in ng b gy no nl l nm nn">&lt;div class="card-body collapse show" <strong class="ng io">id="expInfo"</strong>&gt;<br/>&lt;p class="card-text"&gt;Fill in your experience details&lt;/p&gt;<br/>&lt;form <strong class="ng io">[formGroup]="expInfoForm"</strong>&gt;<br/>&lt;!-- form elements will come here - -&gt;<br/>&lt;/form&gt;<br/>&lt;/div&gt;</span></pre><figure class="mn mo mp mq gt mr"><div class="bz fp l di"><div class="ms mt l"/></div></figure><h2 id="472e" class="lp lq in bd lr ls lt dn lu lv lw dp lx jv ly lz ma jz mb mc md kd me mf mg mh bi translated">GeneralFormValidatorComponent类:</h2><figure class="mn mo mp mq gt mr"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="bfca" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">因为<strong class="jm io">GeneralFormValidatorComponent</strong>是AppComponent的子组件，所以从父组件传递到子组件的任何数据都可以在<strong class="jm io"> ngOnChanges </strong>生命周期钩子中检测到。</p><pre class="mn mo mp mq gt nf ng nh ni aw nj bi"><span id="395d" class="lp lq in ng b gy nk nl l nm nn"><strong class="ng io">ngOnChanges</strong>(changes) {<br/>if (changes) {<br/>this.errorList = [];<br/><strong class="ng io">this.handleForm(this.allFormErrorDetails);</strong><br/>}}</span></pre><p id="c208" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> errorList </strong>是一个数组，包含所有3种形式的错误信息(如果有的话)。该列表将在提交时显示在屏幕上。</p><p id="b123" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> handleForm </strong>()遍历数组<strong class="jm io">allformerrodetails</strong>，该数组包含3个表单的表单和formId细节。对于每个表单，我们调用<strong class="jm io"> parseFormErrors() </strong>，它检查每个表单组(简单的和嵌套的)的FormsControls中的错误。这些错误稍后将被构造成适当的消息。</p><pre class="mn mo mp mq gt nf ng nh ni aw nj bi"><span id="b95e" class="lp lq in ng b gy nk nl l nm nn"><strong class="ng io">handleForm(formDetails)</strong> {<br/>formDetails.forEach(item =&gt; {<br/>//iterating through each form<br/><strong class="ng io">this.parseFormErrors(item.form, item.formId);</strong><br/>})<br/>}</span></pre><p id="bc8f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">parseFormErrors() 使用内部函数的概念来完成任务。</p><pre class="mn mo mp mq gt nf ng nh ni aw nj bi"><span id="b81a" class="lp lq in ng b gy nk nl l nm nn"><strong class="ng io">parseFormErrors(form, formId) {</strong><br/>let that = this;<br/><strong class="ng io">iterate(form);</strong></span><span id="d553" class="lp lq in ng b gy no nl l nm nn"><strong class="ng io">function iterate(formGroup) {</strong><br/>Object.keys(formGroup.controls).forEach((key: string) =&gt; {<br/><strong class="ng io">if (formGroup.get(key) instanceof FormGroup) {</strong><br/>// If the control is not a FormGroup then we know it's a FormControl<br/><strong class="ng io">iterate(formGroup.get(key)); </strong><br/>//pass the FormGroup back to the same method for reiteration<br/>} else {<br/><strong class="ng io">if (formGroup.get(key).errors) {</strong><br/>//if form control has an error and error is not null<br/>Object.entries(formGroup.get(key).errors).forEach(<br/>([errorName, errorValue]) =&gt; {<br/><strong class="ng io">if (errorName === 'message') {<br/>that.errorList.push({<br/>message: errorValue,<br/>sectionName: formId,<br/>});<br/>}</strong>});<br/>}}});<br/>}}</span></pre><p id="b5c6" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><strong class="jm io"> parseFormErrors() </strong>接受两个参数:表单细节，即<strong class="jm io">简单父表单组对象和表单ID </strong>。让我们看看这里遵循的步骤。</p><p id="357a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">1.调用内部函数<strong class="jm io"> iterate() </strong>，将表单的简单父表单组作为参数传递。该函数首先使用<strong class="jm io"> Object.keys. </strong>获取FormGroup的<strong class="jm io">控件属性</strong>的所有键，请注意FormGroup的controls属性的每个键都是FormControl/FormGroup。我们需要检查该键是简单的FormControl还是嵌套的FormGroup。因此，它随后遍历键数组来执行上述检查。</p><p id="2b78" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">2.如果键是嵌套的FormGroup，则满足IF循环条件。因此，我们再次调用iterate()，将嵌套的FormGroup作为参数传递。这样，我们就可以访问嵌套FormGroup的controls属性，并获得该嵌套FormGroup的controls属性的所有键。再次执行相同的检查:键是简单的FormControl或嵌套的FormGroup。</p><p id="700f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">3.如果满足ELSE循环条件，我们将检查FormControl是否有任何错误。请注意，无效表单的所有表单控件可能都没有错误。因此，在这里执行这项检查非常重要。</p><p id="004f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">4.如果FormControl有错误，我们执行下面这段代码:</p><pre class="mn mo mp mq gt nf ng nh ni aw nj bi"><span id="89f7" class="lp lq in ng b gy nk nl l nm nn">Object.entries(formGroup.get(key).errors).forEach(<br/>([errorName, errorValue]) =&gt; {<br/>if (errorName === 'message') {<br/>that.errorList.push({message: errorValue,sectionName: formId,});<br/>}}<br/>);</span></pre><p id="0f7a" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">FormControl的<strong class="jm io">错误属性</strong>是一个包含两个属性的对象:<strong class="jm io">错误和消息</strong>。每个属性都包含错误名称作为键，并且该键有一个值。我们需要键和值来构造一个错误消息。因此，我们使用<strong class="jm io"> Object.entries </strong>以数组形式存储键及其相应的值。</p><p id="9771" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">请注意，我们只需要message属性来显示消息。</p><p id="5042" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我们将来自每个表单控件的error对象的<strong class="jm io"> message </strong>属性的错误消息以及表单ID(表单控件有此错误的表单的ID)推入数组<strong class="jm io"> errorList </strong>。</p><p id="49dd" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">让我们检查一下<strong class="jm io">GeneralFormValidatorComponent模板</strong>。</p><pre class="mn mo mp mq gt nf ng nh ni aw nj bi"><span id="d721" class="lp lq in ng b gy nk nl l nm nn">&lt;div class=”errorList” *ngIf=”errorList.length”&gt;<br/>&lt;ul&gt;<br/><strong class="ng io">&lt;li *ngFor=”let error of errorList”&gt;{{error.message}} &lt;a href=”#{{error.sectionName}}”&gt;Go to Section&lt;/a&gt;&lt;/li&gt;</strong><br/>&lt;/ul&gt;<br/>&lt;/div&gt;</span></pre><p id="191d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">这很简单。刚刚遍历了<strong class="jm io"> errorList </strong>数组并显示了数组中每个对象的<strong class="jm io">消息属性</strong>。注意&lt; a &gt;标签的href属性。<strong class="jm io">我们已经将href链接到表单ID </strong>。这样，当我们点击<strong class="jm io">“转到章节”</strong>时，我们导航到包含错误的表格。当页面中有多个表单，而您很难找出哪个字段有错误时，这非常有用。</p><p id="a466" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">在提交3个表格时，错误信息将显示如下。每次提交时，错误消息将根据用户输入的正确输入进行更新。</p><figure class="mn mo mp mq gt mr gh gi paragraph-image"><div role="button" tabindex="0" class="mv mw di mx bf my"><div class="gh gi np"><img src="../Images/2924c4961f8132f9e93ac5e551377303.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5ohFqWxZDJaRdvVk2Z87dA.png"/></div></div><figcaption class="na nb gj gh gi nc nd bd b be z dk">List of Errors on Submission</figcaption></figure><p id="6272" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">就是这样！</p><p id="4549" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">您可以在下面的StackBlitz链接查看整个工作。</p><div class="ki kj gp gr kk kl"><a href="https://stackblitz.com/edit/angular-eqdkma?file=src/app/app.component.html" rel="noopener  ugc nofollow" target="_blank"><div class="km ab fo"><div class="kn ab ko cl cj kp"><h2 class="bd io gy z fp kq fr fs kr fu fw im bi translated">角形(叉形)堆叠</h2><div class="ks l"><h3 class="bd b gy z fp kq fr fs kr fu fw dk translated">编辑描述</h3></div><div class="kt l"><p class="bd b dl z fp kq fr fs kr fu fw dk translated">stackblitz.com</p></div></div><div class="ku l"><div class="nq l kw kx ky ku kz la kl"/></div></div></a></div><p id="fb34" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><em class="nr">更多内容看</em><a class="ae ns" href="http://plainenglish.io" rel="noopener ugc nofollow" target="_blank"><strong class="jm io"><em class="nr">plain English . io</em></strong></a></p></div></div>    
</body>
</html>