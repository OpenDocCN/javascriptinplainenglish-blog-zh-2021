<html>
<head>
<title>Serverless Redis Caching with Node.js</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Node.js的无服务器Redis缓存</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/introduction-to-redis-and-caching-with-node-js-using-upstash-88efbe39eea2?source=collection_archive---------2-----------------------#2021-03-20">https://javascript.plainenglish.io/introduction-to-redis-and-caching-with-node-js-using-upstash-88efbe39eea2?source=collection_archive---------2-----------------------#2021-03-20</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><div class=""><h2 id="1137" class="pw-subtitle-paragraph jk im in bd b jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb dk translated">Redis是用于缓存的内存中数据结构。在这篇博客中，我们将实现一个简单的Node.js应用程序，它使用无服务器Redis，并且我们将使用Upstash——无服务器<br/>数据库用于Redis。</h2></div><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi kc"><img src="../Images/b0ccb9bd9037247c25b904fdcf01185f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*MLfP-fQt4mUhKZvX"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Photo by <a class="ae ks" href="https://unsplash.com/@clemhlrdt?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Clément Hélardot</a> on <a class="ae ks" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h2 id="513c" class="kt ku in bd kv kw kx dn ky kz la dp lb lc ld le lf lg lh li lj lk ll lm ln lo bi translated">Redis是什么？</h2><p id="280c" class="pw-post-body-paragraph lp lq in lr b ls lt jo lu lv lw jr lx lc ly lz ma lg mb mc md lk me mf mg mh ig bi translated">Redis是一个开源的内存数据结构存储，用作缓存的NoSQL数据库，以提高最频繁请求的数据的整体响应速度。</p></div><div class="ab cl mi mj hr mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="ig ih ii ij ik"><p id="9c49" class="pw-post-body-paragraph lp lq in lr b ls mp jo lu lv mq jr lx lc mr lz ma lg ms mc md lk mt mf mg mh ig bi translated">在这个博客中，我们将开发笔记应用程序API，我们将实现两个功能，</p><ol class=""><li id="9475" class="mu mv in lr b ls mp lv mq lc mw lg mx lk my mh mz na nb nc bi translated">记下用户的笔记。</li><li id="1613" class="mu mv in lr b ls nd lv ne lc nf lg ng lk nh mh mz na nb nc bi translated">将便笺返回给用户。</li></ol><p id="983f" class="pw-post-body-paragraph lp lq in lr b ls mp jo lu lv mq jr lx lc mr lz ma lg ms mc md lk mt mf mg mh ig bi translated">但是这里将使用Redis，来缓存注释。如果用户频繁请求相同的笔记，我们将返回存储在Redis中的笔记。</p><pre class="kd ke kf kg gt ni nj nk nl aw nm bi"><span id="ec1b" class="kt ku in nj b gy nn no l np nq">REST API Routes</span><span id="ead9" class="kt ku in nj b gy nr no l np nq">1. POST =&gt; /api/notes =&gt; Create notes<br/>2. GET  =&gt; /api/notes/:id =&gt; Get a note</span></pre></div><div class="ab cl mi mj hr mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="ig ih ii ij ik"><p id="f278" class="pw-post-body-paragraph lp lq in lr b ls mp jo lu lv mq jr lx lc mr lz ma lg ms mc md lk mt mf mg mh ig bi translated"><strong class="lr io">软件要求</strong></p><p id="4112" class="pw-post-body-paragraph lp lq in lr b ls mp jo lu lv mq jr lx lc mr lz ma lg ms mc md lk mt mf mg mh ig bi translated">我们开始吧，</p><p id="906a" class="pw-post-body-paragraph lp lq in lr b ls mp jo lu lv mq jr lx lc mr lz ma lg ms mc md lk mt mf mg mh ig bi translated">在本地计算机上安装所需的软件包:</p><pre class="kd ke kf kg gt ni nj nk nl aw nm bi"><span id="be02" class="kt ku in nj b gy nn no l np nq">npm install express body-parser mongoose redis --save</span></pre><p id="0a35" class="pw-post-body-paragraph lp lq in lr b ls mp jo lu lv mq jr lx lc mr lz ma lg ms mc md lk mt mf mg mh ig bi translated"><strong class="lr io">用Upstash建立Redis数据库，</strong></p><p id="8e60" class="pw-post-body-paragraph lp lq in lr b ls mp jo lu lv mq jr lx lc mr lz ma lg ms mc md lk mt mf mg mh ig bi translated">是Redis的一个无服务器数据库，有服务器/实例，你按小时付费或固定价格。使用无服务器，您需要为每个请求付费。</p><p id="fc9d" class="pw-post-body-paragraph lp lq in lr b ls mp jo lu lv mq jr lx lc mr lz ma lg ms mc md lk mt mf mg mh ig bi translated">这意味着当数据库没有被使用时，你是免费的。Upstash为您配置和管理数据库。</p><p id="8fc6" class="pw-post-body-paragraph lp lq in lr b ls mp jo lu lv mq jr lx lc mr lz ma lg ms mc md lk mt mf mg mh ig bi translated">让我们先在<strong class="lr io">上创建一个账户，</strong></p><p id="e73b" class="pw-post-body-paragraph lp lq in lr b ls mp jo lu lv mq jr lx lc mr lz ma lg ms mc md lk mt mf mg mh ig bi translated">https://upstash.co m/</p><p id="fa8f" class="pw-post-body-paragraph lp lq in lr b ls mp jo lu lv mq jr lx lc mr lz ma lg ms mc md lk mt mf mg mh ig bi translated">现在设置数据库实例，</p><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi ns"><img src="../Images/fb2240ecd8488de73715ff0970bfdb0c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WQ4am-ITQFY7X1jFUAUYcg.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Create New Database</figcaption></figure><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi nt"><img src="../Images/27febc366670037ef864b3dd11d65597.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NS2-cVYWz2z_qZR0m8ra5Q.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Connect to your database</figcaption></figure><p id="361d" class="pw-post-body-paragraph lp lq in lr b ls mp jo lu lv mq jr lx lc mr lz ma lg ms mc md lk mt mf mg mh ig bi translated">创建一个简单的服务器并连接到MongoDB数据库:</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="nu nv l"/></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Simple Express Server</figcaption></figure><p id="19a7" class="pw-post-body-paragraph lp lq in lr b ls mp jo lu lv mq jr lx lc mr lz ma lg ms mc md lk mt mf mg mh ig bi translated">现在，使用Upstash提供的配置连接到Redis服务器:</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="nu nv l"/></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Redis connection with Upstash</figcaption></figure><p id="b990" class="pw-post-body-paragraph lp lq in lr b ls mp jo lu lv mq jr lx lc mr lz ma lg ms mc md lk mt mf mg mh ig bi translated">猫鼬模型:</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="nu nv l"/></div></figure><p id="5309" class="pw-post-body-paragraph lp lq in lr b ls mp jo lu lv mq jr lx lc mr lz ma lg ms mc md lk mt mf mg mh ig bi translated">现在实现API的路由</p><p id="a713" class="pw-post-body-paragraph lp lq in lr b ls mp jo lu lv mq jr lx lc mr lz ma lg ms mc md lk mt mf mg mh ig bi translated">从用户那里获取一条注释，并将其存储在Redis和MongoDB中:</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="nu nv l"/></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Create notes</figcaption></figure><p id="281b" class="pw-post-body-paragraph lp lq in lr b ls mp jo lu lv mq jr lx lc mr lz ma lg ms mc md lk mt mf mg mh ig bi translated">在代码中，我们使用了一个方法<code class="fe nw nx ny nj b">setex</code>来存储Redis中的数据。</p><p id="9406" class="pw-post-body-paragraph lp lq in lr b ls mp jo lu lv mq jr lx lc mr lz ma lg ms mc md lk mt mf mg mh ig bi translated">这个方法有4个参数</p><ol class=""><li id="af90" class="mu mv in lr b ls mp lv mq lc mw lg mx lk my mh mz na nb nc bi translated"><code class="fe nw nx ny nj b">id</code>:必须提供唯一的ID来存储数据。必须是字符串。</li><li id="83d1" class="mu mv in lr b ls nd lv ne lc nf lg ng lk nh mh mz na nb nc bi translated"><code class="fe nw nx ny nj b">seconds</code>:以秒为单位的到期时间。</li><li id="6067" class="mu mv in lr b ls nd lv ne lc nf lg ng lk nh mh mz na nb nc bi translated"><code class="fe nw nx ny nj b">value</code>:存储在Redis中的实际数据。必须是字符串。所以我们把<code class="fe nw nx ny nj b">object</code>连载成<code class="fe nw nx ny nj b">string</code>。</li><li id="2762" class="mu mv in lr b ls nd lv ne lc nf lg ng lk nh mh mz na nb nc bi translated"><code class="fe nw nx ny nj b">callback</code>:回调带两个参数<code class="fe nw nx ny nj b">err</code>和<code class="fe nw nx ny nj b">reply</code>。</li></ol><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi nz"><img src="../Images/ee35843829fd8dffac8e619fb05bb629.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*o07mPlNL0ML-0ZWawZ8L8g.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Create a note</figcaption></figure><p id="3cf7" class="pw-post-body-paragraph lp lq in lr b ls mp jo lu lv mq jr lx lc mr lz ma lg ms mc md lk mt mf mg mh ig bi translated">现在检索数据，首先，我们必须在Redis中检查数据，如果Redis中没有数据，那么我们必须在数据库中进行查询。</p><p id="00a5" class="pw-post-body-paragraph lp lq in lr b ls mp jo lu lv mq jr lx lc mr lz ma lg ms mc md lk mt mf mg mh ig bi translated">为此，我们必须编写中间件来检查Redis中请求的数据。</p><p id="2cab" class="pw-post-body-paragraph lp lq in lr b ls mp jo lu lv mq jr lx lc mr lz ma lg ms mc md lk mt mf mg mh ig bi translated">中间件:</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="nu nv l"/></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Caching middleware</figcaption></figure><p id="86b2" class="pw-post-body-paragraph lp lq in lr b ls mp jo lu lv mq jr lx lc mr lz ma lg ms mc md lk mt mf mg mh ig bi translated">在上述中间件中，我们使用<code class="fe nw nx ny nj b">get()</code>方法从Redis中检索现有数据。<code class="fe nw nx ny nj b">get(id, callback())</code>。</p><p id="091d" class="pw-post-body-paragraph lp lq in lr b ls mp jo lu lv mq jr lx lc mr lz ma lg ms mc md lk mt mf mg mh ig bi translated">这里我们将<code class="fe nw nx ny nj b">string</code>解析回<code class="fe nw nx ny nj b">object</code>。</p><p id="436c" class="pw-post-body-paragraph lp lq in lr b ls mp jo lu lv mq jr lx lc mr lz ma lg ms mc md lk mt mf mg mh ig bi translated">现在在<code class="fe nw nx ny nj b">get</code>请求上使用这个中间件:</p><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="nu nv l"/></div></figure><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi nz"><img src="../Images/098c77b4b66c02c655b2ccb3ee648372.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*R2gGYqvKL4HA60h97c5XaQ.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">First time retrieves data. It took 11ms</figcaption></figure><figure class="kd ke kf kg gt kh gh gi paragraph-image"><div role="button" tabindex="0" class="ki kj di kk bf kl"><div class="gh gi nz"><img src="../Images/59827cb907b11340471b6da2492fdf4a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ap-PRF_pKPfnEewxKYtaaA.png"/></div></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Next, we retried to get data, It took 5ms.</figcaption></figure><h2 id="e3b5" class="kt ku in bd kv kw kx dn ky kz la dp lb lc ld le lf lg lh li lj lk ll lm ln lo bi translated">密码</h2><figure class="kd ke kf kg gt kh"><div class="bz fp l di"><div class="nu nv l"/></div><figcaption class="ko kp gj gh gi kq kr bd b be z dk">Complete code</figcaption></figure></div><div class="ab cl mi mj hr mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="ig ih ii ij ik"><p id="8211" class="pw-post-body-paragraph lp lq in lr b ls mp jo lu lv mq jr lx lc mr lz ma lg ms mc md lk mt mf mg mh ig bi translated"><strong class="lr io"> <em class="oa">退房新贵进行生产:</em></strong><a class="ae ks" href="https://upstash.com/" rel="noopener ugc nofollow" target="_blank"><strong class="lr io"><em class="oa"/></strong></a></p></div></div>    
</body>
</html>