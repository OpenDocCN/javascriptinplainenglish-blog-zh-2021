<html>
<head>
<title>Create a browser-agnostic PWA install button</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">创建一个与浏览器无关的PWA安装按钮</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/creating-a-browser-agnostic-pwa-install-button-41039f312fbe?source=collection_archive---------0-----------------------#2021-03-30">https://javascript.plainenglish.io/creating-a-browser-agnostic-pwa-install-button-41039f312fbe?source=collection_archive---------0-----------------------#2021-03-30</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/0eb4e33c9a434e12c81ff5c785bc196d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bpZNQb1CZ2NGD61wlTMUoA.jpeg"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">PWA installation on iOS (left) and Android (right)</figcaption></figure><p id="588d" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">谷歌关于PWA开发的最佳资源之一是<a class="ae kx" href="https://web.dev/customize-install/" rel="noopener ugc nofollow" target="_blank">如何提供你自己的应用内安装体验</a>。其中，它非常详细地解释了如何创建一个安装按钮，以及如何检测PWA何时被安装。</p><p id="665f" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">在Chrome上效果很好。</p><h2 id="e751" class="ky kz in bd la lb lc dn ld le lf dp lg kk lh li lj ko lk ll lm ks ln lo lp lq bi translated">制作一个浏览器无关的安装按钮需要什么？</h2><p id="7be5" class="pw-post-body-paragraph jz ka in kb b kc lr ke kf kg ls ki kj kk lt km kn ko lu kq kr ks lv ku kv kw ig bi translated">指望谷歌为其他浏览器编写文档是不公平的。没问题。但是由于PWAs的全部意义在于它们可以在任何地方工作，安装按钮应该是与浏览器无关的。</p><p id="79d3" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">(补充说明:使用<a class="ae kx" href="https://progressier.com" rel="noopener ugc nofollow" target="_blank"> Progressier </a>，创建一个安装按钮就像在代码中添加<code class="fe lw lx ly lz b">&lt;button class="progressier-install-button"&gt;&lt;/button&gt;</code>一样简单，但是如果你绝对想自己构建逻辑，请继续阅读。剧透提醒:不好玩。)</p><h2 id="3f49" class="ky kz in bd la lb lc dn ld le lf dp lg kk lh li lj ko lk ll lm ks ln lo lp lq bi translated">好吧，那我们要造什么？</h2><p id="3d72" class="pw-post-body-paragraph jz ka in kb b kc lr ke kf kg ls ki kj kk lt km kn ko lu kq kr ks lv ku kv kw ig bi translated">我们想要创建一个按钮，单击它会触发<em class="ma">添加到主屏幕</em>提示。</p><figure class="mc md me mf gt jo gh gi paragraph-image"><div class="gh gi mb"><img src="../Images/d8c9c34d6577b44ada22d0eee7e5d38d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1394/format:webp/1*PVhAziC91LUhBSGPskDGfw.png"/></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">The “Add to Home Screen” prompt on desktop</figcaption></figure><p id="686f" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">在iOS上，没有提示，所以当点击按钮时，应该会显示一些说明，解释如何手动将应用程序添加到他们的主屏幕上。</p><figure class="mc md me mf gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/6dbc812409b458c5906dcee8bcaaabce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kdhyRCtLdkdTV43K8xOW9A.jpeg"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Instructions on how to install a PWA on iOS</figcaption></figure><p id="01fb" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">在完全不支持安装功能的浏览器上(例如Mac OS上的Safari)，该按钮应该被禁用或完全隐藏。</p><p id="9f44" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">应用程序安装后，按钮应该消失或被禁用。我们不想在用户已经安装了我们的应用程序之后，再要求他们安装。</p><h2 id="fc99" class="ky kz in bd la lb lc dn ld le lf dp lg kk lh li lj ko lk ll lm ks ln lo lp lq bi translated">首先，让我们创建一个按钮</h2><pre class="mc md me mf gt mg lz mh mi aw mj bi"><span id="1daa" class="ky kz in lz b gy mk ml l mm mn">let installButton = document.createElement('button');</span></pre><h2 id="9b84" class="ky kz in bd la lb lc dn ld le lf dp lg kk lh li lj ko lk ll lm ks ln lo lp lq bi translated">使用beforeinstallprompt事件</h2><p id="564b" class="pw-post-body-paragraph jz ka in kb b kc lr ke kf kg ls ki kj kk lt km kn ko lu kq kr ks lv ku kv kw ig bi translated">对于可安装的域，它必须由SSL保护(即以<a class="ae kx" rel="noopener ugc nofollow" target="_blank" href="/)">http<strong class="kb io"><em class="ma">s</em></strong>://)</a>开始)。它还必须有一个正在工作的服务工作者来监听fetch事件。从2021年8月起，<a class="ae kx" rel="noopener ugc nofollow" target="_blank" href="/your-pwa-is-going-to-break-in-august-2021-34982f329f40">实际上可以离线使用</a>,没有任何花招。</p><p id="4a04" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">当所有条件都满足时，会触发一个<code class="fe lw lx ly lz b">beforeinstallprompt</code>事件，告诉浏览器(和您)该域满足安装的所有条件。如果你什么都不做，Chrome会显示谷歌称之为<em class="ma">的迷你信息栏。</em></p><figure class="mc md me mf gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mo"><img src="../Images/478e375aea64b0c09daf0a07ea17bfdb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fkgO_UvFZUji2azqSMjm4Q.jpeg"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">The “mini-infobar” (left), the “install prompt” (center), and the <a class="ae kx" href="https://9to5google.com/2021/03/29/chrome-new-pwa-install/" rel="noopener ugc nofollow" target="_blank">still-experimental “bottom sheet” </a>(right).</figcaption></figure><p id="1d65" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">现在，在我们的例子中，我们需要捕捉事件并将其存储在某个地方，这样当用户点击我们漂亮的<code class="fe lw lx ly lz b">installButton</code>时，我们就可以调用它的提示方法。</p><figure class="mc md me mf gt jo"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="a6e0" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">酷毙了。此时，当用户点击我们的按钮时，它会提示用户安装app。</p><h2 id="a052" class="ky kz in bd la lb lc dn ld le lf dp lg kk lh li lj ko lk ll lm ks ln lo lp lq bi translated">检测应用程序安装</h2><p id="6865" class="pw-post-body-paragraph jz ka in kb b kc lr ke kf kg ls ki kj kk lt km kn ko lu kq kr ks lv ku kv kw ig bi translated">用户可以点击“安装”。或者他们可以忽略提示。这就是我们对这个选择的反应。</p><figure class="mc md me mf gt jo"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="c426" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">还有一个事件我们可以听。叫<code class="fe lw lx ly lz b">appinstalled</code>。它在应用程序被添加到我们用户的主屏幕后触发。</p><figure class="mc md me mf gt jo"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="efab" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">很简单。当事件被触发时，我们隐藏了<code class="fe lw lx ly lz b">installButton</code>，所以用户不能再点击它。不过有一点奇怪的是:<code class="fe lw lx ly lz b">appinstalled</code>事件从来不会在三星互联网浏览器上触发(其他浏览器也可能如此)。</p><h2 id="165a" class="ky kz in bd la lb lc dn ld le lf dp lg kk lh li lj ko lk ll lm ks ln lo lp lq bi translated">是否已经安装了PWA？还是根本无法安装？</h2><p id="80a9" class="pw-post-body-paragraph jz ka in kb b kc lr ke kf kg ls ki kj kk lt km kn ko lu kq kr ks lv ku kv kw ig bi translated">我们为什么关心？嗯，在不支持安装功能的设备上，正确的UX模式可以完全隐藏我们的<code class="fe lw lx ly lz b">installButton</code>。或者显示它，但同时指出正在使用的浏览器不支持该功能。</p><p id="9e36" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">安装PWA后，最好的UX模式是禁用该按钮并更改其措辞，例如从<em class="ma">安装</em>到<em class="ma">安装</em>。尽管完全隐藏它也是一个不错的选择。</p><p id="f08c" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">现在，我们如何判断一个应用程序是已安装(因此不再可安装)还是根本不可安装？在这两种情况下，什么都不会发生(不会触发<code class="fe lw lx ly lz b">beforeinstallprompt</code>或<code class="fe lw lx ly lz b">appinstalled</code>事件)。</p><p id="247a" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">所以我们要做的就是猜测。这里有一些方法可以帮助你做到这一点:</p><h2 id="f2d6" class="ky kz in bd la lb lc dn ld le lf dp lg kk lh li lj ko lk ll lm ks ln lo lp lq bi translated">1.特征检测</h2><p id="4329" class="pw-post-body-paragraph jz ka in kb b kc lr ke kf kg ls ki kj kk lt km kn ko lu kq kr ks lv ku kv kw ig bi translated">我们可以通过检查该功能所需的功能是否可用来检测PWA是否不可安装。如果没有，我们可以确定浏览器上没有PWA功能，并完全隐藏我们的按钮。</p><figure class="mc md me mf gt jo"><div class="bz fp l di"><div class="mp mq l"/></div></figure><h2 id="7ffa" class="ky kz in bd la lb lc dn ld le lf dp lg kk lh li lj ko lk ll lm ks ln lo lp lq bi translated">2.独立模式检测</h2><p id="68cd" class="pw-post-body-paragraph jz ka in kb b kc lr ke kf kg ls ki kj kk lt km kn ko lu kq kr ks lv ku kv kw ig bi translated">如果应用程序在它自己的窗口中打开，我们就知道这个应用程序已经安装了，我们可以相应地更新我们的UI。</p><figure class="mc md me mf gt jo"><div class="bz fp l di"><div class="mp mq l"/></div></figure><h2 id="a216" class="ky kz in bd la lb lc dn ld le lf dp lg kk lh li lj ko lk ll lm ks ln lo lp lq bi translated">3.饼干</h2><p id="bb77" class="pw-post-body-paragraph jz ka in kb b kc lr ke kf kg ls ki kj kk lt km kn ko lu kq kr ks lv ku kv kw ig bi translated">另一个有效的选择是，每当我们检测到应用程序安装时，就在用户的设备上保存一个cookie。我们希望我们的<code class="fe lw lx ly lz b">installButton</code>的状态在会话中保持一致。请注意，如果我们再次检测到一个<code class="fe lw lx ly lz b">beforeinstallprompt</code>事件，我们可能还想更新cookie。这意味着用户已经删除了我们的应用——因此它又变成了<em class="ma">可安装的</em>。</p><figure class="mc md me mf gt jo"><div class="bz fp l di"><div class="mp mq l"/></div></figure><h2 id="a807" class="ky kz in bd la lb lc dn ld le lf dp lg kk lh li lj ko lk ll lm ks ln lo lp lq bi translated">4.getInstalledRelatedApps方法</h2><p id="e36a" class="pw-post-body-paragraph jz ka in kb b kc lr ke kf kg ls ki kj kk lt km kn ko lu kq kr ks lv ku kv kw ig bi translated">我们还可以使用<a class="ae kx" href="https://web.dev/get-installed-related-apps/" rel="noopener ugc nofollow" target="_blank"> getInstalledRelatedApps方法</a>来检测我们的PWA是否已经安装。</p><figure class="mc md me mf gt jo"><div class="bz fp l di"><div class="mp mq l"/></div></figure><h2 id="4b0a" class="ky kz in bd la lb lc dn ld le lf dp lg kk lh li lj ko lk ll lm ks ln lo lp lq bi translated">5.iOS检测</h2><p id="5d51" class="pw-post-body-paragraph jz ka in kb b kc lr ke kf kg ls ki kj kk lt km kn ko lu kq kr ks lv ku kv kw ig bi translated">iOS需要不同的安装提升机制。但是没有办法检测一个网页是否可以使用iOS的<em class="ma">添加到主屏幕</em>按钮。为了只在iOS上显示特定的指令，我们必须弄清楚如何检测设备是否运行iOS。没有经得起未来考验的方法来做到这一点，但这里有一种方法:</p><figure class="mc md me mf gt jo"><div class="bz fp l di"><div class="mp mq l"/></div></figure><h2 id="88d5" class="ky kz in bd la lb lc dn ld le lf dp lg kk lh li lj ko lk ll lm ks ln lo lp lq bi translated">结论</h2><p id="a485" class="pw-post-body-paragraph jz ka in kb b kc lr ke kf kg ls ki kj kk lt km kn ko lu kq kr ks lv ku kv kw ig bi translated">通过充分利用所有这些变通方法，我们可以构建一个根据浏览器的兼容性和安装状态显示或隐藏的按钮。PWAs最大的挑战也是它最大的优势。构建一个在任何地方都能工作的应用程序也意味着你必须让它在任何地方都能工作。而且在某些情况下——比如我们的安装按钮——它可能相当乏味。</p><p id="cacf" class="pw-post-body-paragraph jz ka in kb b kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw ig bi translated">你在制作PWA安装按钮时遇到过问题吗？请在kevin@progressier.com留下您的评论或发邮件给我。</p></div></div>    
</body>
</html>