<html>
<head>
<title>HTTP API Load Testing Challenges and Answers</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">HTTP API负载测试挑战和答案</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/http-api-load-testing-challenges-and-answers-8dfff02d7353?source=collection_archive---------18-----------------------#2021-08-19">https://javascript.plainenglish.io/http-api-load-testing-challenges-and-answers-8dfff02d7353?source=collection_archive---------18-----------------------#2021-08-19</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><p id="8c35" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">进行API负载测试时的考虑事项，不管使用什么工具，都要在负载时运行有效的场景测试。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/b495c9393a3fbf16cfedc72987eb3e25.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*4Ut1BorF1uXLGWPF.png"/></div></div><figcaption class="ku kv gj gh gi kw kx bd b be z dk">Image by <a class="ae ky" href="https://pixabay.com/photos/?utm_source=link-attribution&amp;amp;utm_medium=referral&amp;amp;utm_campaign=image&amp;amp;utm_content=1209641" rel="noopener ugc nofollow" target="_blank">Free-Photos</a> from <a class="ae ky" href="https://pixabay.com/?utm_source=link-attribution&amp;amp;utm_medium=referral&amp;amp;utm_campaign=image&amp;amp;utm_content=1209641" rel="noopener ugc nofollow" target="_blank">Pixabay</a></figcaption></figure><h1 id="d11e" class="kz la in bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">HTTP API公开注意事项</h1><p id="5416" class="pw-post-body-paragraph jk jl in jm b jn lx jp jq jr ly jt ju jv lz jx jy jz ma kb kc kd mb kf kg kh ig bi translated">HTTP API测试不同于网站自动化测试。例如，有一些UI自动化工具实际上是与浏览器一起运行的。这些将在浏览器中加载一个网站(可能是无头的)并与之交互。通过这种设置，您可以看到应用程序每个部分的使用情况。大多数都有录音功能，你可以互动并记录会话，然后在随后的测试中回放。</p><p id="4738" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">网站UI自动化测试有时是唯一一种真正测试网站的测试。例如，如果您进入Amazon.com登录页面，输入您的凭证并点击“登录”按钮，您将看到超过100个呼叫通过您的网络连接发出和返回。开始时会有一个典型的HTTP表单提交Post，可能还有另一个建立会话cookie的调用。然后是几十个获取数据的电话——个人建议、流行趋势、最近查看的项目、产品图片、用户资料信息、CSS、JavaScript等等。亚马逊在很大程度上是使用微服务构建的。您可以看到，当一个页面被打开时，要模拟成百上千个调用中的每一个是多么困难。与其编写代码或使用Postman之类的工具来处理数百个API调用中的每一个，不如使用一个UI自动化工具来进行整体验收测试，然后针对需要扩展和反复使用的关键API调用进行特定的现场API调用。</p><p id="784d" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">你可以从这里学到的经验是，当你处理你的代码时，你也需要考虑如何测试它。你真的需要考虑如何编写应用程序，因为这将影响它如何被测试。开发人员应该始终确保他们编写的应用程序是可测试的！</p><h1 id="6f09" class="kz la in bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">你的网站代码的组成和注意事项</h1><p id="7f9a" class="pw-post-body-paragraph jk jl in jm b jn lx jp jq jr ly jt ju jv lz jx jy jz ma kb kc kd mb kf kg kh ig bi translated">假设您已经有了一些代码，您必须考虑您试图用您的测试来证明什么，以及您可以在什么级别上注入测试。这里有几点需要考虑。</p><ul class=""><li id="4c8e" class="mc md in jm b jn jo jr js jv me jz mf kd mg kh mh mi mj mk bi translated">您的网站可能是用服务器端页面构建的。当路由到达您的后端时，它们可能会运行没有作为API公开的代码。在极端情况下，你有一个完全没有HTTP API的单一应用程序，只调用服务器托管的代码。服务器端的处理将被协调，然后返回一个HTML页面。在这种情况下，可以测试的外部暴露非常少。在这种情况下，您将需要一些内部单元和集成测试。外部网站测试最适合浏览器托管类型的测试工具。</li><li id="663b" class="mc md in jm b jn ml jr mm jv mn jz mo kd mp kh mh mi mj mk bi translated">另一种情况是，服务器端呈现的网站使用客户端浏览器JavaScript代码的AJAX调用。可以对后端HTTP API进行XHR或JavaScript获取调用，而不需要刷新整个页面。这些API可能只供网站使用。这为您打开了更多的测试界面，因为您现在可以测试那些后端端点API。然后，您可以结合使用浏览器自动化测试和实际的HTTP端点测试调用工具。</li><li id="75a2" class="mc md in jm b jn ml jr mm jv mn jz mo kd mp kh mh mi mj mk bi translated">还有一种情况是，一个应用程序实际上是完全由API驱动的。在客户端SPA应用程序(想想React、Vue和Angular)甚至移动应用程序的情况下，您需要将应用程序的服务与后端API调用分开。在这种情况下，我们可以假设这些电话可能只针对你的应用。与上面的情况类似，您可以使用混合测试策略。</li><li id="8feb" class="mc md in jm b jn ml jr mm jv mn jz mo kd mp kh mh mi mj mk bi translated">您的应用程序和外部客户可以共享一个HTTP API端点。你可能想为你的客户制作一个完全独立的API。以<a class="ae ky" href="https://stripe.com/" rel="noopener ugc nofollow" target="_blank"> Stripe </a>和<a class="ae ky" href="https://github.com/" rel="noopener ugc nofollow" target="_blank"> GitHub </a>为例。这两家公司都有定义良好的API供客户使用，但不一定是他们自己的网站使用的API。Stripe为客户运行信用卡交易提供了一个定义良好的API。该API经过深思熟虑，使其易于使用，方便和安全。Github API允许用户与他们的回购进行交互。例如，使用API检索包含repos列表的JSON主体。如果您有一个独立于UI的合法公开的API，您可能会决定为UI使用一个测试框架，比如React Test Library，然后为HTTP端点使用一个好的API和负载测试工具。</li></ul><p id="4d65" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">所有这些都是为了让您了解实际上可以获得什么，并通过一系列HTTP API调用进行测试。您需要坐下来决定是否将测试定位到几个特定的调用并使用Apache Bench之类的工具，或者您是否真的想要编排一个更有思想的调用场景来模拟更完整的用户与您的站点的交互。</p><p id="4384" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">你需要意识到基于HTTP API的加载工具只能测试暴露的和可用的内容，这就是为什么它与使用浏览器控制工具的UI自动化测试非常不同。</p><h1 id="aa0b" class="kz la in bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">Cookie和令牌认证</h1><p id="31d9" class="pw-post-body-paragraph jk jl in jm b jn lx jp jq jr ly jt ju jv lz jx jy jz ma kb kc kd mb kf kg kh ig bi translated">另一个需要考虑的要点是，网站API端点很可能会公开两种不同的机制来进行身份验证。外部API可能会使用OAuth，而实际的网站不会。在GitHub的例子中，需要一个OAuth令牌来与API交互，但是用户通过表单提交和会话cookie检索来登录网站。作为另一个例子，考虑AWS代码构建。它由您通过UI进行初始的人工交互来授权访问您的GitHub repo，从那时起，CodeBuild保存一个访问令牌(直到您撤销它)。另一方面，站点可能通过表单提交Post接受id和密码，然后返回会话cookie或JWT。</p><p id="c29f" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">如果您想要测试的HTTP API是安全的，那么您需要考虑的第一件事就是如何访问它。您可能有一个专门构建的外部API，比如GitHub，因此您已经为客户提供了一种安全的调用机制，这种机制很容易实现。但是，如果您的API更多的是供内部使用，那么您可能没有提供一种简单的方法来使用相同的安全机制进行任何调用。</p><p id="9dd6" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">一些负载测试工具采用低级方法，并要求您利用已经建立的标准HTTP机制。这些措施如下:</p><ul class=""><li id="d7ec" class="mc md in jm b jn jo jr js jv me jz mf kd mg kh mh mi mj mk bi translated">cookie:工具需要模拟网络浏览器的行为。对于每个调用，响应cookies的返回都被存储起来。例如，您可以调用HTTP API来获得授权，然后会返回一个会话cookie。测试工具将获取所有cookie，并在随后的调用中将它们发送回去，并遵循cookie使用的web标准的所有标准使用限制，例如Expires、Domain、HttpOnly、Secure等。</li><li id="043e" class="mc md in jm b jn ml jr mm jv mn jz mo kd mp kh mh mi mj mk bi translated"><strong class="jm io">令牌:</strong>这些可能是不透明的开发者密钥(例如来自GitHub的PAT，没有嵌入含义的简单代码)或类似JWT的东西，包括OIDC·JWT。您只需要拥有令牌，并在低级调用中使用它。例如，您可以按如下方式设置标题。设置密钥和值，例如—授权:&lt;类型&gt; &lt;凭证&gt;</li></ul><p id="2e97" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">因此，您需要提供一个端点HTTP API调用，该调用以某种方式进行身份验证，然后在后续调用中将响应传递回cookie或令牌。寻找能够无缝捕获OAuth访问和刷新令牌的工具。据我所知，这些是你用来记录和回放浏览器交互的工具。否则，您需要一种方法来捕获生成的令牌或cookies，并将它们提供给不提供浏览器交互的工具。</p><h1 id="f0ec" class="kz la in bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">准入方面的其他挑战</h1><p id="37bd" class="pw-post-body-paragraph jk jl in jm b jn lx jp jq jr ly jt ju jv lz jx jy jz ma kb kc kd mb kf kg kh ig bi translated">像OAuth这样的安全机制意味着添加难以破解的额外步骤。这最终成为解决某些安全机制的挑战。这里有几个。</p><ul class=""><li id="54d3" class="mc md in jm b jn jo jr js jv me jz mf kd mg kh mh mi mj mk bi translated">这个有两个版本。一个总是需要用户交互，比如看一些模糊的字符或图片拼图，另一个会给你一个分数来决定你是否想继续。</li><li id="e509" class="mc md in jm b jn ml jr mm jv mn jz mo kd mp kh mh mi mj mk bi translated"><strong class="jm io">速率限制:</strong>如果你运行一个负载测试，负载测试可能会被你的开发人员认为是DDoS攻击，或者自动触发429响应，因为你必须检测这种类型的攻击的代码托管基础设施。</li><li id="700a" class="mc md in jm b jn ml jr mm jv mn jz mo kd mp kh mh mi mj mk bi translated"><strong class="jm io">电子邮件验证:</strong>在创建账户的时候，你的后台可能会用一个电子邮件和密码来注册一个账户，但会将其标记为待定，直到电子邮件被打开，所提供的链接被点击。</li><li id="e1df" class="mc md in jm b jn ml jr mm jv mn jz mo kd mp kh mh mi mj mk bi translated"><strong class="jm io">多因素认证(MFA): </strong>这可能是每次登录时向您的手机发送一个代码的文本消息。或者，一旦登录时令牌过期，可能需要Google Authenticator。也许甚至有指纹或面部识别的生物特征登录。</li></ul><p id="cb30" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">我发现的解决这些问题的最简单的解决方案是允许一个秘密头绕过这些机制。它包含很少的代码，可以在测试环境中启用，不一定在生产环境中使用，或者只在需要时启用一小段时间。例如，在初始帐户创建调用中设置了一个秘密头，告诉后端立即将帐户设置为“已批准”,并且不发送未决电子邮件。有一些可用的软件库声称他们可以解决reCAPTCHA挑战。</p><h1 id="c562" class="kz la in bd lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv lw bi translated">结论</h1><p id="f608" class="pw-post-body-paragraph jk jl in jm b jn lx jp jq jr ly jt ju jv lz jx jy jz ma kb kc kd mb kf kg kh ig bi translated">HTTP API测试可能会带来一些挑战。鉴于web开发的复杂性，没有完美的测试解决方案。负载测试工具为您提供了大量的选项来大规模运行虚拟用户负载，并从中获得一些价值。</p><p id="ab5b" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated">有一个我开发的新的负载和功能HTTP API测试工具叫做<a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/http-api-load-testing-challenges-and-answers-8dfff02d7353"> <strong class="jm io"> ApiZapi </strong> </a>。我试图让它易于使用和配置。如果你有兴趣，请查看http://apizapi.com<a class="ae ky" href="http://apizapi.com" rel="noopener ugc nofollow" target="_blank">了解更多信息。</a></p><p id="42cc" class="pw-post-body-paragraph jk jl in jm b jn jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ig bi translated"><em class="mq">更多内容看</em> <a class="ae ky" href="http://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"> <strong class="jm io"> <em class="mq">说白了. io </em> </strong> </a></p></div></div>    
</body>
</html>