<html>
<head>
<title>How I Fixed a Bug in Angular</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我如何修复Angular中的一个错误</h1>
<blockquote>原文：<a href="https://javascript.plainenglish.io/how-i-fixed-a-bug-in-angular-1140b62e0194?source=collection_archive---------2-----------------------#2021-06-14">https://javascript.plainenglish.io/how-i-fixed-a-bug-in-angular-1140b62e0194?source=collection_archive---------2-----------------------#2021-06-14</a></blockquote><div><div class="fc ib ic id ie if"/><div class="ig ih ii ij ik"><div class=""/><figure class="gl gn jl jm jn jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi jk"><img src="../Images/9e925c2a7409a98908ac84ff75735737.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*bdE3k8ioH0Frtcj-"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Photo by <a class="ae jz" href="https://unsplash.com/@casparrubin?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Caspar Camille Rubin</a> on <a class="ae jz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="fef1" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">大家好！今天我要告诉你我是如何为Angular社区做出贡献的。您将了解一个大型开源项目的贡献过程，而我将阐明代码评审。我们开始吧！</p><h1 id="2dca" class="ky kz in bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">问题</h1><p id="85ac" class="pw-post-body-paragraph ka kb in kc b kd lw kf kg kh lx kj kk kl ly kn ko kp lz kr ks kt ma kv kw kx ig bi translated">在我以前的工作中，我们有一个长期的SPA应用程序，用户可能会在很长一段时间内保持打开状态。在某个时候，我们注意到一些<code class="fe mb mc md me b">Observable</code>HTTP请求从未完成。</p><figure class="mg mh mi mj gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mf"><img src="../Images/c276a130ff826a6989f10f49a5ed55bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2vyJzjpmTBNSKRjsmRfdXQ.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Sad Observable, that is never completed</figcaption></figure><p id="2496" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">在做了一些少量的研究后，我们发现Angular在浏览器自己取消HTTP请求的情况下不会响应outer <code class="fe mb mc md me b">XMLHttpRequest.abort()</code>。当用户关闭设备进入睡眠模式或按Ctrl+S保存网页时，就会出现这种情况。我们甚至找到了合适的<a class="ae jz" href="https://github.com/angular/angular/issues/22324" rel="noopener ugc nofollow" target="_blank">问题</a>。有人已经提出了修复这个bug的请求。我们在项目中写了一个带有<code class="fe mb mc md me b">XhrFactory</code>的解决方案，期望这个补丁会被发布。</p><p id="f722" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">但是当我六个月后检查修复状态时，我发现这个问题仍然存在。由于作者没有更新，PR被取消了。然后我决定:“这是我尝试开源开发的机会。”</p><h1 id="4057" class="ky kz in bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">贡献流程</h1><p id="ca4b" class="pw-post-body-paragraph ka kb in kc b kd lw kf kg kh lx kj kk kl ly kn ko kp lz kr ks kt ma kv kw kx ig bi translated">首先，我通读了Angular的投稿指南，你可以在<a class="ae jz" href="https://github.com/angular/angular/blob/master/CONTRIBUTING.md" rel="noopener ugc nofollow" target="_blank"> COUNTIBUTING.md </a>文件中找到。以下是你需要做的事情，以便Angular团队考虑你的公关:</p><ol class=""><li id="9f08" class="mk ml in kc b kd ke kh ki kl mm kp mn kt mo kx mp mq mr ms bi translated">搜索<a class="ae jz" href="https://github.com/angular/angular/pulls" rel="noopener ugc nofollow" target="_blank"> GitHub </a>寻找与您的提交相关的公开或关闭的PR。</li><li id="352b" class="mk ml in kc b kd mt kh mu kl mv kp mw kt mx kx mp mq mr ms bi translated">叉项目。</li><li id="fca2" class="mk ml in kc b kd mt kh mu kl mv kp mw kt mx kx mp mq mr ms bi translated">基于“主”创建新的分支。</li><li id="58a3" class="mk ml in kc b kd mt kh mu kl mv kp mw kt mx kx mp mq mr ms bi translated">按照代码风格编写你的代码和至少一个测试。</li><li id="8b43" class="mk ml in kc b kd mt kh mu kl mv kp mw kt mx kx mp mq mr ms bi translated">运行完整的角度测试套件。</li><li id="578b" class="mk ml in kc b kd mt kh mu kl mv kp mw kt mx kx mp mq mr ms bi translated">用正确的消息提交您的更改<strong class="kc io">。</strong></li><li id="bf50" class="mk ml in kc b kd mt kh mu kl mv kp mw kt mx kx mp mq mr ms bi translated">签署贡献者许可协议(CLA)。</li><li id="3133" class="mk ml in kc b kd mt kh mu kl mv kp mw kt mx kx mp mq mr ms bi translated">为Angular的“主”分支创建一个PR。</li></ol><p id="8a88" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我想前三点已经很清楚了。我们将从第四点开始。这个对我来说更容易，因为有一个取消的拉请求，它需要改进。看看这个。</p><p id="fda4" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我们对后端的请求有问题。所以，我们需要检查<code class="fe mb mc md me b">http</code>模块。快速找到合适的包。我们知道，这个问题与<code class="fe mb mc md me b">xhr</code>和<code class="fe mb mc md me b">abort</code>有关，因此在<code class="fe mb mc md me b">http</code>模块中搜索<code class="fe mb mc md me b">XMLHttpRequest</code>是在哪里创建的，以及<code class="fe mb mc md me b">abort</code>事件是如何处理的。找到<strong class="kc io"> xhr.ts </strong>文件，了解我们已经达到目标。</p><figure class="mg mh mi mj gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi my"><img src="../Images/288b41ff5f0fab70ecba9529032f8197.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5MEf3w_f1ZlEQ1OM_vv9dw.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Structure of http module</figcaption></figure><p id="f7fe" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">为<code class="fe mb mc md me b">abort</code>寻找一个事件监听器。答对了。此事件未被处理。</p><p id="96c5" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我们只需要为<code class="fe mb mc md me b">abort</code>添加一个事件监听器，然后如果HTTP请求失败的话，一个<code class="fe mb mc md me b">Observable</code>将被完成并显示一个错误。别忘了为此写一个测试。在<strong class="kc io"> xhr.ts </strong>中已经有了我们可以使用的<code class="fe mb mc md me b">onError</code>函数。只需要两行。</p><figure class="mg mh mi mj gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi mz"><img src="../Images/43299167367b052fd07afb56d44592d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9ECCZECtpmDmHeWx2kemeA.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">Two rows of changes</figcaption></figure><p id="b22e" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我有另一个想法，可以处理HTTP abort，比如<code class="fe mb mc md me b">HttpEvent</code>，而不是一个错误。那我们的解决方案会更复杂。但在我看来，当你无法控制的力量决定你的请求不再继续时，这种情况是相当错误的。</p><p id="a619" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">修复错误的代码已经编写完成。之后，我们需要对这些变化进行单元测试，目的很简单——如果<code class="fe mb mc md me b">http</code>模块的功能改变了，一切都会正常。<code class="fe mb mc md me b">src</code>目录中的每个文件都有自己的扩展名为<strong class="kc io"> .spec.ts </strong>的文件，用于<code class="fe mb mc md me b">test</code>目录中的测试。算法很简单——找一个类似的测试，改一下。我还不得不延长一个模拟。</p><figure class="mg mh mi mj gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi na"><img src="../Images/c2a54d259057b240ff68acf04c732379.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*luZBtS1V8EUVgBudXVjYqA.png"/></div></div><figcaption class="jv jw gj gh gi jx jy bd b be z dk">The test</figcaption></figure><p id="40c7" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">测试已经写好了。现在我们需要运行所有的项目测试。这可能需要相当长的时间。做好准备。</p><p id="7130" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">当我们编写测试时，我们可以检查一个单独的模块，这样会更快。例如:</p><pre class="mg mh mi mj gt nb me nc nd aw ne bi"><span id="0dad" class="nf kz in me b gy ng nh l ni nj">yarn bazel test packages/common/http/test</span></pre><p id="6951" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">所有的测试都运行了。是时候提交我们的更改了。在此之前，我推荐做<code class="fe mb mc md me b">yarn lint</code>，如果你不应用<a class="ae jz" href="https://clang.llvm.org/docs/ClangFormat.html" rel="noopener ugc nofollow" target="_blank"> clang </a>自动格式化程序。代码风格是基础。</p><p id="b82d" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我们可以转移到我们的承诺。Angular团队对<a class="ae jz" href="https://github.com/angular/angular/blob/master/CONTRIBUTING.md#commit" rel="noopener ugc nofollow" target="_blank">提交消息</a>命名有严格的规定。因此，我们仔细阅读了贡献指南中关于这一点的整个部分。</p><p id="d812" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">现在我们发布我们的分支。我们已经到了终点线。我们需要与谷歌签署<a class="ae jz" href="https://cla.developers.google.com/about/google-individual" rel="noopener ugc nofollow" target="_blank"> CLA </a>。它允许贡献者保留他们对代码的权利，谷歌将拥有使用这些代码的合法权利。签署CLA只需要一次，它会扩展到谷歌的所有项目。</p><p id="dc22" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">做PR等着吧，等有角团队审核的时候。</p><h1 id="e5c4" class="ky kz in bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">代码审查</h1><p id="5e3a" class="pw-post-body-paragraph ka kb in kc b kd lw kf kg kh lx kj kk kl ly kn ko kp lz kr ks kt ma kv kw kx ig bi translated">在做了一些调查后，我准备等很长时间。但是我的拉取请求13分钟后就被审核了！获得如此快速的反馈真是令人惊讶。</p><p id="d321" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">Andrew Kushnir认可了我的公关，并说我的改变对他来说很好。他还添加了Alex Rickabaugh作为评论者，因为Alex有更多的上下文。30分钟后，他同意了，并写道，他原本有一些担忧，但他说服自己，这个公关是好的。</p><p id="0887" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">然而，这并不是结束。原来还有另一个类似的拉请求修复了<a class="ae jz" href="https://github.com/angular/angular/issues/26453" rel="noopener ugc nofollow" target="_blank">与<code class="fe mb mc md me b">xhr timeout</code>的问题</a>，代码与我的完全相同。因此，当PR落地时，我们会有合并冲突。当时机成熟时，安德鲁要求我调整我的公关并解决合并冲突。我尽了最大努力，用<code class="fe mb mc md me b">--force-with-lease flag</code>推动了我的改变。你可以在这里阅读更多关于这个标志<a class="ae jz" href="https://git-scm.com/docs/git-push#Documentation/git-push.txt---force-with-leaseltrefnamegt" rel="noopener ugc nofollow" target="_blank">的信息。</a></p><p id="f53b" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">第二天，Andrew Kushnir为我的拉动式请求添加了“<em class="nk"> merge </em>”标签，并对我的贡献表示感谢。几个小时后，我的变化是有角度的。</p><figure class="mg mh mi mj gt jo gh gi paragraph-image"><div role="button" tabindex="0" class="jp jq di jr bf js"><div class="gh gi nl"><img src="../Images/c0284f743c80ea2460161ccc56a06d3a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lccQ1-C4LzD8Z1jOxnltEQ.png"/></div></div></figure><p id="88aa" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">几天后，CHANGE_LOG.md更新了错误已被修复，并将在版本12中发布。</p><h1 id="5277" class="ky kz in bd la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt lu lv bi translated">摘要</h1><p id="e40b" class="pw-post-body-paragraph ka kb in kc b kd lw kf kg kh lx kj kk kl ly kn ko kp lz kr ks kt ma kv kw kx ig bi translated">这是一次非常有趣的经历。看到我写了很长时间的框架的结构，运行测试，并发现Angular团队中的过程是什么样子，这很令人好奇。事实证明，对开源框架做出自己的改变一点也不困难。</p><p id="f209" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated">我希望你已经发现这是有用的。感谢您的阅读。</p><p id="081a" class="pw-post-body-paragraph ka kb in kc b kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ig bi translated"><em class="nk">更多内容请看</em><a class="ae jz" href="http://plainenglish.io/" rel="noopener ugc nofollow" target="_blank"><em class="nk">plain English . io</em></a></p></div></div>    
</body>
</html>